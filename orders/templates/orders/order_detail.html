{% extends 'base.html' %}
{% load decimal_filters %}
{% load unified_status_tags %}
{% block title %}تفاصيل الطلب - نظام الخواجه{% endblock %}
{% block content %}
    <div class="container" style="margin-top: 20px;">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 style="color: white;">
                <i class="fas fa-shopping-cart"></i> تفاصيل الطلب #<span style="color: #28a745;">{{ order.order_number }}</span>
            </h2>
            <div>
                <a href="{% url 'orders:order_list' %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-right"></i> العودة للقائمة
                </a>
                {% if perms.orders.change_order and not user.is_salesperson %}
                    {% if order.creation_method == 'wizard' %}
                        <a href="{% url 'orders:wizard_edit_options' order.pk %}"
                           class="btn btn-primary">
                            <i class="fas fa-magic"></i> تعديل الطلب (ويزارد)
                        </a>
                    {% else %}
                        <a href="{% url 'orders:wizard_edit_options' order_pk=order.pk %}"
                           class="btn btn-primary">
                            <i class="fas fa-edit"></i> تعديل الطلب
                        </a>
                    {% endif %}
                {% endif %}
                <button type="button"
                        class="btn btn-success"
                        onclick="printInvoice('{{ order.order_number }}')">
                    <i class="fas fa-print"></i> طباعة الفاتورة
                </button>
                {% if user.is_superuser or perms.orders.delete_order %}
                    <a href="{% url 'orders:order_delete' order.pk %}"
                       class="btn btn-danger">
                        <i class="fas fa-trash"></i> حذف الطلب
                    </a>
                {% endif %}
            </div>
        </div>
        <div class="row">
            <!-- Order Details -->
            <div class="col-lg-4 col-md-12">
                <div class="card mb-4 h-100">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">معلومات الطلب</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-bordered table-sm">
                            <tr>
                                <th style="width: 40%">رقم الطلب</th>
                                <td>{{ order.order_number }}</td>
                            </tr>
                            <tr>
                                <th>البائع</th>
                                <td>
                                    {% if order.salesperson %}
                                        {{ order.salesperson.name }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>تاريخ الطلب</th>
                                <td>{{ order.order_date|date:"Y-m-d H:i" }}</td>
                            </tr>
                            {% with types_list=order.get_selected_types_list %}
                                {% if types_list and types_list|length == 1 %}
                                    {% if types_list.0 == 'inspection' or types_list.0 == 'products' %}
                                        {# لا تعرض ملف العقد والمعاينة المرتبطة لطلبات المعاينة والمنتجات #}
                                    {% else %}
                                        <tr>
                                            <th>ملف العقد</th>
                                            <td>
                                                {% if order.contract_file %}
                                                    <a href="{% url 'orders:preview_contract' order.id %}"
                                                       target="_blank"
                                                       class="btn btn-sm btn-success">
                                                        <i class="fas fa-file-pdf"></i> عرض ملف العقد
                                                    </a>
                                                {% else %}
                                                    <span class="text-muted">لم يتم رفع ملف العقد</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        <tr>
                                            <th>المعاينة المرتبطة</th>
                                            <td>
                                                {% if order.related_inspection_type == 'customer_side' %}
                                                    <span class="badge bg-info">
                                                        <i class="fas fa-user me-1"></i>طرف العميل
                                                    </span>
                                                    <br>
                                                    <small class="text-muted">تم تحديد المعاينة كطرف العميل</small>
                                                {% elif order.related_inspection %}
                                                    <!-- عرض ملفات المعاينة -->
                                                    {% if order.related_inspection.files.exists %}
                                                        <div class="d-flex flex-wrap gap-2 mb-2">
                                                            {% for file in order.related_inspection.files.all %}
                                                                <div class="file-badge d-inline-flex align-items-center"
                                                                     style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
                                                                            border-radius:6px;
                                                                            padding:4px 10px;
                                                                            color:#fff">
                                                                    <span style="font-size:0.75em;margin-left:4px;">{{ forloop.counter }}</span>
                                                                    <a href="{{ file.file.url }}"
                                                                       target="_blank"
                                                                       class="text-white"
                                                                       title="تحميل">
                                                                        <i class="fas fa-file-pdf" style="font-size:1.1em;"></i>
                                                                    </a>
                                                                    {% if file.is_uploaded_to_drive and file.google_drive_file_url %}
                                                                        <a href="{{ file.google_drive_file_url }}"
                                                                           target="_blank"
                                                                           class="text-white ms-2"
                                                                           title="Google Drive">
                                                                            <i class="fab fa-google-drive" style="font-size:1em;"></i>
                                                                        </a>
                                                                    {% else %}
                                                                        <i class="fas fa-sync fa-spin ms-2"
                                                                           style="font-size:0.8em;
                                                                                  opacity:0.7"
                                                                           title="جاري الرفع"></i>
                                                                    {% endif %}
                                                                </div>
                                                            {% endfor %}
                                                        </div>
                                                    {% elif order.related_inspection.inspection_file %}
                                                        <div class="file-badge d-inline-flex align-items-center"
                                                             style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
                                                                    border-radius:6px;
                                                                    padding:4px 10px;
                                                                    color:#fff">
                                                            <a href="{{ order.related_inspection.inspection_file.url }}"
                                                               target="_blank"
                                                               class="text-white"
                                                               title="تحميل الملف">
                                                                <i class="fas fa-file-pdf" style="font-size:1.2em;"></i>
                                                                <span class="ms-1" style="font-size:0.85em;">ملف المعاينة</span>
                                                            </a>
                                                            {% if order.related_inspection.is_uploaded_to_drive and order.related_inspection.google_drive_file_url %}
                                                                <a href="{{ order.related_inspection.google_drive_file_url }}"
                                                                   target="_blank"
                                                                   class="text-white ms-3"
                                                                   title="Google Drive">
                                                                    <i class="fab fa-google-drive" style="font-size:1.1em;"></i>
                                                                </a>
                                                            {% endif %}
                                                        </div>
                                                    {% elif order.related_inspection.google_drive_file_url %}
                                                        <a href="{{ order.related_inspection.google_drive_file_url }}"
                                                           target="_blank"
                                                           class="btn btn-sm btn-success">
                                                            <i class="fab fa-google-drive me-1"></i>Drive
                                                        </a>
                                                    {% else %}
                                                        <span class="badge bg-secondary">
                                                            <i class="fas fa-file-circle-xmark me-1"></i>بدون ملف
                                                        </span>
                                                    {% endif %}
                                                    <br>
                                                    {% get_status_badge order.related_inspection.status "inspection" %}
                                                    <br>
                                                    <small class="text-muted">
                                                        {% if order.related_inspection.contract_number %}
                                                            <span dir="ltr" style="font-weight: bold; color: #a67c52;">
                                                                {{ order.related_inspection.branch.id|default:"1" }}-{{ order.related_inspection.inspection_code|stringformat:"04d" }}-{{ order.related_inspection.created_at|date:"ym" }}-{{ order.related_inspection.contract_number|default:"00" }}
                                                            </span>
                                                        {% else %}
                                                            {{ order.related_inspection.inspection_code }}
                                                        {% endif %}
                                                        - {{ order.related_inspection.created_at|date:"Y-m-d" }}
                                                    </small>
                                                {% else %}
                                                    <span class="text-muted">لا توجد معاينة مرتبطة</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endif %}
                                {% else %}
                                    <tr>
                                        <th>ملف العقد</th>
                                        <td>
                                            {% if order.contract_file %}
                                                <a href="{% url 'orders:preview_contract' order.id %}"
                                                   target="_blank"
                                                   class="btn btn-sm btn-success">
                                                    <i class="fas fa-file-pdf"></i> عرض ملف العقد
                                                </a>
                                            {% else %}
                                                <span class="text-muted">لم يتم رفع ملف العقد</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>المعاينة المرتبطة</th>
                                        <td>
                                            {% if order.related_inspection_type == 'customer_side' %}
                                                <span class="badge bg-info">
                                                    <i class="fas fa-user me-1"></i>طرف العميل
                                                </span>
                                                <br>
                                                <small class="text-muted">تم تحديد المعاينة كطرف العميل</small>
                                            {% elif order.related_inspection %}
                                                <!-- عرض ملفات المعاينة -->
                                                {% if order.related_inspection.files.exists %}
                                                    <div class="d-flex flex-wrap gap-2 mb-2">
                                                        {% for file in order.related_inspection.files.all %}
                                                            <div class="file-badge d-inline-flex align-items-center"
                                                                 style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
                                                                        border-radius:6px;
                                                                        padding:4px 10px;
                                                                        color:#fff">
                                                                <span style="font-size:0.75em;margin-left:4px;">{{ forloop.counter }}</span>
                                                                <a href="{{ file.file.url }}"
                                                                   target="_blank"
                                                                   class="text-white"
                                                                   title="تحميل">
                                                                    <i class="fas fa-file-pdf" style="font-size:1.1em;"></i>
                                                                </a>
                                                                {% if file.is_uploaded_to_drive and file.google_drive_file_url %}
                                                                    <a href="{{ file.google_drive_file_url }}"
                                                                       target="_blank"
                                                                       class="text-white ms-2"
                                                                       title="Google Drive">
                                                                        <i class="fab fa-google-drive" style="font-size:1em;"></i>
                                                                    </a>
                                                                {% else %}
                                                                    <i class="fas fa-sync fa-spin ms-2"
                                                                       style="font-size:0.8em;
                                                                              opacity:0.7"
                                                                       title="جاري الرفع"></i>
                                                                {% endif %}
                                                            </div>
                                                        {% endfor %}
                                                    </div>
                                                {% elif order.related_inspection.inspection_file %}
                                                    <div class="file-badge d-inline-flex align-items-center"
                                                         style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
                                                                border-radius:6px;
                                                                padding:4px 10px;
                                                                color:#fff">
                                                        <a href="{{ order.related_inspection.inspection_file.url }}"
                                                           target="_blank"
                                                           class="text-white"
                                                           title="تحميل الملف">
                                                            <i class="fas fa-file-pdf" style="font-size:1.2em;"></i>
                                                            <span class="ms-1" style="font-size:0.85em;">ملف المعاينة</span>
                                                        </a>
                                                        {% if order.related_inspection.is_uploaded_to_drive and order.related_inspection.google_drive_file_url %}
                                                            <a href="{{ order.related_inspection.google_drive_file_url }}"
                                                               target="_blank"
                                                               class="text-white ms-3"
                                                               title="Google Drive">
                                                                <i class="fab fa-google-drive" style="font-size:1.1em;"></i>
                                                            </a>
                                                        {% endif %}
                                                    </div>
                                                {% elif order.related_inspection.google_drive_file_url %}
                                                    <a href="{{ order.related_inspection.google_drive_file_url }}"
                                                       target="_blank"
                                                       class="btn btn-sm btn-success">
                                                        <i class="fab fa-google-drive me-1"></i>Drive
                                                    </a>
                                                {% else %}
                                                    <span class="badge bg-secondary">
                                                        <i class="fas fa-file-circle-xmark me-1"></i>بدون ملف
                                                    </span>
                                                {% endif %}
                                                <br>
                                                {% get_status_badge order.related_inspection.status "inspection" %}
                                                <br>
                                                <small class="text-muted">
                                                    {% if order.related_inspection.contract_number %}
                                                        <span dir="ltr" style="font-weight: bold; color: #a67c52;">
                                                            {{ order.related_inspection.branch.id|default:"1" }}-{{ order.related_inspection.inspection_code|stringformat:"04d" }}-{{ order.related_inspection.created_at|date:"ym" }}-{{ order.related_inspection.contract_number|default:"00" }}
                                                        </span>
                                                    {% else %}
                                                        {{ order.related_inspection.inspection_code }}
                                                    {% endif %}
                                                    - {{ order.related_inspection.created_at|date:"Y-m-d" }}
                                                </small>
                                            {% else %}
                                                <span class="text-muted">لا توجد معاينة مرتبطة</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endif %}
                            {% endwith %}
                            <!-- Show different date info for inspection vs other orders -->
                            {% with types_list=order.get_selected_types_list %}
                                {% if 'inspection' in types_list or 'inspection' in order.selected_types %}
                                    <!-- For inspection orders, show inspection date -->
                                    {% with inspection=order.inspections.first %}
                                        {% if inspection %}
                                            {% if inspection.status == 'completed' %}
                                                <tr>
                                                    <th>حالة المعاينة</th>
                                                    <td>
                                                        <span class="badge bg-success">
                                                            <i class="fas fa-check me-1"></i>
                                                            مكتملة
                                                        </span>
                                                        {% if inspection.updated_at %}
                                                            <br>
                                                            <small class="text-muted">آخر تحديث: {{ inspection.updated_at|date:"Y-m-d H:i" }}</small>
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                            {% elif inspection.scheduled_date %}
                                                <tr>
                                                    <th>تاريخ المعاينة المجدولة</th>
                                                    <td>
                                                        <span class="badge bg-warning text-dark">
                                                            <i class="fas fa-calendar me-1"></i>
                                                            {{ inspection.scheduled_date|date:"Y-m-d" }}
                                                        </span>
                                                        <br>
                                                        <small class="text-muted">
                                                            الحالة:
                                                            {% load unified_status_tags %}
                                                            {% get_status_badge inspection.status "inspection" %}
                                                        </small>
                                                    </td>
                                                </tr>
                                            {% else %}
                                                <tr>
                                                    <th>حالة المعاينة</th>
                                                    <td>
                                                        <span class="badge bg-secondary">
                                                            <i class="fas fa-hourglass-half me-1"></i>
                                                            في انتظار الجدولة
                                                        </span>
                                                        <br>
                                                        <small class="text-muted">تاريخ الطلب: {{ inspection.request_date|date:"Y-m-d" }}</small>
                                                    </td>
                                                </tr>
                                            {% endif %}
                                        {% else %}
                                            <tr>
                                                <th>حالة المعاينة</th>
                                                <td>
                                                    <span class="badge bg-danger">
                                                        <i class="fas fa-exclamation-triangle me-1"></i>
                                                        لم يتم إنشاء المعاينة بعد
                                                    </span>
                                                </td>
                                            </tr>
                                        {% endif %}
                                    {% endwith %}
                                    <!-- بطاقة أمر التقطيع -->
                                    {% if order.get_selected_types_list|length > 0 and 'inspection' not in order.get_selected_types_list %}
                                        {% if order.cutting_orders.exists %}
                                            {% for cutting_order in order.cutting_orders.all %}
                                                <tr>
                                                    <th>
                                                        {% if forloop.first %}
                                                            أوامر التقطيع
                                                        {% else %}
                                                        {% endif %}
                                                    </th>
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <span class="badge {% if cutting_order.status == 'completed' %}bg-success {% elif cutting_order.status == 'in_progress' %}bg-info {% elif cutting_order.status == 'partially_completed' %}bg-warning text-dark {% else %}bg-secondary{% endif %} me-2">
                                                                <i class="fas fa-cut me-1"></i>
                                                                {{ cutting_order.cutting_code }}
                                                            </span>
                                                            <span class="badge {% if cutting_order.status == 'completed' %}bg-success {% elif cutting_order.status == 'in_progress' %}bg-info {% elif cutting_order.status == 'partially_completed' %}bg-warning text-dark {% else %}bg-secondary{% endif %}">
                                                                {{ cutting_order.get_status_display }}
                                                            </span>
                                                        </div>
                                                        <div class="mt-2">
                                                            <small class="text-muted">
                                                                <i class="fas fa-warehouse me-1"></i>
                                                                المستودع: {{ cutting_order.warehouse.name }}
                                                            </small>
                                                            <br>
                                                            <small class="text-muted">
                                                                <i class="fas fa-calendar me-1"></i>
                                                                تاريخ الإنشاء: {{ cutting_order.created_at|date:"d/m/Y H:i" }}
                                                            </small>
                                                            {% if cutting_order.assigned_to %}
                                                                <br>
                                                                <small class="text-muted">
                                                                    <i class="fas fa-user-tie me-1"></i>
                                                                    المسؤول: {{ cutting_order.assigned_to.get_full_name|default:cutting_order.assigned_to.username }}
                                                                </small>
                                                            {% endif %}
                                                        </div>
                                                        <div class="mt-2">
                                                            <div class="progress" style="height: 8px;">
                                                                <div class="progress-bar {% if cutting_order.completion_percentage == 100 %}bg-success {% elif cutting_order.completion_percentage > 50 %}bg-info {% else %}bg-warning{% endif %}"
                                                                     role="progressbar"
                                                                     style="width: {{ cutting_order.completion_percentage }}%">
                                                                </div>
                                                            </div>
                                                            <small class="text-muted">
                                                                التقدم: {{ cutting_order.completion_percentage|floatformat:0 }}%
                                                                ({{ cutting_order.completed_items }}/{{ cutting_order.total_items }} عنصر)
                                                            </small>
                                                        </div>
                                                        <div class="mt-2">
                                                            <a href="{% url 'cutting:order_detail' cutting_order.pk %}"
                                                               class="btn btn-sm btn-primary">
                                                                <i class="fas fa-eye"></i> عرض التفاصيل
                                                            </a>
                                                            {% if cutting_order.status == 'pending' %}
                                                                <button class="btn btn-sm btn-success ms-1"
                                                                        onclick="startCutting({{ cutting_order.pk }})">
                                                                    <i class="fas fa-play"></i> بدء التقطيع
                                                                </button>
                                                            {% endif %}
                                                            {% if order.invoice_image or order.invoice_images.exists %}
                                                                <button type="button"
                                                                        class="btn btn-sm btn-info ms-1"
                                                                        data-bs-toggle="modal"
                                                                        data-bs-target="#invoiceImageModal">
                                                                    <i class="fas fa-file-invoice me-1"></i>عرض الفاتورة
                                                                    {% if order.invoice_images.exists %}
                                                                        <span class="badge bg-warning text-dark">{{ order.invoice_images.count|add:1 }}</span>
                                                                    {% endif %}
                                                                </button>
                                                            {% endif %}
                                                        </div>
                                                    </td>
                                                </tr>
                                            {% endfor %}
                                        {% else %}
                                            <tr>
                                                <th>أمر التقطيع</th>
                                                <td>
                                                    <span class="badge bg-warning text-dark">
                                                        <i class="fas fa-exclamation-triangle me-1"></i>
                                                        لم يتم إنشاء أمر التقطيع بعد
                                                    </span>
                                                    <div class="mt-2">
                                                        <button class="btn btn-sm btn-primary"
                                                                onclick="createCuttingOrder({{ order.id }})">
                                                            <i class="fas fa-plus"></i> إنشاء أمر تقطيع
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        {% endif %}
                                    {% endif %}
                                    <!-- Show expected inspection date -->
                                    {% with types_list=order.get_selected_types_list %}
                                        {% if types_list|length == 1 and 'inspection' in types_list and order.expected_delivery_date %}
                                            <tr>
                                                <th>موعد المعاينة المتوقع</th>
                                                <td>
                                                    <span class="badge bg-info">
                                                        <i class="fas fa-clock me-1"></i>
                                                        {{ order.expected_delivery_date|date:"Y-m-d" }}
                                                    </span>
                                                </td>
                                            </tr>
                                        {% elif order.get_smart_delivery_date %}
                                            <tr>
                                                <th>{{ order.get_delivery_date_label }}</th>
                                                <td>
                                                    <span class="badge {% if order.order_status == 'delivered' %}bg-success{% elif order.order_status == 'completed' or order.order_status == 'ready_install' %}bg-warning text-dark{% else %}bg-info{% endif %}">
                                                        <i class="fas fa-calendar me-1"></i>
                                                        {{ order.get_smart_delivery_date|date:"Y-m-d" }}
                                                    </span>
                                                    {% if order.status == 'vip' %}
                                                        <small class="text-warning ms-2">
                                                            <i class="fas fa-star"></i> VIP - أولوية عالية
                                                        </small>
                                                    {% endif %}
                                                    {% if order.order_status in 'completed,ready_install,delivered' %}
                                                        <br>
                                                        <small class="text-muted">
                                                            {% if order.order_status == 'delivered' %}
                                                                تم التسليم فعلياً
                                                            {% elif order.order_status == 'completed' %}
                                                                تم الإكمال في المصنع
                                                            {% elif order.order_status == 'ready_install' %}
                                                                جاهز للتركيب
                                                            {% endif %}
                                                        </small>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            <!-- إضافة تاريخ التركيب المتوقع للطلبات التي تحتوي على تركيب -->
                                            {% if 'installation' in order.get_selected_types_list %}
                                                <tr>
                                                    <th>{{ order.get_installation_date_label }}</th>
                                                    <td>
                                                        {% if order.get_installation_date %}
                                                            <span class="badge bg-info">
                                                                <i class="fas fa-tools me-1"></i>
                                                                {{ order.get_installation_date|date:"Y-m-d" }}
                                                            </span>
                                                            <br>
                                                            <small class="text-muted">
                                                                {% if order.get_installation_date %}
                                                                    تاريخ مجدول للتركيب
                                                                {% else %}
                                                                    تاريخ متوقع للتركيب
                                                                {% endif %}
                                                            </small>
                                                        {% else %}
                                                            <span class="text-muted">لم يتم تحديد موعد التركيب</span>
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                            {% endif %}
                                        {% endif %}
                                    {% endwith %}
                                {% else %}
                                    <!-- For other orders, show smart delivery date -->
                                    {% if order.get_smart_delivery_date %}
                                        <tr>
                                            <th>{{ order.get_delivery_date_label }}</th>
                                            <td>
                                                <span class="badge {% if order.order_status == 'delivered' %}bg-success{% elif order.order_status == 'completed' or order.order_status == 'ready_install' %}bg-warning text-dark{% else %}bg-info{% endif %}">
                                                    <i class="fas fa-calendar me-1"></i>
                                                    {{ order.get_smart_delivery_date|date:"Y-m-d" }}
                                                </span>
                                                {% if order.status == 'vip' %}
                                                    <small class="text-warning ms-2">
                                                        <i class="fas fa-star"></i> VIP - أولوية عالية
                                                    </small>
                                                {% endif %}
                                                {% if order.order_status in 'completed,ready_install,delivered' %}
                                                    <br>
                                                    <small class="text-muted">
                                                        {% if order.order_status == 'delivered' %}
                                                            تم التسليم فعلياً
                                                        {% elif order.order_status == 'completed' %}
                                                            تم الإكمال في المصنع
                                                        {% elif order.order_status == 'ready_install' %}
                                                            جاهز للتركيب
                                                        {% endif %}
                                                    </small>
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endif %}
                                {% endif %}
                            {% endwith %}
                            <tr>
                                <th>حالة الطلب</th>
                                <td>
                                    {% with display_info=order.get_display_status %}
                                        <span class="badge {{ order.get_display_status_badge_class }}"
                                              style="font-size: 0.9rem">
                                            <i class="{{ order.get_display_status_icon }} me-1"></i>
                                            {{ order.get_display_status_text }}
                                        </span>
                                        <!-- إظهار مصدر الحالة إذا كان مختلفاً عن الحالة الأساسية -->
                                        {% if display_info.source != 'order' %}
                                            <br>
                                            <small class="text-muted" style="font-size: 0.75rem;">
                                                {% if display_info.source == 'installation' %}
                                                    <i class="fas fa-tools me-1"></i>تركيب
                                                {% elif display_info.source == 'manufacturing' %}
                                                    <i class="fas fa-industry me-1"></i>مصنع
                                                {% endif %}
                                            </small>
                                        {% endif %}
                                        <!-- إظهار اسم المستلم إذا كانت الحالة تم التسليم -->
                                        {% if order.get_display_status_text == 'تم التسليم' and order.delivery_recipient_name %}
                                            <br>
                                            <small class="text-muted" style="font-size: 0.75rem;">
                                                <i class="fas fa-user me-1"></i>المستلم: {{ order.delivery_recipient_name }}
                                            </small>
                                        {% endif %}
                                        <!-- رابط سجل الحالة -->
                                        <br>
                                        <small>
                                            <a href="{% url 'orders:status_history' order.id %}" class="text-info">
                                                <i class="fas fa-history me-1"></i>عرض سجل الحالة
                                            </a>
                                        </small>
                                    {% endwith %}
                                </td>
                            </tr>
                            <!-- إضافة حالة المصنع إذا كان هناك أمر تصنيع -->
                            {% if order.manufacturing_order %}
                                <tr>
                                    <th>حالة المصنع</th>
                                    <td>
                                        {% with manufacturing_order=order.manufacturing_order %}
                                            {% if manufacturing_order.status == 'pending_approval' %}
                                                <span class="badge bg-warning text-dark">
                                                    <i class="fas fa-clock me-1"></i> قيد الموافقة
                                                </span>
                                            {% elif manufacturing_order.status == 'pending' %}
                                                <span class="badge bg-info">
                                                    <i class="fas fa-hourglass-half me-1"></i> قيد الانتظار
                                                </span>
                                            {% elif manufacturing_order.status == 'in_progress' %}
                                                <span class="badge bg-primary">
                                                    <i class="fas fa-cogs me-1"></i> قيد التصنيع
                                                </span>
                                            {% elif manufacturing_order.status == 'ready_install' %}
                                                <span class="badge bg-success">
                                                    <i class="fas fa-tools me-1"></i> جاهز للتركيب
                                                </span>
                                            {% elif manufacturing_order.status == 'completed' %}
                                                <span class="badge bg-success">
                                                    <i class="fas fa-check me-1"></i> مكتمل
                                                </span>
                                            {% elif manufacturing_order.status == 'delivered' %}
                                                <span class="badge bg-success">
                                                    <i class="fas fa-truck me-1"></i> تم التسليم
                                                </span>
                                            {% elif manufacturing_order.status == 'rejected' %}
                                                <span class="badge bg-danger">
                                                    <i class="fas fa-times me-1"></i> مرفوض
                                                </span>
                                            {% elif manufacturing_order.status == 'cancelled' %}
                                                <span class="badge bg-danger">
                                                    <i class="fas fa-ban me-1"></i> ملغي
                                                </span>
                                            {% else %}
                                                <span class="badge bg-secondary">{{ manufacturing_order.get_status_display }}</span>
                                            {% endif %}
                                            {% if manufacturing_order.updated_at %}
                                                <br>
                                                <small class="text-muted">آخر تحديث: {{ manufacturing_order.updated_at|date:"Y-m-d H:i" }}</small>
                                            {% endif %}
                                        {% endwith %}
                                    </td>
                                </tr>
                            {% endif %}
                            <!-- إضافة حالة التركيب إذا كان نوع الطلب تركيب -->
                            {% if 'installation' in order.get_selected_types_list %}
                                <tr>
                                    <th>حالة التركيب</th>
                                    <td>
                                        {% if order.installation_status == 'not_scheduled' %}
                                            <span class="badge bg-secondary">
                                                <i class="fas fa-clock me-1"></i> غير مجدول
                                            </span>
                                            <br>
                                            <small class="text-muted">لم يتم جدولة التركيب بعد</small>
                                        {% elif order.installation_status == 'pending' %}
                                            <span class="badge bg-warning text-dark">
                                                <i class="fas fa-hourglass-half me-1"></i> في الانتظار
                                            </span>
                                            <br>
                                            <small class="text-muted">تم جدولة التركيب</small>
                                        {% elif order.installation_status == 'scheduled' %}
                                            <span class="badge bg-info">
                                                <i class="fas fa-calendar me-1"></i> مجدول
                                            </span>
                                            <br>
                                            <small class="text-muted">تم تحديد موعد التركيب</small>
                                        {% elif order.installation_status == 'in_progress' %}
                                            <span class="badge bg-primary">
                                                <i class="fas fa-tools me-1"></i> قيد التنفيذ
                                            </span>
                                            <br>
                                            <small class="text-muted">الفريق يعمل على التركيب</small>
                                        {% elif order.installation_status == 'completed' %}
                                            <span class="badge bg-success">
                                                <i class="fas fa-check me-1"></i> مكتمل
                                            </span>
                                            <br>
                                            <small class="text-muted">تم الانتهاء من التركيب</small>
                                        {% elif order.installation_status == 'cancelled' %}
                                            <span class="badge bg-danger">
                                                <i class="fas fa-times me-1"></i> ملغي
                                            </span>
                                            <br>
                                            <small class="text-muted">تم إلغاء التركيب</small>
                                        {% elif order.installation_status == 'modification_required' %}
                                            <span class="badge bg-warning text-dark">
                                                <i class="fas fa-exclamation-triangle me-1"></i> يحتاج تعديل
                                            </span>
                                            <br>
                                            <small class="text-muted">الطلب يحتاج تعديلات</small>
                                        {% elif order.installation_status == 'modification_in_progress' %}
                                            <span class="badge bg-info">
                                                <i class="fas fa-wrench me-1"></i> التعديل قيد التنفيذ
                                            </span>
                                            <br>
                                            <small class="text-muted">الفريق يعمل على التعديلات</small>
                                        {% elif order.installation_status == 'modification_completed' %}
                                            <span class="badge bg-success">
                                                <i class="fas fa-check-double me-1"></i> التعديل مكتمل
                                            </span>
                                            <br>
                                            <small class="text-muted">تم الانتهاء من التعديلات</small>
                                        {% else %}
                                            <span class="badge bg-secondary">
                                                <i class="fas fa-question me-1"></i> {{ order.get_installation_status_display }}
                                            </span>
                                        {% endif %}
                                        <!-- إضافة تاريخ التركيب إذا كان مجدولاً -->
                                        {% with installation=order.installationschedule_set.first %}
                                            {% if installation and installation.get_installation_date %}
                                                <br>
                                                <div class="mt-2 p-2 bg-light rounded">
                                                    <strong><i class="fas fa-calendar me-1"></i>{{ installation.get_installation_date_label }}:</strong>
                                                    <span class="text-primary">{{ installation.get_installation_date|date:"d/m/Y" }}</span>
                                                    {% if installation.scheduled_time %}
                                                        <span class="text-muted">في الساعة {{ installation.scheduled_time|time:"H:i" }}</span>
                                                    {% endif %}
                                                </div>
                                            {% endif %}
                                            <!-- إضافة رابط لتفاصيل التركيب إذا كان موجوداً -->
                                            {% if installation %}
                                                <br>
                                                <a href="{% url 'installations:installation_detail' installation.id %}"
                                                   class="btn btn-sm btn-outline-primary mt-2">
                                                    <i class="fas fa-eye me-1"></i> عرض تفاصيل التركيب
                                                </a>
                                            {% endif %}
                                        {% endwith %}
                                    </td>
                                </tr>
                            {% endif %}
                            <!-- إضافة تفاصيل التسليم من المصنع عند التسليم -->
                            {% if order.manufacturing_order and order.manufacturing_order.status == 'delivered' %}
                                {% with manufacturing_order=order.manufacturing_order %}
                                    {% if manufacturing_order.delivery_recipient_name or manufacturing_order.delivery_permit_number %}
                                        <tr>
                                            <th>تفاصيل التسليم</th>
                                            <td>
                                                <div class="delivery-details">
                                                    {% if manufacturing_order.delivery_recipient_name %}
                                                        <div class="mb-2">
                                                            <strong><i class="fas fa-user me-2"></i>اسم المستلم:</strong>
                                                            <span class="text-primary">{{ manufacturing_order.delivery_recipient_name }}</span>
                                                        </div>
                                                    {% endif %}
                                                    {% if manufacturing_order.delivery_permit_number %}
                                                        <div class="mb-2">
                                                            <strong><i class="fas fa-file-alt me-2"></i>رقم إذن التسليم:</strong>
                                                            <span class="text-info">{{ manufacturing_order.delivery_permit_number }}</span>
                                                        </div>
                                                    {% endif %}
                                                    {% if manufacturing_order.delivery_date %}
                                                        <div class="mb-2">
                                                            <strong><i class="fas fa-calendar me-2"></i>تاريخ التسليم:</strong>
                                                            <span class="text-success">{{ manufacturing_order.delivery_date|date:"Y-m-d H:i" }}</span>
                                                        </div>
                                                    {% endif %}
                                                    {% if manufacturing_order.exit_permit_number %}
                                                        <div class="mb-2">
                                                            <strong><i class="fas fa-sign-out-alt me-2"></i>رقم إذن الخروج:</strong>
                                                            <span class="text-warning">{{ manufacturing_order.exit_permit_number }}</span>
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            </td>
                                        </tr>
                                    {% endif %}
                                {% endwith %}
                            {% endif %}
                            <!-- عرض سجل حالات الرفض والردود -->
                            {% if rejection_logs %}
                                {% with manufacturing_order=order.manufacturing_order %}
                                    <tr>
                                        <th>سجل حالات الرفض</th>
                                        <td>
                                            <div class="rejection-logs-container">
                                                {% for log in rejection_logs %}
                                                    <div class="rejection-log-item card mb-3 {% if forloop.first and manufacturing_order.status == 'rejected' %}border-danger{% else %}border-secondary{% endif %}">
                                                        <div class="card-header {% if forloop.first and manufacturing_order.status == 'rejected' %}bg-danger text-white{% else %}bg-light{% endif %}">
                                                            <div class="d-flex justify-content-between align-items-center">
                                                                <strong>
                                                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                                                    رفض #{{ forloop.counter }}
                                                                    {% if forloop.first and manufacturing_order.status == 'rejected' %}
                                                                        <span class="badge bg-warning text-dark ms-2">حالي</span>
                                                                    {% else %}
                                                                        <span class="badge bg-secondary ms-2">سابق</span>
                                                                    {% endif %}
                                                                </strong>
                                                                <small>
                                                                    <i class="fas fa-clock me-1"></i>
                                                                    {{ log.rejected_at|date:"Y-m-d H:i" }}
                                                                </small>
                                                            </div>
                                                        </div>
                                                        <div class="card-body">
                                                            <!-- سبب الرفض -->
                                                            <div class="alert alert-danger mb-3">
                                                                <strong>سبب الرفض:</strong>
                                                                <div class="mt-2">{{ log.rejection_reason }}</div>
                                                                {% if log.rejected_by %}
                                                                    <small class="text-muted d-block mt-2">
                                                                        <i class="fas fa-user me-1"></i>
                                                                        تم الرفض بواسطة: {{ log.rejected_by.get_full_name|default:log.rejected_by.username }}
                                                                    </small>
                                                                {% endif %}
                                                                {% if log.previous_status %}
                                                                    <small class="text-muted d-block mt-1">
                                                                        <i class="fas fa-history me-1"></i>
                                                                        الحالة قبل الرفض: {{ log.get_previous_status_display|default:log.previous_status }}
                                                                    </small>
                                                                {% endif %}
                                                            </div>
                                                            <!-- الرد على الرفض -->
                                                            {% if log.reply_message %}
                                                                <div class="alert alert-info mb-0">
                                                                    <strong><i class="fas fa-reply me-2"></i>الرد على الرفض:</strong>
                                                                    <div class="mt-2">{{ log.reply_message }}</div>
                                                                    <div class="mt-2">
                                                                        {% if log.replied_by %}
                                                                            <small class="text-muted">
                                                                                <i class="fas fa-user me-1"></i>
                                                                                تم الرد بواسطة: {{ log.replied_by.get_full_name|default:log.replied_by.username }}
                                                                            </small>
                                                                        {% endif %}
                                                                        {% if log.replied_at %}
                                                                            <small class="text-muted d-block mt-1">
                                                                                <i class="fas fa-clock me-1"></i>
                                                                                تاريخ الرد: {{ log.replied_at|date:"Y-m-d H:i" }}
                                                                            </small>
                                                                        {% endif %}
                                                                    </div>
                                                                </div>
                                                            {% else %}
                                                                <!-- زر الرد على الرفض إذا لم يتم الرد بعد -->
                                                                {% if user.is_superuser or user.is_staff or order.created_by_id == user.id or perms.manufacturing.can_approve_orders or perms.orders.change_order %}
                                                                    <div class="text-center">
                                                                        <button class="btn btn-outline-primary btn-sm"
                                                                                onclick="showReplyToRejectionModal({{ log.id }}, '{{ log.rejection_reason|escapejs }}')">
                                                                            <i class="fas fa-reply me-1"></i>
                                                                            الرد على هذا الرفض
                                                                        </button>
                                                                    </div>
                                                                {% endif %}
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        </td>
                                    </tr>
                                {% endwith %}
                            {% endif %}
                            <tr>
                                <th>الإجمالي (قبل الخصم)</th>
                                <td class="fw-bold text-muted">{{ order.total_amount|clean_decimal_currency:currency_symbol }}</td>
                            </tr>
                            <tr>
                                <th>إجمالي الخصم</th>
                                <td class="text-danger">
                                    <strong>- {{ order.total_discount_amount|clean_decimal_currency:currency_symbol }}</strong>
                                    {% if order.administrative_discount_amount and order.administrative_discount_amount > 0 %}
                                        <br>
                                        <small class="text-muted">
                                            (يشمل خصم إداري: {{ order.administrative_discount_amount|clean_decimal_currency:currency_symbol }})
                                        </small>
                                    {% endif %}
                                </td>
                            </tr>
                            {% if order.financial_addition > 0 %}
                                <tr>
                                    <th>إضافات مالية</th>
                                    <td class="text-info">+ {{ order.financial_addition|clean_decimal_currency:currency_symbol }}</td>
                                </tr>
                            {% endif %}
                            <tr class="table-primary border-top border-2">
                                <th class="py-2">الصافي النهائي (المطلوب)</th>
                                <td class="fw-bold fs-5 py-2">{{ order.final_price|clean_decimal_currency:currency_symbol }}</td>
                            </tr>
                            <tr>
                                <th>المبلغ المدفوع</th>
                                <td class="text-success">{{ order.paid_amount|clean_decimal_currency:currency_symbol }}</td>
                            </tr>
                            <tr class="{% if order.remaining_amount > 0 %}table-warning{% else %}table-success{% endif %} border-top">
                                <th class="py-2">المبلغ المتبقي</th>
                                <td class="fw-bold py-2">{{ order.remaining_amount|clean_decimal_currency:currency_symbol }}</td>
                            </tr>
                            <tr>
                                <th>تم الإنشاء بواسطة</th>
                                <td>
                                    {% if order.created_by %}
                                        {{ order.created_by.get_full_name|default:order.created_by.username }}
                                    {% else %}
                                        غير محدد
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>تاريخ الإنشاء</th>
                                <td>{{ order.created_at|date:"Y-m-d H:i" }}</td>
                            </tr>
                            <tr>
                                <th>تاريخ التحديث</th>
                                <td>{{ order.updated_at|date:"Y-m-d H:i" }}</td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
            <!-- Customer Information & Order Type Information -->
            <div class="col-lg-4 col-md-12">
                <div class="card mb-4 h-100">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">معلومات العميل ونوع الطلب</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-bordered table-sm">
                            <tr>
                                <th style="width: 40%">نوع العميل</th>
                                <td>
                                    <span class="badge {% if order.customer.customer_type == 'wholesale' %}bg-primary{% else %}bg-info{% endif %}">
                                        {{ order.customer.get_customer_type_display }}
                                    </span>
                                </td>
                            </tr>
                            <tr>
                                <th style="width: 40%">الاسم</th>
                                <td>
                                    <a href="{% url 'customers:customer_detail' order.customer.pk %}"
                                       class="text-decoration-none">
                                        <i class="fas fa-user me-1"></i>{{ order.customer.name }}
                                    </a>
                                </td>
                            </tr>
                            {% if order.delivery_location %}
                                <tr>
                                    <th>مكان التسليم</th>
                                    <td class="text-success fw-bold">
                                        <i class="fas fa-truck me-1"></i>{{ order.delivery_location }}
                                    </td>
                                </tr>
                            {% endif %}
                            <tr>
                                <th>رقم الهاتف</th>
                                <td>{{ order.customer.phone }}</td>
                            </tr>
                            <tr>
                                <th>البريد الإلكتروني</th>
                                <td>{{ order.customer.email|default:"غير متوفر" }}</td>
                            </tr>
                            <tr>
                                <th>العنوان</th>
                                <td>{{ order.customer.address|default:"غير متوفر" }}</td>
                            </tr>
                            <tr>
                                <th>نوع الطلب</th>
                                <td>
                                    {% with types_list=order.get_selected_types_list %}
                                        {% if types_list %}
                                            {% for type in types_list %}
                                                {% if type == 'accessory' %}
                                                    <span class="badge bg-primary me-2">
                                                        <i class="fas fa-gem me-1"></i> إكسسوار
                                                    </span>
                                                {% elif type == 'installation' %}
                                                    <span class="badge bg-warning me-2">
                                                        <i class="fas fa-tools me-1"></i> تركيب
                                                    </span>
                                                {% elif type == 'inspection' %}
                                                    <span class="badge bg-info me-2">
                                                        <i class="fas fa-eye me-1"></i> معاينة
                                                    </span>
                                                {% elif type == 'tailoring' %}
                                                    <span class="badge bg-success me-2">
                                                        <i class="fas fa-cut me-1"></i> تفصيل
                                                    </span>
                                                {% else %}
                                                    <span class="badge bg-secondary me-2">{{ type }}</span>
                                                {% endif %}
                                            {% endfor %}
                                        {% else %}
                                            <span class="text-muted">غير محدد</span>
                                        {% endif %}
                                    {% endwith %}
                                </td>
                            </tr>
                            <!-- Inspection Status for inspection orders -->
                            {% with types_list=order.get_selected_types_list %}
                                {% if 'inspection' in types_list or 'inspection' in order.selected_types %}
                                    <tr>
                                        <th>حالة المعاينة</th>
                                        <td>
                                            {% with inspection=order.inspections.first %}
                                                {% if inspection %}
                                                    <div class="d-flex align-items-center gap-2 flex-wrap">
                                                        {% get_status_badge inspection.status "inspection" %}
                                                        {% if inspection.result %}
                                                            <span class="badge {% if inspection.result == 'passed' %}bg-success {% else %}bg-danger{% endif %}">
                                                                {% if inspection.result == 'passed' %}
                                                                    <i class="fas fa-thumbs-up me-1"></i> نجحت
                                                                {% else %}
                                                                    <i class="fas fa-thumbs-down me-1"></i> فشلت
                                                                {% endif %}
                                                            </span>
                                                        {% endif %}
                                                    </div>
                                                    <div class="mt-2">
                                                        <small class="text-muted">آخر تحديث: {{ inspection.updated_at|date:"Y-m-d H:i" }}</small>
                                                    </div>
                                                {% else %}
                                                    <span class="badge bg-secondary">
                                                        <i class="fas fa-exclamation-triangle me-1"></i> لم يتم إنشاء المعاينة بعد
                                                    </span>
                                                {% endif %}
                                            {% endwith %}
                                        </td>
                                    </tr>
                                {% endif %}
                            {% endwith %}
                            {% if order.goods_type %}
                                <tr>
                                    <th>نوع البضاعة</th>
                                    <td>{{ order.get_goods_type_display }}</td>
                                </tr>
                            {% endif %}
                            {% if order.service_types %}
                                <tr>
                                    <th>أنواع الخدمات</th>
                                    <td>
                                        {% for service_type in order.service_types %}
                                            {% if service_type == 'installation' %}
                                                <span class="badge bg-info">تركيب</span>
                                            {% elif service_type == 'inspection' %}
                                                <span class="badge bg-primary">معاينة</span>
                                            {% elif service_type == 'transport' %}
                                                <span class="badge bg-secondary">نقل</span>
                                            {% elif service_type == 'tailoring' %}
                                                <span class="badge bg-warning">تفصيل</span>
                                            {% endif %}
                                        {% endfor %}
                                    </td>
                                </tr>
                            {% endif %}
                            {% if order.invoice_number %}
                                <tr>
                                    <th>رقم المرجع</th>
                                    <td>{{ order.invoice_number }}</td>
                                </tr>
                            {% endif %}
                            {% if order.invoice_number_2 %}
                                <tr>
                                    <th>رقم المرجع الإضافي 2</th>
                                    <td>{{ order.invoice_number_2 }}</td>
                                </tr>
                            {% endif %}
                            {% if order.invoice_number_3 %}
                                <tr>
                                    <th>رقم المرجع الإضافي 3</th>
                                    <td>{{ order.invoice_number_3 }}</td>
                                </tr>
                            {% endif %}
                            <tr>
                                <th>صورة الفاتورة</th>
                                <td>
                                    {% if order.invoice_image %}
                                        <button type="button"
                                                class="btn btn-sm btn-success"
                                                data-bs-toggle="modal"
                                                data-bs-target="#invoiceImageModal">
                                            <i class="fas fa-image me-1"></i> عرض صورة الفاتورة
                                        </button>
                                    {% else %}
                                        <span class="text-muted">
                                            <i class="fas fa-image me-1"></i>
                                            لم يتم إرفاق صورة الفاتورة
                                        </span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>تم التحقق من الدفع</th>
                                <td>
                                    {% load order_extras %}
                                    {% if order.payment_verified %}
                                        <span class="badge bg-success">نعم</span>
                                    {% else %}
                                        <span class="badge bg-danger">لا</span>
                                    {% endif %}
                                    <span class="ms-2 text-muted">( {% paid_percentage order %} )</span>
                                </td>
                            </tr>
                            <tr>
                                <th>الفرع</th>
                                <td>{{ order.branch.name }}</td>
                            </tr>
                            {% if 'inspection' in order.service_types and order.inspections.exists %}
                                <tr>
                                    <th>ملفات المعاينة</th>
                                    <td>
                                        {% for inspection in order.inspections.all %}
                                            <div class="mb-3 p-3"
                                                 style="background:linear-gradient(135deg,#f5f7fa 0%,#c3cfe2 100%);
                                                        border-radius:8px;
                                                        border:1px solid #e0e0e0">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <span class="fw-bold" style="color:#495057;">
                                                        <i class="fas fa-clipboard-check me-1"></i>معاينة #{{ inspection.pk }}
                                                    </span>
                                                    {% get_status_badge inspection.status "inspection" %}
                                                </div>
                                                {% if inspection.files.exists %}
                                                    <div class="d-flex flex-wrap gap-2">
                                                        {% for file in inspection.files.all %}
                                                            <div class="file-badge d-inline-flex align-items-center"
                                                                 style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
                                                                        border-radius:6px;
                                                                        padding:5px 12px;
                                                                        color:#fff;
                                                                        box-shadow:0 2px 4px rgba(0,0,0,0.15)">
                                                                <span style="font-size:0.7em;
                                                                             background:rgba(255,255,255,0.2);
                                                                             padding:1px 5px;
                                                                             border-radius:3px;
                                                                             margin-left:6px">{{ forloop.counter }}</span>
                                                                <a href="{{ file.file.url }}"
                                                                   target="_blank"
                                                                   class="text-white"
                                                                   title="تحميل الملف">
                                                                    <i class="fas fa-file-pdf" style="font-size:1.15em;"></i>
                                                                </a>
                                                                {% if file.is_uploaded_to_drive and file.google_drive_file_url %}
                                                                    <a href="{{ file.google_drive_file_url }}"
                                                                       target="_blank"
                                                                       class="text-white ms-2"
                                                                       title="فتح في Google Drive"
                                                                       style="opacity:0.9">
                                                                        <i class="fab fa-google-drive" style="font-size:1.05em;"></i>
                                                                    </a>
                                                                {% else %}
                                                                    <i class="fas fa-sync fa-spin ms-2"
                                                                       style="font-size:0.75em;
                                                                              opacity:0.7"
                                                                       title="جاري الرفع..."></i>
                                                                {% endif %}
                                                            </div>
                                                        {% endfor %}
                                                    </div>
                                                {% elif inspection.inspection_file %}
                                                    <div class="d-flex align-items-center gap-2">
                                                        <div class="file-badge d-inline-flex align-items-center"
                                                             style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
                                                                    border-radius:6px;
                                                                    padding:5px 12px;
                                                                    color:#fff;
                                                                    box-shadow:0 2px 4px rgba(0,0,0,0.15)">
                                                            <a href="{{ inspection.inspection_file.url }}"
                                                               target="_blank"
                                                               class="text-white"
                                                               title="تحميل الملف">
                                                                <i class="fas fa-file-pdf" style="font-size:1.2em;"></i>
                                                                <span class="ms-1" style="font-size:0.85em;">ملف</span>
                                                            </a>
                                                            {% if inspection.is_uploaded_to_drive and inspection.google_drive_file_url %}
                                                                <a href="{{ inspection.google_drive_file_url }}"
                                                                   target="_blank"
                                                                   class="text-white ms-3"
                                                                   title="Google Drive">
                                                                    <i class="fab fa-google-drive" style="font-size:1.1em;"></i>
                                                                </a>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                {% else %}
                                                    <span class="badge bg-secondary">
                                                        <i class="fas fa-file-circle-xmark me-1"></i>بدون ملفات
                                                    </span>
                                                {% endif %}
                                            </div>
                                        {% endfor %}
                                    </td>
                                </tr>
                            {% endif %}
                        </table>
                    </div>
                </div>
            </div>
            <!-- Notes Section -->
            <div class="col-lg-4 col-md-12">
                <!-- Order Notes -->
                <div class="card mb-3">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">ملاحظات الطلب</h6>
                    </div>
                    <div class="card-body">
                        {% if order.notes %}
                            <p class="mb-0 small">{{ order.notes|linebreaks }}</p>
                        {% else %}
                            <p class="text-muted mb-0 small">لا توجد ملاحظات</p>
                        {% endif %}
                    </div>
                </div>
                <!-- Customer Notes -->
                <div class="card mb-3">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0">
                            <i class="fas fa-sticky-note me-2"></i>ملاحظات العميل
                        </h6>
                    </div>
                    <div class="card-body">
                        {% if customer_notes %}
                            <div class="customer-notes-list">
                                {% for note in customer_notes %}
                                    <div class="note-item border-bottom pb-2 mb-2">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div class="flex-grow-1">
                                                <p class="mb-1 small">{{ note.note|linebreaks }}</p>
                                                <small class="text-muted" style="font-size: 0.7rem;">
                                                    <i class="fas fa-user me-1"></i>{{ note.created_by.get_full_name|default:note.created_by.username }}
                                                    <i class="fas fa-clock me-1 ms-2"></i>{{ note.created_at|date:"Y-m-d H:i" }}
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                            <div class="text-center mt-3">
                                <a href="{% url 'customers:customer_detail' order.customer.pk %}"
                                   class="btn btn-outline-info btn-sm">
                                    <i class="fas fa-eye me-1"></i>عرض الكل
                                </a>
                            </div>
                        {% else %}
                            <div class="text-center text-muted py-2">
                                <i class="fas fa-sticky-note fa-2x mb-2"></i>
                                <p class="mb-2 small">لا توجد ملاحظات للعميل</p>
                                <a href="{% url 'customers:customer_detail' order.customer.pk %}"
                                   class="btn btn-outline-info btn-sm">
                                    <i class="fas fa-plus me-1"></i>إضافة
                                </a>
                            </div>
                        {% endif %}
                    </div>
                </div>
                <!-- Contract Information -->
                {% with types_list=order.get_selected_types_list %}
                    {% if 'installation' in types_list or 'tailoring' in types_list or 'accessory' in types_list or order.order_type in 'installation,tailoring,accessory' %}
                        <div class="card mb-3">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0">
                                    <i class="fas fa-file-contract"></i> معلومات العقد
                                </h6>
                            </div>
                            <div class="card-body">
                                <table class="table table-bordered table-sm mb-0">
                                    <tr>
                                        <th style="width: 40%">رقم العقد</th>
                                        <td>
                                            <span dir="ltr"
                                                  style="font-weight: bold;
                                                         color: #a67c52;
                                                         font-size: 0.85rem">
                                                {{ order.order_number }}-{{ order.contract_number|default:"c1" }}
                                            </span>
                                        </td>
                                    </tr>
                                    {% if order.contract_number_2 %}
                                        <tr>
                                            <th>رقم العقد الإضافي 2</th>
                                            <td>
                                                <span dir="ltr"
                                                      style="font-weight: bold;
                                                             color: #a67c52;
                                                             font-size: 0.85rem">{{ order.contract_number_2 }}</span>
                                            </td>
                                        </tr>
                                    {% endif %}
                                    {% if order.contract_number_3 %}
                                        <tr>
                                            <th>رقم العقد الإضافي 3</th>
                                            <td>
                                                <span dir="ltr"
                                                      style="font-weight: bold;
                                                             color: #a67c52;
                                                             font-size: 0.85rem">{{ order.contract_number_3 }}</span>
                                            </td>
                                        </tr>
                                    {% endif %}
                                    <tr>
                                        <th>ملف العقد</th>
                                        <td>
                                            {% if order.contract_file %}
                                                <a href="{% url 'orders:preview_contract' order.id %}"
                                                   target="_blank"
                                                   class="btn btn-sm btn-primary"
                                                   rel="noopener noreferrer">
                                                    <i class="fas fa-file-pdf"></i> عرض العقد
                                                </a>
                                                {% if user.is_superuser or user.is_staff %}
                                                    <button type="button"
                                                            class="btn btn-sm btn-outline-warning ms-1"
                                                            onclick="regenerateContract({{ order.pk }})"
                                                            title="إعادة توليد العقد - سيتم إنشاء ملف جديد">
                                                        <i class="fas fa-sync-alt"></i> إعادة توليد
                                                    </button>
                                                {% endif %}
                                                <br>
                                                <small class="text-muted">
                                                    آخر تحديث:
                                                    {% if order.contract_file.name %}
                                                        {% with order.contract_file.name|slice:"-19:-4" as timestamp %}
                                                            {% if timestamp|length == 15 %}
                                                                {{ timestamp|slice:":4" }}-{{ timestamp|slice:"4:6" }}-{{ timestamp|slice:"6:8" }}
                                                                {{ timestamp|slice:"9:11" }}:{{ timestamp|slice:"11:13" }}:{{ timestamp|slice:"13:15" }}
                                                            {% else %}
                                                                غير معروف
                                                            {% endif %}
                                                        {% endwith %}
                                                    {% endif %}
                                                </small>
                                            {% else %}
                                                <span class="text-muted small">لم يتم توليد العقد</span>
                                                {% if user.is_superuser or user.is_staff %}
                                                    <button type="button"
                                                            class="btn btn-sm btn-success ms-1"
                                                            onclick="regenerateContract({{ order.pk }})"
                                                            title="توليد ملف العقد">
                                                        <i class="fas fa-file-pdf"></i> توليد العقد
                                                    </button>
                                                {% endif %}
                                            {% endif %}
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>عدد الستائر</th>
                                        <td>
                                            {% with curtain_count=order.contract_curtains.count %}
                                                {% if curtain_count > 0 %}
                                                    <span class="badge bg-success">{{ curtain_count }} ستارة</span>
                                                {% else %}
                                                    <span class="text-muted small">لم يتم إضافة ستائر</span>
                                                {% endif %}
                                            {% endwith %}
                                        </td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    {% endif %}
                {% endwith %}
                <!-- Administrative Discount Card - الخصم الإداري -->
                {% if user.can_apply_administrative_discount %}
                    <div class="card mb-3">
                        <div class="card-header bg-warning" style="padding: 0.5rem 1rem;">
                            <h6 class="mb-0">
                                <i class="fas fa-percentage me-1"></i>الخصم الإداري
                            </h6>
                        </div>
                        <div class="card-body" style="padding: 0.75rem;">
                            {% if order.administrative_discount_amount and order.administrative_discount_amount > 0 %}
                                <!-- عرض الخصم الإداري المطبق -->
                                <div class="alert alert-success mb-2" style="padding: 0.5rem;">
                                    <small><i class="fas fa-check-circle me-1"></i>تم التطبيق بنجاح</small>
                                </div>
                                <table class="table table-bordered table-sm mb-0" style="font-size: 0.85rem">
                                    <tr>
                                        <th style="width: 40%">
                                            <i class="fas fa-money-bill-wave me-1"></i>القيمة
                                        </th>
                                        <td>
                                            <strong class="text-danger">{{ order.administrative_discount_amount|clean_decimal_currency:currency_symbol }}</strong>
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>
                                            <i class="fas fa-user me-1"></i>بواسطة
                                        </th>
                                        <td>
                                            <small>{{ order.administrative_discount_by.get_full_name|default:order.administrative_discount_by.username }}</small>
                                        </td>
                                    </tr>
                                    {% if order.administrative_discount_notes %}
                                        <tr>
                                            <th>
                                                <i class="fas fa-sticky-note me-1"></i>ملاحظات
                                            </th>
                                            <td>
                                                <small>{{ order.administrative_discount_notes }}</small>
                                            </td>
                                        </tr>
                                    {% endif %}
                                </table>
                            {% else %}
                                <!-- نموذج تطبيق الخصم الإداري -->
                                <div class="alert alert-info mb-2"
                                     style="padding: 0.5rem;
                                            font-size: 0.8rem">
                                    <i class="fas fa-info-circle me-1"></i>يطبق مرة واحدة فقط
                                </div>
                                <div class="mb-2">
                                    <label class="form-label" style="font-size: 0.85rem; margin-bottom: 0.25rem">
                                        <i class="fas fa-money-bill-wave me-1"></i>قيمة الخصم
                                    </label>
                                    <div class="input-group input-group-sm">
                                        <input type="number"
                                               step="0.01"
                                               min="0"
                                               class="form-control"
                                               id="admin_discount_amount"
                                               placeholder="0.00"
                                               required>
                                        <span class="input-group-text">{{ currency_symbol }}</span>
                                    </div>
                                </div>
                                <div class="mb-2">
                                    <label class="form-label" style="font-size: 0.85rem; margin-bottom: 0.25rem">
                                        <i class="fas fa-sticky-note me-1"></i>ملاحظات
                                    </label>
                                    <input type="text"
                                           class="form-control form-control-sm"
                                           id="admin_discount_notes"
                                           placeholder="سبب الخصم">
                                </div>
                                <button type="button"
                                        class="btn btn-warning btn-sm w-100"
                                        onclick="applyAdministrativeDiscount({{ order.id }})">
                                    <i class="fas fa-check-circle me-1"></i>تطبيق
                                </button>
                            {% endif %}
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
        <!-- سجل حذف أوامر التصنيع -->
        {% if order.manufacturing_deletion_logs.exists %}
            <div class="card mb-4">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-trash-alt me-2"></i>
                        سجل حذف أوامر التصنيع
                    </h5>
                    <small>تفاصيل أوامر التصنيع المحذوفة لهذا الطلب</small>
                </div>
                <div class="card-body">
                    {% for deletion_log in order.manufacturing_deletion_logs.all %}
                        <div class="alert alert-danger d-flex align-items-start mb-3">
                            <div class="flex-shrink-0 me-3">
                                <i class="fas fa-exclamation-triangle fa-2x text-danger"></i>
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="alert-heading mb-2">
                                    <i class="fas fa-trash-alt me-1"></i>
                                    تم حذف أمر التصنيع #{{ deletion_log.manufacturing_order_id }}
                                </h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <p class="mb-1">
                                            <strong>تاريخ الحذف:</strong>
                                            {{ deletion_log.deleted_at|date:"Y-m-d H:i" }}
                                        </p>
                                        <p class="mb-1">
                                            <strong>تم الحذف بواسطة:</strong>
                                            {% if deletion_log.deleted_by %}
                                                <span class="badge bg-dark">{{ deletion_log.deleted_by.get_full_name|default:deletion_log.deleted_by.username }}</span>
                                            {% else %}
                                                <span class="text-muted">نظام</span>
                                            {% endif %}
                                        </p>
                                    </div>
                                    <div class="col-md-6">
                                        {% if deletion_log.manufacturing_order_data.status_display %}
                                            <p class="mb-1">
                                                <strong>حالة أمر التصنيع قبل الحذف:</strong>
                                                <span class="badge bg-secondary">{{ deletion_log.manufacturing_order_data.status_display }}</span>
                                            </p>
                                        {% endif %}
                                    </div>
                                </div>
                                {% if deletion_log.reason %}
                                    <div class="mt-2">
                                        <strong>السبب:</strong>
                                        <p class="mb-0 mt-1 p-2 bg-light rounded">{{ deletion_log.reason }}</p>
                                    </div>
                                {% endif %}
                                <!-- تفاصيل إضافية قابلة للطي -->
                                <div class="mt-3">
                                    <button class="btn btn-sm btn-outline-secondary"
                                            type="button"
                                            data-bs-toggle="collapse"
                                            data-bs-target="#deletionDetails{{ deletion_log.id }}"
                                            aria-expanded="false">
                                        <i class="fas fa-info-circle me-1"></i>
                                        عرض تفاصيل أمر التصنيع المحذوف
                                    </button>
                                    <div class="collapse mt-2" id="deletionDetails{{ deletion_log.id }}">
                                        <div class="card card-body bg-light">
                                            <div class="row">
                                                {% if deletion_log.manufacturing_order_data.contract_number %}
                                                    <div class="col-md-4">
                                                        <strong>رقم العقد:</strong> {{ deletion_log.manufacturing_order_data.contract_number }}
                                                    </div>
                                                {% endif %}
                                                {% if deletion_log.manufacturing_order_data.invoice_number %}
                                                    <div class="col-md-4">
                                                        <strong>رقم الفاتورة:</strong> {{ deletion_log.manufacturing_order_data.invoice_number }}
                                                    </div>
                                                {% endif %}
                                                {% if deletion_log.manufacturing_order_data.order_date %}
                                                    <div class="col-md-4">
                                                        <strong>تاريخ الطلب:</strong> {{ deletion_log.manufacturing_order_data.order_date|date:"Y-m-d" }}
                                                    </div>
                                                {% endif %}
                                                {% if deletion_log.manufacturing_order_data.expected_delivery_date %}
                                                    <div class="col-md-4">
                                                        <strong>تاريخ التسليم المتوقع:</strong> {{ deletion_log.manufacturing_order_data.expected_delivery_date|date:"Y-m-d" }}
                                                    </div>
                                                {% endif %}
                                                {% if deletion_log.manufacturing_order_data.created_by %}
                                                    <div class="col-md-4">
                                                        <strong>تم الإنشاء بواسطة:</strong> {{ deletion_log.manufacturing_order_data.created_by }}
                                                    </div>
                                                {% endif %}
                                                {% if deletion_log.manufacturing_order_data.created_at %}
                                                    <div class="col-md-4">
                                                        <strong>تاريخ الإنشاء:</strong> {{ deletion_log.manufacturing_order_data.created_at|date:"Y-m-d H:i" }}
                                                    </div>
                                                {% endif %}
                                            </div>
                                            {% if deletion_log.manufacturing_order_data.notes %}
                                                <div class="mt-2">
                                                    <strong>ملاحظات أمر التصنيع:</strong>
                                                    <p class="mb-0 mt-1">{{ deletion_log.manufacturing_order_data.notes }}</p>
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}
        <!-- Order Items - Hidden for inspection orders -->
        {% with types_list=order.get_selected_types_list %}
            {% if 'inspection' not in types_list and 'inspection' not in order.selected_types %}
                {% if order_items|length == 0 %}
                    <div class="alert alert-danger text-center fw-bold my-4"
                         style="font-size:1.3rem">
                        طلب بدون عناصر - تم إنشاء هذا الطلب بمسؤولية المستخدم:
                        <span class="text-primary">
                            {% if order.created_by %}
                                {{ order.created_by.get_full_name|default:order.created_by.username }}
                            {% else %}
                                <span class="text-danger">مستخدم غير معروف</span>
                            {% endif %}
                        </span>
                    </div>
                {% else %}
                    <div class="card mb-4 mt-4">
                        <div class="card-header bg-light d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">عناصر الطلب</h5>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover table-striped mb-0">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>المنتج</th>
                                            <th>الكمية</th>
                                            <th>سعر الوحدة</th>
                                            <th>نسبة الخصم</th>
                                            <th>مبلغ الخصم</th>
                                            <th>السعر بعد الخصم</th>
                                            <th>ملاحظات</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for item in order_items %}
                                            <tr>
                                                <td>{{ forloop.counter }}</td>
                                                <td>{{ item.product.name }}</td>
                                                <td>{{ item.quantity|clean_decimal }}</td>
                                                <td>
                                                    {% if item.is_manual_price %}
                                                        <span style="color: #d35400; font-weight: bold;">{{ item.unit_price|clean_decimal_currency:currency_symbol }}</span>
                                                        <span class="badge bg-warning text-dark ms-1"
                                                              style="font-size: 0.65rem"
                                                              data-bs-toggle="tooltip"
                                                              title="تم تعديل السعر يدوياً">
                                                            <i class="fas fa-pen"></i>
                                                        </span>
                                                    {% else %}
                                                        {{ item.unit_price|clean_decimal_currency:currency_symbol }}
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if item.discount_percentage and item.discount_percentage > 0 %}
                                                        <span class="badge bg-warning text-dark">{{ item.get_clean_discount_display }}%</span>
                                                    {% else %}
                                                        <span class="text-muted">0%</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if item.discount_amount and item.discount_amount > 0 %}
                                                        <span class="text-danger">-{{ item.discount_amount|clean_decimal_currency:currency_symbol }}</span>
                                                    {% else %}
                                                        <span class="text-muted">0.00 {{ currency_symbol }}</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <strong class="text-success">{{ item.total_after_discount|clean_decimal_currency:currency_symbol }}</strong>
                                                </td>
                                                <td>{{ item.notes|default:"-" }}</td>
                                            </tr>
                                        {% empty %}
                                            <tr>
                                                <td colspan="8" class="text-center py-3">لا توجد عناصر في هذا الطلب</td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                    <tfoot>
                                        <tr class="table-light">
                                            <th colspan="4" class="text-start">المجموع قبل الخصم (عناصر الطلب)</th>
                                            <th colspan="2">
                                                {% if computed_total_amount is not None %}
                                                    {{ computed_total_amount|clean_decimal_currency:currency_symbol }}
                                                {% else %}
                                                    {{ order.total_amount|clean_decimal_currency:currency_symbol }}
                                                {% endif %}
                                            </th>
                                            <td colspan="2"></td>
                                        </tr>
                                        <tr class="table-warning">
                                            <th colspan="4" class="text-start">إجمالي الخصم</th>
                                            <th colspan="2">
                                                {% if computed_total_discount_amount is not None %}
                                                    {{ computed_total_discount_amount|clean_decimal_currency:currency_symbol }}
                                                {% else %}
                                                    {{ order.total_discount_amount|clean_decimal_currency:currency_symbol }}
                                                {% endif %}
                                                {% if order.administrative_discount_amount and order.administrative_discount_amount > 0 %}
                                                    <br>
                                                    <small class="text-muted fst-italic">
                                                        (يشمل خصم إداري: {{ order.administrative_discount_amount|clean_decimal_currency:currency_symbol }})
                                                    </small>
                                                {% endif %}
                                            </th>
                                            <td colspan="2"></td>
                                        </tr>
                                        {% if order.financial_addition > 0 %}
                                            <tr class="table-info">
                                                <th colspan="4" class="text-start">إضافات مالية</th>
                                                <th colspan="2">+ {{ order.financial_addition|clean_decimal_currency:currency_symbol }}</th>
                                                <td colspan="2"></td>
                                            </tr>
                                        {% endif %}
                                        <tr class="table-success">
                                            <th colspan="4" class="text-start">الإجمالي النهائي بعد الخصم والإضافات</th>
                                            <th colspan="2">
                                                {% if computed_final_price_after_discount is not None %}
                                                    {{ computed_final_price_after_discount|clean_decimal_currency:currency_symbol }}
                                                {% else %}
                                                    {{ order.final_price|clean_decimal_currency:currency_symbol }}
                                                {% endif %}
                                            </th>
                                            <td colspan="2"></td>
                                        </tr>
                                        {% if order.used_customer_balance > 0 %}
                                            <tr class="table-secondary">
                                                <th colspan="4" class="text-start">رصيد مستخدم من الحساب</th>
                                                <th colspan="2">- {{ order.used_customer_balance|clean_decimal_currency:currency_symbol }}</th>
                                                <td colspan="2"></td>
                                            </tr>
                                        {% endif %}
                                        <tr class="table-primary">
                                            <th colspan="4" class="text-start">المتبقي المطلوب</th>
                                            <th colspan="2">
                                                {% if computed_remaining_amount is not None %}
                                                    {{ computed_remaining_amount|clean_decimal_currency:currency_symbol }}
                                                {% else %}
                                                    {{ order.remaining_amount|clean_decimal_currency:currency_symbol }}
                                                {% endif %}
                                            </th>
                                            <td colspan="2"></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                {% endif %}
            {% endif %}
        {% endwith %}
        <!-- Cutting Orders Details -->
        {% with types_list=order.get_selected_types_list %}
            {% if 'inspection' not in types_list %}
                <div class="card mb-4">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">
                            <i class="fas fa-cut me-2"></i>
                            بطاقة تتبع التقطيع
                        </h5>
                        <small>معلومات شاملة عن حالة التقطيع المرتبطة بهذا الطلب</small>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover table-striped mb-0">
                                <thead class="table-warning">
                                    <tr>
                                        <th width="25%">أسماء المنتجات</th>
                                        <th width="15%">المستودع</th>
                                        <th width="10%">العناصر</th>
                                        <th width="15%">تاريخ الإنشاء</th>
                                        <th width="15%">تاريخ الإكمال</th>
                                        <th width="10%">الحالة</th>
                                        <th width="10%">عرض</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for cutting_order in order.cutting_orders.all %}
                                        <tr class="{% if cutting_order.status == 'completed' %}table-success{% elif cutting_order.status == 'in_progress' %}table-info{% elif cutting_order.status == 'rejected' %}table-danger{% else %}table-light{% endif %}">
                                            <td>
                                                <div class="product-names">
                                                    {% for item in cutting_order.items.all %}
                                                        <div class="mb-1">
                                                            <span class="badge bg-primary me-1">{{ forloop.counter }}</span>
                                                            {% if item.is_external %}
                                                                <strong>{{ item.external_fabric_name }}</strong> <span class="badge bg-danger">قماش خارجي</span>
                                                            {% else %}
                                                                <strong>{{ item.order_item.product.name|default:"منتج غير محدد" }}</strong>
                                                                {% if item.order_item.product.code %}<small class="text-muted">({{ item.order_item.product.code }})</small>{% endif %}
                                                            {% endif %}
                                                        </div>
                                                    {% empty %}
                                                        <span class="text-muted">لا توجد عناصر</span>
                                                    {% endfor %}
                                                </div>
                                            </td>
                                            <td>
                                                <div class="text-center">
                                                    <div class="fw-bold">{{ cutting_order.warehouse.name }}</div>
                                                    <small class="text-muted">{{ cutting_order.warehouse.address|default:"" }}</small>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="text-center">
                                                    <div class="fw-bold">{{ cutting_order.items.count }}</div>
                                                    <small class="text-muted">عنصر</small>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="text-center">
                                                    <div class="fw-bold">{{ cutting_order.created_at|date:"Y-m-d" }}</div>
                                                    <small class="text-muted">{{ cutting_order.created_at|date:"H:i" }}</small>
                                                </div>
                                            </td>
                                            <td>
                                                {% if cutting_order.completed_at %}
                                                    <div class="text-center">
                                                        <div class="fw-bold text-success">{{ cutting_order.completed_at|date:"Y-m-d" }}</div>
                                                        <small class="text-muted">{{ cutting_order.completed_at|date:"H:i" }}</small>
                                                    </div>
                                                {% else %}
                                                    <div class="text-center">
                                                        <span class="text-muted">غير مكتمل</span>
                                                    </div>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <div class="text-center">
                                                    {% if cutting_order.status == 'completed' %}
                                                        <span class="badge bg-success">مكتمل</span>
                                                    {% elif cutting_order.status == 'in_progress' %}
                                                        <span class="badge bg-primary">قيد التقطيع</span>
                                                    {% elif cutting_order.status == 'rejected' %}
                                                        <span class="badge bg-danger">مرفوض</span>
                                                    {% else %}
                                                        <span class="badge bg-secondary">قيد الانتظار</span>
                                                    {% endif %}
                                                    {% if cutting_order.status == 'rejected' and cutting_order.rejection_reason %}
                                                        <div class="mt-1">
                                                            <small class="text-danger">{{ cutting_order.rejection_reason|truncatechars:50 }}</small>
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            </td>
                                            <td>
                                                <div class="text-center">
                                                    <a href="{% url 'cutting:order_detail' cutting_order.id %}"
                                                       class="btn btn-sm btn-outline-primary">
                                                        <i class="fas fa-eye"></i>
                                                    </a>
                                                </div>
                                            </td>
                                        </tr>
                                    {% empty %}
                                        <tr>
                                            <td colspan="8" class="text-center text-muted py-4">
                                                <i class="fas fa-info-circle me-2"></i>
                                                لا توجد أوامر تقطيع لهذا الطلب
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            {% endif %}
        {% endwith %}
        <!-- معلومات الاستلام لطلبات المنتجات -->
        {% with types_list=order.get_selected_types_list %}
            {% if 'products' in types_list %}
                {% with product_receipts=order.product_receipts.all %}
                    {% if product_receipts %}
                        <div class="card mb-4">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-check-circle me-2"></i>
                                    معلومات الاستلام من المخزن
                                </h5>
                                <small>تفاصيل استلام المنتجات من المخزن</small>
                            </div>
                            <div class="card-body">
                                {% for receipt in product_receipts %}
                                    <div class="row mb-3 {% if not forloop.last %}border-bottom pb-3{% endif %}">
                                        <div class="col-md-6">
                                            <h6 class="text-success">
                                                <i class="fas fa-warehouse"></i>
                                                رقم الإذن: {{ receipt.permit_number }}
                                            </h6>
                                            <p class="mb-1">
                                                <strong>رقم الشنطة:</strong>
                                                <span class="badge bg-warning text-dark">{{ receipt.bag_number }}</span>
                                            </p>
                                            <p class="mb-1">
                                                <strong>تاريخ الاستلام:</strong>
                                                <span class="text-muted">{{ receipt.receipt_date|date:"d/m/Y H:i" }}</span>
                                            </p>
                                        </div>
                                        <div class="col-md-6">
                                            <p class="mb-1">
                                                <strong>اسم المستلم:</strong>
                                                <span class="text-info">{{ receipt.received_by_name }}</span>
                                            </p>
                                            <p class="mb-1">
                                                <strong>المستخدم المسجل:</strong>
                                                <span class="text-muted">{{ receipt.received_by_user.get_full_name|default:receipt.received_by_user.username }}</span>
                                            </p>
                                            {% if receipt.notes %}
                                                <p class="mb-1">
                                                    <strong>ملاحظات:</strong>
                                                    <span class="text-muted">{{ receipt.notes }}</span>
                                                </p>
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endif %}
                {% endwith %}
            {% endif %}
        {% endwith %}
        {% with types_list=order.get_selected_types_list %}
            {% if 'inspection' in types_list or 'inspection' in order.selected_types %}
                <!-- Inspection Details -->
                <div class="card mb-4 mt-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-eye me-2"></i>
                            بطاقة تتبع المعاينة
                        </h5>
                        <small>معلومات شاملة عن حالة المعاينة المرتبطة بهذا الطلب</small>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover table-striped mb-0">
                                <thead class="table-info">
                                    <tr>
                                        <th width="8%">رقم المعاينة</th>
                                        <th width="12%">تاريخ الطلب</th>
                                        <th width="12%">تاريخ التنفيذ</th>
                                        <th width="8%">عدد الشبابيك</th>
                                        <th width="15%">فني المعاينة</th>
                                        <th width="10%">الحالة</th>
                                        <th width="10%">النتيجة</th>
                                        <th width="8%">ملف المعاينة</th>
                                        <th width="12%">البائع المسؤول</th>
                                        <th width="5%">عرض</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for inspection in inspections %}
                                        <tr class="{% if inspection.status == 'completed' %}table-success{% elif inspection.status == 'scheduled' %}table-info{% elif inspection.status == 'pending' %}table-warning{% endif %}">
                                            <td>
                                                <strong class="text-primary">{{ inspection.inspection_code }}</strong>
                                            </td>
                                            <td>
                                                <div class="text-center">
                                                    <div class="fw-bold">{{ inspection.request_date|date:"Y-m-d" }}</div>
                                                    <small class="text-muted">تاريخ الطلب</small>
                                                </div>
                                            </td>
                                            <td>
                                                {% if inspection.scheduled_date %}
                                                    <div class="text-center">
                                                        <div class="fw-bold">{{ inspection.scheduled_date|date:"Y-m-d" }}</div>
                                                        <small class="text-muted">مجدولة</small>
                                                    </div>
                                                {% else %}
                                                    <div class="text-center">
                                                        <span class="text-muted">غير محدد</span>
                                                        <br>
                                                        <small class="text-muted">لم تُجدول بعد</small>
                                                    </div>
                                                {% endif %}
                                            </td>
                                            <td class="text-center">
                                                {% if inspection.windows_count %}
                                                    <span class="badge bg-secondary">{{ inspection.windows_count }}</span>
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if inspection.inspector %}
                                                    <div class="d-flex align-items-center">
                                                        <i class="fas fa-user-hard-hat me-2 text-primary"></i>
                                                        <div>
                                                            <div class="fw-bold">
                                                                {% if inspection.inspector.get_full_name %}
                                                                    {{ inspection.inspector.get_full_name }}
                                                                {% else %}
                                                                    {{ inspection.inspector.username }}
                                                                {% endif %}
                                                            </div>
                                                            <small class="text-muted">فني معاينة</small>
                                                        </div>
                                                    </div>
                                                {% else %}
                                                    <span class="text-muted">
                                                        <i class="fas fa-user-slash me-1"></i>
                                                        غير محدد
                                                    </span>
                                                {% endif %}
                                            </td>
                                            <td class="text-center">
                                                {% get_status_badge inspection.status "inspection" %}
                                                {% if inspection.status == 'completed' and inspection.updated_at %}
                                                    <br>
                                                    <small class="text-muted mt-1">{{ inspection.updated_at|date:"Y-m-d H:i" }}</small>
                                                {% endif %}
                                            </td>
                                            <td class="text-center">
                                                {% if inspection.result %}
                                                    <span class="badge {% if inspection.result == 'passed' %}bg-success {% else %}bg-danger{% endif %} px-3 py-2">
                                                        {% if inspection.result == 'passed' %}
                                                            <i class="fas fa-thumbs-up me-1"></i> نجحت
                                                        {% else %}
                                                            <i class="fas fa-thumbs-down me-1"></i> فشلت
                                                        {% endif %}
                                                    </span>
                                                {% else %}
                                                    <span class="text-muted">
                                                        <i class="fas fa-hourglass-half me-1"></i>
                                                        في الانتظار
                                                    </span>
                                                {% endif %}
                                            </td>
                                            <td class="text-center">
                                                {% if inspection.files.exists %}
                                                    <div class="d-flex flex-column gap-1">
                                                        {% for file in inspection.files.all %}
                                                            <div class="d-flex justify-content-center gap-1">
                                                                <!-- الملف المحلي -->
                                                                {% if file.file %}
                                                                    <a href="{{ file.file.url }}"
                                                                       target="_blank"
                                                                       class="btn btn-sm btn-outline-primary"
                                                                       title="ملف {{ forloop.counter }}">
                                                                        <i class="fas fa-file-pdf"></i>
                                                                    </a>
                                                                {% endif %}
                                                                <!-- رابط Google Drive -->
                                                                {% if file.is_uploaded_to_drive and file.google_drive_file_url %}
                                                                    <a href="{{ file.google_drive_file_url }}"
                                                                       target="_blank"
                                                                       class="btn btn-sm btn-success"
                                                                       title="Drive {{ forloop.counter }}">
                                                                        <i class="fas fa-cloud"></i>
                                                                    </a>
                                                                {% elif file.file %}
                                                                    <span class="badge bg-warning text-dark" title="جاري الرفع">
                                                                        <i class="fas fa-clock"></i>
                                                                    </span>
                                                                {% endif %}
                                                            </div>
                                                        {% endfor %}
                                                    </div>
                                                {% else %}
                                                    <span class="text-muted">
                                                        <i class="fas fa-file-slash me-1"></i>
                                                        لا يوجد ملف
                                                    </span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if inspection.responsible_employee %}
                                                    <div class="d-flex align-items-center">
                                                        <i class="fas fa-user-tie me-2 text-success"></i>
                                                        <div>
                                                            <div class="fw-bold">{{ inspection.responsible_employee }}</div>
                                                            <small class="text-muted">بائع مسؤول</small>
                                                        </div>
                                                    </div>
                                                {% else %}
                                                    <span class="text-muted">
                                                        <i class="fas fa-user-slash me-1"></i>
                                                        غير محدد
                                                    </span>
                                                {% endif %}
                                            </td>
                                            <td class="text-center">
                                                <a href="{% url 'inspections:inspection_detail' inspection.pk %}"
                                                   class="btn btn-sm btn-outline-info"
                                                   title="عرض تفاصيل المعاينة">
                                                    <i class="fas fa-eye me-1"></i>
                                                    عرض
                                                </a>
                                            </td>
                                        </tr>
                                    {% empty %}
                                        <tr>
                                            <td colspan="10" class="text-center py-3">لم يتم إنشاء معاينة لهذا الطلب بعد</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            {% endif %}
        {% endwith %}
        <!-- Payments -->
        <div class="card">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h5 class="mb-0">الدفعات</h5>
                <a href="{% url 'orders:payment_create' order.pk %}"
                   class="btn btn-sm btn-primary">
                    <i class="fas fa-plus"></i> تسجيل دفعة
                </a>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover table-striped mb-0">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>المبلغ</th>
                                <th>طريقة الدفع</th>
                                <th>تاريخ الدفع</th>
                                <th>رقم المرجع</th>
                                <th>ملاحظات</th>
                                <th>تم الإنشاء بواسطة</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for payment in payments %}
                                <tr>
                                    <td>{{ forloop.counter }}</td>
                                    <td>{{ payment.amount|clean_decimal_currency:currency_symbol }}</td>
                                    <td>{{ payment.get_payment_method_display }}</td>
                                    <td>{{ payment.payment_date|date:"Y-m-d H:i" }}</td>
                                    <td>{{ payment.reference_number|default:"-" }}</td>
                                    <td>{{ payment.notes|default:"-" }}</td>
                                    <td>
                                        {% if payment.created_by %}
                                            {{ payment.created_by.get_full_name|default:payment.created_by.username }}
                                        {% else %}
                                            غير محدد
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="{% url 'orders:payment_delete' payment.pk %}"
                                           class="btn btn-sm btn-danger">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                    </td>
                                </tr>
                            {% empty %}
                                <tr>
                                    <td colspan="8" class="text-center py-3">لا توجد دفعات مسجلة لهذا الطلب</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr class="table-light">
                                <th colspan="7" class="text-start">المجموع المدفوع</th>
                                <th>{{ order.paid_amount|clean_decimal_currency:currency_symbol }}</th>
                            </tr>
                            <tr class="table-light">
                                {% if order.is_customer_credit %}
                                    <th colspan="7" class="text-start">متبقي للعميل</th>
                                    <th class="text-success">-{{ order.remaining_amount_display|clean_decimal_currency:currency_symbol }}</th>
                                {% elif order.remaining_amount > 0 %}
                                    <th colspan="7" class="text-start">المبلغ المتبقي</th>
                                    <th class="text-danger">{{ order.remaining_amount|clean_decimal_currency:currency_symbol }}</th>
                                {% else %}
                                    <th colspan="7" class="text-start">المبلغ المتبقي</th>
                                    <th class="text-success">{{ order.remaining_amount|clean_decimal_currency:currency_symbol }}</th>
                                {% endif %}
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal for Invoice Images -->
    {% if order.invoice_image or order.invoice_images.exists %}
        <div class="modal fade"
             id="invoiceImageModal"
             tabindex="-1"
             aria-labelledby="invoiceImageModalLabel"
             aria-hidden="true">
            <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header bg-success text-white">
                        <h5 class="modal-title" id="invoiceImageModalLabel">
                            <i class="fas fa-images me-2"></i>صور الفاتورة - طلب رقم {{ order.order_number }}
                        </h5>
                        <button type="button"
                                class="btn-close btn-close-white"
                                data-bs-dismiss="modal"
                                aria-label="Close"></button>
                    </div>
                    <div class="modal-body p-4">
                        <div class="row g-4">
                            {% if order.invoice_image %}
                                <div class="col-12">
                                    <div class="card shadow-sm">
                                        <div class="card-header bg-primary text-white">
                                            <i class="fas fa-image me-2"></i>الصورة الرئيسية
                                        </div>
                                        <div class="card-body text-center p-2">
                                            <img src="{{ order.invoice_image.url }}"
                                                 alt="صورة الفاتورة الرئيسية"
                                                 class="img-fluid rounded"
                                                 style="max-height: 500px;
                                                        width: auto;
                                                        cursor: pointer"
                                                 onclick="window.open('{% url 'orders:download_invoice' order.id %}', '_blank')">
                                        </div>
                                        <div class="card-footer text-center">
                                            <a href="{% url 'orders:download_invoice' order.id %}"
                                               target="_blank"
                                               class="btn btn-sm btn-primary">
                                                <i class="fas fa-external-link-alt me-1"></i>فتح
                                            </a>
                                            <a href="{% url 'orders:download_invoice' order.id %}"
                                               download
                                               class="btn btn-sm btn-success">
                                                <i class="fas fa-download me-1"></i>تحميل
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                            {% for img in order.invoice_images.all %}
                                <div class="col-md-6">
                                    <div class="card shadow-sm">
                                        <div class="card-header bg-info text-white">
                                            <i class="fas fa-image me-2"></i>صورة {{ forloop.counter }}
                                        </div>
                                        <div class="card-body text-center p-2">
                                            <a href="{% url 'orders:download_invoice_image' img.id %}"
                                               target="_blank">
                                                <img src="{% url 'orders:download_invoice_image' img.id %}"
                                                     alt="صورة الفاتورة {{ forloop.counter }}"
                                                     class="img-fluid rounded"
                                                     style="max-height: 400px;
                                                            width: auto;
                                                            cursor: pointer">
                                            </a>
                                        </div>
                                        <div class="card-footer text-center">
                                            <a href="{% url 'orders:download_invoice_image' img.id %}"
                                               target="_blank"
                                               class="btn btn-sm btn-primary">
                                                <i class="fas fa-external-link-alt me-1"></i>فتح
                                            </a>
                                            <a href="{% url 'orders:download_invoice_image' img.id %}"
                                               download
                                               class="btn btn-sm btn-success">
                                                <i class="fas fa-download me-1"></i>تحميل
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-1"></i>إغلاق
                        </button>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
    <!-- Modal for Reply to Rejection -->
    <div class="modal fade"
         id="replyToRejectionModal"
         tabindex="-1"
         aria-labelledby="replyToRejectionModalLabel"
         aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="replyToRejectionModalLabel">
                        <i class="fas fa-reply me-2"></i>الرد على رفض الطلب
                    </h5>
                    <button type="button"
                            class="btn-close"
                            data-bs-dismiss="modal"
                            aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        يمكنك الرد على سبب الرفض وتقديم التوضيحات المطلوبة. سيتم إرسال ردك للإدارة للمراجعة.
                    </div>
                    <!-- عرض سبب الرفض الحالي -->
                    <div id="currentRejectionReason"></div>
                    <form id="replyToRejectionForm">
                        <input type="hidden" id="rejectionLogId" name="rejection_log_id">
                        <div class="mb-3">
                            <label for="reply_to_rejection_message" class="form-label">
                                <i class="fas fa-comment me-1"></i>ردك على الرفض:
                            </label>
                            <textarea class="form-control"
                                      id="reply_to_rejection_message"
                                      name="reply_to_rejection_message"
                                      rows="4"
                                      placeholder="اكتب ردك على سبب الرفض هنا..."
                                      required></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>إلغاء
                    </button>
                    <button type="button" class="btn btn-primary" id="submitReplyToRejectionBtn">
                        <i class="fas fa-paper-plane me-1"></i>إرسال الرد
                    </button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
{% block extra_css %}
    <style>
/* Modal fixes to prevent black screen */
.modal-backdrop {
    display: none !important;
    opacity: 0 !important;
}

body.modal-open {
    overflow: auto !important;
    padding-right: 0 !important;
}

body:not(.modal-open) .modal-backdrop {
    display: none !important;
}

.swal2-container {
    z-index: 10000 !important;
}

.swal2-shown {
    overflow: auto !important;
    padding-right: 0 !important;
}

/* Timeline styling */
.timeline {
    position: relative;
    padding: 20px 0;
}

.timeline-item {
    position: relative;
    padding-left: 40px;
    margin-bottom: 20px;
}

.timeline-marker {
    position: absolute;
    left: 0;
    top: 0;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background-color: #007bff;
    border: 2px solid #fff;
    box-shadow: 0 0 0 2px #007bff;
}

.timeline-item:not(:last-child):before {
    content: '';
    position: absolute;
    left: 5px;
    top: 12px;
    height: calc(100% + 8px);
    width: 2px;
    background-color: #e9ecef;
}

.timeline-content {
    padding: 15px;
    background-color: #f8f9fa;
    border-radius: 4px;
}
    </style>
{% endblock %}
{% block extra_js %}
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
// عرض مودال الرد على الرفض
function showReplyToRejectionModal(rejectionLogId, rejectionReason) {
    $('#rejectionLogId').val(rejectionLogId);
    $('#reply_to_rejection_message').val('');
    // عرض سبب الرفض في المودال (اختياري)
    if (rejectionReason) {
        $('#currentRejectionReason').html(`<div class="alert alert-warning"><strong>سبب الرفض:</strong><br>${rejectionReason}</div>`);
    } else {
        $('#currentRejectionReason').html('');
    }
    $('#replyToRejectionModal').modal('show');
}

$(document).ready(function() {
    // إضافة دالة تنظيف المودال
    function forceCleanModal() {
        // إزالة جميع آثار المودال
        $('.modal-backdrop').remove();
        $('.modal-backdrop.show').remove();
        $('.modal-backdrop.fade').remove();
        $('body').removeClass('modal-open');
        $('html').removeClass('modal-open');
        $('body').css({
            'overflow': 'auto',
            'padding-right': '0',
            'margin-right': '0'
        });
    }
    
    // معالجة إرسال الرد على الرفض
    $('#submitReplyToRejectionBtn').on('click', function() {
        const rejectionLogId = $('#rejectionLogId').val();
        const replyMessage = $('#reply_to_rejection_message').val().trim();
        
        if (!rejectionLogId) {
            Swal.fire('خطأ', 'خطأ في تحديد سجل الرفض.', 'error');
            return;
        }
        
        if (!replyMessage) {
            Swal.fire('خطأ', 'يرجى كتابة رد قبل الإرسال.', 'error');
            return;
        }
        
        // إخفاء المودال فوراً قبل إرسال الطلب
        $('#replyToRejectionModal').modal('hide');
        // تنظيف قوي للمودال وإزالة backdrop
        setTimeout(() => {
            forceCleanModal();
        }, 100);
        
        // إظهار loading
        Swal.fire({
            title: 'جاري إرسال الرد...',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });
        
        const csrfToken = $('input[name=csrfmiddlewaretoken]').val() || $('meta[name=csrf-token]').attr('content');
        
        $.ajax({
            url: `/manufacturing/send_reply_to_rejection_log/${rejectionLogId}/`,
            method: 'POST',
            data: JSON.stringify({
                'reply_message': replyMessage
            }),
            contentType: 'application/json',
            headers: {
                'X-CSRFToken': csrfToken
            },
            success: function(response) {
                if (response.success) {
                    Swal.fire({
                        title: 'تم بنجاح!',
                        text: 'تم إرسال ردك للإدارة بنجاح',
                        icon: 'success',
                        timer: 2000,
                        showConfirmButton: false
                    });
                    $('#reply_to_rejection_message').val('');
                    $('#currentRejectionReason').html('');
                    // إعادة تحميل الصفحة لإظهار الرد
                    setTimeout(() => location.reload(), 2000);
                } else {
                    Swal.fire('خطأ!', response.error || 'حدث خطأ أثناء إرسال الرد', 'error');
                }
            },
            error: function(xhr) {
                let errorMessage = 'حدث خطأ غير متوقع';
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMessage = xhr.responseJSON.error;
                }
                Swal.fire('خطأ!', errorMessage, 'error');
            }
        });
    });
    
    // تنظيف مودال الرد على الرفض عند إغلاقه
    $('#replyToRejectionModal').on('hidden.bs.modal', function () {
        forceCleanModal();
        $('#reply_to_rejection_message').val('');
    });
    
    // معالجة النقر على زر X أو خارج مودال الرد على الرفض
    $('#replyToRejectionModal .btn-close, #replyToRejectionModal [data-bs-dismiss="modal"]').on('click', function() {
        forceCleanModal();
    });
    
    // معالجة النقر على الخلفية (backdrop) لمودال الرد على الرفض
    $('#replyToRejectionModal').on('click', function(e) {
        if (e.target === this) {
            forceCleanModal();
        }
    });
});

// دالة طباعة الفاتورة المباشرة
function printInvoice(orderNumber) {
    // إظهار رسالة تحميل
    Swal.fire({
        title: 'جاري التحضير للطباعة...',
        text: 'يرجى الانتظار',
        icon: 'info',
        allowOutsideClick: false,
        showConfirmButton: false,
        didOpen: () => {
            Swal.showLoading();
        }
    });
    
    // إنشاء iframe مخفي للطباعة المباشرة
    const iframe = document.createElement('iframe');
    iframe.style.display = 'none';
    iframe.style.width = '100%';
    iframe.style.height = '100%';
    document.body.appendChild(iframe);
    
    // معالج تحميل الإطار
    iframe.onload = function() {
        setTimeout(() => {
            Swal.close();
            // محاولة الطباعة
            try {
                iframe.contentWindow.print();
            } catch (e) {
                console.log('طباعة تلقائية:', e);
                // فتح في نافذة جديدة كبديل
                window.open(`/orders/order/${orderNumber}/invoice/`, '_blank');
            }
        }, 1000);
    };
    
    // معالج الخطأ
    iframe.onerror = function() {
        Swal.close();
        Swal.fire({
            title: 'خطأ!',
            text: 'حدث خطأ في تحميل الفاتورة',
            icon: 'error'
        });
    };
    
    // تحميل محتوى الفاتورة
    iframe.src = `/orders/order/${orderNumber}/invoice/`;
    
    // إزالة الـ iframe بعد الطباعة
    setTimeout(() => {
        if (document.body.contains(iframe)) {
            document.body.removeChild(iframe);
        }
    }, 10000);
}

// وظائف أمر التقطيع
function startCutting(orderId) {
    Swal.fire({
        title: 'بدء التقطيع',
        text: 'هل تريد بدء عملية التقطيع لهذا الأمر؟',
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#28a745',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'نعم، ابدأ',
        cancelButtonText: 'إلغاء'
    }).then((result) => {
        if (result.isConfirmed) {
            fetch(`/cutting/orders/${orderId}/start/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire('تم!', 'تم بدء عملية التقطيع بنجاح', 'success')
                        .then(() => location.reload());
                } else {
                    Swal.fire('خطأ!', data.message, 'error');
                }
            })
            .catch(error => {
                Swal.fire('خطأ!', 'حدث خطأ في الاتصال', 'error');
            });
        }
    });
}

function createCuttingOrder(orderId) {
    Swal.fire({
        title: 'إنشاء أمر تقطيع',
        text: 'هل تريد إنشاء أمر تقطيع لهذا الطلب؟',
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#007bff',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'نعم، أنشئ',
        cancelButtonText: 'إلغاء'
    }).then((result) => {
        if (result.isConfirmed) {
            fetch(`/cutting/orders/create-from-order/${orderId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire('تم!', 'تم إنشاء أمر التقطيع بنجاح', 'success')
                        .then(() => location.reload());
                } else {
                    Swal.fire('خطأ!', data.message, 'error');
                }
            })
            .catch(error => {
                Swal.fire('خطأ!', 'حدث خطأ في الاتصال', 'error');
            });
        }
    });
}

// إعادة توليد العقد
function regenerateContract(orderId) {
    Swal.fire({
        title: 'تأكيد إعادة التوليد',
        text: 'هل تريد إعادة توليد ملف العقد؟ سيتم استبدال الملف الحالي.',
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#ffc107',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'نعم، أعد التوليد',
        cancelButtonText: 'إلغاء'
    }).then((result) => {
        if (result.isConfirmed) {
            // عرض مؤشر التحميل
            Swal.fire({
                title: 'جاري التوليد...',
                html: 'يرجى الانتظار حتى يتم توليد ملف العقد',
                allowOutsideClick: false,
                allowEscapeKey: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            // زيادة timeout للطلبات الكبيرة
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 120000); // 2 دقيقة
            
            fetch(`/orders/order/${orderId}/contract/regenerate/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
                signal: controller.signal
            })
            .then(response => {
                clearTimeout(timeoutId);
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        title: 'تم!',
                        text: 'تم إعادة توليد ملف العقد بنجاح',
                        icon: 'success',
                        showCancelButton: true,
                        confirmButtonText: 'فتح العقد',
                        cancelButtonText: 'إغلاق'
                    }).then((result) => {
                        if (result.isConfirmed && data.contract_url) {
                            // استخدام الرابط مع timestamp من السيرفر
                            window.open(data.contract_url, '_blank');
                        }
                        // إعادة تحميل الصفحة لتحديث البيانات
                        location.reload();
                    });
                } else {
                    Swal.fire('خطأ!', data.message, 'error');
                }
            })
            .catch(error => {
                clearTimeout(timeoutId);
                let errorMsg = 'حدث خطأ في الاتصال بالخادم';
                if (error.name === 'AbortError') {
                    errorMsg = 'انتهت مهلة الطلب. قد يكون العقد كبيراً جداً. يرجى المحاولة مرة أخرى.';
                }
                Swal.fire({
                    title: 'خطأ!',
                    text: errorMsg,
                    icon: 'error',
                    confirmButtonText: 'حسناً'
                }).then(() => {
                    // إعادة تحميل الصفحة للتحقق من حالة العقد
                    location.reload();
                });
            });
        }
    });
}

// تطبيق الخصم الإداري
function applyAdministrativeDiscount(orderId) {
    const amount = document.getElementById('admin_discount_amount').value;
    const notes = document.getElementById('admin_discount_notes').value;
    
    // التحقق من صحة القيمة
    if (!amount || parseFloat(amount) <= 0) {
        Swal.fire({
            title: 'خطأ!',
            text: 'يرجى إدخال قيمة صحيحة للخصم (أكبر من صفر)',
            icon: 'error',
            confirmButtonText: 'حسناً'
        });
        return;
    }
    
    Swal.fire({
        title: '⚠️ تأكيد التطبيق',
        html: `
            <p>هل تريد تطبيق خصم إداري بقيمة <strong class="text-danger">${amount} {{ currency_symbol }}</strong>؟</p>
            <div class="alert alert-warning mt-3">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>تنبيه:</strong> لا يمكن التراجع عن هذا الإجراء بعد التطبيق
            </div>
        `,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#ffc107',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'نعم، طبّق الخصم',
        cancelButtonText: 'إلغاء'
    }).then((result) => {
        if (result.isConfirmed) {
            // رسالة جاري التحميل
            Swal.fire({
                title: 'جاري التطبيق...',
                text: 'يرجى الانتظار',
                allowOutsideClick: false,
                allowEscapeKey: false,
                showConfirmButton: false,
                willOpen: () => {
                    Swal.showLoading();
                }
            });
            
            fetch(`/orders/order/${orderId}/apply-administrative-discount/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    discount_amount: parseFloat(amount),
                    notes: notes
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        title: 'تم بنجاح!',
                        html: `
                            <div class="text-start">
                                <p><strong><i class="fas fa-check-circle text-success me-2"></i>تم تطبيق الخصم الإداري</strong></p>
                                <hr>
                                <p><strong>قيمة الخصم:</strong> ${data.discount.amount} {{ currency_symbol }}</p>
                                <p><strong>السعر النهائي الجديد:</strong> ${data.totals.final_price} {{ currency_symbol }}</p>
                                <p><strong>المبلغ المتبقي:</strong> ${data.totals.remaining_amount} {{ currency_symbol }}</p>
                            </div>
                        `,
                        icon: 'success',
                        confirmButtonText: 'حسناً'
                    }).then(() => {
                        location.reload();
                    });
                } else {
                    Swal.fire({
                        title: 'خطأ!',
                        text: data.message || 'حدث خطأ أثناء تطبيق الخصم',
                        icon: 'error',
                        confirmButtonText: 'حسناً'
                    });
                }
            })
            .catch(error => {
                Swal.fire({
                    title: 'خطأ!',
                    text: 'حدث خطأ في الاتصال بالخادم',
                    icon: 'error',
                    confirmButtonText: 'حسناً'
                });
            });
        }
    });
}
    </script>
{% endblock %}
