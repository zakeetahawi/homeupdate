{% extends 'base.html' %}
{% load static %}

{% block title %}{{ page_title }}{% endblock %}

{% block extra_css %}
<style>
  body { direction: rtl; }
  .studio { display: grid; grid-template-columns: 1fr 320px; gap: 16px; }
  .panel { background:#fff; border:1px solid #e9ecef; border-radius:8px; }
  .panel .panel-header { padding:12px 16px; border-bottom:1px solid #e9ecef; font-weight:600; }
  .panel .panel-body { padding: 16px; }
  .preview { background:#f8f9fa; padding:16px; }
  .a4 { width:210mm; min-height:297mm; background:#fff; margin:0 auto; box-shadow:0 0 12px rgba(0,0,0,.08); padding:20mm; }
  @media print { .panel, .actions { display:none !important; } .a4 { box-shadow:none; margin:0; padding:10mm; } @page { size:A4; margin:10mm; } }
  .form-label { font-size: 13px; color:#495057; }
  .small { font-size: 12px; color:#6c757d; }
</style>
{% endblock %}

{% block content %}
<div class="container py-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="m-0">{{ page_title }}</h3>
    <div class="actions d-flex gap-2 align-items-center">
      <select id="template_style" class="form-select form-select-sm" style="width: 220px;">
        <option value="classic">القالب الكلاسيكي</option>
        <option value="modern">القالب الحديث</option>
        <option value="pro">القالب الاحترافي</option>
        <option value="custom">قالب محفوظ</option>
      </select>
      <button id="set-default" class="btn btn-outline-primary btn-sm" {% if not template_id %}disabled{% endif %}>تعيين كافتراضي</button>
      <button id="save-template" class="btn btn-success">حفظ القالب</button>
      <a class="btn btn-secondary" href="{% url 'orders:template_list' %}">رجوع</a>
    </div>
  </div>

  <div class="studio">
    <div class="panel preview">
      <div class="panel-body">
        <div id="preview" class="a4"></div>
      </div>
    </div>

    <div class="panel">
      <div class="panel-header">الإعدادات</div>
      <div class="panel-body">
        <div class="mb-2">
          <label class="form-label">عنوان الفاتورة</label>
          <input type="text" id="invoice_title" class="form-control" value="فاتورة">
        </div>
        <div class="mb-2">
          <label class="form-label">تسمية رقم الفاتورة</label>
          <input type="text" id="label_invoice_number" class="form-control" value="رقم الفاتورة">
        </div>
        <div class="mb-2">
          <label class="form-label">تسمية التاريخ</label>
          <input type="text" id="label_date" class="form-control" value="التاريخ">
        </div>
        <div class="row g-2 mb-2">
          <div class="col-6">
            <label class="form-label">اللون الأساسي</label>
            <input type="color" id="primary_color" class="form-control form-control-color" value="#0d6efd">
          </div>
          <div class="col-6">
            <label class="form-label">لون إبراز</label>
            <input type="color" id="accent_color" class="form-control form-control-color" value="#ffc107">
          </div>
        </div>
        <div class="mb-2">
          <label class="form-label">الخط</label>
          <select id="font_family" class="form-select">
            <option value="Cairo, Arial, sans-serif">Cairo</option>
            <option value="Tajawal, Arial, sans-serif">Tajawal</option>
            <option value="Arial, sans-serif">Arial</option>
          </select>
        </div>
        <hr>
        <div class="mb-2">
          <label class="form-label">عنوان قسم العميل</label>
          <input type="text" id="label_customer_section" class="form-control" value="بيانات العميل">
        </div>
        <div class="mb-2">
          <label class="form-label">عنوان قسم الشركة</label>
          <input type="text" id="label_company_section" class="form-control" value="بيانات الشركة">
        </div>
        <hr>
        <div class="mb-2">
          <label class="form-label">اسم الشركة</label>
          <input type="text" id="company_name" class="form-control" value="{{ company_info.name|default_if_none:'اسم الشركة' }}">
        </div>
        <div class="mb-2">
          <label class="form-label">الهاتف</label>
          <input type="text" id="company_phone" class="form-control" value="{{ company_info.phone|default_if_none:'' }}">
        </div>
        <div class="mb-2">
          <label class="form-label">العنوان</label>
          <input type="text" id="company_address" class="form-control" value="{{ company_info.address|default_if_none:'العنوان' }}">
        </div>
        <hr>
        <div class="row g-2 mb-2">
          <div class="col-6">
            <label class="form-label">عنوان عمود الوصف</label>
            <input type="text" id="th_desc" class="form-control" value="الوصف">
          </div>
          <div class="col-6">
            <label class="form-label">عنوان عمود الكمية</label>
            <input type="text" id="th_qty" class="form-control" value="الكمية">
          </div>
        </div>
        <div class="row g-2 mb-2">
          <div class="col-6">
            <label class="form-label">عنوان عمود السعر</label>
            <input type="text" id="th_price" class="form-control" value="السعر">
          </div>
          <div class="col-6">
            <label class="form-label">عنوان عمود المجموع</label>
            <input type="text" id="th_total" class="form-control" value="المجموع">
          </div>
        </div>
        <div class="form-check mb-2">
          <input class="form-check-input" type="checkbox" id="show_customer" checked>
          <label class="form-check-label" for="show_customer">إظهار قسم العميل</label>
        </div>
        <div class="form-check mb-2">
          <input class="form-check-input" type="checkbox" id="show_company" checked>
          <label class="form-check-label" for="show_company">إظهار قسم الشركة</label>
        </div>
        <div class="form-check mb-2">
          <input class="form-check-input" type="checkbox" id="show_table" checked>
          <label class="form-check-label" for="show_table">إظهار جدول العناصر</label>
        </div>
        <div class="mb-2">
          <label class="form-label">ملاحظات أسفل الفاتورة</label>
          <textarea id="notes_text" class="form-control" rows="3" placeholder="أي ملاحظات إضافية"></textarea>
          <div class="small mt-1">سوف تظهر أسفل الصفحة.</div>
        </div>
        <div class="mb-2">
          <label class="form-label">الشروط والأحكام</label>
          <textarea id="terms_text" class="form-control" rows="3" placeholder="الشروط والأحكام"></textarea>
        </div>
        <div class="form-check mb-2">
          <input class="form-check-input" type="checkbox" id="show_bg_logo">
          <label class="form-check-label" for="show_bg_logo">إظهار شعار الشركة كخلفية خفيفة</label>
        </div>
      </div>
    </div>
  </div>
</div>

{{ saved_meta_content|json_script:"saved-meta" }}
{{ saved_html_content|json_script:"saved-html" }}

<script>
  const TEMPLATE_ID = {% if template_id %}{{ template_id }}{% else %}null{% endif %};
  const SAVED_HTML = JSON.parse(document.getElementById('saved-html').textContent || '""');
  const META = JSON.parse(document.getElementById('saved-meta').textContent || '{}');
  const COMPANY_LOGO_URL = "{{ company_info.logo.url|default_if_none:''|escapejs }}";

  function buildHtml() {
    const title = document.getElementById('invoice_title').value || 'فاتورة';
    const labelInvoice = document.getElementById('label_invoice_number').value || 'رقم الفاتورة';
    const labelDate = document.getElementById('label_date').value || 'التاريخ';
    const primary = document.getElementById('primary_color').value || '#0d6efd';
    const accent = document.getElementById('accent_color').value || '#ffc107';
    const font = document.getElementById('font_family').value;
    const cname = document.getElementById('company_name').value || 'اسم الشركة';
    const cphone = document.getElementById('company_phone').value || '';
    const caddr = document.getElementById('company_address').value || '';
    const notes = document.getElementById('notes_text').value || '';
    const terms = document.getElementById('terms_text').value || '';
    const bg = document.getElementById('show_bg_logo').checked;
    const showCustomer = document.getElementById('show_customer').checked;
    const showCompany = document.getElementById('show_company').checked;
    const showTable = document.getElementById('show_table').checked;
    const labelCustomerSec = document.getElementById('label_customer_section').value || 'بيانات العميل';
    const labelCompanySec = document.getElementById('label_company_section').value || 'بيانات الشركة';
    const thDesc = document.getElementById('th_desc').value || 'الوصف';
    const thQty = document.getElementById('th_qty').value || 'الكمية';
    const thPrice = document.getElementById('th_price').value || 'السعر';
    const thTotal = document.getElementById('th_total').value || 'المجموع';

    const styleSel = document.getElementById('template_style');
    const style = styleSel ? styleSel.value : 'classic';

    const classic = `
    <style>
      :root { --primary-color:${primary}; --accent-color:${accent}; }
      body { font-family:${font}; }
      .items-table{ width:100%; border-collapse: collapse; table-layout: fixed; }
      .items-table th, .items-table td{ padding:10px; border:1px solid #ddd; }
      .items-table th{ background: var(--primary-color); color:#fff; }
      .items-table td:first-child{ text-align:right; word-break: break-word; }
      .items-table td:nth-child(2), .items-table td:nth-child(3), .items-table td:nth-child(4){ text-align:center; }
      .bg-logo{ position:fixed; inset:0; display:${bg?'block':'none'}; opacity:.08; z-index:-1; pointer-events:none; }
      .bg-logo img{ max-width:60%; position:absolute; top:40%; left:50%; transform:translate(-50%,-50%); }
      .content{ position:relative; z-index:1; }
      .totals{ background:#f8f9fa; padding:12px; border-radius:8px; margin-top:16px; }
      .totals .row{ display:flex; justify-content:space-between; margin-bottom:6px; }
      @media print { .bg-logo{ display:${bg?'block':'none'} !important; } }
    </style>
    <div class="bg-logo">
      ${bg && COMPANY_LOGO_URL ? "<img src='" + COMPANY_LOGO_URL + "'/>" : ''}
    </div>
    <div class="content">
      <div style="text-align:center; border-bottom: 2px solid var(--primary-color); padding-bottom:10px; margin-bottom:18px;">
        <h1 style="color:var(--primary-color); margin:0;">${title}</h1>
        <div>${labelInvoice}: ${'${order.invoice_number}'} — ${labelDate}: ${'${order.order_date}'}</div>
      </div>
      <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:16px; margin-bottom:16px;">
        ${showCustomer ? `
        <div style=\"background:#f8f9fa; padding:12px; border-right:4px solid var(--accent-color);\">
          <div style=\"font-weight:600; margin-bottom:8px;\">${labelCustomerSec}</div>
          <div>الاسم: ${'${customer.name}'} </div>
          <div>الهاتف: ${'${customer.phone}'} </div>
          <div>العنوان: ${'${customer.address}'} </div>
        </div>` : ''}
        <div style="background:#fff3cd; padding:12px; border-right:4px solid var(--accent-color);">
          <div style="font-weight:600; margin-bottom:8px;">بيانات الطلب</div>
          <div>الفرع: ${'${branch.name}'} </div>
          <div>اسم البائع: ${'${salesperson.name}'} </div>
          <div>رقم الطلب: ${'${order.order_number}'} </div>
          <div>نوع الطلب: ${'${order.type}'} </div>
          <div>تسليم متوقع: ${'${order.expected_delivery_date}'} </div>
        </div>
        ${showCompany ? `
        <div style=\"background:#f8f9fa; padding:12px; border-right:4px solid var(--accent-color);\">
          <div style=\"font-weight:600; margin-bottom:8px;\">${labelCompanySec}</div>
          <div>${cname}</div>
          <div>${cphone}</div>
          <div>${caddr}</div>
        </div>` : ''}
      </div>
      ${showTable ? `
      <table class=\"items-table\">
        <thead>
          <tr><th>${thDesc}</th><th>${thQty}</th><th>${thPrice}</th><th>${thTotal}</th></tr>
        </thead>
        <tbody>${'${order.items_table}'} </tbody>
      </table>` : ''}
      <div class="totals">
        <div class="row"><span>المبلغ الإجمالي:</span><span><strong>${'${order.total_amount}'} ${'${systemSettings.currency_symbol}'}</strong></span></div>
        <div class="row"><span>المبلغ المدفوع:</span><span style="color:#198754;">${'${order.paid_amount}'} ${'${systemSettings.currency_symbol}'}</span></div>
        <div class="row"><span>المبلغ المتبقي:</span><span style="color:#dc3545;">${'${order.remaining_amount}'} ${'${systemSettings.currency_symbol}'}</span></div>
      </div>
      ${notes ? `<div style=\"margin-top:14px; color:#6c757d;\">${notes}</div>` : ''}
      ${terms ? `<div style=\"margin-top:8px; color:#6c757d;\">${terms}</div>` : ''}
    </div>`;

    const modern = `
    <style>
      :root { --primary-color:${primary}; --accent-color:${accent}; }
      body { font-family:${font}; }
      .hero{ background:linear-gradient(135deg, var(--primary-color), var(--accent-color)); color:#fff; padding:18px; border-radius:12px; text-align:center; }
      .card{ background:#fff; border:1px solid #eee; border-radius:10px; padding:12px; }
      .grid{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
      .items-table{ width:100%; border-collapse: collapse; margin-top:10px; }
      .items-table th{ background:#f1f3f5; }
      .items-table th,.items-table td{ padding:10px; border-bottom:1px solid #eee; }
      .items-table td:first-child{ text-align:right; word-break:break-word; }
      .items-table td:nth-child(2), .items-table td:nth-child(3), .items-table td:nth-child(4){ text-align:center; }
      .bg-logo{ position:fixed; inset:0; display:${bg?'block':'none'}; opacity:.08; z-index:-1; pointer-events:none; }
      .bg-logo img{ max-width:60%; position:absolute; top:40%; left:50%; transform:translate(-50%,-50%); }
      .totals{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-top:12px; }
      .totals .t{ background:#f8f9fa; border:1px solid #eee; border-radius:10px; padding:12px; text-align:center; }
      @media print { .bg-logo{ display:${bg?'block':'none'} !important; } }
    </style>
    <div class="bg-logo">
      ${bg && COMPANY_LOGO_URL ? "<img src='" + COMPANY_LOGO_URL + "'/>" : ''}
    </div>
    <div class="hero">
      <h2 style="margin:0;">${title}</h2>
      <div class="small">${labelInvoice}: ${'${order.invoice_number}'} — ${labelDate}: ${'${order.order_date}'}</div>
    </div>
    <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px; margin-top:12px;">
      ${showCustomer ? `
      <div class=\"card\">
        <div style=\"font-weight:600; margin-bottom:6px;\">${labelCustomerSec}</div>
        <div>الاسم: ${'${customer.name}'} </div>
        <div>الهاتف: ${'${customer.phone}'} </div>
        <div>العنوان: ${'${customer.address}'} </div>
      </div>`: ''}
      <div class="card" style="background:#fff3cd;">
        <div style="font-weight:600; margin-bottom:6px;">بيانات الطلب</div>
        <div>الفرع: ${'${branch.name}'} </div>
        <div>اسم البائع: ${'${salesperson.name}'} </div>
        <div>رقم الطلب: ${'${order.order_number}'} </div>
        <div>نوع الطلب: ${'${order.type}'} </div>
        <div>تسليم متوقع: ${'${order.expected_delivery_date}'} </div>
      </div>
      ${showCompany ? `
      <div class=\"card\">
        <div style=\"font-weight:600; margin-bottom:6px;\">${labelCompanySec}</div>
        <div>${cname}</div>
        <div>${cphone}</div>
        <div>${caddr}</div>
      </div>`: ''}
    </div>
    ${showTable ? `
    <div class=\"card\" style=\"margin-top:12px;\">
      <table class=\"items-table\">
        <thead>
          <tr><th>${thDesc}</th><th>${thQty}</th><th>${thPrice}</th><th>${thTotal}</th></tr>
        </thead>
        <tbody>${'${order.items_table}'} </tbody>
      </table>
    </div>`: ''}
    <div class="totals">
      <div class="t"><div style="color:#666;">المبلغ الإجمالي</div><strong>${'${order.total_amount}'} ${'${systemSettings.currency_symbol}'}</strong></div>
      <div class="t"><div style="color:#198754;">المبلغ المدفوع</div><strong>${'${order.paid_amount}'} ${'${systemSettings.currency_symbol}'}</strong></div>
      <div class="t"><div style="color:#dc3545;">المبلغ المتبقي</div><strong>${'${order.remaining_amount}'} ${'${systemSettings.currency_symbol}'}</strong></div>
    </div>
    ${notes ? `<div class=\"card\" style=\"margin-top:12px; color:#495057;\">${notes}</div>` : ''}
    ${terms ? `<div class=\"card\" style=\"margin-top:8px; color:#6c757d;\">${terms}</div>` : ''}
    `;

    const pro = `
    <style>
      :root { --primary-color:${primary}; --accent-color:${accent}; }
      body { font-family:${font}; }
      .header{ display:flex; justify-content:space-between; align-items:center; padding-bottom:12px; border-bottom:3px solid var(--primary-color); }
      .company{ text-align:right; }
      .logo{ height:50px; }
      .grid{ display:grid; grid-template-columns:1fr 1fr; gap:14px; margin-top:14px; }
      .box{ background:#fff; border:1px solid #e9ecef; border-radius:10px; padding:12px; }
      .box h4{ margin:0 0 8px; color:var(--primary-color); font-size:16px; }
      .items-table{ width:100%; border-collapse: collapse; margin-top:14px; table-layout: fixed; }
      .items-table thead th{ background:#fafbfc; border-bottom:2px solid var(--primary-color); }
      .items-table th,.items-table td{ padding:10px; border-bottom:1px solid #eee; }
      .totals{ display:flex; gap:12px; margin-top:14px; }
      .totals .t{ flex:1; background:#f8f9fa; border:1px solid #eee; border-radius:10px; padding:12px; text-align:center; }
      .bg-logo{ position:fixed; inset:0; display:${bg?'block':'none'}; opacity:.08; z-index:-1; pointer-events:none; }
      .bg-logo img{ max-width:60%; position:absolute; top:40%; left:50%; transform:translate(-50%,-50%); }
      @media print { .bg-logo{ display:${bg?'block':'none'} !important; } }
    </style>
    <div class="bg-logo">
      ${bg && COMPANY_LOGO_URL ? "<img src='" + COMPANY_LOGO_URL + "'/>" : ''}
    </div>
    <div class="header">
      <div class="company">
        <div style="font-size:22px; font-weight:700; color:var(--primary-color);">${cname}</div>
        <div class="small">${caddr}</div>
        <div class="small">${cphone}</div>
      </div>
      ${COMPANY_LOGO_URL ? `<img class=\"logo\" src=\"${COMPANY_LOGO_URL}\"/>` : ''}
    </div>
    <div class="small" style="margin-top:6px;">
      ${labelInvoice}: ${'${order.invoice_number}'} • ${labelDate}: ${'${order.order_date}'}
    </div>
    <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:14px;">
      ${showCustomer ? `
      <div class=\"box\">
        <h4>${labelCustomerSec}</h4>
        <div>الاسم: ${'${customer.name}'} </div>
        <div>الهاتف: ${'${customer.phone}'} </div>
        <div>العنوان: ${'${customer.address}'} </div>
      </div>`: ''}
      <div class="box" style="background:#fff3cd;">
        <h4>بيانات الطلب</h4>
        <div>الفرع: ${'${branch.name}'} </div>
        <div>اسم البائع: ${'${salesperson.name}'} </div>
        <div>رقم الطلب: ${'${order.order_number}'} </div>
        <div>نوع الطلب: ${'${order.type}'} </div>
        <div>تسليم متوقع: ${'${order.expected_delivery_date}'} </div>
      </div>
      ${showCompany ? `
      <div class=\"box\">
        <h4>${labelCompanySec}</h4>
        <div>${cname}</div>
        <div>${cphone}</div>
        <div>${caddr}</div>
      </div>`: ''}
    </div>
    ${showTable ? `
    <div class=\"box\" style=\"margin-top:12px;\">
      <table class=\"items-table\">
        <thead>
          <tr><th>${thDesc}</th><th>${thQty}</th><th>${thPrice}</th><th>${thTotal}</th></tr>
        </thead>
        <tbody>${'${order.items_table}'} </tbody>
      </table>
    </div>`: ''}
    <div class="totals">
      <div class="t"><div style="color:#666; font-size:12px;">المبلغ الإجمالي</div><strong style="font-size:18px;">${'${order.total_amount}'} ${'${systemSettings.currency_symbol}'}</strong></div>
      <div class="t"><div style="color:#198754; font-size:12px;">المبلغ المدفوع</div><strong style="color:#198754; font-size:18px;">${'${order.paid_amount}'} ${'${systemSettings.currency_symbol}'}</strong></div>
      <div class="t"><div style="color:#dc3545; font-size:12px;">المبلغ المتبقي</div><strong style="color:#dc3545; font-size:18px;">${'${order.remaining_amount}'} ${'${systemSettings.currency_symbol}'}</strong></div>
    </div>
    ${notes ? `<div class=\"box\" style=\"margin-top:12px; color:#495057;\">${notes}</div>` : ''}
    ${terms ? `<div class=\"box\" style=\"margin-top:12px; color:#6c757d;\">${terms}</div>` : ''}
    `;

    if (style === 'pro') return pro;
    if (style === 'modern') return modern;
    if (style === 'classic') return classic;
    if (SAVED_HTML && SAVED_HTML.length > 0) return SAVED_HTML;
    return classic;
  }

  function updatePreview() {
    const html = buildHtml();
    document.getElementById('preview').innerHTML = html;
  }

  function loadSaved() {
    const s = META?.settings || {};
    if (s.primary_color) document.getElementById('primary_color').value = s.primary_color;
    if (s.accent_color) document.getElementById('accent_color').value = s.accent_color;
    if (s.font_family) document.getElementById('font_family').value = s.font_family;
    const ci = META?.company_info || {};
    if (ci.name) document.getElementById('company_name').value = ci.name;
    if (ci.phone) document.getElementById('company_phone').value = ci.phone;
    if (ci.address) document.getElementById('company_address').value = ci.address;
    const adv = META?.advanced_settings || {};
    if (adv.invoice_title) document.getElementById('invoice_title').value = adv.invoice_title;
    if (adv.label_invoice_number) document.getElementById('label_invoice_number').value = adv.label_invoice_number;
    if (adv.label_date) document.getElementById('label_date').value = adv.label_date;
    if (adv.label_customer_section) document.getElementById('label_customer_section').value = adv.label_customer_section;
    if (adv.label_company_section) document.getElementById('label_company_section').value = adv.label_company_section;
    if (adv.th_desc) document.getElementById('th_desc').value = adv.th_desc;
    if (adv.th_qty) document.getElementById('th_qty').value = adv.th_qty;
    if (adv.th_price) document.getElementById('th_price').value = adv.th_price;
    if (adv.th_total) document.getElementById('th_total').value = adv.th_total;
    if (adv.notes_text) document.getElementById('notes_text').value = adv.notes_text;
    if (adv.terms_text) document.getElementById('terms_text').value = adv.terms_text;
    if (adv.show_background_logo) document.getElementById('show_bg_logo').checked = !!adv.show_background_logo;
    if (typeof adv.show_customer !== 'undefined') document.getElementById('show_customer').checked = !!adv.show_customer;
    if (typeof adv.show_company !== 'undefined') document.getElementById('show_company').checked = !!adv.show_company;
    if (typeof adv.show_table !== 'undefined') document.getElementById('show_table').checked = !!adv.show_table;
    if (adv.template_style) document.getElementById('template_style').value = adv.template_style;
    updatePreview();
  }

  document.addEventListener('input', (e)=>{
    if (['invoice_title','primary_color','accent_color','font_family','company_name','company_phone','company_address','notes_text','show_bg_logo'].includes(e.target.id)) {
      updatePreview();
    }
  });

  document.getElementById('template_style').addEventListener('change', ()=>{
    updatePreview();
  });

  loadSaved();

  document.getElementById('save-template').onclick = async () => {
    const html_content = document.getElementById('preview').innerHTML;
    const payload = {
      template_id: TEMPLATE_ID,
      template_data: {
        name: META?.name || 'قالب مخصص',
        template_type: 'custom',
        html_content,
        css_styles: '',
        settings: {
          primary_color: document.getElementById('primary_color').value,
          secondary_color: META?.settings?.secondary_color || '#198754',
          accent_color: document.getElementById('accent_color').value,
          font_family: document.getElementById('font_family').value,
          font_size: META?.settings?.font_size || 14,
          page_size: 'A4',
          page_margins: 20,
        },
        company_info: {
          name: document.getElementById('company_name').value,
          phone: document.getElementById('company_phone').value,
          address: document.getElementById('company_address').value,
        },
        content_settings: META?.content_settings || {},
        advanced_settings: {
          ...(META?.advanced_settings || {}),
          invoice_title: document.getElementById('invoice_title').value,
          label_invoice_number: document.getElementById('label_invoice_number').value,
          label_date: document.getElementById('label_date').value,
          label_customer_section: document.getElementById('label_customer_section').value,
          label_company_section: document.getElementById('label_company_section').value,
          th_desc: document.getElementById('th_desc').value,
          th_qty: document.getElementById('th_qty').value,
          th_price: document.getElementById('th_price').value,
          th_total: document.getElementById('th_total').value,
          notes_text: document.getElementById('notes_text').value,
          show_background_logo: document.getElementById('show_bg_logo').checked,
          terms_text: document.getElementById('terms_text').value,
          show_customer: document.getElementById('show_customer').checked,
          show_company: document.getElementById('show_company').checked,
          show_table: document.getElementById('show_table').checked,
          template_style: document.getElementById('template_style').value,
        }
      }
    };

    const resp = await fetch('{% url 'orders:save_template' %}', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
      body: JSON.stringify(payload)
    });
    const data = await resp.json();
    if (data.success) {
      alert('تم الحفظ بنجاح');
      if (!TEMPLATE_ID && data.template_id) {
        window.location.href = `/orders/invoice-editor/${data.template_id}/`;
      }
    } else {
      alert('فشل الحفظ: ' + (data.error || 'خطأ غير معروف'));
    }
  };

  document.getElementById('set-default').onclick = async ()=>{
    if (!TEMPLATE_ID) return;
    const resp = await fetch(`/orders/api/templates/${TEMPLATE_ID}/set-default/`, { method: 'POST', headers: { 'X-CSRFToken': '{{ csrf_token }}' } });
    const data = await resp.json().catch(()=>({success:false}));
    if (data.success) alert('تم تعيين القالب كافتراضي'); else alert('تعذر التعيين كافتراضي');
  };
</script>
{% endblock %}

