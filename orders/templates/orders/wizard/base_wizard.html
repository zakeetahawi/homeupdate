{% extends 'base.html' %}
{% load static %}

{% block title %}إنشاء طلب جديد - الخطوة {{ current_step }} من {{ total_steps }}{% endblock %}

{% block extra_css %}
<style>
    .wizard-container {
        max-width: 1200px;
        margin: 0 auto;
    }
    
    .progress-wizard {
        margin-bottom: 30px;
    }
    
    .wizard-progress-bar {
        height: 8px;
        border-radius: 4px;
        background: linear-gradient(90deg, #198754 0%, #146c43 100%);
        transition: width 0.3s ease;
    }
    
    .wizard-steps {
        display: flex;
        justify-content: space-between;
        margin-top: 20px;
        position: relative;
    }
    
    .wizard-step {
        flex: 1;
        text-align: center;
        position: relative;
    }
    
    .wizard-step-number {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #e9ecef;
        color: #6c757d;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-bottom: 8px;
        transition: all 0.3s ease;
    }
    
    .wizard-step.active .wizard-step-number {
        background: linear-gradient(135deg, #198754 0%, #146c43 100%);
        color: white;
        box-shadow: 0 4px 12px rgba(25, 135, 84, 0.3);
    }
    
    .wizard-step.completed .wizard-step-number {
        background: #198754;
        color: white;
    }
    
    .wizard-step-title {
        font-size: 0.85rem;
        color: #6c757d;
    }
    
    .wizard-step.active .wizard-step-title {
        color: #198754;
        font-weight: 600;
    }
    
    .wizard-card {
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        border: none;
    }
    
    .wizard-card-header {
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border-bottom: 2px solid #e2e8f0;
        padding: 20px;
        border-radius: 12px 12px 0 0;
    }
    
    .wizard-card-body {
        padding: 30px;
    }
    
    .wizard-actions {
        display: flex;
        justify-content: space-between;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid #e2e8f0;
    }
    
    .btn-wizard {
        padding: 12px 30px;
        font-weight: 600;
        border-radius: 8px;
        transition: all 0.3s ease;
    }
    
    .btn-wizard-primary {
        background: linear-gradient(135deg, #198754 0%, #146c43 100%);
        border: none;
        color: white;
    }
    
    .btn-wizard-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(25, 135, 84, 0.4);
    }
    
    .btn-wizard-secondary {
        background: #6c757d;
        border: none;
        color: white;
    }
    
    /* تنسيقات الحقول الإلزامية الفارغة */
    .field-required-error {
        border: 2px solid #dc3545 !important;
        background-color: #fff5f5 !important;
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
        animation: shake 0.5s ease-in-out;
    }
    
    .field-required-error:focus {
        border-color: #dc3545 !important;
        box-shadow: 0 0 0 0.25rem rgba(220, 53, 69, 0.25) !important;
    }
    
    .field-error-message {
        color: #dc3545;
        font-size: 0.875rem;
        margin-top: 0.25rem;
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }
    
    .field-error-message i {
        font-size: 0.75rem;
    }
    
    /* تنسيقات الحقول الصحيحة - علامة خضراء */
    .field-valid-success {
        border: 2px solid #198754 !important;
        background-color: #f0fff4 !important;
        box-shadow: 0 0 0 0.2rem rgba(25, 135, 84, 0.15) !important;
    }
    
    .field-valid-success:focus {
        border-color: #198754 !important;
        box-shadow: 0 0 0 0.25rem rgba(25, 135, 84, 0.25) !important;
    }
    
    /* حاوية الحقل مع علامة الصح */
    .field-wrapper {
        position: relative;
    }
    
    .field-success-icon {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #198754;
        font-size: 1.1rem;
        display: none;
        z-index: 10;
        pointer-events: none;
    }
    
    .field-error-icon {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #dc3545;
        font-size: 1.1rem;
        display: none;
        z-index: 10;
        pointer-events: none;
    }
    
    .field-valid-success + .field-success-icon,
    .field-wrapper.has-success .field-success-icon {
        display: block;
    }
    
    .field-required-error + .field-error-icon,
    .field-wrapper.has-error .field-error-icon {
        display: block;
    }
    
    /* Select2 مع نجاح */
    .select2-container--success .select2-selection--single {
        border: 2px solid #198754 !important;
        background-color: #f0fff4 !important;
    }
    
    /* بطاقات الاختيار مع نجاح */
    .order-type-card.field-valid-success {
        border: 3px solid #198754 !important;
        background-color: #f0fff4 !important;
    }
    
    /* تأثير الاهتزاز للحقول */
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
        20%, 40%, 60%, 80% { transform: translateX(5px); }
    }
    
    /* Select2 مع خطأ */
    .select2-container--error .select2-selection--single {
        border: 2px solid #dc3545 !important;
        background-color: #fff5f5 !important;
    }
    
    /* بطاقات الاختيار مع خطأ */
    .order-type-card.field-required-error {
        border: 3px solid #dc3545 !important;
        background-color: #fff5f5 !important;
    }
    
    .btn-wizard-danger {
        background: #dc3545;
        border: none;
        color: white;
    }
    
    /* تحسينات الهواتف المحمولة للويزارد */
    @media (max-width: 768px) {
        .wizard-container {
            padding: 0 10px;
        }
        
        .wizard-steps {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 10px;
        }
        
        .wizard-step {
            min-width: 80px;
        }
        
        .wizard-step-number {
            width: 36px;
            height: 36px;
            font-size: 14px;
        }
        
        .wizard-step-title {
            font-size: 0.75rem;
            white-space: nowrap;
        }
        
        .wizard-card-header {
            padding: 15px;
        }
        
        .wizard-card-header h4 {
            font-size: 16px;
        }
        
        .wizard-card-body {
            padding: 15px;
        }
        
        .wizard-actions {
            flex-direction: column;
            gap: 10px;
        }
        
        .btn-wizard {
            width: 100%;
            padding: 14px 20px;
            font-size: 16px !important;
            min-height: 48px;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        
        /* منع التكبير المزدوج على الحقول */
        .form-control,
        .form-select,
        select,
        input,
        textarea {
            font-size: 16px !important;
            min-height: 48px;
            padding: 12px 15px;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        
        /* تحسين Select2 للموبايل */
        .select2-container .select2-selection--single {
            height: 48px !important;
            font-size: 16px !important;
        }
        
        .select2-container .select2-selection--single .select2-selection__rendered {
            line-height: 46px !important;
            font-size: 16px !important;
        }
        
        .select2-container .select2-selection--single .select2-selection__arrow {
            height: 46px !important;
        }
        
        /* تحسين الـ Labels */
        .form-label {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        /* منع إخفاء العناصر عند اللمس */
        * {
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
        }
        
        /* تحسين الصفوف */
        .row {
            margin-left: -8px;
            margin-right: -8px;
        }
        
        .col,
        [class*="col-"] {
            padding-left: 8px;
            padding-right: 8px;
        }
    }
    
    @media (max-width: 480px) {
        .wizard-step {
            min-width: 60px;
        }
        
        .wizard-step-title {
            font-size: 0.65rem;
        }
        
        .wizard-card-body {
            padding: 12px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="wizard-container">
    <!-- Progress Bar -->
    <div class="progress-wizard">
        <div class="progress" style="height: 8px; border-radius: 4px;">
            <div class="wizard-progress-bar" role="progressbar" 
                 style="width: {{ progress_percentage }}%"
                 aria-valuenow="{{ progress_percentage }}" 
                 aria-valuemin="0" 
                 aria-valuemax="100">
            </div>
        </div>
        
        <!-- Steps Indicator -->
        <div class="wizard-steps">
            <div class="wizard-step {% if current_step >= 1 %}{% if current_step == 1 %}active{% elif current_step > 1 %}completed{% endif %}{% endif %}">
                <div class="wizard-step-number">
                    {% if current_step > 1 %}
                        <i class="fas fa-check"></i>
                    {% else %}
                        1
                    {% endif %}
                </div>
                <div class="wizard-step-title">البيانات الأساسية</div>
            </div>
            
            <div class="wizard-step {% if current_step >= 2 %}{% if current_step == 2 %}active{% elif current_step > 2 %}completed{% endif %}{% endif %}">
                <div class="wizard-step-number">
                    {% if current_step > 2 %}
                        <i class="fas fa-check"></i>
                    {% else %}
                        2
                    {% endif %}
                </div>
                <div class="wizard-step-title">نوع الطلب</div>
            </div>
            
            <div class="wizard-step {% if current_step >= 3 %}{% if current_step == 3 %}active{% elif current_step > 3 %}completed{% endif %}{% endif %}">
                <div class="wizard-step-number">
                    {% if current_step > 3 %}
                        <i class="fas fa-check"></i>
                    {% else %}
                        3
                    {% endif %}
                </div>
                <div class="wizard-step-title">عناصر الطلب</div>
            </div>
            
            <div class="wizard-step {% if current_step >= 4 %}{% if current_step == 4 %}active{% elif current_step > 4 %}completed{% endif %}{% endif %}">
                <div class="wizard-step-number">
                    {% if current_step > 4 %}
                        <i class="fas fa-check"></i>
                    {% else %}
                        4
                    {% endif %}
                </div>
                <div class="wizard-step-title">المرجع والدفع</div>
            </div>
            
            <div class="wizard-step {% if current_step >= 5 %}{% if current_step == 5 %}active{% elif current_step > 5 %}completed{% endif %}{% endif %}">
                <div class="wizard-step-number">
                    {% if current_step > 5 %}
                        <i class="fas fa-check"></i>
                    {% else %}
                        5
                    {% endif %}
                </div>
                <div class="wizard-step-title">العقد الإلكتروني</div>
            </div>
            
            <div class="wizard-step {% if current_step == 6 %}active{% endif %}">
                <div class="wizard-step-number">6</div>
                <div class="wizard-step-title">المراجعة</div>
            </div>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="card wizard-card">
        <div class="card-header wizard-card-header">
            <h4 class="mb-0">
                <i class="fas fa-{{ step_icon|default:'shopping-cart' }} me-2"></i>
                {{ step_title }}
            </h4>
        </div>
        <div class="card-body wizard-card-body">
            {% block wizard_content %}
            <!-- محتوى الخطوة سيتم إدراجه هنا -->
            {% endblock %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// ============================================
// دوال التحقق من الحقول الإلزامية
// ============================================

/**
 * إضافة تنسيق الخطأ للحقل
 */
function markFieldAsError(field, message) {
    if (!field) return;
    
    // إزالة أي تنسيق سابق (خطأ أو نجاح)
    clearFieldError(field);
    clearFieldValid(field);
    
    // إضافة class الخطأ
    field.classList.add('field-required-error');
    
    // التعامل مع Select2
    const select2Container = field.closest('.mb-3, .mb-4')?.querySelector('.select2-container');
    if (select2Container) {
        select2Container.classList.add('select2-container--error');
    }
    
    // إضافة أيقونة الخطأ (❌) إذا لم تكن موجودة
    const wrapper = field.closest('.mb-3, .mb-4, .field-wrapper');
    if (wrapper && !wrapper.querySelector('.field-error-icon')) {
        const errorIcon = document.createElement('span');
        errorIcon.className = 'field-error-icon';
        errorIcon.innerHTML = '<i class="fas fa-times-circle"></i>';
        
        // إضافة الأيقونة بجانب الحقل
        const inputWrapper = field.closest('.input-group') || field.parentElement;
        if (inputWrapper) {
            inputWrapper.style.position = 'relative';
            inputWrapper.appendChild(errorIcon);
        }
    }
    
    // إضافة رسالة الخطأ
    if (message) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'field-error-message';
        errorDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
        field.parentNode.insertBefore(errorDiv, field.nextSibling);
    }
    
    // التمرير إلى الحقل
    field.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

/**
 * إزالة تنسيق الخطأ من الحقل
 */
function clearFieldError(field) {
    if (!field) return;
    
    field.classList.remove('field-required-error');
    
    // إزالة Select2 error
    const select2Container = field.closest('.mb-3, .mb-4')?.querySelector('.select2-container');
    if (select2Container) {
        select2Container.classList.remove('select2-container--error');
    }
    
    // إزالة أيقونة الخطأ
    const wrapper = field.closest('.mb-3, .mb-4, .field-wrapper');
    if (wrapper) {
        const errorIcon = wrapper.querySelector('.field-error-icon');
        if (errorIcon) {
            errorIcon.remove();
        }
    }
    
    // إزالة رسالة الخطأ
    const errorMessage = field.parentNode.querySelector('.field-error-message');
    if (errorMessage) {
        errorMessage.remove();
    }
}

/**
 * إزالة جميع أخطاء الحقول في النموذج
 */
function clearAllFieldErrors(form) {
    if (!form) return;
    
    form.querySelectorAll('.field-required-error').forEach(field => {
        clearFieldError(field);
    });
    
    form.querySelectorAll('.select2-container--error').forEach(container => {
        container.classList.remove('select2-container--error');
    });
    
    form.querySelectorAll('.field-error-message').forEach(msg => msg.remove());
    
    // إزالة الخطأ من بطاقات الاختيار
    form.querySelectorAll('.order-type-card.field-required-error').forEach(card => {
        card.classList.remove('field-required-error');
    });
}

/**
 * إزالة جميع علامات النجاح والخطأ
 */
function clearAllFieldValidation(form) {
    if (!form) return;
    
    clearAllFieldErrors(form);
    
    form.querySelectorAll('.field-valid-success').forEach(field => {
        clearFieldValid(field);
    });
    
    form.querySelectorAll('.select2-container--success').forEach(container => {
        container.classList.remove('select2-container--success');
    });
    
    form.querySelectorAll('.field-success-icon').forEach(icon => icon.remove());
}

/**
 * التحقق من حقل واحد
 */
function validateField(field, fieldName) {
    if (!field) return true;
    
    const value = field.value?.trim();
    
    if (!value || value === '' || value === 'undefined') {
        markFieldAsError(field, `الحقل "${fieldName}" مطلوب`);
        return false;
    }
    
    clearFieldError(field);
    markFieldAsValid(field);
    return true;
}

/**
 * إضافة تنسيق النجاح للحقل (علامة خضراء)
 */
function markFieldAsValid(field) {
    if (!field) return;
    
    // إزالة أي تنسيق سابق
    clearFieldError(field);
    
    // إضافة class النجاح
    field.classList.add('field-valid-success');
    
    // التعامل مع Select2
    const select2Container = field.closest('.mb-3, .mb-4')?.querySelector('.select2-container');
    if (select2Container) {
        select2Container.classList.remove('select2-container--error');
        select2Container.classList.add('select2-container--success');
    }
    
    // إضافة أيقونة النجاح إذا لم تكن موجودة
    const wrapper = field.closest('.mb-3, .mb-4, .field-wrapper');
    if (wrapper && !wrapper.querySelector('.field-success-icon')) {
        const successIcon = document.createElement('span');
        successIcon.className = 'field-success-icon';
        successIcon.innerHTML = '<i class="fas fa-check-circle"></i>';
        
        // إضافة الأيقونة بجانب الحقل
        const inputWrapper = field.closest('.input-group') || field.parentElement;
        if (inputWrapper) {
            inputWrapper.style.position = 'relative';
            inputWrapper.appendChild(successIcon);
        }
    }
}

/**
 * إزالة تنسيق النجاح من الحقل
 */
function clearFieldValid(field) {
    if (!field) return;
    
    field.classList.remove('field-valid-success');
    
    // إزالة Select2 success
    const select2Container = field.closest('.mb-3, .mb-4')?.querySelector('.select2-container');
    if (select2Container) {
        select2Container.classList.remove('select2-container--success');
    }
    
    // إزالة أيقونة النجاح
    const wrapper = field.closest('.mb-3, .mb-4, .field-wrapper');
    if (wrapper) {
        const successIcon = wrapper.querySelector('.field-success-icon');
        if (successIcon) {
            successIcon.remove();
        }
    }
}

/**
 * عرض تنبيه للحقول الفارغة
 */
function showValidationAlert(missingFields) {
    if (typeof Swal !== 'undefined') {
        Swal.fire({
            icon: 'warning',
            title: 'حقول مطلوبة',
            html: `
                <div class="text-end">
                    <p class="mb-3">يرجى ملء الحقول التالية:</p>
                    <ul class="list-unstyled text-danger">
                        ${missingFields.map(f => `<li><i class="fas fa-exclamation-circle me-2"></i>${f}</li>`).join('')}
                    </ul>
                </div>
            `,
            confirmButtonText: 'حسناً',
            confirmButtonColor: '#dc3545'
        });
    } else {
        alert('يرجى ملء الحقول التالية:\n' + missingFields.join('\n'));
    }
}

/**
 * إزالة الخطأ عند تغيير قيمة الحقل وإضافة علامة النجاح
 */
function setupFieldValidationListeners(form) {
    if (!form) return;
    
    // الحقول العادية
    form.querySelectorAll('input, select, textarea').forEach(field => {
        // تطبيق التحقق عند التحميل للحقول المعبأة مسبقاً
        if (field.value?.trim() && field.hasAttribute('required')) {
            markFieldAsValid(field);
        }
        
        field.addEventListener('change', function() {
            if (this.value?.trim()) {
                clearFieldError(this);
                if (this.hasAttribute('required') || this.closest('.mb-4')?.querySelector('.text-danger')) {
                    markFieldAsValid(this);
                }
            } else {
                clearFieldValid(this);
            }
        });
        
        field.addEventListener('input', function() {
            if (this.value?.trim()) {
                clearFieldError(this);
                if (this.hasAttribute('required') || this.closest('.mb-4')?.querySelector('.text-danger')) {
                    markFieldAsValid(this);
                }
            } else {
                clearFieldValid(this);
            }
        });
        
        // عند فقدان التركيز على الحقل، تحقق من القيمة وأظهر الخطأ إذا كان فارغاً
        field.addEventListener('blur', function() {
            const isRequired = this.hasAttribute('required') || this.closest('.mb-4')?.querySelector('.text-danger');
            if (isRequired) {
                if (this.value?.trim()) {
                    markFieldAsValid(this);
                } else {
                    // إظهار الخطأ الأحمر وأيقونة ❌ للحقل الفارغ
                    const label = this.closest('.mb-3, .mb-4')?.querySelector('label')?.textContent?.replace('*', '').trim();
                    markFieldAsError(this, label ? `${label} مطلوب` : 'هذا الحقل مطلوب');
                }
            }
        });
    });
    
    // Select2 fields
    if (typeof $ !== 'undefined') {
        $(form).find('select').on('select2:select', function() {
            clearFieldError(this);
            markFieldAsValid(this);
        });
        
        $(form).find('select').on('select2:clear', function() {
            clearFieldValid(this);
            // إظهار الخطأ إذا كان الحقل مطلوباً
            const isRequired = $(this).attr('required') || $(this).closest('.mb-4').find('.text-danger').length > 0;
            if (isRequired) {
                const label = $(this).closest('.mb-3, .mb-4').find('label').text().replace('*', '').trim();
                markFieldAsError(this, label ? `${label} مطلوب` : 'هذا الحقل مطلوب');
            }
        });
        
        // إضافة مستمع لفتح وإغلاق Select2
        $(form).find('select').on('select2:close', function() {
            const value = $(this).val();
            const isRequired = $(this).attr('required') || $(this).closest('.mb-4').find('.text-danger').length > 0;
            if (isRequired && (!value || value === '')) {
                const label = $(this).closest('.mb-3, .mb-4').find('label').text().replace('*', '').trim();
                markFieldAsError(this, label ? `${label} مطلوب` : 'هذا الحقل مطلوب');
            }
        });
    }
}

// تهيئة المستمعين عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', function() {
    const forms = document.querySelectorAll('form');
    forms.forEach(form => {
        setupFieldValidationListeners(form);
    });
});

// ============================================
// دوال إرسال النموذج
// ============================================

// دالة عامة لإرسال النموذج عبر AJAX
function submitWizardStep(formElement, nextStepUrl) {
    const formData = new FormData(formElement);
    
    fetch(formElement.action, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // الانتقال للخطوة التالية
            window.location.href = nextStepUrl || `/orders/wizard/step/${data.next_step}/`;
        } else {
            // عرض الأخطاء مع تلوين الحقول
            showErrors(data.errors || data.message);
            highlightErrorFields(data.errors);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('حدث خطأ أثناء الحفظ');
    });
}

/**
 * تلوين الحقول التي بها أخطاء من الخادم
 */
function highlightErrorFields(errors) {
    if (!errors || typeof errors !== 'object') return;
    
    for (const [fieldName, msgs] of Object.entries(errors)) {
        // البحث عن الحقل بالاسم أو المعرف
        let field = document.querySelector(`[name="${fieldName}"]`) || 
                    document.querySelector(`#id_${fieldName}`);
        
        if (field) {
            const message = Array.isArray(msgs) ? msgs.join(', ') : msgs;
            markFieldAsError(field, message);
        }
    }
}

function showErrors(errors) {
    if (typeof errors === 'string') {
        if (typeof Swal !== 'undefined') {
            Swal.fire({
                icon: 'error',
                title: 'خطأ',
                text: errors,
                confirmButtonText: 'حسناً',
                confirmButtonColor: '#dc3545'
            });
        } else {
            alert(errors);
        }
    } else {
        let errorMessage = '';
        const fieldNames = [];
        for (const [field, msgs] of Object.entries(errors)) {
            const message = Array.isArray(msgs) ? msgs.join(', ') : msgs;
            errorMessage += `${field}: ${message}\n`;
            fieldNames.push(field);
        }
        
        if (typeof Swal !== 'undefined') {
            Swal.fire({
                icon: 'error',
                title: 'يوجد أخطاء في البيانات',
                html: `<div class="text-end">${errorMessage.replace(/\n/g, '<br>')}</div>`,
                confirmButtonText: 'حسناً',
                confirmButtonColor: '#dc3545'
            });
        } else {
            alert(errorMessage);
        }
    }
}
</script>
{% endblock %}
