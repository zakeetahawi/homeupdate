{% extends 'orders/wizard/base_wizard.html' %}
{% load static decimal_filters %}

{% block wizard_content %}

<!-- Edit History Section -->
{% include 'orders/wizard/partials/edit_history.html' with draft=draft %}

<div class="row">
    <div class="col-md-8">
        <!-- Add Item Section -->
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0">
                    <i class="fas fa-plus me-2"></i>إضافة عنصر جديد
                </h5>
            </div>
            <div class="card-body">
                <!-- زر إضافة بالباركود -->
                <div class="text-center mb-3">
                    <button type="button" class="btn btn-outline-primary btn-lg" data-bs-toggle="modal" data-bs-target="#wizardBarcodeScannerModal"
                            style="border-radius: 12px; border-width: 2px;">
                        <i class="fas fa-barcode me-2"></i> إضافة بالباركود
                    </button>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-bold">المنتج <span class="text-danger">*</span></label>
                        <select id="product-select" class="form-select">
                            <option value="">-- اختر المنتج --</option>
                        </select>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="form-label fw-bold">الكمية <span class="text-danger">*</span></label>
                        <input type="number" id="item-quantity" class="form-control" min="0.001" step="0.001" value="1">
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="form-label fw-bold">السعر <span class="text-danger">*</span></label>
                        <input type="number" id="item-price" class="form-control" min="0" step="0.01" 
                               value="0" readonly style="background-color: #e9ecef;">
                        <small class="text-muted">من النظام</small>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-bold">الخصم</label>
                        <select id="item-discount" class="form-select">
                            {% for i in "0123456789012345"|make_list %}
                                <option value="{{ forloop.counter0 }}">{{ forloop.counter0 }}%</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6 mb-3 d-flex align-items-end">
                        <button type="button" class="btn btn-success w-100" onclick="addItem()">
                            <i class="fas fa-plus me-2"></i>إضافة
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Items List -->
        <div class="card">
            <div class="card-header bg-light">
                <h5 class="mb-0">
                    <i class="fas fa-list me-2"></i>العناصر المضافة
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="items-table">
                        <thead class="table-light">
                            <tr>
                                <th>المنتج</th>
                                <th>الكمية</th>
                                <th>السعر</th>
                                <th>الخصم</th>
                                <th>الإجمالي</th>
                                <th>النهائي</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="items-tbody">
                            {% for item in items %}
                            <tr data-item-id="{{ item.id }}" {% if item.added_by and item.added_by != draft.created_by %}class="table-warning"{% endif %}>
                                <td>
                                    {{ item.product.name }}
                                    {% if item.added_by and item.added_by != draft.created_by %}
                                    <br><small class="badge bg-warning text-dark">
                                        <i class="fas fa-user-edit"></i> أُضيف بواسطة: {{ item.added_by.get_full_name }}
                                    </small>
                                    {% endif %}
                                    {% if item.modified_by and item.modified_by != item.added_by %}
                                    <br><small class="badge bg-info">
                                        <i class="fas fa-edit"></i> عُدل بواسطة: {{ item.modified_by.get_full_name }}
                                    </small>
                                    {% endif %}
                                </td>
                                <td>{{ item.quantity|clean_decimal:3 }}</td>
                                <td>{{ item.unit_price|format_currency }}</td>
                                <td>{{ item.discount_percentage|format_percentage }}</td>
                                <td>{{ item.total_price|format_currency }}</td>
                                <td class="fw-bold">{{ item.final_price|format_currency }}</td>
                                <td>
                                    <button type="button" class="btn btn-sm btn-danger" 
                                            onclick="removeItem({{ item.id }})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {% empty %}
                            <tr id="no-items-row">
                                <td colspan="7" class="text-center text-muted py-4">
                                    <i class="fas fa-inbox fa-2x mb-2"></i>
                                    <p class="mb-0">لم يتم إضافة عناصر بعد</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Summary Sidebar -->
    <div class="col-md-4">
        <div class="card sticky-top" style="top: 20px;">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-calculator me-2"></i>الملخص
                </h5>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between mb-2">
                    <span>المجموع قبل الخصم:</span>
                    <strong id="subtotal">{{ totals.subtotal|format_currency }}</strong>
                </div>
                <div class="d-flex justify-content-between mb-2 text-danger">
                    <span>إجمالي الخصم:</span>
                    <strong id="total-discount">{{ totals.total_discount|format_currency }}</strong>
                </div>
                <hr>
                <div class="d-flex justify-content-between mb-3">
                    <span class="h5">المجموع النهائي:</span>
                    <strong class="h5 text-success" id="final-total">{{ totals.final_total|format_currency }}</strong>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Actions -->
<div class="wizard-actions mt-4">
    <div>
        <a href="{% url 'orders:wizard_cancel' %}" class="btn btn-wizard btn-wizard-danger me-2">
            <i class="fas fa-times me-2"></i>إلغاء
        </a>
        <a href="{% url 'orders:wizard_step' step=2 %}" class="btn btn-wizard btn-wizard-secondary">
            <i class="fas fa-arrow-right me-2"></i>السابق
        </a>
    </div>
    <div>
        <button type="button" class="btn btn-wizard btn-wizard-primary" onclick="completeStep3()">
            <i class="fas fa-arrow-left me-2"></i>التالي
        </button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.rtl.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<style>
/* تحسينات Select2 للمنتجات */
.select2-container {
    width: 100% !important;
}

.select2-container .select2-selection--single {
    height: 48px !important;
    font-size: 16px !important;
    border: 2px solid #e9ecef !important;
    border-radius: 8px !important;
    transition: all 0.3s ease;
}

.select2-container--open .select2-selection--single {
    border-color: #198754 !important;
    box-shadow: 0 0 0 0.2rem rgba(25, 135, 84, 0.25) !important;
}

.select2-container .select2-selection--single .select2-selection__rendered {
    line-height: 44px !important;
    padding-right: 15px !important;
    padding-left: 40px !important;
    font-size: 16px !important;
    color: #212529;
}

.select2-container .select2-selection--single .select2-selection__arrow {
    height: 44px !important;
    left: 10px !important;
}

.select2-container .select2-selection--single .select2-selection__placeholder {
    color: #6c757d;
}

/* نتائج البحث */
.select2-dropdown {
    border: 2px solid #198754 !important;
    border-radius: 8px !important;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
    font-size: 16px !important;
}

.select2-results__option {
    padding: 12px 15px !important;
    border-bottom: 1px solid #f8f9fa;
}

.select2-results__option--highlighted {
    background-color: #f0fdf4 !important;
    color: #198754 !important;
}

.select2-results__option--selected {
    background-color: #dcfce7 !important;
    color: #198754 !important;
}

.select2-results__option .fw-bold {
    font-weight: 600 !important;
    color: #198754;
    font-size: 15px;
}

.select2-results__option .text-muted {
    color: #6c757d !important;
    font-size: 13px;
    margin-top: 2px;
}

.select2-results__option .product-price {
    color: #0d6efd !important;
    font-weight: 600;
    font-size: 14px;
}

/* رسالة البحث */
.select2-search--dropdown .select2-search__field {
    font-size: 16px !important;
    padding: 10px 15px;
    border: 2px solid #e9ecef;
    border-radius: 6px;
}

.select2-search--dropdown .select2-search__field:focus {
    border-color: #198754;
    outline: none;
}

.select2-results__message {
    padding: 15px;
    text-align: center;
    color: #6c757d;
}

/* تحسينات الموبايل */
@media (max-width: 768px) {
    .select2-container .select2-selection--single {
        min-height: 52px !important;
    }
    
    .select2-container .select2-selection--single .select2-selection__rendered {
        line-height: 48px !important;
    }
    
    .select2-dropdown {
        font-size: 16px !important;
    }
    
    .select2-results__option {
        min-height: 65px;
        padding: 14px 15px !important;
    }
    
    .select2-search--dropdown .select2-search__field {
        font-size: 16px !important;
        min-height: 48px;
    }
    
    /* تحسين حقول الكمية والسعر للموبايل */
    #item-quantity,
    #item-price,
    #item-discount {
        font-size: 16px !important;
        min-height: 48px;
        padding: 12px 15px;
    }
}
</style>

<script>
$(document).ready(function() {
    console.log('تهيئة Select2 للبحث عن المنتجات في الويزارد...');
    
    // تفعيل Select2 للمنتجات مع AJAX
    $('#product-select').select2({
        theme: 'bootstrap-5',
        language: 'ar',
        placeholder: 'ابحث عن المنتج بالاسم أو الباركود...',
        allowClear: true,
        minimumInputLength: 2,
        dir: 'rtl',
        ajax: {
            url: '{% url "orders:products_search_api" %}',
            dataType: 'json',
            delay: 300,
            data: function (params) {
                return {
                    q: params.term,
                    page: params.page || 1
                };
            },
            processResults: function (data) {
                console.log('نتائج البحث عن المنتجات:', data);
                
                if (!data.results) {
                    return { results: [] };
                }
                
                return {
                    results: data.results.map(item => ({
                        id: item.id,
                        text: item.name,
                        price: item.price,
                        barcode: item.barcode,
                        product: item
                    })),
                    pagination: {
                        more: data.has_more || false
                    }
                };
            },
            cache: true
        },
        templateResult: function(product) {
            if (product.loading) {
                return $('<div><i class="fas fa-spinner fa-spin me-2"></i>جاري البحث...</div>');
            }
            
            if (!product.product) {
                return product.text;
            }
            
            const p = product.product;
            return $(`
                <div class="product-result">
                    <div class="fw-bold">
                        <i class="fas fa-box me-2"></i>${p.name}
                    </div>
                    <div class="text-muted small">
                        ${p.barcode ? '<i class="fas fa-barcode me-2"></i>' + p.barcode : ''}
                    </div>
                    <div class="product-price mt-1">
                        <i class="fas fa-tag me-2"></i>${p.price} {{ currency_symbol }}
                    </div>
                </div>
            `);
        },
        templateSelection: function(product) {
            if (!product.product) {
                return product.text || 'ابحث عن المنتج...';
            }
            return product.product.name;
        },
        language: {
            inputTooShort: function () {
                return 'اكتب حرفين على الأقل للبحث';
            },
            searching: function () {
                return 'جاري البحث...';
            },
            noResults: function () {
                return 'لا توجد نتائج';
            },
            errorLoading: function () {
                return 'حدث خطأ في تحميل النتائج';
            },
            loadingMore: function () {
                return 'جاري تحميل المزيد...';
            }
        }
    });
    
    // تحديث السعر عند اختيار المنتج
    $('#product-select').on('select2:select', function(e) {
        const data = e.params.data;
        console.log('✅ تم اختيار المنتج:', data);
        
        // السماح بالسعر صفر - التحقق من null/undefined فقط
        if (data.price !== null && data.price !== undefined) {
            $('#item-price').val(data.price);
            console.log('✅ تم تحديث السعر:', data.price);
        }
        
        // التركيز على حقل الكمية
        $('#item-quantity').focus().select();
    });
    
    // عند إزالة اختيار المنتج
    $('#product-select').on('select2:clear', function(e) {
        console.log('⚠️ تم إزالة اختيار المنتج');
        $('#item-price').val('');
    });
    
    // معالجة الباركود
    let barcodeBuffer = '';
    let barcodeTimeout;
    
    $('#barcode-input').on('keypress', function(e) {
        if (e.which === 13) { // Enter key
            e.preventDefault();
            searchByBarcode($(this).val());
            $(this).val('');
            barcodeBuffer = '';
        }
    });
    
    // المسح التلقائي للباركود
    $(document).on('keypress', function(e) {
        // تجاهل إذا كان المستخدم يكتب في حقل
        if ($(e.target).is('input, textarea, select')) {
            return;
        }
        
        clearTimeout(barcodeTimeout);
        
        if (e.which === 13) { // Enter من الماسح
            if (barcodeBuffer.length > 0) {
                searchByBarcode(barcodeBuffer);
                $('#barcode-input').val('');
                barcodeBuffer = '';
            }
        } else {
            barcodeBuffer += String.fromCharCode(e.which);
            
            // مسح البفر بعد 100ms (الماسح أسرع من الكتابة اليدوية)
            barcodeTimeout = setTimeout(function() {
                barcodeBuffer = '';
            }, 100);
        }
    });
});

function searchByBarcode(barcode) {
    if (!barcode) return;
    
    fetch(`{% url "orders:products_search_api" %}?barcode=${encodeURIComponent(barcode)}`)
        .then(response => response.json())
        .then(data => {
            if (data.results && data.results.length > 0) {
                const product = data.results[0];
                
                // تحديد المنتج في Select2
                const option = new Option(product.name, product.id, true, true);
                $('#product-select').append(option).trigger('change');
                
                // تحديث السعر - السماح بصفر
                if (product.price !== null && product.price !== undefined) {
                    $('#item-price').val(product.price);
                }
                
                // التركيز على الكمية
                $('#item-quantity').focus().select();
                
                // إظهار رسالة نجاح
                showToast('success', `تم العثور على المنتج: ${product.name}`);
            } else {
                showToast('error', 'لم يتم العثور على منتج بهذا الباركود');
                $('#barcode-input').val(barcode);
            }
        })
        .catch(error => {
            console.error('Error searching for product:', error);
            showToast('error', 'حدث خطأ أثناء البحث عن المنتج');
        });
}

function showToast(type, message) {
    // إنشاء toast بسيط
    const toast = $(`
        <div class="alert alert-${type === 'success' ? 'success' : 'danger'} position-fixed" 
             style="top: 80px; left: 50%; transform: translateX(-50%); z-index: 9999; min-width: 300px;">
            ${message}
        </div>
    `);
    
    $('body').append(toast);
    
    setTimeout(() => {
        toast.fadeOut(() => toast.remove());
    }, 3000);
}

// دالة للحصول على CSRF token من الكوكي
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function addItem() {
    const productId = $('#product-select').val();
    const quantity = $('#item-quantity').val();
    const unitPrice = $('#item-price').val();
    const discountPercentage = $('#item-discount').val();
    
    // التحقق من الحقول - السماح بالسعر صفر
    if (!productId || !quantity || unitPrice === '' || unitPrice === null || unitPrice === undefined) {
        alert('يرجى ملء جميع الحقول المطلوبة');
        return;
    }
    
    // الحصول على CSRF token - أولاً من الكوكي المخصص، ثم من Django template
    const csrfToken = getCookie('elkhawaga_csrftoken') || '{{ csrf_token }}';
    
    fetch('{% url "orders:wizard_add_item" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        credentials: 'same-origin',
        body: JSON.stringify({
            product_id: productId,
            quantity: quantity,
            unit_price: unitPrice,
            discount_percentage: discountPercentage
        })
    })
    .then(response => {
        if (response.status === 401) {
            // إذا انتهت الجلسة
            alert('انتهت الجلسة. سيتم إعادة تحميل الصفحة.');
            window.location.reload();
            return null;
        }
        if (response.status === 403) {
            // خطأ CSRF - تحديث الصفحة
            alert('انتهت صلاحية الصفحة. سيتم تحديثها.');
            window.location.reload();
            return null;
        }
        return response.json();
    })
    .then(data => {
        if (!data) return;
        if (data.success) {
            addItemToTable(data.item);
            updateTotals(data.totals);
            clearForm();
        } else {
            alert(data.message || 'حدث خطأ');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('حدث خطأ أثناء إضافة العنصر. حاول تحديث الصفحة.');
    });
}

// دالة تنسيق الأرقام - إزالة الأصفار الزائدة
function formatNumber(num, decimals = 2) {
    if (num === null || num === undefined) return '0';
    const parsed = parseFloat(num);
    if (isNaN(parsed)) return '0';
    // تنسيق الرقم وإزالة الأصفار الزائدة
    return parsed.toFixed(decimals).replace(/\.?0+$/, '') || '0';
}

function formatPrice(num) {
    if (num === null || num === undefined) return '0.00';
    const parsed = parseFloat(num);
    if (isNaN(parsed)) return '0.00';
    return parsed.toFixed(2);
}

function addItemToTable(item) {
    const noItemsRow = document.getElementById('no-items-row');
    if (noItemsRow) {
        noItemsRow.remove();
    }
    
    const tbody = document.getElementById('items-tbody');
    const row = document.createElement('tr');
    row.dataset.itemId = item.id;
    row.innerHTML = `
        <td>${item.product_name}</td>
        <td>${formatNumber(item.quantity, 3)}</td>
        <td>${formatPrice(item.unit_price)}</td>
        <td>${formatNumber(item.discount_percentage, 2)}%</td>
        <td>${formatPrice(item.total_price)}</td>
        <td class="fw-bold">${formatPrice(item.final_price)}</td>
        <td>
            <button type="button" class="btn btn-sm btn-danger" onclick="removeItem(${item.id})">
                <i class="fas fa-trash"></i>
            </button>
        </td>
    `;
    tbody.appendChild(row);
}

function removeItem(itemId) {
    if (!confirm('هل أنت متأكد من حذف هذا العنصر؟')) {
        return;
    }
    
    fetch(`{% url 'orders:wizard_remove_item' 0 %}`.replace('0', itemId), {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.querySelector(`tr[data-item-id="${itemId}"]`).remove();
            updateTotals(data.totals);
            
            // إذا لم يعد هناك عناصر
            const tbody = document.getElementById('items-tbody');
            if (tbody.children.length === 0) {
                tbody.innerHTML = `
                    <tr id="no-items-row">
                        <td colspan="7" class="text-center text-muted py-4">
                            <i class="fas fa-inbox fa-2x mb-2"></i>
                            <p class="mb-0">لم يتم إضافة عناصر بعد</p>
                        </td>
                    </tr>
                `;
            }
        } else {
            alert(data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('حدث خطأ أثناء حذف العنصر');
    });
}

/**
 * ⚡ تنسيق المبلغ المالي (إزالة الأصفار الزائدة)
 */
function formatCurrency(value) {
    if (value === null || value === undefined || isNaN(value)) {
        return '0';
    }
    
    // التقريب إلى خانتين عشريتين
    let num = parseFloat(value).toFixed(2);
    
    // إزالة الأصفار الزائدة
    num = num.replace(/\.?0+$/, '');
    
    return num;
}

function updateTotals(totals) {
    // التحقق من أن totals كائن صحيح وليس null
    if (!totals || typeof totals !== 'object') {
        console.error('❌ خطأ: totals غير صحيح', totals);
        return;
    }
    
    // تحويل القيم إلى أرقام وإضافة قيم افتراضية
    const subtotal = parseFloat(totals.subtotal) || 0;
    const totalDiscount = parseFloat(totals.total_discount) || 0;
    const finalTotal = parseFloat(totals.final_total) || 0;
    const currencySymbol = '{{ currency_symbol|default:"ج.م" }}';
    
    // ⚡ استخدام formatCurrency لإزالة الأصفار
    document.getElementById('subtotal').textContent = formatCurrency(subtotal) + ' ' + currencySymbol;
    document.getElementById('total-discount').textContent = formatCurrency(totalDiscount) + ' ' + currencySymbol;
    document.getElementById('final-total').textContent = formatCurrency(finalTotal) + ' ' + currencySymbol;
}

function clearForm() {
    $('#product-select').val(null).trigger('change');
    $('#item-quantity').val('1');
    $('#item-price').val('0');
    $('#item-discount').val('0');
}

function completeStep3() {
    // التحقق من وجود عناصر في الطلب
    const itemsTable = document.getElementById('items-tbody');
    const noItemsRow = document.getElementById('no-items-row');
    
    // حساب عدد العناصر (استثناء صف "لا توجد عناصر")
    const itemRows = itemsTable.querySelectorAll('tr:not(#no-items-row)');
    
    if (itemRows.length === 0 || (noItemsRow && noItemsRow.style.display !== 'none')) {
        // تلوين قسم إضافة العناصر باللون الأحمر
        const addItemCard = document.querySelector('.card.mb-4');
        if (addItemCard) {
            addItemCard.classList.add('field-required-error');
            addItemCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        
        showValidationAlert(['إضافة عنصر واحد على الأقل للطلب']);
        return;
    }
    
    fetch('{% url "orders:wizard_complete_step_3" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.href = `/orders/wizard/step/${data.next_step}/`;
        } else {
            if (typeof Swal !== 'undefined') {
                Swal.fire({
                    icon: 'error',
                    title: 'خطأ',
                    text: data.message,
                    confirmButtonText: 'حسناً',
                    confirmButtonColor: '#dc3545'
                });
            } else {
                alert(data.message);
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('حدث خطأ');
    });
}

// سيتم استخدام نظام الباركود من النموذج القديم

// دالة عامة لإضافة المنتج المفحوص للطلب من الباركود
window.addScannedProductToWizard = function(productId, productName, productCode, productPrice) {
    const quantityInput = document.getElementById('scannedProductQuantity');
    const discountSelect = document.getElementById('scannedProductDiscount');
    
    if (!quantityInput) {
        console.error('❌ حقل الكمية غير موجود');
        return;
    }
    
    let quantity;
    let discount = 0;
    
    try {
        const quantityStr = quantityInput.value.trim();
        if (!quantityStr) {
            alert('يرجى إدخال الكمية');
            quantityInput.focus();
            return;
        }
        
        quantity = Number(quantityStr);
        
        if (isNaN(quantity) || !isFinite(quantity)) {
            alert('يرجى إدخال كمية صحيحة');
            quantityInput.focus();
            return;
        }
        
        if (quantity <= 0) {
            alert('يجب أن تكون الكمية أكبر من صفر');
            quantityInput.focus();
            return;
        }
        
        // الحصول على قيمة الخصم
        if (discountSelect) {
            discount = Number(discountSelect.value) || 0;
        }
    } catch (error) {
        console.error('❌ خطأ في معالجة الكمية:', error);
        alert('خطأ في معالجة الكمية');
        return;
    }
    
    // ملء الحقول وإضافة المنتج
    const productSelect = document.getElementById('product-select');
    if (productSelect) {
        // إضافة المنتج للقائمة إذا لم يكن موجوداً
        let optionExists = false;
        for (let option of productSelect.options) {
            if (option.value == productId) {
                optionExists = true;
                break;
            }
        }
        
        if (!optionExists) {
            const newOption = new Option(productName, productId, false, true);
            productSelect.add(newOption);
        } else {
            productSelect.value = productId;
        }
        
        $(productSelect).trigger('change');
    }
    
    // ملء السعر والكمية والخصم - السماح بصفر
    document.getElementById('item-price').value = productPrice !== null && productPrice !== undefined ? productPrice : 0;
    document.getElementById('item-quantity').value = quantity;
    document.getElementById('item-discount').value = discount;
    
    // إضافة العنصر
    addItem();
    
    // إغلاق الـ modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('wizardBarcodeScannerModal'));
    if (modal) {
        modal.hide();
    }
    
    // رسالة نجاح
    const scanStatus = document.getElementById('wizardScanStatus');
    if (scanStatus) {
        scanStatus.innerHTML = `
            <div class="alert alert-success border-0 shadow-sm text-center" style="border-radius: 15px;">
                <i class="fas fa-check-circle fa-3x mb-3" style="color: #28a745;"></i>
                <h5 class="fw-bold">تمت الإضافة بنجاح!</h5>
                <p class="mb-3">تم إضافة <strong>${productName}</strong> بكمية <strong>${quantity}</strong>${discount > 0 ? ` بخصم <strong>${discount}%</strong>` : ''}</p>
            </div>
        `;
        
        // تنظيف الرسالة بعد 3 ثوان
        setTimeout(() => {
            scanStatus.innerHTML = '';
        }, 3000);
    }
    
    console.log('✅ تم إضافة المنتج للطلب:', {productId, productName, quantity, productPrice, discount});
};

</script>

<!-- Modal الباركود للويزارد -->
{% include 'includes/wizard_barcode_scanner_modal.html' %}

{% endblock %}
