{% extends 'orders/wizard/base_wizard.html' %}
{% load static %}

{% block wizard_content %}

<!-- Edit History Section -->
{% include 'orders/wizard/partials/edit_history.html' with draft=draft %}

<!-- Ø±Ø³Ø§Ù„Ø© ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ -->
{% if editing_mode and editing_order %}
<div class="alert alert-info alert-dismissible fade show mb-4" role="alert">
    <i class="fas fa-edit me-2"></i>
    <strong>ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„:</strong> 
    Ø£Ù†Øª Ø§Ù„Ø¢Ù† ØªÙ‚ÙˆÙ… Ø¨ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ 
    <a href="{% url 'orders:order_detail_by_number' editing_order.order_number %}" target="_blank" class="alert-link">
        #{{ editing_order.order_number }}
    </a>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endif %}

<form method="post" id="step1-form" novalidate>
    {% csrf_token %}
    
    <div class="row">
        <div class="col-md-6">
            <!-- Customer Search with Select2 -->
            <div class="mb-4">
                <label for="customer_search_select" class="form-label fw-bold">
                    <i class="fas fa-user me-2"></i>Ø§Ù„Ø¹Ù…ÙŠÙ„
                    <span class="text-danger">*</span>
                </label>
                
                <!-- Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø« Ø¨Ù€ Select2 -->
                <select id="customer_search_select" class="form-select" style="width: 100%;">
                    <option value="">-- Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„ --</option>
                </select>
                
                <!-- Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ù…Ø®ÙÙŠ Ù„Ù„Ù‚ÙŠÙ…Ø© -->
                {{ form.customer }}
                
                {% if form.customer.errors %}
                    <div class="text-danger mt-1">
                        {{ form.customer.errors }}
                    </div>
                {% endif %}
                <div class="form-text">
                    <i class="fas fa-info-circle me-1"></i>
                    Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù„Ù„Ø¨Ø­Ø« (Ø­Ø±ÙÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)
                </div>
            </div>
            
            <!-- Branch -->
            <div class="mb-4">
                <label for="{{ form.branch.id_for_label }}" class="form-label fw-bold">
                    <i class="fas fa-building me-2"></i>Ø§Ù„ÙØ±Ø¹
                    <span class="text-danger">*</span>
                </label>
                {{ form.branch }}
                {% if form.branch.errors %}
                    <div class="text-danger mt-1">
                        {{ form.branch.errors }}
                    </div>
                {% endif %}
            </div>
            
            <!-- Salesperson -->
            <div class="mb-4">
                <label for="{{ form.salesperson.id_for_label }}" class="form-label fw-bold">
                    <i class="fas fa-user-tie me-2"></i>Ø§Ù„Ø¨Ø§Ø¦Ø¹
                    <span class="text-danger">*</span>
                </label>
                {{ form.salesperson }}
                {% if form.salesperson.errors %}
                    <div class="text-danger mt-1">
                        {{ form.salesperson.errors }}
                    </div>
                {% endif %}
            </div>
        </div>
        
        <div class="col-md-6">
            <!-- Status -->
            <div class="mb-4">
                <label for="{{ form.status.id_for_label }}" class="form-label fw-bold">
                    <i class="fas fa-crown me-2"></i>ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ù…ÙŠÙ„
                </label>
                {{ form.status }}
                {% if form.status.errors %}
                    <div class="text-danger mt-1">
                        {{ form.status.errors }}
                    </div>
                {% endif %}
                <div class="form-text">
                    <i class="fas fa-info-circle me-1"></i>
                    Ø­Ø¯Ø¯ Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„ VIP Ø£Ù… Ø¹Ø§Ø¯ÙŠ
                </div>
            </div>
            
            <!-- Notes -->
            <div class="mb-4">
                <label for="{{ form.notes.id_for_label }}" class="form-label fw-bold">
                    <i class="fas fa-sticky-note me-2"></i>Ù…Ù„Ø§Ø­Ø¸Ø§Øª
                </label>
                {{ form.notes }}
                {% if form.notes.errors %}
                    <div class="text-danger mt-1">
                        {{ form.notes.errors }}
                    </div>
                {% endif %}
                <div class="form-text">
                    <i class="fas fa-info-circle me-1"></i>
                    ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù‡Ù†Ø§
                </div>
            </div>
        </div>
    </div>
    
    <!-- Actions -->
    <div class="wizard-actions">
        <div>
            <a href="{% url 'orders:wizard_cancel' %}" class="btn btn-wizard btn-wizard-danger">
                <i class="fas fa-times me-2"></i>Ø¥Ù„ØºØ§Ø¡
            </a>
        </div>
        <div>
            <button type="submit" class="btn btn-wizard btn-wizard-primary">
                <i class="fas fa-arrow-left me-2"></i>Ø§Ù„ØªØ§Ù„ÙŠ
            </button>
        </div>
    </div>
</form>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.rtl.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<style>
/* ===== ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ù„Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ù„Ø²Ø§Ù…ÙŠØ© ===== */

/* Select2 Ù…Ø¹ Ø®Ø·Ø£ */
.select2-container--error .select2-selection--single,
.select2-container.has-error .select2-selection--single {
    border: 2px solid #dc3545 !important;
    background-color: #fff5f5 !important;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
    animation: shake 0.5s ease-in-out;
}

/* Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø®Ø·Ø£ */
.field-error-icon {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: #dc3545;
    font-size: 1.2rem;
    z-index: 10;
    display: block !important;
}

/* Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ */
.field-error-message {
    color: #dc3545;
    font-size: 0.9rem;
    margin-top: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 500;
}

/* ØªØ£Ø«ÙŠØ± Ø§Ù„Ø§Ù‡ØªØ²Ø§Ø² */
@keyframes shake {
    0%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
    20%, 40%, 60%, 80% { transform: translateX(5px); }
}

/* Ø­Ù‚ÙˆÙ„ select Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© Ù…Ø¹ Ø®Ø·Ø£ */
select.field-required-error,
.form-select.field-required-error {
    border: 2px solid #dc3545 !important;
    background-color: #fff5f5 !important;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
    animation: shake 0.5s ease-in-out;
}

/* ===== ØªØ­Ø³ÙŠÙ†Ø§Øª Select2 Ù„Ù„Ø¹Ù…Ù„Ø§Ø¡ ===== */
.select2-container {
    width: 100% !important;
}

.select2-container .select2-selection--single {
    height: 48px !important;
    font-size: 16px !important;
    border: 2px solid #e9ecef !important;
    border-radius: 8px !important;
    transition: all 0.3s ease;
}

.select2-container--open .select2-selection--single {
    border-color: #198754 !important;
    box-shadow: 0 0 0 0.2rem rgba(25, 135, 84, 0.25) !important;
}

.select2-container .select2-selection--single .select2-selection__rendered {
    line-height: 44px !important;
    padding-right: 15px !important;
    padding-left: 40px !important;
    font-size: 16px !important;
    color: #212529;
}

.select2-container .select2-selection--single .select2-selection__arrow {
    height: 44px !important;
    left: 10px !important;
}

.select2-container .select2-selection--single .select2-selection__placeholder {
    color: #6c757d;
}

/* Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« */
.select2-dropdown {
    border: 2px solid #198754 !important;
    border-radius: 8px !important;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
    font-size: 16px !important;
}

.select2-results__option {
    padding: 12px 15px !important;
    border-bottom: 1px solid #f8f9fa;
}

.select2-results__option--highlighted {
    background-color: #f0fdf4 !important;
    color: #198754 !important;
}

.select2-results__option--selected {
    background-color: #dcfce7 !important;
    color: #198754 !important;
}

.select2-results__option .fw-bold {
    font-weight: 600 !important;
    color: #198754;
    font-size: 15px;
}

.select2-results__option .text-muted {
    color: #6c757d !important;
    font-size: 13px;
    margin-top: 2px;
}

/* Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªØ­Ù…ÙŠÙ„ */
.select2-search--dropdown .select2-search__field {
    font-size: 16px !important;
    padding: 10px 15px;
    border: 2px solid #e9ecef;
    border-radius: 6px;
}

.select2-search--dropdown .select2-search__field:focus {
    border-color: #198754;
    outline: none;
}

.select2-results__message {
    padding: 15px;
    text-align: center;
    color: #6c757d;
}

/* Ø¥Ø®ÙØ§Ø¡ select Ø§Ù„Ø£ØµÙ„ÙŠ */
#{{ form.customer.id_for_label }} {
    display: none !important;
}

/* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© (Ø§Ù„ÙØ±Ø¹ØŒ Ø§Ù„Ø¨Ø§Ø¦Ø¹ØŒ Ø§Ù„Ø­Ø§Ù„Ø©) */
.form-select {
    font-size: 16px !important;
    min-height: 48px;
    padding: 12px 40px 12px 15px;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: left 12px center;
    background-size: 16px;
    transition: all 0.3s ease;
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
}

.form-select:focus {
    border-color: #198754;
    outline: none;
    box-shadow: 0 0 0 0.2rem rgba(25, 135, 84, 0.25);
}

/* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
@media (max-width: 768px) {
    .select2-container .select2-selection--single {
        min-height: 52px !important;
    }
    
    .select2-container .select2-selection--single .select2-selection__rendered {
        line-height: 48px !important;
    }
    
    .select2-dropdown {
        font-size: 16px !important;
    }
    
    .select2-results__option {
        min-height: 60px;
        padding: 14px 15px !important;
    }
    
    .select2-search--dropdown .select2-search__field {
        font-size: 16px !important;
        min-height: 48px;
    }
    
    /* Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
    .form-select {
        min-height: 52px !important;
        font-size: 16px !important;
    }
}
</style>

<script>
$(document).ready(function() {
    console.log('ØªÙ‡ÙŠØ¦Ø© Select2 Ù„Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙÙŠ Ø§Ù„ÙˆÙŠØ²Ø§Ø±Ø¯...');
    
    // ØªÙ‡ÙŠØ¦Ø© Select2 Ù„Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ù…Ø¹ AJAX
    const searchSelect = $('#customer_search_select');
    
    searchSelect.select2({
        theme: 'bootstrap-5',
        language: 'ar',
        placeholder: 'Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù‡Ø§ØªÙ...',
        allowClear: true,
        minimumInputLength: 2,
        dir: 'rtl',
        ajax: {
            url: '/customers/api/customers/',
            dataType: 'json',
            delay: 300,
            data: function (params) {
                return {
                    q: params.term,
                    page: params.page || 1
                };
            },
            processResults: function (data, params) {
                console.log('Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«:', data);
                
                if (data.error || !data.results) {
                    return { results: [] };
                }
                
                return {
                    results: data.results.map(function(customer) {
                        return {
                            id: customer.id,
                            text: customer.name + ' - ' + customer.phone,
                            customer: customer
                        };
                    }),
                    pagination: {
                        more: data.pagination && data.pagination.more
                    }
                };
            },
            cache: true
        },
        templateResult: function(customer) {
            if (customer.loading) {
                return $('<div><i class="fas fa-spinner fa-spin me-2"></i>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...</div>');
            }
            
            if (!customer.customer) {
                return customer.text;
            }
            
            const c = customer.customer;
            return $(`
                <div class="customer-result">
                    <div class="fw-bold">
                        <i class="fas fa-user me-2"></i>${c.name}
                    </div>
                    <div class="text-muted small">
                        <i class="fas fa-phone me-2"></i>${c.phone}
                        ${c.email ? ' - <i class="fas fa-envelope me-1"></i>' + c.email : ''}
                    </div>
                </div>
            `);
        },
        templateSelection: function(customer) {
            if (!customer.customer) {
                return customer.text || 'Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„...';
            }
            return customer.customer.name + ' - ' + customer.customer.phone;
        },
        language: {
            inputTooShort: function () {
                return 'Ø§ÙƒØªØ¨ Ø­Ø±ÙÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ø¨Ø­Ø«';
            },
            searching: function () {
                return 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...';
            },
            noResults: function () {
                return 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬';
            },
            errorLoading: function () {
                return 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬';
            }
        }
    });

    // Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø¹Ù…ÙŠÙ„
    searchSelect.on('select2:select', function (e) {
        const data = e.params.data;
        console.log('âœ… ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„:', data);

        const customerId = data.id || (data.customer && data.customer.id);
        const customerName = data.text || (data.customer && (data.customer.name + ' - ' + data.customer.phone));

        if (customerId) {
            const customerField = $('#{{ form.customer.id_for_label }}');
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø®ÙŠØ§Ø± ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
            const optionExists = customerField.find('option[value="' + customerId + '"]').length > 0;
            
            if (!optionExists) {
                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯
                const newOption = new Option(customerName, customerId, true, true);
                customerField.append(newOption);
                console.log('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø®ÙŠØ§Ø± Ø¬Ø¯ÙŠØ¯:', customerId);
            }
            
            // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù‚ÙŠÙ…Ø©
            customerField.val(customerId);
            customerField.removeClass('is-invalid').addClass('is-valid');
            customerField.trigger('change');
            
            console.log('âœ… ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙÙŠ Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ù…Ø®ÙÙŠ:', customerField.val());
        }
    });

    // Ø¹Ù†Ø¯ Ø¥Ø²Ø§Ù„Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„
    searchSelect.on('select2:clear', function (e) {
        console.log('âš ï¸ ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„');
        
        const customerField = $('#{{ form.customer.id_for_label }}');
        customerField.val('');
        customerField.removeClass('is-valid').addClass('is-invalid');
        customerField.trigger('change');
    });
    
    // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹ (ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø£Ùˆ Ø¹Ù†Ø¯ Ø§Ù„Ù‚Ø¯ÙˆÙ… Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„)
    {% if selected_customer %}
    // Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…Ø­Ø¯Ø¯ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
    const preSelectedCustomer = {
        id: '{{ selected_customer.id }}',
        name: '{{ selected_customer.name|escapejs }}',
        phone: '{{ selected_customer.phone|escapejs }}'
    };
    const displayText = preSelectedCustomer.name + ' - ' + preSelectedCustomer.phone;
    const preOption = new Option(displayText, preSelectedCustomer.id, true, true);
    searchSelect.append(preOption).trigger('change');
    
    // ØªØ¹ÙŠÙŠÙ† Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ù…Ø®ÙÙŠ
    const hiddenField = $('#{{ form.customer.id_for_label }}');
    hiddenField.val(preSelectedCustomer.id);
    console.log('âœ… ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø¯Ø¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±:', preSelectedCustomer.id, preSelectedCustomer.name);
    
    // âš¡ ØªØ¹Ø·ÙŠÙ„ Select2 Ù„Ù…Ù†Ø¹ Ø§Ù„ØªØºÙŠÙŠØ±
    searchSelect.prop('disabled', true);
    searchSelect.select2('destroy');
    searchSelect.addClass('bg-light');
    
    // Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© ØªØ­Ø°ÙŠØ±
    const customerWrapper = searchSelect.closest('.mb-4');
    if (customerWrapper.length && !customerWrapper.find('.customer-locked-warning').length) {
        const warningDiv = $(`
            <div class="customer-locked-warning alert alert-warning mt-2 mb-0">
                <i class="bi bi-lock-fill me-2"></i>
                <strong>ØªÙ†Ø¨ÙŠÙ‡:</strong> Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ± Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ø¹Ø¯ ØªØ­Ø¯ÙŠØ¯Ù‡.
                Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ Ù…Ø±ØªØ¨Ø· Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ø£ØµÙ„ÙŠ.
                Ø§Ø­Ø°Ù Ø§Ù„Ù…Ø³ÙˆØ¯Ø© ÙˆØ£Ù†Ø´Ø¦ Ø·Ù„Ø¨Ø§Ù‹ Ø¬Ø¯ÙŠØ¯Ø§Ù‹ Ù„ØªØºÙŠÙŠØ± Ø§Ù„Ø¹Ù…ÙŠÙ„.
            </div>
        `);
        customerWrapper.append(warningDiv);
    }
    
    console.log('ğŸ”’ ØªÙ… ØªØ¹Ø·ÙŠÙ„ Ø­Ù‚Ù„ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù„Ù…Ù†Ø¹ Ø§Ù„ØªØºÙŠÙŠØ±');
    {% else %}
    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ù…Ù† Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ù…Ø®ÙÙŠ
    const customerField = $('#{{ form.customer.id_for_label }}');
    const selectedValue = customerField.val();
    
    if (selectedValue) {
        const selectedText = customerField.find('option:selected').text();
        const newOption = new Option(selectedText, selectedValue, true, true);
        searchSelect.append(newOption).trigger('change');
        console.log('âœ… ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹:', selectedValue);
    }
    {% endif %}
    
    // Ø§Ù„ÙØ±Ø¹ ÙˆØ§Ù„Ø¨Ø§Ø¦Ø¹: Ù‚ÙˆØ§Ø¦Ù… Ù…Ù†Ø³Ø¯Ù„Ø© Ø¹Ø§Ø¯ÙŠØ© Ø¨Ø¯ÙˆÙ† Select2 (Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ ÙˆØ§Ù„Ø¯ÙŠØ³ÙƒØªÙˆØ¨)
    const branchField = document.getElementById('{{ form.branch.id_for_label }}');
    const salespersonField = document.getElementById('{{ form.salesperson.id_for_label }}');
    
    if (branchField) {
        branchField.classList.add('form-select');
    }
    
    if (salespersonField) {
        salespersonField.classList.add('form-select');
    }
    
    console.log('âœ… ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© Ù„Ù„ÙØ±Ø¹ ÙˆØ§Ù„Ø¨Ø§Ø¦Ø¹');
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø§Ø¦Ø¹ÙŠÙ† Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„ÙØ±Ø¹
    if (branchField) {
        branchField.addEventListener('change', function() {
            const branchId = this.value;
            const salespersonSelect = document.getElementById('{{ form.salesperson.id_for_label }}');
            
            if (!branchId) {
                salespersonSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¨Ø§Ø¦Ø¹...</option>';
                return;
            }
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„
            salespersonSelect.innerHTML = '<option value="">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</option>';
            salespersonSelect.disabled = true;
            
            // Ø·Ù„Ø¨ Ø§Ù„Ø¨Ø§Ø¦Ø¹ÙŠÙ† Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…
            fetch(`/orders/api/salespersons/?branch=${branchId}`)
                .then(response => response.json())
                .then(data => {
                    salespersonSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¨Ø§Ø¦Ø¹...</option>';
                    if (data.results) {
                        data.results.forEach(sp => {
                            const option = document.createElement('option');
                            option.value = sp.id;
                            option.textContent = sp.name;
                            salespersonSelect.appendChild(option);
                        });
                    }
                    salespersonSelect.disabled = false;
                })
                .catch(error => {
                    console.error('Error loading salespersons:', error);
                    salespersonSelect.innerHTML = '<option value="">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</option>';
                    salespersonSelect.disabled = false;
                });
        });
    }
});

// Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ù„Ø²Ø§Ù…ÙŠØ©
document.getElementById('step1-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    console.log('ğŸ“ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬...');
    
    // Ø¥Ø²Ø§Ù„Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
    clearAllFieldErrors(this);
    
    const missingFields = [];
    let hasErrors = false;
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„
    const customerField = document.getElementById('{{ form.customer.id_for_label }}');
    const customerSearchSelect = document.getElementById('customer_search_select');
    
    console.log('ğŸ” Ø­Ù‚Ù„ Ø§Ù„Ø¹Ù…ÙŠÙ„:', customerField?.value);
    
    if (!customerField || !customerField.value) {
        hasErrors = true;
        missingFields.push('Ø§Ù„Ø¹Ù…ÙŠÙ„');
        
        console.log('âŒ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…Ø·Ù„ÙˆØ¨ - ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø®Ø·Ø£');
        
        // ØªÙ„ÙˆÙŠÙ† Select2 Ù…Ø¨Ø§Ø´Ø±Ø©
        const select2Container = document.querySelector('#customer_search_select + .select2-container, .select2-container');
        if (select2Container) {
            select2Container.classList.add('select2-container--error');
            select2Container.style.border = '2px solid #dc3545';
            select2Container.style.borderRadius = '8px';
            console.log('âœ… ØªÙ… ØªÙ„ÙˆÙŠÙ† Select2');
        }
        
        // Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
        const customerWrapper = customerSearchSelect?.closest('.mb-4');
        if (customerWrapper && !customerWrapper.querySelector('.field-error-message')) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'field-error-message';
            errorDiv.innerHTML = '<i class="fas fa-times-circle text-danger"></i> ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„';
            customerWrapper.appendChild(errorDiv);
        }
        
        // Ø¥Ø¶Ø§ÙØ© Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø®Ø·Ø£
        if (customerWrapper && !customerWrapper.querySelector('.field-error-icon')) {
            const errorIcon = document.createElement('span');
            errorIcon.className = 'field-error-icon';
            errorIcon.style.display = 'block';
            errorIcon.innerHTML = '<i class="fas fa-times-circle"></i>';
            customerWrapper.appendChild(errorIcon);
        }
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙØ±Ø¹
    const branchField = document.getElementById('{{ form.branch.id_for_label }}');
    console.log('ğŸ” Ø­Ù‚Ù„ Ø§Ù„ÙØ±Ø¹:', branchField?.value);
    
    if (!branchField || !branchField.value) {
        hasErrors = true;
        missingFields.push('Ø§Ù„ÙØ±Ø¹');
        console.log('âŒ Ø§Ù„ÙØ±Ø¹ Ù…Ø·Ù„ÙˆØ¨');
        markFieldAsError(branchField, 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØ±Ø¹');
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨Ø§Ø¦Ø¹
    const salespersonField = document.getElementById('{{ form.salesperson.id_for_label }}');
    console.log('ğŸ” Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø§Ø¦Ø¹:', salespersonField?.value);
    
    if (!salespersonField || !salespersonField.value) {
        hasErrors = true;
        missingFields.push('Ø§Ù„Ø¨Ø§Ø¦Ø¹');
        console.log('âŒ Ø§Ù„Ø¨Ø§Ø¦Ø¹ Ù…Ø·Ù„ÙˆØ¨');
        markFieldAsError(salespersonField, 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¨Ø§Ø¦Ø¹');
    }
    
    // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‡Ù†Ø§Ùƒ Ø£Ø®Ø·Ø§Ø¡ØŒ Ø¹Ø±Ø¶ ØªÙ†Ø¨ÙŠÙ‡
    if (hasErrors) {
        console.log('âš ï¸ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø©:', missingFields);
        showValidationAlert(missingFields);
        
        // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ù„Ø£Ø¹Ù„Ù‰
        window.scrollTo({ top: 0, behavior: 'smooth' });
        return;
    }
    
    console.log('âœ… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ ØµØ­ÙŠØ­Ø© - Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬');
    submitWizardStep(this);
});
</script>
{% endblock %}
