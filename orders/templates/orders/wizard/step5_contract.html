{% extends 'orders/wizard/base_wizard.html' %}
{% load static %}

{% block wizard_content %}
<style>
/* منع Bootstrap من إخفاء شريط تمرير الصفحة */
body.modal-open {
    overflow: auto !important;
    padding-right: 0 !important;
}

/* ضمان عمل التمرير في النافذة المنبثقة */
#addCurtainModal .modal-dialog-scrollable .modal-body {
    max-height: calc(100vh - 180px) !important;
    overflow-y: auto !important;
    overflow-x: hidden;
    -webkit-overflow-scrolling: touch;
}

#addCurtainModal .modal-content {
    max-height: 95vh !important;
    overflow: hidden;
}

/* ضمان ظهور النافذة في وسط الشاشة */
#addCurtainModal .modal-dialog {
    margin: 0.5rem auto !important;
    max-height: 98vh !important;
}

#addCurtainModal.show .modal-dialog {
    transform: none;
}

/* تحسين عرض المحتوى في الشاشات الصغيرة */
@media (max-height: 768px) {
    #addCurtainModal .modal-dialog-scrollable .modal-body {
        max-height: calc(100vh - 120px) !important;
    }
}

/* شريط التمرير المخصص */
#addCurtainModal .modal-body::-webkit-scrollbar {
    width: 10px;
}

#addCurtainModal .modal-body::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 5px;
}

#addCurtainModal .modal-body::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 5px;
}

#addCurtainModal .modal-body::-webkit-scrollbar-thumb:hover {
    background: #555;
}

/* ===== تنسيقات الحقول الخاطئة ===== */
.field-required-error {
    border: 2px solid #dc3545 !important;
    background-color: #fff5f5 !important;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
    animation: shake 0.5s ease-in-out;
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
    20%, 40%, 60%, 80% { transform: translateX(5px); }
}

.field-error-message {
    color: #dc3545;
    font-size: 0.85rem;
    margin-top: 0.25rem;
}
</style>

<div class="alert alert-info mb-4">
    <i class="fas fa-info-circle me-2"></i>
    أضف تفاصيل الستائر للعقد الإلكتروني.
    <br>
    <small class="text-muted">هذه الخطوة اختيارية، يمكنك تخطيها والانتقال للمراجعة النهائية.</small>
</div>

<!-- Electronic Contract Section (Always Visible) -->
<div id="electronicContractSection">
    <!-- Curtains List -->
    <div id="curtains-list" class="mb-4">
        {% for curtain in curtains %}
        <div class="card mb-3 curtain-card" data-curtain-id="{{ curtain.id }}">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h6 class="mb-0">
                    <i class="fas fa-th me-2"></i>{{ curtain.room_name }}
                </h6>
                <div>
                    <button type="button" class="btn btn-sm btn-primary me-2" onclick="editCurtain({{ curtain.id }})">
                        <i class="fas fa-edit"></i> تعديل
                    </button>
                    <button type="button" class="btn btn-sm btn-danger" onclick="removeCurtain({{ curtain.id }})">
                        <i class="fas fa-trash"></i> حذف
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-3">
                        <strong>المقاسات:</strong> {{ curtain.width }}م × {{ curtain.height }}م
                    </div>
                    <div class="col-md-3">
                        <strong>نوع التركيب:</strong> 
                        {% if curtain.installation_type %}
                            {{ curtain.get_installation_type_display }}
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </div>
                    <div class="col-md-3">
                        <strong>الأقمشة:</strong> {{ curtain.fabrics.count }}
                    </div>
                    <div class="col-md-3">
                        <strong>الإكسسوارات:</strong> {{ curtain.accessories.count }}
                    </div>
                </div>
                
                {% if curtain.curtain_box_width or curtain.curtain_box_depth %}
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="alert alert-info mb-0 py-2">
                            <i class="fas fa-ruler-combined me-2"></i>
                            <strong>مقاسات بيت الستارة:</strong>
                            {% if curtain.curtain_box_width %}العرض: {{ curtain.curtain_box_width }}م{% endif %}
                            {% if curtain.curtain_box_width and curtain.curtain_box_depth %} - {% endif %}
                            {% if curtain.curtain_box_depth %}العمق: {{ curtain.curtain_box_depth }}م{% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}
                
                {% if curtain.fabrics.exists %}
                <div class="mt-3">
                    <strong class="text-primary">
                        <i class="fas fa-cut me-1"></i>الأقمشة:
                    </strong>
                    <div class="row g-2 mt-1">
                        {% for fabric in curtain.fabrics.all %}
                        <div class="col-md-6">
                            <div class="card border-{% if fabric.fabric_type == 'light' %}warning{% elif fabric.fabric_type == 'heavy' %}danger{% elif fabric.fabric_type == 'blackout' %}dark{% else %}secondary{% endif %}">
                                <div class="card-body py-2 px-3">
                                    <div class="d-flex align-items-center">
                                        <span class="badge bg-{% if fabric.fabric_type == 'light' %}warning{% elif fabric.fabric_type == 'heavy' %}danger{% elif fabric.fabric_type == 'blackout' %}dark{% else %}secondary{% endif %} me-2">
                                            {{ fabric.get_fabric_type_display }}
                                        </span>
                                        <div class="flex-grow-1">
                                            <div class="fw-bold">
                                                {% if fabric.order_item %}
                                                    {{ fabric.order_item.product.name }}
                                                {% else %}
                                                    {{ fabric.fabric_name|default:"غير محدد" }}
                                                {% endif %}
                                            </div>
                                            <small class="text-muted">
                                                {% if 'حزام' in fabric.fabric_name or fabric.meters == 0 %}
                                                    {{ fabric.pieces }} قطعة
                                                {% else %}
                                                    {{ fabric.meters }}م × {{ fabric.pieces }} قطعة
                                                {% endif %}
                                                {% if fabric.tailoring_type %}
                                                    - {{ fabric.get_tailoring_type_display }}
                                                {% endif %}
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                {% if curtain.accessories.exists %}
                <div class="mt-3">
                    <strong class="text-success">
                        <i class="fas fa-puzzle-piece me-1"></i>الإكسسوارات:
                    </strong>
                    <div class="row g-2 mt-1">
                        {% for accessory in curtain.accessories.all %}
                        <div class="col-md-6">
                            <div class="card border-success">
                                <div class="card-body py-2 px-3">
                                    <div class="fw-bold">
                                        {{ accessory.accessory_name }}
                                        {% if accessory.accessory_type %}
                                            <span class="badge bg-warning text-dark ms-1">{{ accessory.accessory_type }}</span>
                                        {% endif %}
                                    </div>
                                    <small class="text-muted">
                                        العدد: {{ accessory.count }} قطعة
                                        {% if accessory.size and accessory.size > 0 %}
                                            × المقاس: {{ accessory.size|stringformat:"g" }}م = {{ accessory.quantity|stringformat:"g" }}م
                                        {% endif %}
                                        {% if accessory.color %}
                                            - اللون: {{ accessory.color }}
                                        {% endif %}
                                    </small>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                {% if curtain.notes %}
                <div class="mt-3">
                    <div class="alert alert-warning mb-0">
                        <strong>
                            <i class="fas fa-sticky-note me-1"></i>ملاحظات:
                        </strong>
                        <div class="mt-1">{{ curtain.notes }}</div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        {% empty %}
        <div class="text-center text-muted py-5" id="no-curtains-message">
            <i class="fas fa-inbox fa-3x mb-3"></i>
            <p class="mb-0">لم يتم إضافة ستائر بعد</p>
        </div>
        {% endfor %}
    </div>

    <!-- Add Curtain Button -->
    <div class="text-center mb-4">
        <button type="button" class="btn btn-success btn-lg" data-bs-toggle="modal" data-bs-target="#addCurtainModal">
            <i class="fas fa-plus me-2"></i>إضافة ستارة جديدة
        </button>
    </div>
</div>

<!-- PDF Contract Section -->

<!-- Actions -->
<div class="wizard-actions">
    <div>
        <a href="{% url 'orders:wizard_cancel' %}" class="btn btn-wizard btn-wizard-danger me-2">
            <i class="fas fa-times me-2"></i>إلغاء
        </a>
        <a href="{% url 'orders:wizard_step' step=4 %}" class="btn btn-wizard btn-wizard-secondary">
            <i class="fas fa-arrow-right me-2"></i>السابق
        </a>
    </div>
    <div>
        <button type="button" class="btn btn-wizard btn-wizard-primary" onclick="proceedToNextStep()">
            <i class="fas fa-arrow-left me-2"></i>التالي
        </button>
    </div>
</div>

<!-- Modal: Add Curtain -->
<div class="modal fade" id="addCurtainModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>إضافة ستارة جديدة
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Step 1: Basic Curtain Info -->
                <div id="curtainBasicInfo">
                    <h6 class="text-primary mb-3">
                        <i class="fas fa-info-circle me-2"></i>المعلومات الأساسية
                    </h6>
                    <div class="row g-3 mb-3">
                        <div class="col-md-4">
                            <label class="form-label fw-bold">اسم الغرفة <span class="text-danger">*</span></label>
                            <input type="text" id="curtain-room-name" class="form-control" 
                                   placeholder="مثال: غرفة النوم الرئيسية">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold">العرض (متر) <span class="text-danger">*</span></label>
                            <input type="number" id="curtain-width" class="form-control" 
                                   min="0.01" step="0.01" placeholder="3.5">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold">الطول (متر) <span class="text-danger">*</span></label>
                            <input type="number" id="curtain-height" class="form-control" 
                                   min="0.01" step="0.01" placeholder="2.8">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold">نوع التركيب <span class="text-danger">*</span></label>
                            <select id="curtain-installation-type" class="form-select" onchange="toggleCurtainBoxFields()">
                                <option value="">-- اختر نوع التركيب --</option>
                                {% for option in installation_options %}
                                <option value="{{ option.value }}" 
                                        data-curtain-box="{{ option.extra_data.requires_curtain_box|default:'false' }}">
                                    {{ option.display_name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <!-- Curtain Box Fields (shown only for curtain_box_concrete and curtain_box_gypsum) -->
                    <div id="curtainBoxFields" class="row g-3 mt-2" style="display: none;">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">عرض بيت الستارة (سم) <span class="text-danger">*</span></label>
                            <input type="number" id="curtain-box-width" class="form-control" 
                                   min="1" step="1" placeholder="مثال: 25">
                            <small class="text-muted">أدخل عرض بيت الستارة بالسنتيمتر</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">عمق بيت الستارة (سم) <span class="text-danger">*</span></label>
                            <input type="number" id="curtain-box-depth" class="form-control" 
                                   min="1" step="1" placeholder="مثال: 30">
                            <small class="text-muted">أدخل عمق بيت الستارة بالسنتيمتر</small>
                        </div>
                    </div>
                    
                    <button type="button" class="btn btn-primary mt-3" onclick="showFabricsSection()">
                        <i class="fas fa-arrow-left me-2"></i>التالي - إضافة الأقمشة
                    </button>
                </div>
                
                <!-- Step 2: Fabrics Section (Hidden initially) -->
                <div id="fabricsSection" style="display: none;">
                    <div class="alert alert-info">
                        <i class="fas fa-check-circle me-2"></i>
                        <strong>الستارة:</strong> <span id="summary-room-name"></span> - 
                        <span id="summary-width"></span>م × <span id="summary-height"></span>م
                        <button type="button" class="btn btn-sm btn-link" onclick="editBasicInfo()">
                            <i class="fas fa-edit"></i> تعديل
                        </button>
                    </div>
                    
                    <h6 class="text-primary mb-3">
                        <i class="fas fa-cut me-2"></i>الأقمشة
                    </h6>
                    
                    <!-- Fabrics List -->
                    <div id="fabricsList" class="mb-3"></div>
                    
                    <!-- Add Fabric Form -->
                    <div class="card bg-light mb-3">
                        <div class="card-body">
                            <h6 class="card-title">إضافة قماش جديد</h6>
                            <div class="row g-2">
                                <div class="col-md-3">
                                    <label class="form-label">نوع القماش <span class="text-danger">*</span></label>
                                    <select id="fabric-type" class="form-select">
                                        <option value="">اختر النوع</option>
                                        <option value="light">خفيف</option>
                                        <option value="heavy">ثقيل</option>
                                        <option value="blackout">بلاك أوت</option>
                                        <option value="additional">إضافي</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">اسم القماش <span class="text-danger">*</span></label>
                                    <select id="fabric-name" class="form-select" onchange="updateFabricQuantityInfo(this)">
                                        <option value="">اختر القماش من المرجع</option>
                                        {% for item in draft.items.all %}
                                        <option value="{{ item.id }}" data-available="{{ item.quantity|stringformat:'f' }}" data-name="{{ item.product.name }}">
                                            {{ item.product.name }} - متوفر: <span class="available-qty-{{ item.id }}">{{ item.quantity|floatformat:"-3" }}</span> متر
                                        </option>
                                        {% endfor %}
                                    </select>
                                    <small class="text-muted mt-1" id="fabric-qty-hint" style="display:none;">
                                        <i class="fas fa-info-circle"></i> المتبقي للاختيار: <span id="remaining-qty">0</span> متر
                                    </small>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">الكمية (متر) <span class="text-danger">*</span></label>
                                    <input type="number" id="fabric-meters" class="form-control" 
                                           min="0.01" step="0.01" placeholder="مثال: 5.5">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">عدد القطع <span class="text-danger">*</span></label>
                                    <input type="number" id="fabric-pieces" class="form-control" 
                                           min="1" step="1" placeholder="مثال: 2">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">طريقة التفصيل <span class="text-danger">*</span></label>
                                    <select id="fabric-tailoring" class="form-select">
                                        <option value="">-- اختر --</option>
                                        {% for option in tailoring_options %}
                                        <option value="{{ option.value }}">
                                            {{ option.display_name }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <button type="button" class="btn btn-sm btn-success mt-2" onclick="addFabricToList()">
                                <i class="fas fa-plus me-1"></i>إضافة القماش
                            </button>
                        </div>
                    </div>
                    
                    <!-- ===== قسم الحزام ===== -->
                    <div class="card mb-3 border-info">
                        <div class="card-header bg-info text-white">
                            <i class="fas fa-tape me-2"></i>الحزام (سكوتش)
                        </div>
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="beltChoice" id="noBelt" value="none" onchange="toggleBeltOptions()">
                                        <label class="form-check-label text-secondary" for="noBelt">
                                            <i class="fas fa-ban me-1"></i>لا يوجد حزام
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="beltChoice" id="scotchBelt" value="scotch" onchange="toggleBeltOptions()">
                                        <label class="form-check-label text-success" for="scotchBelt">
                                            <i class="fas fa-tape me-1"></i>حزام سكوتش
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="beltChoice" id="normalBelt" value="normal" onchange="toggleBeltOptions()">
                                        <label class="form-check-label text-primary" for="normalBelt">
                                            <i class="fas fa-grip-lines me-1"></i>حزام عادي
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-3" id="beltQtyDiv" style="display:none;">
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text">العدد</span>
                                        <input type="number" id="beltQty" class="form-control" min="1" placeholder="أدخل العدد">
                                        <button type="button" class="btn btn-success" onclick="addBeltToFabrics()">
                                            <i class="fas fa-plus"></i> إضافة
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between">
                        <button type="button" class="btn btn-secondary" onclick="backToBasicInfo()">
                            <i class="fas fa-arrow-right me-2"></i>السابق
                        </button>
                        <button type="button" class="btn btn-primary" onclick="showAccessoriesSection()">
                            <i class="fas fa-arrow-left me-2"></i>التالي - الإكسسوارات
                        </button>
                    </div>
                </div>
                
                <!-- Step 3: Accessories Section (Hidden initially) -->
                <div id="accessoriesSection" style="display: none;">
                    <div class="alert alert-info">
                        <i class="fas fa-check-circle me-2"></i>
                        <strong>الستارة:</strong> <span id="summary2-room-name"></span> - 
                        الأقمشة: <span id="summary-fabrics-count">0</span>
                    </div>
                    
                    <h6 class="text-primary mb-3">
                        <i class="fas fa-puzzle-piece me-2"></i>الإكسسوارات
                    </h6>
                    
                    <!-- خيارات الإكسسوار -->
                    <div class="card mb-3" id="accessoryChoiceCard">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="accessoryChoice" id="withAccessories" value="with" onchange="toggleAccessoriesChoice()">
                                        <label class="form-check-label fw-bold text-success" for="withAccessories">
                                            <i class="fas fa-puzzle-piece me-2"></i>مع إكسسوار
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="accessoryChoice" id="noAccessories" value="none" onchange="toggleAccessoriesChoice()">
                                        <label class="form-check-label fw-bold text-secondary" for="noAccessories">
                                            <i class="fas fa-ban me-2"></i>بدون إكسسوار
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <small class="text-muted mt-2 d-block">
                                <i class="fas fa-info-circle me-1"></i>يجب اختيار أحد الخيارين للمتابعة
                            </small>
                        </div>
                    </div>
                    
                    <!-- Accessories Fields (Hidden initially) -->
                    <div id="accessoriesFields" style="display: none;">
                        <!-- ===== قسم الإكسسوارات الشائعة (سريعة الإضافة) ===== -->
                        <div class="card mb-3 border-warning">
                            <div class="card-header bg-warning text-dark">
                                <i class="fas fa-bolt me-2"></i>إكسسوارات شائعة (تأكيد الاختيار)
                                <small class="d-block text-muted">يجب تحديد كل نوع لتأكيد وجوده أو عدمه - هذا إقرار رسمي</small>
                            </div>
                            <div class="card-body">
                                <!-- حوامل الحائط -->
                                <div class="card mb-3 border-secondary" id="wallBracketCard">
                                    <div class="card-header bg-light py-2 d-flex justify-content-between align-items-center">
                                        <span><i class="fas fa-grip-lines me-1"></i><strong>حوامل الحائط</strong></span>
                                        <span id="wallBracketStatus" class="badge bg-secondary">لم يتم الاختيار</span>
                                    </div>
                                    <div class="card-body py-2">
                                        <div class="row align-items-center">
                                            <div class="col-md-12 mb-2">
                                                <div class="btn-group w-100" role="group" id="wallBracketBtnGroup">
                                                    <input type="radio" class="btn-check" name="wallBracketChoice" id="wallBracketNone" value="none" onchange="toggleCommonAccessory('wallBracket')">
                                                    <label class="btn btn-outline-danger" for="wallBracketNone" id="wallBracketNoneLabel">
                                                        <i class="fas fa-ban me-1"></i>لا يوجد
                                                    </label>
                                                    <input type="radio" class="btn-check" name="wallBracketChoice" id="wallBracket10" value="10" onchange="toggleCommonAccessory('wallBracket')">
                                                    <label class="btn btn-outline-success" for="wallBracket10" id="wallBracket10Label">10 سنتم</label>
                                                    <input type="radio" class="btn-check" name="wallBracketChoice" id="wallBracket15" value="15" onchange="toggleCommonAccessory('wallBracket')">
                                                    <label class="btn btn-outline-success" for="wallBracket15" id="wallBracket15Label">15 سنتم</label>
                                                    <input type="radio" class="btn-check" name="wallBracketChoice" id="wallBracket20" value="20" onchange="toggleCommonAccessory('wallBracket')">
                                                    <label class="btn btn-outline-success" for="wallBracket20" id="wallBracket20Label">20 سنتم</label>
                                                </div>
                                            </div>
                                            <div class="col-12" id="wallBracketFields" style="display:none;">
                                                <div class="row g-2 align-items-end">
                                                    <div class="col-md-5">
                                                        <label class="form-label">اختر من المرجع <span class="text-danger">*</span></label>
                                                        <select id="wallBracketSelect" class="form-select form-select-sm" onchange="updateCommonAccessoryUnit('wallBracket')">
                                                            <option value="">-- اختر الصنف --</option>
                                                            {% for item in draft.items.all %}
                                                            <option value="{{ item.id }}" data-name="{{ item.product.name }}" data-unit="{{ item.product.unit }}" data-available="{{ item.quantity }}">
                                                                {{ item.product.name }} (متاح: {{ item.quantity }})
                                                            </option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                    <div class="col-md-2">
                                                        <label class="form-label">المتاح</label>
                                                        <input type="text" id="wallBracketAvailable" class="form-control form-control-sm bg-light" readonly>
                                                    </div>
                                                    <div class="col-md-2">
                                                        <label class="form-label">العدد <span class="text-danger">*</span></label>
                                                        <input type="number" id="wallBracketQty" class="form-control form-control-sm" min="1" placeholder="العدد">
                                                    </div>
                                                    <div class="col-md-2" id="wallBracketSizeDiv" style="display:none;">
                                                        <label class="form-label">الطول (متر)</label>
                                                        <input type="number" id="wallBracketSize" class="form-control form-control-sm" min="0.01" step="0.01" placeholder="الطول">
                                                    </div>
                                                    <div class="col-md-2">
                                                        <button type="button" class="btn btn-success btn-sm w-100" onclick="addCommonAccessory('wallBracket')">
                                                            <i class="fas fa-plus me-1"></i>إضافة
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- حوامل مجر -->
                                <div class="card mb-3 border-secondary" id="majarCard">
                                    <div class="card-header bg-light py-2 d-flex justify-content-between align-items-center">
                                        <span><i class="fas fa-arrows-alt-h me-1"></i><strong>حوامل مجر</strong></span>
                                        <span id="majarStatus" class="badge bg-secondary">لم يتم الاختيار</span>
                                    </div>
                                    <div class="card-body py-2">
                                        <div class="row align-items-center">
                                            <div class="col-md-12 mb-2">
                                                <div class="btn-group w-100" role="group" id="majarBtnGroup">
                                                    <input type="radio" class="btn-check" name="majarChoice" id="majarNone" value="none" onchange="toggleCommonAccessory('majar')">
                                                    <label class="btn btn-outline-danger" for="majarNone" id="majarNoneLabel">
                                                        <i class="fas fa-ban me-1"></i>لا يوجد
                                                    </label>
                                                    <input type="radio" class="btn-check" name="majarChoice" id="majarSingle" value="single" onchange="toggleCommonAccessory('majar')">
                                                    <label class="btn btn-outline-success" for="majarSingle" id="majarSingleLabel">مفرد</label>
                                                    <input type="radio" class="btn-check" name="majarChoice" id="majarDouble" value="double" onchange="toggleCommonAccessory('majar')">
                                                    <label class="btn btn-outline-success" for="majarDouble" id="majarDoubleLabel">دبل</label>
                                                </div>
                                            </div>
                                            <div class="col-12" id="majarFields" style="display:none;">
                                                <div class="row g-2 align-items-end">
                                                    <div class="col-md-5">
                                                        <label class="form-label">اختر من المرجع <span class="text-danger">*</span></label>
                                                        <select id="majarSelect" class="form-select form-select-sm" onchange="updateCommonAccessoryUnit('majar')">
                                                            <option value="">-- اختر الصنف --</option>
                                                            {% for item in draft.items.all %}
                                                            <option value="{{ item.id }}" data-name="{{ item.product.name }}" data-unit="{{ item.product.unit }}" data-available="{{ item.quantity }}">
                                                                {{ item.product.name }} (متاح: {{ item.quantity }})
                                                            </option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                    <div class="col-md-2">
                                                        <label class="form-label">المتاح</label>
                                                        <input type="text" id="majarAvailable" class="form-control form-control-sm bg-light" readonly>
                                                    </div>
                                                    <div class="col-md-2">
                                                        <label class="form-label">العدد <span class="text-danger">*</span></label>
                                                        <input type="number" id="majarQty" class="form-control form-control-sm" min="1" placeholder="العدد">
                                                    </div>
                                                    <div class="col-md-2" id="majarSizeDiv" style="display:none;">
                                                        <label class="form-label">الطول (متر)</label>
                                                        <input type="number" id="majarSize" class="form-control form-control-sm" min="0.01" step="0.01" placeholder="الطول">
                                                    </div>
                                                    <div class="col-md-2">
                                                        <button type="button" class="btn btn-success btn-sm w-100" onclick="addCommonAccessory('majar')">
                                                            <i class="fas fa-plus me-1"></i>إضافة
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- حوامل مواسير -->
                                <div class="card mb-3 border-secondary" id="pipeCard">
                                    <div class="card-header bg-light py-2 d-flex justify-content-between align-items-center">
                                        <span><i class="fas fa-grip-vertical me-1"></i><strong>حوامل مواسير</strong></span>
                                        <span id="pipeStatus" class="badge bg-secondary">لم يتم الاختيار</span>
                                    </div>
                                    <div class="card-body py-2">
                                        <div class="row align-items-center">
                                            <div class="col-md-12 mb-2">
                                                <div class="btn-group w-100" role="group" id="pipeBtnGroup">
                                                    <input type="radio" class="btn-check" name="pipeChoice" id="pipeNone" value="none" onchange="toggleCommonAccessory('pipe')">
                                                    <label class="btn btn-outline-danger" for="pipeNone" id="pipeNoneLabel">
                                                        <i class="fas fa-ban me-1"></i>لا يوجد
                                                    </label>
                                                    <input type="radio" class="btn-check" name="pipeChoice" id="pipeSingle" value="single" onchange="toggleCommonAccessory('pipe')">
                                                    <label class="btn btn-outline-success" for="pipeSingle" id="pipeSingleLabel">مفرد</label>
                                                    <input type="radio" class="btn-check" name="pipeChoice" id="pipeDouble" value="double" onchange="toggleCommonAccessory('pipe')">
                                                    <label class="btn btn-outline-success" for="pipeDouble" id="pipeDoubleLabel">دبل</label>
                                                </div>
                                            </div>
                                            <div class="col-12" id="pipeFields" style="display:none;">
                                                <div class="row g-2 align-items-end">
                                                    <div class="col-md-5">
                                                        <label class="form-label">اختر من المرجع <span class="text-danger">*</span></label>
                                                        <select id="pipeSelect" class="form-select form-select-sm" onchange="updateCommonAccessoryUnit('pipe')">
                                                            <option value="">-- اختر الصنف --</option>
                                                            {% for item in draft.items.all %}
                                                            <option value="{{ item.id }}" data-name="{{ item.product.name }}" data-unit="{{ item.product.unit }}" data-available="{{ item.quantity }}">
                                                                {{ item.product.name }} (متاح: {{ item.quantity }})
                                                            </option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                    <div class="col-md-2">
                                                        <label class="form-label">المتاح</label>
                                                        <input type="text" id="pipeAvailable" class="form-control form-control-sm bg-light" readonly>
                                                    </div>
                                                    <div class="col-md-2">
                                                        <label class="form-label">العدد <span class="text-danger">*</span></label>
                                                        <input type="number" id="pipeQty" class="form-control form-control-sm" min="1" placeholder="العدد">
                                                    </div>
                                                    <div class="col-md-2" id="pipeSizeDiv" style="display:none;">
                                                        <label class="form-label">الطول (متر)</label>
                                                        <input type="number" id="pipeSize" class="form-control form-control-sm" min="0.01" step="0.01" placeholder="الطول">
                                                    </div>
                                                    <div class="col-md-2">
                                                        <button type="button" class="btn btn-success btn-sm w-100" onclick="addCommonAccessory('pipe')">
                                                            <i class="fas fa-plus me-1"></i>إضافة
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- إكسسوارات أخرى -->
                                <div class="card border-secondary" id="otherAccessoriesCard">
                                    <div class="card-header bg-light py-2">
                                        <i class="fas fa-tools me-1"></i><strong>إكسسوارات أخرى</strong>
                                    </div>
                                    <div class="card-body py-2">
                                        <!-- مسامير عصفورة -->
                                        <div class="row mb-3 align-items-center border-bottom pb-3" id="birdScrewsCard">
                                            <div class="col-md-3">
                                                <strong><i class="fas fa-screw me-1"></i>مسامير عصفورة</strong>
                                                <span id="birdScrewsStatus" class="badge bg-secondary ms-1">-</span>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="btn-group w-100" role="group" id="birdScrewsBtnGroup">
                                                    <input type="radio" class="btn-check" name="birdScrewsChoice" id="birdScrewsNone" value="none" onchange="toggleOtherAccessoryNew('birdScrews')">
                                                    <label class="btn btn-outline-danger btn-sm" for="birdScrewsNone" id="birdScrewsNoneLabel">لا يوجد</label>
                                                    <input type="radio" class="btn-check" name="birdScrewsChoice" id="birdScrewsYes" value="yes" onchange="toggleOtherAccessoryNew('birdScrews')">
                                                    <label class="btn btn-outline-success btn-sm" for="birdScrewsYes" id="birdScrewsYesLabel">يوجد</label>
                                                </div>
                                            </div>
                                            <div class="col-md-6" id="birdScrewsFields" style="display:none;">
                                                <div class="row g-2 align-items-end">
                                                    <div class="col-md-4">
                                                        <select id="birdScrewsSelect" class="form-select form-select-sm" onchange="updateOtherAccessoryUnit('birdScrews')">
                                                            <option value="">-- اختر الصنف --</option>
                                                            {% for item in draft.items.all %}
                                                            <option value="{{ item.id }}" data-name="{{ item.product.name }}" data-unit="{{ item.product.unit }}" data-available="{{ item.quantity }}">
                                                                {{ item.product.name }} ({{ item.quantity }})
                                                            </option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                    <div class="col-md-2">
                                                        <input type="text" id="birdScrewsAvailable" class="form-control form-control-sm bg-light text-center" readonly placeholder="المتاح">
                                                    </div>
                                                    <div class="col-md-2">
                                                        <input type="number" id="birdScrewsQty" class="form-control form-control-sm" min="1" placeholder="العدد">
                                                    </div>
                                                    <div class="col-md-2">
                                                        <button type="button" class="btn btn-success btn-sm" onclick="addOtherAccessoryNew('birdScrews', 'مسامير عصفورة')">
                                                            <i class="fas fa-plus"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- فرانشة -->
                                        <div class="row mb-3 align-items-center border-bottom pb-3" id="francheCard">
                                            <div class="col-md-3">
                                                <strong><i class="fas fa-tape me-1"></i>فرانشة</strong>
                                                <span id="francheStatus" class="badge bg-secondary ms-1">-</span>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="btn-group w-100" role="group" id="francheBtnGroup">
                                                    <input type="radio" class="btn-check" name="francheChoice" id="francheNone" value="none" onchange="toggleOtherAccessoryNew('franche')">
                                                    <label class="btn btn-outline-danger btn-sm" for="francheNone" id="francheNoneLabel">لا يوجد</label>
                                                    <input type="radio" class="btn-check" name="francheChoice" id="francheYes" value="yes" onchange="toggleOtherAccessoryNew('franche')">
                                                    <label class="btn btn-outline-success btn-sm" for="francheYes" id="francheYesLabel">يوجد</label>
                                                </div>
                                            </div>
                                            <div class="col-md-6" id="francheFields" style="display:none;">
                                                <div class="row g-2 align-items-end">
                                                    <div class="col-md-4">
                                                        <select id="francheSelect" class="form-select form-select-sm" onchange="updateOtherAccessoryUnit('franche')">
                                                            <option value="">-- اختر الصنف --</option>
                                                            {% for item in draft.items.all %}
                                                            <option value="{{ item.id }}" data-name="{{ item.product.name }}" data-unit="{{ item.product.unit }}" data-available="{{ item.quantity }}">
                                                                {{ item.product.name }} ({{ item.quantity }})
                                                            </option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                    <div class="col-md-2">
                                                        <input type="text" id="francheAvailable" class="form-control form-control-sm bg-light text-center" readonly placeholder="المتاح">
                                                    </div>
                                                    <div class="col-md-2">
                                                        <input type="number" id="francheQty" class="form-control form-control-sm" min="1" placeholder="العدد">
                                                    </div>
                                                    <div class="col-md-2">
                                                        <button type="button" class="btn btn-success btn-sm" onclick="addOtherAccessoryNew('franche', 'فرانشة')">
                                                            <i class="fas fa-plus"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- شماعات -->
                                        <div class="row align-items-center" id="hangersCard">
                                            <div class="col-md-3">
                                                <strong><i class="fas fa-ring me-1"></i>شماعات</strong>
                                                <span id="hangersStatus" class="badge bg-secondary ms-1">-</span>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="btn-group w-100" role="group" id="hangersBtnGroup">
                                                    <input type="radio" class="btn-check" name="hangersChoice" id="hangersNone" value="none" onchange="toggleOtherAccessoryNew('hangers')">
                                                    <label class="btn btn-outline-danger btn-sm" for="hangersNone" id="hangersNoneLabel">لا يوجد</label>
                                                    <input type="radio" class="btn-check" name="hangersChoice" id="hangersYes" value="yes" onchange="toggleOtherAccessoryNew('hangers')">
                                                    <label class="btn btn-outline-success btn-sm" for="hangersYes" id="hangersYesLabel">يوجد</label>
                                                </div>
                                            </div>
                                            <div class="col-md-6" id="hangersFields" style="display:none;">
                                                <div class="row g-2 align-items-end">
                                                    <div class="col-md-4">
                                                        <select id="hangersSelect" class="form-select form-select-sm" onchange="updateOtherAccessoryUnit('hangers')">
                                                            <option value="">-- اختر الصنف --</option>
                                                            {% for item in draft.items.all %}
                                                            <option value="{{ item.id }}" data-name="{{ item.product.name }}" data-unit="{{ item.product.unit }}" data-available="{{ item.quantity }}">
                                                                {{ item.product.name }} ({{ item.quantity }})
                                                            </option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                    <div class="col-md-2">
                                                        <input type="text" id="hangersAvailable" class="form-control form-control-sm bg-light text-center" readonly placeholder="المتاح">
                                                    </div>
                                                    <div class="col-md-2">
                                                        <input type="number" id="hangersQty" class="form-control form-control-sm" min="1" placeholder="العدد">
                                                    </div>
                                                    <div class="col-md-2">
                                                        <button type="button" class="btn btn-success btn-sm" onclick="addOtherAccessoryNew('hangers', 'شماعات')">
                                                            <i class="fas fa-plus"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Accessories List -->
                        <div id="accessoriesList" class="mb-3"></div>
                        
                        <!-- Add Accessory Form -->
                        <div class="card bg-light mb-3">
                            <div class="card-body">
                                <h6 class="card-title">إضافة إكسسوار</h6>
                                
                                <!-- Accessory Source Selection -->
                                <div class="mb-3">
                                    <label class="form-label fw-bold">المصدر</label>
                                    <div class="btn-group w-100" role="group">
                                        <input type="radio" class="btn-check" name="accessorySource" id="accessoryFromInvoice" value="invoice" checked onchange="toggleAccessorySource()">
                                        <label class="btn btn-outline-primary" for="accessoryFromInvoice">
                                            <i class="fas fa-list me-1"></i>من المرجع
                                        </label>
                                        
                                        <input type="radio" class="btn-check" name="accessorySource" id="accessoryExternal" value="external" onchange="toggleAccessorySource()">
                                        <label class="btn btn-outline-success" for="accessoryExternal">
                                            <i class="fas fa-plus-circle me-1"></i>إكسسوار خارجي
                                        </label>
                                    </div>
                                </div>
                                
                                <!-- From Invoice Section -->
                                <div id="accessoryInvoiceSection">
                                    <div class="row g-2 mb-2">
                                        <div class="col-md-4">
                                            <label class="form-label">الإكسسوار <span class="text-danger">*</span></label>
                                            <select id="accessory-from-invoice" class="form-select" onchange="updateAccessoryQuantityInfo(this)">
                                                <option value="">اختر الإكسسوار من المرجع</option>
                                                {% for item in draft.items.all %}
                                                <option value="{{ item.id }}" 
                                                        data-available="{{ item.quantity|stringformat:'f' }}" 
                                                        data-name="{{ item.product.name }}"
                                                        data-unit="{{ item.product.unit }}"
                                                        data-is-fabric="false"
                                                        class="accessory-item-option">
                                                    {{ item.product.name }} - متوفر: <span class="available-acc-{{ item.id }}">{{ item.quantity|floatformat:"-3" }}</span>
                                                </option>
                                                {% endfor %}
                                            </select>
                                            <small class="text-muted mt-1" id="accessory-qty-hint" style="display:none;">
                                                <i class="fas fa-info-circle"></i> المتبقي: <span id="remaining-acc-qty">0</span>
                                            </small>
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label">العدد <span class="text-danger">*</span></label>
                                            <input type="number" id="accessory-invoice-quantity" class="form-control" 
                                                   min="1" step="1" placeholder="أدخل العدد">
                                        </div>
                                        <div class="col-md-2" id="accessory-invoice-size-container">
                                            <label class="form-label">المقاس (متر) <span class="text-danger">*</span></label>
                                            <input type="number" id="accessory-invoice-size" class="form-control" 
                                                   min="0.01" step="0.01"
                                                   placeholder="مثال: 2، 1.5">
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label">اللون</label>
                                            <input type="text" id="accessory-invoice-color" class="form-control" 
                                                   placeholder="أبيض، ذهبي...">
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label">&nbsp;</label>
                                            <button type="button" class="btn btn-success w-100" onclick="addAccessoryFromInvoice()">
                                                <i class="fas fa-plus me-1"></i>إضافة
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- External Accessory Section -->
                                <div id="accessoryExternalSection" style="display: none;">
                                    <div class="row g-2 mb-2">
                                        <div class="col-md-3">
                                            <label class="form-label">اسم الإكسسوار <span class="text-danger">*</span></label>
                                            <input type="text" id="accessory-external-name" class="form-control" 
                                                   placeholder="مثال: كورنيش، عصا...">
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label">العدد <span class="text-danger">*</span></label>
                                            <input type="number" id="accessory-external-quantity" class="form-control" 
                                                   min="1" step="1" placeholder="أدخل العدد">
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label">المقاس (رقم) <span class="text-danger">*</span></label>
                                            <input type="number" id="accessory-external-size" class="form-control" 
                                                   min="0.01" step="0.01"
                                                   placeholder="مثال: 2، 1.5">
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label">اللون</label>
                                            <input type="text" id="accessory-external-color" class="form-control" 
                                                   placeholder="أبيض، ذهبي...">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">&nbsp;</label>
                                            <button type="button" class="btn btn-success w-100" onclick="addExternalAccessory()">
                                                <i class="fas fa-plus me-1"></i>إضافة
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div id="customAccessoryName" style="display: none;" class="mb-2">
                                    <input type="text" id="accessory-custom-name" class="form-control" 
                                           placeholder="أدخل اسم الإكسسوار">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between mt-3">
                        <button type="button" class="btn btn-secondary" onclick="backToFabricsSection()">
                            <i class="fas fa-arrow-right me-2"></i>السابق
                        </button>
                        <button type="button" class="btn btn-primary" onclick="showNotesSection()">
                            <i class="fas fa-arrow-left me-2"></i>التالي - حفظ الستارة
                        </button>
                    </div>
                </div>
                
                <!-- Step 4: Notes Section (Hidden initially) -->
                <div id="notesSection" style="display: none;">
                    <div class="alert alert-info">
                        <i class="fas fa-check-circle me-2"></i>
                        <strong>الستارة:</strong> <span id="summary3-room-name"></span> - 
                        الأقمشة: <span id="summary2-fabrics-count">0</span> - 
                        الإكسسوارات: <span id="summary-accessories-count">0</span>
                    </div>
                    
                    <!-- ملاحظات الستارة -->
                    <div class="card mt-3" style="border-left: 4px solid #6c757d;">
                        <div class="card-body">
                            <h6 class="mb-3">
                                <i class="fas fa-sticky-note me-2"></i>ملاحظات الستارة (اختياري)
                            </h6>
                            <textarea id="curtain-notes" class="form-control" rows="3" 
                                      placeholder="أضف أي ملاحظات خاصة بهذه الستارة (ألوان الأقمشة، تفاصيل الإكسسوارات، إلخ)"></textarea>
                            <small class="text-muted">هذه الملاحظات ستظهر في العقد النهائي</small>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between mt-3">
                        <button type="button" class="btn btn-secondary" onclick="backToAccessoriesSection()">
                            <i class="fas fa-arrow-right me-2"></i>السابق
                        </button>
                        <button type="button" class="btn btn-success" onclick="saveCurtainComplete()">
                            <i class="fas fa-save me-2"></i>حفظ الستارة
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
// ===== دالة مساعدة لإضافة أيقونة الخطأ =====
function addFieldErrorIcon(field, message) {
    if (!field) return;
    
    const wrapper = field.closest('.mb-3, .col-md-4, .col-md-3');
    if (wrapper && !wrapper.querySelector('.field-error-icon')) {
        const errorIcon = document.createElement('span');
        errorIcon.className = 'field-error-icon';
        errorIcon.style.cssText = 'position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #dc3545; font-size: 1.2rem; z-index: 10; display: block;';
        errorIcon.innerHTML = '<i class="fas fa-times-circle"></i>';
        
        wrapper.style.position = 'relative';
        wrapper.appendChild(errorIcon);
    }
    
    // إضافة رسالة الخطأ
    if (message && !field.parentNode.querySelector('.field-error-message')) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'field-error-message';
        errorDiv.style.cssText = 'color: #dc3545; font-size: 0.85rem; margin-top: 0.25rem;';
        errorDiv.innerHTML = `<i class="fas fa-times-circle me-1"></i>${message}`;
        field.parentNode.appendChild(errorDiv);
    }
}

// Global variables to store curtain data
let tempFabrics = [];
let tempAccessories = [];
let fabricUsageTracker = {}; // Track how much of each fabric has been used
let editingCurtainId = null; // Track if we're editing an existing curtain

// Initialize fabric usage tracker from draft items
{% for item in draft.items.all %}
fabricUsageTracker['{{ item.id }}'] = {
    total: parseFloat('{{ item.quantity|stringformat:"f" }}'),
    used: 0,
    name: '{{ item.product.name|escapejs }}'
};
{% endfor %}

// دالة للحصول على الكمية المستخدمة من صنف معين - تحسب من كل المصادر
function getUsedQuantityForItem(itemId) {
    let used = 0;
    itemId = String(itemId);
    
    // من الأقمشة المؤقتة في النافذة الحالية
    tempFabrics.forEach(fabric => {
        if (String(fabric.item_id) === itemId) {
            used += parseFloat(fabric.meters) || 0;
        }
    });
    
    // من الإكسسوارات المؤقتة في النافذة الحالية
    tempAccessories.forEach(acc => {
        if (String(acc.item_id) === itemId) {
            used += parseFloat(acc.quantity) || 0;
        }
    });
    
    // من الستائر الموجودة في الصفحة (باستثناء الستارة المعدّلة)
    {% for curtain in curtains %}
    if (editingCurtainId !== {{ curtain.id }} && String(editingCurtainId) !== '{{ curtain.id }}') {
        {% for fabric in curtain.fabrics.all %}
        {% if fabric.draft_order_item_id %}
        if ('{{ fabric.draft_order_item_id }}' === itemId) {
            used += parseFloat('{{ fabric.meters }}') || 0;
        }
        {% endif %}
        {% endfor %}
        
        {% for accessory in curtain.accessories.all %}
        {% if accessory.draft_order_item_id %}
        if ('{{ accessory.draft_order_item_id }}' === itemId) {
            used += parseFloat('{{ accessory.quantity }}') || 0;
        }
        {% endif %}
        {% endfor %}
    }
    {% endfor %}
    
    return used;
}

// دالة للحصول على الكمية المتاحة الفعلية
function getRealAvailableQuantity(itemId) {
    itemId = String(itemId);
    if (!fabricUsageTracker[itemId]) return 0;
    
    const total = fabricUsageTracker[itemId].total;
    const used = getUsedQuantityForItem(itemId);
    return Math.max(0, total - used);
}

// نفس الدالة باسم آخر للتوافق
function calculateUsedFromItem(itemId) {
    return getUsedQuantityForItem(itemId);
}

// Calculate used quantities from existing curtain fabrics
function calculateUsedQuantities() {
    // Reset usage
    for (let key in fabricUsageTracker) {
        fabricUsageTracker[key].used = 0;
    }
    
    // Helper function to find item by name
    function findItemIdByName(name) {
        for (let key in fabricUsageTracker) {
            if (fabricUsageTracker[key].name === name) {
                return key;
            }
        }
        return null;
    }
    
    // Add from existing curtains on the page (exclude the curtain being edited)
    {% for curtain in curtains %}
        // Skip the curtain being edited to avoid double counting
        if (editingCurtainId !== {{ curtain.id }} && String(editingCurtainId) !== '{{ curtain.id }}') {
            {% for fabric in curtain.fabrics.all %}
                {% if fabric.draft_order_item_id %}
                    if (fabricUsageTracker['{{ fabric.draft_order_item_id }}']) {
                        fabricUsageTracker['{{ fabric.draft_order_item_id }}'].used += parseFloat('{{ fabric.meters }}');
                    }
                {% else %}
                    // البحث بالاسم إذا لم يكن هناك draft_order_item_id
                    var fabricItemId = findItemIdByName('{{ fabric.fabric_name|escapejs }}');
                    if (fabricItemId && fabricUsageTracker[fabricItemId]) {
                        fabricUsageTracker[fabricItemId].used += parseFloat('{{ fabric.meters }}');
                    }
                {% endif %}
            {% endfor %}
            
            {% for accessory in curtain.accessories.all %}
                {% if accessory.draft_order_item_id %}
                    if (fabricUsageTracker['{{ accessory.draft_order_item_id }}']) {
                        fabricUsageTracker['{{ accessory.draft_order_item_id }}'].used += parseFloat('{{ accessory.quantity }}');
                    }
                {% else %}
                    // البحث بالاسم إذا لم يكن هناك draft_order_item_id
                    var accItemId = findItemIdByName('{{ accessory.accessory_name|escapejs }}');
                    if (accItemId && fabricUsageTracker[accItemId]) {
                        fabricUsageTracker[accItemId].used += parseFloat('{{ accessory.quantity }}');
                    }
                {% endif %}
            {% endfor %}
        }
    {% endfor %}
    
    // Add from temp fabrics in current modal
    tempFabrics.forEach(fabric => {
        let itemId = String(fabric.item_id);
        // إذا لم يكن هناك item_id، ابحث بالاسم
        if (!itemId || itemId === 'null' || itemId === 'undefined') {
            itemId = findItemIdByName(fabric.name);
        }
        if (itemId && fabricUsageTracker[itemId]) {
            fabricUsageTracker[itemId].used += parseFloat(fabric.meters);
        }
    });
    
    // Add from temp accessories in current modal
    tempAccessories.forEach(accessory => {
        let itemId = String(accessory.item_id);
        // إذا لم يكن هناك item_id، ابحث بالاسم
        if (!itemId || itemId === 'null' || itemId === 'undefined') {
            itemId = findItemIdByName(accessory.name);
        }
        if (itemId && fabricUsageTracker[itemId]) {
            fabricUsageTracker[itemId].used += parseFloat(accessory.quantity);
        }
    });
    
    // Update the select options to show remaining quantities and hide fully used items
    updateFabricSelectOptions();
}

// Update fabric select options to show remaining quantities and hide fully used items
function updateFabricSelectOptions() {
    const fabricSelect = document.getElementById('fabric-name');
    const accessorySelect = document.getElementById('accessory-from-invoice');
    
    // Update fabric select
    if (fabricSelect) {
        Array.from(fabricSelect.options).forEach(option => {
            if (option.value === '') return; // Skip placeholder option
            
            const itemId = option.value;
            const tracker = fabricUsageTracker[itemId];
            if (tracker) {
                const remaining = tracker.total - tracker.used;
                
                // Update the displayed quantity
                const qtySpan = document.querySelector(`.available-qty-${itemId}`);
                if (qtySpan) {
                    qtySpan.textContent = remaining.toFixed(3).replace(/\.?0+$/, '');
                }
                
                // Hide option if fully used
                if (remaining <= 0.001) { // Using small epsilon for floating point comparison
                    option.style.display = 'none';
                    option.disabled = true;
                } else {
                    option.style.display = '';
                    option.disabled = false;
                }
            }
        });
    }
    
    // Update accessory select similarly
    if (accessorySelect) {
        Array.from(accessorySelect.options).forEach(option => {
            if (option.value === '') return;
            
            const itemId = option.value;
            const tracker = fabricUsageTracker[itemId];
            if (tracker) {
                const remaining = tracker.total - tracker.used;
                
                const qtySpan = document.querySelector(`.available-acc-${itemId}`);
                if (qtySpan) {
                    qtySpan.textContent = remaining.toFixed(3).replace(/\.?0+$/, '');
                }
                
                if (remaining <= 0.001) {
                    option.style.display = 'none';
                    option.disabled = true;
                } else {
                    option.style.display = '';
                    option.disabled = false;
                }
            }
        });
    }
    
    // تحديث قوائم الإكسسوارات الشائعة
    updateCommonAccessorySelects();
}

// تحديث جميع قوائم الإكسسوارات الشائعة لإظهار الكمية المتاحة الفعلية
function updateCommonAccessorySelects() {
    const selectIds = [
        'wallBracketSelect', 'majarSelect', 'pipeSelect',
        'birdScrewsSelect', 'francheSelect', 'hangersSelect'
    ];
    
    selectIds.forEach(selectId => {
        const select = document.getElementById(selectId);
        if (!select) return;
        
        Array.from(select.options).forEach(option => {
            if (option.value === '') return; // Skip placeholder
            
            const itemId = option.value;
            const originalName = option.getAttribute('data-name') || '';
            const originalAvailable = parseFloat(option.getAttribute('data-available')) || 0;
            
            // حساب الكمية المتاحة الفعلية
            const usedQty = getUsedQuantityForItem(itemId);
            const realAvailable = originalAvailable - usedQty;
            
            // تحديث نص الخيار
            option.textContent = `${originalName} (متاح: ${Math.max(0, realAvailable).toFixed(0)})`;
            
            // إخفاء الخيار إذا نفذت الكمية
            if (realAvailable <= 0) {
                option.style.display = 'none';
                option.disabled = true;
            } else {
                option.style.display = '';
                option.disabled = false;
            }
        });
    });
}

// Update quantity info when fabric is selected
function updateFabricQuantityInfo(selectElement) {
    const selectedItemId = selectElement.value;
    if (!selectedItemId || !fabricUsageTracker[selectedItemId]) {
        document.getElementById('fabric-qty-hint').style.display = 'none';
        return;
    }
    
    calculateUsedQuantities();
    
    const tracker = fabricUsageTracker[selectedItemId];
    const remaining = tracker.total - tracker.used;
    
    // Show remaining with proper decimal formatting
    document.getElementById('remaining-qty').textContent = remaining.toFixed(3).replace(/\.?0+$/, '');
    document.getElementById('fabric-qty-hint').style.display = 'block';
    
    // Update max attribute on meters input
    const metersInput = document.getElementById('fabric-meters');
    metersInput.setAttribute('max', remaining);
    
    // لا نملأ الكمية تلقائياً - نترك الحقل فارغاً للمستخدم
    // metersInput.value = ''; // الحقل يبقى فارغاً
}

// Toggle between electronic and PDF contract
function toggleContractType(type) {
    if (type === 'electronic') {
        document.getElementById('electronicContractSection').style.display = 'block';
        document.getElementById('pdfContractSection').style.display = 'none';
    } else {
        document.getElementById('electronicContractSection').style.display = 'none';
        document.getElementById('pdfContractSection').style.display = 'block';
    }
}

// Toggle curtain box fields based on installation type
function toggleCurtainBoxFields() {
    const installationType = document.getElementById('curtain-installation-type').value;
    const curtainBoxFields = document.getElementById('curtainBoxFields');
    
    if (installationType === 'curtain_box_concrete' || installationType === 'curtain_box_gypsum') {
        curtainBoxFields.style.display = 'block';
        // Make fields required
        document.getElementById('curtain-box-width').setAttribute('required', 'required');
        document.getElementById('curtain-box-depth').setAttribute('required', 'required');
    } else {
        curtainBoxFields.style.display = 'none';
        // Remove required attribute and clear values
        document.getElementById('curtain-box-width').removeAttribute('required');
        document.getElementById('curtain-box-depth').removeAttribute('required');
        document.getElementById('curtain-box-width').value = '';
        document.getElementById('curtain-box-depth').value = '';
    }
}

// Show fabrics section after basic info
function showFabricsSection() {
    const roomNameInput = document.getElementById('curtain-room-name');
    const widthInput = document.getElementById('curtain-width');
    const heightInput = document.getElementById('curtain-height');
    const installationTypeSelect = document.getElementById('curtain-installation-type');
    const boxWidthInput = document.getElementById('curtain-box-width');
    const boxDepthInput = document.getElementById('curtain-box-depth');
    
    const roomName = roomNameInput.value.trim();
    const width = parseFloat(widthInput.value);
    const height = parseFloat(heightInput.value);
    const installationType = installationTypeSelect.value;
    
    // إزالة الأخطاء السابقة
    [roomNameInput, widthInput, heightInput, installationTypeSelect, boxWidthInput, boxDepthInput].forEach(field => {
        if (field) {
            field.classList.remove('field-required-error');
            const wrapper = field.closest('.mb-3, .col-md-4, .col-md-3, .col-md-6');
            if (wrapper) {
                const errorIcon = wrapper.querySelector('.field-error-icon');
                const errorMsg = wrapper.querySelector('.field-error-message');
                if (errorIcon) errorIcon.remove();
                if (errorMsg) errorMsg.remove();
            }
        }
    });
    
    const missingFields = [];
    let hasErrors = false;
    
    // التحقق من اسم الغرفة
    if (!roomName) {
        hasErrors = true;
        missingFields.push('اسم الغرفة');
        roomNameInput.classList.add('field-required-error');
        addFieldErrorIcon(roomNameInput, 'اسم الغرفة مطلوب');
    }
    
    // التحقق من العرض
    if (!width || width <= 0 || isNaN(width)) {
        hasErrors = true;
        missingFields.push('العرض');
        widthInput.classList.add('field-required-error');
        addFieldErrorIcon(widthInput, 'العرض مطلوب');
    }
    
    // التحقق من الارتفاع
    if (!height || height <= 0 || isNaN(height)) {
        hasErrors = true;
        missingFields.push('الارتفاع');
        heightInput.classList.add('field-required-error');
        addFieldErrorIcon(heightInput, 'الارتفاع مطلوب');
    }
    
    // التحقق من نوع التركيب
    if (!installationType) {
        hasErrors = true;
        missingFields.push('نوع التركيب');
        installationTypeSelect.classList.add('field-required-error');
        addFieldErrorIcon(installationTypeSelect, 'نوع التركيب مطلوب');
    }
    
    // التحقق من بيت الستارة إذا كان مطلوباً
    if (installationType === 'curtain_box_concrete' || installationType === 'curtain_box_gypsum') {
        const boxWidth = parseFloat(boxWidthInput.value);
        const boxDepth = parseFloat(boxDepthInput.value);
        
        if (!boxWidth || boxWidth <= 0 || isNaN(boxWidth)) {
            hasErrors = true;
            missingFields.push('عرض بيت الستارة');
            boxWidthInput.classList.add('field-required-error');
            addFieldErrorIcon(boxWidthInput, 'عرض بيت الستارة مطلوب');
        }
        
        if (!boxDepth || boxDepth <= 0 || isNaN(boxDepth)) {
            hasErrors = true;
            missingFields.push('عمق بيت الستارة');
            boxDepthInput.classList.add('field-required-error');
            addFieldErrorIcon(boxDepthInput, 'عمق بيت الستارة مطلوب');
        }
    }
    
    // إذا كانت هناك أخطاء، عرض التنبيه
    if (hasErrors) {
        if (typeof Swal !== 'undefined') {
            Swal.fire({
                icon: 'warning',
                title: '<i class="fas fa-exclamation-triangle text-warning"></i> حقول مطلوبة',
                html: `
                    <div class="text-end">
                        <p class="mb-3">يرجى ملء الحقول التالية:</p>
                        <ul class="list-unstyled text-danger">
                            ${missingFields.map(f => `<li><i class="fas fa-times-circle me-2"></i>${f}</li>`).join('')}
                        </ul>
                    </div>
                `,
                confirmButtonText: 'حسناً',
                confirmButtonColor: '#dc3545'
            });
        } else {
            alert('يرجى ملء الحقول التالية:\n' + missingFields.join('\n'));
        }
        return;
    }
    
    // Update summary
    document.getElementById('summary-room-name').textContent = roomName;
    document.getElementById('summary-width').textContent = width.toFixed(2);
    document.getElementById('summary-height').textContent = height.toFixed(2);
    document.getElementById('summary2-room-name').textContent = roomName;
    
    // Hide basic info, show fabrics
    document.getElementById('curtainBasicInfo').style.display = 'none';
    document.getElementById('fabricsSection').style.display = 'block';
}

function editBasicInfo() {
    document.getElementById('curtainBasicInfo').style.display = 'block';
    document.getElementById('fabricsSection').style.display = 'none';
}

function backToBasicInfo() {
    editBasicInfo();
}

// Add fabric to temporary list
function addFabricToList() {
    const fabricTypeSelect = document.getElementById('fabric-type');
    const fabricType = fabricTypeSelect.value;
    const fabricSelect = document.getElementById('fabric-name');
    const fabricItemId = fabricSelect.value;
    const metersInput = document.getElementById('fabric-meters');
    const meters = parseFloat(metersInput.value);
    const piecesInput = document.getElementById('fabric-pieces');
    const pieces = parseInt(piecesInput.value);
    const tailoringSelect = document.getElementById('fabric-tailoring');
    const tailoring = tailoringSelect.value;
    
    // إزالة الأخطاء السابقة
    [fabricTypeSelect, fabricSelect, metersInput, piecesInput, tailoringSelect].forEach(field => {
        if (field) {
            field.classList.remove('field-required-error');
            const wrapper = field.closest('.mb-3, .col-md-4, .col-md-3, .col-md-6');
            if (wrapper) {
                const errorIcon = wrapper.querySelector('.field-error-icon');
                const errorMsg = wrapper.querySelector('.field-error-message');
                if (errorIcon) errorIcon.remove();
                if (errorMsg) errorMsg.remove();
            }
        }
    });
    
    const missingFields = [];
    let hasErrors = false;
    
    // التحقق من نوع القماش
    if (!fabricType) {
        hasErrors = true;
        missingFields.push('نوع القماش');
        fabricTypeSelect.classList.add('field-required-error');
        addFieldErrorIcon(fabricTypeSelect, 'نوع القماش مطلوب');
    }
    
    // التحقق من اسم القماش
    if (!fabricItemId) {
        hasErrors = true;
        missingFields.push('اسم القماش');
        fabricSelect.classList.add('field-required-error');
        addFieldErrorIcon(fabricSelect, 'اسم القماش مطلوب');
    }
    
    // التحقق من الكمية
    if (!meters || meters <= 0 || isNaN(meters)) {
        hasErrors = true;
        missingFields.push('الكمية بالمتر');
        metersInput.classList.add('field-required-error');
        addFieldErrorIcon(metersInput, 'الكمية مطلوبة');
    }
    
    // التحقق من عدد القطع
    if (!pieces || pieces <= 0 || isNaN(pieces)) {
        hasErrors = true;
        missingFields.push('عدد القطع');
        piecesInput.classList.add('field-required-error');
        addFieldErrorIcon(piecesInput, 'عدد القطع مطلوب');
    }
    
    // التحقق من طريقة التفصيل
    if (!tailoring) {
        hasErrors = true;
        missingFields.push('طريقة التفصيل');
        tailoringSelect.classList.add('field-required-error');
        addFieldErrorIcon(tailoringSelect, 'طريقة التفصيل مطلوبة');
    }
    
    // إذا كانت هناك أخطاء، عرض التنبيه
    if (hasErrors) {
        if (typeof Swal !== 'undefined') {
            Swal.fire({
                icon: 'warning',
                title: '<i class="fas fa-exclamation-triangle text-warning"></i> حقول مطلوبة',
                html: `
                    <div class="text-end">
                        <p class="mb-3">يرجى ملء الحقول التالية:</p>
                        <ul class="list-unstyled text-danger">
                            ${missingFields.map(f => `<li><i class="fas fa-times-circle me-2"></i>${f}</li>`).join('')}
                        </ul>
                    </div>
                `,
                confirmButtonText: 'حسناً',
                confirmButtonColor: '#dc3545'
            });
        } else {
            alert('يرجى ملء الحقول التالية:\n' + missingFields.join('\n'));
        }
        return;
    }
    
    // Validate quantity against available
    calculateUsedQuantities();
    const tracker = fabricUsageTracker[fabricItemId];
    const remaining = tracker.total - tracker.used;
    
    // Use epsilon for floating point comparison
    if (meters > remaining + 0.001) {
        alert(`الكمية المطلوبة (${meters.toFixed(3)} متر) أكبر من المتوفر (${remaining.toFixed(3)} متر)\nالمتبقي من ${tracker.name}: ${remaining.toFixed(3)} متر`);
        return;
    }
    
    const fabricName = fabricSelect.options[fabricSelect.selectedIndex].getAttribute('data-name');
    
    const fabric = {
        type: fabricType,
        type_display: document.getElementById('fabric-type').options[document.getElementById('fabric-type').selectedIndex].text,
        name: fabricName,
        item_id: fabricItemId,
        meters: meters,
        pieces: pieces,
        tailoring: tailoring,
        tailoring_display: tailoring ? document.getElementById('fabric-tailoring').options[document.getElementById('fabric-tailoring').selectedIndex].text : '-'
    };
    
    tempFabrics.push(fabric);
    updateFabricsList();
    
    // Clear form - إعادة تعيين جميع الحقول بدون قيم افتراضية
    document.getElementById('fabric-type').value = '';
    document.getElementById('fabric-name').value = '';
    metersInput.value = '';
    document.getElementById('fabric-pieces').value = '';
    document.getElementById('fabric-tailoring').value = '';
    document.getElementById('fabric-qty-hint').style.display = 'none';
    
    // إظهار رسالة نجاح
    if (typeof Swal !== 'undefined') {
        const Toast = Swal.mixin({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 2000,
            timerProgressBar: true
        });
        Toast.fire({
            icon: 'success',
            title: 'تم إضافة القماش بنجاح'
        });
    }
    
    // Recalculate to update tracking and hide fully used items
    calculateUsedQuantities();
}

function updateFabricsList() {
    const list = document.getElementById('fabricsList');
    
    if (tempFabrics.length === 0) {
        list.innerHTML = '<div class="alert alert-warning">لم يتم إضافة أقمشة بعد</div>';
        return;
    }
    
    let html = '';
    tempFabrics.forEach((fabric, index) => {
        const colorClass = fabric.type === 'light' ? 'warning' : 
                          fabric.type === 'heavy' ? 'danger' : 
                          fabric.type === 'blackout' ? 'dark' : 'secondary';
        
        // تحديد إذا كان حزام (من اسم القماش أو source أو unit)
        const isBelt = fabric.source === 'belt' || fabric.unit === 'piece' || 
                      (fabric.name && fabric.name.includes('حزام'));
        
        // عرض مختلف للحزام (بالقطعة) والأقمشة (بالمتر)
        let quantityDisplay = '';
        if (isBelt) {
            // الحزام: عرض بالقطعة فقط - استخدام pieces أو meters كـ fallback
            const piecesCount = fabric.pieces || fabric.meters || 1;
            quantityDisplay = `${parseInt(piecesCount)} قطعة`;
        } else {
            // الأقمشة: عرض بالمتر والقطع
            const metersFormatted = parseFloat(fabric.meters).toFixed(3).replace(/\.?0+$/, '');
            const piecesCount = fabric.pieces || 1;
            quantityDisplay = `${metersFormatted}م × ${piecesCount} قطعة`;
        }
        
        html += `
            <div class="card mb-2 border-${colorClass}">
                <div class="card-body py-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <span class="badge bg-${colorClass}">${fabric.type_display}</span>
                            <strong>${fabric.name}</strong> - 
                            ${quantityDisplay}
                            ${fabric.tailoring ? ' - ' + fabric.tailoring_display : ''}
                        </div>
                        <button type="button" class="btn btn-sm btn-danger" onclick="removeFabric(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    
    list.innerHTML = html;
    document.getElementById('summary-fabrics-count').textContent = tempFabrics.length;
}

function removeFabric(index) {
    tempFabrics.splice(index, 1);
    updateFabricsList();
    // Recalculate to update available quantities
    calculateUsedQuantities();
}

// Show accessories section
function showAccessoriesSection(skipFabricCheck = false) {
    // التحقق من اختيار خيار الحزام أو إضافة حزام
    const noBelt = document.getElementById('noBelt')?.checked;
    const scotchBelt = document.getElementById('scotchBelt')?.checked;
    const normalBelt = document.getElementById('normalBelt')?.checked;
    
    // التحقق إذا تم إضافة حزام في قائمة الأقمشة (بأي طريقة)
    const hasBeltAdded = tempFabrics.some(fabric => 
        fabric.source === 'belt' || 
        fabric.unit === 'piece' || 
        (fabric.name && fabric.name.includes('حزام'))
    );
    
    // السماح بالمتابعة إذا: تم اختيار خيار أو تم إضافة حزام
    if (!noBelt && !scotchBelt && !normalBelt && !hasBeltAdded) {
        // تحديد بطاقة الحزام بتنسيق الخطأ
        const beltCard = document.querySelector('.card.border-info');
        if (beltCard) {
            beltCard.classList.add('field-required-error');
        }
        
        Swal.fire({
            icon: 'error',
            title: 'حقل مطلوب',
            text: 'يرجى اختيار خيار الحزام (لا يوجد / سكوتش / عادي) أو إضافة حزام',
            confirmButtonText: 'حسناً'
        });
        return;
    }
    
    // إزالة تنسيق الخطأ من بطاقة الحزام
    const beltCard = document.querySelector('.card.border-info');
    if (beltCard) {
        beltCard.classList.remove('field-required-error');
    }
    
    if (!skipFabricCheck && tempFabrics.length === 0) {
        // إظهار تنبيه SweetAlert مع منع المتابعة
        if (typeof Swal !== 'undefined') {
            Swal.fire({
                icon: 'error',
                title: '<i class="fas fa-times-circle text-danger"></i> يجب إضافة قماش',
                html: `
                    <div class="text-center">
                        <p class="mb-3" style="font-size: 1.1rem;">لم تقم بإضافة أي أقمشة للستارة!</p>
                        <div class="alert alert-warning py-2">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>يجب إضافة قماش واحد على الأقل</strong> للمتابعة
                        </div>
                    </div>
                `,
                confirmButtonText: '<i class="fas fa-plus me-2"></i>إضافة قماش الآن',
                confirmButtonColor: '#198754',
                allowOutsideClick: false,
                allowEscapeKey: false
            });
        } else {
            alert('يجب إضافة قماش واحد على الأقل للمتابعة!');
        }
        
        // تلوين قسم إضافة الأقمشة
        const addFabricCard = document.querySelector('#fabricsSection .card');
        if (addFabricCard) {
            addFabricCard.classList.add('field-required-error');
            addFabricCard.style.animation = 'shake 0.5s ease-in-out';
        }
        
        return; // منع المتابعة
    }
    
    document.getElementById('fabricsSection').style.display = 'none';
    document.getElementById('accessoriesSection').style.display = 'block';
    document.getElementById('notesSection').style.display = 'none';
}

function backToFabricsSection() {
    document.getElementById('accessoriesSection').style.display = 'none';
    document.getElementById('fabricsSection').style.display = 'block';
    document.getElementById('notesSection').style.display = 'none';
}

// Show notes section
function showNotesSection() {
    // التحقق من اختيار الإكسسوار
    const withAccessories = document.getElementById('withAccessories')?.checked;
    const noAccessories = document.getElementById('noAccessories')?.checked;
    
    // التحقق: يجب اختيار إما "مع إكسسوار" أو "بدون إكسسوار"
    if (!withAccessories && !noAccessories) {
        // تحديد حاوية الاختيار بتنسيق الخطأ
        const choiceCard = document.getElementById('accessoryChoiceCard');
        if (choiceCard) {
            choiceCard.classList.add('field-required-error');
            choiceCard.style.border = '2px solid #dc3545';
            choiceCard.style.borderRadius = '8px';
            choiceCard.style.padding = '10px';
        }
        
        Swal.fire({
            icon: 'error',
            title: 'حقل مطلوب',
            text: 'يرجى اختيار إما "مع إكسسوار" أو "بدون إكسسوار"',
            confirmButtonText: 'حسناً'
        });
        return false;
    }
    
    // إذا اختار "مع إكسسوار" يجب التحقق من جميع الإكسسوارات
    if (withAccessories) {
        // التحقق من الإكسسوارات الشائعة (حوامل)
        const commonTypes = ['wallBracket', 'majar', 'pipe'];
        const commonNames = {
            'wallBracket': 'حوامل الحائط',
            'majar': 'حوامل مجر', 
            'pipe': 'حوامل مواسير'
        };
        
        for (let type of commonTypes) {
            const choice = document.querySelector(`input[name="${type}Choice"]:checked`);
            if (!choice) {
                const card = document.getElementById(`${type}Card`);
                if (card) card.classList.add('field-required-error');
                
                Swal.fire({
                    icon: 'error',
                    title: 'حقل مطلوب',
                    html: `يرجى تحديد اختيارك لـ <strong>${commonNames[type]}</strong><br>(لا يوجد أو اختيار النوع)`,
                    confirmButtonText: 'حسناً'
                });
                return false;
            }
        }
        
        // التحقق من الإكسسوارات الأخرى (مسامير عصفورة، فرانشة، شماعات)
        const otherTypes = ['birdScrews', 'franche', 'hangers'];
        const otherNames = {
            'birdScrews': 'مسامير عصفورة',
            'franche': 'فرانشة',
            'hangers': 'شماعات'
        };
        
        for (let type of otherTypes) {
            const choice = document.querySelector(`input[name="${type}Choice"]:checked`);
            if (!choice) {
                const card = document.getElementById(`${type}Card`);
                if (card) card.classList.add('field-required-error');
                
                Swal.fire({
                    icon: 'error',
                    title: 'حقل مطلوب',
                    html: `يرجى تحديد اختيارك لـ <strong>${otherNames[type]}</strong><br>(لا يوجد أو يوجد)`,
                    confirmButtonText: 'حسناً'
                });
                return false;
            }
        }
        
        // التحقق من إضافة إكسسوار واحد على الأقل
        if (tempAccessories.length === 0) {
            Swal.fire({
                icon: 'error',
                title: 'الإكسسوارات مطلوبة',
                text: 'يرجى إضافة إكسسوار واحد على الأقل أو اختيار "بدون إكسسوار"',
                confirmButtonText: 'حسناً'
            });
            return false;
        }
    }
    
    // Update summary
    const roomName = document.getElementById('curtain-room-name').value;
    document.getElementById('summary3-room-name').textContent = roomName;
    document.getElementById('summary2-fabrics-count').textContent = tempFabrics.length;
    document.getElementById('summary-accessories-count').textContent = tempAccessories.length;
    
    document.getElementById('accessoriesSection').style.display = 'none';
    document.getElementById('fabricsSection').style.display = 'none';
    document.getElementById('notesSection').style.display = 'block';
}

function backToAccessoriesSection() {
    document.getElementById('notesSection').style.display = 'none';
    document.getElementById('accessoriesSection').style.display = 'block';
    document.getElementById('fabricsSection').style.display = 'none';
}

// Toggle accessories choice (with or without)
function toggleAccessoriesChoice() {
    const withAccessories = document.getElementById('withAccessories').checked;
    const noAccessories = document.getElementById('noAccessories').checked;
    
    // إزالة تنسيق الخطأ
    const choiceCard = document.getElementById('accessoryChoiceCard');
    if (choiceCard) {
        choiceCard.classList.remove('field-required-error');
        choiceCard.style.border = '';
        choiceCard.style.borderRadius = '';
        choiceCard.style.padding = '';
        const errorIcon = choiceCard.querySelector('.field-error-icon');
        const errorMsg = choiceCard.querySelector('.field-error-message');
        if (errorIcon) errorIcon.remove();
        if (errorMsg) errorMsg.remove();
    }
    
    if (withAccessories) {
        document.getElementById('accessoriesFields').style.display = 'block';
    } else {
        document.getElementById('accessoriesFields').style.display = 'none';
    }
}

// ===== دوال الإكسسوارات الشائعة الجديدة =====

// متغير لحفظ اختيارات الإكسسوارات الشائعة
let commonAccessoryChoices = {
    wallBracket: null,
    majar: null,
    pipe: null,
    birdScrews: null,
    franche: null,
    hangers: null
};

// دالة تحديث حالة الاختيار للمحاسبة
function updateAccessoryStatus(type, choice) {
    const statusBadge = document.getElementById(`${type}Status`);
    if (!statusBadge) return;
    
    statusBadge.classList.remove('bg-secondary', 'bg-danger', 'bg-success', 'bg-info');
    
    if (choice === null || choice === undefined) {
        statusBadge.textContent = 'لم يتم الاختيار';
        statusBadge.classList.add('bg-secondary');
    } else if (choice === 'none') {
        statusBadge.textContent = '❌ تم اختيار: لا يوجد';
        statusBadge.classList.add('bg-danger');
    } else if (choice === 'added') {
        statusBadge.textContent = '✅ تمت الإضافة';
        statusBadge.classList.add('bg-success');
    } else if (choice === 'yes') {
        statusBadge.textContent = '✓ بانتظار التحديد';
        statusBadge.classList.add('bg-info');
    } else {
        statusBadge.textContent = `✓ تم اختيار: ${choice}`;
        statusBadge.classList.add('bg-info');
    }
}

// تبديل إظهار حقول الإكسسوار الشائع (حوامل حائط، مجر، مواسير)
function toggleCommonAccessory(type) {
    const choice = document.querySelector(`input[name="${type}Choice"]:checked`);
    const fieldsDiv = document.getElementById(`${type}Fields`);
    const card = document.getElementById(`${type}Card`);
    const statusBadge = document.getElementById(`${type}Status`);
    
    // حفظ الاختيار
    if (choice) {
        commonAccessoryChoices[type] = choice.value;
    }
    
    // إزالة تنسيق الخطأ من الكارد
    if (card) {
        card.classList.remove('field-required-error');
        const errorIcon = card.querySelector('.field-error-icon');
        const errorMsg = card.querySelector('.field-error-message');
        if (errorIcon) errorIcon.remove();
        if (errorMsg) errorMsg.remove();
    }
    
    // تحديث ألوان الأزرار ديناميكياً
    updateCommonAccessoryButtonColors(type, choice ? choice.value : null);
    
    // تحديث حالة الاختيار
    updateAccessoryStatus(type, choice ? choice.value : null);
    
    if (choice && choice.value !== 'none') {
        // تم اختيار نوع - إظهار حقول الإدخال
        fieldsDiv.style.display = 'block';
    } else {
        // تم اختيار "لا يوجد" أو لم يتم الاختيار
        fieldsDiv.style.display = 'none';
        // إعادة تعيين الحقول
        const selectEl = document.getElementById(`${type}Select`);
        if (selectEl) selectEl.value = '';
        const qtyEl = document.getElementById(`${type}Qty`);
        if (qtyEl) qtyEl.value = '';
        const sizeEl = document.getElementById(`${type}Size`);
        if (sizeEl) sizeEl.value = '';
        const sizeDivEl = document.getElementById(`${type}SizeDiv`);
        if (sizeDivEl) sizeDivEl.style.display = 'none';
        const availableEl = document.getElementById(`${type}Available`);
        if (availableEl) availableEl.value = '';
    }
}

// تحديث ألوان الأزرار ديناميكياً
function updateCommonAccessoryButtonColors(type, selectedValue) {
    // الحصول على جميع الأزرار في المجموعة
    const btnGroup = document.getElementById(`${type}BtnGroup`);
    if (!btnGroup) return;
    
    const radios = btnGroup.querySelectorAll('input[type="radio"]');
    radios.forEach(radio => {
        const label = document.querySelector(`label[for="${radio.id}"]`);
        if (!label) return;
        
        // إزالة جميع الكلاسات اللونية
        label.classList.remove('btn-danger', 'btn-success', 'btn-outline-danger', 'btn-outline-success', 'btn-outline-secondary');
        
        if (radio.checked) {
            // الزر المختار - لون صلب
            if (radio.value === 'none') {
                label.classList.add('btn-danger');
            } else {
                label.classList.add('btn-success');
            }
        } else {
            // الأزرار غير المختارة - لون outline
            if (radio.value === 'none') {
                label.classList.add('btn-outline-danger');
            } else {
                label.classList.add('btn-outline-success');
            }
        }
    });
}

// تحديث حقل الطول والكمية المتاحة بناء على المنتج المختار
function updateCommonAccessoryUnit(type) {
    const select = document.getElementById(`${type}Select`);
    const sizeDiv = document.getElementById(`${type}SizeDiv`);
    const availableInput = document.getElementById(`${type}Available`);
    const qtyInput = document.getElementById(`${type}Qty`);
    const selectedOption = select.options[select.selectedIndex];
    
    if (selectedOption && selectedOption.value) {
        // عرض الكمية المتاحة
        const available = parseFloat(selectedOption.getAttribute('data-available')) || 0;
        const usedQty = getUsedQuantityForItem(selectedOption.value);
        const realAvailable = available - usedQty;
        
        if (availableInput) {
            availableInput.value = realAvailable.toFixed(2);
            if (realAvailable <= 0) {
                availableInput.classList.add('text-danger', 'fw-bold');
            } else {
                availableInput.classList.remove('text-danger', 'fw-bold');
            }
        }
        
        // تحديد الحد الأقصى للعدد
        if (qtyInput) {
            qtyInput.max = Math.floor(realAvailable);
        }
        
        const unit = selectedOption.getAttribute('data-unit');
        // إظهار حقل الطول فقط إذا كانت الوحدة متر أو رول
        if (unit && (unit.toLowerCase() === 'meter' || unit.toLowerCase() === 'متر' || 
                     unit.toLowerCase() === 'roll' || unit.toLowerCase() === 'رول')) {
            sizeDiv.style.display = 'block';
        } else {
            sizeDiv.style.display = 'none';
            const sizeEl = document.getElementById(`${type}Size`);
            if (sizeEl) sizeEl.value = '';
        }
    } else {
        if (sizeDiv) sizeDiv.style.display = 'none';
        if (availableInput) availableInput.value = '';
    }
}

// إضافة إكسسوار شائع
function addCommonAccessory(type) {
    const typeNames = {
        'wallBracket': 'حامل حائط',
        'majar': 'حامل مجر',
        'pipe': 'حامل مواسير'
    };
    
    const typeLabels = {
        'wallBracket': {'10': '10 سنتم', '15': '15 سنتم', '20': '20 سنتم'},
        'majar': {'single': 'مفرد', 'double': 'دبل'},
        'pipe': {'single': 'مفرد', 'double': 'دبل'}
    };
    
    const choice = document.querySelector(`input[name="${type}Choice"]:checked`);
    if (!choice || choice.value === 'none') {
        Swal.fire({
            icon: 'error',
            title: 'خطأ',
            text: 'يرجى اختيار نوع الإكسسوار',
            confirmButtonText: 'حسناً'
        });
        return;
    }
    
    const choiceValue = choice.value;
    const choiceLabel = typeLabels[type][choiceValue] || choiceValue;
    const qtyInput = document.getElementById(`${type}Qty`);
    const qty = parseInt(qtyInput.value);
    
    // التحقق من إدخال العدد
    if (!qty || qty <= 0 || isNaN(qty)) {
        qtyInput.classList.add('field-required-error');
        Swal.fire({
            icon: 'error',
            title: 'حقل مطلوب',
            text: 'يرجى إدخال العدد',
            confirmButtonText: 'حسناً'
        });
        return;
    }
    qtyInput.classList.remove('field-required-error');
    
    // الحصول على معلومات المنتج من المرجع
    const select = document.getElementById(`${type}Select`);
    const selectedOption = select.options[select.selectedIndex];
    
    if (!selectedOption || !selectedOption.value) {
        select.classList.add('field-required-error');
        Swal.fire({
            icon: 'error',
            title: 'حقل مطلوب',
            text: 'يرجى اختيار الصنف من المرجع',
            confirmButtonText: 'حسناً'
        });
        return;
    }
    select.classList.remove('field-required-error');
    
    const itemId = selectedOption.value;
    const productName = selectedOption.getAttribute('data-name') || '';
    const displayType = `${typeNames[type]} ${choiceLabel}`;
    
    // التحقق من الكمية المتاحة
    const available = parseFloat(selectedOption.getAttribute('data-available')) || 0;
    const usedQty = getUsedQuantityForItem(itemId);
    const realAvailable = available - usedQty;
    
    if (qty > realAvailable) {
        qtyInput.classList.add('field-required-error');
        Swal.fire({
            icon: 'error',
            title: 'الكمية غير متاحة',
            html: `الكمية المطلوبة (${qty}) أكبر من المتاح (${realAvailable.toFixed(2)})<br><br>الكمية الأصلية: ${available}<br>المستخدم: ${usedQty.toFixed(2)}`,
            confirmButtonText: 'حسناً'
        });
        return;
    }
    
    // الحصول على الطول إن كان بالمتر
    let size = null;
    const sizeInput = document.getElementById(`${type}Size`);
    if (sizeInput && sizeInput.value) {
        size = parseFloat(sizeInput.value);
    }
    
    const accessory = {
        name: productName,
        display_type: displayType,
        quantity: qty,
        count: qty,
        size: size,
        color: '',
        source: 'invoice',
        item_id: itemId
    };
    
    tempAccessories.push(accessory);
    updateAccessoriesList();
    calculateUsedQuantities(); // تحديث الكميات المستخدمة
    updateCommonAccessorySelects(); // تحديث قوائم الإكسسوارات
    
    // حفظ الاختيار للمحاسبة
    commonAccessoryChoices[type] = {
        choice: choiceValue,
        item_id: itemId,
        product_name: productName,
        quantity: qty,
        size: size,
        display_type: displayType,
        added_at: new Date().toISOString()
    };
    
    // تحديث حالة الاختيار
    updateAccessoryStatus(type, 'added');
    
    // لا نعيد تعيين الاختيار - نحتفظ به للمراجعة
    // لكن نخفي حقول الإدخال ونمسح القيم
    document.getElementById(`${type}Fields`).style.display = 'none';
    select.value = '';
    qtyInput.value = '';
    const sizeEl = document.getElementById(`${type}Size`);
    if (sizeEl) sizeEl.value = '';
    const sizeDivEl = document.getElementById(`${type}SizeDiv`);
    if (sizeDivEl) sizeDivEl.style.display = 'none';
    const availableEl = document.getElementById(`${type}Available`);
    if (availableEl) availableEl.value = '';
    
    // رسالة نجاح
    let sizeText = size ? ` × ${size}م` : '';
    Swal.fire({
        icon: 'success',
        title: 'تمت الإضافة',
        text: `تم إضافة ${productName} - ${displayType} (${qty} قطعة${sizeText})`,
        timer: 2000,
        showConfirmButton: false
    });
}

// تبديل إظهار حقول الإكسسوارات الأخرى (مسامير عصفورة، فرانشة، شماعات)
function toggleOtherAccessoryNew(type) {
    const choice = document.querySelector(`input[name="${type}Choice"]:checked`);
    const fieldsDiv = document.getElementById(`${type}Fields`);
    
    // حفظ الاختيار
    if (choice) {
        commonAccessoryChoices[type] = choice.value;
    }
    
    // تحديث ألوان الأزرار
    updateOtherAccessoryButtonColors(type, choice ? choice.value : null);
    
    // تحديث حالة الاختيار
    updateAccessoryStatus(type, choice ? choice.value : null);
    
    if (choice && choice.value === 'yes') {
        fieldsDiv.style.display = 'flex';
    } else {
        fieldsDiv.style.display = 'none';
        const qtyEl = document.getElementById(`${type}Qty`);
        if (qtyEl) qtyEl.value = '';
        const selectEl = document.getElementById(`${type}Select`);
        if (selectEl) selectEl.value = '';
    }
}

// تحديث ألوان أزرار الإكسسوارات الأخرى
function updateOtherAccessoryButtonColors(type, selectedValue) {
    const btnGroup = document.getElementById(`${type}BtnGroup`);
    if (!btnGroup) return;
    
    const radios = btnGroup.querySelectorAll('input[type="radio"]');
    radios.forEach(radio => {
        const label = document.querySelector(`label[for="${radio.id}"]`);
        if (!label) return;
        
        label.classList.remove('btn-danger', 'btn-success', 'btn-outline-danger', 'btn-outline-success');
        
        if (radio.checked) {
            if (radio.value === 'none') {
                label.classList.add('btn-danger');
            } else {
                label.classList.add('btn-success');
            }
        } else {
            if (radio.value === 'none') {
                label.classList.add('btn-outline-danger');
            } else {
                label.classList.add('btn-outline-success');
            }
        }
    });
}

// تحديث حقل الإكسسوار الآخر - عرض الكمية المتاحة
function updateOtherAccessoryUnit(type) {
    const select = document.getElementById(`${type}Select`);
    const availableInput = document.getElementById(`${type}Available`);
    const qtyInput = document.getElementById(`${type}Qty`);
    const selectedOption = select ? select.options[select.selectedIndex] : null;
    
    if (selectedOption && selectedOption.value) {
        // حساب الكمية المتاحة الحقيقية
        const originalAvailable = parseFloat(selectedOption.getAttribute('data-available')) || 0;
        const usedQty = getUsedQuantityForItem(selectedOption.value);
        const realAvailable = originalAvailable - usedQty;
        
        if (availableInput) {
            availableInput.value = Math.floor(realAvailable);
            if (realAvailable <= 0) {
                availableInput.classList.add('text-danger', 'fw-bold');
            } else {
                availableInput.classList.remove('text-danger', 'fw-bold');
            }
        }
        
        // تحديد الحد الأقصى للعدد
        if (qtyInput) {
            qtyInput.max = Math.floor(realAvailable);
        }
    } else {
        if (availableInput) availableInput.value = '';
    }
}

// إضافة إكسسوار آخر (مسامير عصفورة، فرانشة، شماعات)
function addOtherAccessoryNew(type, displayType) {
    const qtyInput = document.getElementById(`${type}Qty`);
    const qty = parseInt(qtyInput.value);
    
    // التحقق من إدخال العدد
    if (!qty || qty <= 0 || isNaN(qty)) {
        qtyInput.classList.add('field-required-error');
        Swal.fire({
            icon: 'error',
            title: 'حقل مطلوب',
            text: 'يرجى إدخال العدد',
            confirmButtonText: 'حسناً'
        });
        return;
    }
    qtyInput.classList.remove('field-required-error');
    
    // الحصول على معلومات المنتج - يجب اختيار منتج من المرجع
    const select = document.getElementById(`${type}Select`);
    const selectedOption = select ? select.options[select.selectedIndex] : null;
    
    if (!selectedOption || !selectedOption.value) {
        Swal.fire({
            icon: 'error',
            title: 'حقل مطلوب',
            text: 'يرجى اختيار المنتج من القائمة',
            confirmButtonText: 'حسناً'
        });
        return;
    }
    
    const itemId = selectedOption.value;
    const productName = selectedOption.getAttribute('data-name') || displayType;
    
    // التحقق من الكمية المتاحة
    const availableQty = parseFloat(selectedOption.getAttribute('data-available')) || 0;
    const usedFromItem = calculateUsedFromItem(itemId);
    const realAvailable = availableQty - usedFromItem;
    
    if (qty > realAvailable) {
        Swal.fire({
            icon: 'error',
            title: 'الكمية غير متاحة',
            text: `الكمية المطلوبة (${qty}) أكبر من المتاح (${Math.floor(realAvailable)})`,
            confirmButtonText: 'حسناً'
        });
        return;
    }
    
    const accessory = {
        name: productName,
        display_type: displayType,
        quantity: qty,
        count: qty,
        size: null,
        color: '',
        source: 'invoice',
        item_id: itemId
    };
    
    tempAccessories.push(accessory);
    updateAccessoriesList();
    calculateUsedQuantities(); // تحديث الكميات المستخدمة
    updateCommonAccessorySelects(); // تحديث قوائم الإكسسوارات
    
    // حفظ الاختيار للمحاسبة
    commonAccessoryChoices[type] = {
        choice: 'yes',
        item_id: itemId,
        product_name: productName,
        quantity: qty,
        added_at: new Date().toISOString()
    };
    
    // إعادة تعيين
    const noneRadio = document.getElementById(`${type}None`);
    if (noneRadio) {
        noneRadio.checked = true;
        updateOtherAccessoryButtonColors(type, 'none');
        // تحديث حالة الاختيار بعد الإضافة
        updateAccessoryStatus(type, 'added');
    }
    document.getElementById(`${type}Fields`).style.display = 'none';
    qtyInput.value = '';
    if (select) select.value = '';
    
    // رسالة نجاح
    Swal.fire({
        icon: 'success',
        title: 'تمت الإضافة',
        text: `تم إضافة ${productName} - ${displayType} (${qty} قطعة)`,
        timer: 2000,
        showConfirmButton: false
    });
}

// دوال قديمة للتوافق
function toggleQuickAccessory(type) {
    console.log('Using old toggleQuickAccessory - please update to new system');
}

function addQuickAccessory(group) {
    console.log('Using old addQuickAccessory - please update to new system');
}

function toggleOtherAccessory(type) {
    console.log('Using old toggleOtherAccessory - please update to new system');
}

function addOtherAccessory(type, name) {
    console.log('Using old addOtherAccessory - please update to new system');
}

// ===== دوال الحزام =====

// تبديل خيارات الحزام
function toggleBeltOptions() {
    const scotchBelt = document.getElementById('scotchBelt').checked;
    const normalBelt = document.getElementById('normalBelt').checked;
    const beltQtyDiv = document.getElementById('beltQtyDiv');
    
    if (scotchBelt || normalBelt) {
        beltQtyDiv.style.display = 'block';
    } else {
        beltQtyDiv.style.display = 'none';
    }
}

// إضافة الحزام إلى قائمة الأقمشة
function addBeltToFabrics() {
    const scotchBelt = document.getElementById('scotchBelt').checked;
    const normalBelt = document.getElementById('normalBelt').checked;
    const qtyInput = document.getElementById('beltQty');
    const qty = parseInt(qtyInput.value);
    
    let beltName = '';
    if (scotchBelt) {
        beltName = 'حزام سكوتش';
    } else if (normalBelt) {
        beltName = 'حزام عادي';
    } else {
        Swal.fire({
            icon: 'error',
            title: 'خطأ',
            text: 'يرجى اختيار نوع الحزام',
            confirmButtonText: 'حسناً'
        });
        return;
    }
    
    // التحقق من إدخال العدد
    if (!qty || qty <= 0 || isNaN(qty)) {
        qtyInput.classList.add('field-required-error');
        Swal.fire({
            icon: 'error',
            title: 'حقل مطلوب',
            text: 'يرجى إدخال العدد',
            confirmButtonText: 'حسناً'
        });
        return;
    }
    qtyInput.classList.remove('field-required-error');
    
    // إضافة الحزام كقماش إضافي - بالقطعة فقط (بدون أمتار)
    const fabric = {
        type: 'additional',
        type_display: 'إضافي',
        name: beltName,
        meters: qty,           // العدد فقط (قطع)
        pieces: qty,           // نفس العدد
        tailoring: '',
        tailoring_display: '-',
        item_id: null,
        source: 'belt',
        unit: 'piece'          // وحدة القياس: قطعة
    };
    
    tempFabrics.push(fabric);
    updateFabricsList();
    
    // إعادة تعيين - بدون تحديد أي خيار
    document.getElementById('noBelt').checked = false;
    document.getElementById('scotchBelt').checked = false;
    document.getElementById('normalBelt').checked = false;
    document.getElementById('beltQtyDiv').style.display = 'none';
    document.getElementById('beltQty').value = '';
    
    // رسالة نجاح
    if (typeof Swal !== 'undefined') {
        Swal.fire({
            icon: 'success',
            title: 'تمت الإضافة',
            text: `تم إضافة ${beltName} (${qty} قطعة)`,
            timer: 1500,
            showConfirmButton: false
        });
    }
}

// Toggle accessories fields (legacy support)
function toggleAccessoriesFields() {
    const hasAccessories = document.getElementById('hasAccessories')?.checked || 
                          document.getElementById('withAccessories')?.checked;
    document.getElementById('accessoriesFields').style.display = hasAccessories ? 'block' : 'none';
}

// Toggle between invoice and external accessory
function toggleAccessorySource() {
    const invoiceChecked = document.getElementById('accessoryFromInvoice').checked;
    document.getElementById('accessoryInvoiceSection').style.display = invoiceChecked ? 'block' : 'none';
    document.getElementById('accessoryExternalSection').style.display = invoiceChecked ? 'none' : 'block';
}

// Add accessory from invoice
function addAccessoryFromInvoice() {
    const select = document.getElementById('accessory-from-invoice');
    const itemId = select.value;
    const countInput = document.getElementById('accessory-invoice-quantity');
    const count = parseInt(countInput.value);  // العدد يجب أن يكون عدد صحيح
    const sizeInput = document.getElementById('accessory-invoice-size');
    const sizeContainer = document.getElementById('accessory-invoice-size-container');
    const color = document.getElementById('accessory-invoice-color').value.trim();
    
    // إزالة تنسيق الخطأ السابق
    select.classList.remove('field-required-error');
    countInput.classList.remove('field-required-error');
    sizeInput.classList.remove('field-required-error');
    
    // التحقق من اختيار الإكسسوار
    if (!itemId) {
        select.classList.add('field-required-error');
        Swal.fire({
            icon: 'error',
            title: 'حقل مطلوب',
            text: 'يرجى اختيار الإكسسوار من المرجع',
            confirmButtonText: 'حسناً'
        });
        return;
    }
    
    // التحقق من العدد
    if (!count || count <= 0 || isNaN(count)) {
        countInput.classList.add('field-required-error');
        Swal.fire({
            icon: 'error',
            title: 'حقل مطلوب',
            text: 'يرجى إدخال العدد',
            confirmButtonText: 'حسناً'
        });
        return;
    }
    
    // التحقق من وحدة القياس
    const option = select.options[select.selectedIndex];
    const unit = option?.dataset?.unit || 'piece';
    const isMeterBased = (unit === 'meter' || unit === 'roll');
    
    // إذا كانت الوحدة متر، نستخدم المقاس المدخل، وإلا نستخدم 1
    let size = 1;
    if (isMeterBased) {
        size = parseFloat(sizeInput.value);
        if (!size || size <= 0 || isNaN(size)) {
            sizeInput.classList.add('field-required-error');
            Swal.fire({
                icon: 'error',
                title: 'حقل مطلوب',
                text: 'يرجى إدخال المقاس',
                confirmButtonText: 'حسناً'
            });
            return;
        }
    }
    
    // Calculate total quantity = count × size
    const totalQuantity = count * size;
    
    // Calculate remaining quantity for this item
    calculateUsedQuantities();
    const tracker = fabricUsageTracker[itemId];
    if (!tracker) {
        Swal.fire({
            icon: 'error',
            title: 'خطأ',
            text: 'لم يتم العثور على بيانات العنصر',
            confirmButtonText: 'حسناً'
        });
        return;
    }
    
    const remaining = tracker.total - tracker.used;
    
    if (totalQuantity > remaining + 0.001) {
        if (isMeterBased) {
            Swal.fire({
                icon: 'error',
                title: 'الكمية غير كافية',
                text: `الكمية المطلوبة (${count} × ${size} = ${totalQuantity.toFixed(3)}) أكبر من المتوفر (${remaining.toFixed(3)})`,
                confirmButtonText: 'حسناً'
            });
        } else {
            Swal.fire({
                icon: 'error',
                title: 'الكمية غير كافية',
                text: `العدد المطلوب (${count}) أكبر من المتوفر (${remaining.toFixed(0)})`,
                confirmButtonText: 'حسناً'
            });
        }
        return;
    }
    
    const accessoryName = option.dataset.name;
    
    const accessory = {
        name: accessoryName,
        quantity: totalQuantity,  // Store calculated quantity
        count: count,             // Store count separately for display
        size: isMeterBased ? size : null,  // Store size only if meter-based
        color: color,
        source: 'invoice',
        item_id: itemId,
        unit: unit                // Store unit for reference
    };
    
    tempAccessories.push(accessory);
    updateAccessoriesList();
    
    // Clear - بدون قيم افتراضية
    select.value = '';
    countInput.value = '';
    sizeInput.value = '';
    sizeContainer.style.display = 'block';  // إعادة إظهار حقل المقاس
    document.getElementById('accessory-invoice-color').value = '';
    document.getElementById('accessory-qty-hint').style.display = 'none';
    
    // رسالة نجاح
    Swal.fire({
        icon: 'success',
        title: 'تمت الإضافة',
        text: `تم إضافة ${accessoryName}`,
        timer: 1500,
        showConfirmButton: false
    });
    
    // Recalculate to update available quantities
    calculateUsedQuantities();
}

// Add external accessory
function addExternalAccessory() {
    const nameInput = document.getElementById('accessory-external-name');
    const name = nameInput.value.trim();
    const countInput = document.getElementById('accessory-external-quantity');
    const count = parseInt(countInput.value);  // العدد يجب أن يكون عدد صحيح
    const sizeInput = document.getElementById('accessory-external-size');
    const size = parseFloat(sizeInput.value);
    const color = document.getElementById('accessory-external-color').value.trim();
    
    // إزالة تنسيق الخطأ السابق
    nameInput.classList.remove('field-required-error');
    countInput.classList.remove('field-required-error');
    sizeInput.classList.remove('field-required-error');
    
    if (!name) {
        nameInput.classList.add('field-required-error');
        Swal.fire({
            icon: 'error',
            title: 'حقل مطلوب',
            text: 'يرجى إدخال اسم الإكسسوار',
            confirmButtonText: 'حسناً'
        });
        return;
    }
    
    if (!count || count <= 0 || isNaN(count)) {
        countInput.classList.add('field-required-error');
        Swal.fire({
            icon: 'error',
            title: 'حقل مطلوب',
            text: 'يرجى إدخال العدد',
            confirmButtonText: 'حسناً'
        });
        return;
    }
    
    if (!size || size <= 0 || isNaN(size)) {
        sizeInput.classList.add('field-required-error');
        Swal.fire({
            icon: 'error',
            title: 'حقل مطلوب',
            text: 'يرجى إدخال المقاس',
            confirmButtonText: 'حسناً'
        });
        return;
    }
    
    // Calculate total quantity = count × size
    const totalQuantity = count * size;
    
    const accessory = {
        name: name,
        quantity: totalQuantity,  // Store calculated quantity
        count: count,             // Store count separately for display
        size: size,               // Store size as number
        color: color,
        source: 'external'
    };
    
    tempAccessories.push(accessory);
    updateAccessoriesList();
    
    // Clear - بدون قيم افتراضية
    nameInput.value = '';
    countInput.value = '';
    sizeInput.value = '';
    document.getElementById('accessory-external-color').value = '';
    
    // رسالة نجاح
    Swal.fire({
        icon: 'success',
        title: 'تمت الإضافة',
        text: `تم إضافة ${name}`,
        timer: 1500,
        showConfirmButton: false
    });
}

// Update accessory quantity info
function updateAccessoryQuantityInfo(select) {
    const selectedOption = select.options[select.selectedIndex];
    const selectedItemId = select.value;
    const sizeContainer = document.getElementById('accessory-invoice-size-container');
    const sizeInput = document.getElementById('accessory-invoice-size');
    
    // التحقق من وحدة القياس
    if (selectedOption && selectedOption.dataset.unit) {
        const unit = selectedOption.dataset.unit;
        // إذا كانت الوحدة متر، نظهر حقل المقاس
        if (unit === 'meter' || unit === 'roll') {
            sizeContainer.style.display = 'block';
            // لا نضع قيمة افتراضية
        } else {
            // إذا كانت الوحدة قطعة أو غيرها، نخفي حقل المقاس ونضع القيمة 1 (داخلياً فقط)
            sizeContainer.style.display = 'none';
            sizeInput.value = '1';
        }
    } else {
        // إذا لم يتم اختيار عنصر، نظهر الحقل بشكل افتراضي
        sizeContainer.style.display = 'block';
        // لا نضع قيمة افتراضية
    }
    
    if (!selectedItemId || !fabricUsageTracker[selectedItemId]) {
        document.getElementById('accessory-qty-hint').style.display = 'none';
        return;
    }
    
    calculateUsedQuantities();
    
    const tracker = fabricUsageTracker[selectedItemId];
    const remaining = tracker.total - tracker.used;
    
    document.getElementById('remaining-acc-qty').textContent = remaining.toFixed(3).replace(/\.?0+$/, '');
    document.getElementById('accessory-qty-hint').style.display = 'block';
    
    // لا نملأ الكمية تلقائياً - نترك الحقل فارغاً للمستخدم
    // const quantityInput = document.getElementById('accessory-invoice-quantity');
}


// Handle custom accessory name
document.addEventListener('DOMContentLoaded', function() {
    const accessorySelect = document.getElementById('accessory-name');
    if (accessorySelect) {
        accessorySelect.addEventListener('change', function() {
            const customDiv = document.getElementById('customAccessoryName');
            if (this.value === 'other') {
                customDiv.style.display = 'block';
            } else {
                customDiv.style.display = 'none';
            }
        });
    }
    
    // Initialize fabric usage tracker and update select options on page load
    calculateUsedQuantities();
    
    // Listen for modal shown event to refresh quantities
    const addCurtainModal = document.getElementById('addCurtainModal');
    if (addCurtainModal) {
        addCurtainModal.addEventListener('show.bs.modal', function() {
            // Reset temp arrays when opening modal for new curtain
            if (!editingCurtainId) {
                tempFabrics = [];
                tempAccessories = [];
            }
            // Recalculate and update select options
            calculateUsedQuantities();
        });
    }
});

// Add accessory to list
function addAccessoryToList() {
    let accessoryName = document.getElementById('accessory-name').value;
    const quantity = parseInt(document.getElementById('accessory-quantity').value);
    const color = document.getElementById('accessory-color').value.trim();
    
    if (!accessoryName) {
        alert('يرجى اختيار الإكسسوار');
        return;
    }
    
    if (accessoryName === 'other') {
        const customName = document.getElementById('accessory-custom-name').value.trim();
        if (!customName) {
            alert('يرجى إدخال اسم الإكسسوار');
            return;
        }
        accessoryName = customName;
    } else {
        accessoryName = document.getElementById('accessory-name').options[document.getElementById('accessory-name').selectedIndex].text;
    }
    
    if (!quantity || quantity <= 0) {
        alert('يرجى إدخال كمية صحيحة');
        return;
    }
    
    const accessory = {
        name: accessoryName,
        quantity: quantity,
        color: color
    };
    
    tempAccessories.push(accessory);
    updateAccessoriesList();
    
    // Clear form
    document.getElementById('accessory-name').value = '';
    document.getElementById('accessory-quantity').value = '1';
    document.getElementById('accessory-color').value = '';
    document.getElementById('customAccessoryName').style.display = 'none';
    document.getElementById('accessory-custom-name').value = '';
}

function updateAccessoriesList() {
    const list = document.getElementById('accessoriesList');
    
    if (tempAccessories.length === 0) {
        list.innerHTML = '<div class="alert alert-info">لم يتم إضافة إكسسوارات بعد</div>';
        return;
    }
    
    let html = '';
    tempAccessories.forEach((accessory, index) => {
        const colorText = accessory.color ? ` - <span class="badge bg-info">${accessory.color}</span>` : '';
        
        // إظهار نوع الإكسسوار (مثل: حامل حائط 15 سنتم)
        let typeDisplay = '';
        if (accessory.display_type) {
            typeDisplay = `<span class="badge bg-warning text-dark me-2">${accessory.display_type}</span>`;
        }
        
        // Show count × size if size is available, otherwise show just count
        let quantityDisplay = '';
        // المقاس يظهر فقط إذا كان موجوداً وأكبر من 0 ومختلف عن العدد
        const hasValidSize = accessory.size !== null && accessory.size !== undefined && parseFloat(accessory.size) > 0;
        
        if (hasValidSize && accessory.count) {
            // منتج يُقاس بالمتر - عرض العدد × المقاس
            const countFormatted = parseFloat(accessory.count).toFixed(0);
            const sizeFormatted = parseFloat(accessory.size).toFixed(3).replace(/\.?0+$/, '');
            const totalFormatted = parseFloat(accessory.quantity).toFixed(3).replace(/\.?0+$/, '');
            quantityDisplay = `العدد: ${countFormatted} × المقاس: ${sizeFormatted}م = <strong>${totalFormatted}م</strong>`;
        } else if (accessory.count) {
            // منتج يُقاس بالعدد - عرض العدد فقط
            const countFormatted = parseFloat(accessory.count).toFixed(0);
            quantityDisplay = `العدد: <strong>${countFormatted}</strong> قطعة`;
        } else {
            // حالة احتياطية
            const quantityFormatted = parseFloat(accessory.quantity).toFixed(3).replace(/\.?0+$/, '');
            quantityDisplay = `الكمية: ${quantityFormatted}`;
        }
        
        // تحديد لون الحدود حسب المصدر
        let borderClass = 'border-primary';
        let sourceIcon = '';
        if (accessory.source === 'invoice') {
            borderClass = 'border-success';
            sourceIcon = '<i class="fas fa-file-invoice text-success me-1" title="من المرجع"></i>';
        } else if (accessory.source === 'external') {
            borderClass = 'border-warning';
            sourceIcon = '<i class="fas fa-plus-circle text-warning me-1" title="خارجي"></i>';
        }
        
        html += `
            <div class="card mb-2 ${borderClass}">
                <div class="card-body py-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            ${sourceIcon}<strong>${accessory.name}</strong>${colorText}
                            <br>
                            <small class="text-muted">${typeDisplay}${quantityDisplay}</small>
                        </div>
                        <button type="button" class="btn btn-sm btn-danger" onclick="removeAccessory(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    
    list.innerHTML = html;
}

function removeAccessory(index) {
    tempAccessories.splice(index, 1);
    updateAccessoriesList();
    // Recalculate to update available quantities
    calculateUsedQuantities();
    updateCommonAccessorySelects();
}

// Save complete curtain with fabrics and accessories
function saveCurtainComplete() {
    const roomName = document.getElementById('curtain-room-name').value.trim();
    const width = parseFloat(document.getElementById('curtain-width').value);
    const height = parseFloat(document.getElementById('curtain-height').value);
    const installationType = document.getElementById('curtain-installation-type').value;
    const notes = document.getElementById('curtain-notes').value.trim();
    
    // إزالة الأخطاء السابقة
    document.querySelectorAll('.field-required-error').forEach(el => {
        el.classList.remove('field-required-error');
    });
    document.querySelectorAll('.field-error-message').forEach(el => el.remove());
    document.querySelectorAll('.field-error-icon').forEach(el => el.remove());
    
    const missingFields = [];
    let hasErrors = false;
    
    // التحقق من الحقول الأساسية
    if (!roomName) {
        hasErrors = true;
        missingFields.push('اسم الغرفة');
        const field = document.getElementById('curtain-room-name');
        field.classList.add('field-required-error');
        addFieldErrorIcon(field, 'اسم الغرفة مطلوب');
    }
    
    if (!width || width <= 0) {
        hasErrors = true;
        missingFields.push('العرض');
        const field = document.getElementById('curtain-width');
        field.classList.add('field-required-error');
        addFieldErrorIcon(field, 'العرض مطلوب');
    }
    
    if (!height || height <= 0) {
        hasErrors = true;
        missingFields.push('الارتفاع');
        const field = document.getElementById('curtain-height');
        field.classList.add('field-required-error');
        addFieldErrorIcon(field, 'الارتفاع مطلوب');
    }
    
    if (!installationType) {
        hasErrors = true;
        missingFields.push('نوع التركيب');
        const field = document.getElementById('curtain-installation-type');
        field.classList.add('field-required-error');
        addFieldErrorIcon(field, 'نوع التركيب مطلوب');
    }
    
    // ✨ التحقق من وجود قماش واحد على الأقل (إلزامي)
    if (!tempFabrics || tempFabrics.length === 0) {
        hasErrors = true;
        missingFields.push('قماش واحد على الأقل');
        
        // تلوين قسم الأقمشة
        const fabricsSection = document.getElementById('fabricsSection');
        if (fabricsSection) {
            fabricsSection.classList.add('field-required-error');
            fabricsSection.style.border = '2px solid #dc3545';
            fabricsSection.style.borderRadius = '8px';
            fabricsSection.style.padding = '10px';
            fabricsSection.style.backgroundColor = '#fff5f5';
            fabricsSection.style.animation = 'shake 0.5s ease-in-out';
        }
    }
    
    // إذا كانت هناك أخطاء، عرض التنبيه
    if (hasErrors) {
        if (typeof Swal !== 'undefined') {
            Swal.fire({
                icon: 'warning',
                title: 'حقول مطلوبة',
                html: `
                    <div class="text-end">
                        <p class="mb-3">يرجى ملء الحقول التالية:</p>
                        <ul class="list-unstyled text-danger">
                            ${missingFields.map(f => `<li><i class="fas fa-times-circle me-2"></i>${f}</li>`).join('')}
                        </ul>
                    </div>
                `,
                confirmButtonText: 'حسناً',
                confirmButtonColor: '#dc3545'
            });
        } else {
            alert('يرجى ملء الحقول التالية:\n' + missingFields.join('\n'));
        }
        return;
    }
    
    // Prepare curtain data
    const curtainData = {
        room_name: roomName,
        width: width,
        height: height,
        installation_type: installationType,
        fabrics: tempFabrics,
        accessories: tempAccessories,
        notes: notes
    };
    
    // Add curtain box fields if applicable
    if (installationType === 'curtain_box_concrete' || installationType === 'curtain_box_gypsum') {
        const boxWidth = parseFloat(document.getElementById('curtain-box-width').value);
        const boxDepth = parseFloat(document.getElementById('curtain-box-depth').value);
        
        if (!boxWidth || !boxDepth) {
            alert('يرجى إدخال عرض وعمق بيت الستارة');
            return;
        }
        
        curtainData.curtain_box_width = boxWidth;
        curtainData.curtain_box_depth = boxDepth;
    }
    
    // Determine URL based on edit mode
    const url = editingCurtainId 
        ? `{% url "orders:wizard_edit_curtain" 0 %}`.replace('0', editingCurtainId)
        : '{% url "orders:wizard_add_curtain" %}';
    
    // Send to server
    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify(curtainData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Reset and reload
            resetCurtainModal();
            location.reload();
        } else {
            alert(data.message || 'حدث خطأ أثناء حفظ الستارة');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('حدث خطأ أثناء حفظ الستارة');
    });
}

function resetCurtainModal() {
    tempFabrics = [];
    tempAccessories = [];
    editingCurtainId = null; // Reset edit mode
    document.getElementById('curtain-room-name').value = '';
    document.getElementById('curtain-width').value = '';
    document.getElementById('curtain-height').value = '';
    document.getElementById('curtain-installation-type').value = '';
    document.getElementById('curtain-box-width').value = '';
    document.getElementById('curtain-box-depth').value = '';
    document.getElementById('curtain-notes').value = '';
    document.getElementById('curtainBoxFields').style.display = 'none';
    
    // إعادة تعيين خيارات الإكسسوار - بدون تحديد أي خيار
    const hasAccessoriesEl = document.getElementById('hasAccessories');
    if (hasAccessoriesEl) hasAccessoriesEl.checked = false;
    const withAccessoriesEl = document.getElementById('withAccessories');
    if (withAccessoriesEl) withAccessoriesEl.checked = false;
    const noAccessoriesEl = document.getElementById('noAccessories');
    if (noAccessoriesEl) noAccessoriesEl.checked = false;
    
    document.getElementById('curtainBasicInfo').style.display = 'block';
    document.getElementById('fabricsSection').style.display = 'none';
    document.getElementById('accessoriesSection').style.display = 'none';
    document.getElementById('notesSection').style.display = 'none';
    document.getElementById('accessoriesFields').style.display = 'none';
    
    // إعادة تعيين خيارات الحزام - بدون تحديد أي خيار
    const noBeltEl = document.getElementById('noBelt');
    if (noBeltEl) noBeltEl.checked = false;
    const scotchBeltEl = document.getElementById('scotchBelt');
    if (scotchBeltEl) scotchBeltEl.checked = false;
    const normalBeltEl = document.getElementById('normalBelt');
    if (normalBeltEl) normalBeltEl.checked = false;
    const beltQtyDiv = document.getElementById('beltQtyDiv');
    if (beltQtyDiv) beltQtyDiv.style.display = 'none';
    const beltQty = document.getElementById('beltQty');
    if (beltQty) beltQty.value = '';
    
    // إعادة تعيين الإكسسوارات الشائعة الجديدة
    // إعادة تعيين خيارات الراديو للحوامل الرئيسية
    ['wallBracket', 'majar', 'pipe'].forEach(type => {
        // إلغاء تحديد جميع الراديو وتحديث الألوان
        document.querySelectorAll(`input[name="${type}Choice"]`).forEach(radio => {
            radio.checked = false;
        });
        updateCommonAccessoryButtonColors(type, null);
        
        // إخفاء حقول الإدخال
        const fieldsDiv = document.getElementById(`${type}Fields`);
        if (fieldsDiv) fieldsDiv.style.display = 'none';
        // إخفاء حقل الطول
        const sizeDiv = document.getElementById(`${type}SizeDiv`);
        if (sizeDiv) sizeDiv.style.display = 'none';
        // إخفاء حقل الإضافة الخارجية
        const externalDiv = document.getElementById(`${type}ExternalDiv`);
        if (externalDiv) externalDiv.style.display = 'none';
        // إعادة تعيين القيم
        ['Select', 'Qty', 'Size', 'ExternalName'].forEach(suffix => {
            const el = document.getElementById(`${type}${suffix}`);
            if (el) el.value = '';
        });
    });
    
    // إعادة تعيين الإكسسوارات الأخرى (مسامير عصفورة، فرانشة، شماعات)
    ['birdScrews', 'franche', 'hangers'].forEach(type => {
        // إلغاء تحديد جميع الراديو وتحديث الألوان
        document.querySelectorAll(`input[name="${type}Choice"]`).forEach(radio => {
            radio.checked = false;
        });
        updateOtherAccessoryButtonColors(type, null);
        
        // إخفاء حقول الإدخال
        const fieldsDiv = document.getElementById(`${type}Fields`);
        if (fieldsDiv) fieldsDiv.style.display = 'none';
        // إخفاء حقل الإضافة الخارجية
        const externalDiv = document.getElementById(`${type}ExternalDiv`);
        if (externalDiv) externalDiv.style.display = 'none';
        // إعادة تعيين القيم
        ['Select', 'Qty', 'ExternalName'].forEach(suffix => {
            const el = document.getElementById(`${type}${suffix}`);
            if (el) el.value = '';
        });
    });
    
    // Update modal title
    document.querySelector('#addCurtainModal .modal-title').innerHTML = '<i class="fas fa-plus me-2"></i>إضافة ستارة جديدة';
}

// Edit curtain function
function editCurtain(curtainId) {
    // Set edit mode FIRST before any async operations
    editingCurtainId = curtainId;
    
    // Fetch curtain data
    fetch(`{% url 'orders:wizard_edit_curtain' 0 %}`.replace('0', curtainId), {
        method: 'GET',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update modal title
            document.querySelector('#addCurtainModal .modal-title').innerHTML = '<i class="fas fa-edit me-2"></i>تعديل الستارة';
            
            // Fill basic info
            document.getElementById('curtain-room-name').value = data.curtain.room_name;
            document.getElementById('curtain-width').value = data.curtain.width;
            document.getElementById('curtain-height').value = data.curtain.height;
            document.getElementById('curtain-installation-type').value = data.curtain.installation_type || '';
            
            // Fill curtain box fields if present
            if (data.curtain.curtain_box_width) {
                document.getElementById('curtain-box-width').value = data.curtain.curtain_box_width;
            }
            if (data.curtain.curtain_box_depth) {
                document.getElementById('curtain-box-depth').value = data.curtain.curtain_box_depth;
            }
            
            // Fill notes if present
            if (data.curtain.notes) {
                document.getElementById('curtain-notes').value = data.curtain.notes;
            }
            
            // Toggle curtain box fields visibility
            toggleCurtainBoxFields();
            
            // Load fabrics
            tempFabrics = data.curtain.fabrics || [];
            
            // Load accessories
            tempAccessories = data.curtain.accessories || [];
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('addCurtainModal'));
            modal.show();
            
            // التمرير إلى أعلى الصفحة عند فتح النافذة
            setTimeout(function() {
                const modalElement = document.getElementById('addCurtainModal');
                const modalBody = modalElement.querySelector('.modal-body');
                
                // إعادة تمرير محتوى النافذة إلى الأعلى
                if (modalBody) {
                    modalBody.scrollTop = 0;
                }
                
                // إعادة تمرير الصفحة إلى الأعلى لرؤية النافذة
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            }, 100);
            
            // Go directly to fabrics section if there are fabrics
            if (tempFabrics.length > 0) {
                showFabricsSection();
                updateFabricsList();
            }
            
            // Show accessories section if there are accessories
            if (tempAccessories.length > 0) {
                showAccessoriesSection(true); // Skip fabric check when loading from edit
                updateAccessoriesList();
            }
            
            // Recalculate used quantities after loading edit data
            calculateUsedQuantities();
        } else {
            alert(data.message || 'حدث خطأ أثناء تحميل بيانات الستارة');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('حدث خطأ أثناء تحميل بيانات الستارة');
    });
}

// Reset modal when closed
$('#addCurtainModal').on('hidden.bs.modal', function() {
    resetCurtainModal();
    // Recalculate quantities after modal is closed
    calculateUsedQuantities();
});

// إعادة تمرير النافذة إلى الأعلى عند فتحها
$('#addCurtainModal').on('show.bs.modal', function() {
    // التمرير إلى أعلى الصفحة فوراً
    $('html, body').scrollTop(0);
});

$('#addCurtainModal').on('shown.bs.modal', function() {
    // إعادة تمرير محتوى النافذة إلى الأعلى
    $(this).find('.modal-body').scrollTop(0);
    
    // Recalculate quantities after modal is fully shown
    calculateUsedQuantities();
    
    // تحديث قوائم الإكسسوارات الشائعة لإظهار الكميات الفعلية
    updateCommonAccessorySelects();
});

function removeCurtain(curtainId) {
    if (!confirm('هل أنت متأكد من حذف هذه الستارة؟')) {
        return;
    }
    
    fetch(`{% url 'orders:wizard_remove_curtain' 0 %}`.replace('0', curtainId), {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // إعادة تحميل الصفحة لتحديث الكميات المتاحة
            location.reload();
        } else {
            alert(data.message || 'حدث خطأ أثناء حذف الستارة');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('حدث خطأ أثناء حذف الستارة');
    });
}

function uploadContractFile() {
    const fileInput = document.getElementById('contractFileInput');
    
    if (!fileInput || !fileInput.files || !fileInput.files[0]) {
        alert('يرجى اختيار ملف');
        return;
    }
    
    const file = fileInput.files[0];
    
    if (!file.name.toLowerCase().endsWith('.pdf')) {
        alert('يجب أن يكون الملف بصيغة PDF');
        fileInput.value = ''; // إعادة تعيين الحقل
        return;
    }
    
    // إظهار مؤشر التحميل
    const uploadProgress = document.getElementById('uploadProgress');
    if (uploadProgress) {
        uploadProgress.style.display = 'block';
    }
    
    const formData = new FormData();
    formData.append('contract_file', file);
    
    fetch('{% url "orders:wizard_upload_contract" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (uploadProgress) {
            uploadProgress.style.display = 'none';
        }
        
        if (data.success) {
            // إعادة تحميل الصفحة لعرض الملف المرفوع
            location.reload();
        } else {
            alert(data.message || 'حدث خطأ أثناء رفع الملف');
            fileInput.value = ''; // إعادة تعيين الحقل
        }
    })
    .catch(error => {
        if (uploadProgress) {
            uploadProgress.style.display = 'none';
        }
        console.error('Error:', error);
        alert('حدث خطأ أثناء رفع الملف');
        fileInput.value = ''; // إعادة تعيين الحقل
    });
}

function proceedToNextStep() {
    // التحقق من وجود عقد (إلكتروني أو PDF)
    const hasElectronicContract = document.querySelectorAll('.curtain-card').length > 0;
    const hasPdfContract = {% if draft.contract_file %}true{% else %}false{% endif %};
    
    if (!hasElectronicContract && !hasPdfContract) {
        // لم يتم إضافة أي عقد - التأكيد من المستخدم
        if (confirm('لم تقم بإضافة عقد. هل تريد المتابعة بدون عقد؟')) {
            // الانتقال إلى الخطوة التالية
            window.location.href = '{% url "orders:wizard_step" step=6 %}';
        }
    } else {
        // تم إضافة عقد - حفظ الخطوة والانتقال
        fetch('{% url "orders:wizard_step" step=5 %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => {
            // الانتقال إلى الخطوة التالية
            window.location.href = '{% url "orders:wizard_step" step=6 %}';
        })
        .catch(error => {
            console.error('Error:', error);
            // الانتقال رغم الخطأ
            window.location.href = '{% url "orders:wizard_step" step=6 %}';
        });
    }
}

function removeContractFile() {
    if (!confirm('هل أنت متأكد من حذف ملف العقد؟')) {
        return;
    }
    
    fetch('{% url "orders:wizard_remove_contract_file" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('تم حذف الملف بنجاح');
            location.reload();
        } else {
            alert(data.message || 'حدث خطأ أثناء حذف الملف');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('حدث خطأ أثناء حذف الملف');
    });
}
</script>
{% endblock %}
