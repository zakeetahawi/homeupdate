{% extends 'orders/wizard/base_wizard.html' %}
{% load static %}

{% block wizard_content %}
<form method="post" id="step4-form">
    {% csrf_token %}
    
    <div class="row">
        <div class="col-md-6">
            <h5 class="mb-3">
                <i class="fas fa-file-invoice me-2"></i>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø±Ø¬Ø¹
            </h5>
            
            <!-- Invoice Numbers -->
            <div class="mb-3">
                <label for="{{ form.invoice_number.id_for_label }}" class="form-label fw-bold">
                    <i class="fas fa-receipt me-2"></i>Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
                </label>
                {{ form.invoice_number }}
                {% if form.invoice_number.errors %}
                    <div class="text-danger mt-1">{{ form.invoice_number.errors }}</div>
                {% endif %}
            </div>
            
            <div class="mb-3">
                <label for="{{ form.invoice_number_2.id_for_label }}" class="form-label">
                    Ø±Ù‚Ù… Ù…Ø±Ø¬Ø¹ Ø¥Ø¶Ø§ÙÙŠ 1
                </label>
                {{ form.invoice_number_2 }}
            </div>
            
            <div class="mb-3">
                <label for="{{ form.invoice_number_3.id_for_label }}" class="form-label">
                    Ø±Ù‚Ù… Ù…Ø±Ø¬Ø¹ Ø¥Ø¶Ø§ÙÙŠ 2
                </label>
                {{ form.invoice_number_3 }}
            </div>
        </div>
        
        <div class="col-md-6">
            <h5 class="mb-3">
                <i class="fas fa-money-bill-wave me-2"></i>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¯ÙØ¹
            </h5>
            
            <!-- Payment Summary -->
            <div class="alert alert-info mb-4">
                <h6 class="alert-heading">Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø¨Ø§Ù„Øº</h6>
                <div class="d-flex justify-content-between mb-2">
                    <span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ù‚Ø¨Ù„ Ø§Ù„Ø®ØµÙ…:</span>
                    <strong>{{ totals.subtotal }} Ø¬Ù†ÙŠÙ‡</strong>
                </div>
                <div class="d-flex justify-content-between mb-2 text-danger">
                    <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø®ØµÙ…:</span>
                    <strong>{{ totals.total_discount }} Ø¬Ù†ÙŠÙ‡</strong>
                </div>
                <hr>
                <div class="d-flex justify-content-between">
                    <span class="h6">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:</span>
                    <strong class="h6 text-success">{{ totals.final_total }} Ø¬Ù†ÙŠÙ‡</strong>
                </div>
            </div>
            
            <!-- Payment Method -->
            <div class="mb-3">
                <label for="{{ form.payment_method.id_for_label }}" class="form-label fw-bold">
                    <i class="fas fa-credit-card me-2"></i>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹
                </label>
                {{ form.payment_method }}
            </div>
            
            <!-- Paid Amount -->
            <div class="mb-3">
                <label for="{{ form.paid_amount.id_for_label }}" class="form-label fw-bold">
                    <i class="fas fa-dollar-sign me-2"></i>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹
                    <span class="text-danger">*</span>
                </label>
                {{ form.paid_amount }}
                {% if form.paid_amount.errors %}
                    <div class="alert alert-danger mt-2 py-2">
                        <i class="fas fa-exclamation-circle me-1"></i>
                        {{ form.paid_amount.errors }}
                    </div>
                {% endif %}
                <div class="alert alert-warning mt-2 py-2">
                    <i class="fas fa-lightbulb me-1"></i>
                    <strong>ğŸ’¡ ØªÙ†Ø¨ÙŠÙ‡:</strong> ÙŠØ¬Ø¨ Ø¯ÙØ¹ 50% Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ© Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©
                    <br>
                    <small>Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: <strong>{{ totals.minimum_payment|default:"0.00" }} Ø¬Ù†ÙŠÙ‡</strong></small>
                </div>
                <div class="form-text">
                    <i class="fas fa-info-circle me-1"></i>
                    Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: <span id="remaining-amount">{{ totals.remaining }}</span> Ø¬Ù†ÙŠÙ‡
                </div>
            </div>
            
            <!-- Payment Notes -->
            <div class="mb-3">
                <label for="{{ form.payment_notes.id_for_label }}" class="form-label">
                    <i class="fas fa-sticky-note me-2"></i>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¯ÙØ¹
                </label>
                {{ form.payment_notes }}
            </div>
        </div>
    </div>
    
    <!-- Actions -->
    <div class="wizard-actions">
        <div>
            <a href="{% url 'orders:wizard_cancel' %}" class="btn btn-wizard btn-wizard-danger me-2">
                <i class="fas fa-times me-2"></i>Ø¥Ù„ØºØ§Ø¡
            </a>
            <a href="{% url 'orders:wizard_step' step=3 %}" class="btn btn-wizard btn-wizard-secondary">
                <i class="fas fa-arrow-right me-2"></i>Ø§Ù„Ø³Ø§Ø¨Ù‚
            </a>
        </div>
        <div>
            <button type="submit" class="btn btn-wizard btn-wizard-primary">
                <i class="fas fa-arrow-left me-2"></i>Ø§Ù„ØªØ§Ù„ÙŠ
            </button>
        </div>
    </div>
</form>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
// Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
const totalAmount = {{ totals.final_total }};
const minimumPayment = {{ totals.minimum_payment }};
const paidAmountInput = document.getElementById('{{ form.paid_amount.id_for_label }}');

paidAmountInput.addEventListener('input', function() {
    const paidAmount = parseFloat(this.value) || 0;
    const remaining = totalAmount - paidAmount;
    
    document.getElementById('remaining-amount').textContent = remaining.toFixed(2);
    
    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
    this.classList.remove('is-invalid', 'is-valid');
    
    // ØªØ­Ø°ÙŠØ± Ø¥Ø°Ø§ ØªØ¬Ø§ÙˆØ² Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
    if (paidAmount > totalAmount) {
        this.classList.add('is-invalid');
    } else if (paidAmount >= minimumPayment) {
        this.classList.add('is-valid');
    } else if (paidAmount > 0) {
        this.classList.add('is-invalid');
    }
});

// Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
document.getElementById('step4-form').addEventListener('submit', function(e) {
    const paidAmount = parseFloat(paidAmountInput.value) || 0;
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰
    if (paidAmount < minimumPayment) {
        e.preventDefault();
        alert('âš ï¸ ÙŠØ¬Ø¨ Ø¯ÙØ¹ 50% Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ\n' + 
              'Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: ' + minimumPayment.toFixed(2) + ' Ø¬Ù†ÙŠÙ‡\n' +
              'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹: ' + paidAmount.toFixed(2) + ' Ø¬Ù†ÙŠÙ‡');
        paidAmountInput.focus();
        return false;
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
    if (paidAmount > totalAmount) {
        e.preventDefault();
        alert('âŒ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠØªØ¬Ø§ÙˆØ² Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ\n' +
              'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: ' + totalAmount.toFixed(2) + ' Ø¬Ù†ÙŠÙ‡');
        paidAmountInput.focus();
        return false;
    }
    
    submitWizardStep(this);
});
</script>
{% endblock %}
