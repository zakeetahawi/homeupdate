{% extends 'orders/wizard/base_wizard.html' %}
{% load static %}

{% block wizard_content %}
<form method="post" id="step4-form" enctype="multipart/form-data">
    {% csrf_token %}
    
    <div class="row">
        <div class="col-md-6">
            <h5 class="mb-3">
                <i class="fas fa-file-invoice me-2"></i>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø±Ø¬Ø¹
            </h5>
            
            <!-- Invoice Numbers -->
            <div class="mb-3">
                <label for="{{ form.invoice_number.id_for_label }}" class="form-label fw-bold">
                    <i class="fas fa-receipt me-2"></i>Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
                    <span class="text-danger">*</span>
                </label>
                {{ form.invoice_number }}
                <div id="invoice-number-warning" class="mt-2" style="display: none;"></div>
                {% if form.invoice_number.errors %}
                    <div class="text-danger mt-1">{{ form.invoice_number.errors }}</div>
                {% endif %}
            </div>
            
            <div class="mb-3">
                <label for="{{ form.invoice_number_2.id_for_label }}" class="form-label">
                    Ø±Ù‚Ù… Ù…Ø±Ø¬Ø¹ Ø¥Ø¶Ø§ÙÙŠ 1
                </label>
                {{ form.invoice_number_2 }}
            </div>
            
            <div class="mb-3">
                <label for="{{ form.invoice_number_3.id_for_label }}" class="form-label">
                    Ø±Ù‚Ù… Ù…Ø±Ø¬Ø¹ Ø¥Ø¶Ø§ÙÙŠ 2
                </label>
                {{ form.invoice_number_3 }}
            </div>
            
            <!-- Invoice Image -->
            <div class="mb-3">
                <label for="{{ form.invoice_image.id_for_label }}" class="form-label fw-bold">
                    <i class="fas fa-image me-2"></i>ØµÙˆØ±Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©
                    {% if draft.selected_type != 'inspection' %}
                    <span class="text-danger">*</span>
                    {% endif %}
                </label>
                {{ form.invoice_image }}
                {% if draft.invoice_image %}
                    <div class="mt-2">
                        <a href="{{ draft.invoice_image.url }}" target="_blank" class="btn btn-sm btn-outline-success">
                            <i class="fas fa-eye me-1"></i>Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
                        </a>
                    </div>
                {% endif %}
                {% if form.invoice_image.errors %}
                    <div class="text-danger mt-1">{{ form.invoice_image.errors }}</div>
                {% endif %}
                <div class="form-text">
                    <i class="fas fa-info-circle me-1"></i>
                    ÙŠÙØ³Ù…Ø­ Ø¨ØµÙˆØ± JPG, PNG, GIF, WEBP - Ø£Ù‚ØµÙ‰ Ø­Ø¬Ù… 10 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <h5 class="mb-3">
                <i class="fas fa-money-bill-wave me-2"></i>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¯ÙØ¹
            </h5>
            
            <!-- Payment Summary -->
            <div class="alert alert-info mb-4">
                <h6 class="alert-heading">Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø¨Ø§Ù„Øº</h6>
                <div class="d-flex justify-content-between mb-2">
                    <span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ù‚Ø¨Ù„ Ø§Ù„Ø®ØµÙ…:</span>
                    <strong>{{ totals.subtotal }} Ø¬Ù†ÙŠÙ‡</strong>
                </div>
                <div class="d-flex justify-content-between mb-2 text-danger">
                    <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø®ØµÙ…:</span>
                    <strong>{{ totals.total_discount }} Ø¬Ù†ÙŠÙ‡</strong>
                </div>
                <hr>
                <div class="d-flex justify-content-between">
                    <span class="h6">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:</span>
                    <strong class="h6 text-success">{{ totals.final_total }} Ø¬Ù†ÙŠÙ‡</strong>
                </div>
            </div>
            
            <!-- Payment Method -->
            <div class="mb-3">
                <label for="{{ form.payment_method.id_for_label }}" class="form-label fw-bold">
                    <i class="fas fa-credit-card me-2"></i>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹
                </label>
                {{ form.payment_method }}
            </div>
            
            <!-- Paid Amount -->
            <div class="mb-3">
                <label for="{{ form.paid_amount.id_for_label }}" class="form-label fw-bold">
                    <i class="fas fa-dollar-sign me-2"></i>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹
                    <span class="text-danger">*</span>
                </label>
                {{ form.paid_amount }}
                {% if form.paid_amount.errors %}
                    <div class="alert alert-danger mt-2 py-2">
                        <i class="fas fa-exclamation-circle me-1"></i>
                        {{ form.paid_amount.errors }}
                    </div>
                {% endif %}
                <div class="alert alert-warning mt-2 py-2">
                    <i class="fas fa-lightbulb me-1"></i>
                    <strong>ğŸ’¡ ØªÙ†Ø¨ÙŠÙ‡:</strong> ÙŠØ¬Ø¨ Ø¯ÙØ¹ 50% Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ© Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©
                    <br>
                    <small>Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: <strong>{{ totals.minimum_payment|default:"0.00" }} Ø¬Ù†ÙŠÙ‡</strong></small>
                </div>
                <div class="form-text">
                    <i class="fas fa-info-circle me-1"></i>
                    Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: <span id="remaining-amount">{{ totals.remaining }}</span> Ø¬Ù†ÙŠÙ‡
                </div>
            </div>
            
            <!-- Payment Notes -->
            <div class="mb-3">
                <label for="{{ form.payment_notes.id_for_label }}" class="form-label">
                    <i class="fas fa-sticky-note me-2"></i>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¯ÙØ¹
                </label>
                {{ form.payment_notes }}
            </div>
        </div>
    </div>
    
    <!-- Actions -->
    <div class="wizard-actions">
        <div>
            <a href="{% url 'orders:wizard_cancel' %}" class="btn btn-wizard btn-wizard-danger me-2">
                <i class="fas fa-times me-2"></i>Ø¥Ù„ØºØ§Ø¡
            </a>
            <a href="{% url 'orders:wizard_step' step=3 %}" class="btn btn-wizard btn-wizard-secondary">
                <i class="fas fa-arrow-right me-2"></i>Ø§Ù„Ø³Ø§Ø¨Ù‚
            </a>
        </div>
        <div>
            <button type="submit" class="btn btn-wizard btn-wizard-primary" id="submit-btn">
                <i class="fas fa-arrow-left me-2"></i>Ø§Ù„ØªØ§Ù„ÙŠ
            </button>
        </div>
    </div>
</form>

<!-- Sweet Alert for duplicate warning -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
// Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ÙˆØ¯Ø©
const customerId = {{ draft.customer.id|default:"null" }};
const orderType = "{{ draft.selected_type|default:'' }}";
const checkInvoiceUrl = "{% url 'orders:check_invoice_number_api' %}";

// Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
const totalAmount = {{ totals.final_total }};
const minimumPayment = {{ totals.minimum_payment }};
const paidAmountInput = document.getElementById('{{ form.paid_amount.id_for_label }}');
const invoiceNumberInput = document.getElementById('{{ form.invoice_number.id_for_label }}') || 
                           document.getElementById('id_invoice_number') ||
                           document.querySelector('[name="invoice_number"]');

// Ù…ØªØºÙŠØ± Ù„ØªØªØ¨Ø¹ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚
let invoiceNumberValid = true;
let checkTimeout = null;

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ Ø¹Ù†Ø¯ Ø§Ù„ÙƒØªØ§Ø¨Ø©
if (invoiceNumberInput) {
    invoiceNumberInput.addEventListener('input', function() {
        // Ø¥Ù„ØºØ§Ø¡ Ø£ÙŠ ØªØ­Ù‚Ù‚ Ø³Ø§Ø¨Ù‚
        if (checkTimeout) {
            clearTimeout(checkTimeout);
        }
        
        // ØªØ£Ø®ÙŠØ± Ø§Ù„ØªØ­Ù‚Ù‚ Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ù…ØªÙƒØ±Ø±Ø©
        checkTimeout = setTimeout(function() {
            checkInvoiceNumber(invoiceNumberInput.value);
        }, 500);
    });
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¹Ù†Ø¯ Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„Ø­Ù‚Ù„
    invoiceNumberInput.addEventListener('blur', function() {
        if (checkTimeout) {
            clearTimeout(checkTimeout);
        }
        checkInvoiceNumber(invoiceNumberInput.value);
    });
}

function checkInvoiceNumber(invoiceNumber) {
    const warningDiv = document.getElementById('invoice-number-warning');
    
    if (!invoiceNumber || !customerId) {
        warningDiv.style.display = 'none';
        invoiceNumberValid = true;
        return;
    }
    
    fetch(`${checkInvoiceUrl}?invoice_number=${encodeURIComponent(invoiceNumber)}&customer_id=${customerId}&order_type=${orderType}`)
        .then(response => response.json())
        .then(data => {
            if (data.exists) {
                if (data.same_type) {
                    // Ù†ÙØ³ Ø§Ù„Ù†ÙˆØ¹ - Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©
                    invoiceNumberValid = false;
                    warningDiv.innerHTML = `
                        <div class="alert alert-danger py-2">
                            <i class="fas fa-times-circle me-2"></i>
                            <strong>Ø®Ø·Ø£:</strong> ${data.message}
                        </div>
                    `;
                    warningDiv.style.display = 'block';
                    
                    // Ø¹Ø±Ø¶ SweetAlert
                    Swal.fire({
                        icon: 'error',
                        title: data.title,
                        html: data.message,
                        confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹',
                        confirmButtonColor: '#dc3545'
                    });
                } else {
                    // Ù†ÙˆØ¹ Ù…Ø®ØªÙ„Ù - ØªØ­Ø°ÙŠØ± ÙÙ‚Ø·
                    invoiceNumberValid = true;
                    warningDiv.innerHTML = `
                        <div class="alert alert-warning py-2">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>ØªÙ†Ø¨ÙŠÙ‡:</strong> ${data.message}
                        </div>
                    `;
                    warningDiv.style.display = 'block';
                    
                    // Ø¹Ø±Ø¶ SweetAlert ØªØ­Ø°ÙŠØ±ÙŠ
                    Swal.fire({
                        icon: 'warning',
                        title: data.title,
                        html: data.message,
                        confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹ØŒ Ù…ØªØ§Ø¨Ø¹Ø©',
                        confirmButtonColor: '#ffc107'
                    });
                }
            } else {
                invoiceNumberValid = true;
                warningDiv.style.display = 'none';
            }
        })
        .catch(error => {
            console.error('Error checking invoice number:', error);
            invoiceNumberValid = true;
        });
}

paidAmountInput.addEventListener('input', function() {
    const paidAmount = parseFloat(this.value) || 0;
    const remaining = totalAmount - paidAmount;
    
    document.getElementById('remaining-amount').textContent = remaining.toFixed(2);
    
    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
    this.classList.remove('is-invalid', 'is-valid');
    
    // Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨ØªØ¬Ø§ÙˆØ² Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
    if (paidAmount >= minimumPayment) {
        this.classList.add('is-valid');
    } else if (paidAmount > 0) {
        this.classList.add('is-invalid');
    }
});

// Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
document.getElementById('step4-form').addEventListener('submit', function(e) {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹
    if (!invoiceNumberValid) {
        e.preventDefault();
        Swal.fire({
            icon: 'error',
            title: 'Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©',
            text: 'Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¨Ù‚Ø§Ù‹ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙÙŠ Ø·Ù„Ø¨ Ù…Ù† Ù†ÙØ³ Ø§Ù„Ù†ÙˆØ¹. ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ù‚Ù… Ù…Ø±Ø¬Ø¹ Ù…Ø®ØªÙ„Ù.',
            confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹',
            confirmButtonColor: '#dc3545'
        });
        return false;
    }
    
    const paidAmount = parseFloat(paidAmountInput.value) || 0;
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ ÙÙ‚Ø·
    if (paidAmount < minimumPayment) {
        e.preventDefault();
        Swal.fire({
            icon: 'warning',
            title: 'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ ØºÙŠØ± ÙƒØ§ÙÙ',
            html: `ÙŠØ¬Ø¨ Ø¯ÙØ¹ 50% Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ<br>
                   <strong>Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:</strong> ${minimumPayment.toFixed(2)} Ø¬Ù†ÙŠÙ‡<br>
                   <strong>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</strong> ${paidAmount.toFixed(2)} Ø¬Ù†ÙŠÙ‡`,
            confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹',
            confirmButtonColor: '#ffc107'
        });
        paidAmountInput.focus();
        return false;
    }
    
    // ØªÙ†Ø¨ÙŠÙ‡ Ø¥Ø°Ø§ ØªØ¬Ø§ÙˆØ² Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø¨Ø¯ÙˆÙ† Ù…Ù†Ø¹ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„)
    if (paidAmount > totalAmount) {
        e.preventDefault();
        const overpayment = paidAmount - totalAmount;
        Swal.fire({
            icon: 'question',
            title: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø²Ø§Ø¦Ø¯',
            html: `Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ ÙŠØªØ¬Ø§ÙˆØ² Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ<br>
                   <strong>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:</strong> ${totalAmount.toFixed(2)} Ø¬Ù†ÙŠÙ‡<br>
                   <strong>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</strong> ${paidAmount.toFixed(2)} Ø¬Ù†ÙŠÙ‡<br>
                   <strong>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø²Ø§Ø¦Ø¯:</strong> ${overpayment.toFixed(2)} Ø¬Ù†ÙŠÙ‡`,
            showCancelButton: true,
            confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ù…ØªØ§Ø¨Ø¹Ø©',
            cancelButtonText: 'Ù„Ø§ØŒ ØªØ¹Ø¯ÙŠÙ„',
            confirmButtonColor: '#28a745',
            cancelButtonColor: '#6c757d'
        }).then((result) => {
            if (result.isConfirmed) {
                submitWizardStep(document.getElementById('step4-form'));
            } else {
                paidAmountInput.focus();
            }
        });
        return false;
    }
    
    submitWizardStep(this);
});
</script>
{% endblock %}
