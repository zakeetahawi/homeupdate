{% extends 'orders/wizard/base_wizard.html' %}
{% load static decimal_filters %}
{% block wizard_content %}
    <!-- Edit History Section -->
    {% include 'orders/wizard/partials/edit_history.html' with draft=draft %}
    <form method="post"
          id="step4-form"
          enctype="multipart/form-data"
          novalidate>
        {% csrf_token %}
        <div class="row">
            <div class="col-md-6">
                <h5 class="mb-3">
                    <i class="fas fa-file-invoice me-2"></i>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø±Ø¬Ø¹
                </h5>
                <!-- Invoice Numbers -->
                <div class="mb-3">
                    <label for="{{ form.invoice_number.id_for_label }}"
                           class="form-label fw-bold">
                        <i class="fas fa-receipt me-2"></i>Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
                        <span class="text-danger">*</span>
                    </label>
                    {{ form.invoice_number }}
                    <div id="invoice-number-warning" class="mt-2" style="display: none;"></div>
                    {% if form.invoice_number.errors %}<div class="text-danger mt-1">{{ form.invoice_number.errors }}</div>{% endif %}
                </div>
                <div class="mb-3">
                    <label for="{{ form.invoice_number_2.id_for_label }}" class="form-label">Ø±Ù‚Ù… Ù…Ø±Ø¬Ø¹ Ø¥Ø¶Ø§ÙÙŠ 1</label>
                    {{ form.invoice_number_2 }}
                </div>
                <div class="mb-3">
                    <label for="{{ form.invoice_number_3.id_for_label }}" class="form-label">Ø±Ù‚Ù… Ù…Ø±Ø¬Ø¹ Ø¥Ø¶Ø§ÙÙŠ 2</label>
                    {{ form.invoice_number_3 }}
                </div>
                <!-- Invoice Images - ØµÙˆØ± Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø© -->
                <div class="mb-3">
                    <label class="form-label fw-bold">
                        <i class="fas fa-images me-2"></i>ØµÙˆØ± Ø§Ù„ÙØ§ØªÙˆØ±Ø©
                        {% if draft.selected_type != 'inspection' %}<span class="text-danger">*</span>{% endif %}
                    </label>
                    <!-- Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ© -->
                    <div id="current-images" class="mb-3">
                        {% if draft.invoice_image %}
                            <div class="border rounded p-2 mb-2 d-flex align-items-center justify-content-between bg-light"
                                 id="main-invoice-image">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-image me-2 text-success"></i>
                                    <span class="fw-bold">ØµÙˆØ±Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
                                </div>
                                <div>
                                    <a href="{{ draft.invoice_image.url }}"
                                       target="_blank"
                                       class="btn btn-sm btn-outline-success me-1"
                                       title="Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø©">
                                        <i class="fas fa-eye me-1"></i>Ø¹Ø±Ø¶
                                    </a>
                                    <button type="button"
                                            class="btn btn-sm btn-outline-danger"
                                            onclick="deleteMainInvoiceImage()"
                                            title="Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø©">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        {% endif %}
                        {% for img in draft.invoice_images_new.all %}
                            <div class="border rounded p-2 mb-2 d-flex align-items-center justify-content-between bg-light"
                                 id="invoice-image-{{ img.id }}">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-image me-2 text-success"></i>
                                    <span>ØµÙˆØ±Ø© ÙØ§ØªÙˆØ±Ø© {{ forloop.counter }}</span>
                                </div>
                                <div>
                                    <a href="{{ img.image.url }}"
                                       target="_blank"
                                       class="btn btn-sm btn-outline-success me-1"
                                       title="Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø©">
                                        <i class="fas fa-eye me-1"></i>Ø¹Ø±Ø¶
                                    </a>
                                    <button type="button"
                                            class="btn btn-sm btn-outline-danger"
                                            onclick="deleteInvoiceImage({{ img.id }})"
                                            title="Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø©">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        {% endfor %}
                        {% if not draft.invoice_image and not draft.invoice_images_new.exists %}
                            <div class="alert alert-info py-2 mb-2">
                                <i class="fas fa-info-circle me-2"></i>
                                Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ± Ù…Ø­ÙÙˆØ¸Ø©. ÙŠØ±Ø¬Ù‰ Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©.
                            </div>
                        {% endif %}
                    </div>
                    <!-- Ø­Ù‚ÙˆÙ„ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± -->
                    <div id="invoice-images-container">
                        {% if not draft.invoice_image and not draft.invoice_images_new.exists %}
                            <!-- Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ø£ÙˆÙ„ Ø¥Ø¬Ø¨Ø§Ø±ÙŠ ÙÙ‚Ø· Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ ØµÙˆØ± Ù…Ø­ÙÙˆØ¸Ø© -->
                            <div class="invoice-image-input mb-2">{{ form.invoice_image }}</div>
                        {% else %}
                            <!-- Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‡Ù†Ø§Ùƒ ØµÙˆØ± Ù…Ø­ÙÙˆØ¸Ø©ØŒ Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ø£ÙˆÙ„ Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ù…Ø¹ Ø²Ø± Ø­Ø°Ù -->
                            <div class="invoice-image-input mb-2 d-flex gap-2">
                                <input type="file"
                                       name="invoice_image"
                                       class="form-control"
                                       accept="image/*"
                                       id="invoice_image_field">
                                <button type="button"
                                        class="btn btn-sm btn-outline-danger"
                                        onclick="this.parentElement.remove()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        {% endif %}
                    </div>
                    <!-- Ø²Ø± Ø¥Ø¶Ø§ÙØ© ØµÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø© -->
                    <button type="button"
                            class="btn btn-sm btn-outline-primary"
                            id="add-invoice-image"
                            onclick="addInvoiceImageField()">
                        <i class="fas fa-plus me-1"></i>Ø¥Ø¶Ø§ÙØ© ØµÙˆØ±Ø© Ø¥Ø¶Ø§ÙÙŠØ©
                    </button>
                    {% if form.invoice_image.errors %}<div class="text-danger mt-2">{{ form.invoice_image.errors }}</div>{% endif %}
                    <div class="form-text mt-2">
                        <i class="fas fa-info-circle me-1"></i>
                        ÙŠÙØ³Ù…Ø­ Ø¨ØµÙˆØ± JPG, PNG, GIF, WEBP - Ø£Ù‚ØµÙ‰ Ø­Ø¬Ù… 10 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª Ù„ÙƒÙ„ ØµÙˆØ±Ø©
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <h5 class="mb-3">
                    <i class="fas fa-money-bill-wave me-2"></i>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¯ÙØ¹
                </h5>
                <!-- Payment Summary -->
                <div class="alert alert-info mb-4">
                    <h6 class="alert-heading">Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø¨Ø§Ù„Øº</h6>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ù‚Ø¨Ù„ Ø§Ù„Ø®ØµÙ…:</span>
                        <strong>{{ totals.subtotal|format_currency }}</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-2 text-danger">
                        <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø®ØµÙ…:</span>
                        <strong>{{ totals.total_discount|format_currency }}</strong>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between">
                        <span class="h6">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:</span>
                        <strong class="h6 text-success">{{ totals.final_total|format_currency }}</strong>
                    </div>
                </div>
                <!-- Payment Method -->
                <div class="mb-3">
                    <label for="{{ form.payment_method.id_for_label }}"
                           class="form-label fw-bold">
                        <i class="fas fa-credit-card me-2"></i>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹
                    </label>
                    {{ form.payment_method }}
                </div>
                <!-- Paid Amount -->
                <div class="mb-3">
                    <label for="{{ form.paid_amount.id_for_label }}" class="form-label fw-bold">
                        <i class="fas fa-dollar-sign me-2"></i>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹
                        <span class="text-danger">*</span>
                    </label>
                    {{ form.paid_amount }}
                    {% if form.paid_amount.errors %}
                        <div class="alert alert-danger mt-2 py-2">
                            <i class="fas fa-exclamation-circle me-1"></i>
                            {{ form.paid_amount.errors }}
                        </div>
                    {% endif %}
                    <div class="alert alert-warning mt-2 py-2">
                        <i class="fas fa-lightbulb me-1"></i>
                        {% if draft.customer.customer_type == 'wholesale' %}
                            <strong>ğŸ’¡ ØªÙ†Ø¨ÙŠÙ‡:</strong> ÙŠØ¬Ø¨ Ø¯ÙØ¹ 50% Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ© (Ø£Ùˆ 0 Ù„Ù„Ø¯ÙØ¹ Ù„Ø§Ø­Ù‚Ø§Ù‹) Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©
                        {% else %}
                            <strong>ğŸ’¡ ØªÙ†Ø¨ÙŠÙ‡:</strong> ÙŠØ¬Ø¨ Ø¯ÙØ¹ 50% Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ© Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©
                        {% endif %}
                        <br>
                        <small>Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: <strong>{{ totals.minimum_payment|format_currency }}</strong></small>
                    </div>
                    <div class="form-text">
                        <i class="fas fa-info-circle me-1"></i>
                        Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: <span id="remaining-amount">{{ totals.remaining|clean_decimal }}</span> {{ currency_symbol }}
                    </div>
                </div>
                <!-- Payment Notes -->
                <div class="mb-3">
                    <label for="{{ form.payment_notes.id_for_label }}" class="form-label">
                        <i class="fas fa-sticky-note me-2"></i>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¯ÙØ¹
                    </label>
                    {{ form.payment_notes }}
                </div>
            </div>
        </div>
        <!-- Actions -->
        <div class="wizard-actions">
            <div>
                <a href="{% url 'orders:wizard_cancel' %}"
                   class="btn btn-wizard btn-wizard-danger me-2">
                    <i class="fas fa-times me-2"></i>Ø¥Ù„ØºØ§Ø¡
                </a>
                <a href="{% url 'orders:wizard_step' step=3 %}"
                   class="btn btn-wizard btn-wizard-secondary">
                    <i class="fas fa-arrow-right me-2"></i>Ø§Ù„Ø³Ø§Ø¨Ù‚
                </a>
            </div>
            <div>
                <button type="submit"
                        class="btn btn-wizard btn-wizard-primary"
                        id="submit-btn">
                    <i class="fas fa-arrow-left me-2"></i>Ø§Ù„ØªØ§Ù„ÙŠ
                </button>
            </div>
        </div>
    </form>
    <!-- Sweet Alert for duplicate warning -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
{% endblock %}
{% block extra_js %}
    {{ block.super }}
    <!-- JavaScript Functions - Ø¯ÙˆØ§Ù„ Ø¹Ø§Ù…Ø© -->
    <script>
    // Ø¥Ø¶Ø§ÙØ© Ø­Ù‚Ù„ ØµÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯ - Ø¯Ø§Ù„Ø© Ø¹Ø§Ù…Ø© ÙŠÙ…ÙƒÙ† Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„ÙŠÙ‡Ø§ Ù…Ù† onclick
    let imageFieldCounter = 1;
    window.addInvoiceImageField = function () {
        const container = document.getElementById('invoice-images-container');
        if (!container) {
            console.error('Container not found');
            return;
        }

        const newField = document.createElement('div');
        newField.className = 'invoice-image-input mb-2 d-flex gap-2';
        newField.innerHTML = `
        <input type="file" name="additional_invoice_image_${imageFieldCounter}" class="form-control" accept="image/*">
        <button type="button" class="btn btn-sm btn-outline-danger" onclick="this.parentElement.remove()">
            <i class="fas fa-times"></i>
        </button>
    `;
        container.appendChild(newField);
        imageFieldCounter++;
        console.log('Added new image field');
    }

    // Ø­Ø°Ù ØµÙˆØ±Ø© ÙØ§ØªÙˆØ±Ø© - Ø¯Ø§Ù„Ø© Ø¹Ø§Ù…Ø©
    window.deleteInvoiceImage = function (imageId) {
        Swal.fire({
            title: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ',
            text: 'Ø³ÙŠØªÙ… Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„ØµÙˆØ±Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#dc3545',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù',
            cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch(`/orders/wizard/delete-invoice-image/${imageId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json'
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¹Ù†ØµØ± Ù…Ù† DOM Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
                            const element = document.getElementById(`invoice-image-${imageId}`);
                            if (element) {
                                element.remove();
                            }
                            Swal.fire({
                                icon: 'success',
                                title: 'ØªÙ… Ø§Ù„Ø­Ø°Ù!',
                                text: 'ØªÙ… Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­',
                                timer: 1500,
                                showConfirmButton: false
                            });
                        } else {
                            Swal.fire('Ø®Ø·Ø£!', data.error || 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù', 'error');
                        }
                    })
                    .catch(error => {
                        Swal.fire('Ø®Ø·Ø£!', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…', 'error');
                    });
            }
        });
    }

    // Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ù„ÙØ§ØªÙˆØ±Ø©
    window.deleteMainInvoiceImage = function () {
        Swal.fire({
            title: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ',
            text: 'Ø³ÙŠØªÙ… Ø­Ø°Ù ØµÙˆØ±Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#dc3545',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù',
            cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch(`/orders/wizard/delete-main-invoice-image/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json'
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¹Ù†ØµØ± Ù…Ù† DOM
                            const element = document.getElementById('main-invoice-image');
                            if (element) {
                                element.remove();
                            }
                            Swal.fire({
                                icon: 'success',
                                title: 'ØªÙ… Ø§Ù„Ø­Ø°Ù!',
                                text: 'ØªÙ… Ø­Ø°Ù ØµÙˆØ±Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­',
                                timer: 1500,
                                showConfirmButton: false
                            });
                        } else {
                            Swal.fire('Ø®Ø·Ø£!', data.error || 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù', 'error');
                        }
                    })
                    .catch(error => {
                        Swal.fire('Ø®Ø·Ø£!', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…', 'error');
                    });
            }
        });
    }
    </script>
    <script>
    // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ÙˆØ¯Ø©
    const customerId = {% if draft.customer %}{{ draft.customer.id }}{% else %}null{% endif %};
    const orderType = "{{ draft.selected_type|default:'' }}";
    const checkInvoiceUrl = "{% url 'orders:check_invoice_number_api' %}";

    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
    const totalAmount = {{ totals.final_total }};
    const minimumPayment = {{ totals.minimum_payment }};
    const paidAmountInput = document.getElementById('{{ form.paid_amount.id_for_label }}');
    const invoiceNumberInput = document.getElementById('{{ form.invoice_number.id_for_label }}') ||
        document.getElementById('id_invoice_number') ||
        document.querySelector('[name="invoice_number"]');

    // Ù…ØªØºÙŠØ± Ù„ØªØªØ¨Ø¹ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚
    let invoiceNumberValid = true;
    let checkTimeout = null;

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ Ø¹Ù†Ø¯ Ø§Ù„ÙƒØªØ§Ø¨Ø©
    if (invoiceNumberInput) {
        invoiceNumberInput.addEventListener('input', function () {
            // Ø¥Ù„ØºØ§Ø¡ Ø£ÙŠ ØªØ­Ù‚Ù‚ Ø³Ø§Ø¨Ù‚
            if (checkTimeout) {
                clearTimeout(checkTimeout);
            }

            // ØªØ£Ø®ÙŠØ± Ø§Ù„ØªØ­Ù‚Ù‚ Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ù…ØªÙƒØ±Ø±Ø©
            checkTimeout = setTimeout(function () {
                checkInvoiceNumber(invoiceNumberInput.value);
            }, 500);
        });

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¹Ù†Ø¯ Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„Ø­Ù‚Ù„
        invoiceNumberInput.addEventListener('blur', function () {
            if (checkTimeout) {
                clearTimeout(checkTimeout);
            }
            checkInvoiceNumber(invoiceNumberInput.value);
        });
    }

    async function checkInvoiceNumber(invoiceNumber) {
        const warningDiv = document.getElementById('invoice-number-warning');

        if (!invoiceNumber || !customerId) {
            warningDiv.style.display = 'none';
            invoiceNumberValid = true;
            return;
        }

        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        // Ù…Ø¹Ø±Ù Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
        const currentOrderId = '{{ request.session.editing_order_id|default:"" }}';

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹
        const data = {
            invoice_number: invoiceNumber,
            customer_id: customerId,
            order_type: '{{ draft.selected_type }}',
            current_order_id: currentOrderId // âš¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø±Ù Ù„Ø§Ø³ØªØ«Ù†Ø§Ø¦Ù‡
        };

        fetch('{% url "orders:check_invoice_number_api" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(data)
        })
            .then(response => response.json())
            .then(data => {
                if (data.exists) {
                    // Ø§Ù„Ø±Ù‚Ù… Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¨Ù‚Ø§Ù‹
                    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù†ÙØ³ Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙˆÙ„Ù†ÙØ³ Ø§Ù„Ù†ÙˆØ¹ ÙÙ‡Ø°Ø§ Ø®Ø·Ø£ Ø­Ø§Ø³Ù… Ø¥Ù„Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù†ÙØ³ Ø§Ù„Ø·Ù„Ø¨
                    if (data.is_blocking) {
                        invoiceNumberValid = false;
                        warningDiv.innerHTML = `
                    <div class="alert alert-danger py-2">
                        <i class="fas fa-times-circle me-2"></i>
                        <strong>Ø®Ø·Ø£:</strong> ${data.message}
                    </div>
                `;
                        warningDiv.style.display = 'block';

                        // Ø¹Ø±Ø¶ SweetAlert
                        Swal.fire({
                            icon: 'error',
                            title: 'Ø±Ù‚Ù… Ù…Ø±Ø¬Ø¹ Ù…ÙƒØ±Ø±',
                            text: data.message,
                            confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹',
                            confirmButtonColor: '#dc3545'
                        });
                    } else {
                        // ØªØ­Ø°ÙŠØ± ÙÙ‚Ø·
                        invoiceNumberValid = true;
                        warningDiv.innerHTML = `
                    <div class="alert alert-warning py-2">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>ØªÙ†Ø¨ÙŠÙ‡:</strong> ${data.message}
                    </div>
                `;
                        warningDiv.style.display = 'block';
                    }
                } else {
                    // Ø§Ù„Ø±Ù‚Ù… Ù…ØªØ§Ø­
                    invoiceNumberValid = true;
                    warningDiv.style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Error checking invoice number:', error);
                // ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ØŒ Ù†ÙØªØ±Ø¶ ØµØ­Ø© Ø§Ù„Ø±Ù‚Ù… Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©
                invoiceNumberValid = true;
                warningDiv.style.display = 'none';
            });
    }

    paidAmountInput.addEventListener('input', function () {
        const paidAmount = parseFloat(this.value) || 0;
        const remaining = totalAmount - paidAmount;

        // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø±Ù‚Ù… Ø¨Ø¯ÙˆÙ† Ø£ØµÙØ§Ø± Ø²Ø§Ø¦Ø¯Ø©
        const formattedRemaining = remaining.toFixed(2).replace(/\.?0+$/, '');
        document.getElementById('remaining-amount').textContent = formattedRemaining;

        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
        this.classList.remove('is-invalid', 'is-valid', 'field-required-error');

        // Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨ØªØ¬Ø§ÙˆØ² Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
        if (paidAmount >= minimumPayment) {
            this.classList.add('is-valid');
        } else if (paidAmount > 0) {
            this.classList.add('is-invalid');
        }
    });

    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…ÙƒØ±Ø±Ø© Ø§Ù„ØªÙŠ ÙƒØ§Ù†Øª Ù‡Ù†Ø§ - ØªÙ… Ù†Ù‚Ù„Ù‡Ø§ Ø¥Ù„Ù‰ window object Ø£Ø¹Ù„Ø§Ù‡

    // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
    document.getElementById('step4-form').addEventListener('submit', function (e) {
        e.preventDefault();

        // Ø¥Ø²Ø§Ù„Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
        clearAllFieldErrors(this);

        const missingFields = [];
        let hasErrors = false;

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹
        const invoiceNumberField = document.getElementById('{{ form.invoice_number.id_for_label }}');
        if (!invoiceNumberField || !invoiceNumberField.value.trim()) {
            hasErrors = true;
            missingFields.push('Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ');
            markFieldAsError(invoiceNumberField, 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹');
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ (ØºÙŠØ± Ù…ÙƒØ±Ø±)
        if (!invoiceNumberValid) {
            hasErrors = true;
            missingFields.push('Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¨Ù‚Ø§Ù‹');
            markFieldAsError(invoiceNumberField, 'Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¨Ù‚Ø§Ù‹ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„');

            Swal.fire({
                icon: 'error',
                title: 'Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©',
                text: 'Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¨Ù‚Ø§Ù‹ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙÙŠ Ø·Ù„Ø¨ Ù…Ù† Ù†ÙØ³ Ø§Ù„Ù†ÙˆØ¹. ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ù‚Ù… Ù…Ø±Ø¬Ø¹ Ù…Ø®ØªÙ„Ù.',
                confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹',
                confirmButtonColor: '#dc3545'
            });
            return false;
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙˆØ±Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© (Ø¥Ù„Ø²Ø§Ù…ÙŠØ© Ù„ØºÙŠØ± Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©)
        const draftType = '{{ draft.selected_type }}';
        const hasExistingImages = {{ draft.invoice_image|yesno:"true,false" }} || {{ draft.invoice_images_new.exists|yesno:"true,false" }};
    const invoiceImageField = document.getElementById('{{ form.invoice_image.id_for_label }}') || document.querySelector('input[name="invoice_image"]');

    if (draftType !== 'inspection' && !hasExistingImages) {
        if (!invoiceImageField || !invoiceImageField.files || invoiceImageField.files.length === 0) {
            hasErrors = true;
            missingFields.push('ØµÙˆØ±Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©');
            markFieldAsError(invoiceImageField, 'ÙŠØ±Ø¬Ù‰ Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©');
        }
    }

    const paidAmount = parseFloat(paidAmountInput.value) || 0;

    // Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…ÙŠÙ„ (ØªÙ… ØªÙ…Ø±ÙŠØ±Ù‡ Ù…Ù† Ø§Ù„Ù€ View Ø£Ùˆ Ø§Ù„Ù…Ø³ÙˆØ¯Ø©)
    const customerType = "{{ draft.customer.customer_type|default:'retail' }}";
    const isWholesale = customerType === 'wholesale';

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹
    if (isWholesale) {
        // Ø¹Ù…ÙŠÙ„ Ø¬Ù…Ù„Ø© - ÙŠØ³Ù…Ø­ Ø¨Ø§Ù„ØµÙØ±
        if (paidAmount < 0) {
            hasErrors = true;
            missingFields.push('Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹');
            markFieldAsError(paidAmountInput, 'Ø§Ù„Ù…Ø¨Ù„Øº Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† Ø³Ø§Ù„Ø¨Ø§Ù‹');
        }
    } else {
        // Ø¹Ù…ÙŠÙ„ Ø¹Ø§Ø¯ÙŠ - ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ±
        if (paidAmount <= 0) {
            hasErrors = true;
            missingFields.push('Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹');
            markFieldAsError(paidAmountInput, 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹');
        }
    }

    // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‡Ù†Ø§Ùƒ Ø£Ø®Ø·Ø§Ø¡ Ø£ÙˆÙ„ÙŠØ©ØŒ Ø¹Ø±Ø¶Ù‡Ø§
    if (hasErrors) {
        showValidationAlert(missingFields);
        return false;
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰
    // Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ø¬Ù…Ù„Ø©: Ø§Ù„ØªØ­Ù‚Ù‚ ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù…Ø¨Ù„Øº Ù…Ø¯ÙÙˆØ¹ (> 0)
    // Ù„Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ø¹Ø§Ø¯ÙŠÙŠÙ†: Ø§Ù„ØªØ­Ù‚Ù‚ Ø¯Ø§Ø¦Ù…Ø§Ù‹ (Ù„Ø£Ù†Ù†Ø§ ØªØ£ÙƒØ¯Ù†Ø§ Ø£ØµÙ„Ø§Ù‹ Ø£Ù†Ù‡ > 0 Ø£Ø¹Ù„Ø§Ù‡)
    
    let checkMinimum = true;
    if (isWholesale && paidAmount === 0) {
        checkMinimum = false; // ØªØ¬Ø§ÙˆØ² ÙØ­Øµ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø¨Ù„Øº 0 Ù„Ø¹Ù…ÙŠÙ„ Ø¬Ù…Ù„Ø©
    }

    if (checkMinimum && paidAmount < minimumPayment) {
        let msg = `Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: ${minimumPayment.toFixed(2)} Ø¬Ù†ÙŠÙ‡`;
        let desc = `ÙŠØ¬Ø¨ Ø¯ÙØ¹ 50% Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ`;
        
        if (isWholesale) {
            msg += ` (Ø£Ùˆ 0 Ù„Ù„Ø¯ÙØ¹ Ù„Ø§Ø­Ù‚Ø§Ù‹)`;
            desc += ` (Ø£Ùˆ ØªØ±Ùƒ Ø§Ù„Ù…Ø¨Ù„Øº 0 Ù„Ù„Ø¯ÙØ¹ Ù„Ø§Ø­Ù‚Ø§Ù‹)`;
        }

        markFieldAsError(paidAmountInput, msg);

        Swal.fire({
            icon: 'warning',
            title: 'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ ØºÙŠØ± ÙƒØ§ÙÙ',
            html: `${desc}<br>
                   <strong>Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:</strong> ${minimumPayment.toFixed(2)} Ø¬Ù†ÙŠÙ‡<br>
                   <strong>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</strong> ${paidAmount.toFixed(2)} Ø¬Ù†ÙŠÙ‡`,
            confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹',
            confirmButtonColor: '#ffc107'
        });
        paidAmountInput.focus();
        return false;
    }

    // ØªÙ†Ø¨ÙŠÙ‡ Ø¥Ø°Ø§ ØªØ¬Ø§ÙˆØ² Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø¨Ø¯ÙˆÙ† Ù…Ù†Ø¹ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„)
    if (paidAmount > totalAmount) {
        const overpayment = paidAmount - totalAmount;
        Swal.fire({
            icon: 'question',
            title: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø²Ø§Ø¦Ø¯',
            html: `Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ ÙŠØªØ¬Ø§ÙˆØ² Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ<br>
                   <strong>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:</strong> ${totalAmount.toFixed(2)} Ø¬Ù†ÙŠÙ‡<br>
                   <strong>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</strong> ${paidAmount.toFixed(2)} Ø¬Ù†ÙŠÙ‡<br>
                   <strong>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø²Ø§Ø¦Ø¯:</strong> ${overpayment.toFixed(2)} Ø¬Ù†ÙŠÙ‡`,
            showCancelButton: true,
            confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ù…ØªØ§Ø¨Ø¹Ø©',
            cancelButtonText: 'Ù„Ø§ØŒ ØªØ¹Ø¯ÙŠÙ„',
            confirmButtonColor: '#28a745',
            cancelButtonColor: '#6c757d'
        }).then((result) => {
            if (result.isConfirmed) {
                submitWizardStep(document.getElementById('step4-form'));
            } else {
                paidAmountInput.focus();
            }
        });
        return false;
    }

    submitWizardStep(this);
});
    </script>
{% endblock %}
