{% extends 'orders/wizard/base_wizard.html' %}
{% load static %}
{% block wizard_content %}
    <!-- Edit History Section -->
    {% include 'orders/wizard/partials/edit_history.html' with draft=draft %}
    <form method="post" id="step2-form" novalidate>
        {% csrf_token %}
        <!-- Ø¹Ø±Ø¶ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¹Ø§Ù…Ø© -->
        {% if form.non_field_errors %}
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Ø®Ø·Ø£:</strong>
                {% for error in form.non_field_errors %}{{ error }}{% endfor %}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endif %}
        <div class="mb-4">
            <h5 class="mb-3">
                <i class="fas fa-tags me-2"></i>Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨
                <span class="text-danger">*</span>
            </h5>
            {% if form.selected_type.errors %}<div class="alert alert-danger">{{ form.selected_type.errors }}</div>{% endif %}
            <div class="row g-3">
                {% for choice in form.selected_type.field.choices %}
                    <div class="col-md-4 col-sm-6">
                        <label for="type_{{ choice.0 }}" class="order-type-label">
                            <div class="card h-100 order-type-card">
                                <div class="card-body text-center">
                                    <input type="radio"
                                           name="{{ form.selected_type.name }}"
                                           value="{{ choice.0 }}"
                                           id="type_{{ choice.0 }}"
                                           {% if form.selected_type.value == choice.0 %}checked{% endif %}
                                           class="order-type-radio">
                                    <div class="order-type-icon mb-3">
                                        {% if choice.0 == 'accessory' %}
                                            <i class="fas fa-gem fa-3x text-primary"></i>
                                        {% elif choice.0 == 'installation' %}
                                            <i class="fas fa-tools fa-3x text-success"></i>
                                        {% elif choice.0 == 'inspection' %}
                                            <i class="fas fa-eye fa-3x text-info"></i>
                                        {% elif choice.0 == 'tailoring' or choice.0 == 'deli' %}
                                            <i class="fas fa-cut fa-3x text-warning"></i>
                                        {% elif choice.0 == 'products' %}
                                            <i class="fas fa-boxes fa-3x text-secondary"></i>
                                        {% endif %}
                                    </div>
                                    <h5>{{ choice.1 }}</h5>
                                    <small class="text-muted d-block mt-2">
                                        {% if choice.0 == 'accessory' %}
                                            ğŸ”§ Ù…ÙˆØ¬Ù‡ Ø¥Ù„Ù‰ ÙˆØ±Ø´Ø© Ø§Ù„Ø¥ÙƒØ³Ø³ÙˆØ§Ø±
                                        {% elif choice.0 == 'installation' %}
                                            ğŸ­ Ù…ÙˆØ¬Ù‡ Ø¥Ù„Ù‰ Ø§Ù„Ù…ØµÙ†Ø¹
                                        {% elif choice.0 == 'tailoring' or choice.0 == 'deli' %}
                                            ğŸ“¦ Ù…ÙˆØ¬Ù‡ Ø¥Ù„Ù‰ Ø§Ù„Ù…ØµÙ†Ø¹
                                        {% elif choice.0 == 'inspection' %}
                                            ğŸ‘ï¸ Ù…ÙˆØ¬Ù‡ Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø§Øª
                                        {% elif choice.0 == 'products' %}
                                            ğŸ“¦ Ù…ÙˆØ¬Ù‡ Ù„Ù„Ù…Ø®Ø§Ø²Ù†
                                        {% endif %}
                                    </small>
                                </div>
                            </div>
                        </label>
                    </div>
                {% endfor %}
            </div>
        </div>
        <!-- Related Inspection (shown conditionally) -->
        <div id="related-inspection-section" style="display: none;">
            <div class="card border-warning mb-4">
                <div class="card-header bg-warning bg-opacity-10">
                    <h5 class="mb-0">
                        <i class="fas fa-eye me-2"></i>Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©
                        <span class="text-danger">*</span>
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Ø¹Ø±Ø¶ Ø£Ø®Ø·Ø§Ø¡ Ø­Ù‚Ù„ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© -->
                    {% if form.related_inspection.errors %}
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            {% for error in form.related_inspection.errors %}{{ error }}{% endfor %}
                        </div>
                    {% endif %}
                    <!-- Ø®ÙŠØ§Ø± Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ÙØ¹Ù„ÙŠØ© -->
                    <div class="mb-3">
                        <div class="inspection-choice-card"
                             onclick="selectInspectionType('existing')">
                            <div class="choice-header">
                                <input class="form-check-input inspection-checkbox"
                                       type="checkbox"
                                       id="use_existing_inspection"
                                       value="existing"
                                       onchange="toggleInspectionChoice(event)">
                                <label class="form-check-label fw-bold" for="use_existing_inspection">
                                    <i class="fas fa-list me-2"></i>Ø§Ø®ØªÙŠØ§Ø± Ù…Ø¹Ø§ÙŠÙ†Ø© Ù…ÙˆØ¬ÙˆØ¯Ø©
                                </label>
                            </div>
                        </div>
                        <div id="inspection-select-wrapper"
                             class="mt-2 inspection-details"
                             style="display: none">
                            <label for="{{ form.related_inspection.id_for_label }}" class="form-label">Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©</label>
                            {{ form.related_inspection }}
                            <div class="form-text">
                                <i class="fas fa-info-circle me-1"></i>
                                Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨
                            </div>
                        </div>
                    </div>
                    <!-- Ø®ÙŠØ§Ø± Ø·Ø±Ù Ø§Ù„Ø¹Ù…ÙŠÙ„ -->
                    <div class="mb-3">
                        <div class="inspection-choice-card"
                             onclick="selectInspectionType('customer_side')">
                            <div class="choice-header">
                                <input class="form-check-input inspection-checkbox"
                                       type="checkbox"
                                       id="use_customer_inspection"
                                       value="customer_side"
                                       onchange="toggleInspectionChoice(event)">
                                <label class="form-check-label fw-bold" for="use_customer_inspection">
                                    <i class="fas fa-user-plus me-2"></i>Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§ÙŠÙ†Ø© Ø·Ø±Ù Ø§Ù„Ø¹Ù…ÙŠÙ„
                                </label>
                            </div>
                            <div class="form-text text-muted choice-description">
                                <i class="fas fa-info-circle me-1"></i>
                                Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ø¨Ø¯ÙˆÙ† Ù…Ø¹Ø§ÙŠÙ†Ø© ÙØ¹Ù„ÙŠØ© (Ø·Ø±Ù Ø§Ù„Ø¹Ù…ÙŠÙ„)
                            </div>
                        </div>
                    </div>
                    <!-- Hidden field for related_inspection_type -->
                    <input type="hidden"
                           name="{{ form.related_inspection_type.name }}"
                           id="id_related_inspection_type"
                           value="">
                </div>
            </div>
        </div>
        <!-- Actions -->
        <div class="wizard-actions">
            <div>
                <a href="{% url 'orders:wizard_cancel' %}"
                   class="btn btn-wizard btn-wizard-danger me-2">
                    <i class="fas fa-times me-2"></i>Ø¥Ù„ØºØ§Ø¡
                </a>
                <a href="{% url 'orders:wizard_step' step=1 %}"
                   class="btn btn-wizard btn-wizard-secondary">
                    <i class="fas fa-arrow-right me-2"></i>Ø§Ù„Ø³Ø§Ø¨Ù‚
                </a>
            </div>
            <div>
                <button type="submit" class="btn btn-wizard btn-wizard-primary">
                    <i class="fas fa-arrow-left me-2"></i>Ø§Ù„ØªØ§Ù„ÙŠ
                </button>
            </div>
        </div>
    </form>
{% endblock %}
{% block extra_js %}
    {{ block.super }}
    <style>
/* ØªØºÙ„ÙŠÙ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø¨Ù€ label Ù„Ù„Ù†Ù‚Ø± Ø§Ù„Ø³Ù‡Ù„ */
.order-type-label {
    display: block;
    cursor: pointer;
    margin-bottom: 0;
    -webkit-tap-highlight-color: transparent;
}

.order-type-card {
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid #e2e8f0;
    -webkit-tap-highlight-color: transparent;
    user-select: none;
    -webkit-user-select: none;
}

.order-type-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.15);
}

.order-type-card:active {
    transform: scale(0.98);
}

/* Ø¥Ø®ÙØ§Ø¡ radio button */
.order-type-radio {
    position: absolute;
    opacity: 0;
    width: 0;
    height: 0;
}

/* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© */
.order-type-radio:checked + .card-body {
    background: #f0fdf4;
}

.order-type-radio:checked ~ .order-type-card,
.order-type-label:has(.order-type-radio:checked) .order-type-card {
    border-color: #198754;
    background: #f0fdf4;
    box-shadow: 0 4px 12px rgba(25, 135, 84, 0.3);
}

/* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
@media (max-width: 768px) {
    .order-type-card {
        min-height: 180px;
        margin-bottom: 15px;
    }
    
    .order-type-card .card-body {
        padding: 20px 15px;
    }
    
    .order-type-icon {
        margin-bottom: 10px !important;
    }
    
    .order-type-icon i {
        font-size: 2.5rem !important;
    }
    
    .order-type-card h5 {
        font-size: 16px;
        margin-bottom: 8px;
    }
    
    .order-type-card small {
        font-size: 13px;
    }
    
    /* ØªØ­Ø³ÙŠÙ†Ø§Øª checkboxes Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© */
    .inspection-choice-card {
        background: white;
        border: 2px solid #e0e0e0;
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        -webkit-tap-highlight-color: transparent;
    }
    
    .inspection-choice-card:hover {
        border-color: #a67c52;
        background: #fafafa;
    }
    
    .inspection-choice-card:active {
        transform: scale(0.98);
    }
    
    .inspection-choice-card.selected {
        border-color: #28a745;
        background: #f0fdf4;
        box-shadow: 0 2px 8px rgba(40, 167, 69, 0.2);
    }
    
    .choice-header {
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .inspection-checkbox {
        width: 24px;
        height: 24px;
        min-width: 24px;
        border-radius: 6px;
        border: 2px solid #6c757d;
        cursor: pointer;
        flex-shrink: 0;
        margin: 0;
    }
    
    .inspection-checkbox:checked {
        background-color: #28a745;
        border-color: #28a745;
    }
    
    .choice-header label {
        margin: 0;
        cursor: pointer;
        flex: 1;
        font-size: 15px;
        user-select: none;
        -webkit-user-select: none;
    }
    
    .choice-description {
        margin-top: 8px;
        margin-right: 36px;
        font-size: 13px;
        line-height: 1.5;
    }
    
    .inspection-details {
        margin-right: 36px;
        padding: 12px;
        background: #f8f9fa;
        border-radius: 8px;
        border-right: 3px solid #28a745;
    }
    
    /* ØªØ­Ø³ÙŠÙ† Ù‚Ø³Ù… Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
    #related-inspection-section {
        margin-top: 20px;
    }
    
    #related-inspection-section .card-header h5 {
        font-size: 16px;
    }
    
    #related-inspection-section .form-check-label {
        font-size: 15px;
        padding: 10px 0;
    }
    
    #related-inspection-section .form-text {
        font-size: 13px;
    }
    
    /* ØªØ­Ø³ÙŠÙ†Ø§Øª checkboxes Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
    .inspection-choice-card {
        padding: 18px;
        margin-bottom: 15px;
    }
    
    .inspection-checkbox {
        width: 28px;
        height: 28px;
        min-width: 28px;
    }
    
    .choice-header label {
        font-size: 16px;
    }
    
    .choice-description {
        font-size: 14px;
        margin-right: 40px;
    }
    
    .inspection-details {
        margin-right: 40px;
        padding: 15px;
    }
    
    /* ØªØ­Ø³ÙŠÙ† Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙ†Ù‚Ù„ Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
    .wizard-actions {
        position: sticky;
        bottom: 0;
        background: white;
        padding: 15px;
        margin: 0 -15px;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        z-index: 100;
    }
}
    </style>
    <script>
// Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„Ù…Ø­Ù…ÙˆÙ„
const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
const isMobile = window.innerWidth <= 768;

console.log('ğŸ”§ ØªÙ‡ÙŠØ¦Ø© ØµÙØ­Ø© Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨...');
console.log('ğŸ“± Ø¬Ù‡Ø§Ø² Ù…Ø­Ù…ÙˆÙ„:', isMobile);
console.log('ğŸ‘† Ø´Ø§Ø´Ø© Ù„Ù…Ø³:', isTouchDevice);

function selectOrderType(type) {
    console.log('ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨:', type);
    
    // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
    document.querySelectorAll('.order-type-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    const radio = document.getElementById('type_' + type);
    if (radio) {
        radio.checked = true;
        const card = radio.closest('.order-type-card');
        if (card) {
            card.classList.add('selected');
        }
        
        // ØªØ£Ø«ÙŠØ± Ø¨ØµØ±ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„
        if (isTouchDevice && card) {
            card.style.transform = 'scale(0.98)';
            setTimeout(() => {
                card.style.transform = '';
            }, 150);
        }
    }
    
    // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ù‚Ø³Ù… Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©
    const relatedInspectionSection = document.getElementById('related-inspection-section');
    if (['installation', 'tailoring', 'deli', 'accessory'].includes(type)) {
        relatedInspectionSection.style.display = 'block';
    } else {
        relatedInspectionSection.style.display = 'none';
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ù‚ÙˆÙ„
        resetInspectionFields();
    }
}

function selectInspectionType(type) {
    const existingChoice = document.getElementById('use_existing_inspection');
    const customerChoice = document.getElementById('use_customer_inspection');
    const existingCard = existingChoice.closest('.inspection-choice-card');
    const customerCard = customerChoice.closest('.inspection-choice-card');
    
    // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ù…Ù† Ø§Ù„Ø¬Ù…ÙŠØ¹ Ø£ÙˆÙ„Ø§Ù‹
    existingChoice.checked = false;
    customerChoice.checked = false;
    existingCard.classList.remove('selected');
    customerCard.classList.remove('selected');
    
    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
    if (type === 'existing') {
        existingChoice.checked = true;
        existingCard.classList.add('selected');
    } else if (type === 'customer_side') {
        customerChoice.checked = true;
        customerCard.classList.add('selected');
    }
    
    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
    toggleInspectionChoice();
}

function toggleInspectionChoice(event) {
    // Ù…Ù†Ø¹ Ø§Ù„Ø­Ø¯Ø« Ù…Ù† Ø§Ù„Ø§Ù†ØªØ´Ø§Ø± Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ù† checkbox
    if (event) {
        event.stopPropagation();
    }
    
    const existingChoice = document.getElementById('use_existing_inspection');
    const customerChoice = document.getElementById('use_customer_inspection');
    const inspectionSelectWrapper = document.getElementById('inspection-select-wrapper');
    const inspectionSelect = document.querySelector('select[name="{{ form.related_inspection.name }}"]');
    const inspectionTypeInput = document.getElementById('id_related_inspection_type');
    const existingCard = existingChoice.closest('.inspection-choice-card');
    const customerCard = customerChoice.closest('.inspection-choice-card');
    
    // Ø¶Ù…Ø§Ù† Ø£Ù† ÙŠÙƒÙˆÙ† ÙˆØ§Ø­Ø¯ ÙÙ‚Ø· Ù…Ø­Ø¯Ø¯ (Ø³Ù„ÙˆÙƒ radio)
    if (existingChoice.checked && customerChoice.checked) {
        // Ø¥Ø°Ø§ ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø§Ø«Ù†ÙŠÙ†ØŒ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¢Ø®Ø±
        if (event && event.target === existingChoice) {
            customerChoice.checked = false;
            customerCard.classList.remove('selected');
        } else {
            existingChoice.checked = false;
            existingCard.classList.remove('selected');
        }
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
    if (existingChoice.checked) {
        // Ø¥Ø¸Ù‡Ø§Ø± Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø§Øª
        inspectionSelectWrapper.style.display = 'block';
        inspectionTypeInput.value = 'inspection';
        existingCard.classList.add('selected');
        customerCard.classList.remove('selected');
    } else if (customerChoice.checked) {
        // Ø¥Ø®ÙØ§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø§Øª ÙˆØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù‚ÙŠÙ…Ø©
        inspectionSelectWrapper.style.display = 'none';
        inspectionSelect.value = '';  // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ¯
        inspectionTypeInput.value = 'customer_side';
        customerCard.classList.add('selected');
        existingCard.classList.remove('selected');
    } else {
        // Ù„Ø§ Ø´ÙŠØ¡ Ù…Ø­Ø¯Ø¯
        inspectionSelectWrapper.style.display = 'none';
        inspectionTypeInput.value = '';
        existingCard.classList.remove('selected');
        customerCard.classList.remove('selected');
    }
}

function resetInspectionFields() {
    const existingChoice = document.getElementById('use_existing_inspection');
    const customerChoice = document.getElementById('use_customer_inspection');
    const inspectionSelect = document.querySelector('select[name="{{ form.related_inspection.name }}"]');
    const inspectionTypeInput = document.getElementById('id_related_inspection_type');
    const inspectionSelectWrapper = document.getElementById('inspection-select-wrapper');
    
    if (existingChoice) existingChoice.checked = false;
    if (customerChoice) customerChoice.checked = false;
    if (inspectionSelect) inspectionSelect.value = '';
    if (inspectionTypeInput) inspectionTypeInput.value = '';
    if (inspectionSelectWrapper) inspectionSelectWrapper.style.display = 'none';
}

// ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
document.addEventListener('DOMContentLoaded', function() {
    console.log('ØªØ­Ù…ÙŠÙ„ ØµÙØ­Ø© Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨...');
    
    // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ ØªØºÙŠÙŠØ± radio buttons
    const radioButtons = document.querySelectorAll('input[name="{{ form.selected_type.name }}"]');
    radioButtons.forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.checked) {
                selectOrderType(this.value);
            }
        });
    });
    
    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ
    const selectedRadio = document.querySelector('input[name="{{ form.selected_type.name }}"]:checked');
    if (selectedRadio) {
        selectOrderType(selectedRadio.value);
    }
    
    // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø­Ø§Ù„Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
    const inspectionTypeValue = '{{ form.related_inspection_type.value|default:"" }}';
    const relatedInspectionValue = '{{ form.related_inspection.value|default:"" }}';
    
    if (inspectionTypeValue === 'customer_side') {
        const customerChoice = document.getElementById('use_customer_inspection');
        if (customerChoice) {
            customerChoice.checked = true;
            toggleInspectionChoice();
        }
    } else if (relatedInspectionValue) {
        const existingChoice = document.getElementById('use_existing_inspection');
        if (existingChoice) {
            existingChoice.checked = true;
            toggleInspectionChoice();
        }
    }
    
    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø£Ø®Ø·Ø§Ø¡ ÙÙŠ Ø­Ù‚Ù„ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©ØŒ Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù‚Ø³Ù… ÙˆØ§Ù„ØªÙ…Ø±ÙŠØ± Ø¥Ù„ÙŠÙ‡
    {% if form.related_inspection.errors %}
    console.log('âš ï¸ ÙŠÙˆØ¬Ø¯ Ø®Ø·Ø£ ÙÙŠ Ø­Ù‚Ù„ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© - Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø³Ù…');
    const relatedInspectionSection = document.getElementById('related-inspection-section');
    if (relatedInspectionSection) {
        relatedInspectionSection.style.display = 'block';
        
        // Ø¥Ø¶Ø§ÙØ© Ø­Ø¯ Ø£Ø­Ù…Ø± Ù„Ù„ØªÙ†Ø¨ÙŠÙ‡
        relatedInspectionSection.style.border = '3px solid #dc3545';
        relatedInspectionSection.style.borderRadius = '8px';
        
        // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ù„Ù‚Ø³Ù…
        setTimeout(() => {
            relatedInspectionSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 300);
    }
    {% endif %}
});

// Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
document.getElementById('step2-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    console.log('ğŸ” Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬...');
    
    // Ø¥Ø²Ø§Ù„Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
    clearAllFieldErrors(this);
    document.querySelectorAll('.order-type-card').forEach(card => {
        card.classList.remove('field-required-error');
    });
    
    const missingFields = [];
    let hasErrors = false;
    
    const selectedType = document.querySelector('input[name="{{ form.selected_type.name }}"]:checked');
    if (!selectedType) {
        hasErrors = true;
        missingFields.push('Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨');
        
        // ØªÙ„ÙˆÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø¨Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø­Ù…Ø±
        document.querySelectorAll('.order-type-card').forEach(card => {
            card.classList.add('field-required-error');
        });
        
        // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ø£ÙˆÙ„ Ø¨Ø·Ø§Ù‚Ø©
        const firstCard = document.querySelector('.order-type-card');
        if (firstCard) {
            firstCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        
        showValidationAlert(missingFields);
        return;
    }
    
    console.log('âœ… Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨:', selectedType.value);
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ù„Ù„Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
    const typesRequiringInspection = ['installation', 'tailoring', 'deli', 'accessory'];
    if (typesRequiringInspection.includes(selectedType.value)) {
        console.log('âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ù†ÙˆØ¹ ÙŠØªØ·Ù„Ø¨ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø£Ùˆ Ø·Ø±Ù Ø§Ù„Ø¹Ù…ÙŠÙ„');
        
        const relatedInspectionSection = document.getElementById('related-inspection-section');
        const inspectionSelect = document.querySelector('select[name="{{ form.related_inspection.name }}"]');
        const existingChoice = document.getElementById('use_existing_inspection');
        const customerChoice = document.getElementById('use_customer_inspection');
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ø¹Ø§ÙŠÙ†Ø§Øª Ù…ØªØ§Ø­Ø©
        const hasAvailableInspections = inspectionSelect && inspectionSelect.options.length > 1; // > 1 Ù„Ø£Ù† Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø£ÙˆÙ„ ÙØ§Ø±Øº
        console.log('ğŸ“‹ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©:', inspectionSelect ? inspectionSelect.options.length - 1 : 0);
        
        // âš ï¸ Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø¥Ù„Ø²Ø§Ù…ÙŠ: ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø¹Ø§ÙŠÙ†Ø© Ø£Ùˆ Ø·Ø±Ù Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø­ÙˆØ§Ù„
        if (!existingChoice.checked && !customerChoice.checked) {
            console.error('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ø¹Ø§ÙŠÙ†Ø© Ø£Ùˆ Ø·Ø±Ù Ø§Ù„Ø¹Ù…ÙŠÙ„');
            
            hasErrors = true;
            missingFields.push('Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø£Ùˆ Ø·Ø±Ù Ø§Ù„Ø¹Ù…ÙŠÙ„');
            
            // ØªÙ„ÙˆÙŠÙ† Ù‚Ø³Ù… Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø¨Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø­Ù…Ø±
            if (relatedInspectionSection) {
                relatedInspectionSection.classList.add('field-required-error');
                relatedInspectionSection.style.border = '3px solid #dc3545';
                relatedInspectionSection.style.borderRadius = '8px';
                relatedInspectionSection.style.backgroundColor = '#fff5f5';
                relatedInspectionSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            
            // Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ Ù…Ø­Ø³Ù‘Ù†Ø©
            showValidationAlert([hasAvailableInspections 
                ? 'Ø§Ø®ØªÙŠØ§Ø± Ù…Ø¹Ø§ÙŠÙ†Ø© Ù…Ø±ØªØ¨Ø·Ø© Ø£Ùˆ ØªØ­Ø¯ÙŠØ¯ "Ø·Ø±Ù Ø§Ù„Ø¹Ù…ÙŠÙ„"' 
                : 'ØªØ­Ø¯ÙŠØ¯ "Ø·Ø±Ù Ø§Ù„Ø¹Ù…ÙŠÙ„" (Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§ÙŠÙ†Ø§Øª Ù…ØªØ§Ø­Ø©)']);
            return;
        }
        
        // Ø¥Ø°Ø§ ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ø¹Ø§ÙŠÙ†Ø© Ù…ÙˆØ¬ÙˆØ¯Ø©ØŒ ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± ÙˆØ§Ø­Ø¯Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        if (existingChoice.checked) {
            if (!hasAvailableInspections) {
                console.error('âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§ÙŠÙ†Ø§Øª Ù…ØªØ§Ø­Ø© Ù„Ù„Ø§Ø®ØªÙŠØ§Ø±');
                
                hasErrors = true;
                missingFields.push('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§ÙŠÙ†Ø§Øª Ù…ØªØ§Ø­Ø© - ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ "Ø·Ø±Ù Ø§Ù„Ø¹Ù…ÙŠÙ„"');
                showValidationAlert(missingFields);
                return;
            }
            
            if (!inspectionSelect.value) {
                console.error('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ø¹Ø§ÙŠÙ†Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©');
                
                hasErrors = true;
                missingFields.push('Ø§Ø®ØªÙŠØ§Ø± Ù…Ø¹Ø§ÙŠÙ†Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©');
                
                // ØªÙ„ÙˆÙŠÙ† Ø­Ù‚Ù„ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
                markFieldAsError(inspectionSelect, 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø¹Ø§ÙŠÙ†Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©');
                inspectionSelect.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                showValidationAlert(missingFields);
                return;
            }
        }
        
        console.log('âœ… ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­');
        console.log('   - Ù…Ø¹Ø§ÙŠÙ†Ø© Ù…ÙˆØ¬ÙˆØ¯Ø©:', existingChoice.checked);
        console.log('   - Ø·Ø±Ù Ø§Ù„Ø¹Ù…ÙŠÙ„:', customerChoice.checked);
        if (existingChoice.checked && inspectionSelect) {
            console.log('   - Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©:', inspectionSelect.value);
        }
    } else {
        console.log('â„¹ï¸ Ù‡Ø°Ø§ Ø§Ù„Ù†ÙˆØ¹ Ù„Ø§ ÙŠØªØ·Ù„Ø¨ Ù…Ø¹Ø§ÙŠÙ†Ø©');
    }
    
    console.log('âœ… Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ­Ù‚Ù‚Ø§Øª Ù†Ø¬Ø­Øª - Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬...');
    submitWizardStep(this);
});

// Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø±Ø³Ø§Ø¦Ù„ ØªÙ†Ø¨ÙŠÙ‡ Ù…Ø­Ø³Ù‘Ù†Ø© Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„
function showMobileAlert(title, message, type = 'info') {
    // Ø¥Ù†Ø´Ø§Ø¡ modal Ø¨Ø³ÙŠØ·
    const alertDiv = document.createElement('div');
    alertDiv.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 8px 30px rgba(0,0,0,0.3);
        z-index: 10000;
        max-width: 90%;
        min-width: 280px;
        text-align: center;
        animation: slideIn 0.3s ease-out;
    `;
    
    const colorMap = {
        'warning': '#ffc107',
        'error': '#dc3545',
        'success': '#28a745',
        'info': '#17a2b8'
    };
    
    alertDiv.innerHTML = `
        <style>
            @keyframes slideIn {
                from {
                    opacity: 0;
                    transform: translate(-50%, -60%);
                }
                to {
                    opacity: 1;
                    transform: translate(-50%, -50%);
                }
            }
</style>
        <div style="font-size: 48px; margin-bottom: 15px;">${title}</div>
        <div style="font-size: 18px; margin-bottom: 20px; line-height: 1.5; color: #333;">${message}</div>
        <button onclick="this.closest('div').remove(); document.getElementById('mobile-alert-overlay').remove();" style=" background: ${colorMap[type] || '#17a2b8'}; color: white; border: none; padding: 12px 30px; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; min-width: 120px; -webkit-tap-highlight-color: transparent; ">
            Ø­Ø³Ù†Ø§Ù‹
        </button>
    `;
    
    // Ø¥Ù†Ø´Ø§Ø¡ overlay
    const overlay = document.createElement('div');
    overlay.id = 'mobile-alert-overlay';
    overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        z-index: 9999;
    `;
    
    overlay.onclick = function() {
        alertDiv.remove();
        overlay.remove();
    };
    
    document.body.appendChild(overlay);
    document.body.appendChild(alertDiv);
}
    </script>
{% endblock %}
