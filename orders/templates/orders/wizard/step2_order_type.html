{% extends 'orders/wizard/base_wizard.html' %}
{% load static %}

{% block wizard_content %}
<form method="post" id="step2-form">
    {% csrf_token %}
    
    <div class="mb-4">
        <h5 class="mb-3">
            <i class="fas fa-tags me-2"></i>Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨
            <span class="text-danger">*</span>
        </h5>
        
        {% if form.selected_type.errors %}
            <div class="alert alert-danger">
                {{ form.selected_type.errors }}
            </div>
        {% endif %}
        
        <div class="row g-3">
            {% for choice in form.selected_type.field.choices %}
            <div class="col-md-4 col-sm-6">
                <label for="type_{{ choice.0 }}" class="order-type-label">
                    <div class="card h-100 order-type-card">
                        <div class="card-body text-center">
                            <input type="radio" name="{{ form.selected_type.name }}" 
                                   value="{{ choice.0 }}" 
                                   id="type_{{ choice.0 }}"
                                   {% if form.selected_type.value == choice.0 %}checked{% endif %}
                                   class="order-type-radio">
                            <div class="order-type-icon mb-3">
                                {% if choice.0 == 'accessory' %}
                                    <i class="fas fa-gem fa-3x text-primary"></i>
                                {% elif choice.0 == 'installation' %}
                                    <i class="fas fa-tools fa-3x text-success"></i>
                                {% elif choice.0 == 'inspection' %}
                                    <i class="fas fa-eye fa-3x text-info"></i>
                                {% elif choice.0 == 'tailoring' %}
                                    <i class="fas fa-cut fa-3x text-warning"></i>
                                {% elif choice.0 == 'products' %}
                                    <i class="fas fa-boxes fa-3x text-secondary"></i>
                                {% endif %}
                            </div>
                            <h5>{{ choice.1 }}</h5>
                            <small class="text-muted d-block mt-2">
                                {% if choice.0 == 'accessory' %}
                                    ğŸ”§ Ù…ÙˆØ¬Ù‡ Ø¥Ù„Ù‰ ÙˆØ±Ø´Ø© Ø§Ù„Ø¥ÙƒØ³Ø³ÙˆØ§Ø±
                                {% elif choice.0 == 'installation' %}
                                    ğŸ­ Ù…ÙˆØ¬Ù‡ Ø¥Ù„Ù‰ Ø§Ù„Ù…ØµÙ†Ø¹
                                {% elif choice.0 == 'tailoring' %}
                                    ğŸ“¦ Ù…ÙˆØ¬Ù‡ Ø¥Ù„Ù‰ Ø§Ù„Ù…ØµÙ†Ø¹
                                {% elif choice.0 == 'inspection' %}
                                    ğŸ‘ï¸ Ù…ÙˆØ¬Ù‡ Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø§Øª
                                {% elif choice.0 == 'products' %}
                                    ğŸ“¦ Ù…ÙˆØ¬Ù‡ Ù„Ù„Ù…Ø®Ø§Ø²Ù†
                                {% endif %}
                            </small>
                        </div>
                    </div>
                </label>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- Related Inspection (shown conditionally) -->
    <div id="related-inspection-section" style="display: none;">
        <div class="card border-warning mb-4">
            <div class="card-header bg-warning bg-opacity-10">
                <h5 class="mb-0">
                    <i class="fas fa-eye me-2"></i>Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©
                    <span class="text-danger">*</span>
                </h5>
            </div>
            <div class="card-body">
                {% if form.related_inspection.errors %}
                    <div class="alert alert-danger">
                        {{ form.related_inspection.errors }}
                    </div>
                {% endif %}
                
                <!-- Ø®ÙŠØ§Ø± Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ÙØ¹Ù„ÙŠØ© -->
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="inspection_choice" 
                               id="use_existing_inspection" value="existing" 
                               onchange="toggleInspectionChoice()">
                        <label class="form-check-label fw-bold" for="use_existing_inspection">
                            <i class="fas fa-list me-2"></i>Ø§Ø®ØªÙŠØ§Ø± Ù…Ø¹Ø§ÙŠÙ†Ø© Ù…ÙˆØ¬ÙˆØ¯Ø©
                        </label>
                    </div>
                    <div id="inspection-select-wrapper" class="mt-2" style="display: none; padding-right: 2rem;">
                        <label for="{{ form.related_inspection.id_for_label }}" class="form-label">
                            Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©
                        </label>
                        {{ form.related_inspection }}
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨
                        </div>
                    </div>
                </div>
                
                <!-- Ø®ÙŠØ§Ø± Ø·Ø±Ù Ø§Ù„Ø¹Ù…ÙŠÙ„ -->
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="inspection_choice" 
                               id="use_customer_inspection" value="customer_side" 
                               onchange="toggleInspectionChoice()">
                        <label class="form-check-label fw-bold" for="use_customer_inspection">
                            <i class="fas fa-user-plus me-2"></i>Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§ÙŠÙ†Ø© Ø·Ø±Ù Ø§Ù„Ø¹Ù…ÙŠÙ„
                        </label>
                    </div>
                    <div class="form-text text-muted" style="padding-right: 2rem;">
                        <i class="fas fa-info-circle me-1"></i>
                        Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ø¨Ø¯ÙˆÙ† Ù…Ø¹Ø§ÙŠÙ†Ø© ÙØ¹Ù„ÙŠØ© (Ø·Ø±Ù Ø§Ù„Ø¹Ù…ÙŠÙ„)
                    </div>
                </div>
                
                <!-- Hidden field for related_inspection_type -->
                <input type="hidden" name="{{ form.related_inspection_type.name }}" 
                       id="id_related_inspection_type" value="">
            </div>
        </div>
    </div>
    
    <!-- Actions -->
    <div class="wizard-actions">
        <div>
            <a href="{% url 'orders:wizard_cancel' %}" class="btn btn-wizard btn-wizard-danger me-2">
                <i class="fas fa-times me-2"></i>Ø¥Ù„ØºØ§Ø¡
            </a>
            <a href="{% url 'orders:wizard_step' step=1 %}" class="btn btn-wizard btn-wizard-secondary">
                <i class="fas fa-arrow-right me-2"></i>Ø§Ù„Ø³Ø§Ø¨Ù‚
            </a>
        </div>
        <div>
            <button type="submit" class="btn btn-wizard btn-wizard-primary">
                <i class="fas fa-arrow-left me-2"></i>Ø§Ù„ØªØ§Ù„ÙŠ
            </button>
        </div>
    </div>
</form>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<style>
/* ØªØºÙ„ÙŠÙ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø¨Ù€ label Ù„Ù„Ù†Ù‚Ø± Ø§Ù„Ø³Ù‡Ù„ */
.order-type-label {
    display: block;
    cursor: pointer;
    margin-bottom: 0;
    -webkit-tap-highlight-color: transparent;
}

.order-type-card {
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid #e2e8f0;
    -webkit-tap-highlight-color: transparent;
    user-select: none;
    -webkit-user-select: none;
}

.order-type-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.15);
}

.order-type-card:active {
    transform: scale(0.98);
}

/* Ø¥Ø®ÙØ§Ø¡ radio button */
.order-type-radio {
    position: absolute;
    opacity: 0;
    width: 0;
    height: 0;
}

/* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© */
.order-type-radio:checked + .card-body {
    background: #f0fdf4;
}

.order-type-radio:checked ~ .order-type-card,
.order-type-label:has(.order-type-radio:checked) .order-type-card {
    border-color: #198754;
    background: #f0fdf4;
    box-shadow: 0 4px 12px rgba(25, 135, 84, 0.3);
}

/* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
@media (max-width: 768px) {
    .order-type-card {
        min-height: 180px;
        margin-bottom: 15px;
    }
    
    .order-type-card .card-body {
        padding: 20px 15px;
    }
    
    .order-type-icon {
        margin-bottom: 10px !important;
    }
    
    .order-type-icon i {
        font-size: 2.5rem !important;
    }
    
    .order-type-card h5 {
        font-size: 16px;
        margin-bottom: 8px;
    }
    
    .order-type-card small {
        font-size: 13px;
    }
}
</style>

<script>
// Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„Ù…Ø­Ù…ÙˆÙ„
const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

function selectOrderType(type) {
    console.log('ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨:', type);
    
    // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
    document.querySelectorAll('.order-type-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    const radio = document.getElementById('type_' + type);
    if (radio) {
        radio.checked = true;
        const card = radio.closest('.order-type-card');
        if (card) {
            card.classList.add('selected');
        }
        
        // ØªØ£Ø«ÙŠØ± Ø¨ØµØ±ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„
        if (isTouchDevice && card) {
            card.style.transform = 'scale(0.98)';
            setTimeout(() => {
                card.style.transform = '';
            }, 150);
        }
    }
    
    // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ù‚Ø³Ù… Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©
    const relatedInspectionSection = document.getElementById('related-inspection-section');
    if (['installation', 'tailoring', 'accessory'].includes(type)) {
        relatedInspectionSection.style.display = 'block';
    } else {
        relatedInspectionSection.style.display = 'none';
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ù‚ÙˆÙ„
        resetInspectionFields();
    }
}

function toggleInspectionChoice() {
    const existingChoice = document.getElementById('use_existing_inspection');
    const customerChoice = document.getElementById('use_customer_inspection');
    const inspectionSelectWrapper = document.getElementById('inspection-select-wrapper');
    const inspectionSelect = document.querySelector('select[name="{{ form.related_inspection.name }}"]');
    const inspectionTypeInput = document.getElementById('id_related_inspection_type');
    
    if (existingChoice.checked) {
        // Ø¥Ø¸Ù‡Ø§Ø± Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø§Øª
        inspectionSelectWrapper.style.display = 'block';
        inspectionTypeInput.value = 'inspection';
    } else if (customerChoice.checked) {
        // Ø¥Ø®ÙØ§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø§Øª ÙˆØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù‚ÙŠÙ…Ø©
        inspectionSelectWrapper.style.display = 'none';
        inspectionSelect.value = '';  // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ¯
        inspectionTypeInput.value = 'customer_side';
    }
}

function resetInspectionFields() {
    const existingChoice = document.getElementById('use_existing_inspection');
    const customerChoice = document.getElementById('use_customer_inspection');
    const inspectionSelect = document.querySelector('select[name="{{ form.related_inspection.name }}"]');
    const inspectionTypeInput = document.getElementById('id_related_inspection_type');
    const inspectionSelectWrapper = document.getElementById('inspection-select-wrapper');
    
    if (existingChoice) existingChoice.checked = false;
    if (customerChoice) customerChoice.checked = false;
    if (inspectionSelect) inspectionSelect.value = '';
    if (inspectionTypeInput) inspectionTypeInput.value = '';
    if (inspectionSelectWrapper) inspectionSelectWrapper.style.display = 'none';
}

// ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
document.addEventListener('DOMContentLoaded', function() {
    console.log('ØªØ­Ù…ÙŠÙ„ ØµÙØ­Ø© Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨...');
    
    // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ ØªØºÙŠÙŠØ± radio buttons
    const radioButtons = document.querySelectorAll('input[name="{{ form.selected_type.name }}"]');
    radioButtons.forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.checked) {
                selectOrderType(this.value);
            }
        });
    });
    
    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ
    const selectedRadio = document.querySelector('input[name="{{ form.selected_type.name }}"]:checked');
    if (selectedRadio) {
        selectOrderType(selectedRadio.value);
    }
    
    // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø­Ø§Ù„Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
    const inspectionTypeValue = '{{ form.related_inspection_type.value|default:"" }}';
    const relatedInspectionValue = '{{ form.related_inspection.value|default:"" }}';
    
    if (inspectionTypeValue === 'customer_side') {
        const customerChoice = document.getElementById('use_customer_inspection');
        if (customerChoice) {
            customerChoice.checked = true;
            toggleInspectionChoice();
        }
    } else if (relatedInspectionValue) {
        const existingChoice = document.getElementById('use_existing_inspection');
        if (existingChoice) {
            existingChoice.checked = true;
            toggleInspectionChoice();
        }
    }
});

// Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
document.getElementById('step2-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const selectedType = document.querySelector('input[name="{{ form.selected_type.name }}"]:checked');
    if (!selectedType) {
        alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨');
        return;
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ù„Ù„Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
    const typesRequiringInspection = ['installation', 'tailoring', 'accessory'];
    if (typesRequiringInspection.includes(selectedType.value)) {
        const relatedInspectionSection = document.getElementById('related-inspection-section');
        const inspectionSelect = document.querySelector('select[name="{{ form.related_inspection.name }}"]');
        const hasAvailableInspections = inspectionSelect && inspectionSelect.options.length > 1; // > 1 Ù„Ø£Ù† Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø£ÙˆÙ„ ÙØ§Ø±Øº
        
        if (hasAvailableInspections) {
            const existingChoice = document.getElementById('use_existing_inspection');
            const customerChoice = document.getElementById('use_customer_inspection');
            
            if (!existingChoice.checked && !customerChoice.checked) {
                alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø¹Ø§ÙŠÙ†Ø© Ù…Ø±ØªØ¨Ø·Ø© Ø£Ùˆ ØªØ­Ø¯ÙŠØ¯ "Ø·Ø±Ù Ø§Ù„Ø¹Ù…ÙŠÙ„"');
                return;
            }
            
            if (existingChoice.checked && !inspectionSelect.value) {
                alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø¹Ø§ÙŠÙ†Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©');
                return;
            }
        }
    }
    
    submitWizardStep(this);
});
</script>
{% endblock %}
