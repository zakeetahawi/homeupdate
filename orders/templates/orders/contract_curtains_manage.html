{% extends 'base.html' %}
{% load static %}

{% block title %}إدارة ستائر العقد - {{ order.order_number }}{% endblock %}

{% block extra_css %}
<style>
    .curtain-card {
        border: 1px solid #dee2e6;
        border-radius: 6px;
        padding: 10px;
        margin-bottom: 10px;
        background: #fff;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .curtain-card.active {
        border-color: #0d6efd;
        box-shadow: 0 0 8px rgba(13, 110, 253, 0.2);
    }

    .curtain-header {
        background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
        color: white;
        padding: 6px 10px;
        margin: -10px -10px 10px -10px;
        border-radius: 5px 5px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.9rem;
    }

    .fabric-section, .accessories-section {
        background: #f8f9fa;
        padding: 8px;
        border-radius: 4px;
        margin-bottom: 8px;
    }

    .section-title {
        font-weight: bold;
        color: #0d6efd;
        margin-bottom: 6px;
        padding-bottom: 3px;
        border-bottom: 1px solid #0d6efd;
        font-size: 0.85rem;
    }

    .fabric-group {
        background: white;
        padding: 6px;
        border-radius: 3px;
        margin-bottom: 6px;
        border-right: 2px solid #6c757d;
    }

    .fabric-group.light {
        border-right-color: #ffc107;
    }

    .fabric-group.heavy {
        border-right-color: #dc3545;
    }

    .fabric-group.blackout {
        border-right-color: #212529;
    }

    .fabric-group h6 {
        font-size: 0.8rem;
        margin-bottom: 4px;
    }

    .form-label {
        font-size: 0.75rem;
        margin-bottom: 2px;
    }

    .form-control, .form-select {
        font-size: 0.8rem;
        padding: 4px 8px;
        height: auto;
    }

    .accessories-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 12px;
        margin-top: 12px;
    }

    .accessory-item {
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        border: 2px solid #e3e6ea;
        border-radius: 8px;
        padding: 10px;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .accessory-item:hover {
        border-color: #0d6efd;
        box-shadow: 0 4px 8px rgba(13,110,253,0.15);
        transform: translateY(-2px);
    }

    .accessory-checkbox {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 8px;
        padding: 6px 8px;
        background: linear-gradient(135deg, #e7f3ff 0%, #f0f7ff 100%);
        border-radius: 6px;
        cursor: pointer;
        border: 1px solid #b6d4fe;
        transition: all 0.2s ease;
    }

    .accessory-checkbox:hover {
        background: linear-gradient(135deg, #cfe2ff 0%, #e7f3ff 100%);
        border-color: #0d6efd;
    }

    .accessory-checkbox input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
        accent-color: #0d6efd;
    }

    .accessory-checkbox input[type="checkbox"]:checked {
        background-color: #0d6efd;
    }

    .accessory-checkbox label {
        margin: 0;
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        flex: 1;
        color: #0d6efd;
        text-shadow: 0 1px 1px rgba(255,255,255,0.8);
    }

    .accessory-fields {
        display: none;
        padding: 8px;
        background: #ffffff;
        border-top: 2px solid #e3e6ea;
        margin-top: 6px;
        border-radius: 0 0 6px 6px;
    }

    .accessory-fields.active {
        display: block;
        animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            max-height: 0;
        }
        to {
            opacity: 1;
            max-height: 200px;
        }
    }

    .accessory-fields .form-label {
        font-size: 0.7rem;
        font-weight: 600;
        color: #495057;
        margin-bottom: 3px;
    }

    /* Fabric Groups */
    .fabric-groups-container {
        margin-top: 15px;
    }

    .fabric-group-item {
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        border: 2px solid #dee2e6;
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 12px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .fabric-group-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        padding-bottom: 8px;
        border-bottom: 2px solid #dee2e6;
    }

    .fabric-group-title {
        font-size: 0.95rem;
        font-weight: bold;
        color: #0d6efd;
    }

    .fabric-number {
        background: #0d6efd;
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.8rem;
    }

    .accessory-fields .form-select,
    .accessory-fields .form-control {
        font-size: 0.75rem;
        padding: 4px 6px;
        border-radius: 4px;
        border: 1px solid #ced4da;
        transition: border-color 0.2s ease;
    }

    .accessory-fields .form-select:focus,
    .accessory-fields .form-control:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.2rem rgba(13,110,253,0.15);
    }

    .quantity-error {
        border-color: #dc3545 !important;
        background-color: #fff5f5 !important;
        animation: shake 0.3s ease;
    }

    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-5px); }
        75% { transform: translateX(5px); }
    }

    .quantity-warning {
        font-size: 0.65rem;
        color: #dc3545;
        margin-top: 3px;
        display: none;
        font-weight: 600;
        padding: 2px 4px;
        background: #fff5f5;
        border-radius: 3px;
        border-left: 3px solid #dc3545;
    }

    .quantity-warning.active {
        display: block;
        animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .btn-add-curtain {
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        font-size: 0.9rem;
        padding: 8px 16px;
    }

    .btn-save-all {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        font-size: 0.9rem;
        padding: 8px 16px;
    }

    .row.g-2 {
        margin-bottom: 4px;
    }

    textarea.form-control {
        font-size: 0.75rem;
        padding: 4px 8px;
        min-height: 50px;
    }
    
    .order-info {
        background: linear-gradient(135deg, #e9ecef 0%, #f8f9fa 100%);
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
    }

    /* Order Info Card - Enhanced */
    .order-info-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 25px;
        box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        color: white;
    }

    .order-info-card .card-title {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .order-info-card .card-title i {
        font-size: 1.8rem;
        color: #ffd700;
    }

    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }

    .info-item {
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(10px);
        border-radius: 8px;
        padding: 12px 15px;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .info-item .label {
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        opacity: 0.9;
        margin-bottom: 5px;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .info-item .value {
        font-size: 1.1rem;
        font-weight: 700;
        color: #ffffff;
    }

    .action-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .action-buttons .btn {
        font-weight: 600;
        padding: 8px 20px;
        border-radius: 8px;
        transition: all 0.3s ease;
        border: 2px solid rgba(255, 255, 255, 0.3);
    }

    .action-buttons .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        border-color: rgba(255, 255, 255, 0.6);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- معلومات الطلب - Enhanced -->
    <div class="order-info-card">
        <div class="card-title">
            <i class="fas fa-file-contract"></i>
            إدارة ستائر العقد
        </div>

        <div class="info-grid">
            <div class="info-item">
                <div class="label">
                    <i class="fas fa-hashtag"></i>
                    رقم الطلب
                </div>
                <div class="value">{{ order.order_number }}</div>
            </div>

            <div class="info-item">
                <div class="label">
                    <i class="fas fa-receipt"></i>
                    رقم الفاتورة
                </div>
                <div class="value">{{ order.invoice_number|default:"غير محدد" }}</div>
            </div>

            <div class="info-item">
                <div class="label">
                    <i class="fas fa-user"></i>
                    اسم العميل
                </div>
                <div class="value">{{ order.customer.name }}</div>
            </div>

            <div class="info-item">
                <div class="label">
                    <i class="fas fa-file-signature"></i>
                    رقم العقد
                </div>
                <div class="value">{{ order.contract_number|default:"لم يتم تحديده" }}</div>
            </div>
        </div>

        <div class="action-buttons">
            <a href="{% url 'orders:order_detail_by_number' order.order_number %}" class="btn btn-light">
                <i class="fas fa-arrow-right"></i> العودة للطلب
            </a>
            {% if order.contract_file %}
            <a href="{{ order.contract_file.url }}" target="_blank" class="btn btn-light">
                <i class="fas fa-file-pdf"></i> عرض العقد
            </a>
            {% endif %}
        </div>
    </div>

    <!-- قائمة الستائر -->
    <div id="curtains-container">
        <!-- سيتم إضافة الستائر هنا ديناميكياً -->
    </div>

    <!-- أزرار الإجراءات -->
    <button type="button" class="btn btn-primary btn-lg btn-add-curtain" onclick="addCurtain()">
        <i class="fas fa-plus"></i> إضافة ستارة
    </button>
    
    <button type="button" class="btn btn-success btn-lg btn-save-all" onclick="saveAllCurtains()">
        <i class="fas fa-save"></i> حفظ الكل
    </button>
</div>

<!-- قالب بطاقة الستارة -->
<template id="curtain-template">
    <div class="curtain-card" data-curtain-id="">
        <div class="curtain-header">
            <span class="curtain-title">ستارة جديدة</span>
            <button type="button" class="btn btn-sm btn-danger" onclick="removeCurtain(this)">
                <i class="fas fa-trash"></i> حذف
            </button>
        </div>
        
        <div class="row g-2 mb-2">
            <div class="col-md-3">
                <label class="form-label">اسم الغرفة <span class="text-danger">*</span></label>
                <input type="text" class="form-control room-name" required>
            </div>
            <div class="col-md-2">
                <label class="form-label">العرض (م) <span class="text-danger">*</span></label>
                <input type="number" step="0.01" class="form-control width" required>
            </div>
            <div class="col-md-2">
                <label class="form-label">الطول (م) <span class="text-danger">*</span></label>
                <input type="number" step="0.01" class="form-control height" required>
            </div>
            <div class="col-md-3">
                <label class="form-label">صورة الموديل</label>
                <input type="file" class="form-control curtain-image" accept="image/*">
            </div>
            <div class="col-md-2">
                <label class="form-label">&nbsp;</label>
                <button type="button" class="btn btn-sm btn-outline-secondary w-100" onclick="toggleFabricSection(this)">
                    <i class="fas fa-chevron-down"></i> القماش
                </button>
            </div>
        </div>

        <!-- القماش والأمتار -->
        <div class="fabric-section" style="display: none;">
            <div class="section-title">
                القماش والأمتار
                <button type="button" class="btn btn-sm btn-success float-end" onclick="addFabricGroup(this)">
                    <i class="fas fa-plus"></i> إضافة قماش
                </button>
            </div>

            <!-- حاوية مجموعات القماش -->
            <div class="fabric-groups-container">
                <!-- سيتم إضافة مجموعات القماش هنا -->
            </div>
        </div>

        <!-- الإكسسوارات -->
        <div class="accessories-section" style="display: none;">
            <div class="section-title">
                الإكسسوارات (اختر المطلوب فقط)
                <button type="button" class="btn btn-sm btn-link float-end p-0" onclick="toggleSection(this)">
                    <i class="fas fa-chevron-up"></i>
                </button>
            </div>

            <div class="accessories-grid">
                <!-- خشب -->
                <div class="accessory-item">
                    <div class="accessory-checkbox">
                        <input type="checkbox" class="form-check-input wood-checkbox">
                        <label class="form-check-label">خشب</label>
                    </div>
                    <div class="accessory-fields wood-fields">
                        <div class="mb-1">
                            <label class="form-label">النوع</label>
                            <select class="form-select wood-select" data-accessory="wood"><option value="">-- اختر --</option></select>
                        </div>
                        <div>
                            <label class="form-label">العدد</label>
                            <input type="number" class="form-control wood-quantity" placeholder="0" data-accessory="wood">
                            <div class="quantity-warning wood-warning"></div>
                        </div>
                    </div>
                </div>

                <!-- مجرى -->
                <div class="accessory-item">
                    <div class="accessory-checkbox">
                        <input type="checkbox" class="form-check-input track-checkbox">
                        <label class="form-check-label">مجرى</label>
                    </div>
                    <div class="accessory-fields track-fields">
                        <div class="mb-1">
                            <label class="form-label">النوع</label>
                            <select class="form-select track-type-select" data-accessory="track"><option value="">-- اختر --</option></select>
                        </div>
                        <div>
                            <label class="form-label">العدد</label>
                            <input type="number" class="form-control track-quantity" placeholder="0" data-accessory="track">
                            <div class="quantity-warning track-warning"></div>
                        </div>
                    </div>
                </div>

                <!-- مواسير -->
                <div class="accessory-item">
                    <div class="accessory-checkbox">
                        <input type="checkbox" class="form-check-input pipe-checkbox">
                        <label class="form-check-label">مواسير</label>
                    </div>
                    <div class="accessory-fields pipe-fields">
                        <div class="mb-1">
                            <label class="form-label">النوع</label>
                            <select class="form-select pipe-select" data-accessory="pipe"><option value="">-- اختر --</option></select>
                        </div>
                        <div>
                            <label class="form-label">العدد</label>
                            <input type="number" class="form-control pipe-quantity" placeholder="0" data-accessory="pipe">
                            <div class="quantity-warning pipe-warning"></div>
                        </div>
                    </div>
                </div>

                <!-- كوابيل -->
                <div class="accessory-item">
                    <div class="accessory-checkbox">
                        <input type="checkbox" class="form-check-input bracket-checkbox">
                        <label class="form-check-label">كوابيل</label>
                    </div>
                    <div class="accessory-fields bracket-fields">
                        <div class="mb-1">
                            <label class="form-label">النوع</label>
                            <select class="form-select bracket-select" data-accessory="bracket"><option value="">-- اختر --</option></select>
                        </div>
                        <div>
                            <label class="form-label">العدد</label>
                            <input type="number" class="form-control bracket-quantity" placeholder="0" data-accessory="bracket">
                            <div class="quantity-warning bracket-warning"></div>
                        </div>
                    </div>
                </div>

                <!-- نهايات -->
                <div class="accessory-item">
                    <div class="accessory-checkbox">
                        <input type="checkbox" class="form-check-input finial-checkbox">
                        <label class="form-check-label">نهايات</label>
                    </div>
                    <div class="accessory-fields finial-fields">
                        <div class="mb-1">
                            <label class="form-label">النوع</label>
                            <select class="form-select finial-select" data-accessory="finial"><option value="">-- اختر --</option></select>
                        </div>
                        <div>
                            <label class="form-label">العدد</label>
                            <input type="number" class="form-control finial-quantity" placeholder="0" data-accessory="finial">
                            <div class="quantity-warning finial-warning"></div>
                        </div>
                    </div>
                </div>

                <!-- طبة -->
                <div class="accessory-item">
                    <div class="accessory-checkbox">
                        <input type="checkbox" class="form-check-input ring-checkbox">
                        <label class="form-check-label">طبة</label>
                    </div>
                    <div class="accessory-fields ring-fields">
                        <div class="mb-1">
                            <label class="form-label">النوع</label>
                            <select class="form-select ring-select" data-accessory="ring"><option value="">-- اختر --</option></select>
                        </div>
                        <div>
                            <label class="form-label">العدد</label>
                            <input type="number" class="form-control ring-quantity" placeholder="0" data-accessory="ring">
                            <div class="quantity-warning ring-warning"></div>
                        </div>
                    </div>
                </div>

                <!-- شماعات -->
                <div class="accessory-item">
                    <div class="accessory-checkbox">
                        <input type="checkbox" class="form-check-input hanger-checkbox">
                        <label class="form-check-label">شماعات</label>
                    </div>
                    <div class="accessory-fields hanger-fields">
                        <div class="mb-1">
                            <label class="form-label">النوع</label>
                            <select class="form-select hanger-select" data-accessory="hanger"><option value="">-- اختر --</option></select>
                        </div>
                        <div>
                            <label class="form-label">العدد</label>
                            <input type="number" class="form-control hanger-quantity" placeholder="0" data-accessory="hanger">
                            <div class="quantity-warning hanger-warning"></div>
                        </div>
                    </div>
                </div>

                <!-- فرانشة -->
                <div class="accessory-item">
                    <div class="accessory-checkbox">
                        <input type="checkbox" class="form-check-input valance-checkbox">
                        <label class="form-check-label">فرانشة</label>
                    </div>
                    <div class="accessory-fields valance-fields">
                        <div class="mb-1">
                            <label class="form-label">النوع</label>
                            <select class="form-select valance-select" data-accessory="valance"><option value="">-- اختر --</option></select>
                        </div>
                        <div>
                            <label class="form-label">العدد</label>
                            <input type="number" class="form-control valance-quantity" placeholder="0" data-accessory="valance">
                            <div class="quantity-warning valance-warning"></div>
                        </div>
                    </div>
                </div>

                <!-- شرابة -->
                <div class="accessory-item">
                    <div class="accessory-checkbox">
                        <input type="checkbox" class="form-check-input tassel-checkbox">
                        <label class="form-check-label">شرابة</label>
                    </div>
                    <div class="accessory-fields tassel-fields">
                        <div class="mb-1">
                            <label class="form-label">النوع</label>
                            <select class="form-select tassel-select" data-accessory="tassel"><option value="">-- اختر --</option></select>
                        </div>
                        <div>
                            <label class="form-label">العدد</label>
                            <input type="number" class="form-control tassel-quantity" placeholder="0" data-accessory="tassel">
                            <div class="quantity-warning tassel-warning"></div>
                        </div>
                    </div>
                </div>

                <!-- مرابط -->
                <div class="accessory-item">
                    <div class="accessory-checkbox">
                        <input type="checkbox" class="form-check-input tieback-checkbox">
                        <label class="form-check-label">مرابط</label>
                    </div>
                    <div class="accessory-fields tieback-fields">
                        <div class="mb-1">
                            <label class="form-label">القماش</label>
                            <select class="form-select tieback-fabric-select" data-accessory="tieback"><option value="">-- اختر --</option></select>
                        </div>
                        <div>
                            <label class="form-label">العدد</label>
                            <input type="number" class="form-control tieback-quantity" placeholder="0" data-accessory="tieback">
                            <div class="quantity-warning tieback-warning"></div>
                        </div>
                    </div>
                </div>

                <!-- حزام وسط -->
                <div class="accessory-item">
                    <div class="accessory-checkbox">
                        <input type="checkbox" class="form-check-input belt-checkbox">
                        <label class="form-check-label">حزام وسط</label>
                    </div>
                    <div class="accessory-fields belt-fields">
                        <div class="mb-1">
                            <label class="form-label">النوع</label>
                            <select class="form-select belt-select" data-accessory="belt"><option value="">-- اختر --</option></select>
                        </div>
                        <div>
                            <label class="form-label">العدد</label>
                            <input type="number" class="form-control belt-quantity" placeholder="0" data-accessory="belt">
                            <div class="quantity-warning belt-warning"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- الملاحظات -->
        <div class="mb-3">
            <label class="form-label">ملاحظات وشرح</label>
            <textarea class="form-control notes" rows="3"></textarea>
        </div>
    </div>
</template>

<!-- قالب مجموعة القماش -->
<template id="fabric-group-template">
    <div class="fabric-group-item">
        <div class="fabric-group-header">
            <span class="fabric-group-title">قماش <span class="fabric-number"></span></span>
            <button type="button" class="btn btn-sm btn-danger" onclick="removeFabricGroup(this)">
                <i class="fas fa-trash"></i> حذف
            </button>
        </div>

        <div class="row g-2 mb-2">
            <div class="col-md-3">
                <label class="form-label">نوع القماش</label>
                <select class="form-select fabric-type-select">
                    <option value="">-- اختر --</option>
                    <option value="light">خفيف</option>
                    <option value="heavy">ثقيل</option>
                    <option value="blackout">بلاك أوت</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">اسم القماش</label>
                <select class="form-select fabric-name-select">
                    <option value="">-- اختر --</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">عدد القطع</label>
                <input type="number" class="form-control fabric-pieces-count" min="1" value="1">
            </div>
            <div class="col-md-2">
                <label class="form-label">عدد الأمتار</label>
                <input type="number" step="0.01" class="form-control fabric-meters">
            </div>
            <div class="col-md-2">
                <label class="form-label">نوع التفصيل</label>
                <select class="form-select fabric-tailoring">
                    <option value="">-- اختر --</option>
                    <option value="rings">حلقات</option>
                    <option value="tape">شريط</option>
                    <option value="snap">كبس</option>
                </select>
            </div>
        </div>

        <div class="row g-2">
            <div class="col-md-3">
                <label class="form-label">مقاس الشريط</label>
                <input type="text" class="form-control fabric-tailoring-size" placeholder="فقط للشريط">
            </div>
        </div>
    </div>
</template>

{% endblock %}

{% block extra_js %}
<script>
let curtainCounter = 0;
const orderItems = {{ order_items_json|safe }};

// تحميل الستائر الموجودة عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', function() {
    loadExistingCurtains();
});

// تحميل الستائر الموجودة
function loadExistingCurtains() {
    fetch(`/orders/order/{{ order.id }}/contract/curtains/data/`)
        .then(response => response.json())
        .then(data => {
            if (data.curtains && data.curtains.length > 0) {
                data.curtains.forEach(curtain => {
                    addCurtain(curtain);
                });
            } else {
                // إضافة ستارة واحدة فارغة للبداية
                addCurtain();
            }
        })
        .catch(error => {
            console.error('Error loading curtains:', error);
            addCurtain();
        });
}

// إضافة ستارة جديدة
function addCurtain(data = null) {
    const template = document.getElementById('curtain-template');
    const clone = template.content.cloneNode(true);
    const card = clone.querySelector('.curtain-card');

    curtainCounter++;
    card.dataset.curtainId = data ? data.id : `new-${curtainCounter}`;

    if (data) {
        // ملء البيانات الأساسية
        card.querySelector('.room-name').value = data.room_name || '';
        card.querySelector('.width').value = data.width || '';
        card.querySelector('.height').value = data.height || '';
        card.querySelector('.notes').value = data.notes || '';

        // الإكسسوارات - تفعيل checkbox وملء البيانات
        const accessories = [
            {name: 'wood', hasType: true, typeField: 'wood'},
            {name: 'track', hasType: true, typeField: 'track_type'},
            {name: 'pipe', hasType: true, typeField: 'pipe'},
            {name: 'bracket', hasType: true, typeField: 'bracket'},
            {name: 'finial', hasType: true, typeField: 'finial'},
            {name: 'ring', hasType: true, typeField: 'ring'},
            {name: 'hanger', hasType: true, typeField: 'hanger'},
            {name: 'valance', hasType: true, typeField: 'valance'},
            {name: 'tassel', hasType: true, typeField: 'tassel'},
            {name: 'tieback', hasType: true, typeField: 'tieback_fabric'},
            {name: 'belt', hasType: true, typeField: 'belt'}
        ];

        accessories.forEach(acc => {
            const quantityField = `${acc.name}_quantity`;
            const quantity = data[quantityField];

            if (quantity && quantity > 0) {
                // تفعيل checkbox
                const checkbox = card.querySelector(`.${acc.name}-checkbox`);
                if (checkbox) {
                    checkbox.checked = true;
                    const fields = card.querySelector(`.${acc.name}-fields`);
                    if (fields) fields.classList.add('active');
                }

                // ملء الكمية
                const qtyInput = card.querySelector(`.${acc.name}-quantity`);
                if (qtyInput) qtyInput.value = quantity;

                // ملء النوع
                if (acc.hasType && data[acc.typeField]) {
                    const typeSelect = card.querySelector(`.${acc.name === 'track' ? 'track-type' : acc.name === 'tieback' ? 'tieback-fabric' : acc.name}-select`);
                    if (typeSelect) typeSelect.value = data[acc.typeField];
                }
            }
        });
    }

    document.getElementById('curtains-container').appendChild(card);

    // تهيئة القوائم المنسدلة
    initializeSelects(card);

    // تحميل مجموعات القماش إذا كانت موجودة
    if (data && data.fabrics && data.fabrics.length > 0) {
        data.fabrics.forEach(fabricData => {
            addFabricGroupToCard(card, fabricData);
        });
    }

    // تحديث عنوان البطاقة
    updateCurtainTitle(card);
}

// تهيئة القوائم المنسدلة
function initializeSelects(card) {
    // ملء القوائم بعناصر الفاتورة
    const selects = {
        '.wood-select': orderItems,
        '.track-type-select': orderItems,
        '.pipe-select': orderItems,
        '.bracket-select': orderItems,
        '.finial-select': orderItems,
        '.ring-select': orderItems,
        '.hanger-select': orderItems,
        '.valance-select': orderItems,
        '.tassel-select': orderItems,
        '.tieback-fabric-select': orderItems,
        '.belt-select': orderItems
    };

    Object.keys(selects).forEach(selector => {
        const select = card.querySelector(selector);
        if (!select) return;

        // مسح الخيارات الموجودة (ما عدا الخيار الافتراضي)
        while (select.options.length > 1) {
            select.remove(1);
        }

        orderItems.forEach(item => {
            const option = document.createElement('option');
            option.value = item.id;
            option.textContent = `${item.product_name} (متوفر: ${item.quantity})`;
            select.appendChild(option);
        });
    });

    // إضافة event listeners للـ checkboxes
    setupAccessoryCheckboxes(card);

    // إضافة مجموعة قماش واحدة افتراضياً
    const fabricContainer = card.querySelector('.fabric-groups-container');
    if (fabricContainer && fabricContainer.children.length === 0) {
        addFabricGroupToCard(card);
    }
}

// إضافة مجموعة قماش جديدة
function addFabricGroup(button) {
    const card = button.closest('.curtain-card');
    addFabricGroupToCard(card);
}

// إضافة مجموعة قماش إلى بطاقة محددة
function addFabricGroupToCard(card, data = null) {
    const template = document.getElementById('fabric-group-template');
    const clone = template.content.cloneNode(true);
    const fabricGroup = clone.querySelector('.fabric-group-item');

    const container = card.querySelector('.fabric-groups-container');
    const currentCount = container.children.length + 1;

    // تحديث رقم القماش
    fabricGroup.querySelector('.fabric-number').textContent = currentCount;

    // إضافة المجموعة
    container.appendChild(clone);

    // الحصول على العنصر المضاف
    const addedGroup = container.lastElementChild;

    // ملء قائمة اسم القماش
    const fabricNameSelect = addedGroup.querySelector('.fabric-name-select');
    orderItems.forEach(item => {
        const option = document.createElement('option');
        option.value = item.id;
        option.textContent = `${item.product_name} (متوفر: ${item.quantity})`;
        fabricNameSelect.appendChild(option);
    });

    // ملء البيانات إذا كانت موجودة
    if (data) {
        if (data.fabric_type) {
            addedGroup.querySelector('.fabric-type-select').value = data.fabric_type;
        }
        if (data.fabric_id) {
            addedGroup.querySelector('.fabric-name-select').value = data.fabric_id;
        }
        if (data.pieces_count) {
            addedGroup.querySelector('.fabric-pieces-count').value = data.pieces_count;
        }
        if (data.meters) {
            addedGroup.querySelector('.fabric-meters').value = data.meters;
        }
        if (data.tailoring) {
            addedGroup.querySelector('.fabric-tailoring').value = data.tailoring;
        }
        if (data.tailoring_size) {
            addedGroup.querySelector('.fabric-tailoring-size').value = data.tailoring_size;
        }
    }
}

// حذف مجموعة قماش
function removeFabricGroup(button) {
    const fabricGroup = button.closest('.fabric-group-item');
    const container = fabricGroup.parentElement;

    fabricGroup.remove();

    // إعادة ترقيم المجموعات
    const groups = container.querySelectorAll('.fabric-group-item');
    groups.forEach((group, index) => {
        group.querySelector('.fabric-number').textContent = index + 1;
    });
}

// إعداد checkboxes للإكسسوارات
function setupAccessoryCheckboxes(card) {
    const accessories = [
        'wood', 'track', 'pipe', 'bracket', 'finial',
        'ring', 'hanger', 'valance', 'tassel', 'tieback', 'belt'
    ];

    accessories.forEach(acc => {
        const checkbox = card.querySelector(`.${acc}-checkbox`);
        const fields = card.querySelector(`.${acc}-fields`);

        if (checkbox && fields) {
            checkbox.addEventListener('change', function() {
                if (this.checked) {
                    fields.classList.add('active');
                } else {
                    fields.classList.remove('active');
                    // مسح القيم عند إلغاء التحديد
                    const inputs = fields.querySelectorAll('input, select');
                    inputs.forEach(input => {
                        input.value = '';
                    });
                    // إزالة رسائل الخطأ
                    const warning = card.querySelector(`.${acc}-warning`);
                    if (warning) {
                        warning.classList.remove('active');
                        warning.textContent = '';
                    }
                }
            });
        }
    });

    // إضافة التحقق من الكميات
    setupQuantityValidation(card);
}

// التحقق من الكميات مقارنة بالفاتورة
function setupQuantityValidation(card) {
    const quantityInputs = card.querySelectorAll('input[type="number"][data-accessory]');
    const selects = card.querySelectorAll('select[data-accessory]');

    // التحقق عند تغيير الكمية
    quantityInputs.forEach(input => {
        input.addEventListener('input', function() {
            validateQuantity(this, card);
        });
    });

    // التحقق عند تغيير النوع
    selects.forEach(select => {
        select.addEventListener('change', function() {
            const accessory = this.dataset.accessory;
            const quantityInput = card.querySelector(`.${accessory}-quantity`);
            if (quantityInput) {
                validateQuantity(quantityInput, card);
            }
        });
    });
}

// دالة التحقق من الكمية
function validateQuantity(input, card) {
    const accessory = input.dataset.accessory;
    const quantity = parseFloat(input.value) || 0;

    if (quantity <= 0) {
        clearValidationError(input, accessory, card);
        return;
    }

    // الحصول على العنصر المحدد
    let selectedItemId = null;

    const selectClass = accessory === 'track' ? 'track-type-select' :
                       accessory === 'tieback' ? 'tieback-fabric-select' :
                       `${accessory}-select`;
    const select = card.querySelector(`.${selectClass}`);
    selectedItemId = select ? select.value : null;

    if (!selectedItemId) {
        clearValidationError(input, accessory, card);
        return;
    }

    // البحث عن العنصر في الفاتورة
    const orderItem = orderItems.find(item => item.id == selectedItemId);

    if (!orderItem) {
        clearValidationError(input, accessory, card);
        return;
    }

    // التحقق من الكمية
    if (quantity > orderItem.quantity) {
        showValidationError(input, accessory, card, orderItem.quantity);
    } else {
        clearValidationError(input, accessory, card);
    }
}

// إظهار رسالة خطأ
function showValidationError(input, accessory, card, availableQty) {
    input.classList.add('quantity-error');
    const warning = card.querySelector(`.${accessory}-warning`);
    if (warning) {
        warning.classList.add('active');
        warning.textContent = `⚠️ الكمية المتاحة: ${availableQty}`;
    }
}

// إزالة رسالة الخطأ
function clearValidationError(input, accessory, card) {
    input.classList.remove('quantity-error');
    const warning = card.querySelector(`.${accessory}-warning`);
    if (warning) {
        warning.classList.remove('active');
        warning.textContent = '';
    }
}

// حذف ستارة
function removeCurtain(button) {
    if (confirm('هل أنت متأكد من حذف هذه الستارة؟')) {
        button.closest('.curtain-card').remove();
    }
}

// تحديث عنوان البطاقة
function updateCurtainTitle(card) {
    const roomName = card.querySelector('.room-name').value;
    const title = card.querySelector('.curtain-title');
    if (roomName) {
        title.textContent = `ستارة ${roomName}`;
    } else {
        title.textContent = 'ستارة جديدة';
    }
}

// حفظ جميع الستائر
function saveAllCurtains() {
    const cards = document.querySelectorAll('.curtain-card');
    const curtains = [];

    cards.forEach((card, index) => {
        // جمع مجموعات القماش
        const fabricGroups = [];
        const fabricGroupElements = card.querySelectorAll('.fabric-group-item');
        fabricGroupElements.forEach(group => {
            const fabricType = group.querySelector('.fabric-type-select')?.value;
            const fabricId = group.querySelector('.fabric-name-select')?.value;
            const piecesCount = group.querySelector('.fabric-pieces-count')?.value;
            const meters = group.querySelector('.fabric-meters')?.value;
            const tailoring = group.querySelector('.fabric-tailoring')?.value;
            const tailoringSize = group.querySelector('.fabric-tailoring-size')?.value;

            // فقط إضافة المجموعات التي تحتوي على بيانات
            if (fabricType || fabricId || meters) {
                fabricGroups.push({
                    fabric_type: fabricType || '',
                    fabric_id: fabricId || null,
                    pieces_count: piecesCount || 1,
                    meters: meters || '',
                    tailoring: tailoring || '',
                    tailoring_size: tailoringSize || ''
                });
            }
        });

        const curtain = {
            id: card.dataset.curtainId.startsWith('new-') ? null : card.dataset.curtainId,
            sequence: index + 1,
            room_name: card.querySelector('.room-name').value,
            width: card.querySelector('.width').value,
            height: card.querySelector('.height').value,

            // مجموعات القماش الجديدة
            fabrics: fabricGroups,

            // الإكسسوارات
            wood: card.querySelector('.wood-select')?.value || null,
            wood_quantity: card.querySelector('.wood-quantity')?.value || 0,
            track_type: card.querySelector('.track-type-select')?.value || null,
            track_quantity: card.querySelector('.track-quantity')?.value || 0,
            pipe: card.querySelector('.pipe-select')?.value || null,
            pipe_quantity: card.querySelector('.pipe-quantity')?.value || 0,
            bracket: card.querySelector('.bracket-select')?.value || null,
            bracket_quantity: card.querySelector('.bracket-quantity')?.value || 0,
            finial: card.querySelector('.finial-select')?.value || null,
            finial_quantity: card.querySelector('.finial-quantity')?.value || 0,
            ring: card.querySelector('.ring-select')?.value || null,
            ring_quantity: card.querySelector('.ring-quantity')?.value || 0,
            hanger: card.querySelector('.hanger-select')?.value || null,
            hanger_quantity: card.querySelector('.hanger-quantity')?.value || 0,
            valance: card.querySelector('.valance-select')?.value || null,
            valance_quantity: card.querySelector('.valance-quantity')?.value || 0,
            tassel: card.querySelector('.tassel-select')?.value || null,
            tassel_quantity: card.querySelector('.tassel-quantity')?.value || 0,
            tieback_fabric: card.querySelector('.tieback-fabric-select')?.value || null,
            tieback_quantity: card.querySelector('.tieback-quantity')?.value || 0,
            belt: card.querySelector('.belt-select')?.value || null,
            belt_quantity: card.querySelector('.belt-quantity')?.value || 0,

            notes: card.querySelector('.notes')?.value || ''
        };

        curtains.push(curtain);
    });

    // إرسال البيانات
    fetch(`/orders/order/{{ order.id }}/contract/curtains/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ curtains: curtains })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('تم حفظ الستائر بنجاح!');
            location.reload();
        } else {
            alert('حدث خطأ: ' + (data.message || 'خطأ غير معروف'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('حدث خطأ أثناء الحفظ');
    });
}

// تحديث العنوان عند تغيير اسم الغرفة
document.addEventListener('input', function(e) {
    if (e.target.classList.contains('room-name')) {
        updateCurtainTitle(e.target.closest('.curtain-card'));
    }
});

// دالة لطي/فتح الأقسام
function toggleSection(button) {
    const section = button.closest('.fabric-section, .accessories-section');
    const icon = button.querySelector('i');
    const content = section.querySelectorAll('.fabric-group, .accessory-item');

    content.forEach(item => {
        if (item.style.display === 'none') {
            item.style.display = 'block';
            icon.classList.remove('fa-chevron-down');
            icon.classList.add('fa-chevron-up');
        } else {
            item.style.display = 'none';
            icon.classList.remove('fa-chevron-up');
            icon.classList.add('fa-chevron-down');
        }
    });
}

// دالة لفتح قسم القماش
function toggleFabricSection(button) {
    const card = button.closest('.curtain-card');
    const fabricSection = card.querySelector('.fabric-section');
    const accessoriesSection = card.querySelector('.accessories-section');

    if (fabricSection.style.display === 'none') {
        fabricSection.style.display = 'block';
        accessoriesSection.style.display = 'block';
        button.innerHTML = '<i class="fas fa-chevron-up"></i> إخفاء';
    } else {
        fabricSection.style.display = 'none';
        accessoriesSection.style.display = 'none';
        button.innerHTML = '<i class="fas fa-chevron-down"></i> القماش';
    }
}

// Event delegation للـ checkboxes
document.addEventListener('change', function(e) {
    if (e.target.classList.contains('form-check-input') &&
        e.target.classList.toString().includes('-checkbox')) {
        const card = e.target.closest('.curtain-card');
        if (card) {
            setupAccessoryCheckboxes(card);
        }
    }
});
</script>
{% endblock %}

