{% extends 'base.html' %}
{% load static %}

{% block title %}Ù…Ø­Ø±Ø± Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø¨Ø³ÙŠØ· - ØªØµÙ…ÙŠÙ… Ø³Ù‡Ù„ ÙˆØ³Ø±ÙŠØ¹{% endblock %}

{% block extra_css %}
<style>
/* Ù…Ø­Ø±Ø± Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø¨Ø³ÙŠØ· */
.simple-editor {
    background: #f8f9fa;
    min-height: 100vh;
    padding: 20px 0;
}

.editor-header {
    background: linear-gradient(135deg, #0d6efd 0%, #198754 100%);
    color: white;
    padding: 20px;
    border-radius: 10px 10px 0 0;
    text-align: center;
}

.editor-body {
    background: white;
    border-radius: 0 0 10px 10px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    overflow: hidden;
}

/* Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ Ø§Ù„Ø¨Ø³ÙŠØ· */
.simple-toolbar {
    background: #fff;
    border-bottom: 1px solid #dee2e6;
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 10px;
}

.toolbar-left {
    display: flex;
    gap: 10px;
    align-items: center;
}

.toolbar-right {
    display: flex;
    gap: 10px;
    align-items: center;
}

.simple-btn {
    background: #0d6efd;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 5px;
}

.simple-btn:hover {
    background: #0b5ed7;
    transform: translateY(-1px);
}

.simple-btn.secondary {
    background: #6c757d;
}

.simple-btn.secondary:hover {
    background: #5a6268;
}

.simple-btn.success {
    background: #198754;
}

.simple-btn.success:hover {
    background: #157347;
}

/* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ØªØ­Ø±ÙŠØ± Ø§Ù„Ù…Ø¨Ø³Ø·Ø© */
.editor-content {
    display: flex;
    min-height: 70vh;
}

/* Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ø³ÙŠØ·Ø© */
.settings-panel {
    width: 300px;
    background: #f8f9fa;
    border-right: 1px solid #dee2e6;
    padding: 20px;
    overflow-y: auto;
}

.setting-group {
    background: white;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}

.setting-title {
    font-weight: bold;
    color: #495057;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.setting-row {
    margin-bottom: 12px;
}

.setting-label {
    display: block;
    font-size: 13px;
    color: #6c757d;
    margin-bottom: 5px;
}

.setting-input {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    font-size: 14px;
    transition: border-color 0.3s ease;
}

.setting-input:focus {
    outline: none;
    border-color: #0d6efd;
    box-shadow: 0 0 0 2px rgba(13,110,253,0.25);
}

.setting-checkbox {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
}

.setting-checkbox input {
    margin: 0;
}

/* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© */
.preview-area {
    flex: 1;
    padding: 30px;
    background: #fff;
    overflow: auto;
}

.invoice-paper {
    max-width: 800px;
    margin: 0 auto;
    background: white;
    box-shadow: 0 0 20px rgba(0,0,0,0.1);
    border-radius: 8px;
    overflow: hidden;
    font-family: 'Cairo', sans-serif;
}

/* Ø±Ø£Ø³ Ø§Ù„ÙØ§ØªÙˆØ±Ø© */
.invoice-header {
    background: var(--header-bg, linear-gradient(135deg, #0d6efd 0%, #198754 100%));
    color: white;
    padding: 30px;
    text-align: center;
    position: relative;
}

.company-logo {
    max-width: 120px;
    max-height: 80px;
    margin-bottom: 15px;
}

.company-name {
    font-size: 28px;
    font-weight: bold;
    margin-bottom: 10px;
}

.company-details {
    font-size: 14px;
    opacity: 0.9;
    line-height: 1.6;
}

.invoice-title {
    position: absolute;
    top: 30px;
    left: 30px;
    background: rgba(255,255,255,0.2);
    padding: 10px 20px;
    border-radius: 20px;
    font-size: 18px;
    font-weight: bold;
}

/* Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ÙØ§ØªÙˆØ±Ø© */
.invoice-content {
    padding: 30px;
}

.invoice-info {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 30px;
    margin-bottom: 30px;
}

.info-section {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    border-left: 4px solid var(--accent-color, #0d6efd);
}

.info-title {
    font-weight: bold;
    color: #495057;
    margin-bottom: 15px;
    font-size: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.info-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    font-size: 14px;
}

.info-label {
    color: #6c757d;
    font-weight: 500;
}

.info-value {
    color: #212529;
    font-weight: 600;
}

/* Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ù†Ø§ØµØ± */
.items-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 30px;
    font-size: 14px;
}

.items-table th {
    background: var(--accent-color, #0d6efd);
    color: white;
    padding: 15px 10px;
    text-align: center;
    font-weight: bold;
}

.items-table td {
    padding: 12px 10px;
    text-align: center;
    border-bottom: 1px solid #dee2e6;
}

.items-table tr:nth-child(even) {
    background: #f8f9fa;
}

/* Ø§Ù„Ù…Ø¬Ø§Ù…ÙŠØ¹ */
.totals-section {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 30px;
}

.total-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
    font-size: 14px;
}

.total-row.final {
    font-size: 18px;
    font-weight: bold;
    color: var(--accent-color, #0d6efd);
    border-top: 2px solid var(--accent-color, #0d6efd);
    padding-top: 10px;
    margin-top: 15px;
}

/* ØªØ°ÙŠÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© */
.invoice-footer {
    background: #f8f9fa;
    padding: 20px;
    text-align: center;
    border-top: 1px solid #dee2e6;
    font-size: 13px;
    color: #6c757d;
}

/* Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© */
@media (max-width: 768px) {
    .editor-content {
        flex-direction: column;
    }
    
    .settings-panel {
        width: 100%;
    }
    
    .simple-toolbar {
        flex-direction: column;
        gap: 15px;
    }
    
    .invoice-info {
        grid-template-columns: 1fr;
        gap: 15px;
    }
}

/* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© */
.color-picker {
    width: 40px;
    height: 30px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

.template-selector {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
    gap: 10px;
    margin-top: 10px;
}

.template-option {
    background: white;
    border: 2px solid #dee2e6;
    border-radius: 6px;
    padding: 10px;
    cursor: pointer;
    text-align: center;
    transition: all 0.3s ease;
    font-size: 12px;
}

.template-option:hover {
    border-color: #0d6efd;
}

.template-option.active {
    border-color: #198754;
    background: rgba(25,135,84,0.1);
}

.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}

.loading-spinner {
    width: 50px;
    height: 50px;
    border: 5px solid #f3f3f3;
    border-top: 5px solid #0d6efd;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* ØªØµØºÙŠØ± ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø®Ø·ÙˆØ· Ø­Ø³Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù†Ø§ØµØ± */
.dynamic-sizing {
    font-size: calc(14px - min(var(--item-count, 0) * 0.3px, 4px));
}

.items-table.dynamic-sizing {
    font-size: calc(12px - min(var(--item-count, 0) * 0.2px, 3px));
}

.items-table.dynamic-sizing th,
.items-table.dynamic-sizing td {
    padding: calc(8px - min(var(--item-count, 0) * 0.1px, 3px));
}

/* Ù…ØªØºÙŠØ±Ø§Øª CSS Ù„Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ */
:root {
    --item-count: 5; /* Ø¹Ø¯Ø¯ Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© */
}
</style>
{% endblock %}

{% block content %}
<div class="simple-editor">
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <!-- Ø±Ø£Ø³ Ø§Ù„Ù…Ø­Ø±Ø± -->
                <div class="editor-header">
                    <h2><i class="fas fa-edit me-2"></i>Ù…Ø­Ø±Ø± Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø¨Ø³ÙŠØ·</h2>
                    <p class="mb-0">ØµÙ…Ù… ÙØ§ØªÙˆØ±ØªÙƒ Ø¨Ø³Ù‡ÙˆÙ„Ø© ÙˆØ³Ø±Ø¹Ø©</p>
                </div>
                
                <div class="editor-body">
                    <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¨Ø³ÙŠØ· -->
                    <div class="simple-toolbar">
                        <div class="toolbar-left">
                            <button class="simple-btn" onclick="loadDefaultTemplate(true)">
                                <i class="fas fa-sync"></i>
                                ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
                            </button>
                        </div>
                        <div class="toolbar-right">
                            <button class="simple-btn" onclick="previewInvoice()">
                                <i class="fas fa-eye"></i>
                                Ù…Ø¹Ø§ÙŠÙ†Ø©
                            </button>
                            <button class="simple-btn success" onclick="saveTemplate()">
                                <i class="fas fa-save"></i>
                                Ø­ÙØ¸ Ø§Ù„Ù‚Ø§Ù„Ø¨
                            </button>
                        </div>
                    </div>
                    
                    <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ø­Ø±Ø± -->
                    <div class="editor-content">
                        <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
                        <div class="settings-panel">
                            <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø© -->
                            <div class="setting-group">
                                <div class="setting-title">
                                    <i class="fas fa-file-invoice"></i>
                                    Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø©
                                </div>
                                <div class="setting-row">
                                    <label class="setting-label">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙØ§ØªÙˆØ±Ø©</label>
                                    <input type="text" class="setting-input" id="invoice-title" 
                                           value="ÙØ§ØªÙˆØ±Ø©"
                                           onchange="updatePreview()">
                                </div>
                            </div>
                            
                            <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ© -->
                            <div class="setting-group">
                                <div class="setting-title">
                                    <i class="fas fa-building"></i>
                                    Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ©
                                </div>
                                <div class="setting-row">
                                    <label class="setting-label">Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©</label>
                                    <input type="text" class="setting-input" id="company-name" 
                                           value="{{ company_info.name|default:'Ø´Ø±ÙƒØ© Ø§Ù„Ø®ÙˆØ§Ø¬Ù‡ Ù„Ù„Ø³ØªØ§Ø¦Ø± ÙˆØ§Ù„Ù…ÙØ±ÙˆØ´Ø§Øª' }}"
                                           onchange="updatePreview()">
                                </div>
                                <div class="setting-row">
                                    <label class="setting-label">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø´Ø±ÙƒØ©</label>
                                    <textarea class="setting-input" id="company-address" rows="2" 
                                              onchange="updatePreview()">{{ company_info.address|default:'Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©' }}</textarea>
                                </div>
                                <div class="setting-row">
                                    <label class="setting-label">Ù‡Ø§ØªÙ Ø§Ù„Ø´Ø±ÙƒØ©</label>
                                    <input type="text" class="setting-input" id="company-phone" 
                                           value="{{ company_info.phone|default:'+966 XX XXX XXXX' }}"
                                           onchange="updatePreview()">
                                </div>
                                <div class="setting-row">
                                    <label class="setting-label">Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø´Ø±ÙƒØ©</label>
                                    <input type="email" class="setting-input" id="company-email" 
                                           value="{{ company_info.email|default:'info@company.com' }}"
                                           onchange="updatePreview()">
                                </div>
                            </div>
                            
                            <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ù„ÙˆØ§Ù† -->
                            <div class="setting-group">
                                <div class="setting-title">
                                    <i class="fas fa-palette"></i>
                                    Ø§Ù„Ø£Ù„ÙˆØ§Ù† ÙˆØ§Ù„ØªØµÙ…ÙŠÙ…
                                </div>
                                <div class="setting-row">
                                    <label class="setting-label">Ù„ÙˆÙ† Ø§Ù„Ø±Ø£Ø³</label>
                                    <input type="color" class="color-picker" id="header-color" 
                                           value="#0d6efd" onchange="updatePreview()">
                                </div>
                                <div class="setting-row">
                                    <label class="setting-label">Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ù…Ù…ÙŠØ²</label>
                                    <input type="color" class="color-picker" id="accent-color" 
                                           value="#198754" onchange="updatePreview()">
                                </div>
                                <div class="setting-row">
                                    <label class="setting-label">Ø­Ø¬Ù… Ø§Ù„Ø®Ø·</label>
                                    <select class="setting-input" id="font-size" onchange="updatePreview()">
                                        <option value="12">ØµØºÙŠØ± (12px)</option>
                                        <option value="14" selected>Ù…ØªÙˆØ³Ø· (14px)</option>
                                        <option value="16">ÙƒØ¨ÙŠØ± (16px)</option>
                                        <option value="18">ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹ (18px)</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø­ØªÙˆÙ‰ -->
                            <div class="setting-group">
                                <div class="setting-title">
                                    <i class="fas fa-list-check"></i>
                                    Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙØ§ØªÙˆØ±Ø©
                                </div>
                                <div class="setting-checkbox">
                                    <input type="checkbox" id="show-logo" checked onchange="updatePreview()">
                                    <label for="show-logo">Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø¹Ø§Ø± Ø§Ù„Ø´Ø±ÙƒØ©</label>
                                </div>
                                <div class="setting-checkbox">
                                    <input type="checkbox" id="show-background-logo" onchange="updatePreview()">
                                    <label for="show-background-logo">Ø´Ø¹Ø§Ø± Ø´ÙØ§Ù ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©</label>
                                </div>
                                <div class="setting-checkbox">
                                    <input type="checkbox" id="show-order-number" checked onchange="updatePreview()">
                                    <label for="show-order-number">Ø¥Ø¸Ù‡Ø§Ø± Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</label>
                                </div>
                                <div class="setting-checkbox">
                                    <input type="checkbox" id="show-order-type" checked onchange="updatePreview()">
                                    <label for="show-order-type">Ø¥Ø¸Ù‡Ø§Ø± Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨</label>
                                </div>
                                <div class="setting-checkbox">
                                    <input type="checkbox" id="show-customer-info" checked onchange="updatePreview()">
                                    <label for="show-customer-info">Ø¥Ø¸Ù‡Ø§Ø± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                                </div>
                                <div class="setting-checkbox">
                                    <input type="checkbox" id="show-items-table" checked onchange="updatePreview()">
                                    <label for="show-items-table">Ø¥Ø¸Ù‡Ø§Ø± Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ù†Ø§ØµØ±</label>
                                </div>
                                <div class="setting-checkbox">
                                    <input type="checkbox" id="show-totals" checked onchange="updatePreview()">
                                    <label for="show-totals">Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø¬Ø§Ù…ÙŠØ¹</label>
                                </div>
                                <div class="setting-checkbox">
                                    <input type="checkbox" id="show-notes" checked onchange="updatePreview()">
                                    <label for="show-notes">Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                                </div>
                            </div>
                            
                            <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø© -->
                            <div class="setting-group">
                                <div class="setting-title">
                                    <i class="fas fa-coins"></i>
                                    Ø§Ù„Ø¹Ù…Ù„Ø©
                                </div>
                                <div class="setting-row">
                                    <label class="setting-label">Ø±Ù…Ø² Ø§Ù„Ø¹Ù…Ù„Ø©</label>
                                    <input type="text" class="setting-input" id="currency-symbol" 
                                           value="{{ currency_symbol|default:'Ø±ÙŠØ§Ù„' }}" readonly>
                                    <small class="text-muted">ÙŠØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© -->
                        <div class="preview-area">
                            <div class="invoice-paper" id="invoice-preview">
                                <!-- Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù‡Ù†Ø§ -->
                                <div class="text-center p-5" style="color: #6c757d;">
                                    <i class="fas fa-file-invoice fa-3x mb-3"></i>
                                    <h4>Ø§Ø®ØªØ± Ù‚Ø§Ù„Ø¨Ø§Ù‹ Ù„Ø¨Ø¯Ø¡ Ø§Ù„ØªØµÙ…ÙŠÙ…</h4>
                                    <p>Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù„Ø§Ø®ØªÙŠØ§Ø± Ù‚Ø§Ù„Ø¨ Ø£Ùˆ Ø§Ø¨Ø¯Ø£ Ù…Ù† Ø§Ù„ØµÙØ±</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
<div class="loading-overlay" id="loading-overlay">
    <div class="loading-spinner"></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
let currentTemplate = null;

// Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù… (JSON Ø¢Ù…Ù†)
window.SAVED_HTML = window.SAVED_HTML || ({{ saved_html_json|default:"''"|safe }});
window.SAVED_META = window.SAVED_META || ({{ saved_meta_json|default:'null'|safe }});

let companyInfo = {
    name: '{{ company_info.name|default:"Ø´Ø±ÙƒØ© Ø§Ù„Ø®ÙˆØ§Ø¬Ù‡ Ù„Ù„Ø³ØªØ§Ø¦Ø± ÙˆØ§Ù„Ù…ÙØ±ÙˆØ´Ø§Øª" }}',
    address: '{{ company_info.address|default:"Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©" }}',
    phone: '{{ company_info.phone|default:"+966 XX XXX XXXX" }}',
    email: '{{ company_info.email|default:"info@company.com" }}',
    logo_url: '{% if company_info.logo %}{{ company_info.logo.url }}{% else %}/static/img/logo.png{% endif %}'
};

let systemSettings = {
    currency_symbol: '{{ currency_symbol|default:"Ø±ÙŠØ§Ù„" }}',
    currency_code: '{{ system_settings.currency|default:"SAR" }}'
};

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
function loadTemplate(templateType = 'default') {
    showLoading();
    currentTemplate = 'default';
    
    setTimeout(() => {
        if (window.SAVED_HTML && window.SAVED_HTML.length > 50) {
            const preview = document.getElementById('invoice-preview');
            preview.innerHTML = window.SAVED_HTML;
        } else {
            loadDefaultTemplate();
        }
        hideLoading();
    }, 500);
}

// ØªÙ… Ø­Ø°Ù Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø§Ù„Ø­Ø¯ÙŠØ« - Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ„Ø§Ø³ÙŠÙƒÙŠ ÙÙ‚Ø·

function loadDefaultTemplate(force = false) {
    const preview = document.getElementById('invoice-preview');
    
    // Ø´Ø¹Ø§Ø± Ø´ÙØ§Ù ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©
    const backgroundLogo = document.getElementById('show-background-logo').checked ? 
        `<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); opacity: 0.05; z-index: 0; pointer-events: none;">
            <img src="${companyInfo.logo_url}" alt="Ø´Ø¹Ø§Ø± Ø®Ù„ÙÙŠØ©" style="max-width: 400px; max-height: 400px;">
        </div>` : '';
    
    if (!force && window.SAVED_HTML && window.SAVED_HTML.length > 50) {
        preview.innerHTML = window.SAVED_HTML;
        return;
    }

    preview.innerHTML = `
        <div style="position: relative; min-height: 800px;">
            ${backgroundLogo}
            
            <!-- Ø±Ø£Ø³ Ø§Ù„ÙØ§ØªÙˆØ±Ø© -->
            <div style="padding: 30px; border-bottom: 3px solid var(--accent-color, #0d6efd); position: relative; z-index: 1;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div class="company-logo-container" style="display: ${document.getElementById('show-logo').checked ? 'block' : 'none'}">
                            <img src="${companyInfo.logo_url}" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ø´Ø±ÙƒØ©" style="max-width: 100px; max-height: 60px;">
                        </div>
                        <h2 style="color: var(--accent-color, #0d6efd); margin: 10px 0;" id="preview-company-name">${companyInfo.name}</h2>
                        <div style="color: #6c757d; font-size: 14px;" id="preview-company-details">
                            ${companyInfo.address}<br>
                            ${companyInfo.phone} | ${companyInfo.email}
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <h1 style="color: var(--accent-color, #0d6efd); margin: 0;" id="preview-invoice-title-classic">${document.getElementById('invoice-title').value}</h1>
                        <div style="margin-top: 15px; font-size: 14px;">
                            <div class="order-number-row" style="display: ${document.getElementById('show-order-number').checked ? 'block' : 'none'}">
                                <strong>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨:</strong> ORD-2025-001
                            </div>
                            <div class="order-type-row" style="display: ${document.getElementById('show-order-type').checked ? 'block' : 'none'}">
                                <strong>Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨:</strong> Ù…Ø¹Ø§ÙŠÙ†Ø©
                            </div>
                            <div><strong>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</strong> INV-2025-001</div>
                            <div><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${new Date().toLocaleDateString('en-CA')}</div>
                        </div>
                    </div>
                </div>
            </div>
        
        <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ -->
        <div style="padding: 30px;">
            <!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ -->
            <div class="customer-info-section" style="margin-bottom: 30px; display: ${document.getElementById('show-customer-info').checked ? 'block' : 'none'}; position: relative; z-index: 1;">
                <h4 style="color: var(--accent-color, #0d6efd); border-bottom: 2px solid var(--accent-color, #0d6efd); padding-bottom: 5px;">
                    <i class="fas fa-user me-2"></i>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„
                </h4>
                <div style="margin-top: 15px; line-height: 1.8;">
                    <strong>Ø§Ù„Ø§Ø³Ù…:</strong> Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯<br>
                    <strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> 0501234567<br>
                    <strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> Ø§Ù„Ø±ÙŠØ§Ø¶ØŒ Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©
                </div>
            </div>
            
            <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ù†Ø§ØµØ± -->
            <div class="items-table-section" style="margin-bottom: 30px; display: ${document.getElementById('show-items-table').checked ? 'block' : 'none'}; position: relative; z-index: 1;">
                <table class="items-table dynamic-sizing">
                    <thead>
                        <tr>
                            <th>Ù…</th>
                            <th>Ø§Ù„ÙˆØµÙ</th>
                            <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                            <th>Ø§Ù„Ø³Ø¹Ø±</th>
                            <th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>1</td>
                            <td>Ø³ØªØ§Ø¦Ø± ØºØ±ÙØ© Ø§Ù„Ù…Ø¹ÙŠØ´Ø©</td>
                            <td>2</td>
                            <td>500.00</td>
                            <td>1000.00</td>
                        </tr>
                        <tr>
                            <td>2</td>
                            <td>ØªØ±ÙƒÙŠØ¨ ÙˆØªØ«Ø¨ÙŠØª</td>
                            <td>1</td>
                            <td>150.00</td>
                            <td>150.00</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- ØªÙ… Ø¥Ø®ÙØ§Ø¡ Ù‚Ø³Ù… Ø§Ù„Ù…Ø¬Ø§Ù…ÙŠØ¹ Ø­Ø³Ø¨ Ø·Ù„Ø¨ Ø§Ù„Ø¹Ù…ÙŠÙ„ -->
            
            <!-- Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª -->
            <div class="notes-section-content">
                <h4 style="color: var(--accent-color, #0d6efd);">
                    <i class="fas fa-sticky-note me-2"></i>Ù…Ù„Ø§Ø­Ø¸Ø§Øª
                </h4>
                <p style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-top: 10px;">
                    Ø´ÙƒØ±Ø§Ù‹ Ù„Ø«Ù‚ØªÙƒÙ… Ø¨Ù†Ø§. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§ ÙÙŠ Ø­Ø§Ù„Ø© ÙˆØ¬ÙˆØ¯ Ø£ÙŠ Ø§Ø³ØªÙØ³Ø§Ø±.
                </p>
            </div>
        </div>
        
        <!-- Ø§Ù„ØªØ°ÙŠÙŠÙ„ -->
        <div class="invoice-footer">
            <p><strong>Ø´ÙƒØ±Ø§Ù‹ Ù„Ø«Ù‚ØªÙƒÙ… Ø¨Ù†Ø§</strong></p>
            <p>${companyInfo.name} | ${companyInfo.phone} | ${companyInfo.email}</p>
        </div>
    `;
    
    // ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„
}

// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
function updatePreview() {
    // ØªØ­Ø¯ÙŠØ« Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙØ§ØªÙˆØ±Ø©
    const invoiceTitle = document.getElementById('invoice-title').value;
    
    // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ©
    companyInfo.name = document.getElementById('company-name').value;
    companyInfo.address = document.getElementById('company-address').value;
    companyInfo.phone = document.getElementById('company-phone').value;
    companyInfo.email = document.getElementById('company-email').value;
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ù„ÙˆØ§Ù†
    const headerColor = document.getElementById('header-color').value;
    const accentColor = document.getElementById('accent-color').value;
    const fontSize = document.getElementById('font-size').value;
    
    const preview = document.getElementById('invoice-preview');
    preview.style.setProperty('--header-bg', headerColor);
    preview.style.setProperty('--accent-color', accentColor);
    preview.style.fontSize = fontSize + 'px';
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†ØµÙˆØµ ÙÙŠ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© ÙÙ‚Ø· Ø¥Ø°Ø§ ÙˆØ¬Ø¯Øª
    updateCompanyTexts();
    updateVisibleElements();
}

// ØªØ­Ø¯ÙŠØ« Ù†ØµÙˆØµ Ø§Ù„Ø´Ø±ÙƒØ© ÙÙŠ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
function updateCompanyTexts() {
    const preview = document.getElementById('invoice-preview');
    const invoiceTitle = document.getElementById('invoice-title').value;
    
    // ØªØ­Ø¯ÙŠØ« Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙØ§ØªÙˆØ±Ø©
    const invoiceTitleElements = preview.querySelectorAll('#preview-invoice-title, #preview-invoice-title-classic');
    invoiceTitleElements.forEach(el => {
        if (el) el.textContent = invoiceTitle;
    });
    
    // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ©
    const companyNameElements = preview.querySelectorAll('#preview-company-name');
    const companyDetailsElements = preview.querySelectorAll('#preview-company-details');
    
    companyNameElements.forEach(el => {
        if (el) el.textContent = companyInfo.name;
    });
    
    companyDetailsElements.forEach(el => {
        if (el) el.innerHTML = `${companyInfo.address}<br>${companyInfo.phone} | ${companyInfo.email}`;
    });
}

// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø±Ø¦ÙŠØ©
function updateVisibleElements() {
    const preview = document.getElementById('invoice-preview');
    
    // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø­Ø³Ø¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
    const elementsToToggle = [
        { checkboxId: 'show-logo', selector: '.company-logo-container' },
        { checkboxId: 'show-order-number', selector: '.order-number-row' },
        { checkboxId: 'show-order-type', selector: '.order-type-row' },
        { checkboxId: 'show-customer-info', selector: '.customer-info-section' },
        { checkboxId: 'show-items-table', selector: '.items-table-section' },
        { checkboxId: 'show-totals', selector: '.totals-section-content' },
        { checkboxId: 'show-notes', selector: '.notes-section-content' }
    ];
    
    elementsToToggle.forEach(item => {
        const checkbox = document.getElementById(item.checkboxId);
        const elements = preview.querySelectorAll(item.selector);
        const display = checkbox && checkbox.checked ? 'block' : 'none';
        
        elements.forEach(el => {
            if (el) el.style.display = display;
        });
    });
}

// Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†
function resetTemplate() {
    document.getElementById('invoice-preview').innerHTML = `
        <div class="text-center p-5" style="color: #6c757d;">
            <i class="fas fa-file-invoice fa-3x mb-3"></i>
            <h4>Ø§Ø®ØªØ± Ù‚Ø§Ù„Ø¨Ø§Ù‹ Ù„Ø¨Ø¯Ø¡ Ø§Ù„ØªØµÙ…ÙŠÙ…</h4>
            <p>Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù„Ø§Ø®ØªÙŠØ§Ø± Ù‚Ø§Ù„Ø¨ Ø£Ùˆ Ø§Ø¨Ø¯Ø£ Ù…Ù† Ø§Ù„ØµÙØ±</p>
        </div>
    `;
    currentTemplate = null;
}

// Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©
function previewInvoice() {
    const preview = document.getElementById('invoice-preview');
    const newWindow = window.open('', '_blank', 'width=800,height=600');
    newWindow.document.write(`
        <!DOCTYPE html>
        <html dir="rtl" lang="ar">
        <head>
            <meta charset="UTF-8">
            <title>Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©</title>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
            <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
            <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
            <style>
                body { font-family: 'Cairo', sans-serif; margin: 20px; }
                .items-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                .items-table th { background: #0d6efd; color: white; padding: 15px 10px; text-align: center; }
                .items-table td { padding: 12px 10px; text-align: center; border-bottom: 1px solid #dee2e6; }
                .items-table tr:nth-child(even) { background: #f8f9fa; }
                @media print { body { margin: 0; } }
            </style>
        </head>
        <body>
            ${preview.innerHTML}
            <div class="text-center mt-4">
                <button onclick="window.print()" class="btn btn-primary">
                    <i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø©
                </button>
                <button onclick="window.close()" class="btn btn-secondary">
                    <i class="fas fa-times"></i> Ø¥ØºÙ„Ø§Ù‚
                </button>
            </div>
        </body>
        </html>
    `);
    newWindow.document.close();
}

// Ø­ÙØ¸ Ø§Ù„Ù‚Ø§Ù„Ø¨
function saveTemplate() {
    if (!currentTemplate) {
        Swal.fire({
            title: 'ØªÙ†Ø¨ÙŠÙ‡',
            text: 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù‚Ø§Ù„Ø¨ Ø£ÙˆÙ„Ø§Ù‹',
            icon: 'warning',
            confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹'
        });
        return;
    }
    
    showLoading();
    
    // Ø¬Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
    const templateData = {
        name: 'Ù‚Ø§Ù„Ø¨ ÙƒÙ„Ø§Ø³ÙŠÙƒÙŠ Ù…ÙØ¹Ø¯Ù„',
        template_type: 'custom',
        html_content: document.getElementById('invoice-preview').innerHTML,
        css_styles: '',
        settings: {
            primary_color: document.getElementById('accent-color').value,
            secondary_color: '#198754',
            accent_color: document.getElementById('header-color').value,
            font_family: 'Cairo, Arial, sans-serif',
            font_size: parseInt(document.getElementById('font-size').value),
            page_size: 'A4',
            page_margins: 20
        },
        company_info: {
            name: document.getElementById('company-name').value,
            address: document.getElementById('company-address').value,
            phone: document.getElementById('company-phone').value,
            email: document.getElementById('company-email').value
        },
        content_settings: {
            show_company_logo: document.getElementById('show-logo').checked,
            show_background_logo: document.getElementById('show-background-logo').checked,
            show_order_details: document.getElementById('show-order-number').checked,
            show_customer_details: document.getElementById('show-customer-info').checked,
            show_payment_details: true,
            show_notes: document.getElementById('show-notes').checked,
            show_terms: true
        },
        advanced_settings: {
            invoice_title: document.getElementById('invoice-title').value,
            header_color: document.getElementById('header-color').value,
            template_style: 'classic', // Ø¯Ø§Ø¦Ù…Ø§Ù‹ ÙƒÙ„Ø§Ø³ÙŠÙƒÙŠ
            date_format: document.getElementById('date-format').value,
            notes_text: document.getElementById('notes-text').value,
            policies_text: document.getElementById('policies-text').value
        },
        is_active: true,
        is_default: true // Ø¬Ø¹Ù„Ù‡ Ø§ÙØªØ±Ø§Ø¶ÙŠ
    };
    
    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø®Ø§Ø¯Ù…
    fetch('/orders/api/templates/save/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            template_data: templateData
        })
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success) {
            Swal.fire({
                title: 'ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­!',
                text: 'ØªÙ… Ø­ÙØ¸ Ù‚Ø§Ù„Ø¨ Ø§Ù„ÙØ§ØªÙˆØ±Ø© ÙˆØ³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©',
                icon: 'success',
                confirmButtonText: 'Ù…Ù…ØªØ§Ø²'
            });
        } else {
            Swal.fire({
                title: 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸',
                text: data.error || 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ù‚Ø§Ù„Ø¨',
                icon: 'error',
                confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹'
            });
        }
    })
    .catch(error => {
        hideLoading();
        console.error('Ø®Ø·Ø£:', error);
        Swal.fire({
            title: 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„',
            text: 'ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…',
            icon: 'error',
            confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹'
        });
    });
}

// Ø¯Ø§Ù„Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
function showLoading() {
    document.getElementById('loading-overlay').style.display = 'flex';
}

function hideLoading() {
    document.getElementById('loading-overlay').style.display = 'none';
}

// ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…Ø­Ø±Ø± Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸ¨ Ù…Ø­Ø±Ø± Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø¨Ø³ÙŠØ· Ø¬Ø§Ù‡Ø²!');
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
    setTimeout(() => {
        loadTemplate('default');
        // ÙÙŠ Ø­Ø§Ù„ ÙˆØ¬ÙˆØ¯ SAVED_METAØŒ Ø·Ø¨Ù‘Ù‚ Ø§Ù„Ù‚ÙŠÙ… Ø¹Ù„Ù‰ Ø§Ù„Ø­Ù‚ÙˆÙ„
        setTimeout(() => {
            try {
                if (window.SAVED_META) {
                    const m = window.SAVED_META;
                    // Ø´Ø±ÙƒØ©
                    if (m.company_info) {
                        if (m.company_info.name) document.getElementById('company-name').value = m.company_info.name;
                        if (m.company_info.address) document.getElementById('company-address').value = m.company_info.address;
                        if (m.company_info.phone) document.getElementById('company-phone').value = m.company_info.phone;
                        if (m.company_info.email) document.getElementById('company-email').value = m.company_info.email;
                    }
                    // Ø£Ù„ÙˆØ§Ù† ÙˆØ®Ø·ÙˆØ·
                    if (m.settings) {
                        if (m.settings.accent_color) document.getElementById('header-color').value = m.settings.accent_color;
                        if (m.settings.primary_color) document.getElementById('accent-color').value = m.settings.primary_color;
                        if (m.settings.font_size) document.getElementById('font-size').value = String(m.settings.font_size);
                    }
                    // Ø§Ù„Ù…Ø­ØªÙˆÙ‰
                    if (m.content_settings) {
                        document.getElementById('show-logo').checked = !!m.content_settings.show_company_logo;
                        document.getElementById('show-order-number').checked = !!m.content_settings.show_order_details;
                        document.getElementById('show-customer-info').checked = !!m.content_settings.show_customer_details;
                        document.getElementById('show-items-table').checked = true;
                        document.getElementById('show-totals').checked = true;
                        document.getElementById('show-notes').checked = !!m.content_settings.show_notes;
                    }
                    // Ù…ØªÙ‚Ø¯Ù…
                    if (m.advanced_settings) {
                        if (m.advanced_settings.invoice_title) document.getElementById('invoice-title').value = m.advanced_settings.invoice_title;
                        if (m.advanced_settings.date_format) document.getElementById('date-format').value = m.advanced_settings.date_format;
                        if (m.advanced_settings.notes_text) document.getElementById('notes-text').value = m.advanced_settings.notes_text;
                        if (m.advanced_settings.policies_text) document.getElementById('policies-text').value = m.advanced_settings.policies_text;
                        if (m.advanced_settings.show_background_logo !== undefined) document.getElementById('show-background-logo').checked = !!m.advanced_settings.show_background_logo;
                    }
                }
            } catch (e) { console.warn('Meta apply error', e); }
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
            updatePreview();
        }, 150);
    }, 500);
});
</script>
{% endblock %}