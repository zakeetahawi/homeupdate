{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title }} - نظام الخواجه{% endblock %}

{% block extra_css %}
<style>
    .notes-field {
        min-height: 150px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-shopping-cart"></i> {{ title }}</h2>
        <a href="{% url 'orders:order_list' %}" class="btn btn-secondary">
            <i class="fas fa-arrow-right"></i> العودة للقائمة
        </a>
    </div>

    <form method="post" id="orderForm" novalidate enctype="multipart/form-data">
    {{ formset.management_form }}
    <div style="display:none;">
        {% for form in formset %}
            {{ form.as_p }}
        {% endfor %}
    </div>
        {% csrf_token %}
        
        <!-- Display form errors -->
        {% if form.errors or formset.errors %}
            <div class="alert alert-danger mb-4">
                <h5 class="alert-heading"><i class="fas fa-exclamation-triangle"></i> يوجد أخطاء في النموذج</h5>
                {% if form.non_field_errors %}
                    <ul class="mb-0">
                        {% for error in form.non_field_errors %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="mb-0">يرجى التحقق من الحقول المطلوبة أدناه.</p>
                {% endif %}
                {% if formset.errors %}
                    <ul class="mb-0">
                    {% for error in formset.non_form_errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                    {% for f in formset.forms %}
                        {% for field in f.visible_fields %}
                            {% for error in field.errors %}
                                <li>{{ field.label }}: {{ error }}</li>
                            {% endfor %}
                        {% endfor %}
                    {% endfor %}
                    </ul>
                {% endif %}
            </div>
        {% endif %}
        
        <!-- Hidden fields for form submission -->
        <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
        <input type="hidden" name="selected_products" id="selected_products" value="">
        <input type="hidden" name="paid_amount" id="paid_amount" value="0">
        <input type="hidden" name="payment_verified" id="payment_verified" value="0">
        <input type="hidden" name="payment_notes" id="payment_notes" value="">
        <input type="hidden" name="payment_reference" id="payment_reference" value="">
        <input type="hidden" name="tracking_status" value="pending">
        
        <div class="row">
            <!-- Order Information -->
            <div class="col-md-12">
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">معلومات الطلب</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <!-- Customer Selection -->
                                <div class="mb-3">
                                    <label for="{{ form.customer.id_for_label }}" class="form-label">العميل *</label>
                                    {% if customer %}
                                    <input type="text" class="form-control" value="{{ customer.name }}" readonly>
                                    <input type="hidden" name="customer" value="{{ customer.pk }}">
                                    {% else %}
                                    {{ form.customer }}
                                    {% endif %}
                                    {% if form.customer.errors %}
                                    <div class="alert alert-danger mt-2">
                                        {{ form.customer.errors }}
                                    </div>
                                    {% endif %}
                                </div>
                                
                                <!-- Order Number (Auto-generated but visible) -->
                                <div class="mb-3">
                                    <label for="{{ form.order_number.id_for_label }}" class="form-label">رقم الطلب</label>
                                    {{ form.order_number }}
                                    {% if last_order %}
                                    <div class="form-text">
                                        آخر رقم طلب للعميل: {{ last_order.order_number }}
                                    </div>
                                    {% endif %}
                                </div>
                                
                                <!-- Order Status - Hidden for inspection -->
                                <div class="mb-3 order-status-field" id="order-status-container" style="display: none;">
                                    <label for="{{ form.status.id_for_label }}" class="form-label">وضع الطلب *</label>
                                    {{ form.status }}
                                    <div class="form-text text-muted">
                                        عادي: تسليم خلال 15 يوم | VIP: تسليم خلال 7 أيام
                                    </div>
                                    {% if form.status.errors %}
                                    <div class="alert alert-danger mt-2">
                                        {{ form.status.errors }}
                                    </div>
                                    {% endif %}
                                </div>

                                <!-- Inspection Status Info -->
                                <div class="mb-3 inspection-status-info" id="inspection-status-info" style="display: none;">
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle me-2"></i>
                                        <strong>وضع الطلب للمعاينة:</strong>
                                        <br>
                                        سيتم تعيين وضع الطلب تلقائياً إلى "عادي" مع موعد تسليم خلال 48 ساعة
                                    </div>
                                </div>
                                
                                <!-- Expected Delivery Date - Hidden -->
                                <div class="mb-3" style="display: none;">
                                    <label for="{{ form.expected_delivery_date.id_for_label }}" class="form-label">تاريخ التسليم المتوقع</label>
                                    {{ form.expected_delivery_date }}
                                    <div class="form-text text-muted">
                                        يتم حسابه تلقائياً بناءً على وضع الطلب
                                    </div>
                                    {% if form.expected_delivery_date.errors %}
                                    <div class="alert alert-danger mt-2">
                                        {{ form.expected_delivery_date.errors }}
                                    </div>
                                    {% endif %}
                                </div>
                                
                                <!-- Invoice Number -->
                                <div class="mb-3">
                                    <label for="{{ form.invoice_number.id_for_label }}" class="form-label">
                                        رقم الفاتورة
                                        <span class="text-danger">*</span>
                                    </label>
                                    {{ form.invoice_number }}
                                    <div class="form-text text-danger">
                                        مطلوب لجميع أنواع الطلبات
                                    </div>
                                    {% if form.invoice_number.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.invoice_number.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>

                                <!-- Salesperson -->
                                <div class="mb-3">
                                    <label for="{{ form.salesperson.id_for_label }}" class="form-label">
                                        البائع
                                        <span class="text-danger">*</span>
                                    </label>
                                    {{ form.salesperson }}
                                    {% if form.salesperson.errors %}
                                    <div class="alert alert-danger mt-2">
                                        {% for error in form.salesperson.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>

                            </div>
                            
                            <div class="col-md-6">
                                <!-- Order Types -->
                                <div class="mb-4 {% if form.selected_types.errors %}border border-danger rounded p-3{% endif %}">
                                    <h5 class="mb-3">نوع الطلب *</h5>
                                    {% if form.selected_types.errors %}
                                    <div class="alert alert-danger">
                                        {% for error in form.selected_types.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                    
                                    <div class="d-flex flex-wrap gap-3 mb-3">
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input styled-radio" type="radio" name="order_type_selector" id="order_type_accessory" value="accessory">
                                            <label class="form-check-label" for="order_type_accessory">
                                                <i class="fas fa-gem me-2"></i> إكسسوار
                                            </label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input styled-radio" type="radio" name="order_type_selector" id="order_type_installation" value="installation">
                                            <label class="form-check-label" for="order_type_installation">
                                                <i class="fas fa-tools me-2"></i> تركيب
                                            </label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input styled-radio" type="radio" name="order_type_selector" id="order_type_inspection" value="inspection">
                                            <label class="form-check-label" for="order_type_inspection">
                                                <i class="fas fa-eye me-2"></i> معاينة
                                            </label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input styled-radio" type="radio" name="order_type_selector" id="order_type_tailoring" value="tailoring">
                                            <label class="form-check-label" for="order_type_tailoring">
                                                <i class="fas fa-cut me-2"></i> تسليم
                                            </label>
                                        </div>
                                    </div>

                                    <div style="display:none;">
                                        {{ form.selected_types }}
                                    </div>
                                    
                                    <div class="form-text text-muted">
                                        <strong>ملاحظة:</strong> يجب اختيار نوع واحد فقط للطلب
                                    </div>
                                </div>
                                
                                <!-- Contract Number -->
                                <div class="mb-3 contract-field" style="display: none;">
                                    <label for="{{ form.contract_number.id_for_label }}" class="form-label">
                                        رقم العقد
                                        <span class="text-danger">*</span>
                                    </label>
                                    {{ form.contract_number }}
                                    <div class="form-text text-danger">
                                        مطلوب عند اختيار التركيب، التفصيل، أو الإكسسوار
                                    </div>
                                    {% if form.contract_number.errors %}
                                    <div class="alert alert-danger mt-2">
                                        {% for error in form.contract_number.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>

                                <!-- Contract File -->
                                <div class="mb-3 contract-file-field" style="display: none;">
                                    <label for="{{ form.contract_file.id_for_label }}" class="form-label">
                                        ملف العقد (PDF)
                                        <span class="text-danger">*</span>
                                    </label>
                                    {{ form.contract_file }}
                                    <div class="form-text text-muted">
                                        يجب أن يكون الملف من نوع PDF وأقل من 10 ميجابايت
                                        <br><strong>سيتم رفع الملف تلقائياً إلى Google Drive عند الحفظ</strong>
                                    </div>
                                    {% if form.contract_file.errors %}
                                    <div class="alert alert-danger mt-2">
                                        {% for error in form.contract_file.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                    {% endif %}

                                    <!-- Google Drive Status -->
                                    {% if form.instance.is_contract_uploaded_to_drive %}
                                    <div class="alert alert-success mt-2">
                                        <i class="fas fa-cloud-upload-alt me-2"></i>
                                        تم رفع الملف إلى Google Drive بنجاح
                                        {% if form.instance.contract_google_drive_file_url %}
                                        <br>
                                        <a href="{{ form.instance.contract_google_drive_file_url }}" target="_blank" class="btn btn-sm btn-outline-primary mt-2">
                                            <i class="fas fa-external-link-alt me-1"></i>
                                            عرض الملف في Google Drive
                                        </a>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                </div>

                                <!-- Related Inspection -->
                                <div class="mb-3 related-inspection-field" style="display: none;">
                                    <label for="{{ form.related_inspection.id_for_label }}" class="form-label">
                                        معاينة مرتبطة
                                    </label>
                                    {{ form.related_inspection }}
                                    <div class="form-text text-muted">
                                        اختر المعاينة المرتبطة بهذا الطلب (اختياري)
                                    </div>
                                    {% if form.related_inspection.errors %}
                                    <div class="alert alert-danger mt-2">
                                        {% for error in form.related_inspection.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>

                                <!-- Hidden Fields for Delivery - Set automatically by JavaScript -->
                                <div style="display:none;">
                                {{ form.delivery_type }}
                                {{ form.delivery_address }}
                                </div>



                                <!-- Branch Selection - Always visible but will be set automatically -->
                                <div class="mb-3">
                                    <label for="{{ form.branch.id_for_label }}" class="form-label">الفرع *</label>
                                    {{ form.branch }}
                                    {% if form.branch.errors %}
                                    <div class="alert alert-danger mt-2">
                                        {{ form.branch.errors }}
                                    </div>
                                    {% endif %}
                                </div>

                                <!-- Notes -->
                                <div class="mb-4">
                                    <label for="{{ form.notes.id_for_label }}" class="form-label">ملاحظات</label>
                                    <textarea name="notes" id="{{ form.notes.id_for_label }}" class="form-control notes-field" rows="6">{{ form.notes.value|default:'' }}</textarea>
                                    <div class="form-text">
                                        يمكنك إضافة معلومات العميل وتفاصيل الطلب هنا
                                    </div>
                                    <!-- Debug Information -->
                                    {% if debug %}
                                    <div class="alert alert-info mt-2">
                                        <strong>معلومات التصحيح:</strong><br>
                                        {{ form.errors }}<br>
                                        {{ form.non_field_errors }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- جدول العناصر المختارة ديناميكيًا -->
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-list me-2"></i> العناصر المختارة (قبل الحفظ)</h5>
            </div>
            <div class="card-body p-0">
                <div id="live-order-items-table" class="table-responsive"></div>
            </div>
        </div>
        
        <!-- Product Selection Section -->
        <div class="card mb-4 product-selection-section" id="product-selection-section" style="display: none;">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-box-open me-2"></i> اختيار المنتجات</h5>
            </div>
            <div class="card-body">
                <!-- Product Search -->
                <div class="mb-4">
                    <div class="input-group">
                        <input type="text" id="product-search" class="form-control" placeholder="ابحث عن منتج بالاسم أو الكود..." aria-label="ابحث عن منتج">
                        <button class="btn btn-outline-primary" type="button" id="product-search-button">
                            <i class="fas fa-search"></i> بحث
                        </button>
                    </div>
                </div>
                
                <div id="products-container" class="row">
                    <!-- Products will be loaded here -->
                    <div class="text-center py-3" id="products-loading">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">جاري التحميل...</span>
                        </div>
                        <p class="mt-2">جاري تحميل المنتجات...</p>
                    </div>
                </div>
                
                <!-- Selected Products -->
                <div class="mb-4">
                    <h5 class="mb-3">المنتجات المختارة</h5>
                    <div id="selected-products-container">
                        <p class="text-muted" id="no-products-message">لم يتم اختيار أي منتجات بعد</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="d-grid gap-2 d-md-flex justify-content-md-end mb-3">
            <button type="button" class="btn btn-success btn-lg" id="add-order-item-btn-custom">
                <i class="fas fa-plus me-2"></i> إضافة عنصر
            </button>
        </div>
        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
            <button type="submit" class="btn btn-primary btn-lg">
                <i class="fas fa-save me-2"></i> حفظ الطلب
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- Elements ---
        const styledRadios = document.querySelectorAll('.styled-radio');
        const realRadios = document.querySelectorAll('input[name="selected_types"]');
        
        const contractField = document.querySelector('.contract-field');
        const contractFileField = document.querySelector('.contract-file-field');
        const relatedInspectionField = document.querySelector('.related-inspection-field');
        const productSelection = document.querySelector('#product-selection-section');
        const tailoringSection = document.querySelector('#tailoring-section');
        const inspectionFields = document.querySelector('#inspection-fields');
        
        // إضافة عناصر وضع الطلب
        const orderStatusContainer = document.querySelector('#order-status-container');
        const inspectionStatusInfo = document.querySelector('#inspection-status-info');
        const statusField = document.querySelector('#{{ form.status.id_for_label }}');
        
        // --- Functions ---
        
        // Syncs the hidden Django radio buttons with the visible styled ones
        function syncRealRadios(selectedValue) {
            realRadios.forEach(radio => {
                radio.checked = (radio.value === selectedValue);
            });
        }

        // Updates visibility of form sections based on selected order type
        function updateFormFields() {
            const selectedRadio = document.querySelector('.styled-radio:checked');
            const selectedType = selectedRadio ? selectedRadio.value : 'none';

            syncRealRadios(selectedType);

            const showForContract = ['installation', 'tailoring', 'accessory'].includes(selectedType);
            const showForAccessory = selectedType === 'accessory';
            const showForTailoring = selectedType === 'tailoring';
            const showForInspection = selectedType === 'inspection';
            const showRelatedInspection = ['installation', 'tailoring', 'accessory'].includes(selectedType);

            // التحكم في إظهار/إخفاء حقل وضع الطلب
            if (orderStatusContainer) {
                if (showForInspection) {
                    // إخفاء حقل وضع الطلب للمعاينة
                    orderStatusContainer.style.display = 'none';
                    if (inspectionStatusInfo) {
                        inspectionStatusInfo.style.display = 'block';
                    }
                    // تعيين وضع الطلب تلقائياً إلى "عادي" للمعاينة
                    if (statusField) {
                        statusField.value = 'normal';
                    }
                } else {
                    // إظهار حقل وضع الطلب للخدمات الأخرى
                    orderStatusContainer.style.display = 'block';
                    if (inspectionStatusInfo) {
                        inspectionStatusInfo.style.display = 'none';
                    }
                }
            }

            // Invoice number handling - required for all types
            const invoiceRequired = document.querySelector('.text-danger');
            const invoiceHelp = document.querySelector('.form-text.text-danger');
            const inspectionInvoiceHelp = document.querySelector('.inspection-invoice-help');
            
            if (showForInspection) {
                // للمعاينات: إظهار علامة * ورسالة "مطلوب" مثل باقي الأنواع
                if (invoiceRequired) invoiceRequired.style.display = 'inline';
                if (invoiceHelp) invoiceHelp.style.display = 'block';
                if (inspectionInvoiceHelp) inspectionInvoiceHelp.style.display = 'none';
            } else {
                // للخدمات الأخرى: إظهار علامة * ورسالة "مطلوب"
                if (invoiceRequired) invoiceRequired.style.display = 'inline';
                if (invoiceHelp) invoiceHelp.style.display = 'block';
                if (inspectionInvoiceHelp) inspectionInvoiceHelp.style.display = 'none';
            }

            if (contractField) contractField.style.display = showForContract ? 'block' : 'none';
            if (contractFileField) contractFileField.style.display = showForContract ? 'block' : 'none';
            
            // إخفاء حقل المعاينة المرتبطة للمعاينات وإظهاره للخدمات الأخرى فقط
            if (relatedInspectionField) {
                if (showForInspection) {
                    // إخفاء حقل المعاينة المرتبطة للمعاينات
                    relatedInspectionField.style.display = 'none';
                    // إفراغ قيمة الحقل للمعاينات
                    const relatedInspectionSelect = relatedInspectionField.querySelector('select');
                    if (relatedInspectionSelect) {
                        relatedInspectionSelect.value = '';
                    }
                } else {
                    // إظهار حقل المعاينة المرتبطة للخدمات الأخرى
                    relatedInspectionField.style.display = showRelatedInspection ? 'block' : 'none';
                }
            }
            
            if (productSelection) {
                productSelection.style.display = showForAccessory ? 'block' : 'none';
                if (showForAccessory && typeof loadProducts === 'function') {
                    loadProducts();
                }
            }

            if (tailoringSection) tailoringSection.style.display = showForTailoring ? 'block' : 'none';
            if (inspectionFields) inspectionFields.style.display = showForInspection ? 'block' : 'none';
        }
        
        // --- Event Listeners ---
        styledRadios.forEach(radio => {
            radio.addEventListener('change', updateFormFields);
        });
        
        // --- Initial Call ---
        updateFormFields();

        // --- Submission check for diagnostics ---
        const orderForm = document.getElementById('orderForm');
        if (orderForm) {
            orderForm.addEventListener('submit', function(e) {
                // Run sync one last time to be sure
                updateFormFields();

                const selectedRealRadio = document.querySelector('input[name="selected_types"]:checked');
                
                console.log("--- FORM SUBMISSION DIAGNOSTICS ---");
                if (selectedRealRadio) {
                    console.log("SUCCESS: A 'real' radio button is checked.");
                    console.log("Value being submitted:", selectedRealRadio.value);
                } else {
                    console.error("FAILURE: No 'real' radio button was checked before form submission.");
                    console.log("This is why the form validation is failing.");
                    // e.preventDefault(); // Uncomment this line to stop submission for further debugging
                }
                console.log("------------------------------------");
            });
        }
    });
    
    // --- Dynamic Inspection Loading ---
    // إضافة كود لتحديث قائمة المعاينات عند تغيير العميل
    document.addEventListener('DOMContentLoaded', function() {
        const customerSelect = document.querySelector('#{{ form.customer.id_for_label }}');
        const relatedInspectionSelect = document.querySelector('#{{ form.related_inspection.id_for_label }}');
        
        if (customerSelect && relatedInspectionSelect) {
            customerSelect.addEventListener('change', function() {
                const customerId = this.value;
                
                if (customerId) {
                    // إظهار مؤشر التحميل
                    relatedInspectionSelect.innerHTML = '<option value="">جاري التحميل...</option>';
                    relatedInspectionSelect.disabled = true;
                    
                    // جلب معاينات العميل عبر AJAX
                    fetch(`{% url 'orders:customer_inspections_api' %}?customer_id=${customerId}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // تحديث قائمة المعاينات
                                relatedInspectionSelect.innerHTML = '';
                                data.choices.forEach(choice => {
                                    const option = document.createElement('option');
                                    option.value = choice.value;
                                    option.textContent = choice.text;
                                    relatedInspectionSelect.appendChild(option);
                                });
                                relatedInspectionSelect.disabled = false;
                            } else {
                                // في حالة الخطأ، إظهار رسالة خطأ
                                relatedInspectionSelect.innerHTML = '<option value="">خطأ في تحميل المعاينات</option>';
                                relatedInspectionSelect.disabled = true;
                                console.error('Error loading inspections:', data.message);
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching inspections:', error);
                            relatedInspectionSelect.innerHTML = '<option value="">خطأ في الاتصال</option>';
                            relatedInspectionSelect.disabled = true;
                        });
                } else {
                    // إذا لم يتم اختيار عميل، إظهار رسالة
                    relatedInspectionSelect.innerHTML = '<option value="">اختر العميل أولاً</option>';
                    relatedInspectionSelect.disabled = true;
                }
            });
            
            // تشغيل الحدث مرة واحدة عند تحميل الصفحة إذا كان العميل محدد مسبقاً
            if (customerSelect.value) {
                customerSelect.dispatchEvent(new Event('change'));
            }
        }
    });

    // تعريف orderItems كمصفوفة عامة على مستوى document
    if (typeof document.orderItems === 'undefined') {
        document.orderItems = [];
    }

    function renderOrderItemsList() {
        if (!document.orderItems) document.orderItems = [];
        const listBox = document.getElementById('swal-order-items-list');
        if (!listBox) return;
        if (document.orderItems.length === 0) {
            listBox.innerHTML = `<p class='text-muted'>لم يتم اختيار أي عناصر بعد</p>`;
            updateTotalAmount();
            return;
        }
        let html = `<table class='table table-sm'><thead><tr><th>#</th><th>المنتج</th><th>الكمية</th><th>سعر الوحدة</th><th>الإجمالي</th><th></th></tr></thead><tbody>`;
        document.orderItems.forEach((item, idx) => {
            html += `<tr><td>${idx+1}</td><td>${item.name}</td><td>${item.quantity}</td><td>${item.unit_price}</td><td>${item.total.toFixed(2)}</td><td><button type='button' class='btn btn-danger btn-sm' onclick='document.removeOrderItemSwal(${idx})'>حذف</button></td></tr>`;
        });
        html += `</tbody></table>`;
        listBox.innerHTML = html;
        updateTotalAmount();
    }

    document.updateLiveOrderItemsTable = function() {
        console.log('تشغيل updateLiveOrderItemsTable', document.orderItems);
        const tableDiv = document.getElementById('live-order-items-table');
        console.log('هل div موجود؟', !!tableDiv);
        if (!tableDiv) return;
        if (!document.orderItems) document.orderItems = [];
        if (document.orderItems.length === 0) {
            tableDiv.innerHTML = `<p class='text-muted text-center my-3'>لم يتم اختيار أي عناصر بعد</p>`;
            return;
        }
        let html = `<table class='table table-sm mb-0'><thead><tr><th>#</th><th>المنتج</th><th>الكمية</th><th>سعر الوحدة</th><th>الإجمالي</th></tr></thead><tbody>`;
        document.orderItems.forEach((item, idx) => {
            html += `<tr><td>${idx+1}</td><td>${item.name}</td><td>${item.quantity}</td><td>${item.unit_price}</td><td>${item.total.toFixed(2)}</td></tr>`;
        });
        html += `</tbody></table>`;
        tableDiv.innerHTML = html;
    }

    function updateTotalAmount() {
        if (!document.orderItems) document.orderItems = [];
        const total = document.orderItems.reduce((sum, item) => sum + item.total, 0);
        const totalBox = document.getElementById('swal-total-amount');
        if (totalBox) totalBox.textContent = total.toFixed(2);
    }

    document.removeOrderItemSwal = function(idx) {
        document.orderItems.splice(idx, 1);
        renderOrderItemsList();
        updateTotalAmount();
        document.updateLiveOrderItemsTable();
    };

    document.addEventListener('DOMContentLoaded', function() {
        const addItemBtn = document.getElementById('add-order-item-btn-custom');
        const selectedProductsInput = document.getElementById('selected_products');
        const paidAmountInput = document.getElementById('paid_amount');
        const paymentVerifiedInput = document.getElementById('payment_verified');

        if (addItemBtn) {
            addItemBtn.addEventListener('click', function(e) {
                e.preventDefault();
                showOrderItemsModal();
            });
        }

        function showOrderItemsModal() {
            Swal.fire({
                title: 'إضافة عناصر الطلب',
                html: getOrderItemsModalHtml(),
                showCancelButton: true,
                confirmButtonText: 'اعتماد العناصر',
                cancelButtonText: 'إغلاق',
                width: '60em',
                didOpen: () => {
                    setupModalEvents();
                    renderOrderItemsList();
                },
                preConfirm: () => {
                    if (!document.orderItems) document.orderItems = [];
                    if (document.orderItems.length === 0) {
                        Swal.showValidationMessage('يجب إضافة عنصر واحد على الأقل!');
                        return false;
                    }
                    document.getElementById('selected_products').value = JSON.stringify(document.orderItems);
                    const paidAmount = document.getElementById('swal-paid-amount').value || '0';
                    document.getElementById('paid_amount').value = paidAmount;
                    const paymentVerified = document.getElementById('swal-payment-verified').checked ? '1' : '0';
                    document.getElementById('payment_verified').value = paymentVerified;
                    // حفظ ملاحظات الدفعة ورقم المرجع
                    document.getElementById('payment_notes').value = document.getElementById('swal-payment-notes').value || '';
                    document.getElementById('payment_reference').value = document.getElementById('swal-payment-reference').value || '';
                    return true;
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    document.updateLiveOrderItemsTable();
                }
            });
        }

        function getOrderItemsModalHtml() {
            return `
            <div class='mb-3'>
                <input type='text' id='swal-product-search' class='swal2-input' placeholder='ابحث عن منتج...'>
                <div id='swal-suggestions' class='list-group' style='max-height:200px;overflow:auto;'></div>
            </div>
            <div id='swal-product-details' style='display:none;' class='mb-3'></div>
            <div class='mb-3'>
                <h6>العناصر المختارة:</h6>
                <div id='swal-order-items-list'></div>
            </div>
            <div class='mb-3'>
                <label>المبلغ المدفوع:</label>
                <input type='number' id='swal-paid-amount' class='swal2-input' min='0' value='0'>
                <div class='form-check mt-2'>
                    <input class='form-check-input' type='checkbox' id='swal-payment-verified'>
                    <label class='form-check-label' for='swal-payment-verified'>تم التحقق من الدفع</label>
                </div>
                <div class='mb-2'>
                    <label>ملاحظات الدفعة:</label>
                    <textarea id='swal-payment-notes' class='form-control' rows='2' placeholder='ملاحظات الدفعة...'></textarea>
                </div>
                <div class='mb-2'>
                    <label>رقم المرجع (رقم الفاتورة):</label>
                    <input type='text' id='swal-payment-reference' class='form-control' placeholder='رقم الفاتورة أو المرجع...'>
                </div>
            </div>
            <div class='mb-2 text-end'><strong>الإجمالي: <span id='swal-total-amount'>0</span> ج.م</strong></div>
            <div id='swal-no-items-warning' class='alert alert-warning mt-3' style='display:none;'>
                <div class='form-check'>
                    <input class='form-check-input' type='checkbox' id='swal-no-items-confirm'>
                    <label class='form-check-label' for='swal-no-items-confirm'>
                        أتحمل المسؤولية الكاملة عن إنشاء طلب بدون عناصر
                    </label>
                </div>
                <div class='text-danger small mt-2'>لن يتم حفظ الطلب إلا بعد الموافقة على هذا التحذير.</div>
            </div>
            `;
        }

        function setupModalEvents() {
            const searchInput = document.getElementById('swal-product-search');
            const suggestionsBox = document.getElementById('swal-suggestions');
            const detailsBox = document.getElementById('swal-product-details');
            if (!searchInput) return;
            let selectedProduct = null;

            searchInput.addEventListener('input', function() {
                const query = this.value.trim();
                suggestionsBox.innerHTML = '';
                detailsBox.style.display = 'none';
                selectedProduct = null;
                if (query.length < 1) return;
                fetch(`/inventory/api/product-autocomplete/?query=${encodeURIComponent(query)}`)
                    .then(res => res.json())
                    .then(data => {
                        if (data.length > 0) {
                            data.forEach(item => {
                                const el = document.createElement('button');
                                el.type = 'button';
                                el.className = 'list-group-item list-group-item-action';
                                el.innerHTML = `<strong>${item.name}</strong> <span class='text-muted'>[${item.code || ''}]</span> <span class='badge bg-info ms-2'>${item.price} ج.م</span> <span class='badge bg-secondary ms-2'>مخزون: ${item.current_stock}</span>`;
                                el.onclick = function() {
                                    selectedProduct = item;
                                    showProductDetails(item);
                                    suggestionsBox.innerHTML = '';
                                };
                                suggestionsBox.appendChild(el);
                            });
                        }
                    });
            });

            function showProductDetails(item) {
                detailsBox.innerHTML = `
                    <div class='row align-items-end'>
                        <div class='col-md-5 mb-2'>
                            <label>سعر الوحدة:</label>
                            <input type='text' class='form-control' id='swal-unit-price' value='${item.price}' readonly>
                        </div>
                        <div class='col-md-4 mb-2'>
                            <label>الكمية:</label>
                            <input type='number' class='form-control' id='swal-quantity' min='1' max='${item.current_stock}' value='1'>
                            <div class='form-text text-danger' id='swal-stock-warning' style='display:none;'></div>
                        </div>
                        <div class='col-md-3 mb-2'>
                            <label>الإجمالي:</label>
                            <input type='text' class='form-control' id='swal-total' value='${item.price}' readonly>
                        </div>
                    </div>
                    <div class='mb-2 mt-2'>
                        <label>ملاحظات العنصر:</label>
                        <textarea id='swal-item-notes' class='form-control' rows='2' placeholder='ملاحظات العنصر...'></textarea>
                    </div>
                    <div class='mt-2'>
                        <button type='button' class='btn btn-success' id='swal-add-item-btn'>إضافة إلى القائمة</button>
                    </div>
                `;
                detailsBox.style.display = 'block';
                const qtyInput = document.getElementById('swal-quantity');
                const totalInput = document.getElementById('swal-total');
                const warning = document.getElementById('swal-stock-warning');
                qtyInput.addEventListener('input', function() {
                    let qty = parseInt(this.value) || 1;
                    if (qty > item.current_stock) {
                        warning.textContent = `الكمية المطلوبة أكبر من المخزون المتوفر (${item.current_stock})!`;
                        warning.style.display = 'block';
                        this.value = item.current_stock;
                        qty = item.current_stock;
                    } else {
                        warning.style.display = 'none';
                    }
                    totalInput.value = (item.price * qty).toFixed(2);
                });
                document.getElementById('swal-add-item-btn').onclick = function() {
                    const qty = parseInt(qtyInput.value) || 1;
                    const notes = document.getElementById('swal-item-notes').value || '';
                    if (qty < 1) return;
                    // تحقق من عدم تكرار المنتج في القائمة العامة
                    const exists = document.orderItems.find(x => x.product_id === item.id);
                    if (exists) {
                        Swal.showValidationMessage('تمت إضافة هذا المنتج بالفعل!');
                        return;
                    }
                    document.orderItems.push({
                        product_id: item.id,
                        name: item.name,
                        code: item.code,
                        unit_price: item.price,
                        quantity: qty,
                        total: (item.price * qty),
                        notes: notes
                    });
                    console.log('بعد إضافة عنصر:', document.orderItems);
                    detailsBox.style.display = 'none';
                    searchInput.value = '';
                    renderOrderItemsList();
                    updateTotalAmount();
                };
            }
        }

        // عند تحميل الصفحة، حدث الجدول مباشرة إذا كان هناك عناصر
        console.log('عند تحميل الصفحة، document.orderItems:', document.orderItems);
        document.updateLiveOrderItemsTable();
    });

    // تحديث الحقول المخفية دائمًا عند حفظ الطلب
    const orderForm = document.getElementById('orderForm');
    if (orderForm) {
        orderForm.addEventListener('submit', function(e) {
            // تأكد من تحديث الحقول المخفية دائمًا قبل الإرسال
            if (typeof document.orderItems !== 'undefined' && document.orderItems.length > 0) {
                document.getElementById('selected_products').value = JSON.stringify(document.orderItems);
            }
            // تحديث الدفع والتحقق إذا كانت الحقول موجودة في الصفحة
            var paidAmountInput = document.getElementById('paid_amount');
            var paymentVerifiedInput = document.getElementById('payment_verified');
            var paymentNotesInput = document.getElementById('payment_notes');
            var paymentReferenceInput = document.getElementById('payment_reference');

            if (paidAmountInput && document.getElementById('swal-paid-amount')) {
                paidAmountInput.value = document.getElementById('swal-paid-amount').value || '0';
            }
            if (paymentVerifiedInput && document.getElementById('swal-payment-verified')) {
                paymentVerifiedInput.value = document.getElementById('swal-payment-verified').checked ? '1' : '0';
            }
            if (paymentNotesInput && document.getElementById('swal-payment-notes')) {
                paymentNotesInput.value = document.getElementById('swal-payment-notes').value;
            }
            if (paymentReferenceInput && document.getElementById('swal-payment-reference')) {
                paymentReferenceInput.value = document.getElementById('swal-payment-reference').value;
            }
        });
    }

    // إضافة كود جافاسكريبت في event submit للـ form: إذا لم توجد عناصر في document.orderItems، أوقف الإرسال وأظهر نافذة SweetAlert2 فيها تحذير ومربع اختيار "أتحمل المسؤولية"، ولا يتم الحفظ إلا بعد الموافقة.
    document.addEventListener('DOMContentLoaded', function() {
        const orderForm = document.getElementById('orderForm');
        if (orderForm) {
            orderForm.addEventListener('submit', function(e) {
                // تحقق من وجود عناصر قبل الحفظ
                if (!document.orderItems || document.orderItems.length === 0) {
                    e.preventDefault();
                    Swal.fire({
                        title: 'تحذير: لا توجد عناصر للطلب',
                        html: `<div class='alert alert-warning'>
                                <div class='form-check'>
                                    <input class='form-check-input' type='checkbox' id='swal-no-items-confirm-main'>
                                    <label class='form-check-label' for='swal-no-items-confirm-main'>
                                        أتحمل المسؤولية الكاملة عن إنشاء طلب بدون عناصر
                                    </label>
                                </div>
                                <div class='text-danger small mt-2'>لن يتم حفظ الطلب إلا بعد الموافقة على هذا التحذير.</div>
                            </div>`,
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'موافق، أتحمل المسؤولية',
                        cancelButtonText: 'إلغاء',
                        preConfirm: () => {
                            const confirm = document.getElementById('swal-no-items-confirm-main');
                            if (!confirm || !confirm.checked) {
                                Swal.showValidationMessage('يجب الموافقة على تحمل المسؤولية أولاً!');
                                return false;
                            }
                            return true;
                        }
                    }).then((result) => {
                        if (result.isConfirmed) {
                            // أعد إرسال النموذج برمجيًا بعد الموافقة
                            orderForm.submit();
                        }
                    });
                    return false;
                }
                // Run sync one last time to be sure
                updateFormFields();

                const selectedRealRadio = document.querySelector('input[name="selected_types"]:checked');
                
                console.log("--- FORM SUBMISSION DIAGNOSTICS ---");
                if (selectedRealRadio) {
                    console.log("SUCCESS: A 'real' radio button is checked.");
                    console.log("Value being submitted:", selectedRealRadio.value);
                } else {
                    console.error("FAILURE: No 'real' radio button was checked before form submission.");
                    console.log("This is why the form validation is failing.");
                    // e.preventDefault(); // Uncomment this line to stop submission for further debugging
                }
                console.log("------------------------------------");
            });
        }
    });
</script>
{% endblock %}
