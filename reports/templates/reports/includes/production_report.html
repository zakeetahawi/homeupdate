{% load static %}
{% load i18n %}

<style>
    .production-dashboard {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    .stat-card {
        border-radius: 15px;
        overflow: hidden;
        transition: transform 0.3s, box-shadow 0.3s;
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    }
    
    .stat-card .card-body {
        padding: 1.5rem;
    }
    
    .stat-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
    }
    
    .bg-gradient-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .bg-gradient-success {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    }
    
    .bg-gradient-warning {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    
    .bg-gradient-info {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
    
    .bg-gradient-dark {
        background: linear-gradient(135deg, #434343 0%, #000000 100%);
    }
    
    .progress-ring {
        width: 120px;
        height: 120px;
    }
    
    .filter-card {
        border: none;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    }
    
    .nav-pills .nav-link {
        border-radius: 25px;
        padding: 10px 25px;
        font-weight: 500;
    }
    
    .nav-pills .nav-link.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .table-modern {
        border-radius: 10px;
        overflow: hidden;
    }
    
    .table-modern thead {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    
    .table-modern thead th {
        border: none;
        padding: 15px;
        font-weight: 500;
    }
    
    .table-modern tbody tr:hover {
        background-color: rgba(102, 126, 234, 0.1);
    }
    
    .badge-type {
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
    }
    
    .chart-container {
        height: 250px;
    }
    
    @media print {
        .no-print { display: none !important; }
        .stat-card { break-inside: avoid; }
    }
</style>

<div class="production-dashboard">
    <!-- رأس التقرير -->
    <div class="d-flex justify-content-between align-items-center mb-4 no-print">
        <div>
            <h3 class="mb-1"><i class="fas fa-industry me-2"></i>تقرير الإنتاج الشامل</h3>
            <small class="text-muted">
                من {{ data.date_from|date:"Y/m/d" }} إلى {{ data.date_to|date:"Y/m/d" }}
                {% if data.selected_warehouses %}
                <span class="ms-2">
                    <i class="fas fa-warehouse me-1"></i>
                    {{ data.selected_warehouses|length }} مستودع
                </span>
                {% endif %}
            </small>
        </div>
        <div>
            <button class="btn btn-outline-primary me-2" onclick="window.print()">
                <i class="fas fa-print me-1"></i>طباعة
            </button>
            <button class="btn btn-success" onclick="exportToExcel()">
                <i class="fas fa-file-excel me-1"></i>تصدير
            </button>
        </div>
    </div>

    <!-- نموذج الفلترة -->
    <div class="card filter-card mb-4 no-print">
        <div class="card-body">
            <form method="GET" id="productionFilterForm">
                <div class="row g-3 align-items-end">
                    <div class="col-md-2">
                        <label class="form-label fw-bold">من تاريخ</label>
                        <input type="date" name="date_from" class="form-control" 
                               value="{{ data.date_from|date:'Y-m-d' }}">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-bold">إلى تاريخ</label>
                        <input type="date" name="date_to" class="form-control" 
                               value="{{ data.date_to|date:'Y-m-d' }}">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-bold">العرض</label>
                        <select name="view_mode" class="form-select">
                            <option value="all" {% if data.view_mode == 'all' %}selected{% endif %}>الكل</option>
                            <option value="incoming" {% if data.view_mode == 'incoming' %}selected{% endif %}>الوارد فقط</option>
                            <option value="produced" {% if data.view_mode == 'produced' %}selected{% endif %}>المنتج فقط</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-bold">نوع الطلب</label>
                        <select name="order_types" class="form-select" multiple size="1">
                            <option value="">الكل</option>
                            <option value="installation" {% if 'installation' in data.selected_order_types %}selected{% endif %}>تركيب</option>
                            <option value="custom" {% if 'custom' in data.selected_order_types %}selected{% endif %}>تفصيل</option>
                            <option value="accessory" {% if 'accessory' in data.selected_order_types %}selected{% endif %}>اكسسوار</option>
                            <option value="modification" {% if 'modification' in data.selected_order_types %}selected{% endif %}>تعديل</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-bold">خط الإنتاج</label>
                        <select name="production_line" class="form-select">
                            <option value="">الكل</option>
                            {% for pl in data.production_lines %}
                            <option value="{{ pl.id }}" {% if data.selected_production_line == pl.id|stringformat:"s" %}selected{% endif %}>{{ pl.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-search me-1"></i>بحث
                        </button>
                    </div>
                </div>
                
                <!-- صف ثاني: المستودعات -->
                <div class="row g-3 mt-2">
                    <div class="col-md-12">
                        <label class="form-label fw-bold">
                            <i class="fas fa-warehouse me-1"></i>
                            المستودعات لحساب الأمتار 
                            <small class="text-muted">(اتركها فارغة لاستخدام الإعدادات الافتراضية)</small>
                        </label>
                        <div class="d-flex flex-wrap gap-2 border rounded p-2 bg-light">
                            {% for wh in data.all_warehouses %}
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="warehouses" 
                                       value="{{ wh.id }}" id="wh_{{ wh.id }}"
                                       {% if wh.id in data.selected_warehouses %}checked{% endif %}>
                                <label class="form-check-label" for="wh_{{ wh.id }}">
                                    {{ wh.name }}
                                    {% if wh.id in data.default_warehouses %}
                                    <span class="badge bg-info" title="مستودع افتراضي">✓</span>
                                    {% endif %}
                                </label>
                            </div>
                            {% empty %}
                            <span class="text-muted">لا توجد مستودعات متاحة</span>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- بطاقات الإحصائيات الرئيسية -->
    <div class="row g-4 mb-4">
        <!-- الوارد -->
        <div class="col-md-3">
            <div class="card stat-card bg-gradient-primary text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="mb-1 opacity-75">الطلبات الواردة</p>
                            <h2 class="mb-0">{{ data.incoming_total }}</h2>
                            <small class="opacity-75">{{ data.incoming_meters }} متر</small>
                        </div>
                        <div class="stat-icon bg-white bg-opacity-25">
                            <i class="fas fa-inbox text-white"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- المنتج -->
        <div class="col-md-3">
            <div class="card stat-card bg-gradient-success text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="mb-1 opacity-75">الطلبات المنتجة</p>
                            <h2 class="mb-0">{{ data.produced_total }}</h2>
                            <small class="opacity-75">{{ data.produced_meters }} متر</small>
                        </div>
                        <div class="stat-icon bg-white bg-opacity-25">
                            <i class="fas fa-check-circle text-white"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- قيد الانتظار -->
        <div class="col-md-3">
            <div class="card stat-card bg-gradient-warning text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="mb-1 opacity-75">قيد التصنيع</p>
                            <h2 class="mb-0">{{ data.pending_count }}</h2>
                            <small class="opacity-75">{{ data.pending_meters }} متر</small>
                        </div>
                        <div class="stat-icon bg-white bg-opacity-25">
                            <i class="fas fa-clock text-white"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- نسبة الإنجاز -->
        <div class="col-md-3">
            <div class="card stat-card bg-gradient-info text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="mb-1 opacity-75">نسبة الإنجاز</p>
                            <h2 class="mb-0">{{ data.completion_rate }}%</h2>
                            <small class="opacity-75">من الوارد</small>
                        </div>
                        <div class="stat-icon bg-white bg-opacity-25">
                            <i class="fas fa-chart-pie text-white"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- التبويبات -->
    <ul class="nav nav-pills mb-4 no-print" id="reportTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="incoming-tab" data-bs-toggle="pill" 
                    data-bs-target="#incoming" type="button">
                <i class="fas fa-inbox me-1"></i>الوارد للمصنع
                <span class="badge bg-light text-dark ms-1">{{ data.incoming_total }}</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="produced-tab" data-bs-toggle="pill" 
                    data-bs-target="#produced" type="button">
                <i class="fas fa-check-circle me-1"></i>المنتج
                <span class="badge bg-light text-dark ms-1">{{ data.produced_total }}</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="stats-tab" data-bs-toggle="pill" 
                    data-bs-target="#stats" type="button">
                <i class="fas fa-chart-bar me-1"></i>الإحصائيات
            </button>
        </li>
    </ul>

    <div class="tab-content" id="reportTabsContent">
        <!-- تبويب الوارد -->
        <div class="tab-pane fade show active" id="incoming" role="tabpanel">
            <div class="card">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-inbox me-2 text-primary"></i>
                        الطلبات الواردة للمصنع
                    </h5>
                    <span class="badge bg-primary">{{ data.incoming_total }} طلب - {{ data.incoming_meters }} متر</span>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-modern table-hover mb-0" id="incomingTable">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>رقم التصنيع</th>
                                    <th>رقم الطلب</th>
                                    <th>العميل</th>
                                    <th>النوع</th>
                                    <th>الحالة الحالية</th>
                                    <th>الأمتار</th>
                                    <th>تاريخ الاستلام</th>
                                    <th>المستلم</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for order in data.incoming_orders_data %}
                                <tr>
                                    <td>{{ forloop.counter }}</td>
                                    <td>
                                        <a href="{% url 'manufacturing:order_detail_by_code' order.manufacturing_code %}" 
                                           target="_blank" class="fw-bold text-primary">
                                            {{ order.manufacturing_code }}
                                        </a>
                                    </td>
                                    <td>{{ order.order_number }}</td>
                                    <td>{{ order.customer_name }}</td>
                                    <td>
                                        <span class="badge badge-type 
                                            {% if order.order_type == 'installation' %}bg-info
                                            {% elif order.order_type == 'custom' %}bg-success
                                            {% elif order.order_type == 'accessory' %}bg-warning text-dark
                                            {% else %}bg-secondary{% endif %}">
                                            {{ order.order_type_display }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge 
                                            {% if order.current_status == 'completed' or order.current_status == 'delivered' %}bg-success
                                            {% elif order.current_status == 'ready_install' %}bg-primary
                                            {% elif order.current_status == 'in_progress' %}bg-warning text-dark
                                            {% elif order.current_status == 'pending' %}bg-info
                                            {% else %}bg-secondary{% endif %}">
                                            {{ order.current_status_display }}
                                        </span>
                                    </td>
                                    <td><strong>{{ order.meters }}</strong> م</td>
                                    <td>{{ order.received_date|date:"Y-m-d H:i" }}</td>
                                    <td>{{ order.received_by }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="9" class="text-center py-5 text-muted">
                                        <i class="fas fa-inbox fa-3x mb-3 d-block"></i>
                                        لا توجد طلبات واردة في الفترة المحددة
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            {% if data.incoming_orders_data %}
                            <tfoot class="table-light">
                                <tr>
                                    <th colspan="6" class="text-end">الإجمالي:</th>
                                    <th><strong>{{ data.incoming_meters }}</strong> م</th>
                                    <th colspan="2"></th>
                                </tr>
                            </tfoot>
                            {% endif %}
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- تبويب المنتج -->
        <div class="tab-pane fade" id="produced" role="tabpanel">
            <div class="card">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-check-circle me-2 text-success"></i>
                        الطلبات المنتجة
                    </h5>
                    <span class="badge bg-success">{{ data.produced_total }} طلب - {{ data.produced_meters }} متر</span>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-modern table-hover mb-0" id="producedTable">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>رقم التصنيع</th>
                                    <th>رقم الطلب</th>
                                    <th>العميل</th>
                                    <th>النوع</th>
                                    <th>الحالة</th>
                                    <th>الأمتار</th>
                                    <th>تاريخ الإنتاج</th>
                                    <th>المنفذ</th>
                                    <th>خط الإنتاج</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for order in data.produced_orders_data %}
                                <tr>
                                    <td>{{ forloop.counter }}</td>
                                    <td>
                                        <a href="{% url 'manufacturing:order_detail_by_code' order.manufacturing_code %}" 
                                           target="_blank" class="fw-bold text-primary">
                                            {{ order.manufacturing_code }}
                                        </a>
                                    </td>
                                    <td>{{ order.order_number }}</td>
                                    <td>{{ order.customer_name }}</td>
                                    <td>
                                        <span class="badge badge-type 
                                            {% if order.order_type == 'installation' %}bg-info
                                            {% elif order.order_type == 'custom' %}bg-success
                                            {% elif order.order_type == 'accessory' %}bg-warning text-dark
                                            {% else %}bg-secondary{% endif %}">
                                            {{ order.order_type_display }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge bg-success">{{ order.status_display }}</span>
                                    </td>
                                    <td><strong>{{ order.meters }}</strong> م</td>
                                    <td>{{ order.production_date|date:"Y-m-d H:i" }}</td>
                                    <td>{{ order.changed_by }}</td>
                                    <td>{{ order.production_line }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="10" class="text-center py-5 text-muted">
                                        <i class="fas fa-check-circle fa-3x mb-3 d-block"></i>
                                        لا توجد طلبات منتجة في الفترة المحددة
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            {% if data.produced_orders_data %}
                            <tfoot class="table-light">
                                <tr>
                                    <th colspan="6" class="text-end">الإجمالي:</th>
                                    <th><strong>{{ data.produced_meters }}</strong> م</th>
                                    <th colspan="3"></th>
                                </tr>
                            </tfoot>
                            {% endif %}
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- تبويب الإحصائيات -->
        <div class="tab-pane fade" id="stats" role="tabpanel">
            <div class="row g-4">
                <!-- توزيع الوارد حسب النوع -->
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-inbox me-2"></i>توزيع الوارد حسب النوع</h6>
                        </div>
                        <div class="card-body">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>النوع</th>
                                        <th>العدد</th>
                                        <th>الأمتار</th>
                                        <th>%</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in data.incoming_type_distribution %}
                                    <tr>
                                        <td>{{ item.type }}</td>
                                        <td>{{ item.count }}</td>
                                        <td>{{ item.meters }} م</td>
                                        <td>
                                            <div class="progress" style="height: 20px;">
                                                <div class="progress-bar bg-primary" 
                                                     style="width: {% widthratio item.count data.incoming_total 100 %}%">
                                                    {% widthratio item.count data.incoming_total 100 %}%
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr><td colspan="4" class="text-center text-muted">لا توجد بيانات</td></tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- توزيع المنتج حسب النوع -->
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-check-circle me-2"></i>توزيع المنتج حسب النوع</h6>
                        </div>
                        <div class="card-body">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>النوع</th>
                                        <th>العدد</th>
                                        <th>الأمتار</th>
                                        <th>%</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in data.produced_type_distribution %}
                                    <tr>
                                        <td>{{ item.type }}</td>
                                        <td>{{ item.count }}</td>
                                        <td>{{ item.meters }} م</td>
                                        <td>
                                            <div class="progress" style="height: 20px;">
                                                <div class="progress-bar bg-success" 
                                                     style="width: {% widthratio item.count data.produced_total 100 %}%">
                                                    {% widthratio item.count data.produced_total 100 %}%
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr><td colspan="4" class="text-center text-muted">لا توجد بيانات</td></tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- أداء المستلمين -->
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-users me-2"></i>أداء فريق الإنتاج</h6>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>الاسم</th>
                                            <th>عدد الطلبات المنتجة</th>
                                            <th>إجمالي الأمتار</th>
                                            <th>متوسط الأمتار/طلب</th>
                                            <th>النسبة</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for user in data.user_distribution|slice:":15" %}
                                        <tr>
                                            <td>{{ forloop.counter }}</td>
                                            <td><strong>{{ user.user }}</strong></td>
                                            <td>{{ user.count }}</td>
                                            <td>{{ user.meters }} م</td>
                                            <td>{% widthratio user.meters user.count 1 %} م</td>
                                            <td>
                                                <div class="progress" style="height: 25px; min-width: 100px;">
                                                    <div class="progress-bar bg-info" 
                                                         style="width: {% widthratio user.count data.produced_total 100 %}%">
                                                        {% widthratio user.count data.produced_total 100 %}%
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="6" class="text-center text-muted">لا توجد بيانات</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ملخص -->
                <div class="col-12">
                    <div class="card bg-light">
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-md-3">
                                    <h4 class="text-primary">{{ data.avg_meters_incoming }}</h4>
                                    <small class="text-muted">متوسط الأمتار/طلب وارد</small>
                                </div>
                                <div class="col-md-3">
                                    <h4 class="text-success">{{ data.avg_meters_produced }}</h4>
                                    <small class="text-muted">متوسط الأمتار/طلب منتج</small>
                                </div>
                                <div class="col-md-3">
                                    <h4 class="text-info">{{ data.completion_rate }}%</h4>
                                    <small class="text-muted">نسبة الإنجاز</small>
                                </div>
                                <div class="col-md-3">
                                    <h4 class="text-warning">{{ data.pending_count }}</h4>
                                    <small class="text-muted">طلبات قيد التصنيع</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// تصدير Excel
function exportToExcel() {
    const activeTab = document.querySelector('.tab-pane.active');
    const table = activeTab.querySelector('table');
    if (table) {
        const wb = XLSX.utils.table_to_book(table, {sheet: "التقرير"});
        XLSX.writeFile(wb, `production_report_${new Date().toISOString().slice(0,10)}.xlsx`);
    }
}

// تحميل مكتبة XLSX
if (typeof XLSX === 'undefined') {
    const script = document.createElement('script');
    script.src = 'https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js';
    document.head.appendChild(script);
}

// DataTables
document.addEventListener('DOMContentLoaded', function() {
    if (typeof $.fn !== 'undefined' && $.fn.DataTable) {
        // التحقق من وجود بيانات في الجدول قبل تهيئة DataTables
        const incomingTableBody = $('#incomingTable tbody tr');
        const producedTableBody = $('#producedTable tbody tr');
        
        const incomingOptions = {
            language: {
                url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/ar.json'
            },
            pageLength: 25,
            order: [[7, 'desc']], // عمود تاريخ الاستلام
            dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>rtip',
            columnDefs: [
                { orderable: false, targets: 0 } // عمود الترقيم
            ]
        };
        
        const producedOptions = {
            language: {
                url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/ar.json'
            },
            pageLength: 25,
            order: [[7, 'desc']], // عمود تاريخ الإنتاج
            dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>rtip',
            columnDefs: [
                { orderable: false, targets: 0 } // عمود الترقيم
            ]
        };
        
        // تهيئة DataTables فقط إذا كان هناك بيانات فعلية (أكثر من صف واحد أو الصف ليس فارغاً)
        if (incomingTableBody.length > 0 && !incomingTableBody.first().find('td[colspan]').length) {
            $('#incomingTable').DataTable(incomingOptions);
        }
        
        if (producedTableBody.length > 0 && !producedTableBody.first().find('td[colspan]').length) {
            $('#producedTable').DataTable(producedOptions);
        }
    }
});
</script>
