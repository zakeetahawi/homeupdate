# خطة تطوير وتحسين نظام HomeUpdate لبيئة Daphne (ASGI)

هذه الوثيقة تمثل خارطة طريق تقنية كاملة لتحويل النظام من وضع التشغيل التقليدي إلى وضع التشغيل المتطور (High-Performance ASGI) لضمان السرعة الفائقة واستقرار البيانات اللحظية.

## المرحلة الأولى: تنظيف وتحصين الإعدادات (Infrastructure Cleanup)
الهدف: توحيد بنية الإعدادات ومنع أي تضارب بين بيئة التطوير والإنتاج.

1.  **توحيد ملف `settings.py`**:
    *   إزالة التكرار في تعريف `DATABASES` و `LOGGING`.
    *   تثبيت `CONN_MAX_AGE` على 60 ثانية لضمان ثبات اتصالات قاعدة البيانات مع Daphne.
    *   ضبط `SESSION_ENGINE` ليعمل بنظام `cached_db` باستخدام Redis لتسريع الدخول.

2.  **تطوير معايير الأمان (Security Hardening)**:
    *   تفعيل `SECURE_CROSS_ORIGIN_OPENER_POLICY` بشكل صحيح.
    *   ضبط إعدادات `CSRF_TRUSTED_ORIGINS` بدقة لتشمل نطاق الإنتاج فقط.

## المرحلة الثانية: تحسين طبقة الميدل وير (Execution Layer Efficiency)
الهدف: إزالة "عنق الزجاجة" الذي يبطئ الاستجابة لكل مستخدم.

1.  **تحديث `UserSessionTrackingMiddleware`**:
    *   بدلاً من الكتابة في قاعدة البيانات (SQL) في كل طلب، سيتم تخزين النشاط في Redis وتحديث قاعدة البيانات كل 5 دقائق فقط.
2.  **تأمين `CurrentUserMiddleware`**:
    *   استبدال `threading.local` بـ `ContextVar` لضمان سلامة بيانات المستخدم في بيئة المهام المتزامنة (Async tasks).

## المرحلة الثالثة: تحسين الأداء اللحظي (Real-time Optimization)
الهدف: جعل الوصول للبيانات والرسائل فورياً بأقل استهلاك للمعالج.

1.  **تحسين الـ Channel Layer**:
    *   ضبط `expiry` للرسائل في Redis لتقليل استهلاك الذاكرة.
    *   تفعيل الضغط (Compression) لرسائل الـ WebSocket.
2.  **تحليل الاستعلامات (SQL Indexing)**:
    *   إضافة فهارس (Indexes) مركبة للعمليات التي تعتمد على الوقت والحالة معاً.

## المرحلة الرابعة: ضبط خادم Daphne (Service Tuning)
الهدف: استغلال كامل قوة الجهاز (HP Z230) لخدمة أكبر عدد من المستخدمين.

1.  **تعديل سكريبت التشغيل**:
    *   إضافة `--threads 4` (أو حسب عدد الأنوية في الجهاز) لتمكين Daphne من معالجة طلبات متعددة في نفس اللحظة.
    *   تفعيل `--access-log` بشكل منظم للمراقبة الدورية.

---
**[شكرا زكي]**
هذه الخطة جاهزة للتنفيذ، وسأقوم برفعها الآن على غيت هاب لتكون مرجعاً دائماً لنا.
