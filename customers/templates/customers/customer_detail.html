{% extends 'base.html' %}
{% load i18n %}
{% load static %}

{% block title %}{{ customer.name }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Customer Header with Enhanced Design -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm {% if is_cross_branch %}cross-branch-customer-detail{% endif %}">
                {% if is_cross_branch %}
                <div class="alert alert-warning mb-0 border-0 rounded-top" style="border-radius: 0.375rem 0.375rem 0 0 !important;">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>تنبيه:</strong> هذا العميل من فرع آخر ({{ customer.branch.name }})
                        <span class="ms-auto">
                            <i class="fas fa-info-circle me-1"></i>
                            يمكنك عرض البيانات وإنشاء طلبات مرتبطة بفرعك ({{ user_branch.name }})
                        </span>
                    </div>
                </div>
                {% endif %}
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-2 text-center">
                            {% if customer.image %}
                            <img src="{{ customer.image.url }}" alt="{{ customer.name }}"
                                 class="img-fluid rounded-circle border border-3 border-primary"
                                 style="max-width: 120px; max-height: 120px;">
                            {% else %}
                            <div class="bg-primary rounded-circle d-inline-flex align-items-center justify-content-center"
                                 style="width: 120px; height: 120px;">
                                <i class="fas fa-user fa-3x text-white"></i>
                            </div>
                            {% endif %}
                        </div>
                        <div class="col-md-8">
                            <h2 class="mb-1">
                                <i class="fas fa-user-tie text-primary"></i> {{ customer.name }}
                                <small class="text-muted fs-6">#{{ customer.code }}</small>
                                {% if is_cross_branch %}
                                    <span class="badge bg-warning text-dark ms-2">
                                        <i class="fas fa-exchange-alt"></i> فرع آخر
                                    </span>
                                {% endif %}
                            </h2>
                            <div class="mb-3">
                                <span class="badge {% if customer.status == 'active' %}bg-success
                                       {% elif customer.status == 'inactive' %}bg-warning text-dark
                                       {% else %}bg-danger{% endif %} me-2">
                                    <i class="fas fa-circle me-1"></i>{{ customer.get_status_display }}
                                </span>
                                <span class="badge bg-info me-2">
                                    <i class="fas fa-tag me-1"></i>{{ customer.get_customer_type_display }}
                                </span>
                                {% if customer.category %}
                                <span class="badge bg-secondary me-2">
                                    <i class="fas fa-folder me-1"></i>{{ customer.category.name }}
                                </span>
                                {% endif %}
                                {% if customer.branch %}
                                <span class="badge {% if is_cross_branch %}bg-warning text-dark{% else %}bg-dark{% endif %}">
                                    <i class="fas fa-building me-1"></i>{{ customer.branch.name }}
                                    {% if is_cross_branch %}
                                        <small class="d-block">فرع العميل</small>
                                    {% endif %}
                                </span>
                                {% endif %}
                            </div>
                            <div class="d-flex flex-wrap gap-3">
                                {% if customer.phone %}
                                <div>
                                    <small class="text-muted d-block">{% trans 'الهاتف الأساسي' %}</small>
                                    <a href="tel:{{ customer.phone }}" class="text-decoration-none">
                                        <i class="fas fa-phone text-success"></i> {{ customer.phone }}
                                    </a>
                                </div>
                                {% endif %}
                                {% if customer.email %}
                                <div>
                                    <small class="text-muted d-block">{% trans 'البريد الإلكتروني' %}</small>
                                    <a href="mailto:{{ customer.email }}" class="text-decoration-none">
                                        <i class="fas fa-envelope text-primary"></i> {{ customer.email }}
                                    </a>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-2 text-end">
                            <div class="btn-group-vertical d-grid gap-2">
                                <a href="{% url 'orders:order_create' %}?customer={{ customer.code }}" class="btn btn-success btn-sm">
                                    <i class="fas fa-plus"></i> {% trans 'إنشاء طلب' %}
                                    {% if is_cross_branch %}
                                        <small class="d-block">مرتبط بفرعك</small>
                                    {% endif %}
                                </a>
                                <a href="{% url 'complaints:complaint_create' %}?customer_id={{ customer.pk }}" class="btn btn-warning btn-sm">
                                    <i class="fas fa-headset"></i> {% trans 'إنشاء شكوى' %}
                                    {% if is_cross_branch %}
                                        <small class="d-block">مرتبط بفرعك</small>
                                    {% endif %}
                                </a>
                                {% if can_edit %}
                                    <a href="{% url 'customers:customer_update' customer.pk %}" class="btn btn-primary btn-sm">
                                        <i class="fas fa-edit"></i> {% trans 'تعديل' %}
                                    </a>
                                {% else %}
                                    {% if is_cross_branch %}
                                        <button class="btn btn-secondary btn-sm disabled" title="لا يمكن التعديل - عميل من فرع آخر">
                                            <i class="fas fa-lock"></i> {% trans 'محظور التعديل' %}
                                        </button>
                                    {% endif %}
                                {% endif %}
                                {% if perms.customers.delete_customer and not is_cross_branch %}
                                    <a href="{% url 'customers:customer_delete' customer.pk %}" class="btn btn-outline-danger btn-sm">
                                        <i class="fas fa-trash"></i> {% trans 'حذف' %}
                                    </a>
                                {% endif %}
                                <a href="{% url 'customers:customer_list' %}" class="btn btn-outline-secondary btn-sm">
                                    <i class="fas fa-arrow-left"></i> {% trans 'العودة' %}
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cross-Branch Access Log -->
    {% if show_cross_branch_alert %}
    <div class="row mb-3">
        <div class="col-12">
            <div class="alert alert-info border-0 shadow-sm">
                <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-info-circle fa-2x text-info"></i>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h6 class="alert-heading mb-1">
                            <i class="fas fa-history me-2"></i>سجل الوصول عبر الفروع
                        </h6>
                        <p class="mb-2">
                            تم الوصول لبيانات هذا العميل من فرع <strong>{{ user_branch.name }}</strong>
                            بواسطة <strong>{{ user.get_full_name|default:user.username }}</strong>
                        </p>
                        <small class="text-muted">
                            <i class="fas fa-clock me-1"></i>
                            تم تسجيل هذا الوصول في سجل ملاحظات العميل
                        </small>
                    </div>
                    <div class="flex-shrink-0">
                        <span class="badge bg-info">
                            <i class="fas fa-exchange-alt me-1"></i>وصول عبر فروع
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="row">
        <!-- Customer Information -->
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">{% trans 'معلومات العميل' %}</h5>
                </div>
                <div class="card-body">
                    {% if customer.image %}
                    <div class="text-center mb-3">
                        <img src="{{ customer.image.url }}" alt="{{ customer.name }}"
                             class="img-fluid rounded-circle" style="max-width: 150px;">
                    </div>
                    {% endif %}                    <table class="table table-sm">
                        <tr>
                            <th>{% trans 'كود العميل' %}:</th>
                            <td><strong>{{ customer.code }}</strong></td>
                        </tr>
                        <tr>
                            <th>{% trans 'نوع العميل' %}:</th>
                            <td>
                                <span class="badge bg-info">{{ customer.get_customer_type_display }}</span>
                            </td>
                        </tr>
                        {% if customer.category %}
                        <tr>
                            <th>{% trans 'تصنيف العميل' %}:</th>
                            <td>
                                <span class="badge bg-secondary">{{ customer.category.name }}</span>
                            </td>
                        </tr>
                        {% endif %}
                        {% if customer.discount_type %}
                        <tr>
                            <th>{% trans 'نوع الخصم' %}:</th>
                            <td>
                                <span class="badge bg-success">
                                    <i class="fas fa-percentage me-1"></i>{{ customer.discount_type.name }}
                                </span>
                                <small class="text-muted ms-2">({{ customer.discount_type.percentage }}%)</small>
                            </td>
                        </tr>
                        {% endif %}
                        <tr>
                            <th>{% trans 'الحالة' %}:</th>
                            <td>
                                <span class="badge {% if customer.status == 'active' %}bg-success
                                       {% elif customer.status == 'inactive' %}bg-warning text-dark
                                       {% else %}bg-danger{% endif %}">
                                    {{ customer.get_status_display }}
                                </span>
                            </td>
                        </tr>
                        <tr>
                            <th>{% trans 'الهاتف' %}:</th>
                            <td>
                                <a href="tel:{{ customer.phone }}" class="text-decoration-none">
                                    <i class="fas fa-phone text-success"></i> {{ customer.phone }}
                                </a>
                            </td>
                        </tr>
                        {% if customer.phone2 %}
                        <tr>
                            <th>{% trans 'الهاتف الثاني' %}:</th>
                            <td>
                                <a href="tel:{{ customer.phone2 }}" class="text-decoration-none">
                                    <i class="fas fa-phone text-success"></i> {{ customer.phone2 }}
                                </a>
                            </td>
                        </tr>
                        {% endif %}
                        {% if customer.email %}
                        <tr>
                            <th>{% trans 'البريد الإلكتروني' %}:</th>
                            <td>
                                <a href="mailto:{{ customer.email }}" class="text-decoration-none">
                                    <i class="fas fa-envelope text-primary"></i> {{ customer.email }}
                                </a>
                            </td>
                        </tr>
                        {% endif %}
                        {% if customer.birth_date %}
                        <tr>
                            <th>{% trans 'تاريخ الميلاد' %}:</th>
                            <td>
                                <i class="fas fa-birthday-cake text-warning"></i> 
                                {{ customer.birth_date|date:"Y-m-d" }}
                                <small class="text-muted">{{ customer.birth_date|date:"Y-m-d" }}</small>
                            </td>
                        </tr>
                        {% endif %}
                        <tr>
                            <th>{% trans 'العنوان' %}:</th>
                            <td>
                                <i class="fas fa-map-marker-alt text-danger"></i> {{ customer.address }}
                            </td>
                        </tr>
                        {% if customer.branch %}
                        <tr>
                            <th>{% trans 'الفرع' %}:</th>
                            <td>
                                <i class="fas fa-building text-info"></i> {{ customer.branch.name }}
                            </td>
                        </tr>
                        {% endif %}
                        <tr>
                            <th>{% trans 'تاريخ الإنشاء' %}:</th>
                            <td>
                                <i class="fas fa-calendar-alt text-info"></i> {{ customer.created_at|date:"Y-m-d H:i" }}
                            </td>
                        </tr>
                        {% if customer.created_by %}
                        <tr>
                            <th>{% trans 'أنشئ بواسطة' %}:</th>
                            <td>
                                <i class="fas fa-user text-primary"></i> {{ customer.created_by.get_full_name|default:customer.created_by.username }}
                            </td>
                        </tr>
                        {% endif %}
                    </table>
                </div>
            </div>

            <!-- قسم المسؤولين للشركات والجهات الحكومية -->
            {% if customer.customer_type == 'corporate' or customer.customer_type == 'government' %}
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-users me-2"></i>مسؤولي العميل
                    </h5>
                </div>
                <div class="card-body">
                    {% if customer.responsibles.exists %}
                        <div class="row">
                            {% for responsible in customer.responsibles.all %}
                            <div class="col-md-6 mb-3">
                                <div class="card border-left-primary">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <h6 class="text-primary mb-1">
                                                    <i class="fas fa-user me-1"></i>{{ responsible.name }}
                                                    {% if responsible.is_primary %}
                                                    <span class="badge bg-warning text-dark ms-2">رئيسي</span>
                                                    {% endif %}
                                                </h6>
                                                {% if responsible.position %}
                                                <p class="text-muted mb-1">
                                                    <i class="fas fa-briefcase me-1"></i>{{ responsible.position }}
                                                </p>
                                                {% endif %}
                                                {% if responsible.phone %}
                                                <p class="mb-1">
                                                    <i class="fas fa-phone me-1 text-success"></i>
                                                    <a href="tel:{{ responsible.phone }}" class="text-decoration-none">{{ responsible.phone }}</a>
                                                </p>
                                                {% endif %}
                                                {% if responsible.email %}
                                                <p class="mb-0">
                                                    <i class="fas fa-envelope me-1 text-info"></i>
                                                    <a href="mailto:{{ responsible.email }}" class="text-decoration-none">{{ responsible.email }}</a>
                                                </p>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-users fa-3x mb-3"></i>
                            <p>لم يتم إضافة مسؤولين لهذا العميل بعد</p>
                            <a href="{% url 'customers:customer_update' customer.pk %}" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-plus me-1"></i>إضافة مسؤولين
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

              <!-- Customer Interests -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-heart text-primary me-2"></i>
                        اهتمامات العميل
                    </h5>
                </div>
                <div class="card-body">
                    {% if customer.interests %}
                        <p class="card-text">{{ customer.interests|linebreaks }}</p>
                    {% else %}
                        <p class="text-muted">لم يتم تحديد اهتمامات للعميل</p>
                    {% endif %}
                </div>
            </div>

            <!-- Customer General Notes -->
            {% if customer.notes %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-sticky-note text-warning"></i> {% trans 'ملاحظات عامة' %}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="p-3 bg-light rounded">
                        {{ customer.notes|linebreaks }}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Customer Details Tabs -->
        <div class="col-md-8">
            <!-- Tab Navigation -->
            <ul class="nav nav-tabs mb-4" id="customerTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="notes-tab" data-bs-toggle="tab" data-bs-target="#notes" type="button" role="tab">
                        <i class="fas fa-sticky-note me-2"></i>الملاحظات
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="complaints-tab" data-bs-toggle="tab" data-bs-target="#complaints" type="button" role="tab">
                        <i class="fas fa-exclamation-triangle me-2"></i>الشكاوى
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="access-logs-tab" data-bs-toggle="tab" data-bs-target="#access-logs" type="button" role="tab">
                        <i class="fas fa-history me-2"></i>سجل الوصول
                        {% if access_logs %}
                            <span class="badge bg-info ms-1">{{ access_logs|length }}</span>
                        {% endif %}
                    </button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="customerTabsContent">
                <!-- Notes Tab -->
                <div class="tab-pane fade show active" id="notes" role="tabpanel">
                    <!-- Add Note Button -->
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">{% trans 'ملاحظات العميل' %}</h5>
                            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addNoteModal">
                                <i class="fas fa-plus me-1"></i>{% trans 'إضافة ملاحظة' %}
                            </button>
                        </div>
                    </div>

                    <!-- Notes History -->
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">{% trans 'سجل الملاحظات' %}</h5>
                        </div>
                        <div class="card-body">
                            {% if customer.notes_history.all %}
                            <div class="notes-list">
                                {% for note in customer.notes_history.all %}
                                <div class="note-item {% if 'تم الوصول لبيانات العميل' in note.note %}cross-branch-note{% endif %} mb-3 p-3 border rounded">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <small class="text-muted">
                                            <i class="fas fa-clock me-1"></i>{{ note.created_at|date:"Y-m-d H:i" }}
                                        </small>
                                        {% if 'تم الوصول لبيانات العميل' in note.note %}
                                            <span class="badge bg-info">
                                                <i class="fas fa-exchange-alt me-1"></i>وصول عبر فروع
                                            </span>
                                        {% endif %}
                                    </div>
                                    <p class="mb-2">{{ note.note }}</p>
                                    <small class="text-muted">
                                        <i class="fas fa-user me-1"></i>
                                        {% if note.created_by %}
                                            {{ note.created_by.get_full_name|default:note.created_by.username }}
                                        {% else %}
                                            غير محدد
                                        {% endif %}
                                    </small>
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <p class="text-muted">{% trans 'لا توجد ملاحظات' %}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Complaints Tab -->
                <div class="tab-pane fade" id="complaints" role="tabpanel">
                    {% include 'complaints/widgets/customer_complaints_widget.html' with customer=customer %}
                </div>

                <!-- Access Logs Tab -->
                <div class="tab-pane fade" id="access-logs" role="tabpanel">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-history me-2"></i>سجل الوصول للعميل
                            </h5>
                            <small class="text-muted">
                                آخر {{ access_logs|length }} عملية وصول
                            </small>
                        </div>
                        <div class="card-body">
                            {% if access_logs %}
                                <div class="access-logs-list">
                                    {% for log in access_logs %}
                                    <div class="access-log-item {% if log.is_cross_branch %}cross-branch-access{% endif %} mb-3 p-3 border rounded">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <div class="d-flex align-items-center">
                                                <div class="me-3">
                                                    {% if log.is_cross_branch %}
                                                        <i class="fas fa-exchange-alt text-warning fa-lg"></i>
                                                    {% else %}
                                                        <i class="fas fa-eye text-primary fa-lg"></i>
                                                    {% endif %}
                                                </div>
                                                <div>
                                                    <h6 class="mb-1">
                                                        {{ log.user.get_full_name|default:log.user.username }}
                                                        {% if log.is_cross_branch %}
                                                            <span class="badge bg-warning text-dark ms-2">
                                                                <i class="fas fa-building me-1"></i>وصول عبر فروع
                                                            </span>
                                                        {% endif %}
                                                    </h6>
                                                    <small class="text-muted">
                                                        <i class="fas fa-clock me-1"></i>{{ log.accessed_at|date:"Y-m-d H:i:s" }}
                                                        <span class="ms-2">({{ log.time_since_access }})</span>
                                                    </small>
                                                </div>
                                            </div>
                                            <div class="text-end">
                                                {% if log.user_branch and log.user_branch != customer.branch %}
                                                    <small class="text-muted d-block">
                                                        <i class="fas fa-user-tag me-1"></i>{{ log.user_branch.name }}
                                                    </small>
                                                {% endif %}
                                            </div>
                                        </div>

                                        {% if log.is_cross_branch and log.customer_branch %}
                                            <div class="alert alert-warning alert-sm mb-0">
                                                <i class="fas fa-info-circle me-1"></i>
                                                تم الوصول من فرع <strong>{{ log.user_branch.name|default:"غير محدد" }}</strong>
                                                لعميل تابع لفرع <strong>{{ log.customer_branch.name }}</strong>
                                            </div>
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                </div>

                                {% if access_logs|length >= 20 %}
                                    <div class="text-center mt-3">
                                        <small class="text-muted">
                                            <i class="fas fa-info-circle me-1"></i>
                                            يتم عرض آخر 20 عملية وصول فقط
                                        </small>
                                    </div>
                                {% endif %}
                            {% else %}
                                <div class="text-center py-4">
                                    <i class="fas fa-history text-muted mb-3" style="font-size: 3rem;"></i>
                                    <h6 class="text-muted">لا توجد سجلات وصول</h6>
                                    <p class="text-muted small">لم يتم تسجيل أي عمليات وصول لهذا العميل بعد</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Orders & Inspections -->
    <div class="row mt-4">
        <!-- Recent Orders -->
        <div class="col-md-6">
            <div class="card" style="font-size: 0.93em; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.04);">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">{% trans 'آخر الطلبات' %}</h5>
                    <a href="{% url 'orders:order_list' %}?customer={{ customer.code }}" class="btn btn-sm btn-outline-primary">
                        {% trans 'عرض الكل' %}
                    </a>
                </div>
                <div class="card-body" style="padding: 0.7rem 0.7rem 0.5rem 0.7rem;">
                    {% if orders %}
                    <div class="table-responsive">
                        <table class="table table-sm" id="orders-table-customer-detail">
                            <thead>
                                <tr>
                                    <th style="width: 60px; min-width: 60px; text-align: center;">رقم الطلب</th>
                                    <th style="min-width: 100px; text-align: center;">التاريخ</th>
                                    <th style="min-width: 120px; text-align: center;">النوع</th>
                                    <th style="min-width: 120px; text-align: center;">الحالة</th>
                                    <th style="min-width: 90px; text-align: center;">القيمة</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for order in orders %}
                                <tr>
                                    <td style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 60px; text-align: center; font-weight: bold; font-size: 1em;">
                                        <a href="{% url 'orders:order_detail' order.pk %}" tabindex="0" class="order-popover" data-bs-toggle="popover" data-bs-trigger="hover focus" data-bs-html="true" data-bs-content="<b>رقم العقد:</b> {{ order.contract_number|default:'-' }}{% if order.contract_number_2 %}<br/><b>عقد إضافي 2:</b> {{ order.contract_number_2 }}{% endif %}{% if order.contract_number_3 %}<br/><b>عقد إضافي 3:</b> {{ order.contract_number_3 }}{% endif %}<br/><b>البائع:</b> {{ order.salesperson.name|default:'-' }}<br/><b>تاريخ الطلب:</b> {{ order.order_date|date:'Y-m-d H:i' }}<br/><b>حالة التصنيع:</b> {% if order.manufacturing_order %}{{ order.manufacturing_order.get_status_display }}{% else %}-{% endif %}">>
                                            {{ order.order_number }}
                                        </a>
                                    </td>
                                    <td style="white-space: nowrap; max-width: 100px; text-align: center;">{{ order.order_date|date:"Y-m-d" }}</td>
                                    <td style="white-space: nowrap; max-width: 140px; text-align: center;">
                                        {% if order.order_type == 'product' %}
                                            <span class="badge bg-primary">منتج</span>
                                        {% elif order.order_type == 'service' %}
                                            <span class="badge bg-info">خدمة</span>
                                            {% for service_type in order.service_types %}
                                                {% if service_type == 'installation' %}
                                                    <span class="badge bg-secondary">تركيب</span>
                                                {% elif service_type == 'inspection' %}
                                                    <span class="badge bg-warning">معاينة</span>
                                                {% elif service_type == 'transport' %}
                                                    <span class="badge bg-dark">نقل</span>
                                                {% elif service_type == 'tailoring' %}
                                                    <span class="badge bg-success">تسليم</span>
                                                {% endif %}
                                            {% endfor %}
                                        {% else %}
                                            <span class="badge bg-secondary">طلب</span>
                                            {% for selected_type in order.selected_types %}
                                                {% if selected_type == 'fabric' %}
                                                    <span class="badge bg-primary">قماش</span>
                                                {% elif selected_type == 'accessory' %}
                                                    <span class="badge bg-info">إكسسوار</span>
                                                {% elif selected_type == 'installation' %}
                                                    <span class="badge bg-secondary">تركيب</span>
                                                {% elif selected_type == 'inspection' %}
                                                    <span class="badge bg-warning">معاينة</span>
                                                {% elif selected_type == 'transport' %}
                                                    <span class="badge bg-dark">نقل</span>
                                                {% elif selected_type == 'tailoring' %}
                                                    <span class="badge bg-success">تسليم</span>
                                                {% endif %}
                                            {% endfor %}
                                        {% endif %}
                                    </td>
                                    <td style="white-space: nowrap; max-width: 140px; text-align: center;">
                                        <span class="badge {{ order.get_display_status_badge_class }}" style="font-size: 0.95em; padding: 0.35em 0.7em;">
                                            <i class="{{ order.get_display_status_icon }} me-1"></i>
                                            {{ order.get_display_status_text }}
                                        </span>
                                    </td>
                                    <td style="white-space: nowrap; max-width: 90px; text-align: center; font-weight: 600;">{{ order.total|default:'-' }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted">{% trans 'لا توجد طلبات' %}</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Recent Inspections -->
        <div class="col-md-6">
            <div class="card" style="font-size: 0.93em; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.04);">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">{% trans 'آخر المعاينات' %}</h5>
                    <a href="{% url 'inspections:inspection_list' %}?q={{ customer.code }}" class="btn btn-sm btn-outline-success">
                        {% trans 'عرض الكل' %}
                    </a>
                </div>
                <div class="card-body" style="padding: 0.7rem 0.7rem 0.5rem 0.7rem;">
                    {% if inspections %}
                    <div class="table-responsive">
                        <table class="table table-sm" id="inspections-table-customer-detail">
                            <thead>
                                <tr>
                                    <th style="width: 80px; min-width: 80px; text-align: center;">كود المعاينة</th>
                                    <th style="min-width: 100px; text-align: center;">التاريخ</th>
                                    <th style="min-width: 120px; text-align: center;">الحالة</th>
                                    <th style="min-width: 100px; text-align: center;">الموعد</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for inspection in inspections %}
                                <tr onclick="window.location.href='{% url 'inspections:inspection_detail_by_code' inspection_code=inspection.inspection_code %}'" style="cursor: pointer;">
                                    <td style="text-align: center;">{{ inspection.inspection_code|default:"--" }}</td>
                                    <td style="text-align: center;">{{ inspection.created_at|date:"Y-m-d" }}</td>
                                    <td style="text-align: center;">
                                        <span class="status-label status-{{ inspection.status }}">
                                            {{ inspection.get_status_display }}
                                        </span>
                                    </td>
                                    <td style="text-align: center;">
                                        {% if inspection.scheduled_date %}
                                            {{ inspection.scheduled_date|date:"Y-m-d" }}
                                        {% else %}
                                            --
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted">{% trans 'لا توجد معاينات' %}</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .timeline {
        position: relative;
        padding: 20px 0;
    }

    .timeline-item {
        padding: 20px 30px;
        border-left: 2px solid #e9ecef;
        position: relative;
        margin-bottom: 20px;
    }

    .timeline-item:before {
        content: '';
        position: absolute;
        left: -7px;
        top: 24px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #007bff;
    }

    .timeline-date {
        color: #6c757d;
        font-size: 0.9rem;
        margin-bottom: 5px;
    }

    .timeline-content {
        padding: 10px;
        background: #f8f9fa;
        border-radius: 4px;
    }

    .card-header {
        border-bottom: 2px solid var(--primary);
    }

    .card-title {
        font-size: 1.1rem;
        font-weight: 600;
    }

    .card-text {
        white-space: pre-line;
        color: var(--dark);
    }

    .text-muted {
        font-style: italic;
    }

    .cross-branch-customer-detail {
        border-left: 4px solid #ffc107 !important;
    }

    .cross-branch-customer-detail .alert-warning {
        background-color: #fff3cd;
        border-color: #ffc107;
        color: #856404;
    }

    #orders-table td, #orders-table th {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        vertical-align: middle;
    }
    .action-buttons {
        display: flex;
        gap: 0.25rem;
        justify-content: center;
        align-items: center;
    }
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
        20%, 40%, 60%, 80% { transform: translateX(5px); }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var popoverTriggerList = [].slice.call(document.querySelectorAll('.order-popover'));
        var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
            return new bootstrap.Popover(popoverTriggerEl, {
                container: 'body',
                placement: 'auto',
                trigger: 'hover focus',
                html: true
            });
        });

        // التحقق من نموذج إضافة الملاحظة
        const noteForm = document.getElementById('noteForm');
        const noteTextarea = document.getElementById('noteTextarea');
        const noteError = document.getElementById('noteError');
        const addNoteBtn = document.getElementById('addNoteBtn');
        const addNoteModal = document.getElementById('addNoteModal');

        // إعادة تعيين النموذج عند فتح الـ Modal
        if (addNoteModal) {
            addNoteModal.addEventListener('shown.bs.modal', function () {
                if (noteTextarea) {
                    noteTextarea.value = '';
                    noteTextarea.focus();
                    isSubmitting = false; // إعادة تعيين حالة الإرسال
                    lastSubmittedNote = ''; // مسح آخر ملاحظة
                    checkNoteContent();
                }
            });
        }

        if (noteForm && noteTextarea && addNoteBtn) {
            let isSubmitting = false; // متغير لمنع الإرسال المتكرر
            let lastSubmittedNote = ''; // آخر ملاحظة تم إرسالها

            // تعطيل زر الإضافة في البداية إذا كان النص فارغ
            function checkNoteContent() {
                const noteValue = noteTextarea.value.trim();
                if (noteValue.length > 0) {
                    addNoteBtn.disabled = false;
                    addNoteBtn.classList.remove('btn-secondary');
                    addNoteBtn.classList.add('btn-primary');
                    noteTextarea.classList.remove('is-invalid');
                    noteError.style.display = 'none';
                } else {
                    addNoteBtn.disabled = true;
                    addNoteBtn.classList.remove('btn-primary');
                    addNoteBtn.classList.add('btn-secondary');
                }
            }

            // فحص المحتوى عند التحميل
            checkNoteContent();

            // فحص المحتوى عند الكتابة
            noteTextarea.addEventListener('input', checkNoteContent);
            noteTextarea.addEventListener('keyup', checkNoteContent);
            noteTextarea.addEventListener('paste', function() {
                setTimeout(checkNoteContent, 100);
            });

            noteForm.addEventListener('submit', function(e) {
                e.preventDefault(); // منع الإرسال العادي دائماً

                // التحقق من عدم الإرسال المتكرر
                if (isSubmitting) {
                    return false;
                }

                const noteValue = noteTextarea.value.trim();

                // التحقق من عدم تكرار نفس الملاحظة
                if (noteValue === lastSubmittedNote) {
                    alert('تم إرسال هذه الملاحظة مؤخراً');
                    return false;
                }

                if (!noteValue) {
                    e.preventDefault();

                    // إظهار رسالة الخطأ
                    noteTextarea.classList.add('is-invalid');
                    noteError.style.display = 'block';

                    // التركيز على الحقل
                    noteTextarea.focus();

                    // إضافة تأثير اهتزاز
                    noteTextarea.style.animation = 'shake 0.5s ease-in-out';
                    setTimeout(() => {
                        noteTextarea.style.animation = '';
                    }, 500);

                    // إظهار رسالة تنبيه
                    alert('يرجى كتابة الملاحظة قبل الإضافة');

                    return false;
                } else {
                    // إخفاء رسالة الخطأ إذا كان النص موجود
                    noteTextarea.classList.remove('is-invalid');
                    noteError.style.display = 'none';

                    // تعيين حالة الإرسال
                    isSubmitting = true;
                    lastSubmittedNote = noteValue; // حفظ الملاحظة المرسلة

                    // تعطيل الزر لمنع الإرسال المتكرر
                    addNoteBtn.disabled = true;
                    addNoteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الإضافة...';

                    // إرسال النموذج عبر AJAX لتجنب إعادة تحميل الصفحة
                    const formData = new FormData(noteForm);
                    fetch(noteForm.action, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    }).then(response => {
                        return response.json().then(data => {
                            if (response.ok && data.success) {
                                // إغلاق الـ Modal
                                const modal = bootstrap.Modal.getInstance(addNoteModal);
                                modal.hide();

                                // إعادة تعيين النموذج
                                noteTextarea.value = '';
                                addNoteBtn.disabled = true;
                                addNoteBtn.innerHTML = '<i class="fas fa-plus me-1"></i>إضافة الملاحظة';
                                addNoteBtn.classList.remove('btn-primary');
                                addNoteBtn.classList.add('btn-secondary');

                                // إعادة تعيين حالة الإرسال
                                isSubmitting = false;

                                // مسح آخر ملاحظة مرسلة بعد 30 ثانية
                                setTimeout(() => {
                                    lastSubmittedNote = '';
                                }, 30000);

                                // إعادة تحميل الصفحة بعد تأخير قصير
                                setTimeout(() => {
                                    location.reload();
                                }, 500);
                            } else {
                                // إعادة تفعيل الزر في حالة الخطأ
                                isSubmitting = false;
                                addNoteBtn.disabled = false;
                                addNoteBtn.innerHTML = '<i class="fas fa-plus me-1"></i>إضافة الملاحظة';

                                const errorMessage = data.error || 'حدث خطأ أثناء إضافة الملاحظة';
                                alert(errorMessage);
                            }
                        }).catch(() => {
                            // في حالة فشل تحليل JSON، نحاول كـ text
                            return response.text().then(text => {
                                if (response.ok) {
                                    // إغلاق الـ Modal
                                    const modal = bootstrap.Modal.getInstance(addNoteModal);
                                    modal.hide();

                                    // إعادة تعيين النموذج
                                    noteTextarea.value = '';
                                    addNoteBtn.disabled = true;
                                    addNoteBtn.innerHTML = '<i class="fas fa-plus me-1"></i>إضافة الملاحظة';
                                    addNoteBtn.classList.remove('btn-primary');
                                    addNoteBtn.classList.add('btn-secondary');

                                    // إعادة تعيين حالة الإرسال
                                    isSubmitting = false;

                                    // إعادة تحميل الصفحة بعد تأخير قصير
                                    setTimeout(() => {
                                        location.reload();
                                    }, 500);
                                } else {
                                    // إعادة تفعيل الزر في حالة الخطأ
                                    isSubmitting = false;
                                    addNoteBtn.disabled = false;
                                    addNoteBtn.innerHTML = '<i class="fas fa-plus me-1"></i>إضافة الملاحظة';
                                    alert('حدث خطأ أثناء إضافة الملاحظة');
                                }
                            });
                        });
                    }).catch(error => {
                        isSubmitting = false;
                        addNoteBtn.disabled = false;
                        addNoteBtn.innerHTML = '<i class="fas fa-plus me-1"></i>إضافة الملاحظة';
                        alert('حدث خطأ أثناء إضافة الملاحظة');
                    });

                    return false; // منع الإرسال العادي للنموذج
                }
            });

            // إزالة رسالة الخطأ عند الكتابة
            noteTextarea.addEventListener('input', function() {
                if (this.value.trim()) {
                    this.classList.remove('is-invalid');
                    noteError.style.display = 'none';
                }
            });
        }
    });
</script>

<style>
@keyframes shake {
    0%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
    20%, 40%, 60%, 80% { transform: translateX(5px); }
}

.shake {
    animation: shake 0.5s ease-in-out;
}

/* تحسينات إضافية للنموذج */
#noteForm textarea {
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
}

#noteForm textarea:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

#noteForm textarea.is-invalid {
    border-color: #dc3545;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
}

#addNoteBtn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

#addNoteBtn {
    transition: all 0.3s ease;
}

/* تحسينات لعرض ملاحظات الوصول عبر الفروع */
.note-item.cross-branch-note {
    background: linear-gradient(135deg, #e3f2fd 0%, #f8f9fa 100%);
    border-left: 4px solid #2196f3 !important;
    box-shadow: 0 2px 4px rgba(33, 150, 243, 0.1);
}

.notes-list .note-item {
    transition: all 0.3s ease;
}

.notes-list .note-item:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    transform: translateY(-2px);
}

/* تحسينات لسجل الوصول */
.access-log-item {
    transition: all 0.3s ease;
    border-left: 4px solid #dee2e6 !important;
}

.access-log-item:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    transform: translateY(-2px);
}

.access-log-item.cross-branch-access {
    background: linear-gradient(135deg, #fff3cd 0%, #fefefe 100%);
    border-left: 4px solid #ffc107 !important;
}

.access-logs-list .access-log-item:last-child {
    margin-bottom: 0 !important;
}

.alert-sm {
    padding: 0.5rem 0.75rem;
    font-size: 0.875rem;
}

/* تحسين عرض تنبيه الوصول عبر الفروع */
.cross-branch-customer-detail {
    border: 2px solid #ff9800;
    box-shadow: 0 4px 12px rgba(255, 152, 0, 0.2);
}
</style>

<!-- Add Note Modal -->
<div class="modal fade" id="addNoteModal" tabindex="-1" aria-labelledby="addNoteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addNoteModalLabel">
                    <i class="fas fa-sticky-note me-2"></i>إضافة ملاحظة جديدة
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{% url 'customers:add_note_by_code' customer.code %}" id="noteForm">
                <div class="modal-body">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="noteTextarea" class="form-label">الملاحظة</label>
                        <textarea class="form-control" id="noteTextarea" name="note" rows="4"
                                  placeholder="أضف ملاحظتك هنا..." required></textarea>
                        {% if note_form.note.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in note_form.note.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                        <div class="invalid-feedback" id="noteError" style="display: none;">
                            يرجى كتابة الملاحظة قبل الإضافة
                        </div>
                    </div>
                    <div class="text-muted small">
                        <i class="fas fa-info-circle me-1"></i>
                        ستتم إضافة الملاحظة باسم: {{ user.get_full_name|default:user.username }}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>إلغاء
                    </button>
                    <button type="submit" class="btn btn-primary" id="addNoteBtn" disabled>
                        <i class="fas fa-plus me-1"></i>إضافة الملاحظة
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}
