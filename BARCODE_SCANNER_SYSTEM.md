# نظام فحص الباركود - دليل شامل

## نظرة عامة

تم إضافة نظام فحص باركود متكامل إلى الصفحة الرئيسية للتطبيق، يتيح للمستخدمين فحص المنتجات بسرعة وسهولة باستخدام الكاميرا أو الإدخال اليدوي.

## المميزات الرئيسية

### 1. زر فحص الباركود العائم
- زر دائري لطيف يظهر في أسفل يمين الصفحة
- تصميم عصري بتدرج لوني جذاب (بنفسجي إلى بنفسجي غامق)
- تأثيرات حركية عند التمرير (Hover)
- أيقونة باركود واضحة

### 2. نافذة الفحص المنبثقة
- نافذة منبثقة بتصميم حديث ومريح للعين
- خلفية داكنة شفافة للتركيز
- إمكانية الإغلاق بالضغط على زر × أو خارج النافذة

### 3. طرق الفحص المتعددة

#### أ) الفحص بالكاميرا
- استخدام مكتبة Html5-QRCode الحديثة
- تشغيل كاميرا الجهاز (خلفية أو أمامية)
- فحص QR Code و Barcode 1D
- واجهة مرئية للفحص مع إطار توجيهي
- إيقاف/تشغيل الكاميرا بسهولة

#### ب) الإدخال اليدوي
- حقل إدخال نصي لكتابة كود المنتج
- البحث بالضغط على زر البحث أو Enter
- مفيد عند عدم توفر كاميرا أو صعوبة الفحص

### 4. بطاقة عرض المنتج الذكية

عند العثور على المنتج، يتم عرض بطاقة جميلة تحتوي على:

#### المعلومات الأساسية
- **اسم المنتج**: عنوان واضح مع أيقونة
- **الكود**: رمز المنتج الفريد
- **السعر**: مع رمز العملة
- **الفئة**: تصنيف المنتج
- **الوحدة**: وحدة القياس (قطعة، كيلو، متر، إلخ)

#### معلومات المخزون
- **الكمية المتوفرة**: العدد الإجمالي في جميع المستودعات
- **حالة المخزون**: 
  - 🟢 متوفر (أخضر)
  - 🟡 مخزون منخفض (برتقالي)
  - 🔴 نفذ من المخزون (أحمر)

#### المخزون حسب المستودع
- عرض قائمة بالمستودعات التي تحتوي على المنتج
- الكمية المتوفرة في كل مستودع
- تاريخ آخر تحديث

#### الوصف
- وصف تفصيلي للمنتج (إذا كان متوفراً)

### 5. وظائف إضافية

#### زر "إضافة إلى الطلب"
- إضافة المنتج مباشرة إلى سلة الطلبات
- حفظ البيانات في localStorage
- زيادة الكمية تلقائياً عند الإضافة المتكررة
- رسالة تأكيد بعد الإضافة

#### رابط التفاصيل الكاملة
- زر للانتقال إلى صفحة المنتج الكاملة
- عرض السجل التاريخي والتقارير

## البنية التقنية

### الملفات المعدلة

#### 1. `templates/home.html`
تم إضافة:
- أنماط CSS للواجهة
- هيكل HTML للزر والنافذة المنبثقة
- سكريبت JavaScript للتفاعل

#### 2. `inventory/views.py`
تم إضافة:
```python
@login_required
def barcode_scan_api(request):
    """
    API لفحص الباركود والحصول على معلومات المنتج
    """
```

#### 3. `inventory/urls.py`
تم إضافة المسار:
```python
path('api/barcode-scan/', views.barcode_scan_api, name='barcode_scan_api'),
```

### المكتبات المستخدمة

1. **Html5-QRCode v2.3.8**
   - مكتبة JavaScript حديثة لفحص QR Code و Barcode
   - تدعم جميع المتصفحات الحديثة
   - لا تحتاج إلى jQuery

## آلية العمل

### 1. فتح نافذة الفحص
```javascript
openScannerBtn.addEventListener('click', function() {
    scannerModal.classList.add('active');
    manualBarcodeInput.focus();
});
```

### 2. تشغيل الكاميرا
```javascript
html5QrCode.start(
    { facingMode: "environment" },  // استخدام الكاميرا الخلفية
    config,
    (decodedText) => {
        searchProduct(decodedText);  // البحث عن المنتج
    }
);
```

### 3. البحث عن المنتج
```javascript
fetch(`/inventory/api/barcode-scan/?barcode=${barcode}`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayProduct(data.product);
        }
    });
```

### 4. استجابة API
```json
{
    "success": true,
    "product": {
        "id": 123,
        "name": "اسم المنتج",
        "code": "P-12345678",
        "price": 100.00,
        "currency_symbol": "ج.م",
        "current_stock": 50,
        "stock_status": "متوفر",
        "warehouses": [
            {
                "warehouse_name": "المستودع الرئيسي",
                "stock": 30
            }
        ]
    }
}
```

## ربط المخازن

### الربط الكامل مع نظام المخازن

النظام مرتبط بالكامل مع:

1. **نماذج المخزون**
   - `Product`: جلب معلومات المنتج
   - `Warehouse`: المستودعات النشطة
   - `StockTransaction`: حساب المخزون الحالي

2. **حساب المخزون**
```python
# الحصول على المخزون من جميع المستودعات
current_stock = product.current_stock

# الحصول على المخزون لكل مستودع
for warehouse in warehouses:
    last_transaction = StockTransaction.objects.filter(
        product=product,
        warehouse=warehouse
    ).order_by('-transaction_date', '-id').first()
```

3. **التحديث التلقائي**
   - المخزون يُحدث من آخر حركة في كل مستودع
   - استخدام `running_balance` لحساب دقيق

## الأرضية للطلبات

### نظام السلة (Cart) في localStorage

تم تهيئة نظام بسيط لحفظ المنتجات:

```javascript
function addToOrder(productId, productName, productPrice) {
    let cart = JSON.parse(localStorage.getItem('cart') || '[]');
    
    const existingItem = cart.find(item => item.id === productId);
    if (existingItem) {
        existingItem.quantity += 1;
    } else {
        cart.push({
            id: productId,
            name: productName,
            price: productPrice,
            quantity: 1
        });
    }
    
    localStorage.setItem('cart', JSON.stringify(cart));
}
```

### التكامل المستقبلي

يمكن تطوير هذا ليرتبط مع:
- نظام الطلبات الحالي (`orders` app)
- إنشاء طلب جديد مباشرة
- إضافة المنتجات إلى طلب قائم

## الاستخدام

### للمستخدم النهائي

1. **افتح التطبيق** على الصفحة الرئيسية
2. **اضغط على الزر العائم** (أيقونة الباركود) في الزاوية السفلى اليمنى
3. **اختر طريقة الفحص**:
   - **بالكاميرا**: اضغط "تشغيل الكاميرا" ووجه الكاميرا نحو الباركود
   - **يدوياً**: اكتب كود المنتج في الحقل واضغط Enter أو "بحث"
4. **شاهد معلومات المنتج** في بطاقة جميلة
5. **أضف إلى الطلب** إذا أردت
6. **اطلع على التفاصيل الكاملة** بالضغط على الرابط

### للمطورين

#### إضافة منتج جديد
تأكد من:
- وجود `code` فريد لكل منتج (هذا هو الباركود)
- إدخال المنتج في المخزون
- تحديد مستودع واحد على الأقل

#### تخصيص التصميم
- الأنماط موجودة في `{% block extra_css %}`
- يمكن تعديل الألوان والأحجام بسهولة
- استخدام متغيرات CSS مستقبلاً للتخصيص

## المتطلبات

### المتصفح
- متصفح حديث يدعم:
  - Camera API (getUserMedia)
  - ES6 JavaScript
  - Fetch API

### الأذونات
- إذن الوصول إلى الكاميرا (Camera Permission)

### الخادم
- Django مع inventory app
- قاعدة بيانات تحتوي على:
  - Products
  - Warehouses
  - StockTransactions

## معالجة الأخطاء

### رسائل الخطأ

1. **المنتج غير موجود**
```
❌ المنتج غير موجود
لا يوجد منتج بكود الباركود: XYZ
```

2. **خطأ في الكاميرا**
```
⚠️ فشل تشغيل الكاميرا
يرجى التأكد من منح الأذونات اللازمة
```

3. **خطأ في الاتصال**
```
❌ حدث خطأ في الاتصال
```

## التحسينات المستقبلية المقترحة

### قصيرة المدى
1. ✅ إضافة صوت تنبيه عند الفحص الناجح
2. ✅ حفظ تاريخ عمليات الفحص
3. ✅ إضافة فلتر للمنتجات المفحوصة مؤخراً

### متوسطة المدى
1. 📊 تقارير عن المنتجات الأكثر فحصاً
2. 🔄 مزامنة السلة مع الخادم
3. 📱 تطبيق موبايل مخصص

### طويلة المدى
1. 🤖 الذكاء الاصطناعي للتعرف على المنتجات من الصور
2. 🌐 دعم فحص باركود متعدد في وقت واحد
3. 📦 ربط مباشر مع نظام ERP

## استكشاف الأخطاء

### الكاميرا لا تعمل
1. تأكد من منح أذونات الكاميرا للمتصفح
2. تحقق من أن الكاميرا ليست قيد الاستخدام من تطبيق آخر
3. جرب متصفح مختلف
4. استخدم الإدخال اليدوي كبديل

### المنتج لا يظهر
1. تأكد من وجود المنتج في قاعدة البيانات
2. تحقق من أن `code` المنتج صحيح
3. تأكد من أن المستخدم لديه صلاحيات العرض

### البطاقة لا تظهر بشكل صحيح
1. تحقق من console المتصفح للأخطاء
2. تأكد من تحميل جميع الأنماط CSS
3. تحقق من حجم الشاشة (responsive design)

## الأمان

### الاعتبارات الأمنية

1. **التحقق من الصلاحيات**
   - `@login_required` على جميع API endpoints
   - التحقق من أذونات المستخدم

2. **تنظيف المدخلات**
   - استخدام `.strip()` و `encodeURIComponent()`
   - التحقق من صحة البيانات

3. **معالجة الأخطاء**
   - عدم كشف معلومات حساسة في رسائل الخطأ
   - تسجيل الأخطاء في logs

## الأداء

### التحسينات المطبقة

1. **استعلامات قاعدة البيانات**
   - استخدام `select_related()` لتقليل الاستعلامات
   - حساب المخزون من `running_balance` بدلاً من SUM

2. **التخزين المؤقت**
   - يمكن إضافة caching للمنتجات الشائعة مستقبلاً

3. **تحميل الأصول**
   - تحميل مكتبة Html5-QRCode من CDN
   - تحميل lazy للفيديو

## الخلاصة

نظام فحص الباركود المتكامل يوفر:
- ✅ واجهة مستخدم جميلة وسهلة
- ✅ ربط كامل مع نظام المخازن
- ✅ دعم طرق فحص متعددة
- ✅ عرض معلومات شاملة
- ✅ أرضية للطلبات المستقبلية
- ✅ تصميم responsive يعمل على جميع الأجهزة

---

**تم التنفيذ بنجاح في:** {{ التاريخ الحالي }}

**المطور:** Factory AI Assistant

**الإصدار:** 1.0.0
