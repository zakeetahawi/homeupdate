# إصلاح مشكلة عدم ظهور أوامر التقطيع المكتملة لموظفي المستودع

## المشكلة

المستخدم **bafli** (موظف مستودع) عند الدخول على صفحة أوامر التقطيع:
- URL: `http://0.0.0.0:8001/cutting/orders/warehouse/3/`
- **لا تظهر** أوامر التقطيع المكتملة حتى عند اختيار فلتر "مكتمل"

## السبب

في `CuttingOrderListView` (ملف `cutting/views.py`)، كان هناك كود يستبعد **جميع** الأوامر المكتملة لموظفي المستودع **بشكل دائم**، حتى لو اختار المستخدم فلتر الحالة "مكتمل":

```python
# الكود القديم (المشكلة)
# لموظفي المستودع: عرض الطلبات غير المكتملة فقط
user = self.request.user
if hasattr(user, 'is_warehouse_staff') and user.is_warehouse_staff:
    queryset = queryset.exclude(status='completed')  # ❌ يستبعد دائماً!

# فلترة حسب الحالة
status = self.request.GET.get('status')
if status:
    queryset = queryset.filter(status=status)  # ⚠️ لا يعمل لأن الأوامر المكتملة مستبعدة مسبقاً!
```

## الحل

تم تعديل الكود بحيث:
1. **إذا اختار المستخدم فلتر حالة معين** → يتم عرض الأوامر حسب الحالة المختارة (بما في ذلك "مكتمل")
2. **إذا لم يختر المستخدم أي فلتر** → يتم استبعاد الأوامر المكتملة تلقائياً (السلوك الافتراضي)

```python
# الكود الجديد (الحل)
# البحث
search = self.request.GET.get('search')
if search:
    queryset = queryset.filter(
        Q(cutting_code__icontains=search) |
        Q(order__contract_number__icontains=search) |
        Q(order__customer__name__icontains=search) |
        Q(order__customer__phone__icontains=search)
    )

# فلترة حسب الحالة
status = self.request.GET.get('status')
if status:
    queryset = queryset.filter(status=status)  # ✅ يعمل بشكل صحيح
else:
    # لموظفي المستودع: عرض الطلبات غير المكتملة فقط (إذا لم يتم تحديد حالة معينة)
    user = self.request.user
    if hasattr(user, 'is_warehouse_staff') and user.is_warehouse_staff:
        queryset = queryset.exclude(status='completed')  # ✅ يستبعد فقط عند عدم وجود فلتر
```

## التغييرات

### الملف: `cutting/views.py`

**السطور المعدلة:** 120-138

**التغيير:**
- تم نقل فلتر استبعاد الأوامر المكتملة إلى **بعد** فلتر الحالة
- تم إضافة شرط `else` بحيث يتم استبعاد الأوامر المكتملة **فقط** إذا لم يتم تحديد حالة معينة

## النتيجة

### قبل الإصلاح ❌

| الحالة | النتيجة |
|--------|---------|
| بدون فلتر | 0 أمر (لا تظهر الأوامر المكتملة) |
| فلتر "مكتمل" | 0 أمر (لا تظهر حتى مع الفلتر!) |
| فلتر "قيد الانتظار" | 0 أمر |

### بعد الإصلاح ✅

| الحالة | النتيجة |
|--------|---------|
| بدون فلتر | 0 أمر (لا تظهر الأوامر المكتملة - السلوك الافتراضي) |
| فلتر "مكتمل" | 22 أمر (تظهر جميع الأوامر المكتملة!) ✅ |
| فلتر "قيد الانتظار" | 0 أمر (لا توجد أوامر قيد الانتظار) |

## كيفية الاستخدام

### للمستخدم bafli (موظف مستودع):

1. **لعرض الأوامر المكتملة:**
   - افتح الرابط: `http://0.0.0.0:8001/cutting/orders/warehouse/3/`
   - اختر من قائمة "الحالة" → **"مكتمل"**
   - اضغط على زر "بحث"
   - ستظهر جميع الأوامر المكتملة (22 أمر)

2. **لعرض الأوامر غير المكتملة (الافتراضي):**
   - افتح الرابط: `http://0.0.0.0:8001/cutting/orders/warehouse/3/`
   - لا تختر أي فلتر حالة (اترك "جميع الحالات")
   - ستظهر فقط الأوامر غير المكتملة

3. **لعرض أوامر حالة معينة:**
   - اختر الحالة المطلوبة من القائمة المنسدلة
   - اضغط على زر "بحث"

## الملفات المعدلة

1. `cutting/views.py` - تعديل `CuttingOrderListView.get_queryset()`
2. `cutting/views.py` - تعديل `get_user_warehouses()` في عدة Views لإصلاح مشكلة المستودعات

## الاختبار

تم اختبار الإصلاح باستخدام السكريبتات التالية:
- `check_bafli_user.py` - للتحقق من معلومات المستخدم
- `test_completed_orders_query.py` - لاختبار استعلام الأوامر المكتملة
- `debug_completed_orders_view.py` - لمحاكاة CompletedCuttingOrdersView
- `test_fixed_view.py` - لاختبار الإصلاح النهائي

## ملاحظات

- هذا الإصلاح يؤثر فقط على صفحة `CuttingOrderListView` (أوامر التقطيع النشطة)
- صفحة `CompletedCuttingOrdersView` (أوامر التقطيع المجمعة) تعمل بشكل صحيح ولم تحتاج إلى تعديل
- السلوك الافتراضي لموظفي المستودع هو عدم عرض الأوامر المكتملة (لتقليل الفوضى)
- يمكن لموظفي المستودع عرض الأوامر المكتملة عند الحاجة باختيار فلتر "مكتمل"

## التاريخ

- **التاريخ:** 2025-10-15
- **المطور:** Augment Agent
- **المشكلة:** عدم ظهور أوامر التقطيع المكتملة لموظفي المستودع
- **الحل:** تعديل ترتيب الفلاتر في `CuttingOrderListView.get_queryset()`

