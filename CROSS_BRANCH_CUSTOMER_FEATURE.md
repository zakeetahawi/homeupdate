# ميزة البحث عن العملاء عبر الفروع وإنشاء الطلبات

## نظرة عامة
تم تطوير ميزة جديدة تسمح للمستخدمين بالبحث عن العملاء من فروع أخرى باستخدام رقم الهاتف، مع إمكانية عرض بطاقة العميل وإنشاء طلبات مرتبطة بفرع المستخدم الحالي.

## الميزات الجديدة

### 1. البحث المحسن برقم الهاتف
- **البحث التلقائي**: عند كتابة رقم هاتف في حقل البحث، يتم البحث تلقائياً في جميع الفروع
- **البحث المرن**: يدعم أرقام الهاتف بصيغ مختلفة (+20, 01, مع مسافات أو شرطات)
- **البحث في الهاتف الثاني**: يبحث في كل من رقم الهاتف الأساسي والثاني
- **نتائج فورية**: عرض النتائج أثناء الكتابة مع مؤشر التحميل

### 2. المؤشرات البصرية
- **تمييز العملاء من فروع أخرى**: خلفية صفراء وبادج "فرع آخر"
- **معلومات الفرع**: عرض اسم فرع العميل الأصلي
- **تنبيهات واضحة**: رسائل تنبيه في صفحة تفاصيل العميل

### 3. الصلاحيات المحدودة
- **عرض فقط**: يمكن عرض بيانات العملاء من فروع أخرى
- **منع التعديل**: لا يمكن تعديل أو حذف عملاء من فروع أخرى
- **إنشاء الطلبات**: يمكن إنشاء طلبات للعملاء من فروع أخرى مرتبطة بفرع المستخدم

### 4. تسجيل النشاط
- **ملاحظات تلقائية**: تسجيل ملاحظة عند الوصول لعميل من فرع آخر
- **تتبع المستخدم**: تسجيل اسم المستخدم والفرع الذي وصل للعميل

## التحديثات التقنية

### 1. ملف الصلاحيات (`customers/permissions.py`)
```python
# دوال جديدة
def can_user_create_order_for_customer(user, customer)
def can_user_access_cross_branch_customer(user, customer)

# تحسين البحث في get_user_customers_queryset
# دعم البحث برقم الهاتف عبر جميع الفروع
```

### 2. العروض (`customers/views.py`)
```python
# تحسين find_customer_by_phone
# دعم البحث المتعدد والمرن
# إرجاع معلومات الصلاحيات لكل عميل

# تحسين customer_detail
# دعم العملاء من فروع أخرى
# إضافة ملاحظات تلقائية
```

### 3. القوالب
- **قائمة العملاء**: مؤشرات بصرية وأزرار مخصصة
- **تفاصيل العميل**: تنبيهات وقيود على الأزرار
- **JavaScript**: بحث تلقائي ونتائج فورية

### 4. المسارات (`customers/urls.py`)
```python
# مسار جديد للبحث المحسن
path('api/find-by-phone/', views.find_customer_by_phone, name='find_customer_by_phone')
```

## كيفية الاستخدام

### للمستخدمين
1. **البحث برقم الهاتف**:
   - اكتب رقم الهاتف في حقل البحث
   - ستظهر النتائج تلقائياً أثناء الكتابة
   - العملاء من فروع أخرى مميزون بلون أصفر

2. **عرض بطاقة العميل**:
   - انقر على "عرض" لرؤية تفاصيل العميل
   - ستظهر رسالة تنبيه إذا كان من فرع آخر
   - يمكن إضافة ملاحظات للعميل

3. **إنشاء طلب**:
   - انقر على "إنشاء طلب" أو الزر الأخضر
   - الطلب سيكون مرتبط بفرعك وليس فرع العميل
   - يمكن إنشاء جميع أنواع الطلبات

### للمطورين
1. **إضافة صلاحيات جديدة**:
```python
from customers.permissions import can_user_create_order_for_customer

if can_user_create_order_for_customer(request.user, customer):
    # السماح بإنشاء الطلب
```

2. **التحقق من العملاء عبر الفروع**:
```python
from customers.permissions import can_user_access_cross_branch_customer

is_cross_branch = can_user_access_cross_branch_customer(request.user, customer)
```

## الأمان والصلاحيات

### مستويات الوصول
- **المدير العام**: وصول كامل لجميع العملاء
- **مدير المنطقة**: وصول للفروع المُدارة فقط
- **مدير الفرع**: وصول لفرعه + عرض العملاء من فروع أخرى
- **البائع**: وصول لفرعه + عرض العملاء من فروع أخرى
- **فني المعاينة**: عرض فقط لفرعه

### القيود الأمنية
- لا يمكن تعديل بيانات عملاء من فروع أخرى
- لا يمكن حذف عملاء من فروع أخرى
- الطلبات المنشأة ترتبط بفرع المستخدم وليس فرع العميل
- تسجيل جميع عمليات الوصول للعملاء من فروع أخرى

## الاختبار

### سيناريوهات الاختبار
1. **البحث برقم هاتف موجود في نفس الفرع**
2. **البحث برقم هاتف موجود في فرع آخر**
3. **البحث برقم هاتف غير موجود**
4. **إنشاء طلب لعميل من فرع آخر**
5. **محاولة تعديل عميل من فرع آخر**
6. **عرض ملاحظات العميل من فرع آخر**

### بيانات الاختبار
```python
# إنشاء عملاء في فروع مختلفة
customer1 = Customer.objects.create(
    name="أحمد محمد",
    phone="01234567890",
    branch=branch_cairo
)

customer2 = Customer.objects.create(
    name="فاطمة علي", 
    phone="01987654321",
    branch=branch_alexandria
)
```

## المشاكل المحتملة والحلول

### 1. الأداء
- **المشكلة**: البحث في جميع ��لفروع قد يكون بطيء
- **الحل**: استخدام فهارس قاعدة البيانات وتحسين الاستعلامات

### 2. الصلاحيات
- **المشكلة**: تعقيد نظام الصلاحيات
- **الحل**: دوال واضحة ومنفصلة لكل نوع صلاحية

### 3. تجربة المستخدم
- **المشكلة**: الخلط بين العملاء من فروع مختلفة
- **الحل**: مؤشرات بصرية واضحة ورسائل تنبيه

## التطوير المستقبلي

### ميزات مقترحة
1. **إحصائيات الوصول عبر الفروع**
2. **تقارير العملاء المشتركين**
3. **إشعارات للفروع عند إنشاء طلبات لعملائهم**
4. **نظام موافقات للطلبات عبر الفروع**

### تحسينات تقنية
1. **تخزين مؤقت للبحث**
2. **فهرسة أفضل لأرقام الهاتف**
3. **API منفصل للبحث عبر الفروع**
4. **تحسين واجهة المستخدم**

## الخلاصة
تم تطوير ميزة شاملة تسمح بالبحث عن العملاء عبر الفروع مع الحفاظ على الأمان والصلاحيات. الميزة تحسن من تجربة المستخدم وتزيد من كفاءة العمل مع الحفاظ على سلامة البيانات.