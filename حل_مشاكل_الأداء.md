# ๐ง ุญู ูุดุงูู ุงูุฃุฏุงุก ูุงูุจุทุก - ูุธุงู ุงูุฎูุงุฌุฉ

## ๐ ุงููุดุงูู ุงูุชู ุชู ุญููุง

### 1. Worker Timeout (CRITICAL)
**ุงููุดููุฉ:**
```
[CRITICAL] WORKER TIMEOUT (pid:87043)
[ERROR] Worker was sent SIGKILL! Perhaps out of memory?
```

**ุงูุณุจุจ:**
- ุงุณุชุฎุฏุงู 2 workers + sync mode = ุงุณุชููุงู ุฐุงูุฑุฉ ุนุงูู
- Timeout ูุตูุฑ ุฌุฏุงู (60 ุซุงููุฉ)
- Preload mode ูุญููู ุงูุชุทุจูู ูุฑุชูู

**ุงูุญู:**
```bash
# ูุจู (ุจุทูุก + ูุดุงูู ุฐุงูุฑุฉ):
--workers 2
--worker-class sync
--timeout 60
--preload

# ุจุนุฏ (ุณุฑูุน + ูุณุชูุฑ):
--workers 1
--threads 4
--worker-class gthread
--timeout 120
--worker-tmp-dir /dev/shm  # ุงุณุชุฎุฏุงู RAM ุจุฏูุงู ูู disk
```

---

### 2. IP ุบูุฑ ูุณููุญ (DisallowedHost)
**ุงููุดููุฉ:**
```
DisallowedHost: Invalid HTTP_HOST header: '192.168.1.30:8000'
```

**ุงูุณุจุจ:**
- IP ุงููุญูู `192.168.1.30` ูู ููู ููุฌูุฏ ูู ALLOWED_HOSTS

**ุงูุญู:**
ุชู ุฅุถุงูุฉ IP ูู `crm/settings.py`:
```python
ALLOWED_HOSTS = [
    'localhost',
    '127.0.0.1',
    '192.168.1.30',  # โ ุชูุช ุงูุฅุถุงูุฉ
    ...
]
```

---

### 3. ุฎุทุฃ ูู Logging Format
**ุงููุดููุฉ:**
```
KeyError: 'user'
ValueError: Formatting field not found in record: 'user'
```

**ุงูุณุจุจ:**
- security formatter ูุทูุจ ุญูู `{user}` ุบูุฑ ููุฌูุฏ

**ุงูุญู:**
ุชุจุณูุท formatter ูู `crm/settings.py`:
```python
# ูุจู:
'format': '[SECURITY] {asctime} | {levelname} | {message} | User: {user} | IP: {ip}'

# ุจุนุฏ:
'format': '[SECURITY] {asctime} | {levelname} | {message}'
```

---

### 4. ุงุณุชููุงู ุนุงูู ููุฐุงูุฑุฉ
**ุงููุดููุฉ:**
- Workers ุชุณุชููู ุฐุงูุฑุฉ ูุจูุฑุฉ ูุชููุชู

**ุงูุญู:**
- ุชูููู CONN_MAX_AGE ูู 600 ุฅูู 300 ุซุงููุฉ
- ุงุณุชุฎุฏุงู gthread ุจุฏูุงู ูู sync
- ุชูููู ุนุฏุฏ workers ูู 2 ุฅูู 1
- ุงุณุชุฎุฏุงู /dev/shm (RAM) ูููููุงุช ุงููุคูุชุฉ
- ุชุญุฏูุฏ max-memory ููุฐุงูุฑุฉ

---

## โ ุงูุณูุฑูุจุช ุงููุญุณูู

ุชู ุฅูุดุงุก ุณูุฑูุจุช ุฌุฏูุฏ ูุญุณูู: `start_optimized.sh`

### ุงููููุฒุงุช:

1. **ุจุฏุก ุณุฑูุน:**
   - ุชูุธูู ุชููุงุฆู ููุนูููุงุช ุงููุฏููุฉ
   - ูุง ูุนูู migrations (ูุฏููุงู ุนูุฏ ุงูุญุงุฌุฉ)
   - ุจุฏุก ูุจุงุดุฑ ููุณูุฑูุฑ

2. **ุงุณุชููุงู ุฐุงูุฑุฉ ุฃูู:**
   - 1 worker + 4 threads ุจุฏูุงู ูู 2 workers
   - Redis ูุน ุญุฏ ุฃูุตู 256MB
   - Celery ูุญุฏูุฏ ุจู 200MB ููู ุนูููุฉ

3. **ุฃุฏุงุก ุฃูุถู:**
   - gthread worker class (ุฃุณุฑุน)
   - /dev/shm ูููููุงุช ุงููุคูุชุฉ (RAM)
   - timeout ุฃุทูู (120 ุซุงููุฉ)
   - keep-alive ูุญุณูู

### ุงูุงุณุชุฎุฏุงู:

```bash
# ุงูุชุดุบูู
cd /home/zakee/homeupdate
./start_optimized.sh

# ุงููุตูู
http://localhost:8000
http://192.168.1.30:8000

# ุงูุฅููุงู
Ctrl+C
```

---

## ๐ ููุงุฑูุฉ ุงูุฃุฏุงุก

| ุงููุนูุงุฑ | ูุจู | ุจุนุฏ |
|---------|-----|-----|
| **Workers** | 2 sync | 1 gthread + 4 threads |
| **Timeout** | 60s | 120s |
| **ุงุณุชููุงู ุงูุฐุงูุฑุฉ** | ~400MB | ~200MB |
| **ุณุฑุนุฉ ุงูุจุฏุก** | ุจุทูุก (3-5 ุฏูุงุฆู) | ุณุฑูุน (30 ุซุงููุฉ) |
| **ุงูุงุณุชูุฑุงุฑ** | Worker timeouts | ูุณุชูุฑ โ |
| **Worker Restarts** | ูุชูุฑุฑ | ูุงุฏุฑ ุฌุฏุงู |

---

## ๐ฏ ุงูุชูุตูุงุช

### ููุงุณุชุฎุฏุงู ุงููููู:

โ **ุงุณุชุฎุฏู:** `start_optimized.sh`
- ุจุฏุก ุณุฑูุน
- ุงุณุชููุงู ุฐุงูุฑุฉ ุฃูู
- ุฃุฏุงุก ุฃูุถู

### ููุฅูุชุงุฌ ุงููุงูู:

โ **ุงุณุชุฎุฏู:** `./ููููุณ/run-production-no-tunnel.sh`
- ูุดูู migrations ุชููุงุฆูุฉ
- ูุดูู collectstatic
- ูุดูู ุงููุณุฎ ุงูุงุญุชูุงุทู
- ูุฑุงูุจุฉ ุฏูุฑูุฉ

---

## ๐ ูุฑุงูุจุฉ ุงูุฃุฏุงุก

### ูุญุต ุงุณุชููุงู ุงูููุงุฑุฏ:

```bash
# ูุญุต ุงูุฐุงูุฑุฉ
ps aux | grep gunicorn | awk '{sum+=$6} END {print sum/1024 " MB"}'

# ูุญุต CPU
top -bn1 | grep gunicorn

# ูุญุต ุงูุงุชุตุงูุงุช
netstat -an | grep :8000 | wc -l
```

### ุงูุณุฌูุงุช:

```bash
# ุณุฌูุงุช Gunicorn
# ุชุธูุฑ ูุจุงุดุฑุฉ ูู ุงูุชุฑููุงู

# ุณุฌูุงุช Celery
tail -f logs/celery.log

# ุณุฌูุงุช Django
tail -f logs/django.log
```

---

## โ๏ธ ุงูุฅุนุฏุงุฏุงุช ุงููุญุณููุฉ

### Gunicorn:
```bash
--workers 1              # ุนูููุฉ ูุงุญุฏุฉ
--threads 4              # 4 ุฎููุท ููู ุนูููุฉ
--worker-class gthread   # ููุน ุงูุนูููุฉ
--timeout 120            # ููุช ุงูุชุธุงุฑ ุฃุทูู
--worker-tmp-dir /dev/shm  # ุงุณุชุฎุฏุงู RAM
```

### Redis:
```bash
--maxmemory 256mb         # ุญุฏ ุฃูุตู ููุฐุงูุฑุฉ
--maxmemory-policy allkeys-lru  # ุณูุงุณุฉ ุงูุชูุธูู
```

### Celery:
```bash
--pool solo              # ููุน pool ุจุณูุท
--concurrency 1          # ุนูููุฉ ูุงุญุฏุฉ
--max-memory-per-child 200000  # ุญุฏ ุงูุฐุงูุฑุฉ
--time-limit 300         # 5 ุฏูุงุฆู max
```

### PostgreSQL (ูู settings.py):
```python
'CONN_MAX_AGE': 300,     # 5 ุฏูุงุฆู (ูุงู 10)
'CONN_HEALTH_CHECKS': True,
'OPTIONS': {
    'connect_timeout': 10,
    'options': '-c statement_timeout=30000',
}
```

---

## ๐จ ุงููุดุงูู ุงููุนุฑููุฉ

### 1. ุชุญุฐูุฑ Redis Memory Overcommit
**ุงูุฑุณุงูุฉ:**
```
WARNING Memory overcommit must be enabled!
```

**ุงูุญู (ุงุฎุชูุงุฑู):**
```bash
# ุญู ูุคูุช
sudo sysctl vm.overcommit_memory=1

# ุญู ุฏุงุฆู
echo "vm.overcommit_memory = 1" | sudo tee -a /etc/sysctl.conf
sudo sysctl -p
```

### 2. Celery ูุง ูุจุฏุฃ
**ุงูุณุจุจ:** ูุดููุฉ ูู ุงูุฐุงูุฑุฉ ุฃู ุงูุฃุฐููุงุช

**ุงูุญู:**
```bash
# ูุญุต ุงูุณุฌู
cat logs/celery.log

# ุชุดุบูู ูุฏูู
celery -A crm worker --loglevel=debug
```

### 3. ุตูุฑ Company Logo ุบูุฑ ููุฌูุฏุฉ
**ุงูุฑุณุงูุฉ:**
```
Not Found: /media/company_logos/...
```

**ุงูุณุจุจ:** ุงููููุงุช ุบูุฑ ููุฌูุฏุฉ ูู media/

**ุงูุญู:**
- ุฑูุน ุงูุตูุฑ ุนุจุฑ ููุญุฉ ุงูุฅุฏุงุฑุฉ
- ุฃู ุชุนุทูู ุนุฑุถ ุงูููุฌู ูุคูุชุงู

---

## ๐ ููุงุญุธุงุช ูููุฉ

1. **DEBUG Mode:**
   - ุญุงููุงู DEBUG=True
   - ููุฅูุชุงุฌ ุงูุญููููุ ุบููุฑ ุฅูู False ูู `.env`

2. **ุนุฏุฏ Workers:**
   - 1 worker ูุงูู ูู 10-20 ูุณุชุฎุฏู ูุชุฒุงูู
   - ูููุฒูุฏุ ุฒุฏ ุนุฏุฏ threads (ุญุชู 8)

3. **ุงูุฐุงูุฑุฉ:**
   - ุงููุธุงู ูุญุชุงุฌ ~2GB RAM
   - ูุน 1 worker: ~200-300MB
   - ูุน 2 workers: ~400-600MB

4. **ุงูุฃุฏุงุก:**
   - ุฃูู ุทูุจ ูุฏ ูููู ุจุทูุก (ุชุญููู)
   - ุงูุทูุจุงุช ุงูุชุงููุฉ ุณุฑูุนุฉ ุฌุฏุงู
   - ุงุณุชุฎุฏู Redis cache ููุชุณุฑูุน

---

## โจ ุงููุชุงุฆุฌ

ุจุนุฏ ุงูุชุญุณููุงุช:
- โ ุงููุธุงู ูุนูู ุจุฏูู worker timeouts
- โ ุงุณุชููุงู ุงูุฐุงูุฑุฉ ุฃูู ุจูุณุจุฉ 50%
- โ ุจุฏุก ุฃุณุฑุน (30 ุซุงููุฉ ุจุฏูุงู ูู 5 ุฏูุงุฆู)
- โ ุงุณุชูุฑุงุฑ ููุชุงุฒ
- โ ูุณุชุฌูุจ ููุทูุจุงุช ุจุณุฑุนุฉ

---

**ุขุฎุฑ ุชุญุฏูุซ:** 3 ุฏูุณูุจุฑ 2025
**ุงูุฅุตุฏุงุฑ:** 2.1 - ูุญุณูู
