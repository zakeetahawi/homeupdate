# نظام تتبع أخطاء رفع المنتجات بالجملة

## نظرة عامة

تم إضافة نظام شامل لتتبع وتسجيل جميع أخطاء عمليات رفع المنتجات بالجملة، مما يتيح:

- **تسجيل تلقائي** لجميع عمليات الرفع الجماعي
- **حفظ الأخطاء** في قاعدة البيانات مع تفاصيل كاملة
- **تقارير مفصلة** لكل عملية رفع مع إحصائيات دقيقة
- **تصنيف الأخطاء** حسب النوع لسهولة التحليل
- **عرض البيانات** التي فشلت في الرفع لتسهيل التصحيح

## النماذج (Models)

### 1. BulkUploadLog

نموذج لتسجيل كل عملية رفع جماعي:

**الحقول الأساسية:**
- `upload_type`: نوع العملية (رفع منتجات / تحديث مخزون)
- `status`: حالة العملية (قيد المعالجة / مكتمل / مكتمل مع أخطاء / فشل)
- `file_name`: اسم الملف المرفوع
- `warehouse`: المستودع المرتبط بالعملية

**إحصائيات:**
- `total_rows`: إجمالي عدد الصفوف في الملف
- `processed_count`: عدد الصفوف المعالجة بنجاح
- `created_count`: عدد المنتجات المُنشأة
- `updated_count`: عدد المنتجات المحدثة
- `error_count`: عدد الأخطاء

**معلومات إضافية:**
- `options`: خيارات العملية (JSON)
- `created_warehouses`: قائمة المستودعات المُنشأة تلقائياً (JSON)
- `summary`: ملخص نصي للعملية
- `created_at`: تاريخ بدء العملية
- `completed_at`: تاريخ إكمال العملية
- `created_by`: المستخدم المنفذ للعملية

**خصائص محسوبة:**
- `duration`: مدة العملية بالثواني
- `success_rate`: نسبة نجاح العملية (%)
- `has_errors`: هل توجد أخطاء

**وظائف:**
- `complete(summary)`: إكمال العملية بنجاح
- `fail(error_message)`: تسجيل فشل العملية

### 2. BulkUploadError

نموذج لتسجيل كل خطأ يحدث أثناء الرفع:

**الحقول:**
- `upload_log`: ربط بسجل العملية
- `row_number`: رقم الصف الذي حدث فيه الخطأ
- `error_type`: نوع الخطأ (تحقق / تكرار / بيانات ناقصة / بيانات غير صالحة / قاعدة بيانات / معالجة / آخر)
- `error_message`: رسالة الخطأ التفصيلية
- `row_data`: بيانات الصف كاملة (JSON)
- `created_at`: تاريخ تسجيل الخطأ

**خصائص محسوبة:**
- `product_name`: اسم المنتج المستخرج من بيانات الصف
- `product_code`: كود المنتج المستخرج من بيانات الصف

## أنواع الأخطاء

يتم تصنيف الأخطاء إلى:

1. **خطأ في التحقق (validation)**: فشل في التحقق من صحة البيانات
2. **تكرار (duplicate)**: محاولة إضافة منتج موجود مسبقاً
3. **بيانات ناقصة (missing_data)**: حقول مطلوبة فارغة
4. **بيانات غير صالحة (invalid_data)**: قيم غير صحيحة أو غير متوافقة
5. **خطأ في قاعدة البيانات (database)**: مشاكل في حفظ البيانات
6. **خطأ في المعالجة (processing)**: أخطاء عامة أثناء المعالجة
7. **خطأ آخر (other)**: أخطاء أخرى غير مصنفة

## الواجهات (Views)

### 1. قائمة سجلات العمليات

**المسار:** `/inventory/bulk-upload-logs/`

عرض جميع عمليات الرفع الجماعي مع إمكانية:
- الفلترة حسب نوع العملية (منتجات / مخزون)
- الفلترة حسب الحالة
- البحث في اسم الملف أو المستخدم
- الترتيب والصفحات

**المعلومات المعروضة:**
- رقم العملية
- نوع العملية
- اسم الملف والمستخدم
- الحالة
- الإحصائيات (إجمالي / معالج / أخطاء)
- نسبة النجاح
- التاريخ
- رابط التقرير

### 2. تقرير عملية رفع محددة

**المسار:** `/inventory/bulk-upload-report/<id>/`

عرض تقرير مفصل لعملية محددة يتضمن:

**معلومات العملية:**
- اسم الملف
- الحالة
- المستودع
- المستخدم المنفذ
- تواريخ البدء والإكمال
- مدة العملية
- نسبة النجاح

**الإحصائيات:**
- إجمالي الصفوف
- عدد الصفوف المعالجة
- عدد المنتجات المُنشأة
- عدد المنتجات المحدثة
- عدد الأخطاء

**قائمة الأخطاء:**
- جدول مفصل بجميع الأخطاء
- رقم الصف
- نوع الخطأ
- اسم المنتج
- كود المنتج
- رسالة الخطأ
- إمكانية الفلترة حسب نوع الخطأ
- صفحات للأخطاء الكثيرة

**إحصائيات الأخطاء:**
- توزيع الأخطاء حسب النوع

**المستودعات المُنشأة:**
- قائمة بالمستودعات التي تم إنشاؤها تلقائياً

### 3. آخر عملية رفع

**المسار:** `/inventory/latest-bulk-upload-report/`

عرض سريع لآخر عملية رفع للمستخدم الحالي، مع إمكانية تحديد النوع:
- `/inventory/latest-bulk-upload-report/products/` - آخر رفع منتجات
- `/inventory/latest-bulk-upload-report/stock_update/` - آخر تحديث مخزون

## التكامل مع النظام الحالي

### 1. صفحة رفع المنتجات

تم تحديث صفحة رفع المنتجات (`/inventory/products/bulk-upload/`) لتتضمن:

- **قسم "آخر عملية رفع"** أعلى الصفحة يعرض:
  - اسم الملف
  - تاريخ ووقت الرفع
  - الحالة
  - عدد الصفوف المعالجة
  - عدد الأخطاء (إن وجدت)
  - رابط لعرض التقرير التفصيلي

- **زر "سجل العمليات"** في الأزرار السريعة للانتقال لقائمة جميع العمليات

- **رسالة بعد الرفع** تتضمن رابطاً للتقرير

### 2. صفحة تحديث المخزون

نفس التحديثات المطبقة على صفحة رفع المنتجات

### 3. لوحة الإدارة (Django Admin)

تم إضافة واجهات إدارة كاملة للنماذج الجديدة:

**BulkUploadLog Admin:**
- عرض جميع السجلات مع الإحصائيات
- فلترة حسب النوع والحالة والتاريخ والمستودع
- بحث في اسم الملف والملخص والمستخدم
- عرض تفصيلي لكل سجل مع:
  - جميع المعلومات والإحصائيات
  - الخيارات المستخدمة
  - المستودعات المُنشأة
  - الملخص
  - معلومات التتبع
  - قائمة الأخطاء المرتبطة (Inline)

**BulkUploadError Admin:**
- عرض جميع الأخطاء
- فلترة حسب نوع الخطأ ونوع العملية والتاريخ
- بحث في رسالة الخطأ واسم الملف
- عرض تفصيلي لكل خطأ مع:
  - معلومات الخطأ الكاملة
  - بيانات الصف JSON
  - اسم المنتج والكود
  - معلومات التسجيل

## آلية العمل

### 1. عند رفع ملف منتجات:

```
1. إنشاء سجل BulkUploadLog بحالة "قيد المعالجة"
2. قراءة ملف Excel
3. تحديث عدد الصفوف الإجمالي في السجل
4. معالجة كل صف:
   - محاولة معالجة البيانات
   - في حالة النجاح: تحديث الإحصائيات
   - في حالة الفشل:
     * إنشاء كائن BulkUploadError
     * حفظ بيانات الصف الكاملة
     * تصنيف نوع الخطأ
     * حفظ رسالة الخطأ
5. حفظ جميع الأخطاء دفعة واحدة (bulk_create)
6. تحديث إحصائيات السجل
7. إكمال السجل بحالة نهائية:
   - "مكتمل" إذا لم توجد أخطاء
   - "مكتمل مع أخطاء" إذا وجدت أخطاء
   - "فشل" في حالة الفشل الكامل
```

### 2. التعامل مع الأخطاء:

تم تحديث جميع نقاط معالجة الأخطاء في الكود لحفظها في قاعدة البيانات:

```python
# مثال على حفظ خطأ
if not name or price <= 0:
    error_msg = 'اسم المنتج والسعر مطلوبان'
    result['errors'].append(f'الصف {row_number}: {error_msg}')
    errors_to_create.append(BulkUploadError(
        upload_log=upload_log,
        row_number=row_number,
        error_type='missing_data',
        error_message=error_msg,
        row_data=row.to_dict()  # حفظ بيانات الصف كاملة
    ))
    continue
```

## الفوائد

1. **تتبع كامل**: جميع عمليات الرفع مسجلة ويمكن مراجعتها في أي وقت
2. **تحليل الأخطاء**: إمكانية تحليل أنواع الأخطاء المتكررة وتحسين العملية
3. **تصحيح سهل**: عرض بيانات الصفوف الفاشلة يسهل التصحيح
4. **إحصائيات دقيقة**: معرفة معدلات النجاح والفشل
5. **مساءلة**: تتبع من قام بكل عملية رفع ومتى
6. **تحسين الجودة**: معرفة المشاكل المتكررة في البيانات

## استخدام النظام

### للمستخدم النهائي:

1. **رفع ملف منتجات:**
   - انتقل إلى: `/inventory/products/bulk-upload/`
   - اختر الملف واملأ الخيارات
   - بعد الرفع، ستظهر رسالة مع رابط التقرير
   - اضغط على "عرض التقرير" لمشاهدة النتائج التفصيلية

2. **مراجعة العمليات السابقة:**
   - اضغط على زر "سجل العمليات" في صفحة الرفع
   - أو انتقل مباشرة إلى: `/inventory/bulk-upload-logs/`
   - استخدم الفلاتر للبحث عن عملية محددة
   - اضغط على أيقونة العين لعرض التقرير

3. **مراجعة الأخطاء:**
   - في صفحة التقرير، راجع قسم "تفاصيل الأخطاء"
   - راجع رقم الصف ونوع الخطأ والرسالة
   - قم بتصحيح البيانات في ملف Excel
   - أعد رفع الملف

### للمطور/المسؤول:

1. **الوصول إلى لوحة الإدارة:**
   - `/admin/inventory/bulkuploadlog/` - سجلات العمليات
   - `/admin/inventory/bulkuploaderror/` - الأخطاء

2. **تحليل الأخطاء:**
   - استخدم فلاتر Django Admin للتحليل
   - راجع `row_data` لكل خطأ لفهم المشكلة
   - حلل توزيع أنواع الأخطاء

3. **تحسين العملية:**
   - راجع الأخطاء المتكررة
   - حسّن validations في الكود
   - أضف رسائل أخطاء أوضح

## التطويرات المستقبلية

- **تصدير تقارير الأخطاء** إلى Excel/PDF
- **إشعارات تلقائية** عند حدوث أخطاء كثيرة
- **إعادة محاولة رفع** الصفوف الفاشلة فقط
- **إحصائيات متقدمة** ورسوم بيانية
- **مقارنة بين العمليات** لتتبع التحسينات
- **جدولة تلقائية** لحذف السجلات القديمة

## الملفات المضافة/المعدلة

### ملفات جديدة:
- `inventory/views_bulk_reports.py` - واجهات التقارير
- `inventory/templates/inventory/bulk_upload_report.html` - صفحة التقرير
- `inventory/templates/inventory/bulk_upload_log_list.html` - قائمة السجلات
- `inventory/migrations/0009_bulkuploadlog_bulkuploaderror_and_more.py` - Migration
- `docs/BULK_UPLOAD_ERROR_TRACKING.md` - هذا الملف

### ملفات معدلة:
- `inventory/models.py` - إضافة النماذج الجديدة
- `inventory/admin.py` - إضافة واجهات الإدارة
- `inventory/views_bulk.py` - تحديث منطق الرفع لحفظ الأخطاء
- `inventory/urls.py` - إضافة المسارات الجديدة
- `inventory/templates/inventory/product_bulk_upload.html` - إضافة قسم آخر رفع

## الدعم والأسئلة

للمزيد من المعلومات أو المساعدة، يرجى:
- مراجعة الكود المصدري مع التعليقات التوضيحية
- التواصل مع فريق التطوير
- رفع تذكرة دعم في نظام إدارة المشاريع
