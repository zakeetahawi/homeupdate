# نظام إدارة المديونيات

## نظرة عامة

تم تطوير نظام شامل لإدارة مديونيات العملاء يعمل بشكل تلقائي ومتكامل مع نظام الطلبات. يقوم النظام بتتبع المديونيات وإدارتها بشكل دقيق وفعال.

## المكونات الرئيسية

### 1. نموذج البيانات (CustomerDebt)

```python
class CustomerDebt(models.Model):
    customer = models.ForeignKey('customers.Customer', on_delete=models.CASCADE)
    order = models.ForeignKey('orders.Order', on_delete=models.CASCADE)
    debt_amount = models.DecimalField(max_digits=10, decimal_places=2)
    notes = models.TextField(blank=True)
    is_paid = models.BooleanField(default=False)
    payment_receipt_number = models.CharField(max_length=100, blank=True)
    payment_receiver_name = models.CharField(max_length=100, blank=True)
    payment_date = models.DateTimeField(null=True, blank=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
```

### 2. الإشارات التلقائية (Signals)

#### إنشاء/تحديث المديونيات تلقائياً
- **الإشارة**: `post_save` على نموذج `Order`
- **الوظيفة**: `manage_customer_debt_on_order_save`
- **المهام**:
  - إنشاء سجل مديونية جديد عند وجود مبلغ متبقي
  - تحديث المبلغ عند تغيير قيمة المديونية
  - تحديث الحالة إلى "مدفوع" عند سداد المبلغ كاملاً

#### تحديث تاريخ الدفع
- **الإشارة**: `pre_save` على نموذج `CustomerDebt`
- **الوظيفة**: `update_debt_payment_date`
- **المهام**: تحديث تاريخ الدفع تلقائياً عند تغيير الحالة

### 3. أوامر الإدارة (Management Commands)

#### أمر إنشاء سجلات المديونيات
```bash
python manage.py create_debt_records [--update-existing] [--min-debt=1.0]
```

**المعاملات**:
- `--update-existing`: تحديث السجلات الموجودة
- `--min-debt`: الحد الأدنى لمبلغ المديونية (افتراضي: 1.0)

#### أمر مزامنة المديونيات
```bash
python manage.py sync_debts [--dry-run] [--verbose]
```

**المعاملات**:
- `--dry-run`: تشغيل تجريبي بدون حفظ
- `--verbose`: عرض تفاصيل أكثر

### 4. المهام الدورية (Celery Tasks)

#### مزامنة المديونيات
- **المهمة**: `sync_customer_debts_task`
- **التكرار**: كل ساعة
- **الوظيفة**: مزامنة المديونيات مع الطلبات الحالية

#### إنشاء سجلات المديونيات
- **المهمة**: `create_debt_records_task`
- **التكرار**: كل 30 دقيقة
- **الوظيفة**: إنشاء سجلات للطلبات الجديدة

#### تحديث المديونيات المتأخرة
- **المهمة**: `update_overdue_debts_task`
- **التكرار**: يومياً في منتصف الليل
- **الوظيفة**: تحديد وتصنيف المديونيات المتأخرة

#### تقرير المديونيات الأسبوعي
- **المهمة**: `generate_debt_report_task`
- **التكرار**: كل أحد الساعة 8 صباحاً
- **الوظيفة**: إنشاء تقرير شامل للمديونيات

### 5. واجهة الإدارة

#### لوحة التحكم الرئيسية
- **المسار**: `/admin/`
- **المكونات**:
  - بطاقة إحصائيات المديونيات
  - أزرار الوصول السريع (إدارة - عرض)
  - إحصائيات المديونيات المتأخرة

#### صفحة إدارة المديونيات
- **المسار**: `/admin/debt-management/`
- **المميزات**:
  - عرض جميع المديونيات مع الفلترة
  - إحصائيات سريعة
  - إمكانية تسديد المديونيات
  - البحث والفلترة المتقدمة
  - ترقيم الصفحات

#### API تسديد المديونيات
- **المسار**: `/admin/mark-debt-paid/<debt_id>/`
- **الطريقة**: POST
- **الوظيفة**: تسديد مديونية محددة

## الاستخدام

### 1. إنشاء المديونيات الأولية

```bash
# إنشاء سجلات المديونيات للطلبات الموجودة
python manage.py create_debt_records

# تحديث السجلات الموجودة أيضاً
python manage.py create_debt_records --update-existing

# تحديد حد أدنى للمديونية
python manage.py create_debt_records --min-debt=50.0
```

### 2. مزامنة المديونيات

```bash
# مزامنة عادية
python manage.py sync_debts

# تشغيل تجريبي لمعاينة التغييرات
python manage.py sync_debts --dry-run --verbose
```

### 3. الوصول لواجهة الإدارة

1. انتقل إلى لوحة التحكم الرئيسية
2. اضغط على بطاقة "المديونيات المعلقة"
3. اختر "إدارة" للوصول لصفحة الإدارة الشاملة
4. استخدم الفلاتر للبحث والتصفية
5. اضغط "تسديد" لتسديد مديونية محددة

## الإحصائيات المتاحة

### في لوحة التحكم الرئيسية
- إجمالي عدد المديونيات غير المدفوعة
- إجمالي مبلغ المديونيات
- عدد المديونيات المتأخرة (أكثر من 30 يوم)

### في صفحة إدارة المديونيات
- إجمالي المديونيات
- إجمالي المبلغ
- المديونيات المتأخرة
- مدفوعات اليوم
- مبلغ مدفوعات اليوم

## الفلترة والبحث

### فلاتر متاحة
- **حالة الدفع**: الكل، غير مدفوع، مدفوع، متأخر
- **البحث**: اسم العميل أو رقم الطلب
- **الحد الأدنى**: تحديد حد أدنى لمبلغ المديونية

### ترتيب النتائج
- الترتيب الافتراضي: حسب تاريخ الإنشاء (الأحدث أولاً)
- إمكانية الترتيب حسب أي عمود في الجدول

## الأمان والصلاحيات

- جميع صفحات الإدارة محمية بـ `@staff_member_required`
- تسجيل جميع العمليات في سجلات النظام
- تتبع المستخدم الذي قام بتسديد المديونية
- حماية CSRF لجميع العمليات

## المراقبة والسجلات

### سجلات النظام
- تسجيل إنشاء المديونيات الجديدة
- تسجيل تحديث المبالغ
- تسجيل عمليات التسديد
- تسجيل أخطاء المزامنة

### مراقبة الأداء
- مراقبة أداء المهام الدورية
- تتبع أوقات تنفيذ المزامنة
- إحصائيات استخدام الذاكرة والمعالج

## الصيانة والتحسين

### مهام الصيانة الدورية
- تنظيف السجلات القديمة
- فهرسة قاعدة البيانات
- تحسين الاستعلامات

### النسخ الاحتياطي
- نسخ احتياطي يومي لجدول المديونيات
- تصدير التقارير الشهرية
- أرشفة السجلات القديمة

## استكشاف الأخطاء

### مشاكل شائعة وحلولها

#### المديونيات لا تظهر
```bash
# تشغيل أمر إنشاء المديونيات
python manage.py create_debt_records --update-existing
```

#### عدم تطابق المبالغ
```bash
# تشغيل مزامنة شاملة
python manage.py sync_debts --verbose
```

#### مشاكل في المهام الدورية
```bash
# فحص حالة Celery
celery -A crm inspect active
celery -A crm inspect scheduled
```

## التطوير المستقبلي

### مميزات مخططة
- إشعارات تلقائية للمديونيات المتأخرة
- تقارير تفصيلية قابلة للتصدير
- واجهة API للتطبيقات الخارجية
- تكامل مع أنظمة الدفع الإلكتروني

### تحسينات الأداء
- فهرسة متقدمة لقاعدة البيانات
- تخزين مؤقت للإحصائيات
- تحسين استعلامات قاعدة البيانات
