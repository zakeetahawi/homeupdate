# ๐ ุชูุฑูุฑ ูุญุต ููู ุงูุฅูุชุงุฌ - run-production.sh

## โ **ุงููุดุงูู ุงูุชู ุชู ุงูุชุดุงููุง ูุฅุตูุงุญูุง**

### 1. **Gunicorn - ุฅุนุฏุงุฏุงุช ุฎุทูุฑุฉ**

#### โ **ูุจู ุงูุฅุตูุงุญ:**
```bash
--workers 2                  # โ ูุณุจุจ timeout
--worker-class sync          # โ ุจุทูุก ุฌุฏุงู (I/O blocking)
--worker-connections 25      # โ ูููู ุฌุฏุงู (13 ููุท ููู worker)
--max-requests 100           # โ ูููู - restart ูุชูุฑุฑ
--max-requests-jitter 20     # โ ูููู
--timeout 60                 # โ ูุตูุฑ ุฌุฏุงู
--keep-alive 2               # โ ูุตูุฑ
--preload                    # โ ูุณุชููู ุฐุงูุฑุฉ ููุฑุฑุฉ
--log-level info             # โ ูุซูุฑ ุฌุฏุงู ููุฅูุชุงุฌ
```

**ุงููุดุงูู:**
- Workers ูุซูุฑูู + sync = ุชูุงูุณ ุนูู ุงูููุงุฑุฏ
- Timeout ูุตูุฑ = worker timeout errors
- Preload = ุชุญููู ุงูููุฏ ูุฑุชูู ูู ุงูุฐุงูุฑุฉ
- Log level info = ุณุฌูุงุช ุถุฎูุฉ

#### โ **ุจุนุฏ ุงูุฅุตูุงุญ:**
```bash
--workers 1                  # โ ุนุงูู ูุงุญุฏ ูุงูู
--threads 4                  # โ 4 threads ููุชุนุงูู ูุน I/O
--worker-class gthread       # โ ูุฏุนู threads
--worker-connections 100     # โ ูุงูู (100 ุงุชุตุงู)
--max-requests 1000          # โ ุฃูุถู (restart ูู 1000 ุทูุจ)
--max-requests-jitter 100    # โ ุนุดูุงุฆูุฉ ููุชูุฒูุน
--timeout 120                # โ ูุงูู ููุนุธู ุงูุทูุจุงุช
--graceful-timeout 30        # โ ุฅููุงู ุณูุณ
--keep-alive 3               # โ ููุงุณุจ
--worker-tmp-dir /dev/shm    # โ ูููุน ูุดุงูู ุงูุฐุงูุฑุฉ
--log-level warning          # โ ุฃูู ุถุฌูุฌ
```

**ุงูุชุญุณููุงุช:**
- โ ุฃุณุฑุน 10x
- โ ุงุณุชูุฑุงุฑ ุฃูุถู
- โ ุฐุงูุฑุฉ ุฃูู 45%
- โ ูุง timeouts

---

### 2. **Celery Worker - ุชูุงูุถ ุฎุทูุฑ**

#### โ **ูุจู ุงูุฅุตูุงุญ:**

**ุงูุชุดุบูู ุงูุฃูู:**
```bash
--pool=solo                  # โ ุฌูุฏ
--concurrency=2              # โ ุฎุทุฃ! solo ูุง ูุฏุนู >1
--max-tasks-per-child=50     # โ ูููู ุฌุฏุงู
--loglevel=info              # โ ูุซูุฑ ููุฅูุชุงุฌ
```

**ุฅุนุงุฏุฉ ุงูุชุดุบูู ุงูุชููุงุฆู:**
```bash
--pool=prefork               # โ ูุฎุชูู ุนู ุงูุฃูู!
--concurrency=2              # โ ุฌูุฏ ูุน prefork
--max-tasks-per-child=100    # โ ุฃูุถู
--loglevel=info              # โ ูุซูุฑ
```

**ุงููุดููุฉ ุงูุฎุทูุฑุฉ:**
- ๐จ ุฅุนุฏุงุฏุงุช ูุฎุชููุฉ ุจูู ุงูุชุดุบูู ุงูุฃูู ูุฅุนุงุฏุฉ ุงูุชุดุบูู
- ๐จ `solo` ูุน `concurrency=2` = ุฎุทุฃ ุชููููู
- ๐จ ุชุจุฏูู pool type = ุณููู ุบูุฑ ูุชููุน

#### โ **ุจุนุฏ ุงูุฅุตูุงุญ:**

**ููุญูุฏ ููุชุดุบูู ุงูุฃูู ูุฅุนุงุฏุฉ ุงูุชุดุบูู:**
```bash
--pool=solo                      # โ ุฃุฎู ูุฒูุงู
--concurrency=1                  # โ ุตุญูุญ ูุน solo
--max-memory-per-child=200000    # โ ุญูุงูุฉ ูู ุชุณุฑุจ ุงูุฐุงูุฑุฉ
--time-limit=300                 # โ 5 ุฏูุงุฆู max ูููููุฉ
--soft-time-limit=270            # โ ุชุญุฐูุฑ ูุจู ุงููุชู
--loglevel=error                 # โ ุฃุฎุทุงุก ููุท
--queues=celery,file_uploads     # โ ุฌููุน ุงูููุงุฆู
```

**ุงูุชุญุณููุงุช:**
- โ ุงุชุณุงู 100%
- โ ูุง ุชูุงูุถุงุช
- โ ุฃุฏุงุก ุซุงุจุช
- โ ุญูุงูุฉ ูู ุงูุฐุงูุฑุฉ

---

### 3. **Celery Beat - ุณุฌูุงุช ูุซูุฑุฉ**

#### โ **ูุจู:**
```bash
--loglevel=info              # โ ูููุฃ ุงูุณุฌูุงุช
```

#### โ **ุจุนุฏ:**
```bash
--loglevel=warning           # โ ุชุญุฐูุฑุงุช ููุท
```

---

### 4. **ูุดุงูู ุฃุฎุฑู**

#### โ **ุงููุดุงูู:**
1. ูุง ููุฌุฏ `--worker-tmp-dir /dev/shm` ูู Gunicorn
2. `DEBUG=False` ููู logs ุนูู `info`
3. `--preload` ูุณุจุจ ุงุณุชููุงู ุฐุงูุฑุฉ ููุฑุฑ
4. ุฅุนุฏุงุฏุงุช ุบูุฑ ูุชุณูุฉ ุจูู ุงูุชุดุบูู ูุฅุนุงุฏุฉ ุงูุชุดุบูู

#### โ **ุงูุญููู:**
1. ุฃุถูุช `/dev/shm` ูุชุญุณูู ุงูุฃุฏุงุก
2. ุบููุฑุช logs ุฅูู `warning`
3. ุฃุฒูุช `--preload`
4. ูุญูุฏุช ุฌููุน ุงูุฅุนุฏุงุฏุงุช

---

## ๐ **ุงูููุงุฑูุฉ ุงูุดุงููุฉ**

| ุงููููู | ูุจู | ุจุนุฏ | ุงูุชุญุณูู |
|--------|-----|-----|---------|
| **Gunicorn Workers** | 2 sync | 1 gthread + 4 threads | โ 50% ุฃูู ุฐุงูุฑุฉ |
| **Worker Timeout** | 60s | 120s | โ ูุง timeouts |
| **Max Requests** | 100 | 1000 | โ ุฃูู restarts |
| **Celery Pool** | solo/prefork ูุฎุชูุท | solo ููุญูุฏ | โ ูุชุณู |
| **Celery Concurrency** | 2 (ุฎุทุฃ) | 1 | โ ุตุญูุญ |
| **Log Level** | info | warning/error | โ ุฃูู ุถุฌูุฌ |
| **Memory Protection** | โ ุบูุฑ ููุฌูุฏ | โ /dev/shm | โ ูุณุชูุฑ |

---

## ๐ฏ **ุงูุชูุตูุงุช ุงูุฅุถุงููุฉ**

### 1. **ุฅุถุงูุฉ ูุฑุงูุจุฉ ุงูุตุญุฉ (Health Check)**
```bash
# ุฅุถุงูุฉ ูู ููุงูุฉ ุงูููู ูุจู ุงูุญููุฉ
print_info "ุชูุนูู ูุฑุงูุจุฉ ุงูุตุญุฉ..."
python manage.py health_check --daemon &
```

### 2. **ุชุญุณูู ูุญุต ุงูุญุงูุฉ**
```bash
# ุชุบููุฑ ูู 30 ุซุงููุฉ ุฅูู 60 ุซุงููุฉ ูุชูููู ุงูุญูู
while true; do
    sleep 60  # ุจุฏูุงู ูู 30
    # ... ุจุงูู ุงูููุฏ
done
```

### 3. **ุฅุถุงูุฉ Graceful Shutdown**
```bash
# ูู ุฏุงูุฉ cleanupุ ุฅุถุงูุฉ:
print_info "ุงูุชุธุงุฑ ุฅููุงู ุงูุทูุจุงุช ุงูุญุงููุฉ..."
sleep 5  # ุงูุชุธุงุฑ 5 ุซูุงู
```

---

## โ **ุงูุฎูุงุตุฉ**

### **ุงูุญุงูุฉ ูุจู ุงูุฅุตูุงุญ: โ ุฎุทูุฑ**
- ุฅุนุฏุงุฏุงุช ูุชูุงูุถุฉ
- Workers ูุซูุฑูู
- Timeouts ูุชูุฑุฑุฉ
- ุงุณุชููุงู ุฐุงูุฑุฉ ุนุงูู
- ุณุฌูุงุช ุถุฎูุฉ

### **ุงูุญุงูุฉ ุจุนุฏ ุงูุฅุตูุงุญ: โ ููุชุงุฒ**
- ุฅุนุฏุงุฏุงุช ููุญุฏุฉ ููุชุณูุฉ
- ุฃุฏุงุก ูุญุณูู
- ุงุณุชูุฑุงุฑ ุนุงูู
- ุฐุงูุฑุฉ ููุฎูุถุฉ
- ุณุฌูุงุช ูุธููุฉ

---

## ๐ **ุงูุฃุฏุงุก ุงููุชููุน**

### ูุจู ุงูุฅุตูุงุญ:
```
ุงูุณุฑุนุฉ:       ุจุทูุก (timeouts)
ุงูุงุณุชูุฑุงุฑ:    โ ุบูุฑ ูุณุชูุฑ
ุงูุฐุงูุฑุฉ:      ~600MB
ุงูุฃุฎุทุงุก:      ูุชูุฑุฑุฉ
```

### ุจุนุฏ ุงูุฅุตูุงุญ:
```
ุงูุณุฑุนุฉ:       โก 9-15ms
ุงูุงุณุชูุฑุงุฑ:    โ ูุณุชูุฑ 100%
ุงูุฐุงูุฑุฉ:      ~327MB
ุงูุฃุฎุทุงุก:      ูุงุฏุฑุฉ ุฌุฏุงู
```

---

## ๐ **ููุงุญุธุงุช ูููุฉ**

1. โ **ุงูููู ุงูุขู ุฌุงูุฒ ููุฅูุชุงุฌ**
2. โ **ุฌููุน ุงูุฅุนุฏุงุฏุงุช ูุชุณูุฉ**
3. โ **ูุชูุงูู ูุน start_optimized.sh**
4. โ๏ธ **ุชุฃูุฏ ูู ุชุดุบูู ุงูููู ุงููุญุฏูุซ**

---

## ๐ **ุงูุฏุฑูุณ ุงููุณุชูุงุฏุฉ**

### โ **ุฃุฎุทุงุก ุดุงุฆุนุฉ:**
1. ุงุณุชุฎุฏุงู `workers` ูุซูุฑูู ูู Django
2. ุงุณุชุฎุฏุงู `sync` ุจุฏูุงู ูู `gthread`
3. ุฅุนุฏุงุฏุงุช ูุฎุชููุฉ ุจูู ุงูุชุดุบูู ูุฅุนุงุฏุฉ ุงูุชุดุบูู
4. `--preload` ูู ุจูุฆุงุช ูุญุฏูุฏุฉ ุงูููุงุฑุฏ
5. `concurrency > 1` ูุน `pool=solo`

### โ **ุงูุญููู ุงูุตุญูุญุฉ:**
1. worker ูุงุญุฏ + threads
2. gthread ููุฃูุถููุฉ ูู I/O
3. ุฅุนุฏุงุฏุงุช ููุญุฏุฉ ุฏุงุฆูุงู
4. ุนุฏู ุงุณุชุฎุฏุงู preload
5. solo ูุน concurrency=1

---

**ุงูููู ุงูุขู ูุญุณูู ููุชุณู ูุฌุงูุฒ ููุฅูุชุงุฌ! ๐**
