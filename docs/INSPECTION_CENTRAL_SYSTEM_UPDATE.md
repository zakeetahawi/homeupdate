# ุชุญุฏูุซ ูุธุงู ุงููุนุงููุงุช ุงููุฑูุฒู
## Central Inspection System Update

**ุงูุชุงุฑูุฎ:** 4 ููููุจุฑ 2025  
**ุงูุญุงูุฉ:** โ ุชู ุงูุชุทุจูู ุจูุฌุงุญ

---

## ๐ ุงููุดููุฉ ุงูุฃุตููุฉ

### ุงูุณููุงุฑูู:
1. ููุธู (mina.ezzat) ูู ูุฑุน **Open Air** ุฃูุดุฃ ูุนุงููุฉ #5645
2. ุชู ููู ุงูููุธู ุฅูู ูุฑุน **ุงูููู**
3. ุนูุฏ ูุญุงููุฉ ุชุญุฏูุซ ุงููุนุงููุฉุ ูุธูุฑ ุฎุทุฃ:
   ```
   ูุง ููููู ุฅุถุงูุฉ ูุนุงููุงุช ููุฑุน ุขุฎุฑ
   ```

### ุงูุณุจุจ ุงูุฌุฐุฑู:
- ูุงู ุงููุธุงู ููุญุต ุงููุฑุน ูู `Inspection.clean()` ุจุงุณุชุฎุฏุงู `self.created_by`
- `created_by` ูุดูุฑ ููููุธู ุงูุฐู **ุฃูุดุฃ** ุงููุนุงููุฉ (ููุณ ุงููุณุชุฎุฏู ุงูุญุงูู)
- ุนูุฏ ููู ุงูููุธู ููุฑุน ุขุฎุฑุ ูุตุจุญ `created_by.branch` ูุฎุชููุงู ุนู `inspection.branch`
- ุงููุชูุฌุฉ: ุฑูุถ ุงูุชุญุฏูุซ ุญุชู ููุฏูุฑู ุงููุธุงู!

---

## โ ุงูุญู ุงููุทุจู

### ุงูุชุบููุฑุงุช ูู `inspections/models.py`

**ูุจู ุงูุชุนุฏูู:**
```python
def clean(self):
    # ... ุงูุชุญููุงุช ุงูุฃุฎุฑู ...
    
    # ูุญุต ุงููุฑุน
    if self.created_by:
        is_admin_user = (
            self.created_by.is_superuser or 
            self.created_by.is_staff or 
            getattr(self.created_by, 'is_branch_manager', False)
        )
        if not is_admin_user:
            if self.branch != self.created_by.branch:
                raise ValidationError(_('ูุง ููููู ุฅุถุงูุฉ ูุนุงููุงุช ููุฑุน ุขุฎุฑ'))
```

**ุจุนุฏ ุงูุชุนุฏูู:**
```python
def clean(self):
    # ุงูุชุฃูุฏ ูู ูุฌูุฏ ุทูุจ ูุฑุชุจุท
    if not self.order:
        raise ValidationError(_('ูุฌุจ ุฑุจุท ุงููุนุงููุฉ ุจุทูุจ ูู ูุณู ุงูุทูุจุงุช'))
    
    # Ensure scheduled date is not before request date
    if self.scheduled_date and self.request_date:
        if self.scheduled_date < self.request_date:
            raise ValidationError(_('ุชุงุฑูุฎ ุชูููุฐ ุงููุนุงููุฉ ูุง ูููู ุฃู ูููู ูุจู ุชุงุฑูุฎ ุงูุทูุจ'))
    
    # ููุงุญุธุฉ: ุชู ุฅุฒุงูุฉ ูุญุต ุงููุฑุน ูู ููุง ูุฃู:
    # 1. ุงูู view ููุญุต ุงูุตูุงุญูุงุช ุจุงููุนู (InspectionUpdateView.test_func)
    # 2. ูุฏูุฑู ุงููุธุงู ูุญุชุงุฌูู ุชุญุฏูุซ ุฃู ูุนุงููุฉ ุจุบุถ ุงููุธุฑ ุนู ููู ุงูููุธููู
    # 3. ุงููุญุต ููุง ูุงู ูุนุชูุฏ ุนูู created_by ูููุณ ุงููุณุชุฎุฏู ุงูุญุงูู
```

---

## ๐ ูุธุงู ุงูุตูุงุญูุงุช ุงูููุฌูุฏ

### ูู `InspectionUpdateView.test_func()`:
```python
def test_func(self):
    inspection = self.get_object()
    user = self.request.user

    # ุงูุณูุงุญ ูููุฏูุฑูู ูุงููุณุชุฎุฏููู ุงููุฎูููู
    if user.is_superuser or user.is_staff:
        return True

    # ุงูุณูุงุญ ูููุดุฆ ุงููุนุงููุฉ ุฃู ุงููุนุงูู ุงูููุนูููู
    if inspection.created_by == user or inspection.inspector == user:
        return True

    # ุงูุณูุงุญ ููููู ุงููุนุงููุฉ
    if hasattr(user, 'is_inspection_technician') and user.is_inspection_technician:
        return True

    # ุงูุณูุงุญ ููุฏูุฑู ุงููุฑูุน
    if hasattr(user, 'is_branch_manager') and user.is_branch_manager:
        return True

    return False
```

โ **ุงูุตูุงุญูุงุช ุชููุญุต ูู ุงูู View ุจุดูู ุตุญูุญ**  
โ **ูุง ุญุงุฌุฉ ูููุญุต ุงูููุฑุฑ ูู Model.clean()**

---

## ๐งช ูุชุงุฆุฌ ุงูุงุฎุชุจุงุฑ

### ุงุฎุชุจุงุฑ 1: ููุธู ุนุงุฏู ุชู ูููู
```
ุงููุนุงููุฉ #5645:
  - ุงููุฑุน: Open Air
  - ุฃูุดุฆุช ุจูุงุณุทุฉ: mina.ezzat
  - ูุฑุน ุงูููุดุฆ ุงูุญุงูู: ูุฑุน ุงูููู

โ ุงููุฌุงุญ! ุชู ุฅุฒุงูุฉ ูุญุต ุงููุฑุน - ูููู ููููุธู ุงูุชุนุฏูู
```

### ุงุฎุชุจุงุฑ 2: ูุฏูุฑ ูุธุงู ูู ูุฑุน ูุฎุชูู
```
ุงููุณุชุฎุฏู: zakee.tahawi
  - ุงููุฑุน: ุงูุงุฏุงุฑุฉ
  - is_staff: True
  - ุงููุนุงููุฉ ูู ูุฑุน: Open Air

โ ุงููุฌุงุญ! ูุฏูุฑ ุงููุธุงู ููููู ุงูุชุนุฏูู ูู ุฃู ูุฑุน
```

---

## ๐ ุงูููุงุฆุฏ

### โ ูุธุงู ูุฑูุฒู
- ุชุญุฏูุซ ุงููุนุงููุงุช ูุชู ุจุดูู ูุฑูุฒู ุนูู ูุณุชูู ุงูุดุฑูุฉ
- ูุง ูููุฏ ุนูู ุงููุฑูุน ููุฏูุฑู ุงููุธุงู

### โ ูุฑููุฉ ูู ุฅุฏุงุฑุฉ ุงูููุธููู
- ููู ุงูููุธููู ุจูู ุงููุฑูุน ูุง ูุคุซุฑ ุนูู ุงููุนุงููุงุช ุงูุณุงุจูุฉ
- ููู ุงูุจุงุฆุนูู ูุง ูููุน ุชุญุฏูุซ ูุนุงููุงุชูู

### โ ุตูุงุญูุงุช ูุงุถุญุฉ
- ุงููุฏูุฑูู (is_superuser, is_staff): **ูุตูู ูุงูู ูุฌููุน ุงููุนุงููุงุช**
- ูุฏูุฑู ุงููุฑูุน (is_branch_manager): **ูุตูู ูุงูู**
- ูููู ุงููุนุงููุฉ (is_inspection_technician): **ูุตูู ูุงูู**
- ููุดุฆ ุงููุนุงููุฉ: **ููููู ุงูุชุนุฏูู**
- ุงููุนุงูู ุงููุนููู: **ููููู ุงูุชุนุฏูู**

### โ ุฃูุงู ูุญููุธ
- ุงูุตูุงุญูุงุช ูุง ุชุฒุงู ุชููุญุต ูู `InspectionUpdateView.test_func()`
- ุงููุณุชุฎุฏููู ุบูุฑ ุงููุฎูููู ูุง ูููููู ุงููุตูู
- 403 Forbidden ูููุตูู ุบูุฑ ุงููุตุฑุญ

---

## ๐ฏ ุงูุฎูุงุตุฉ

| ุงูุฌุงูุจ | ูุจู | ุจุนุฏ |
|--------|-----|-----|
| **ูุญุต ุงููุฑุน ูู Model** | โ ููุฌูุฏ | โ ูุญุฐูู |
| **ูุญุต ุงูุตูุงุญูุงุช ูู View** | โ ููุฌูุฏ | โ ููุฌูุฏ |
| **ุชุฃุซูุฑ ููู ุงูููุธููู** | โ ูููุน ุงูุชุญุฏูุซ | โ ูุง ุชุฃุซูุฑ |
| **ูุตูู ูุฏูุฑู ุงููุธุงู** | โ๏ธ ูุญุฏูุฏ ุจุงููุฑุน | โ ูุงูู |
| **ุงููุธุงู** | โ๏ธ ูุฑุนู | โ ูุฑูุฒู |

---

## ๐ ููุงุญุธุงุช ูููุฉ

1. **ุงูุชุญูู ูู ุงูุตูุงุญูุงุช:**
   - ูุชู ูู `InspectionUpdateView.test_func()`
   - ูุง ูุญุชุงุฌ ูุญุต ููุฑุฑ ูู `Model.clean()`

2. **ููุณูุฉ ุงูุชุตููู:**
   - `Model.clean()`: ููุชุญูู ูู **ุตุญุฉ ุงูุจูุงูุงุช** (data validation)
   - `View.test_func()`: ููุชุญูู ูู **ุตูุงุญูุงุช ุงููุณุชุฎุฏู** (permissions)

3. **ุงููุณุชุฎุฏููู ุงููุฎูููู:**
   - is_superuser
   - is_staff (16 ูุณุชุฎุฏู)
   - is_branch_manager (7 ูุณุชุฎุฏููู)
   - is_inspection_technician
   - created_by
   - inspector

---

## ๐ ุงูุชุทุจูู

```bash
# ุงูุชุนุฏููุงุช ุชูุทุจู ุชููุงุฆูุงู - Django ูุนูุฏ ุชุญููู ุงูููุฏ
# ูุง ุญุงุฌุฉ ูุฅุนุงุฏุฉ ุชุดุบูู ุงูุฎุงุฏู

# ุงูุณุญ cache ุงููุชุตูุญ:
# Ctrl + Shift + R (Windows/Linux)
# Cmd + Shift + R (Mac)
```

---

## โ ุชู ุงูุฅูุฌุงุฒ ุจูุฌุงุญ!

**ุงูุชุงุฑูุฎ:** 4 ููููุจุฑ 2025  
**ุงููุทูุฑ:** GitHub Copilot  
**ุงูุญุงูุฉ:** ุฌุงูุฒ ููุฅูุชุงุฌ ๐
