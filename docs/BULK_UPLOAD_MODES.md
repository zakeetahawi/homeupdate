# أوضاع رفع المنتجات بالجملة - دليل المستخدم

## 📋 نظرة عامة

تم إضافة 3 أوضاع مختلفة لرفع المنتجات بالجملة لإعطائك تحكم كامل في كيفية التعامل مع المنتجات الموجودة مسبقاً في النظام.

---

## 🎯 الأوضاع الثلاثة

### 1️⃣ إضافة للكميات الموجودة (add_to_existing)

**الوصف:** تحديث بيانات المنتج + إضافة الكمية إلى الرصيد الموجود

**متى تستخدمه:**
- عند استلام شحنة جديدة من منتجات موجودة
- عند إضافة مخزون إلى مخزون موجود
- عند تحديث أسعار المنتجات مع زيادة المخزون

**مثال:**
```
المنتج: كرسي خشبي (كود: CH-001)
الرصيد الحالي: 50 قطعة
الكمية في الملف: 30 قطعة

النتيجة:
✅ تحديث بيانات المنتج (الاسم، السعر، إلخ)
✅ الرصيد الجديد: 80 قطعة (50 + 30)
```

---

### 2️⃣ استبدال الكميات (replace_quantity)

**الوصف:** تحديث بيانات المنتج + استبدال الكمية بالكامل

**متى تستخدمه:**
- عند إجراء جرد كامل للمخزون
- عند تصحيح أرصدة خاطئة
- عند بدء نظام جديد وتريد تصفير كل شيء وإعادة إدخاله

**مثال:**
```
المنتج: كرسي خشبي (كود: CH-001)
الرصيد الحالي: 50 قطعة
الكمية في الملف: 30 قطعة

النتيجة:
✅ تحديث بيانات المنتج (الاسم، السعر، إلخ)
✅ تصفير الرصيد الحالي (إنشاء معاملة خروج: -50)
✅ الرصيد الجديد: 30 قطعة (استبدال كامل)
```

**آلية العمل:**
1. يتم إنشاء معاملة خروج (out) بالرصيد الحالي لتصفيره
2. يتم إنشاء معاملة دخول (in) بالكمية الجديدة
3. النتيجة النهائية: الرصيد = الكمية من الملف

---

### 3️⃣ المنتجات الجديدة فقط (new_only)

**الوصف:** إضافة المنتجات الجديدة فقط، تجاهل المنتجات الموجودة تماماً

**متى تستخدمه:**
- عند إضافة أصناف جديدة فقط
- عند عدم الرغبة في تعديل أي شيء موجود
- عند استيراد كتالوج منتجات من مورد جديد

**مثال:**
```
المنتج: كرسي خشبي (كود: CH-001) - موجود مسبقاً
النتيجة: ⏭️ تم تخطيه (لن يتم تحديثه أو تغيير كميته)

المنتج: طاولة خشبية (كود: TB-001) - جديد
النتيجة: ✅ تم إضافته بالكامل
```

---

## 📊 جدول مقارنة سريع

| الوضع | المنتج الموجود | المنتج الجديد | الكمية |
|-------|----------------|----------------|--------|
| **إضافة للموجود** | ✅ تحديث البيانات | ✅ إضافة | إضافة (رصيد قديم + جديد) |
| **استبدال** | ✅ تحديث البيانات | ✅ إضافة | استبدال (الكمية الجديدة فقط) |
| **جديد فقط** | ⏭️ تخطي | ✅ إضافة | حسب الملف (للجديد فقط) |

---

## 🎬 سيناريوهات الاستخدام

### سيناريو 1: استلام شحنة جديدة
**الموقف:**
- لديك 100 قطعة من المنتج A
- استلمت شحنة جديدة بـ 50 قطعة إضافية
- تريد تحديث السعر أيضاً

**الحل:**
- ✅ استخدم **إضافة للموجود**
- النتيجة: 150 قطعة + سعر محدث

---

### سيناريو 2: جرد سنوي
**الموقف:**
- تقوم بجرد شامل للمخزون
- عدّيت فعلياً 80 قطعة من المنتج A
- النظام يقول 100 قطعة (خطأ)
- تريد تصحيح الرصيد ليكون 80 بالضبط

**الحل:**
- ✅ استخدم **استبدال الكميات**
- النتيجة: 80 قطعة (تم التصحيح)

---

### سيناريو 3: كتالوج مورد جديد
**الموقف:**
- تستورد 500 منتج من مورد جديد
- بعضها موجود لديك (50 منتج)
- بعضها جديد (450 منتج)
- لا تريد المساس بالمنتجات الموجودة

**الحل:**
- ✅ استخدم **جديد فقط**
- النتيجة: إضافة 450 منتج جديد فقط

---

## 💻 كيفية الاستخدام

### 1. اذهب إلى صفحة الرفع
```
المخزون → رفع منتجات بالجملة
```

### 2. حدد الوضع المناسب
- ⚪ إضافة للكميات الموجودة (افتراضي)
- ⚪ استبدال الكميات
- ⚪ المنتجات الجديدة فقط

### 3. ارفع الملف
- اختر ملف Excel
- اختر المستودع (اختياري)
- اضغط "رفع وإضافة المنتجات"

### 4. راجع التقرير
- سيظهر لك تقرير مفصل بالنتائج
- يمكنك رؤية:
  - عدد المنتجات الجديدة
  - عدد المنتجات المحدثة
  - عدد المنتجات المتخطاة
  - أي أخطاء حدثت

---

## ⚠️ ملاحظات مهمة

### في وضع "استبدال الكميات":
- ⚠️ سيتم تصفير الرصيد الحالي تماماً
- ⚠️ يُنشأ معاملة خروج بالكمية الكاملة
- ⚠️ ثم معاملة دخول بالكمية الجديدة
- ⚠️ استخدمه بحذر مع المنتجات ذات الحركة الكبيرة

### في وضع "جديد فقط":
- ℹ️ المنتجات الموجودة ستُتجاهل تماماً
- ℹ️ لن يتم تحديث أسعارها أو بياناتها
- ℹ️ مفيد عند عدم الرغبة في تغيير أي شيء موجود

### في وضع "إضافة للموجود":
- ℹ️ الكميات تُضاف إلى الرصيد الموجود
- ℹ️ البيانات (الاسم، السعر، إلخ) تُحدث
- ℹ️ الوضع الأكثر أماناً والأكثر شيوعاً

---

## 🧪 أمثلة عملية

### مثال 1: تحديث أسعار + إضافة كميات

**الملف (products.xlsx):**
```
كود المنتج | اسم المنتج | السعر | الكمية | المستودع
CH-001     | كرسي خشبي  | 250    | 20      | المخزن الرئيسي
TB-002     | طاولة حديد | 450    | 15      | المخزن الرئيسي
```

**الوضع المختار:** إضافة للموجود

**النتيجة:**
```
CH-001: 
  - السعر: 200 → 250 ✅
  - الكمية: 50 → 70 (50+20) ✅
  
TB-002: (جديد)
  - تم الإضافة بكمية 15 ✅
```

---

### مثال 2: جرد كامل

**الملف (inventory.xlsx):**
```
كود المنتج | اسم المنتج | السعر | الكمية | المستودع
CH-001     | كرسي خشبي  | 250    | 35      | المخزن الرئيسي
CH-002     | كرسي حديد  | 300    | 0       | المخزن الرئيسي
```

**الوضع المختار:** استبدال الكميات

**النتيجة:**
```
CH-001: 
  - الكمية الحالية: 70
  - معاملة خروج: -70 (تصفير)
  - معاملة دخول: +35
  - الكمية النهائية: 35 ✅
  
CH-002:
  - الكمية الحالية: 10
  - معاملة خروج: -10 (تصفير)
  - معاملة دخول: 0
  - الكمية النهائية: 0 ✅
```

---

### مثال 3: استيراد منتجات جديدة فقط

**الملف (new_products.xlsx):**
```
كود المنتج | اسم المنتج      | السعر | الكمية
CH-001     | كرسي خشبي (موجود)| 250    | 20
SOF-001    | صوفا جلد (جديد)  | 2500   | 10
BED-001    | سرير خشب (جديد)  | 3000   | 5
```

**الوضع المختار:** جديد فقط

**النتيجة:**
```
CH-001: ⏭️ تم التخطي (موجود مسبقاً)

SOF-001: ✅ تم الإضافة
  - الكمية: 10
  - السعر: 2500

BED-001: ✅ تم الإضافة
  - الكمية: 5
  - السعر: 3000
```

---

## 📈 تحسينات الأداء

تم تحسين النظام لتقليل الاستراحات/التوقفات:

### ما تم تحسينه:
1. ✅ تقليل عدد استعلامات قاعدة البيانات
2. ✅ استخدام bulk operations عند الإمكان
3. ✅ تقليل logging غير الضروري
4. ✅ إزالة حسابات الرصيد المتكررة (يتم في Signals)

### النتيجة:
- ⚡ رفع أسرع بكثير
- ⚡ لا توقفات ملحوظة في الترمنال
- ⚡ استهلاك أقل للذاكرة

---

## 🐛 استكشاف الأخطاء

### المشكلة: "المنتجات لا تُحدث"
**الحل:**
- تأكد أنك اخترت "إضافة للموجود" أو "استبدال"
- في وضع "جديد فقط"، المنتجات الموجودة تُتجاهل

### المشكلة: "الكميات تُضاف بدلاً من الاستبدال"
**الحل:**
- تأكد أنك اخترت "استبدال الكميات"
- راجع التقرير للتأكد من إنشاء معاملات التصفير

### المشكلة: "بطء في الرفع"
**الحل:**
- تأكد من استخدام أحدث نسخة
- قسّم الملف إلى ملفات أصغر (500-1000 صف)
- تجنب رفع ملفات ضخمة دفعة واحدة

---

## 📞 الدعم

إذا واجهت أي مشاكل:
1. راجع تقرير الرفع للأخطاء التفصيلية
2. تحقق من logs النظام
3. تأكد من صحة بيانات ملف Excel

---

**آخر تحديث:** 2025-10-20  
**الإصدار:** 2.0  
**الحالة:** ✅ جاهز للإنتاج
