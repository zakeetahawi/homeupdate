# ุฅุตูุงุญ ูุดููุฉ "too many clients already" ูู PostgreSQL

## ๐ **ููุฎุต ุงููุดููุฉ**
ูุงูุช ุงููุดููุฉ ุชุญุฏุซ ุจุณุจุจ:
- ุชุถุงุฑุจ ูู ุฅุนุฏุงุฏุงุช `CONN_MAX_AGE` ูู ูููุงุช ูุชุนุฏุฏุฉ
- ุนุฏุฏ ูุจูุฑ ูู ุนูุงู Gunicorn (4 ุนูุงู ร 100 ุงุชุตุงู = 400 ุงุชุตุงู ูุญุชูู)
- ุนุฏู ุฅุบูุงู ุงูุงุชุตุงูุงุช ุจุดูู ุตุญูุญ
- ููุงู Celery ุชูุชุญ ุงุชุตุงูุงุช ุฅุถุงููุฉ
- WebSocket Consumers ุชุณุชุฎุฏู `database_sync_to_async` ุจูุซุฑุฉ

## โ **ุงูุชุบููุฑุงุช ุงููุทุจูุฉ**

### **1. ุชูุญูุฏ ุฅุนุฏุงุฏุงุช ูุงุนุฏุฉ ุงูุจูุงูุงุช**
```python
# ูู crm/settings.py
DATABASES = {
    'default': {
        'CONN_MAX_AGE': 0,  # ุฅุบูุงู ููุฑู ููุงุชุตุงูุงุช
        'CONN_HEALTH_CHECKS': True,
        'OPTIONS': {
            'options': '-c statement_timeout=30000 -c idle_in_transaction_session_timeout=30000',
        },
    }
}
```

### **2. ุชุญุณูู Gunicorn**
```python
# ูู gunicorn_config.py
workers = 2                    # ูู 4 ุฅูู 2
worker_connections = 25        # ูู 100 ุฅูู 25
max_requests = 100            # ูู 500 ุฅูู 100
max_worker_age = 600          # ูู 1800 ุฅูู 600
```

### **3. ุฅุถุงูุฉ Connection Management Middleware**
- `EmergencyConnectionMiddleware` - ููุญุงูุงุช ุงูุญุฑุฌุฉ
- `DatabaseConnectionMiddleware` - ุฅุบูุงู ุงูุงุชุตุงูุงุช ุจุนุฏ ูู ุทูุจ
- `ConnectionMonitoringMiddleware` - ูุฑุงูุจุฉ ุงูุฃุฏุงุก

### **4. ุชุญุณูู Celery**
```python
# ูู crm/celery.py
broker_pool_limit = 5          # ูู 10 ุฅูู 5
worker_max_tasks_per_child = 20 # ูู 50 ุฅูู 20
database_engine_options = {
    'pool_size': 3,            # ุญุฏ ุฃูุตู 3 ุงุชุตุงูุงุช
    'pool_recycle': 180,       # 3 ุฏูุงุฆู
}
```

### **5. ุชุญุณูู ุงูููุงู ุงูุฏูุฑูุฉ**
- ุชูุธูู ุงูุงุชุตุงูุงุช: ูู 10 ุฏูุงุฆู (ุจุฏูุงู ูู 5)
- ูุฑุงูุจุฉ ุงูุงุชุตุงูุงุช: ูู 5 ุฏูุงุฆู (ุจุฏูุงู ูู 3)

## ๐๏ธ **ุงูุฃุฏูุงุช ุงูุฌุฏูุฏุฉ**

### **1. ุณูุฑูุจุช ุงูุฅุตูุงุญ ุงูุทุงุฑุฆ**
```bash
sudo bash scripts/emergency_db_fix.sh
```
- ููุชู ุงูุงุชุตุงูุงุช ุงูุฎุงููุฉ
- ูุญุณู ุฅุนุฏุงุฏุงุช PostgreSQL
- ูุนูุฏ ุชุดุบูู ุงูุฎุฏูุฉ

### **2. ุณูุฑูุจุช ูุฑุงูุจุฉ ุงูุงุชุตุงูุงุช**
```bash
# ูุฑุงูุจุฉ ูุณุชูุฑุฉ
bash scripts/monitor-connections.sh monitor

# ูุญุต ูุงุญุฏ
bash scripts/monitor-connections.sh check

# ุชูุธูู ุงูุงุชุตุงูุงุช ุงูุฎุงููุฉ
bash scripts/monitor-connections.sh cleanup

# ุชูุธูู ุทูุงุฑุฆ
bash scripts/monitor-connections.sh emergency
```

## ๐ **ุงููุชุงุฆุฌ ุงููุชููุนุฉ**

### **ูุจู ุงูุชุญุณูู:**
- ุนุฏุฏ ุงูุนูุงู: 4
- ุงุชุตุงูุงุช ููู ุนุงูู: 100
- ุฅุฌูุงูู ุงูุงุชุตุงูุงุช ุงููุญุชููุฉ: **400+**

### **ุจุนุฏ ุงูุชุญุณูู:**
- ุนุฏุฏ ุงูุนูุงู: 2
- ุงุชุตุงูุงุช ููู ุนุงูู: 25
- ุฅุฌูุงูู ุงูุงุชุตุงูุงุช ุงููุญุชููุฉ: **50**

**ุชุญุณู ุจูุณุจุฉ 87.5%** ๐

## ๐ **ุฎุทูุงุช ุงูุชุดุบูู**

### **1. ุฅุนุงุฏุฉ ุชุดุบูู ุงูุฎุฏูุงุช**
```bash
# ุฅููุงู ุงูุฎุฏูุงุช
pkill -f "daphne.*crm.asgi"
pkill -f "celery.*worker"
pkill -f "celery.*beat"

# ุชุดุบูู ุงูุฎุฏูุงุช ุงูุฌุฏูุฏุฉ
bash start-server.sh
```

### **2. ูุฑุงูุจุฉ ุงูุงุชุตุงูุงุช**
```bash
# ูู terminal ูููุตู
bash scripts/monitor-connections.sh monitor
```

### **3. ูุญุต ุงูุญุงูุฉ**
```bash
# ูุญุต ุนุฏุฏ ุงูุงุชุตุงูุงุช
sudo -u postgres psql -c "
SELECT count(*) as total_connections
FROM pg_stat_activity 
WHERE datname = 'crm_system';
"
```

## โ๏ธ **ุชุญุฐูุฑุงุช ูููุฉ**

### **1. ุฅุนุฏุงุฏุงุช PostgreSQL**
ุชุฃูุฏ ูู ุชุทุจูู ุงูุฅุนุฏุงุฏุงุช ุงูุฌุฏูุฏุฉ:
```sql
-- ูู postgresql.conf
max_connections = 200
idle_in_transaction_session_timeout = 30000
statement_timeout = 30000
```

### **2. ูุฑุงูุจุฉ ุงูุฃุฏุงุก**
- ุฑุงูุจ ุงูุงุชุตุงูุงุช ุจุงูุชุธุงู
- ุชุฃูุฏ ูู ุนุฏู ุชุฌุงูุฒ 70 ุงุชุตุงู
- ูู ุญุงูุฉ ุชุฌุงูุฒ 90 ุงุชุตุงูุ ุดุบู ุงูุชูุธูู ุงูุทุงุฑุฆ

### **3. ุฅุนุงุฏุฉ ุงูุชุดุบูู ุงูุฏูุฑู**
- ุฃุนุฏ ุชุดุบูู ุนูุงู Gunicorn ูู 10 ุฏูุงุฆู
- ุฃุนุฏ ุชุดุบูู ุนูุงู Celery ูู 20 ูููุฉ

## ๐ง **ุงุณุชูุดุงู ุงูุฃุฎุทุงุก**

### **ุฅุฐุง ุงุณุชูุฑุช ุงููุดููุฉ:**

1. **ูุญุต ุงูุงุชุตุงูุงุช:**
```bash
bash scripts/monitor-connections.sh top
```

2. **ุชูุธูู ุทูุงุฑุฆ:**
```bash
bash scripts/monitor-connections.sh emergency
```

3. **ุฅุนุงุฏุฉ ุชุดุบูู PostgreSQL:**
```bash
sudo systemctl restart postgresql
```

4. **ูุญุต ุงูุณุฌูุงุช:**
```bash
tail -f /tmp/db_connections_monitor.log
```

### **ุฅุฐุง ูุดู ุงูุชุดุบูู:**

1. **ุชุญูู ูู ุงูุฅุนุฏุงุฏุงุช:**
```bash
python manage.py check --deploy
```

2. **ุงุฎุชุจุฑ ุงูุงุชุตุงู:**
```bash
python manage.py dbshell
```

3. **ุฑุงุฌุน ุณุฌูุงุช Django:**
```bash
tail -f logs/django.log
```

## ๐ **ุงููุฑุญูุฉ ุงูุชุงููุฉ (ุงุฎุชูุงุฑูุฉ)**

### **ุชุซุจูุช pgbouncer ููุชุญุณูู ุงูุฅุถุงูู:**
```bash
sudo apt-get install pgbouncer
```

### **ุฅุนุฏุงุฏ Connection Pooling ูุชูุฏู:**
- ุชุซุจูุช pgbouncer
- ุฅุนุฏุงุฏ connection pooling
- ุชุญุณูู ุฅุนุฏุงุฏุงุช ุงูุดุจูุฉ

## ๐ **ุงูุฏุนู**

ูู ุญุงูุฉ ุงุณุชูุฑุงุฑ ุงููุดุงูู:
1. ุดุบู `bash scripts/monitor-connections.sh log`
2. ุงุญูุธ ุงูุณุฌูุงุช
3. ุดุงุฑู ุงููุชุงุฆุฌ ูููุฑุงุฌุนุฉ

---

# ๐ **ุชู ุฅููุงู ุฌููุน ุงููุฑุงุญู ุจูุฌุงุญ!**

## ๐ **ุงููุชุงุฆุฌ ุงูููุงุฆูุฉ:**

### **ูุจู ุงูุชุญุณูู:**
- ุนุฏุฏ ุงูุนูุงู: 4
- ุงุชุตุงูุงุช ููู ุนุงูู: 100
- ุฅุฌูุงูู ุงูุงุชุตุงูุงุช ุงููุญุชููุฉ: **400+**
- ุนุฏู ูุฌูุฏ connection pooling
- ุนุฏู ูุฌูุฏ ูุฑุงูุจุฉ

### **ุจุนุฏ ุงูุชุญุณูู ุงููุงูู:**
- ุนุฏุฏ ุงูุนูุงู: 2
- ุงุชุตุงูุงุช ููู ุนุงูู: 25
- PgBouncer connection pooling: 10 ุงุชุตุงูุงุช
- ุฅุฌูุงูู ุงูุงุชุตุงูุงุช ุงููุญุชููุฉ: **ุฃูู ูู 30**
- ูุฑุงูุจุฉ ูู ุงูููุช ุงููุนูู
- ุชูุธูู ุชููุงุฆู

**ุชุญุณู ุจูุณุจุฉ 92.5%** ๐

## ๐๏ธ **ุงูููุฒุงุช ุงูุฌุฏูุฏุฉ ุงููุถุงูุฉ:**

### **1. PgBouncer Connection Pooling**
- ุชุฌููุน ุงูุงุชุตุงูุงุช ุจููุงุกุฉ
- ุชูููู ุงูุญูู ุนูู PostgreSQL
- ุฅุฏุงุฑุฉ ุชููุงุฆูุฉ ููุงุชุตุงูุงุช

### **2. ูุธุงู ูุฑุงูุจุฉ ูุชูุฏู**
- ูุฑุงูุจุฉ ูู ุงูููุช ุงููุนูู
- ุชุญุฐูุฑุงุช ุชููุงุฆูุฉ
- ููุญุฉ ุชุญูู ููุจ
- API endpoints ูููุฑุงูุจุฉ

### **3. ุฎุฏูุงุช systemd**
- ูุฑุงูุจุฉ ุชููุงุฆูุฉ ูููุธุงู
- ุชูุธูู ุฏูุฑู ููุงุชุตุงูุงุช
- ุชุญุณูู ุฏูุฑู ููุงุนุฏุฉ ุงูุจูุงูุงุช
- ุฅุนุงุฏุฉ ุชุดุบูู ุชููุงุฆูุฉ

### **4. ุฃุฏูุงุช ุฅุฏุงุฑุฉ**
- Django management commands
- ุณูุฑูุจุชุงุช shell ูุชูุฏูุฉ
- ุฃุฏูุงุช ุชุดุฎูุต ูุฅุตูุงุญ

## ๐ **ููููุฉ ุงูุงุณุชุฎุฏุงู:**

### **1. ุชุดุบูู ุงููุธุงู ุงููุญุณู:**
```bash
# ุชุซุจูุช pgbouncer (ูุฑุฉ ูุงุญุฏุฉ)
sudo bash scripts/install_pgbouncer.sh

# ุฅุนุฏุงุฏ ุฎุฏูุงุช ุงููุฑุงูุจุฉ (ูุฑุฉ ูุงุญุฏุฉ)
sudo bash scripts/setup_monitoring_service.sh

# ุชุดุบูู ุงููุธุงู
bash start-server.sh
```

### **2. ูุฑุงูุจุฉ ุงููุธุงู:**
```bash
# ููุญุฉ ุงูุชุญูู ุงูููุจ
https://elkhawaga.uk/monitoring/

# ูุฑุงูุจุฉ ูู ุณุทุฑ ุงูุฃูุงูุฑ
python manage.py monitor_db

# ูุญุต ุณุฑูุน
bash scripts/monitor-connections.sh check
```

### **3. ุฅุฏุงุฑุฉ ุงูุฎุฏูุงุช:**
```bash
# ุฅุฏุงุฑุฉ ุฌููุน ุงูุฎุฏูุงุช
homeupdate-services status
homeupdate-services restart

# ุฅุฏุงุฑุฉ ุฎุฏูุฉ ูุงุญุฏุฉ
systemctl status homeupdate-db-monitor
```

### **4. ุชุญุณูู ูุงุนุฏุฉ ุงูุจูุงูุงุช:**
```bash
# ุชุญุณูู ุดุงูู
python manage.py optimize_db --all

# ุชูุธูู ููุท
python manage.py monitor_db --cleanup
```

## ๐ **API Endpoints:**

- `GET /api/monitoring/status/` - ุญุงูุฉ ุงููุฑุงูุจุฉ ุงูุนุงูุฉ
- `GET /api/monitoring/database/` - ุฅุญุตุงุฆูุงุช ูุงุนุฏุฉ ุงูุจูุงูุงุช
- `GET /api/monitoring/system/` - ุฅุญุตุงุฆูุงุช ุงููุธุงู
- `GET /api/monitoring/health/` - ูุญุต ุตุญุฉ ุงููุธุงู
- `POST /api/monitoring/actions/` - ุชูููุฐ ุฅุฌุฑุงุกุงุช

## ๐ง **ุงูุตูุงูุฉ ุงูุฏูุฑูุฉ:**

### **ุชููุงุฆูุฉ:**
- ุชูุธูู ุงูุงุชุตุงูุงุช: ูู 10 ุฏูุงุฆู
- ุชุญุณูู ูุงุนุฏุฉ ุงูุจูุงูุงุช: ููููุงู
- ูุฑุงูุจุฉ ูุณุชูุฑุฉ: ูู 30 ุซุงููุฉ

### **ูุฏููุฉ (ุดูุฑูุงู):**
```bash
# ุชุญุณูู ุดุงูู
python manage.py optimize_db --all

# ูุญุต ุงูุณุฌูุงุช
journalctl -u homeupdate-db-monitor --since "1 week ago"

# ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช
python manage.py monitor_db --stats
```

## ๐จ **ุงุณุชูุดุงู ุงูุฃุฎุทุงุก:**

### **ุฅุฐุง ุนุงุฏุช ุงููุดููุฉ:**
1. ูุญุต ุญุงูุฉ pgbouncer: `systemctl status pgbouncer`
2. ูุญุต ุงูุณุฌูุงุช: `journalctl -u homeupdate-db-monitor -f`
3. ุชูุธูู ุทูุงุฑุฆ: `python manage.py monitor_db --emergency`
4. ุฅุนุงุฏุฉ ุชุดุบูู ุงูุฎุฏูุงุช: `homeupdate-services restart`

### **ูุฑุงูุจุฉ ุงูุฃุฏุงุก:**
- ููุญุฉ ุงูุชุญูู: https://elkhawaga.uk/monitoring/
- ูุญุต ุตุญุฉ ุงููุธุงู: `/api/monitoring/health/`
- ุณุฌูุงุช ุงููุธุงู: `/tmp/db_connections_monitor.log`

---

**๐ ุงููุธุงู ุงูุขู ูุญุณู ุจุงููุงูู ููุญูู ูู ูุดููุฉ "too many clients already"!**

**ุงูุนุฏุฏ ุงููุชููุน ููุงุชุตุงูุงุช: ุฃูู ูู 30 ุงุชุตุงู (ุจุฏูุงู ูู 400+)**
