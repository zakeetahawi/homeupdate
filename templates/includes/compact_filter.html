{% load static %}
<!-- Compact Filter Component -->
<div class="cf-component">
    <div class="cf-header" onclick="toggleFilters()">
        <div class="cf-header-right">
            <div class="cf-icon-wrap">
                <i class="fas fa-sliders-h"></i>
            </div>
            <span class="cf-header-text">فلاتر البحث</span>
            {% if has_active_filters %}<span class="cf-badge">{{ active_filters_count }}</span>{% endif %}
        </div>
        <div class="cf-header-left">
            {% if has_active_filters %}
                <button type="button" class="cf-clear-btn" onclick="clearAllFilters(event)">
                    <i class="fas fa-eraser me-1"></i>مسح
                </button>
            {% endif %}
            <i class="fas fa-chevron-down cf-toggle-arrow" id="cfToggleArrow"></i>
        </div>
    </div>

    <!-- الفلاتر النشطة - تظهر دائماً فوق المحتوى -->
    {% if has_active_filters %}
    <div class="cf-active-bar">
        {% if selected_year %}
            <span class="cf-chip"><i class="fas fa-calendar-alt me-1"></i>{{ selected_year }}<button type="button" onclick="removeFilter('year')" class="cf-chip-x">&times;</button></span>
        {% endif %}
        {% if selected_month %}
            <span class="cf-chip"><i class="fas fa-calendar-day me-1"></i>شهر {{ selected_month }}<button type="button" onclick="removeFilter('month')" class="cf-chip-x">&times;</button></span>
        {% endif %}
        {% if search_query %}
            <span class="cf-chip cf-chip-search"><i class="fas fa-search me-1"></i>"{{ search_query }}"<button type="button" onclick="removeFilter('search')" class="cf-chip-x">&times;</button></span>
        {% endif %}
        {% block active_filter_tags %}{% endblock %}
    </div>
    {% endif %}

    <div class="cf-body" id="filterContent"
         style="display: {% if has_active_filters %}block{% else %}none{% endif %}">
        <form method="get" id="filterForm" class="cf-form">
            <!-- كل الحقول في صف واحد -->
            <div class="cf-filters-grid">
                <div class="cf-field cf-field-search">
                    <label class="cf-label">بحث</label>
                    <div class="cf-search-wrap">
                        <i class="fas fa-search cf-search-icon"></i>
                        <input type="text"
                               name="search"
                               class="cf-search-input"
                               placeholder="رقم الطلب، العميل..."
                               value="{{ search_query }}"
                               autocomplete="off"
                               dir="auto">
                    </div>
                </div>
                <div class="cf-field">
                    <label class="cf-label">السنة</label>
                    <select name="year" class="cf-select">
                        <option value="">الكل</option>
                        {% for year in available_years %}
                            <option value="{{ year }}" {% if selected_year == year|stringformat:'s' %}selected{% endif %}>{{ year }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="cf-field">
                    <label class="cf-label">الشهر</label>
                    <select name="month" class="cf-select">
                        <option value="">الكل</option>
                        <option value="1" {% if selected_month == '1' %}selected{% endif %}>يناير</option>
                        <option value="2" {% if selected_month == '2' %}selected{% endif %}>فبراير</option>
                        <option value="3" {% if selected_month == '3' %}selected{% endif %}>مارس</option>
                        <option value="4" {% if selected_month == '4' %}selected{% endif %}>أبريل</option>
                        <option value="5" {% if selected_month == '5' %}selected{% endif %}>مايو</option>
                        <option value="6" {% if selected_month == '6' %}selected{% endif %}>يونيو</option>
                        <option value="7" {% if selected_month == '7' %}selected{% endif %}>يوليو</option>
                        <option value="8" {% if selected_month == '8' %}selected{% endif %}>أغسطس</option>
                        <option value="9" {% if selected_month == '9' %}selected{% endif %}>سبتمبر</option>
                        <option value="10" {% if selected_month == '10' %}selected{% endif %}>أكتوبر</option>
                        <option value="11" {% if selected_month == '11' %}selected{% endif %}>نوفمبر</option>
                        <option value="12" {% if selected_month == '12' %}selected{% endif %}>ديسمبر</option>
                    </select>
                </div>

                {% block additional_filters %}{% endblock %}

                <div class="cf-field">
                    <label class="cf-label">نتائج/صفحة</label>
                    <select name="page_size" class="cf-select">
                        <option value="10" {% if request.GET.page_size == '10' %}selected{% endif %}>10</option>
                        <option value="25" {% if request.GET.page_size == '25' or not request.GET.page_size %}selected{% endif %}>25</option>
                        <option value="50" {% if request.GET.page_size == '50' %}selected{% endif %}>50</option>
                        <option value="100" {% if request.GET.page_size == '100' %}selected{% endif %}>100</option>
                    </select>
                </div>
                <div class="cf-field cf-field-submit">
                    <label class="cf-label">&nbsp;</label>
                    <button type="submit" class="cf-search-btn">
                        <i class="fas fa-search me-1"></i>بحث
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<style>
/* ========== Compact Filter — Theme-Aware ========== */
.cf-component {
    background: var(--card-bg, #fff);
    border: 1px solid var(--border, #DED5CE);
    border-radius: var(--radius-large, 12px);
    margin-bottom: 1rem;
    box-shadow: 0 1px 4px rgba(0,0,0,0.04);
    overflow: hidden;
}

/* ---- Header ---- */
.cf-header {
    padding: 0.6rem 0.85rem;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    user-select: none;
    background: var(--surface, #F8F8F8);
    transition: background 0.15s;
}
.cf-header:hover {
    background: rgba(139,115,90,0.06);
}
.cf-header-right,
.cf-header-left {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}
.cf-icon-wrap {
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
    background: var(--primary, #8B735A);
    color: #fff;
    font-size: 0.72rem;
}
.cf-header-text {
    font-weight: 600;
    font-size: 0.85rem;
    color: var(--text-primary, #3D3427);
}
.cf-badge {
    background: var(--primary, #8B735A);
    color: #fff;
    border-radius: 10px;
    min-width: 18px;
    height: 18px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 0.65rem;
    font-weight: 700;
    padding: 0 5px;
}
.cf-clear-btn {
    background: none;
    border: 1px solid var(--border, #DED5CE);
    color: var(--text-tertiary, #8B8178);
    font-size: 0.72rem;
    padding: 0.15rem 0.5rem;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.15s;
}
.cf-clear-btn:hover {
    background: #dc3545;
    color: #fff;
    border-color: #dc3545;
}
.cf-toggle-arrow {
    color: var(--text-tertiary, #8B8178);
    font-size: 0.7rem;
    transition: transform 0.25s;
}

/* ---- Active Filters Bar ---- */
.cf-active-bar {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 0.35rem;
    padding: 0.4rem 0.85rem;
    border-top: 1px solid var(--separator, #E8DCCA);
    background: rgba(139,115,90,0.03);
}
.cf-chip {
    display: inline-flex;
    align-items: center;
    gap: 0.2rem;
    background: var(--primary, #8B735A);
    color: #fff;
    padding: 0.15rem 0.5rem;
    border-radius: 14px;
    font-size: 0.7rem;
    font-weight: 500;
    white-space: nowrap;
}
.cf-chip-search { background: #198754; }
.cf-chip-status { background: #6c757d; }
.cf-chip-type   { background: #6f42c1; }
.cf-chip-branch { background: #fd7e14; }
.cf-chip-person { background: #0dcaf0; color: #000; }
.cf-chip-vip    { background: #ffc107; color: #000; }
.cf-chip-date   { background: #6c757d; }
.cf-chip-x {
    background: rgba(255,255,255,0.25);
    border: none;
    color: inherit;
    cursor: pointer;
    font-size: 0.82rem;
    line-height: 1;
    width: 15px;
    height: 15px;
    border-radius: 50%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0;
    margin-right: 2px;
    transition: background 0.12s;
}
.cf-chip-x:hover {
    background: rgba(255,255,255,0.45);
}

/* ---- Body ---- */
.cf-body {
    border-top: 1px solid var(--border, #DED5CE);
    padding: 0.85rem;
    background: var(--card-bg, #fff);
}
.cf-form {
    display: flex;
    flex-direction: column;
    gap: 0;
}

/* ---- Search Field ---- */
.cf-field-search {
    flex: 0 0 auto;
}
.cf-search-wrap {
    position: relative;
}
.cf-search-icon {
    position: absolute;
    right: 0.65rem;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-tertiary, #8B8178);
    font-size: 0.78rem;
    pointer-events: none;
}
.cf-search-input {
    width: 160px;
    padding: 0.35rem 2rem 0.35rem 0.65rem;
    border: 1px solid var(--border, #DED5CE);
    border-radius: 6px;
    font-size: 0.8rem;
    color: var(--text-primary, #3D3427);
    background: var(--card-bg, #fff);
    transition: border-color 0.15s, box-shadow 0.15s;
}
.cf-search-input:focus {
    border-color: var(--primary, #8B735A);
    outline: 0;
    box-shadow: 0 0 0 3px rgba(139,115,90,0.1);
}
.cf-search-input::placeholder {
    color: var(--text-tertiary, #8B8178);
    font-size: 0.8rem;
}
.cf-search-btn {
    background: var(--primary, #8B735A);
    color: #fff;
    border: none;
    border-radius: 6px;
    padding: 0.35rem 0.7rem;
    font-size: 0.8rem;
    font-weight: 600;
    cursor: pointer;
    white-space: nowrap;
    transition: background 0.15s;
}
.cf-search-btn:hover {
    background: var(--accent, #5F4B32);
}

/* ---- Filters Grid ---- */
.cf-filters-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 0.55rem;
    align-items: end;
}
.cf-field {
    display: flex;
    flex-direction: column;
    min-width: 0;
    flex: 0 0 auto;
}
.cf-label {
    font-size: 0.7rem;
    font-weight: 600;
    color: var(--text-tertiary, #8B8178);
    margin-bottom: 0.15rem;
    text-transform: uppercase;
    letter-spacing: 0.02em;
}
.cf-select,
.cf-input {
    padding: 0.35rem 0.45rem;
    border: 1px solid var(--border, #DED5CE);
    border-radius: 6px;
    font-size: 0.8rem;
    color: var(--text-primary, #3D3427);
    background: var(--card-bg, #fff);
    min-width: 80px;
    width: auto;
    transition: border-color 0.15s, box-shadow 0.15s;
    appearance: auto;
}
.cf-select:focus,
.cf-input:focus {
    border-color: var(--primary, #8B735A);
    outline: 0;
    box-shadow: 0 0 0 2px rgba(139,115,90,0.1);
}

/* ---- Responsive ---- */
@media (max-width: 768px) {
    .cf-header { padding: 0.5rem 0.65rem; }
    .cf-body { padding: 0.65rem; }
    .cf-filters-grid { gap: 0.45rem; }
    .cf-search-input { width: 100%; }
    .cf-search-btn { padding: 0.35rem 0.8rem; }
    .cf-field { flex: 1 1 calc(50% - 0.25rem); min-width: 0; }
    .cf-select, .cf-input { width: 100%; }
}
@media (max-width: 480px) {
    .cf-field { flex: 1 1 100%; }
}
</style>

<script>
function toggleFilters() {
    const content = document.getElementById('filterContent');
    const arrow = document.getElementById('cfToggleArrow');
    if (content.style.display === 'none') {
        content.style.display = 'block';
        arrow.style.transform = 'rotate(180deg)';
    } else {
        content.style.display = 'none';
        arrow.style.transform = 'rotate(0deg)';
    }
}

function clearAllFilters(event) {
    event.stopPropagation();
    const form = document.getElementById('filterForm');
    const inputs = form.querySelectorAll('input, select');
    inputs.forEach(input => {
        if (input.name !== 'page_size') input.value = '';
    });
    form.submit();
}

function removeFilter(filterName) {
    const form = document.getElementById('filterForm');
    const input = form.querySelector('[name="' + filterName + '"]');
    if (input) {
        input.value = '';
        form.submit();
    }
}
</script>
