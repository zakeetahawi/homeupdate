<!-- القائمة الجانبية للمستخدمين النشطين -->
<div id="online-users-sidebar" class="online-users-sidebar">
    <div class="sidebar-header">
        <h6 class="sidebar-title">
            <i class="fas fa-circle text-success me-2"></i>
            المستخدمون النشطون
            <span id="online-count-badge" class="badge bg-success ms-2">0</span>
        </h6>
        <button class="sidebar-toggle" onclick="toggleOnlineUsersSidebar()">
            <i class="fas fa-times"></i>
        </button>
    </div>
    
    <div class="sidebar-content">
        <div class="refresh-section">
            <button class="refresh-btn" onclick="refreshOnlineUsersList()" id="refresh-online-btn">
                <i class="fas fa-sync-alt me-1"></i>
                تحديث
            </button>
            <div class="last-update" id="last-update-time">
                آخر تحديث: --:--:--
            </div>
        </div>
        
        <div id="online-users-list" class="users-list">
            <!-- سيتم تحميل المستخدمين هنا -->
            <div class="loading-state">
                <i class="fas fa-spinner fa-spin"></i>
                <p>جاري التحميل...</p>
            </div>
        </div>
    </div>
</div>

<!-- الزر العائم للمستخدمين النشطين -->
<button id="online-users-trigger" class="online-users-trigger floating-draggable" onclick="toggleOnlineUsersSidebar()">
    <i class="fas fa-users"></i>
    <span class="trigger-badge" id="trigger-count-badge">0</span>
</button>

<style>
/* القائمة الجانبية */
.online-users-sidebar {
    position: fixed;
    top: 0;
    left: -350px;
    width: 350px;
    height: 100vh;
    background: white;
    box-shadow: 2px 0 15px rgba(0, 0, 0, 0.1);
    z-index: 1050;
    transition: left 0.3s ease;
    display: flex;
    flex-direction: column;
}

.online-users-sidebar.active {
    left: 0;
}

.sidebar-header {
    padding: 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    display: flex;
    justify-content: between;
    align-items: center;
    flex-shrink: 0;
}

.sidebar-title {
    margin: 0;
    font-size: 1.1rem;
    font-weight: 600;
    flex-grow: 1;
}

.sidebar-toggle {
    background: none;
    border: none;
    color: white;
    font-size: 1.2rem;
    cursor: pointer;
    padding: 5px;
    border-radius: 4px;
    transition: background 0.3s ease;
}

.sidebar-toggle:hover {
    background: rgba(255, 255, 255, 0.2);
}

.sidebar-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.refresh-section {
    padding: 15px 20px;
    border-bottom: 1px solid #e9ecef;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-shrink: 0;
}

.refresh-btn {
    background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    color: white;
    border: none;
    border-radius: 6px;
    padding: 6px 12px;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.refresh-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(67, 233, 123, 0.3);
}

.refresh-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

.last-update {
    font-size: 0.75rem;
    color: #6c757d;
}

.users-list {
    flex: 1;
    overflow-y: auto;
    padding: 10px 0;
}

.user-item {
    padding: 12px 20px;
    border-bottom: 1px solid #f1f3f4;
    transition: background 0.3s ease;
    cursor: pointer;
}

.user-item:hover {
    background: #f8f9fa;
}

.user-item:last-child {
    border-bottom: none;
}

.user-info {
    display: flex;
    align-items: center;
}

.user-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    object-fit: cover;
    margin-left: 12px;
    border: 2px solid #e9ecef;
}

.user-avatar.placeholder {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 0.9rem;
}

.user-details {
    flex: 1;
    min-width: 0;
}

.user-name {
    font-weight: 600;
    font-size: 0.9rem;
    color: #333;
    margin-bottom: 2px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.user-role {
    font-size: 0.75rem;
    color: #6c757d;
    margin-bottom: 2px;
}

.user-status {
    font-size: 0.75rem;
    color: #28a745;
    display: flex;
    align-items: center;
}

.user-status i {
    margin-left: 4px;
    animation: pulse 2s infinite;
}

.user-page {
    font-size: 0.7rem;
    color: #6c757d;
    margin-top: 2px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.user-stats {
    display: flex;
    gap: 8px;
    margin-top: 4px;
}

.stat-item {
    background: #f8f9fa;
    padding: 2px 6px;
    border-radius: 10px;
    font-size: 0.7rem;
    color: #6c757d;
}

/* الزر العائم للمستخدمين النشطين */
.online-users-trigger {
    position: fixed;
    top: 60px;
    right: 20px;
    width: 50px;
    height: 50px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 50%;
    box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
    cursor: move;
    transition: all 0.3s ease;
    z-index: 1040;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.1rem;
}

.online-users-trigger:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 25px rgba(102, 126, 234, 0.4);
}

.online-users-trigger.dragging {
    opacity: 0.8;
    transform: scale(1.1) rotate(5deg);
    z-index: 1041;
}

.trigger-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background: #dc3545;
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    font-size: 0.7rem;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
}

/* حالات خاصة */
.loading-state, .empty-state {
    text-align: center;
    padding: 40px 20px;
    color: #6c757d;
}

.loading-state i {
    font-size: 2rem;
    margin-bottom: 10px;
    color: #667eea;
}

.empty-state i {
    font-size: 2rem;
    margin-bottom: 10px;
    color: #6c757d;
}

/* تأثير النبض */
@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

/* تجاوبية */
@media (max-width: 768px) {
    .online-users-sidebar {
        width: 100%;
        left: -100%;
    }
    
    .online-users-trigger {
        top: 50px;
        right: 10px;
        width: 45px;
        height: 45px;
        font-size: 1rem;
    }
}

/* Overlay للخلفية */
.sidebar-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1049;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
}

.sidebar-overlay.active {
    opacity: 1;
    visibility: visible;
}
</style>

<script>
// متغيرات عامة
let onlineUsersSidebarOpen = false;
let refreshInterval;

// فتح/إغلاق القائمة الجانبية
function toggleOnlineUsersSidebar() {
    const sidebar = document.getElementById('online-users-sidebar');
    const overlay = document.getElementById('sidebar-overlay') || createOverlay();
    
    onlineUsersSidebarOpen = !onlineUsersSidebarOpen;
    
    if (onlineUsersSidebarOpen) {
        sidebar.classList.add('active');
        overlay.classList.add('active');
        document.body.style.overflow = 'hidden';
        
        // تحميل البيانات عند فتح القائمة
        refreshOnlineUsersList();
        
        // بدء التحديث التلقائي
        startAutoRefresh();
    } else {
        sidebar.classList.remove('active');
        overlay.classList.remove('active');
        document.body.style.overflow = '';
        
        // إيقاف التحديث التلقائي
        stopAutoRefresh();
    }
}

// إنشاء overlay للخلفية
function createOverlay() {
    const overlay = document.createElement('div');
    overlay.id = 'sidebar-overlay';
    overlay.className = 'sidebar-overlay';
    overlay.onclick = toggleOnlineUsersSidebar;
    document.body.appendChild(overlay);
    return overlay;
}

// تحديث قائمة المستخدمين النشطين
function refreshOnlineUsersList() {
    const refreshBtn = document.getElementById('refresh-online-btn');
    const usersList = document.getElementById('online-users-list');
    const countBadge = document.getElementById('online-count-badge');
    const triggerBadge = document.getElementById('trigger-count-badge');
    const lastUpdateTime = document.getElementById('last-update-time');
    
    // إظهار حالة التحميل
    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>جاري التحديث...';
    refreshBtn.disabled = true;
    
    fetch('/accounts/api/online-users/')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // تحديث العدادات
                countBadge.textContent = data.total_online;
                triggerBadge.textContent = data.total_online;
                
                // تحديث وقت آخر تحديث
                lastUpdateTime.textContent = `آخر تحديث: ${data.timestamp}`;
                
                // تحديث قائمة المستخدمين
                if (data.users.length > 0) {
                    usersList.innerHTML = data.users.map(user => `
                        <div class="user-item" onclick="viewUserActivity(${user.id})">
                            <div class="user-info">
                                ${user.avatar_url ? 
                                    `<img src="${user.avatar_url}" alt="${user.username}" class="user-avatar">` :
                                    `<div class="user-avatar placeholder">${user.username.charAt(0).toUpperCase()}</div>`
                                }
                                <div class="user-details">
                                    <div class="user-name">${user.full_name}</div>
                                    <div class="user-role">${user.role}</div>
                                    <div class="user-status">
                                        <i class="fas fa-circle"></i>
                                        متصل منذ ${user.online_duration}
                                    </div>
                                    ${user.current_page ? `<div class="user-page"><i class="fas fa-eye me-1"></i>${user.current_page}</div>` : ''}
                                    <div class="user-stats">
                                        <span class="stat-item">${user.pages_visited} صفحة</span>
                                        <span class="stat-item">${user.actions_performed} عملية</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    usersList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-users"></i>
                            <p>لا يوجد مستخدمون متصلون حالياً</p>
                        </div>
                    `;
                }
            } else {
                usersList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>خطأ في تحميل البيانات</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('خطأ في تحديث المستخدمين النشطين:', error);
            usersList.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-wifi"></i>
                    <p>خطأ في الاتصال</p>
                </div>
            `;
        })
        .finally(() => {
            // إعادة تعيين زر التحديث
            refreshBtn.innerHTML = '<i class="fas fa-sync-alt me-1"></i>تحديث';
            refreshBtn.disabled = false;
        });
}

// عرض نشاط المستخدم
function viewUserActivity(userId) {
    window.open(`/accounts/activity/user/${userId}/`, '_blank');
}

// بدء التحديث التلقائي
function startAutoRefresh() {
    refreshInterval = setInterval(refreshOnlineUsersList, 30000); // كل 30 ثانية
}

// إيقاف التحديث التلقائي
function stopAutoRefresh() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
        refreshInterval = null;
    }
}

// جعل الزر العائم قابلاً للسحب
function initDraggableButton() {
    const trigger = document.getElementById('online-users-trigger');
    if (!trigger) return;

    let isDragging = false;
    let startX, startY, startLeft, startTop;

    // تحميل الموقع المحفوظ
    loadButtonPosition();

    trigger.addEventListener('mousedown', function(e) {
        // التأكد من أن النقر ليس على الشريط الجانبي
        if (document.getElementById('online-users-sidebar').classList.contains('active')) {
            return;
        }

        isDragging = true;
        trigger.classList.add('dragging');

        startX = e.clientX;
        startY = e.clientY;

        const rect = trigger.getBoundingClientRect();
        startLeft = rect.left;
        startTop = rect.top;

        e.preventDefault();
        e.stopPropagation();
    });

    document.addEventListener('mousemove', function(e) {
        if (!isDragging) return;

        const deltaX = e.clientX - startX;
        const deltaY = e.clientY - startY;

        let newLeft = startLeft + deltaX;
        let newTop = startTop + deltaY;

        // التأكد من عدم خروج الزر من الشاشة
        const maxLeft = window.innerWidth - trigger.offsetWidth;
        const maxTop = window.innerHeight - trigger.offsetHeight;

        newLeft = Math.max(0, Math.min(newLeft, maxLeft));
        newTop = Math.max(0, Math.min(newTop, maxTop));

        trigger.style.left = newLeft + 'px';
        trigger.style.top = newTop + 'px';
        trigger.style.right = 'auto';
        trigger.style.bottom = 'auto';

        e.preventDefault();
    });

    document.addEventListener('mouseup', function(e) {
        if (isDragging) {
            isDragging = false;
            trigger.classList.remove('dragging');

            // حفظ الموقع الجديد
            saveButtonPosition();
        }
    });
}

// حفظ موقع الزر
function saveButtonPosition() {
    const trigger = document.getElementById('online-users-trigger');
    const rect = trigger.getBoundingClientRect();
    const position = {
        left: rect.left,
        top: rect.top
    };

    localStorage.setItem('online-users-trigger-position', JSON.stringify(position));
}

// تحميل موقع الزر المحفوظ
function loadButtonPosition() {
    const trigger = document.getElementById('online-users-trigger');
    const savedPosition = localStorage.getItem('online-users-trigger-position');

    if (savedPosition) {
        const position = JSON.parse(savedPosition);
        trigger.style.left = position.left + 'px';
        trigger.style.top = position.top + 'px';
        trigger.style.right = 'auto';
        trigger.style.bottom = 'auto';
    }
}

// تحديث أولي عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', function() {
    // تحديث العداد في الزر
    refreshOnlineUsersList();

    // تهيئة الزر القابل للسحب
    initDraggableButton();

    // تحديث دوري للعداد فقط (كل دقيقة)
    setInterval(() => {
        if (!onlineUsersSidebarOpen) {
            fetch('/accounts/api/online-users/')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('trigger-count-badge').textContent = data.total_online;
                    }
                })
                .catch(error => console.error('خطأ في تحديث العداد:', error));
        }
    }, 60000);
});

// إغلاق القائمة عند الضغط على Escape
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && onlineUsersSidebarOpen) {
        toggleOnlineUsersSidebar();
    }
});
</script>
