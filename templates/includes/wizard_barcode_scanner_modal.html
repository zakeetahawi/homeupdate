{% load static %}

<!-- Modal Bootstrap Ù„Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙÙŠ Ø§Ù„ÙˆÙŠØ²Ø§Ø±Ø¯ -->
<div class="modal fade" id="wizardBarcodeScannerModal" tabindex="-1" aria-labelledby="wizardBarcodeScannerLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content border-0 shadow-lg" style="background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px); border-radius: 20px;">
            <!-- Ø±Ø£Ø³ Ø§Ù„Modal -->
            <div class="modal-header border-0" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 20px 20px 0 0;">
                <h5 class="modal-title text-white fw-bold" id="wizardBarcodeScannerLabel">
                    <i class="fas fa-barcode me-2"></i>
                    ÙØ­Øµ Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙˆØ¥Ø¶Ø§ÙØ© Ù„Ù„Ø·Ù„Ø¨
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Ø¥ØºÙ„Ø§Ù‚"></button>
            </div>
            
            <!-- Ø¬Ø³Ù… Ø§Ù„Modal -->
            <div class="modal-body p-4">
                
                <!-- Ø·Ù„Ø¨ Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª -->
                <div class="alert alert-info border-0 shadow-sm d-none" id="wizardPermissionRequest" style="border-radius: 15px; background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);">
                    <div class="text-center">
                        <i class="fas fa-camera fa-3x mb-3" style="color: #1976d2;"></i>
                        <h5 class="fw-bold" style="color: #0d47a1;">Ù†Ø­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø¥Ø°Ù† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</h5>
                        <p class="mb-3" style="color: #1565c0;">Ù„Ù„ÙØ­Øµ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</p>
                        <button class="btn btn-primary btn-lg shadow" id="wizardRequestPermissionBtn" style="border-radius: 10px;">
                            <i class="fas fa-check-circle me-2"></i> Ù…Ù†Ø­ Ø§Ù„Ø¥Ø°Ù†
                        </button>
                    </div>
                </div>
                
                <!-- ØªÙ†Ø¨ÙŠÙ‡ HTTPS -->
                <div class="alert alert-warning border-0 shadow-sm d-none" id="wizardHttpsWarning" style="border-radius: 15px;">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-exclamation-triangle fa-2x me-3" style="color: #f57c00;"></i>
                        <div>
                            <strong>ØªÙ†Ø¨ÙŠÙ‡:</strong> Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØªØ¹Ù…Ù„ ÙÙ‚Ø· Ø¹Ù„Ù‰:
                            <br>â€¢ <strong>HTTPS</strong> (Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ø¢Ù…Ù†)
                            <br>â€¢ <strong>localhost</strong> (Ø§Ù„ØªØ·ÙˆÙŠØ± Ø§Ù„Ù…Ø­Ù„ÙŠ)
                            <br>Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙŠØ¯ÙˆÙŠ Ø£Ùˆ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø°Ù„Ùƒ.
                        </div>
                    </div>
                </div>
                
                <!-- Ø®Ø·Ø£ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ -->
                <div class="alert alert-danger border-0 shadow-sm d-none" id="wizardCameraError" style="border-radius: 15px;">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-times-circle fa-2x me-3" style="color: #d32f2f;"></i>
                        <div>
                            <strong>ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</strong>
                            <br>Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙŠØ¯ÙˆÙŠ Ø£Ùˆ Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯.
                        </div>
                    </div>
                </div>
                
                <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… -->
                <div class="d-flex gap-2 justify-content-center mb-3">
                    <button class="btn btn-success btn-lg shadow" id="wizardStartCameraBtn" style="border-radius: 12px; min-width: 150px;">
                        <i class="fas fa-camera me-2"></i> ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
                    </button>
                    <button class="btn btn-danger btn-lg shadow d-none" id="wizardStopCameraBtn" style="border-radius: 12px; min-width: 150px;">
                        <i class="fas fa-stop me-2"></i> Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
                    </button>
                </div>
                
                <!-- Ø¹Ù†ØµØ± Ø§Ù„Ù‚Ø§Ø±Ø¦ -->
                <div id="wizardBarcodeReader" class="d-none mb-3" style="border-radius: 15px; overflow: hidden; border: 3px solid #667eea; box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);"></div>
                
                <!-- Ø®ÙŠØ§Ø± Ø±ÙØ¹ ØµÙˆØ±Ø© -->
                <div class="card border-0 shadow-sm mb-3" style="border-radius: 15px; background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);">
                    <div class="card-body text-center py-4">
                        <p class="mb-3 fw-bold" style="color: #1976d2;">
                            <i class="fas fa-image fa-2x mb-2 d-block"></i>
                            Ø£Ùˆ Ø§Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
                        </p>
                        <input type="file" id="wizardImageInput" accept="image/*" capture="environment" style="display: none;">
                        <label for="wizardImageInput" class="btn btn-primary btn-lg shadow" style="border-radius: 10px; cursor: pointer;">
                            <i class="fas fa-upload me-2"></i> Ø§Ø®ØªØ± ØµÙˆØ±Ø©
                        </label>
                    </div>
                </div>
                
                <!-- Ø®ÙŠØ§Ø± Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙŠØ¯ÙˆÙŠ -->
                <div class="card border-0 shadow-sm" style="border-radius: 15px; background: linear-gradient(135deg, #f3e5f5 0%, #fce4ec 100%);">
                    <div class="card-body">
                        <label class="form-label fw-bold mb-3" style="color: #6a1b9a;">
                            <i class="fas fa-keyboard me-2"></i>
                            Ø£Ùˆ Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†ØªØ¬ ÙŠØ¯ÙˆÙŠØ§Ù‹
                        </label>
                        <div class="input-group input-group-lg">
                            <input type="text" 
                                   id="wizardManualBarcodeInput" 
                                   class="form-control shadow-sm" 
                                   placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ù‡Ù†Ø§..."
                                   autocomplete="off"
                                   style="border-radius: 10px 0 0 10px; border: 2px solid #ce93d8;">
                            <button class="btn btn-primary shadow" id="wizardManualScanBtn" style="border-radius: 0 10px 10px 0; min-width: 100px;">
                                <i class="fas fa-search me-2"></i> Ø¨Ø­Ø«
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Ø­Ø§Ù„Ø© Ø§Ù„ÙØ­Øµ -->
                <div id="wizardScanStatus" class="mt-3"></div>
                
            </div>
            
            <!-- ØªØ°ÙŠÙŠÙ„ Ø§Ù„Modal -->
            <div class="modal-footer border-0 bg-light" style="border-radius: 0 0 20px 20px;">
                <button type="button" class="btn btn-secondary shadow" data-bs-dismiss="modal" style="border-radius: 10px;">
                    <i class="fas fa-times me-2"></i> Ø¥ØºÙ„Ø§Ù‚
                </button>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript Ù„Ù„Modal -->
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<script>
// Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ ÙƒÙ„ Ø´ÙŠØ¡
(function() {
    'use strict';
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Bootstrap
    if (typeof bootstrap === 'undefined') {
        console.error('âŒ Bootstrap ØºÙŠØ± Ù…Ø­Ù…Ù„!');
        return;
    }
    
    console.log('âœ… ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù„Ù„ÙˆÙŠØ²Ø§Ø±Ø¯...');
    
document.addEventListener('DOMContentLoaded', function() {
    let wizardHtml5QrCode = null;
    let wizardIsScanning = false;
    let wizardIsCameraRunning = false;
    
    const modal = document.getElementById('wizardBarcodeScannerModal');
    const startCameraBtn = document.getElementById('wizardStartCameraBtn');
    const stopCameraBtn = document.getElementById('wizardStopCameraBtn');
    const readerElement = document.getElementById('wizardBarcodeReader');
    const manualBarcodeInput = document.getElementById('wizardManualBarcodeInput');
    const manualScanBtn = document.getElementById('wizardManualScanBtn');
    const scanStatus = document.getElementById('wizardScanStatus');
    const permissionRequest = document.getElementById('wizardPermissionRequest');
    const requestPermissionBtn = document.getElementById('wizardRequestPermissionBtn');
    const imageInput = document.getElementById('wizardImageInput');
    
    // Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Modal
    modal.addEventListener('hidden.bs.modal', function () {
        stopWizardCamera();
        scanStatus.innerHTML = '';
        document.getElementById('wizardHttpsWarning').classList.add('d-none');
        document.getElementById('wizardCameraError').classList.add('d-none');
        permissionRequest.classList.add('d-none');
        manualBarcodeInput.value = '';
        imageInput.value = '';
    });
    
    // Ø·Ù„Ø¨ Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª
    requestPermissionBtn.addEventListener('click', function() {
        permissionRequest.classList.add('d-none');
        startWizardCamera();
    });
    
    // ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
    startCameraBtn.addEventListener('click', function() {
        startWizardCamera();
    });
    
    // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
    stopCameraBtn.addEventListener('click', function() {
        stopWizardCamera();
    });
    
    // Ø±ÙØ¹ ØµÙˆØ±Ø©
    imageInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            scanStatus.innerHTML = `
                <div class="alert alert-info border-0 shadow-sm text-center" style="border-radius: 15px;">
                    <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
                    <p class="mb-0">Ø¬Ø§Ø±ÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØµÙˆØ±Ø©...</p>
                </div>
            `;
            
            const tempScanner = new Html5Qrcode("wizardBarcodeReader");
            
            tempScanner.scanFile(file, true)
                .then(decodedText => {
                    console.log('âœ… ØªÙ… Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ù† Ø§Ù„ØµÙˆØ±Ø©:', decodedText);
                    searchWizardProduct(decodedText);
                })
                .catch(err => {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØµÙˆØ±Ø©:', err);
                    scanStatus.innerHTML = `
                        <div class="alert alert-danger border-0 shadow-sm text-center" style="border-radius: 15px;">
                            <i class="fas fa-exclamation-circle fa-2x mb-2"></i>
                            <h5>ÙØ´Ù„ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ù† Ø§Ù„ØµÙˆØ±Ø©</h5>
                            <p class="mb-0">ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¶ÙˆØ­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙÙŠ Ø§Ù„ØµÙˆØ±Ø©</p>
                        </div>
                    `;
                });
        }
    });
    
    // Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ÙŠØ¯ÙˆÙŠ
    manualScanBtn.addEventListener('click', function() {
        const barcode = manualBarcodeInput.value.trim();
        if (barcode) {
            searchWizardProduct(barcode);
        }
    });
    
    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Enter
    manualBarcodeInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            const barcode = manualBarcodeInput.value.trim();
            if (barcode) {
                searchWizardProduct(barcode);
            }
        }
    });
    
    function startWizardCamera() {
        const isSecure = window.location.protocol === 'https:' || 
                        window.location.hostname === 'localhost' || 
                        window.location.hostname === '127.0.0.1';
        
        if (!isSecure) {
            document.getElementById('wizardHttpsWarning').classList.remove('d-none');
            return;
        }
        
        if (wizardIsCameraRunning) {
            return;
        }
        
        readerElement.classList.remove('d-none');
        startCameraBtn.classList.add('d-none');
        stopCameraBtn.classList.remove('d-none');
        document.getElementById('wizardHttpsWarning').classList.add('d-none');
        document.getElementById('wizardCameraError').classList.add('d-none');
        
        wizardHtml5QrCode = new Html5Qrcode("wizardBarcodeReader");
        
        const config = {
            fps: 30,
            qrbox: { width: 300, height: 300 },
            aspectRatio: 1.0,
            disableFlip: false,
            experimentalFeatures: {
                useBarCodeDetectorIfSupported: true
            }
        };
        
        wizardHtml5QrCode.start(
            { facingMode: "environment" },
            config,
            (decodedText, decodedResult) => {
                if (!wizardIsScanning) {
                    wizardIsScanning = true;
                    wizardIsCameraRunning = true;
                    
                    console.log('âœ… ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯:', decodedText);
                    
                    // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù„Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù†Ø¸ÙŠÙ
                    stopWizardCamera();
                    
                    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù†ØªØ¬ ÙˆØ¥Ø¶Ø§ÙØªÙ‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
                    searchWizardProduct(decodedText);
                    
                    setTimeout(() => { 
                        wizardIsScanning = false;
                    }, 1000);
                }
            },
            (errorMessage) => {
                // Ù„Ø§ Ù†ÙØ¹Ù„ Ø´ÙŠØ¡ Ù„Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©
            }
        ).then(() => {
            wizardIsCameraRunning = true;
            console.log('âœ… ØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø¨Ù†Ø¬Ø§Ø­');
        }).catch((err) => {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§:', err);
            
            if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                permissionRequest.classList.remove('d-none');
            } else {
                document.getElementById('wizardCameraError').classList.remove('d-none');
            }
            
            readerElement.classList.add('d-none');
            startCameraBtn.classList.remove('d-none');
            stopCameraBtn.classList.add('d-none');
            wizardIsCameraRunning = false;
        });
    }
    
    function stopWizardCamera() {
        if (wizardHtml5QrCode && wizardIsCameraRunning) {
            wizardHtml5QrCode.stop().then(() => {
                console.log('âœ… ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§');
                readerElement.classList.add('d-none');
                startCameraBtn.classList.remove('d-none');
                stopCameraBtn.classList.add('d-none');
                wizardIsCameraRunning = false;
            }).catch((err) => {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§:', err);
                wizardIsCameraRunning = false;
            });
        } else {
            readerElement.classList.add('d-none');
            startCameraBtn.classList.remove('d-none');
            stopCameraBtn.classList.add('d-none');
            wizardIsCameraRunning = false;
        }
    }
    
    function searchWizardProduct(barcode) {
        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙˆØ¥Ø²Ø§Ù„Ø© Ø§Ù„Ø£ØµÙØ§Ø± Ù…Ù† Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
        barcode = barcode.trim();
        const originalBarcode = barcode;
        barcode = barcode.replace(/^0+/, '') || '0';
        
        if (originalBarcode !== barcode) {
            console.log(`ğŸ”„ ØªÙ… ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯: ${originalBarcode} â†’ ${barcode}`);
        }
        
        scanStatus.innerHTML = `
            <div class="alert alert-info border-0 shadow-sm text-center" style="border-radius: 15px;">
                <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
                <p class="mb-0">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù†ØªØ¬...</p>
            </div>
        `;
        
        fetch(`/inventory/api/barcode-scan/?barcode=${encodeURIComponent(barcode)}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayWizardProduct(data.product);
                } else {
                    scanStatus.innerHTML = `
                        <div class="alert alert-danger border-0 shadow-sm text-center" style="border-radius: 15px;">
                            <i class="fas fa-exclamation-circle fa-2x mb-2"></i>
                            <h5>${data.error}</h5>
                            <p class="mb-0">${data.message || ''}</p>
                            ${originalBarcode !== barcode ? `<p class="small text-muted mt-2">ØªÙ… Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„ÙƒÙˆØ¯: ${barcode}</p>` : ''}
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Ø®Ø·Ø£:', error);
                scanStatus.innerHTML = `
                    <div class="alert alert-danger border-0 shadow-sm text-center" style="border-radius: 15px;">
                        <i class="fas fa-times-circle fa-2x mb-2"></i>
                        <h5>Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„</h5>
                    </div>
                `;
            });
    }
    
    function displayWizardProduct(product) {
        // Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬ ÙˆØ·Ù„Ø¨ Ø§Ù„ÙƒÙ…ÙŠØ©
        scanStatus.innerHTML = `
            <div class="card border-0 shadow-lg" style="border-radius: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <div class="card-body p-4">
                    <h4 class="text-center mb-4">
                        <i class="fas fa-box-open me-2"></i> ${product.name}
                    </h4>
                    
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <div class="p-3" style="background: rgba(255,255,255,0.2); border-radius: 10px;">
                                <small class="d-block mb-1 opacity-75">Ø§Ù„ÙƒÙˆØ¯</small>
                                <strong>${product.code || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</strong>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="p-3" style="background: rgba(255,255,255,0.2); border-radius: 10px;">
                                <small class="d-block mb-1 opacity-75">Ø§Ù„Ø³Ø¹Ø±</small>
                                <strong>${product.price} ${product.currency_symbol}</strong>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="p-3" style="background: rgba(255,255,255,0.2); border-radius: 10px;">
                                <small class="d-block mb-1 opacity-75">Ø§Ù„Ù…ØªÙˆÙØ±</small>
                                <strong>${product.current_stock}</strong>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="p-3" style="background: rgba(255,255,255,0.2); border-radius: 10px;">
                                <small class="d-block mb-1 opacity-75">Ø§Ù„Ø­Ø§Ù„Ø©</small>
                                <strong>${product.stock_status}</strong>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:</label>
                        <input type="number" id="scannedProductQuantity" class="form-control form-control-lg shadow-sm" 
                               min="0.001" step="0.001" value="1" 
                               placeholder="Ù…Ø«Ø§Ù„: 4.25"
                               style="border-radius: 10px; border: 2px solid white;">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Ø§Ù„Ø®ØµÙ… (%):</label>
                        <select id="scannedProductDiscount" class="form-select form-select-lg shadow-sm" 
                                style="border-radius: 10px; border: 2px solid white;">
                            <option value="0">0%</option>
                            <option value="1">1%</option>
                            <option value="2">2%</option>
                            <option value="3">3%</option>
                            <option value="4">4%</option>
                            <option value="5">5%</option>
                            <option value="6">6%</option>
                            <option value="7">7%</option>
                            <option value="8">8%</option>
                            <option value="9">9%</option>
                            <option value="10">10%</option>
                            <option value="11">11%</option>
                            <option value="12">12%</option>
                            <option value="13">13%</option>
                            <option value="14">14%</option>
                            <option value="15">15%</option>
                        </select>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button class="btn btn-light btn-lg flex-grow-1 shadow" onclick="addScannedProductToWizard(${product.id}, '${product.name.replace(/'/g, "\\'")}', '${product.code || ''}', ${product.price})" style="border-radius: 10px;">
                            <i class="fas fa-plus-circle me-2"></i> Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø·Ù„Ø¨
                        </button>
                        <button class="btn btn-outline-light btn-lg shadow" onclick="document.getElementById('wizardScanStatus').innerHTML = ''; document.getElementById('wizardManualBarcodeInput').value = ''; document.getElementById('wizardManualBarcodeInput').focus();" style="border-radius: 10px;">
                            <i class="fas fa-redo me-2"></i> ÙØ­Øµ Ø¢Ø®Ø±
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        // ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø­Ù‚Ù„ Ø§Ù„ÙƒÙ…ÙŠØ©
        setTimeout(() => {
            const quantityInput = document.getElementById('scannedProductQuantity');
            if (quantityInput) {
                quantityInput.select();
                quantityInput.focus();
            }
        }, 100);
    }
});

})(); // Ù†Ù‡Ø§ÙŠØ© IIFE
</script>
