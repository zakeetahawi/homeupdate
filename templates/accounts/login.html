{% extends 'base.html' %}
{% block title %}تسجيل الدخول - نظام الخواجه{% endblock %}
{% block content %}
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card" style="border-color: var(--neutral);">
                    <div class="card-header"
                         style="background-color: var(--primary);
                                color: white">
                        <h5 class="mb-0">
                            <i class="fas fa-sign-in-alt"></i> تسجيل الدخول
                        </h5>
                    </div>
                    <div class="card-body">
                        {% if messages %}
                            <div class="messages">
                                {% for message in messages %}
                                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
                                        {{ message }}
                                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}
                        {% if error_message %}
                            <div class="alert alert-danger alert-dismissible fade show">
                                {{ error_message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endif %}
                        <form method="post" id="loginForm">
                            {% csrf_token %}
                            <input type="hidden" name="device_info" id="deviceInfo">
                            <input type="hidden" name="device_token" id="deviceToken">
                            {% if form.non_field_errors %}
                                <div class="alert alert-danger">
                                    {% for error in form.non_field_errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                            <div class="mb-3">
                                <label for="{{ form.username.id_for_label }}" class="form-label">اسم المستخدم</label>
                                {% if form.username %}
                                    {{ form.username }}
                                {% else %}
                                    <input type="text"
                                           name="username"
                                           class="form-control"
                                           placeholder="اسم المستخدم"
                                           required>
                                {% endif %}
                                {% if form.username.errors %}
                                    <div class="text-danger">
                                        {% for error in form.username.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="mb-3">
                                <label for="{{ form.password.id_for_label }}" class="form-label">كلمة المرور</label>
                                {% if form.password %}
                                    {{ form.password }}
                                {% else %}
                                    <input type="password"
                                           name="password"
                                           class="form-control"
                                           placeholder="كلمة المرور"
                                           required>
                                {% endif %}
                                {% if form.password.errors %}
                                    <div class="text-danger">
                                        {% for error in form.password.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="d-grid gap-2">
                                <button type="submit"
                                        class="btn"
                                        style="background-color: var(--primary);
                                               color: white">
                                    <i class="fas fa-sign-in-alt"></i> تسجيل الدخول
                                </button>
                            </div>
                        </form>
                    </div>
                    <div class="card-footer text-center">
                        <small class="text-muted">إذا واجهت مشكلة في تسجيل الدخول، يرجى التواصل مع مسؤول النظام.</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script>
// ====================
// IndexedDB Helper
// ====================
const DeviceDB = {
    dbName: 'ElkhawagaDeviceDB',
    storeName: 'deviceToken',
    
    async init() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(this.dbName, 1);
            request.onerror = () => reject(request.error);
            request.onsuccess = () => resolve(request.result);
            request.onupgradeneeded = (e) => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains(this.storeName)) {
                    db.createObjectStore(this.storeName);
                }
            };
        });
    },
    
    async getToken() {
        const db = await this.init();
        return new Promise((resolve, reject) => {
            const tx = db.transaction([this.storeName], 'readonly');
            const store = tx.objectStore(this.storeName);
            const request = store.get('device_token');
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
        });
    }
};

// جمع بصمة الجهاز عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', async function() {
    // 1. محاولة قراءة Token من IndexedDB
    let deviceToken = null;
    try {
        deviceToken = await DeviceDB.getToken();
        if (deviceToken) {
            document.getElementById('deviceToken').value = deviceToken;
            console.log('✅ Device Token loaded from IndexedDB');
        } else {
            console.log('ℹ️ لا يوجد device token - سيتم التحقق من قيود الفرع');
        }
    } catch(err) {
        console.error('Failed to read device token:', err);
    }
    
    // جمع معلومات الجهاز الأساسية فقط (بدون البصمات المعقدة)
    const deviceInfo = {
        screen_resolution: window.screen.width + 'x' + window.screen.height,
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
        language: navigator.language,
        platform: navigator.platform,
        user_agent: navigator.userAgent,
        color_depth: window.screen.colorDepth,
        pixel_ratio: window.devicePixelRatio,
        has_touch: 'ontouchstart' in window,
        cpu_cores: navigator.hardwareConcurrency || 0,
    };
    
    // حفظ معلومات الجهاز في النموذج
    document.getElementById('deviceInfo').value = JSON.stringify(deviceInfo);
    
    console.log('✅ Device ready for login:', {
        hasToken: !!deviceToken,
        deviceInfo: 'collected'
    });
    
    // معالج إرسال النموذج
    document.getElementById('loginForm').addEventListener('submit', function(e) {
        // التأكد من وجود معلومات الجهاز
        if (!document.getElementById('deviceInfo').value) {
            document.getElementById('deviceInfo').value = JSON.stringify(deviceInfo);
        }
        
        // Warning if no token
        if (!deviceToken) {
            console.log('ℹ️ No device token - will be checked on server');
        }
    });
});
    </script>
    {% if device_denial_popup.show %}
        <script>
// عرض popup للجهاز غير المصرح
document.addEventListener('DOMContentLoaded', function() {
    Swal.fire({
        icon: 'error',
        title: '{{ device_denial_popup.title|escapejs }}',
        html: `{{ device_denial_popup.html_content|safe|escapejs }}`,
        confirmButtonText: 'حسناً',
        confirmButtonColor: '#dc3545',
        width: '700px',
        customClass: {
            popup: 'device-denial-popup',
            htmlContainer: 'text-right'
        },
        didOpen: () => {
            // إضافة CSS مخصص للـ popup
            const style = document.createElement('style');
            style.innerHTML = `
                .device-denial-popup {
                    text-align: right;
                    direction: rtl;
                    font-family: 'Cairo', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                }
                .device-denial-popup table {
                    width: 100%;
                    border-collapse: collapse;
                }
                .device-denial-popup td {
                    padding: 8px;
                    border: 1px solid #ddd;
                }
            `;
            document.head.appendChild(style);
        }
    });
});
        </script>
    {% endif %}
{% endblock %}
