{% extends 'base.html' %}
{% load static %}
{% block title %}{{ title }}{% endblock %}
{% block content %}
    <div class="row justify-content-center">
        <!-- Main Content Column -->
        <div class="col-lg-10 col-xl-8">
            <!-- 1. Identity Card -->
            <div class="card border-0 shadow-sm mb-4 overflow-hidden">
                <div class="card-body p-0">
                    <div class="row g-0">
                        <div class="col-md-4 bg-light d-flex align-items-center justify-content-center p-4">
                            <div class="position-relative">
                                {% if user.image %}
                                    <img src="{{ user.image.url }}"
                                         alt="{{ user.username }}"
                                         class="rounded-circle border border-4 border-white shadow"
                                         style="width: 150px;
                                                height: 150px;
                                                object-fit: cover"
                                         id="identityPreview">
                                {% else %}
                                    <div class="rounded-circle bg-white d-flex align-items-center justify-content-center border border-4 border-light shadow mx-auto"
                                         style="width: 150px;
                                                height: 150px"
                                         id="identityPreviewDiv">
                                        <i class="fas fa-user fa-5x text-secondary"></i>
                                    </div>
                                {% endif %}
                                <button type="button"
                                        class="btn btn-sm btn-dark rounded-circle position-absolute bottom-0 end-0 shadow border border-white"
                                        style="width: 38px;
                                               height: 38px"
                                        onclick="document.getElementById('id_image').click()"
                                        title="تغيير الصورة">
                                    <i class="fas fa-camera text-white"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-8 p-4 d-flex flex-column justify-content-center">
                            <h2 class="fw-bold text-dark mb-1">{{ user.get_full_name|default:user.username }}</h2>
                            <p class="text-muted mb-3 fs-5">{{ user.get_user_role_display }}</p>
                            <div class="d-flex flex-wrap gap-2">
                                {% if user.branch %}
                                    <span class="badge bg-light text-dark border px-3 py-2 rounded-pill">
                                        <i class="fas fa-building me-1 text-secondary"></i> {{ user.branch.name }}
                                    </span>
                                {% endif %}
                                <span class="badge bg-light text-dark border px-3 py-2 rounded-pill">
                                    <i class="fas fa-user-tag me-1 text-secondary"></i> {{ user.username }}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <!-- Hidden Image Input -->
                <div class="d-none">{{ form.image }}</div>
                {% if form.errors %}
                    <div class="alert alert-danger border-0 shadow-sm mb-4">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-exclamation-triangle fa-2x me-3"></i>
                            <div>
                                <h5 class="alert-heading fw-bold mb-1">تنبيه</h5>
                                <ul class="mb-0 ps-3">
                                    {% for field, errors in form.errors.items %}
                                        {% for error in errors %}<li>{{ error }}</li>{% endfor %}
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    </div>
                {% endif %}
                <!-- 2. Personal Details Card -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white py-3 px-4 border-bottom">
                        <h5 class="mb-0 fw-bold text-dark">
                            <i class="fas fa-id-card me-2 text-primary"></i>البيانات الشخصية
                        </h5>
                    </div>
                    <div class="card-body p-4">
                        <div class="row g-4">
                            <div class="col-md-6">
                                <label class="form-label text-muted fw-bold small text-uppercase">الاسم الأول</label>
                                {{ form.first_name }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label text-muted fw-bold small text-uppercase">الاسم الأخير</label>
                                {{ form.last_name }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label text-muted fw-bold small text-uppercase">البريد الإلكتروني</label>
                                {{ form.email }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label text-muted fw-bold small text-uppercase">رقم الهاتف</label>
                                {{ form.phone }}
                            </div>
                        </div>
                    </div>
                </div>
                <!-- 3. Preferences Card -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white py-3 px-4 border-bottom d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 fw-bold text-dark">
                            <i class="fas fa-sliders-h me-2 text-primary"></i>تفضيلات النظام
                        </h5>
                        <span class="badge bg-success rounded-pill px-3 py-2 d-none"
                              id="themeSuccessBadge">
                            تمت المعاينة <i class="fas fa-check ms-1"></i>
                        </span>
                    </div>
                    <div class="card-body p-4">
                        <div class="mb-0">
                            <label class="form-label text-muted fw-bold small text-uppercase mb-2">المظهر (Theme)</label>
                            <div class="input-group">
                                <span class="input-group-text bg-light border-end-0"><i class="fas fa-palette text-secondary"></i></span>
                                {{ form.default_theme }}
                            </div>
                            <div class="form-text mt-2">
                                اختر المظهر المناسب لك. سيتم تطبيق التغيير فوراً كمعاينة، وسيحفظ عند الضغط على زر الحفظ.
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Action Buttons -->
                <div class="d-flex justify-content-end gap-3 mb-5">
                    <a href="{% url 'home' %}"
                       class="btn btn-light border px-4 py-2 fw-bold">إلغاء</a>
                    <button type="submit" class="btn btn-primary px-5 py-2 fw-bold shadow-sm">
                        <i class="fas fa-save me-2"></i> حفظ التغييرات
                    </button>
                </div>
            </form>
        </div>
    </div>
    <script>
    // Image Preview
    document.getElementById('id_image').addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const previewImg = document.getElementById('identityPreview');
                const previewDiv = document.getElementById('identityPreviewDiv');

                if (previewImg) {
                    previewImg.src = e.target.result;
                } else if (previewDiv) {
                    // Replace div with img
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.alt = "{{ user.username }}";
                    img.className = "rounded-circle border border-4 border-white shadow";
                    img.style.width = "150px";
                    img.style.height = "150px";
                    img.style.objectFit = "cover";
                    img.id = "identityPreview";
                    
                    const wrapper = previewDiv.parentNode;
                    // Keep the button, replace the div
                    const btn = wrapper.querySelector('button');
                    wrapper.innerHTML = '';
                    wrapper.appendChild(img);
                    wrapper.appendChild(btn);
                }
            }
            reader.readAsDataURL(file);
        }
    });

    // Theme Preview & Logic
    const themeSelect = document.getElementById('id_default_theme');
    const badge = document.getElementById('themeSuccessBadge');
    const validThemes = ['default', 'modern-black', 'ornamental'];

    if (themeSelect) {
        themeSelect.classList.add('form-select', 'border-start-0', 'ps-3'); // Bootstrap classes
        
        themeSelect.addEventListener('change', function() {
            const selectedTheme = this.value;
            if (validThemes.includes(selectedTheme)) {
                // Apply theme
                document.documentElement.setAttribute('data-theme', selectedTheme);
                
                // Show success badge
                if(badge) {
                    badge.classList.remove('d-none');
                    setTimeout(() => {
                        badge.classList.add('d-none');
                    }, 2500);
                }
            }
        });
    }
    </script>
{% endblock %}
