{% extends 'base.html' %}
{% load static %}

{% block title %}تفاصيل السلفة - {{ advance.advance_number }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'accounting:dashboard' %}">المحاسبة</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'accounting:advance_list' %}">السلف</a></li>
                    <li class="breadcrumb-item active">{{ advance.advance_number }}</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                <h2 class="mb-0">
                    <i class="fas fa-hand-holding-usd me-2"></i>
                    سلفة رقم: {{ advance.advance_number }}
                    {% if advance.status == 'active' %}
                    <span class="badge bg-success">نشطة</span>
                    {% elif advance.status == 'partially_used' %}
                    <span class="badge bg-warning">مستخدمة جزئياً</span>
                    {% elif advance.status == 'fully_used' %}
                    <span class="badge bg-secondary">مستخدمة بالكامل</span>
                    {% else %}
                    <span class="badge bg-danger">ملغية</span>
                    {% endif %}
                </h2>
                <div>
                    {% if advance.status == 'active' and advance.remaining_amount > 0 %}
                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#useAdvanceModal">
                        <i class="fas fa-check me-1"></i> استخدام السلفة
                    </button>
                    {% endif %}
                    <button onclick="window.print()" class="btn btn-outline-secondary">
                        <i class="fas fa-print me-1"></i> طباعة
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- معلومات السلفة -->
        <div class="col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        معلومات السلفة
                    </h5>
                </div>
                <div class="card-body">
                    <table class="table table-borderless mb-0">
                        <tr>
                            <th width="40%">رقم السلفة:</th>
                            <td>{{ advance.advance_number }}</td>
                        </tr>
                        <tr>
                            <th>العميل:</th>
                            <td>
                                <a href="{% url 'customers:customer_detail' advance.customer.pk %}">
                                    {{ advance.customer.name }}
                                </a>
                            </td>
                        </tr>
                        <tr>
                            <th>تاريخ الإنشاء:</th>
                            <td>{{ advance.created_at|date:"Y-m-d H:i" }}</td>
                        </tr>
                        <tr>
                            <th>طريقة الدفع:</th>
                            <td>{{ advance.get_payment_method_display }}</td>
                        </tr>
                        <tr>
                            <th>رقم الإيصال:</th>
                            <td>{{ advance.receipt_number|default:"-" }}</td>
                        </tr>
                        <tr>
                            <th>المستلم:</th>
                            <td>{{ advance.created_by.get_full_name|default:advance.created_by.username }}</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>

        <!-- المبالغ -->
        <div class="col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-money-bill-wave me-2"></i>
                        المبالغ
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-4">
                            <h6 class="text-muted mb-1">المبلغ الأصلي</h6>
                            <h3 class="text-primary">{{ advance.amount|floatformat:2 }}</h3>
                            <small class="text-muted">{{ currency_symbol }}</small>
                        </div>
                        <div class="col-4">
                            <h6 class="text-muted mb-1">المستخدم</h6>
                            <h3 class="text-danger">{{ advance.used_amount|floatformat:2 }}</h3>
                            <small class="text-muted">{{ currency_symbol }}</small>
                        </div>
                        <div class="col-4">
                            <h6 class="text-muted mb-1">المتبقي</h6>
                            <h3 class="text-success">{{ advance.remaining_amount|floatformat:2 }}</h3>
                            <small class="text-muted">{{ currency_symbol }}</small>
                        </div>
                    </div>
                    
                    <!-- شريط التقدم -->
                    <div class="mt-3">
                        {% widthratio advance.used_amount advance.amount 100 as used_percentage %}
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar bg-danger" role="progressbar" style="width: {{ used_percentage }}%">
                                {{ used_percentage }}% مستخدم
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- الملاحظات -->
    {% if advance.notes %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-sticky-note me-2"></i>
                        ملاحظات
                    </h5>
                </div>
                <div class="card-body">
                    {{ advance.notes|linebreaks }}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- سجل الاستخدام -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-history me-2"></i>
                        سجل استخدام السلفة
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>التاريخ</th>
                                    <th>الطلب</th>
                                    <th>المبلغ</th>
                                    <th>بواسطة</th>
                                    <th>ملاحظات</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for usage in usages %}
                                <tr>
                                    <td>{{ usage.used_at|date:"Y-m-d H:i" }}</td>
                                    <td>
                                        {% if usage.order %}
                                        <a href="{% url 'orders:order_detail' usage.order.pk %}">
                                            {{ usage.order.order_number }}
                                        </a>
                                        {% else %}
                                        -
                                        {% endif %}
                                    </td>
                                    <td class="text-danger">{{ usage.amount|floatformat:2 }} {{ currency_symbol }}</td>
                                    <td>{{ usage.used_by.get_full_name|default:usage.used_by.username }}</td>
                                    <td>{{ usage.notes|default:"-" }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="5" class="text-center py-4 text-muted">
                                        لم يتم استخدام السلفة بعد
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal استخدام السلفة -->
{% if advance.status == 'active' and advance.remaining_amount > 0 %}
<div class="modal fade" id="useAdvanceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{% url 'accounting:advance_use' advance.pk %}" method="post">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-check me-2"></i>
                        استخدام السلفة
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <strong>المتبقي من السلفة:</strong> {{ advance.remaining_amount|floatformat:2 }} {{ currency_symbol }}
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">الطلب <span class="text-danger">*</span></label>
                        <select name="order" class="form-select" required>
                            <option value="">اختر الطلب...</option>
                            <!-- يتم ملؤها من JavaScript أو يمكن إضافة الطلبات هنا -->
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">المبلغ <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <input type="number" name="amount" class="form-control" step="0.01" max="{{ advance.remaining_amount }}" required>
                            <span class="input-group-text">{{ currency_symbol }}</span>
                        </div>
                        <small class="text-muted">الحد الأقصى: {{ advance.remaining_amount|floatformat:2 }} {{ currency_symbol }}</small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">ملاحظات</label>
                        <textarea name="notes" class="form-control" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-check me-1"></i> تأكيد الاستخدام
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<style>
@media print {
    .navbar, .breadcrumb, .btn, .modal {
        display: none !important;
    }
}
</style>
{% endblock %}
