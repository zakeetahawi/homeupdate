<!DOCTYPE html>
{% load static %}
{% load complaints_permissions %}
<html lang="ar" dir="rtl">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport"
              content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="default">
        <meta name="theme-color" content="#007bff">
        <meta name="format-detection" content="telephone=no">
        <meta name="csrf-token" content="{{ csrf_token }}">
        {% if user.is_authenticated %}<meta name="current-user" content="{{ user.username }}">{% endif %}
        <title>
            {% block title %}نظام إدارة العملاء{% endblock %}
        </title>
        <!-- Floating Chat Button: يُدرج في نهاية body لتجنب الوميض -->
        <!-- Favicon -->
        {% if company_info.logo %}
            <link rel="icon" type="image/png" href="{{ company_info.logo.url }}">
            <link rel="shortcut icon"
                  type="image/png"
                  href="{{ company_info.logo.url }}">
            <link rel="apple-touch-icon" href="{{ company_info.logo.url }}">
        {% else %}
            <link rel="icon" type="image/png" href="{% static 'images/favicon.png' %}">
            <link rel="shortcut icon"
                  type="image/png"
                  href="{% static 'images/favicon.png' %}">
            <link rel="apple-touch-icon" href="{% static 'images/favicon.png' %}">
        {% endif %}
        <!-- Bootstrap RTL CSS - محلي -->
        <link href="{% static 'vendor/bootstrap/bootstrap.rtl.min.css' %}"
              rel="stylesheet">
        <!-- Font Awesome - محلي -->
        <link href="{% static 'vendor/fontawesome/css/all.min.css' %}"
              rel="stylesheet">
        <!-- Animate.css for SweetAlert animations - محلي -->
        <link rel="stylesheet" href="{% static 'vendor/animate/animate.min.css' %}">
        <!-- DataTables CSS - يُحمّل فقط في الصفحات التي تحتاجه -->
        {% block datatables_css %}{% endblock %}
        <!-- Global Font CSS (Cairo + Font Awesome fix merged) -->
        <link rel="stylesheet" href="{% static 'css/global-cairo-font.css' %}">
        <!-- Custom CSS -->
        <link rel="stylesheet" href="{% static 'css/style.css' %}?v=2.2.0">
        <!-- Ornamental Theme - loaded conditionally via data-theme attribute -->
        <link rel="stylesheet"
              href="{% static 'css/ornamental-theme.css' %}?v=2.2.0">
        <!-- Custom Theme Enhancements CSS -->
        <link rel="stylesheet"
              href="{% static 'css/extra-dark-fixes.css' %}?v=2.2.0">
        <!-- Custom Theme Enhancements -->
        <link rel="stylesheet"
              href="{% static 'css/custom-theme-enhancements.css' %}?v=2.2.0">
        <!-- ZakZak Theme - أزرق وفضي -->
        <link rel="stylesheet"
              href="{% static 'css/zakzak-theme.css' %}?v=2.2.0">
        <!-- Unified Status System CSS (merged with colors) -->
        <link rel="stylesheet" href="{% static 'css/unified-status-system.css' %}">
        <!-- Responsive Footer CSS -->
        <link rel="stylesheet" href="{% static 'css/responsive-footer.css' %}">
        <!-- Anti-Flicker CSS -->
        <link rel="stylesheet" href="{% static 'css/anti-flicker.css' %}">
        <!-- Google Material Icons - محلي -->
        <link href="{% static 'vendor/fonts/material-icons.css' %}"
              rel="stylesheet">
        <!-- Google Fonts - Cairo (Arabic) - محلي -->
        <link href="{% static 'vendor/fonts/cairo.css' %}" rel="stylesheet">
        <!-- Google Fonts - Roboto (English) - محلي -->
        <link href="{% static 'vendor/fonts/roboto.css' %}" rel="stylesheet">
        <!-- Database Card CSS -->
        {% if 'database' in request.path %}
            <link rel="stylesheet" href="{% static 'css/db_card.css' %}">
        {% endif %}
        <!-- Floating Chat Button CSS -->
        <link rel="stylesheet" href="{% static 'css/floating-button.css' %}">
        <!-- Base Layout CSS (extracted from inline) -->
        <link rel="stylesheet" href="{% static 'css/base-layout.css' %}">
        <!-- تطبيق فوري للثيم لتجنب الوميض -->
        <script>
        // تطبيق الثيم فوراً قبل رسم الصفحة - محسن لتجنب الوميض
        (function () {
            // إخفاء body مؤقتاً لتجنب الوميض
            document.documentElement.style.visibility = 'hidden';

            {% if user.is_authenticated %}
            var userDefaultTheme = '{{ user.default_theme }}';
            // Always prefer user's default theme from database after login
            if (userDefaultTheme && userDefaultTheme !== 'default') {
                document.documentElement.setAttribute('data-theme', userDefaultTheme);
                localStorage.setItem('selectedTheme', userDefaultTheme);
                if (document.getElementById('themeSelector')) {
                    document.getElementById('themeSelector').value = userDefaultTheme;
                }
            } else {
                var savedTheme = localStorage.getItem('selectedTheme');
                // Only use localStorage theme if no default theme is set
                if (savedTheme && savedTheme !== 'default') {
                    document.documentElement.setAttribute('data-theme', savedTheme);
                }
            }
            {% else %}
            // For non-authenticated users, use localStorage theme
            var savedTheme = localStorage.getItem('selectedTheme');
            if (savedTheme && savedTheme !== 'default') {
                document.documentElement.setAttribute('data-theme', savedTheme);
            }
            {% endif %}

            // إظهار الصفحة بعد تطبيق الثيم
            setTimeout(function () {
                document.documentElement.style.visibility = 'visible';
            }, 10);
        })();
        </script>
        <!-- CSS فوري للثيم الافتراضي لتجنب الوميض -->
        <!-- CSS moved to base-layout.css -->
        {% block extra_css %}{% endblock %}
    </head>
    <body id="main-body"
          data-user-authenticated="{% if user.is_authenticated %}true{% else %}false{% endif %}"
          {% if user.is_authenticated %}data-notifications-count-url="{% url 'notifications:ajax_count' %}"
          data-notifications-recent-url="{% url 'notifications:ajax_recent' %}"
          data-notifications-mark-all-url="{% url 'notifications:mark_all_read' %}"
          data-notifications-list-url="{% url 'notifications:list' %}"{% endif %}>
        <!-- Navigation -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
            <div class="container-fluid">
                <a class="navbar-brand" href="{% url 'home' %}">
                    <div class="d-flex align-items-center">
                        {% if company_info.header_logo %}
                            <img src="{{ company_info.header_logo.url }}?v={{ company_info.header_logo.url|length }}"
                                 alt="{{ company_info.name|default:'شعار النظام' }}"
                                 class="logo-img"
                                 id="header-logo">
                        {% elif company_info.logo %}
                            <img src="{{ company_info.logo.url }}?v={{ company_info.logo.url|length }}"
                                 alt="{{ company_info.name|default:'شعار النظام' }}"
                                 class="logo-img"
                                 id="header-logo">
                        {% else %}
                            <img src="{% static 'img/logo.png' %}"
                                 alt="شعار النظام"
                                 class="logo-img"
                                 id="header-logo">
                        {% endif %}
                    </div>
                </a>
                <button class="navbar-toggler"
                        type="button"
                        data-bs-toggle="collapse"
                        data-bs-target="#navbarNav"
                        aria-controls="navbarNav"
                        aria-expanded="false"
                        aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'home' %}"><i class="fas fa-home"></i><span class="nav-text">الرئيسية</span></a>
                        </li>
                        <!-- Admin Dashboard Link Removed -->
                        <!-- الأقسام للمستخدمين المسجلين فقط -->
                        {% if user.is_authenticated %}
                            {% if user.is_warehouse_staff %}
                                <!-- موظفو المستودع يرون نظام التقطيع والمستودع المخصص فقط -->
                                <li class="nav-item">
                                    <a class="nav-link" href="/cutting/">
                                        <i class="fas fa-cut"></i><span class="nav-text">نظام التقطيع</span>
                                    </a>
                                </li>
                                {% if user.assigned_warehouse %}
                                    <li class="nav-item">
                                        <a class="nav-link"
                                           href="/cutting/orders/warehouse/{{ user.assigned_warehouse.id }}/">
                                            <i class="fas fa-warehouse"></i><span class="nav-text">{{ user.assigned_warehouse.name }}</span>
                                        </a>
                                    </li>
                                {% endif %}
                                <li class="nav-item">
                                    <a class="nav-link" href="/cutting/orders/completed/">
                                        <i class="fas fa-list-check"></i><span class="nav-text">أوامر التقطيع المجمعة</span>
                                    </a>
                                </li>
                            {% elif user.is_factory_receiver %}
                                {# مسؤول استلام المصنع يرى رابط استلام الأقمشة ورابط أوامر التصنيع #}
                                <li class="nav-item">
                                    <a class="nav-link" href="/manufacturing/">
                                        <i class="fas fa-industry"></i><span class="nav-text">أوامر التصنيع</span>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="/manufacturing/fabric-receipt/">
                                        <i class="fas fa-boxes"></i><span class="nav-text">استلام الأقمشة</span>
                                    </a>
                                </li>
                            {% elif user.is_staff %}
                                <!-- الموظفون يرون جميع الأقسام من قاعدة البيانات -->
                                {% include 'includes/navbar_dynamic.html' %}
                                <!-- روابط إضافية للتوافق -->
                                <li class="nav-item d-none">
                                    <a class="nav-link" href="/customers/">
                                        <i class="fas fa-users"></i><span class="nav-text">العملاء</span>
                                    </a>
                                </li>
                                <li class="nav-item d-none">
                                    <a class="nav-link" href="/orders/">
                                        <i class="fas fa-shopping-cart"></i><span class="nav-text">الطلبات</span>
                                    </a>
                                </li>
                                <!-- القائمة القديمة تم استبدالها بالقائمة الديناميكية أعلاه -->
                            {% else %}
                                <!-- المستخدمون العاديون يرون الأقسام المخصصة لهم من navbar_departments -->
                                {% include 'includes/navbar_dynamic.html' %}
                            {% endif %}
                        {% else %}
                            <!-- رسالة للمستخدمين غير المسجلين -->
                            <li class="nav-item">
                                <span class="nav-link text-muted">
                                    <i class="fas fa-lock"></i><span class="nav-text">يرجى تسجيل الدخول للوصول للأقسام</span>
                                </span>
                            </li>
                        {% endif %}
                    </ul>
                    <div class="d-flex align-items-center ms-auto">
                        {% if user.is_authenticated %}
                            <!-- زر فحص الباركود -->
                            <button class="btn btn-outline-light btn-sm position-relative me-2"
                                    type="button"
                                    id="openScannerBtn"
                                    data-bs-toggle="modal"
                                    data-bs-target="#scannerModal"
                                    title="فحص الباركود / بحث عن منتج">
                                <i class="fas fa-barcode"></i>
                                <span class="d-none d-lg-inline ms-1">باركود</span>
                            </button>
                            <!-- أيقونة التحويلات الواردة - للمستخدمين الذين يديرون مستودعات -->
                            {% if incoming_transfers_count > 0 %}
                                <div class="dropdown me-2">
                                    <button class="btn btn-outline-warning position-relative"
                                            type="button"
                                            id="incomingTransfersDropdown"
                                            data-bs-toggle="dropdown"
                                            aria-expanded="false"
                                            title="تحويلات واردة بحاجة استلام">
                                        <i class="fas fa-inbox"></i>
                                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                                            {{ incoming_transfers_count }}
                                        </span>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end"
                                        aria-labelledby="incomingTransfersDropdown"
                                        style="width: 380px;
                                               max-height: 450px;
                                               overflow-y: auto">
                                        <li class="dropdown-header d-flex justify-content-between align-items-center bg-warning bg-opacity-10">
                                            <span class="fw-bold text-dark">
                                                <i class="fas fa-inbox me-2 text-warning"></i>
                                                تحويلات واردة بحاجة استلام
                                            </span>
                                            <span class="badge bg-danger">{{ incoming_transfers_count }}</span>
                                        </li>
                                        <li>
                                            <hr class="dropdown-divider">
                                        </li>
                                        {% for transfer in incoming_transfers_list %}
                                            <li>
                                                <a class="dropdown-item py-3"
                                                   href="{% url 'inventory:stock_transfer_receive' transfer.id %}"
                                                   style="border-radius: 8px;
                                                          margin: 2px 8px">
                                                    <div class="d-flex justify-content-between align-items-start">
                                                        <div class="flex-grow-1">
                                                            <div class="d-flex align-items-center mb-2">
                                                                <strong class="text-primary">{{ transfer.transfer_number }}</strong>
                                                                {% if transfer.status == 'approved' %}
                                                                    <span class="badge bg-success ms-2">تمت الموافقة</span>
                                                                {% elif transfer.status == 'in_transit' %}
                                                                    <span class="badge bg-info ms-2">قيد النقل</span>
                                                                {% endif %}
                                                            </div>
                                                            <div class="mb-2">
                                                                <small class="text-muted d-block">
                                                                    <i class="fas fa-warehouse text-danger"></i> من: <strong>{{ transfer.from_warehouse.name }}</strong>
                                                                </small>
                                                                <small class="text-muted d-block">
                                                                    <i class="fas fa-warehouse text-success"></i> إلى: <strong>{{ transfer.to_warehouse.name }}</strong>
                                                                </small>
                                                            </div>
                                                            <div class="d-flex justify-content-between align-items-center">
                                                                <small class="text-muted">
                                                                    <i class="fas fa-boxes"></i> {{ transfer.total_items }} صنف
                                                                </small>
                                                                <small class="text-muted">
                                                                    <i class="fas fa-clock"></i> {{ transfer.transfer_date|timesince }}
                                                                </small>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </a>
                                            </li>
                                            {% if not forloop.last %}
                                                <li>
                                                    <hr class="dropdown-divider">
                                                </li>
                                            {% endif %}
                                        {% endfor %}
                                        <li>
                                            <hr class="dropdown-divider">
                                        </li>
                                        <li>
                                            <a class="dropdown-item text-center text-primary"
                                               href="{% url 'inventory:stock_transfer_list' %}?status=approved,in_transit">
                                                <i class="fas fa-list"></i> عرض جميع التحويلات الواردة
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            {% endif %}
                            <!-- Unified Complaints Center (Merged Button) -->
                            {% if user|has_complaints_permissions or user|has_assignment_permissions %}
                                <div class="dropdown me-2">
                                    <button class="btn btn-outline-warning position-relative"
                                            type="button"
                                            id="complaintsCenterDropdown"
                                            data-bs-toggle="dropdown"
                                            data-bs-auto-close="outside"
                                            aria-expanded="false"
                                            title="مركز الشكاوى والتعيينات">
                                        <i class="fas fa-headset"></i>
                                        <!-- Combined Badge -->
                                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
                                              id="complaints-center-total-badge"
                                              style="display: none">0</span>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end shadow-lg border-0"
                                        aria-labelledby="complaintsCenterDropdown"
                                        style="width: 360px;
                                               max-height: 500px;
                                               overflow-y: auto">
                                        <li class="dropdown-header d-flex justify-content-between align-items-center bg-light py-2">
                                            <span class="fw-bold text-dark">
                                                <i class="fas fa-headset me-2 text-warning"></i>
                                                مركز الشكاوى
                                            </span>
                                            <a href="{% url 'complaints:complaint_list' %}"
                                               class="btn btn-xs btn-outline-primary">عرض الكل</a>
                                        </li>
                                        <!-- Sub-header: Notifications -->
                                        {% if user|has_complaints_permissions %}
                                            <div class="px-2 mt-2">
                                                <div class="d-flex justify-content-between align-items-center bg-light border rounded p-1">
                                                    <span class="micro-header fw-bold text-muted ps-2"
                                                          style="font-size: 0.7rem">الإشعارات</span>
                                                    <span class="badge bg-warning text-dark"
                                                          id="complaints-notification-count-badge"
                                                          style="display:none;
                                                                 font-size: 0.6rem">0</span>
                                                </div>
                                            </div>
                                            <div id="complaints-notifications-list" class="px-1">
                                                <!-- JS will load items here -->
                                                <div class="text-center p-2 small text-muted">
                                                    <i class="fas fa-spinner fa-spin"></i>
                                                </div>
                                            </div>
                                            <div class="text-center mt-1 border-bottom pb-2">
                                                <button class="btn btn-xs btn-link text-danger text-decoration-none"
                                                        onclick="clearComplaintsNotifications()">
                                                    <small>مسح الإشعارات</small>
                                                </button>
                                            </div>
                                        {% endif %}
                                        <!-- Sub-header: Assignments -->
                                        {% if user|has_assignment_permissions %}
                                            <div class="px-2 mt-2">
                                                <div class="d-flex justify-content-between align-items-center bg-light border rounded p-1">
                                                    <span class="micro-header fw-bold text-muted ps-2"
                                                          style="font-size: 0.7rem">التعيينات والمهام</span>
                                                    <span class="badge bg-danger"
                                                          id="assignment-notification-badge"
                                                          style="display:none;
                                                                 font-size: 0.6rem">0</span>
                                                </div>
                                            </div>
                                            <div id="assignment-notifications-list" class="px-1">
                                                <!-- JS will load items here -->
                                                <div class="text-center p-2 small text-muted">
                                                    <i class="fas fa-spinner fa-spin"></i>
                                                </div>
                                            </div>
                                        {% endif %}
                                    </ul>
                                </div>
                            {% endif %}
                        </ul>
                    </div>
                {% endif %}
                <!-- Right Side Icons (Authenticated) -->
                {% if user.is_authenticated %}
                    <!-- تم نقل أيقونة الرسائل والمستخدمين إلى زر عائم (Floating Button) -->
                    <!-- زر التحويلات المخزنية لمسؤول المخزن -->
                    {% if is_warehouse_manager and not user.is_superuser %}
                        <a href="{% url 'inventory:stock_transfer_list' %}"
                           class="btn btn-outline-light position-relative me-3"
                           title="التحويلات المخزنية">
                            <i class="fas fa-exchange-alt"></i>
                            {% if pending_transfers_count > 0 %}
                                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
                                      style="font-size: 0.6rem">{{ pending_transfers_count }}</span>
                            {% endif %}
                            <span class="d-none d-lg-inline ms-1">التحويلات</span>
                        </a>
                    {% endif %}
                    <!-- أيقونة الإشعارات العامة -->
                    {% if not user.is_inspection_technician or user.is_superuser %}
                        <div class="dropdown me-3">
                            <button class="btn btn-outline-light position-relative"
                                    type="button"
                                    id="notificationsDropdown"
                                    data-bs-toggle="dropdown"
                                    aria-expanded="false"
                                    title="الإشعارات العامة">
                                <i class="fas fa-bell"></i>
                                {% if notifications_unread_count > 0 %}
                                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
                                          id="notification-count-badge">{{ notifications_unread_count }}</span>
                                {% else %}
                                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
                                          id="notification-count-badge"
                                          style="display: none">0</span>
                                {% endif %}
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end shadow-lg p-0"
                                aria-labelledby="notificationsDropdown">
                                <!-- رأس القائمة -->
                                <li>
                                    <div class="dropdown-header d-flex justify-content-between align-items-center py-2 px-3 bg-light border-bottom">
                                        <span class="fw-bold text-dark small">
                                            <i class="fas fa-bell me-1 text-primary"></i>الإشعارات
                                            {% if notifications_unread_count > 0 %}
                                                <span class="badge bg-primary rounded-pill ms-1" style="font-size: 0.65rem;">{{ notifications_unread_count }}</span>
                                            {% endif %}
                                        </span>
                                        {% if notifications_unread_count > 0 %}
                                            <button type="button"
                                                    class="btn btn-sm btn-outline-primary py-0 px-2"
                                                    onclick="markAllNotificationsRead()"
                                                    style="font-size: 0.7rem;">
                                                <i class="fas fa-check-double me-1"></i>تحديد الكل
                                            </button>
                                        {% endif %}
                                    </div>
                                </li>
                                <!-- قائمة الإشعارات -->
                                {% if recent_notifications %}
                                    {% for notification in recent_notifications %}
                                        {% with visibility=notification.visibility_records.all|first %}
                                        {% with icon_data=notification.get_icon_and_color %}
                                            <li>
                                                <a class="dropdown-item notification-dropdown-item px-3 py-2 {% if not visibility.is_read %}bg-light{% endif %}"
                                                   href="{{ notification.get_absolute_url }}"
                                                   data-notification-id="{{ notification.pk }}"
                                                   data-is-read="{% if visibility.is_read %}true{% else %}false{% endif %}">
                                                    <div class="d-flex gap-2 align-items-start">
                                                        <!-- أيقونة -->
                                                        <div class="notification-icon-wrapper flex-shrink-0"
                                                             style="width: 36px; height: 36px; border-radius: 50%;
                                                                    background: {{ icon_data.bg }}; border: 1.5px solid {{ icon_data.color }};
                                                                    display: flex; align-items: center; justify-content: center;">
                                                            <i class="{{ icon_data.icon }}" style="color: {{ icon_data.color }}; font-size: 14px;"></i>
                                                        </div>
                                                        <!-- محتوى -->
                                                        <div class="flex-grow-1" style="min-width: 0;">
                                                            <div class="d-flex justify-content-between align-items-center mb-0">
                                                                <h6 class="mb-0 text-truncate {% if not visibility.is_read %}fw-semibold text-dark{% else %}text-muted{% endif %}"
                                                                    style="font-size: 0.8rem; max-width: 260px;">
                                                                    {% if not visibility.is_read %}<i class="fas fa-circle text-primary me-1" style="font-size: 5px; vertical-align: middle;"></i>{% endif %}
                                                                    {{ notification.title }}
                                                                </h6>
                                                                <small class="text-muted flex-shrink-0 ms-2" style="font-size: 0.65rem;">
                                                                    {{ notification.created_at|timesince|truncatewords:2 }}
                                                                </small>
                                                            </div>
                                                            <p class="mb-0 text-muted" style="font-size: 0.72rem; line-height: 1.3;
                                                               display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical; overflow: hidden;">
                                                                {{ notification.message|truncatewords:12 }}
                                                            </p>
                                                            {% if notification.extra_data.customer_name or notification.extra_data.order_number or notification.created_by or notification.extra_data.changed_by %}
                                                                <div class="d-flex gap-1 mt-1 flex-wrap">
                                                                    {% if notification.created_by %}
                                                                        <span class="badge bg-light text-dark border" style="font-size: 0.6rem; font-weight: normal;">
                                                                            <i class="fas fa-user-edit text-primary me-1"></i>{{ notification.created_by.get_full_name|default:notification.created_by.username }}
                                                                        </span>
                                                                    {% elif notification.extra_data.changed_by %}
                                                                        <span class="badge bg-light text-dark border" style="font-size: 0.6rem; font-weight: normal;">
                                                                            <i class="fas fa-user-edit text-primary me-1"></i>{{ notification.extra_data.changed_by }}
                                                                        </span>
                                                                    {% endif %}
                                                                    {% if notification.extra_data.order_number %}
                                                                        <span class="badge bg-light text-dark border" style="font-size: 0.6rem; font-weight: normal;">
                                                                            <i class="fas fa-hashtag text-info me-1"></i>{{ notification.extra_data.order_number }}
                                                                        </span>
                                                                    {% endif %}
                                                                    {% if notification.extra_data.customer_name %}
                                                                        <span class="badge bg-light text-dark border" style="font-size: 0.6rem; font-weight: normal;">
                                                                            <i class="fas fa-user text-success me-1"></i>{{ notification.extra_data.customer_name|truncatewords:3 }}
                                                                        </span>
                                                                    {% endif %}
                                                                </div>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </a>
                                            </li>
                                        {% endwith %}
                                        {% endwith %}
                                    {% endfor %}
                                    <!-- رابط عرض الكل -->
                                    <li class="border-top">
                                        <a class="dropdown-item text-center py-2 text-primary fw-semibold" style="font-size: 0.8rem;"
                                           href="{% url 'notifications:list' %}">
                                            <i class="fas fa-list me-1"></i>عرض جميع الإشعارات
                                        </a>
                                    </li>
                                {% else %}
                                    <li>
                                        <div class="text-center text-muted py-4 px-3">
                                            <i class="fas fa-bell-slash fa-2x mb-2 d-block opacity-50"></i>
                                            <small>لا توجد إشعارات</small>
                                        </div>
                                    </li>
                                {% endif %}
                            </ul>
                        </div>
                    {% endif %}
                    <!-- زر المستخدم -->
                    <button class="btn btn-outline-light dropdown-toggle d-inline-flex align-items-center gap-2"
                            id="customUserBtn"
                            type="button">
                        <i class="fas fa-user"></i>
                        <div class="d-flex flex-column align-items-start lh-1 text-wrap text-start">
                            <span class="mb-1">{{ user.get_full_name|default:user.username }}</span>
                            <span class="badge bg-white text-primary bg-opacity-75 rounded-pill"
                                  style="font-size: 0.65em">{{ user.get_user_role_display }}</span>
                        </div>
                    </button>
                {% else %}
                    <a href="{% url 'accounts:login' %}" class="btn btn-outline-light"><i class="fas fa-sign-in-alt"></i> تسجيل الدخول</a>
                {% endif %}
            </div>
        </div>
    </div>
</nav>
<!-- تم إزالة صناديق الإشعارات -->
<!-- Branch Messages - Only shown on home page -->
{% if branch_messages and request.path == '/' %}
    <script>
        // Wait for all DOM content and resources to load for optimal display timing
        window.addEventListener('load', function () {
            const branchMessages = [
                {% for message in branch_messages %}
                    {
                title: "{{ message.title|escapejs }}",
                message: "{{ message.message|escapejs }}",
                type: "{{ message.message_type|escapejs }}",
                color: "{{ message.color|escapejs }}",
                icon: "{{ message.icon|escapejs }}",
                iconSize: "{{ message.icon_size|default:'medium'|escapejs }}",
                displayStyle: "{{ message.display_style|default:'sweetalert2'|escapejs }}",
                displayDuration: {{ message.display_duration|default:20 }},
            autoClose: {{ message.auto_close|yesno:"true,false" }},
            showCloseButton: {{ message.show_close_button|yesno:"true,false" }},
            allowOutsideClick: {{ message.allow_outside_click|yesno:"true,false" }}
                    }{% if not forloop.last %}, {% endif %}
        {% endfor %}
            ];

        let currentMessageIndex = 0;
        const showMessage = () => {
            if (currentMessageIndex >= branchMessages.length) return;

            const message = branchMessages[currentMessageIndex];
            currentMessageIndex++;

            Swal.fire({
                title: message.title,
                html: message.message,
                icon: getMessageIcon(message.type),
                timer: message.displayDuration ? message.displayDuration * 1000:20000,
                timerProgressBar: true,
                showClass: {
                    popup: 'animate__animated animate__zoomIn animate__faster'
                },
                hideClass: {
                    popup: 'animate__animated animate__zoomOut animate__faster'
                },
                customClass: {
                    popup: 'rtl-popup branch-message-popup',
                    title: 'rtl-title branch-message-title',
                    content: 'rtl-content branch-message-content',
                    container: 'branch-message-container'
                },
                showCloseButton: true,
                position: 'center',
                showConfirmButton: false,
                allowOutsideClick: true,
                width: '500px',
                padding: '2rem',
                background: getMessageBackground(message.color),
                backdrop: `
                        rgba(0,0,0,0.6)
                        center
                        no-repeat
                    `,
                didOpen: (toast) => {
                    const icon = document.createElement('i');
                    const iconSizeClass = getIconSizeClass(message.iconSize);
                    icon.className = `${message.icon} ${iconSizeClass}`;
                    const title = toast.querySelector('.swal2-title');
                    if (title) {
                        title.insertBefore(icon, title.firstChild);
                        icon.style.marginLeft = '10px';
                    }

                    if (message.autoClose) {
                        toast.addEventListener('mouseenter', Swal.stopTimer);
                        toast.addEventListener('mouseleave', Swal.resumeTimer);
                    }
                },
                didClose: () => {
                    setTimeout(() => {
                        if (currentMessageIndex < branchMessages.length) {
                            showMessage();
                        }
                    }, 500);
                }
            });
        };

        function getMessageIcon(type) {
            switch (type) {
                case 'welcome':
                    return 'success';
                case 'goal':
                    return 'info';
                case 'announcement':
                    return 'info';
                case 'holiday':
                    return 'warning';
                default:
                    return 'info';
            }
        }

        function getIconSizeClass(size) {
            switch (size) {
                case 'small': return 'fa-sm';
                case 'medium': return 'fa-lg';
                case 'large': return 'fa-2x';
                default: return 'fa-lg';
            }
        }

        function getMessageBackground(color) {
            switch (color) {
                case 'danger':
                    return '#f8d7da';
                case 'warning':
                    return '#fff3cd';
                case 'success':
                    return '#d4edda';
                case 'info':
                    return '#d1ecf1';
                default:
                    return '#ffffff';
            }
        }

        // Start showing messages after a short delay to ensure page is fully loaded
        setTimeout(showMessage, 500);
        });
    </script>
    <!-- Branch message CSS moved to base-layout.css -->
{% endif %}
<!-- قائمة المستخدم المنبثقة خارج تدفق الهيدر -->
<div id="customUserDropdown"
     class="custom-dropdown-menu"
     style="display:none;
            position:fixed;
            top:70px;
            left:90px;
            z-index:2147483647;
            min-width:260px;
            max-width:95vw;
            background:#fff;
            border-radius:12px;
            box-shadow:0 8px 32px rgba(0,0,0,0.18);
            border:1px solid #eee">
    <div class="dropdown-header fw-bold py-2 px-3 border-bottom">القائمة الشخصية</div>
    <div class="px-3 py-2">
        <label for="themeSelector" class="form-label" style="font-weight: bold;">اختر الثيم المناسب</label>
        <select id="themeSelector" class="form-select">
            <option value="default">الثيم الإفتراضي</option>
            <option value="custom-theme">نسخة الثيم الإفتراضي القابلة للتعديل</option>
            <option value="ornamental">الثيم الزخرفي</option>
            <option value="zakzak">ثيم ZakZak - أزرق وفضي</option>
        </select>
    </div>
    <hr class="my-1">
    <a class="dropdown-item" href="{% url 'accounts:profile' %}"><i class="fas fa-id-card"></i> الملف الشخصي</a>
    {% if user.is_staff %}
        <a class="dropdown-item" href="{% url 'admin:index' %}"><i class="fas fa-cog"></i> لوحة الإدارة</a>
        <a class="dropdown-item" href="{% url 'accounts:device_diagnostic' %}"><i class="fas fa-stethoscope"></i> تشخيص
        الجهاز</a>
        <a class="dropdown-item" href="{% url 'accounts:register_device' %}"><i class="fas fa-desktop"></i> تسجيل جهاز
        جديد</a>
    <a class="dropdown-item"
       href="{% url 'admin:accounts_branchdevice_changelist' %}"><i class="fas fa-list"></i>
إدارة الأجهزة</a>
{% endif %}
<hr class="my-1">
<a class="dropdown-item" href="{% url 'accounts:logout' %}"><i class="fas fa-sign-out-alt"></i> تسجيل الخروج</a>
</div>
<!-- User dropdown JS moved to base-utilities.js -->
<!-- Assigned Complaints Popup -->
<div id="assignedComplaintsPopup"
     class="assigned-complaints-popup"
     style="display: none">
    <div class="popup-content">
        <div class="popup-header">
            <h5>
                <i class="fas fa-exclamation-triangle text-warning me-2"></i>شكاوى مسندة إليك
            </h5>
            <div class="popup-controls">
                <button class="btn btn-sm btn-outline-secondary me-2"
                        onclick="snoozeComplaintsPopup()">
                    <i class="fas fa-clock"></i> تأجيل
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="hideComplaintsPopup()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        <div class="popup-body" id="assignedComplaintsContent">
            <div class="text-center">
                <i class="fas fa-spinner fa-spin"></i> جاري التحميل...
            </div>
        </div>
    </div>
</div>
<!-- Escalated Complaints Popup - للمستخدم المصعد له فقط -->
<div id="escalatedComplaintsPopup"
     class="escalated-complaints-popup"
     style="display: none">
    <div class="popup-content">
        <div class="popup-header bg-danger">
            <h5>
                <i class="fas fa-fire text-white me-2"></i>شكاوى مصعدة إليك - عاجل!
            </h5>
            <div class="popup-controls">
                <button class="btn btn-sm btn-outline-light me-2"
                        onclick="snoozeEscalatedPopup()">
                    <i class="fas fa-clock"></i> تأجيل
                </button>
                <button class="btn btn-sm btn-outline-light" onclick="hideEscalatedPopup()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        <div class="popup-body" id="escalatedComplaintsContent">
            <div class="text-center">
                <i class="fas fa-spinner fa-spin"></i> جاري التحميل...
            </div>
        </div>
    </div>
</div>
<!-- General System Notifications Popup -->
<div id="systemNotificationsPopup"
     class="system-notifications-popup"
     style="display: none">
    <div class="popup-content">
        <div class="popup-header system-popup-header">
            <h5>
                <i class="fas fa-bell text-white me-2"></i>إشعارات جديدة
            </h5>
            <div class="popup-controls">
                <button class="btn btn-sm btn-outline-light me-2"
                        onclick="snoozeSystemPopup()">
                    <i class="fas fa-clock"></i> تأجيل
                </button>
                <button class="btn btn-sm btn-outline-light" onclick="hideSystemPopup()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        <div class="popup-body" id="systemNotificationsContent">
            <div class="text-center">
                <i class="fas fa-spinner fa-spin"></i> جاري التحميل...
            </div>
        </div>
        <div class="popup-footer text-center p-2 border-top">
            <a href="/notifications/" class="btn btn-sm btn-outline-primary">
                <i class="fas fa-list me-1"></i>عرض جميع الإشعارات
            </a>
        </div>
    </div>
</div>
<!-- Main Content -->
<main class="container-fluid mt-4 flex-grow" id="main-content">
    {% block content %}{% endblock %}
</main>
<!-- Django Messages as Toast Notifications (Only for non-messages pages) -->
{% if messages and 'messages' not in request.path %}
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            {% for message in messages %}showToastNotification('{{ message.tags }}', '{{ message|escapejs }}');{% endfor %}
        });
    </script>
{% endif %}
<!-- Footer المُحسَّن - تصميم ثلاثي الأعمدة متوازن -->
<footer class="footer-area bg-primary py-3" id="main-footer">
    <div class="container-fluid">
        <div class="row align-items-center">
            <!-- العمود الأول (يسار): معلومات الاتصال -->
            <div class="col-md-4 footer-section contact-section text-start">
                <div class="d-flex align-items-center gap-3">
                    {% if company_info.email %}
                        <a href="mailto:{{ company_info.email }}"
                           class="footer-contact-item"
                           title="البريد الإلكتروني">
                            <i class="fas fa-at footer-icon-email"></i>
                            <span class="d-none d-lg-inline small">{{ company_info.email }}</span>
                        </a>
                    {% endif %}
                    {% if company_info.phone %}
                        <a href="tel:{{ company_info.phone }}"
                           class="footer-contact-item"
                           title="رقم الهاتف">
                            <i class="fas fa-phone-alt footer-icon-phone"></i>
                            <span class="d-none d-lg-inline small">{{ company_info.phone }}</span>
                        </a>
                    {% endif %}
                </div>
            </div>
            <!-- العمود الثاني (منتصف): الروابط السريعة -->
            <div class="col-md-4 footer-section links-section text-center">
                <div class="d-flex justify-content-center gap-4">
                    <a href="{% url 'home' %}" class="footer-link" title="الرئيسية">
                        <i class="fas fa-home"></i>
                    </a>
                    <a href="{% url 'about' %}" class="footer-link" title="عن الشركة">
                        <i class="fas fa-info-circle text-info"></i>
                    </a>
                    <a href="{% url 'contact' %}" class="footer-link" title="اتصل بنا">
                        <i class="fas fa-envelope text-primary"></i>
                    </a>
                </div>
            </div>
            <!-- العمود الثالث (يمين): اسم الشركة والبراند -->
            <div class="col-md-4 footer-section brand-section text-end">
                <div class="d-flex align-items-center justify-content-end gap-2">
                    <h6 class="footer-title mb-0">{{ company_info.name }}</h6>
                    <i class="fas fa-building footer-icon-brand"></i>
                </div>
            </div>
        </div>
        <!-- سطر الحقوق السفلي -->
        <div class="row mt-3 pt-2 border-top border-white border-opacity-10">
            <div class="col-12 text-center">
                <p class="copyright-text mb-0 small">
                    <i class="far fa-copyright me-1"></i>
                    {{ current_year }}
                    {{ company_info.copyright_text|default:"جميع الحقوق محفوظة لشركة الخواجة للستائر والمفروشات تطوير zakee tahawi" }}
                </p>
            </div>
        </div>
    </div>
</footer>
<!-- Footer CSS moved to base-layout.css -->
<!-- jQuery - محلي -->
<script src="{% static 'vendor/jquery/jquery-3.7.1.min.js' %}"></script>
<!-- Bootstrap Bundle with Popper - محلي -->
<script src="{% static 'vendor/bootstrap/bootstrap.bundle.min.js' %}"></script>
<!-- DataTables JS - يُحمّل فقط في الصفحات التي تحتاجه -->
{% block datatables_js %}{% endblock %}
<!-- SweetAlert2 - محلي -->
<script src="{% static 'vendor/sweetalert2/sweetalert2.all.min.js' %}" defer></script>
<!-- Custom JS -->
<script src="{% static 'js/main.js' %}" defer></script>
<!-- smooth-navigation.js removed: was causing page flash by setting body.opacity=0 -->
<script src="{% static 'js/custom-theme-animations.js' %}" defer></script>
<!-- Database Connection Test JS -->
{% if 'database' in request.path %}
    <script src="{% static 'js/db_connection_test.js' %}"></script>
{% endif %}
<!-- Restore Alert, Logo Update JS moved to base-utilities.js -->
<!-- Base Utilities JS (modal fix, dropdown, toast, etc.) -->
<script src="{% static 'js/base-utilities.js' %}" defer></script>
{% block extra_js %}
{% endblock %}
<!-- Notifications JS (extracted to external file) -->
{% if user.is_authenticated %}
    <script src="{% static 'js/base-notifications.js' %}"></script>
{% endif %}
<!-- CSRF Token للإشعارات -->
{% csrf_token %}
<!-- معالج CSRF التلقائي -->
<script src="{% static 'js/csrf-handler.js' %}" defer></script>
<!-- Popup CSS moved to base-layout.css -->
<!-- JavaScript للرسائل الداخلية والمستخدمين النشطين -->
{% if user.is_authenticated %}
    <script src="{% static 'js/internal_messages_dropdown.js' %}"></script>
{% endif %}
<!-- مكان مخصص للمودلز (Modals) لتجنب مشاكل التداخل (z-index/stacking context) -->
{% block modals %}
{% endblock %}
<!-- نافذة فحص الباركود (للمستخدمين المسجلين فقط) -->
{% if user.is_authenticated %}
    {% include 'barcode_scanner_modal.html' %}
{% endif %}
<!-- Floating Chat Button Include + JS -->
{% if user.is_authenticated %}
    {% include 'includes/floating_chat_button.html' %}
    <script src="{% static 'js/floating-button.js' %}?v=2.2.0" defer></script>
{% endif %}
<!-- Arabic to English Number Converter -->
<script src="{% static 'js/arabic-numbers-converter.js' %}" defer></script>
</body>
</html>
