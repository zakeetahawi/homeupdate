{% extends "base.html" %}
{% load static %}
{% block title %}Ù„ÙˆØ­Ø© Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù†Ø¸Ø§Ù…{% endblock %}
{% block extra_css %}
    <style>
    .monitoring-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
    }
    
    .status-normal { background-color: #28a745; }
    .status-warning { background-color: #ffc107; }
    .status-critical { background-color: #dc3545; }
    .status-emergency { background-color: #6f42c1; }
    
    .metric-value {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 5px;
    }
    
    .metric-label {
        color: #6c757d;
        font-size: 0.9rem;
    }
    
    .progress-bar-custom {
        height: 8px;
        border-radius: 4px;
        background-color: #e9ecef;
        overflow: hidden;
        margin-top: 5px;
    }
    
    .progress-fill {
        height: 100%;
        transition: width 0.3s ease;
    }
    
    .alert-item {
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 4px;
        border-left: 4px solid;
    }
    
    .alert-warning {
        background-color: #fff3cd;
        border-left-color: #ffc107;
    }
    
    .alert-critical {
        background-color: #f8d7da;
        border-left-color: #dc3545;
    }
    
    .alert-emergency {
        background-color: #e2e3f0;
        border-left-color: #6f42c1;
    }
    
    .refresh-indicator {
        display: inline-block;
        margin-left: 10px;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .refresh-indicator.active {
        opacity: 1;
    }
    
    .action-button {
        margin: 5px;
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
    }
    
    .btn-cleanup {
        background-color: #17a2b8;
        color: white;
    }
    
    .btn-emergency {
        background-color: #dc3545;
        color: white;
    }
    
    .btn-optimize {
        background-color: #28a745;
        color: white;
    }
    </style>
{% endblock %}
{% block content %}
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <h1>
                    ğŸ” Ù„ÙˆØ­Ø© Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù†Ø¸Ø§Ù…
                    <span class="refresh-indicator" id="refreshIndicator">
                        <i class="fas fa-sync-alt fa-spin"></i>
                    </span>
                </h1>
                <p class="text-muted">Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§ØªØµØ§Ù„Ø§Øª Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ£Ø¯Ø§Ø¡ Ø§Ù„Ù†Ø¸Ø§Ù… ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ÙØ¹Ù„ÙŠ</p>
            </div>
        </div>
        <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª -->
        <div class="row">
            <div class="col-md-3">
                <div class="monitoring-card">
                    <div class="d-flex align-items-center">
                        <span class="status-indicator" id="dbStatusIndicator"></span>
                        <h5 class="mb-0">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª</h5>
                    </div>
                    <div class="metric-value" id="totalConnections">--</div>
                    <div class="metric-label">Ù…Ù† Ø£ØµÙ„ 200 Ø§ØªØµØ§Ù„</div>
                    <div class="progress-bar-custom">
                        <div class="progress-fill" id="connectionsProgress"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="monitoring-card">
                    <h5>Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©</h5>
                    <div class="metric-value" id="activeConnections">--</div>
                    <div class="metric-label">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="monitoring-card">
                    <h5>Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª Ø§Ù„Ø®Ø§Ù…Ù„Ø©</h5>
                    <div class="metric-value" id="idleConnections">--</div>
                    <div class="metric-label">ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø±</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="monitoring-card">
                    <h5>Ù…Ø¹Ù„Ù‚Ø© ÙÙŠ Ù…Ø¹Ø§Ù…Ù„Ø©</h5>
                    <div class="metric-value" id="idleInTransaction">--</div>
                    <div class="metric-label">ØªØ­ØªØ§Ø¬ ØªÙ†Ø¸ÙŠÙ</div>
                </div>
            </div>
        </div>
        <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù… -->
        <div class="row">
            <div class="col-md-4">
                <div class="monitoring-card">
                    <h5>Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø°Ø§ÙƒØ±Ø©</h5>
                    <div class="metric-value" id="memoryUsage">--</div>
                    <div class="metric-label">Ù…Ù† Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø©</div>
                    <div class="progress-bar-custom">
                        <div class="progress-fill" id="memoryProgress"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="monitoring-card">
                    <h5>Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬</h5>
                    <div class="metric-value" id="cpuUsage">--</div>
                    <div class="metric-label">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…</div>
                    <div class="progress-bar-custom">
                        <div class="progress-fill" id="cpuProgress"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="monitoring-card">
                    <h5>Ø¹Ø¯Ø¯ Ø§Ù„Ø®ÙŠÙˆØ·</h5>
                    <div class="metric-value" id="threadCount">--</div>
                    <div class="metric-label">Ø®ÙŠØ· Ù†Ø´Ø·</div>
                </div>
            </div>
        </div>
        <!-- Ø§Ù„ØªØ­Ø°ÙŠØ±Ø§Øª ÙˆØ§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª -->
        <div class="row">
            <div class="col-md-8">
                <div class="monitoring-card">
                    <h5>Ø§Ù„ØªØ­Ø°ÙŠØ±Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©</h5>
                    <div id="alertsContainer">
                        <p class="text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ­Ø°ÙŠØ±Ø§Øª Ù†Ø´Ø·Ø©</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="monitoring-card">
                    <h5>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø³Ø±ÙŠØ¹Ø©</h5>
                    <div class="d-flex flex-column">
                        <button class="action-button btn-cleanup" onclick="performAction('cleanup')">ğŸ§¹ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª Ø§Ù„Ø®Ø§Ù…Ù„Ø©</button>
                        <button class="action-button btn-emergency"
                                onclick="performAction('emergency')">ğŸš¨ ØªÙ†Ø¸ÙŠÙ Ø·ÙˆØ§Ø±Ø¦</button>
                        <button class="action-button btn-optimize"
                                onclick="performAction('optimize')">âš¡ ØªØ­Ø³ÙŠÙ† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© -->
        <div class="row">
            <div class="col-12">
                <div class="monitoring-card">
                    <h5>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <p>
                                <strong>Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«:</strong> <span id="lastUpdate">--</span>
                            </p>
                            <p>
                                <strong>Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©:</strong> <span id="monitoringStatus">--</span>
                            </p>
                        </div>
                        <div class="col-md-6">
                            <p>
                                <strong>ÙˆÙ‚Øª Ø§Ù„ØªØ´ØºÙŠÙ„:</strong> <span id="uptime">--</span>
                            </p>
                            <p>
                                <strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ­Ø°ÙŠØ±Ø§Øª:</strong> <span id="totalAlerts">--</span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
{% block extra_js %}
    <script>
let refreshInterval;
let isRefreshing = false;

// Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
document.addEventListener('DOMContentLoaded', function() {
    loadMonitoringData();
    startAutoRefresh();
});

// ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©
async function loadMonitoringData() {
    if (isRefreshing) return;
    
    isRefreshing = true;
    showRefreshIndicator();
    
    try {
        // ØªØ­Ù…ÙŠÙ„ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const dbResponse = await fetch('/api/monitoring/database/');
        const dbData = await dbResponse.json();
        
        if (dbData.success) {
            updateDatabaseStats(dbData.data);
        }
        
        // ØªØ­Ù…ÙŠÙ„ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
        const systemResponse = await fetch('/api/monitoring/system/');
        const systemData = await systemResponse.json();
        
        if (systemData.success) {
            updateSystemStats(systemData.data);
        }
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ­Ø°ÙŠØ±Ø§Øª
        const alertsResponse = await fetch('/api/monitoring/alerts/');
        const alertsData = await alertsResponse.json();
        
        if (alertsData.success) {
            updateAlerts(alertsData.data);
        }
        
        // ØªØ­Ø¯ÙŠØ« ÙˆÙ‚Øª Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«
        document.getElementById('lastUpdate').textContent = new Date().toLocaleString('ar-EG');
        
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©:', error);
    } finally {
        isRefreshing = false;
        hideRefreshIndicator();
    }
}

// ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
function updateDatabaseStats(data) {
    document.getElementById('totalConnections').textContent = data.total_connections;
    document.getElementById('activeConnections').textContent = data.active_connections;
    document.getElementById('idleConnections').textContent = data.idle_connections;
    document.getElementById('idleInTransaction').textContent = data.idle_in_transaction;
    
    // ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
    const percentage = (data.total_connections / 200) * 100;
    const progressBar = document.getElementById('connectionsProgress');
    progressBar.style.width = percentage + '%';
    
    // ØªØ­Ø¯ÙŠØ« Ù„ÙˆÙ† Ø§Ù„Ø­Ø§Ù„Ø©
    const indicator = document.getElementById('dbStatusIndicator');
    const statusClass = getStatusClass(data.status_level);
    indicator.className = 'status-indicator ' + statusClass;
    
    // ØªØ­Ø¯ÙŠØ« Ù„ÙˆÙ† Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
    progressBar.className = 'progress-fill ' + getProgressColor(data.status_level);
}

// ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
function updateSystemStats(data) {
    if (data.memory) {
        document.getElementById('memoryUsage').textContent = data.memory.percent.toFixed(1) + '%';
        document.getElementById('memoryProgress').style.width = data.memory.percent + '%';
        document.getElementById('memoryProgress').className = 'progress-fill ' + getProgressColor(
            data.memory.percent > 90 ? 'critical' : data.memory.percent > 70 ? 'warning' : 'normal'
        );
    }
    
    if (data.cpu) {
        document.getElementById('cpuUsage').textContent = data.cpu.percent.toFixed(1) + '%';
        document.getElementById('cpuProgress').style.width = data.cpu.percent + '%';
        document.getElementById('cpuProgress').className = 'progress-fill ' + getProgressColor(
            data.cpu.percent > 90 ? 'critical' : data.cpu.percent > 70 ? 'warning' : 'normal'
        );
    }
    
    if (data.process) {
        document.getElementById('threadCount').textContent = data.process.num_threads;
    }
}

// ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ­Ø°ÙŠØ±Ø§Øª
function updateAlerts(data) {
    const container = document.getElementById('alertsContainer');
    
    if (data.active_alerts.length === 0) {
        container.innerHTML = '<p class="text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ­Ø°ÙŠØ±Ø§Øª Ù†Ø´Ø·Ø©</p>';
    } else {
        container.innerHTML = data.active_alerts.map(alert => `
            <div class="alert-item alert-${alert.level}">
                <strong>${alert.type}:</strong> ${alert.message}
                <small class="d-block text-muted">${new Date(alert.timestamp).toLocaleString('ar-EG')}</small>
            </div>
        `).join('');
    }
    
    document.getElementById('totalAlerts').textContent = data.total_alerts;
}

// ØªÙ†ÙÙŠØ° Ø¥Ø¬Ø±Ø§Ø¡
async function performAction(action) {
    const button = event.target;
    const originalText = button.textContent;
    
    button.disabled = true;
    button.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°...';
    
    try {
        const response = await fetch('/api/monitoring/actions/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                action: action === 'emergency' ? 'cleanup' : action,
                force: action === 'emergency'
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('âœ… ' + data.message);
            loadMonitoringData(); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        } else {
            alert('âŒ Ø®Ø·Ø£: ' + data.error);
        }
        
    } catch (error) {
        alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ' + error.message);
    } finally {
        button.disabled = false;
        button.textContent = originalText;
    }
}

// Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø©
function getStatusClass(level) {
    switch (level) {
        case 'emergency': return 'status-emergency';
        case 'critical': return 'status-critical';
        case 'warning': return 'status-warning';
        default: return 'status-normal';
    }
}

function getProgressColor(level) {
    switch (level) {
        case 'emergency': return 'bg-purple';
        case 'critical': return 'bg-danger';
        case 'warning': return 'bg-warning';
        default: return 'bg-success';
    }
}

function showRefreshIndicator() {
    document.getElementById('refreshIndicator').classList.add('active');
}

function hideRefreshIndicator() {
    document.getElementById('refreshIndicator').classList.remove('active');
}

function startAutoRefresh() {
    refreshInterval = setInterval(loadMonitoringData, 30000); // ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØµÙØ­Ø©
window.addEventListener('beforeunload', function() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
    }
});
    </script>
{% endblock %}
