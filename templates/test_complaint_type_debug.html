{% load static %}
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>اختبار نوع الشكوى - تشخيص المشكلة</title>
    <link href="{% static 'vendor/bootstrap/css/bootstrap.rtl.min.css' %}" rel="stylesheet">
    <link href="{% static 'vendor/fontawesome/css/all.min.css' %}" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <div class="row">
            <div class="col-md-8 mx-auto">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h4><i class="fas fa-bug me-2"></i>اختبار نوع الشكوى - تشخيص المشكلة</h4>
                    </div>
                    <div class="card-body">
                        
                        <!-- اختيار نوع الشكوى -->
                        <div class="mb-3">
                            <label class="form-label">اختر نوع الشكوى للاختبار:</label>
                            <select id="complaint_type_select" class="form-select">
                                <option value="">-- اختر نوع الشكوى --</option>
                            </select>
                        </div>

                        <!-- نتائج الاختبار -->
                        <div id="test_results" class="d-none">
                            <hr>
                            <h5><i class="fas fa-chart-line me-2"></i>نتائج الاختبار</h5>
                            
                            <!-- معلومات نوع الشكوى -->
                            <div class="alert alert-info">
                                <h6><i class="fas fa-info-circle me-2"></i>معلومات نوع الشكوى</h6>
                                <div id="complaint_type_info"></div>
                            </div>

                            <!-- الموظفين المتاحين -->
                            <div class="alert alert-success">
                                <h6><i class="fas fa-users me-2"></i>الموظفين المتاحين للتعيين</h6>
                                <div id="available_staff"></div>
                            </div>

                            <!-- الأقسام المتاحة -->
                            <div class="alert alert-warning">
                                <h6><i class="fas fa-building me-2"></i>الأقسام المتاحة</h6>
                                <div id="available_departments"></div>
                            </div>

                            <!-- البيانات الخام -->
                            <div class="alert alert-secondary">
                                <h6><i class="fas fa-code me-2"></i>البيانات الخام (JSON)</h6>
                                <pre id="raw_data" class="small"></pre>
                            </div>
                        </div>

                        <!-- رسائل الخطأ -->
                        <div id="error_message" class="alert alert-danger d-none">
                            <h6><i class="fas fa-exclamation-triangle me-2"></i>خطأ</h6>
                            <div id="error_details"></div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="{% static 'vendor/bootstrap/js/bootstrap.bundle.min.js' %}"></script>
    <script src="{% static 'vendor/jquery/jquery-3.7.1.min.js' %}"></script>
    
    <script>
        $(document).ready(function() {
            // جلب أنواع الشكاوى المتاحة
            loadComplaintTypes();

            // عند تغيير نوع الشكوى
            $('#complaint_type_select').change(function() {
                const typeId = $(this).val();
                if (typeId) {
                    testComplaintType(typeId);
                } else {
                    hideResults();
                }
            });
        });

        function loadComplaintTypes() {
            $.ajax({
                url: '/complaints/api/complaint-types/',
                method: 'GET',
                success: function(data) {
                    const select = $('#complaint_type_select');
                    select.empty();
                    select.append('<option value="">-- اختر نوع الشكوى --</option>');
                    
                    if (data.results) {
                        data.results.forEach(function(type) {
                            select.append(`<option value="${type.id}">${type.name}</option>`);
                        });
                    }
                },
                error: function(xhr, status, error) {
                    showError('فشل في جلب أنواع الشكاوى', error);
                }
            });
        }

        function testComplaintType(typeId) {
            console.log('اختبار نوع الشكوى:', typeId);
            
            $.ajax({
                url: `/complaints/api/complaint-types/${typeId}/`,
                method: 'GET',
                success: function(data) {
                    console.log('نتائج الاختبار:', data);
                    displayResults(data);
                },
                error: function(xhr, status, error) {
                    console.error('خطأ في الاختبار:', error);
                    showError('فشل في اختبار نوع الشكوى', `${status}: ${error}`);
                }
            });
        }

        function displayResults(data) {
            hideError();
            
            // معلومات نوع الشكوى
            $('#complaint_type_info').html(`
                <p><strong>الاسم:</strong> ${data.name || 'غير محدد'}</p>
                <p><strong>الوصف:</strong> ${data.description || 'غير محدد'}</p>
                <p><strong>القسم الافتراضي:</strong> ${data.default_department || 'غير محدد'}</p>
                <p><strong>المسؤول الافتراضي:</strong> ${data.default_assignee || 'غير محدد'}</p>
                <p><strong>الأولوية الافتراضية:</strong> ${data.default_priority || 'غير محدد'}</p>
                <p><strong>المهلة الافتراضية:</strong> ${data.default_deadline_hours || 'غير محدد'} ساعة</p>
            `);

            // الموظفين المتاحين
            let staffHtml = '';
            if (data.staff && data.staff.length > 0) {
                staffHtml = '<ul class="list-unstyled">';
                data.staff.forEach(function(staff) {
                    const defaultBadge = staff.is_default ? '<span class="badge bg-success">افتراضي</span>' : '';
                    const sourceBadge = staff.source ? `<span class="badge bg-info">${staff.source}</span>` : '';
                    const permissionsBadge = staff.has_permissions ? '<span class="badge bg-primary">له صلاحيات</span>' : '<span class="badge bg-secondary">بدون صلاحيات</span>';
                    
                    staffHtml += `
                        <li class="mb-2">
                            <strong>${staff.name}</strong> (${staff.username})
                            ${defaultBadge} ${sourceBadge} ${permissionsBadge}
                            <br><small class="text-muted">القسم: ${staff.department || 'غير محدد'}</small>
                        </li>
                    `;
                });
                staffHtml += '</ul>';
            } else {
                staffHtml = '<p class="text-danger">لا توجد موظفين متاحين!</p>';
            }
            $('#available_staff').html(staffHtml);

            // الأقسام المتاحة
            let deptHtml = '';
            if (data.departments && data.departments.length > 0) {
                deptHtml = '<ul class="list-unstyled">';
                data.departments.forEach(function(dept) {
                    const defaultBadge = dept.is_default ? '<span class="badge bg-success">افتراضي</span>' : '';
                    deptHtml += `<li><strong>${dept.name}</strong> ${defaultBadge}</li>`;
                });
                deptHtml += '</ul>';
            } else {
                deptHtml = '<p class="text-danger">لا توجد أقسام متاحة!</p>';
            }
            $('#available_departments').html(deptHtml);

            // البيانات الخام
            $('#raw_data').text(JSON.stringify(data, null, 2));

            $('#test_results').removeClass('d-none');
        }

        function showError(title, details) {
            $('#error_details').html(`<strong>${title}</strong><br>${details}`);
            $('#error_message').removeClass('d-none');
            hideResults();
        }

        function hideError() {
            $('#error_message').addClass('d-none');
        }

        function hideResults() {
            $('#test_results').addClass('d-none');
        }
    </script>
</body>
</html>
