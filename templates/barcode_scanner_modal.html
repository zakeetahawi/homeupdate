{% load static %}

<!-- تنسيق المودال -->
<style>
    #scannerModal .modal-content {
        border-radius: var(--radius-large, 12px);
        overflow: hidden;
        border: 1px solid var(--border, #DED5CE);
    }
    #scannerModal .scanner-modal-header {
        background: var(--primary, #8B735A);
        color: #fff;
        border-bottom: none;
    }
    #scannerModal .scanner-modal-header .btn-close {
        filter: brightness(0) invert(1);
        opacity: .85;
    }
    #scannerModal .scanner-modal-header .btn-close:hover {
        opacity: 1;
    }
    #scannerModal .scanner-tools-bar {
        background: var(--surface, #F8F8F8);
        border-bottom: 1px solid var(--border, #DED5CE);
    }
    #scannerModal .scanner-tool-btn {
        border: 1px solid var(--border, #DED5CE);
        background: var(--card-bg, #fff);
        color: var(--text-secondary, #6D6055);
        border-radius: var(--radius, 8px);
        transition: var(--transition, all 0.3s ease);
        font-size: 0.82rem;
        padding: 0.35rem 0.75rem;
    }
    #scannerModal .scanner-tool-btn:hover {
        background: var(--primary, #8B735A);
        color: #fff;
        border-color: var(--primary, #8B735A);
    }
    #scannerModal .scanner-tool-btn.active-camera {
        background: var(--error, #F44336);
        color: #fff;
        border-color: var(--error, #F44336);
    }
    #scannerModal .search-input {
        border: 1px solid var(--border, #DED5CE);
        border-radius: var(--radius, 8px);
        transition: var(--transition, all 0.3s ease);
    }
    #scannerModal .search-input:focus {
        border-color: var(--primary, #8B735A);
        box-shadow: 0 0 0 0.2rem rgba(139, 115, 90, 0.15);
    }
    #scannerModal .search-btn {
        background: var(--primary, #8B735A);
        border-color: var(--primary, #8B735A);
        color: #fff;
        border-radius: 0 var(--radius, 8px) var(--radius, 8px) 0 !important;
    }
    #scannerModal .search-btn:hover {
        background: var(--accent, #5F4B32);
        border-color: var(--accent, #5F4B32);
    }
    #scannerModal #reader {
        border: 2px solid var(--primary, #8B735A) !important;
        border-radius: var(--radius, 8px);
    }
    #scannerModal .autocomplete-item {
        border-bottom: 1px solid var(--separator, #E8DCCA);
        transition: background 0.15s;
    }
    #scannerModal .autocomplete-item:last-child { border-bottom: none; }
    #scannerModal .autocomplete-item:hover,
    #scannerModal .autocomplete-item:focus {
        background: var(--surface, #F8F8F8);
    }
    /* بطاقة المنتج */
    #scannerModal .product-result-card {
        background: var(--card-bg, #fff);
        border: 1px solid var(--border, #DED5CE);
        border-radius: var(--radius-large, 12px);
        overflow: hidden;
    }
    #scannerModal .product-result-header {
        background: var(--primary, #8B735A);
        color: #fff;
        padding: 0.75rem 1rem;
    }
    #scannerModal .product-result-body {
        padding: 1rem;
    }
    #scannerModal .product-info-row {
        display: flex;
        justify-content: space-between;
        padding: 0.45rem 0;
        border-bottom: 1px solid var(--separator, #E8DCCA);
        font-size: 0.875rem;
    }
    #scannerModal .product-info-row:last-child { border-bottom: none; }
    #scannerModal .product-info-row .info-label {
        color: var(--text-tertiary, #8B8178);
    }
    #scannerModal .product-info-row .info-value {
        color: var(--text-primary, #3D3427);
        font-weight: 600;
    }
    #scannerModal .warehouse-chip {
        display: inline-block;
        background: var(--surface, #F8F8F8);
        border: 1px solid var(--border, #DED5CE);
        border-radius: 20px;
        padding: 0.2rem 0.65rem;
        font-size: 0.78rem;
        color: var(--text-secondary, #6D6055);
        margin: 0.15rem;
    }
</style>

<!-- نافذة فحص الباركود - Bootstrap 5 Modal -->
<div class="modal fade" id="scannerModal" tabindex="-1" aria-labelledby="scannerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow-lg">
            <!-- Header -->
            <div class="modal-header scanner-modal-header py-2">
                <h6 class="modal-title fw-bold mb-0" id="scannerModalLabel">
                    <i class="fas fa-barcode me-2"></i>فحص باركود / بحث عن منتج
                </h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
            </div>

            <!-- شريط الأدوات -->
            <div class="scanner-tools-bar d-flex gap-2 justify-content-center p-2">
                <button class="scanner-tool-btn" id="startCameraBtn">
                    <i class="fas fa-camera me-1"></i>الكاميرا
                </button>
                <button class="scanner-tool-btn active-camera d-none" id="stopCameraBtn">
                    <i class="fas fa-stop me-1"></i>إيقاف
                </button>
                <input type="file" id="imageInput" accept="image/*" capture="environment" class="d-none">
                <label for="imageInput" class="scanner-tool-btn mb-0" role="button" style="cursor:pointer;">
                    <i class="fas fa-image me-1"></i>صورة
                </label>
            </div>

            <div class="modal-body px-3 py-3" style="max-height: 75vh; overflow-y: auto;">
                <!-- طلب الأذونات -->
                <div class="alert alert-success d-none text-center py-2 small" id="permissionRequest">
                    <i class="fas fa-camera d-block mb-1" style="font-size:1.4rem;"></i>
                    <strong>نحتاج إلى إذن الكاميرا</strong>
                    <p class="mb-1" style="font-size:.78rem;">يرجى السماح بالوصول إلى الكاميرا</p>
                    <button class="btn btn-success btn-sm py-0 px-3" id="requestPermissionBtn">
                        <i class="fas fa-check-circle me-1"></i>منح الإذن
                    </button>
                </div>

                <!-- تنبيه HTTPS -->
                <div class="alert alert-warning d-none small py-2 mb-2" id="httpsWarning">
                    <i class="fas fa-exclamation-triangle me-1"></i>
                    الكاميرا تعمل فقط على <strong>HTTPS</strong> أو <strong>localhost</strong>.
                </div>

                <!-- خطأ الكاميرا -->
                <div class="alert alert-danger d-none small py-2 mb-2" id="cameraError">
                    <i class="fas fa-times-circle me-1"></i>
                    فشل تشغيل الكاميرا. استخدم الإدخال اليدوي أو رفع صورة.
                </div>

                <!-- عنصر القارئ -->
                <div id="reader" class="d-none overflow-hidden mb-3"></div>

                <!-- حقل البحث مع Autocomplete -->
                <div class="position-relative">
                    <label class="form-label small mb-1" style="color: var(--text-tertiary, #8B8178);">
                        <i class="fas fa-search me-1"></i>بحث بالكود أو اسم المنتج
                    </label>
                    <div class="input-group">
                        <input type="text"
                               id="manualBarcodeInput"
                               class="form-control search-input"
                               placeholder="ادخل كود الصنف أو اسم المنتج..."
                               autocomplete="off"
                               dir="auto">
                        <button class="btn search-btn" type="button" id="manualScanBtn">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
                <!-- قائمة الاقتراحات (inline - توسّع المودال) -->
                <div id="autocompleteDropdown"
                     class="border rounded-2 mt-1 py-0"
                     style="max-height: 270px; overflow-y: auto; display: none; border-color: var(--border, #DED5CE) !important; background: var(--card-bg, #fff);">
                </div>

                <!-- عرض النتيجة -->
                <div id="scanResult" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript -->
<script src="{% static 'vendor/qrcode/html5-qrcode.min.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const openScannerBtn = document.getElementById('openScannerBtn');
    const scannerModal = document.getElementById('scannerModal');
    const startCameraBtn = document.getElementById('startCameraBtn');
    const stopCameraBtn = document.getElementById('stopCameraBtn');
    const readerElement = document.getElementById('reader');
    const manualBarcodeInput = document.getElementById('manualBarcodeInput');
    const manualScanBtn = document.getElementById('manualScanBtn');
    const scanResult = document.getElementById('scanResult');
    const permissionRequest = document.getElementById('permissionRequest');
    const requestPermissionBtn = document.getElementById('requestPermissionBtn');
    const autocompleteDropdown = document.getElementById('autocompleteDropdown');

    let html5QrCode = null;
    let isScanning = false;
    let isCameraRunning = false;
    let bsModal = null;
    let autocompleteTimer = null;

    // تهيئة Bootstrap Modal
    if (scannerModal) {
        bsModal = new bootstrap.Modal(scannerModal);
    }

    // فتح النافذة
    if (openScannerBtn) {
        openScannerBtn.addEventListener('click', function() {
            if (bsModal) bsModal.show();
        });
    }

    // عند فتح النافذة - focus على حقل البحث
    scannerModal.addEventListener('shown.bs.modal', function() {
        manualBarcodeInput.focus();
    });

    // عند إغلاق النافذة
    scannerModal.addEventListener('hidden.bs.modal', function() {
        stopCamera();
        scanResult.innerHTML = '';
        manualBarcodeInput.value = '';
        document.getElementById('httpsWarning').classList.add('d-none');
        document.getElementById('cameraError').classList.add('d-none');
        permissionRequest.classList.add('d-none');
        hideAutocomplete();
        const imageInput = document.getElementById('imageInput');
        if (imageInput) imageInput.value = '';
    });

    // ============ AUTOCOMPLETE ============
    manualBarcodeInput.addEventListener('input', function() {
        const query = this.value.trim();
        clearTimeout(autocompleteTimer);

        if (query.length < 2) {
            hideAutocomplete();
            return;
        }

        autocompleteTimer = setTimeout(() => {
            fetchAutocomplete(query);
        }, 250);
    });

    function fetchAutocomplete(query) {
        fetch(`/inventory/api/product-autocomplete/?query=${encodeURIComponent(query)}`)
            .then(r => r.json())
            .then(results => {
                if (!results || results.length === 0) {
                    hideAutocomplete();
                    return;
                }
                showAutocomplete(results);
            })
            .catch(() => hideAutocomplete());
    }

    function showAutocomplete(results) {
        autocompleteDropdown.innerHTML = '';
        results.forEach(item => {
            const el = document.createElement('button');
            el.type = 'button';
            el.className = 'dropdown-item autocomplete-item d-flex justify-content-between align-items-center py-2 px-3';
            el.style.whiteSpace = 'normal';
            el.style.cursor = 'pointer';

            const stockClass = item.current_stock > 0 ? 'text-success' : 'text-danger';
            const stockIcon = item.current_stock > 0 ? 'check-circle' : 'times-circle';

            el.innerHTML = `
                <div class="flex-grow-1 me-2">
                    <div class="fw-semibold" style="font-size:.85rem; color: var(--text-primary, #3D3427);">${item.name}</div>
                    <div style="font-size: 0.75rem; color: var(--text-tertiary, #8B8178);">
                        ${item.code ? '<i class="fas fa-barcode me-1"></i>' + item.code : ''}
                        ${item.category ? ' · ' + item.category : ''}
                    </div>
                </div>
                <span class="${stockClass}" style="font-size: 0.75rem;">
                    <i class="fas fa-${stockIcon} me-1"></i>${item.current_stock}
                </span>
            `;

            el.addEventListener('click', function() {
                hideAutocomplete();
                manualBarcodeInput.value = item.code || item.name;
                if (item.code) {
                    searchProduct(item.code);
                } else {
                    searchProduct(item.name);
                }
            });

            autocompleteDropdown.appendChild(el);
        });

        autocompleteDropdown.style.display = 'block';
    }

    function hideAutocomplete() {
        autocompleteDropdown.style.display = 'none';
        autocompleteDropdown.innerHTML = '';
    }

    // إغلاق القائمة عند النقر خارجها
    document.addEventListener('click', function(e) {
        if (!manualBarcodeInput.contains(e.target) && !autocompleteDropdown.contains(e.target)) {
            hideAutocomplete();
        }
    });

    // التنقل بالأسهم في القائمة
    manualBarcodeInput.addEventListener('keydown', function(e) {
        if (autocompleteDropdown.style.display !== 'block') return;

        const items = autocompleteDropdown.querySelectorAll('.dropdown-item');
        if (!items.length) return;

        let focused = autocompleteDropdown.querySelector('.dropdown-item:focus');
        let idx = Array.from(items).indexOf(focused);

        if (e.key === 'ArrowDown') {
            e.preventDefault();
            idx = idx < items.length - 1 ? idx + 1 : 0;
            items[idx].focus();
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            idx = idx > 0 ? idx - 1 : items.length - 1;
            items[idx].focus();
        } else if (e.key === 'Escape') {
            hideAutocomplete();
            manualBarcodeInput.focus();
        }
    });

    // ============ رفع صورة الباركود ============
    const imageInput = document.getElementById('imageInput');
    imageInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            scanResult.innerHTML = `
                <div class="text-center py-3">
                    <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                    جاري قراءة الصورة...
                </div>`;

            const tempScanner = new Html5Qrcode("reader");
            tempScanner.scanFile(file, true)
                .then(decodedText => {
                    searchProduct(decodedText);
                })
                .catch(err => {
                    scanResult.innerHTML = `
                        <div class="alert alert-danger text-center py-2">
                            <i class="fas fa-exclamation-circle me-1"></i>
                            فشل قراءة الباركود من الصورة. تأكد من وضوح الباركود.
                        </div>`;
                });
        }
    });

    // ============ طلب الأذونات ============
    requestPermissionBtn.addEventListener('click', function() {
        permissionRequest.classList.add('d-none');
        startCamera();
    });

    // ============ الكاميرا ============
    function startCamera() {
        const isSecure = window.location.protocol === 'https:' ||
                        window.location.hostname === 'localhost' ||
                        window.location.hostname === '127.0.0.1';

        if (!isSecure) {
            document.getElementById('httpsWarning').classList.remove('d-none');
            return;
        }
        if (isCameraRunning) return;

        readerElement.classList.remove('d-none');
        startCameraBtn.classList.add('d-none');
        stopCameraBtn.classList.remove('d-none');
        document.getElementById('httpsWarning').classList.add('d-none');
        document.getElementById('cameraError').classList.add('d-none');

        html5QrCode = new Html5Qrcode("reader");

        const config = {
            fps: 30,
            qrbox: { width: 280, height: 280 },
            aspectRatio: 1.0,
            disableFlip: false,
            experimentalFeatures: { useBarCodeDetectorIfSupported: true }
        };

        html5QrCode.start(
            { facingMode: "environment" },
            config,
            (decodedText) => {
                if (!isScanning) {
                    isScanning = true;
                    isCameraRunning = true;
                    stopCamera();
                    searchProduct(decodedText);
                    setTimeout(() => { isScanning = false; }, 1000);
                }
            },
            () => {}
        ).then(() => {
            isCameraRunning = true;
        }).catch((err) => {
            if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                permissionRequest.classList.remove('d-none');
            } else {
                document.getElementById('cameraError').classList.remove('d-none');
            }
            readerElement.classList.add('d-none');
            startCameraBtn.classList.remove('d-none');
            stopCameraBtn.classList.add('d-none');
            isCameraRunning = false;
        });
    }

    function stopCamera() {
        if (html5QrCode && isCameraRunning) {
            html5QrCode.stop().then(() => {
                readerElement.classList.add('d-none');
                startCameraBtn.classList.remove('d-none');
                stopCameraBtn.classList.add('d-none');
                isCameraRunning = false;
            }).catch(() => { isCameraRunning = false; });
        } else {
            readerElement.classList.add('d-none');
            startCameraBtn.classList.remove('d-none');
            stopCameraBtn.classList.add('d-none');
            isCameraRunning = false;
        }
    }

    startCameraBtn.addEventListener('click', () => startCamera());
    stopCameraBtn.addEventListener('click', () => stopCamera());

    // ============ البحث اليدوي ============
    manualScanBtn.addEventListener('click', function() {
        const val = manualBarcodeInput.value.trim();
        if (val) {
            hideAutocomplete();
            searchProduct(val);
        }
    });

    manualBarcodeInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            const val = manualBarcodeInput.value.trim();
            if (val) {
                hideAutocomplete();
                searchProduct(val);
            }
        }
    });

    // ============ البحث عن المنتج ============
    function searchProduct(barcode) {
        barcode = barcode.trim();
        const originalBarcode = barcode;
        barcode = barcode.replace(/^0+/, '') || '0';

        scanResult.innerHTML = `
            <div class="text-center py-3">
                <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                جاري البحث...
            </div>`;

        fetch(`/inventory/api/barcode-scan/?barcode=${encodeURIComponent(barcode)}`)
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    displayProduct(data.product);
                } else {
                    scanResult.innerHTML = `
                        <div class="alert alert-danger text-center py-2 mb-0">
                            <i class="fas fa-exclamation-circle me-1"></i>
                            <strong>${data.error}</strong>
                            ${data.message ? '<br><small>' + data.message + '</small>' : ''}
                        </div>`;
                }
            })
            .catch(() => {
                scanResult.innerHTML = `
                    <div class="alert alert-danger text-center py-2 mb-0">
                        <i class="fas fa-times-circle me-1"></i>حدث خطأ في الاتصال
                    </div>`;
            });
    }

    // ============ عرض بيانات المنتج ============
    function displayProduct(product) {
        let stockBadge = 'bg-success';
        let stockLabel = product.stock_status;
        if (product.current_stock <= 0) {
            stockBadge = 'bg-danger';
        } else if (product.current_stock <= product.minimum_stock) {
            stockBadge = 'bg-warning text-dark';
        }

        let warehousesHtml = '';
        if (product.warehouses && product.warehouses.length > 0) {
            warehousesHtml = `
                <div class="mt-2 pt-2" style="border-top: 1px solid var(--separator, #E8DCCA);">
                    <small class="fw-bold" style="color: var(--text-tertiary, #8B8178);">المخزون حسب المستودع:</small>
                    <div class="mt-1">
                        ${product.warehouses.map(wh => `
                            <span class="warehouse-chip">
                                ${wh.warehouse_name}: <strong>${wh.stock}</strong>
                            </span>
                        `).join('')}
                    </div>
                </div>`;
        }

        scanResult.innerHTML = `
            <div class="product-result-card">
                <div class="product-result-header text-center">
                    <i class="fas fa-box-open me-1"></i>
                    <span class="fw-bold">${product.name}</span>
                </div>
                <div class="product-result-body">
                    <div class="product-info-row">
                        <span class="info-label"><i class="fas fa-barcode me-1"></i>الكود</span>
                        <span class="info-value">${product.code || '—'}</span>
                    </div>
                    <div class="product-info-row">
                        <span class="info-label"><i class="fas fa-tag me-1"></i>السعر</span>
                        <span class="info-value">${product.price} ${product.currency_symbol}</span>
                    </div>
                    <div class="product-info-row">
                        <span class="info-label"><i class="fas fa-layer-group me-1"></i>الفئة</span>
                        <span class="info-value">${product.category}</span>
                    </div>
                    <div class="product-info-row">
                        <span class="info-label"><i class="fas fa-ruler me-1"></i>الوحدة</span>
                        <span class="info-value">${product.unit_display}</span>
                    </div>
                    <div class="text-center mt-2">
                        <span class="badge ${stockBadge} px-3 py-2" style="font-size: 0.85rem;">
                            <i class="fas fa-cubes me-1"></i>المتوفر: ${product.current_stock} — ${stockLabel}
                        </span>
                    </div>
                    ${warehousesHtml}
                    ${product.description ? '<p class="mt-2 mb-0 small" style="color: var(--text-tertiary, #8B8178);">' + product.description + '</p>' : ''}
                </div>
            </div>`;
    }
});
</script>