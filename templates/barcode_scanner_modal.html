{% load static %}

<!-- CSS للنافذة المنبثقة -->
<style>
    .scanner-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.95);
        z-index: 9999;
        justify-content: center;
        align-items: center;
        padding: 10px;
        overflow-y: auto;
    }
    
    .scanner-modal.active {
        display: flex;
    }
    
    .scanner-container {
        background: white;
        border-radius: 15px;
        padding: 20px;
        max-width: 500px;
        width: 100%;
        max-height: 95vh;
        overflow-y: auto;
        position: relative;
        margin: auto;
    }
    
    .scanner-close {
        position: absolute;
        top: 10px;
        right: 10px;
        background: #ff4757;
        border: none;
        width: 45px;
        height: 45px;
        border-radius: 50%;
        color: white;
        font-size: 24px;
        cursor: pointer;
        transition: all 0.3s ease;
        z-index: 10;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
    }
    
    .scanner-close:hover {
        background: #ff3838;
        transform: scale(1.1);
    }
    
    .scanner-close:active {
        transform: scale(0.95);
    }
    
    #reader {
        width: 100%;
        border-radius: 15px;
        margin: 20px 0;
        border: 3px solid #667eea;
        background: #000;
        position: relative;
        overflow: hidden;
    }
    
    #reader video {
        width: 100% !important;
        border-radius: 15px;
        display: block;
    }
    
    #reader__scan_region {
        border: 3px solid #667eea !important;
        border-radius: 10px !important;
    }
    
    #reader__scan_region img {
        opacity: 0.4 !important;
    }
    
    #reader__dashboard {
        background: rgba(102, 126, 234, 0.1) !important;
        padding: 10px !important;
    }
    
    #reader__dashboard_section {
        text-align: center !important;
    }
    
    #reader__camera_selection {
        margin: 10px 0 !important;
    }
    
    .product-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 20px;
        padding: 30px;
        color: white;
        margin-top: 20px;
        animation: slideIn 0.5s ease;
    }
    
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .product-info-item {
        display: flex;
        justify-content: space-between;
        padding: 12px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .product-info-item:last-child {
        border-bottom: none;
    }
    
    .product-info-label {
        font-weight: 600;
        opacity: 0.9;
    }
    
    .product-info-value {
        font-weight: 700;
    }
    
    .warehouse-badge {
        display: inline-block;
        background: rgba(255, 255, 255, 0.2);
        padding: 8px 15px;
        border-radius: 10px;
        margin: 5px;
        font-size: 14px;
    }
    
    .stock-status {
        display: inline-block;
        padding: 8px 20px;
        border-radius: 20px;
        font-weight: bold;
        margin: 10px 0;
    }
    
    .stock-status.available {
        background: #2ecc71;
        color: white;
    }
    
    .stock-status.low {
        background: #f39c12;
        color: white;
    }
    
    .stock-status.out {
        background: #e74c3c;
        color: white;
    }
    
    .scanner-input-group {
        display: flex;
        gap: 10px;
        margin: 20px 0;
    }
    
    .scanner-input {
        flex: 1;
        padding: 15px;
        border: 2px solid #ddd;
        border-radius: 10px;
        font-size: 16px;
    }
    
    .scanner-submit-btn {
        padding: 15px 30px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 10px;
        color: white;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .scanner-submit-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    
    /* تحسينات للموبايل */
    @media (max-width: 768px) {
        .scanner-container {
            padding: 15px;
            border-radius: 10px;
            max-height: 98vh;
        }
        
        .scanner-container h3 {
            font-size: 18px;
            margin-bottom: 15px;
            padding-right: 50px;
        }
        
        .scanner-close {
            width: 40px;
            height: 40px;
            font-size: 20px;
            top: 5px;
            right: 5px;
        }
        
        .product-card {
            padding: 20px;
        }
        
        .product-card h4 {
            font-size: 18px;
        }
        
        .product-info-item {
            padding: 10px 0;
            font-size: 14px;
        }
        
        .warehouse-badge {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        .scanner-input {
            padding: 12px;
            font-size: 14px;
        }
        
        .scanner-submit-btn {
            padding: 12px 20px;
            font-size: 14px;
        }
    }
    
    /* تنبيه HTTPS */
    .https-warning {
        background: #fff3cd;
        border: 2px solid #ffc107;
        border-radius: 10px;
        padding: 15px;
        margin: 15px 0;
        color: #856404;
    }
    
    .https-warning strong {
        color: #d39e00;
    }
    
    .camera-error {
        background: #f8d7da;
        border: 2px solid #f5c6cb;
        border-radius: 10px;
        padding: 15px;
        margin: 15px 0;
        color: #721c24;
    }
    
    /* خيار رفع الصورة */
    .upload-option {
        margin: 20px 0;
        padding: 15px;
        background: #e3f2fd;
        border-radius: 10px;
        text-align: center;
    }
    
    .upload-btn {
        display: inline-block;
        padding: 12px 25px;
        background: #2196F3;
        color: white;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s ease;
    }
    
    .upload-btn:hover {
        background: #1976D2;
        transform: translateY(-2px);
    }
    
    #imageInput {
        display: none;
    }
    
    /* طلب الأذونات */
    .permission-request {
        background: #e8f5e9;
        border: 2px solid #4caf50;
        border-radius: 10px;
        padding: 20px;
        margin: 15px 0;
        text-align: center;
    }
    
    .permission-request-btn {
        background: #4caf50;
        color: white;
        border: none;
        padding: 15px 30px;
        border-radius: 10px;
        font-weight: bold;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
        transition: all 0.3s ease;
    }
    
    .permission-request-btn:hover {
        background: #45a049;
        transform: scale(1.05);
    }
</style>

<!-- نافذة فحص الباركود -->
<div class="scanner-modal" id="scannerModal">
    <div class="scanner-container">
        <button class="scanner-close" id="closeScannerBtn">
            <i class="fas fa-times"></i>
        </button>
        
        <h3 class="text-center mb-3" style="color: #667eea; font-weight: bold;">
            <i class="fas fa-barcode"></i> فحص باركود المنتج
        </h3>
        
        <!-- طلب الأذونات -->
        <div class="permission-request d-none" id="permissionRequest">
            <i class="fas fa-camera fa-3x mb-3" style="color: #4caf50;"></i>
            <h5 style="color: #2e7d32;">نحتاج إلى إذن الكاميرا</h5>
            <p style="color: #555;">للفحص التلقائي، يرجى السماح بالوصول إلى الكاميرا</p>
            <button class="permission-request-btn" id="requestPermissionBtn">
                <i class="fas fa-check-circle"></i> منح الإذن
            </button>
        </div>
        
        <!-- تنبيه HTTPS -->
        <div class="https-warning d-none" id="httpsWarning">
            <strong>⚠️ تنبيه:</strong> الكاميرا تعمل فقط على:
            <br>• <strong>HTTPS</strong> (الاتصال الآمن)
            <br>• <strong>localhost</strong> (التطوير المحلي)
            <br>استخدم الإدخال اليدوي أو رفع الصورة بدلاً من ذلك.
        </div>
        
        <!-- خطأ الكاميرا -->
        <div class="camera-error d-none" id="cameraError">
            <strong>❌ فشل تشغيل الكاميرا</strong>
            <br>الرجاء استخدام الإدخال اليدوي أو رفع صورة الباركود.
        </div>
        
        <!-- خيار الفحص بالكاميرا -->
        <div class="text-center mb-3">
            <button class="btn btn-primary" id="startCameraBtn">
                <i class="fas fa-camera"></i> تشغيل الكاميرا
            </button>
            <button class="btn btn-danger d-none" id="stopCameraBtn">
                <i class="fas fa-stop"></i> إيقاف الكاميرا
            </button>
        </div>
        
        <!-- عنصر الفيديو للفحص -->
        <div id="reader" class="d-none"></div>
        
        <!-- خيار رفع صورة -->
        <div class="upload-option">
            <p style="margin: 0 0 10px 0; font-weight: bold; color: #1976D2;">
                <i class="fas fa-image"></i> أو ارفع صورة الباركود
            </p>
            <input type="file" id="imageInput" accept="image/*" capture="environment">
            <label for="imageInput" class="upload-btn">
                <i class="fas fa-upload"></i> اختر صورة
            </label>
        </div>
        
        <!-- خيار الإدخال اليدوي -->
        <div class="scanner-input-group">
            <input type="text" 
                   id="manualBarcodeInput" 
                   class="scanner-input" 
                   placeholder="أو أدخل كود المنتج يدوياً..."
                   autocomplete="off">
            <button class="scanner-submit-btn" id="manualScanBtn">
                <i class="fas fa-search"></i> بحث
            </button>
        </div>
        
        <!-- عرض النتيجة -->
        <div id="scanResult"></div>
    </div>
</div>

<!-- JavaScript للنافذة المنبثقة -->
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const openScannerBtn = document.getElementById('openScannerBtn');
    const closeScannerBtn = document.getElementById('closeScannerBtn');
    const scannerModal = document.getElementById('scannerModal');
    const startCameraBtn = document.getElementById('startCameraBtn');
    const stopCameraBtn = document.getElementById('stopCameraBtn');
    const readerElement = document.getElementById('reader');
    const manualBarcodeInput = document.getElementById('manualBarcodeInput');
    const manualScanBtn = document.getElementById('manualScanBtn');
    const scanResult = document.getElementById('scanResult');
    const permissionRequest = document.getElementById('permissionRequest');
    const requestPermissionBtn = document.getElementById('requestPermissionBtn');
    
    let html5QrCode = null;
    let isScanning = false;
    let isCameraRunning = false;
    
    // فتح نافذة الفحص
    if (openScannerBtn) {
        openScannerBtn.addEventListener('click', function() {
            scannerModal.classList.add('active');
            manualBarcodeInput.focus();
        });
    }
    
    // إغلاق نافذة الفحص
    closeScannerBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        closeScanner();
    });
    
    // إغلاق عند الضغط خارج النافذة
    scannerModal.addEventListener('click', function(e) {
        if (e.target === scannerModal) {
            closeScanner();
        }
    });
    
    // دالة مركزية للإغلاق
    function closeScanner() {
        stopCamera();
        scannerModal.classList.remove('active');
        scanResult.innerHTML = '';
        document.getElementById('httpsWarning').classList.add('d-none');
        document.getElementById('cameraError').classList.add('d-none');
        permissionRequest.classList.add('d-none');
        manualBarcodeInput.value = '';
        imageInput.value = '';
    }
    
    // إغلاق بالضغط على ESC
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && scannerModal.classList.contains('active')) {
            closeScanner();
        }
    });
    
    // رفع صورة الباركود
    const imageInput = document.getElementById('imageInput');
    imageInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            scanResult.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin fa-2x"></i><p>جاري قراءة الصورة...</p></div>';
            
            const tempScanner = new Html5Qrcode("reader");
            
            tempScanner.scanFile(file, true)
                .then(decodedText => {
                    console.log('✅ تم قراءة الباركود من الصورة:', decodedText);
                    searchProduct(decodedText);
                })
                .catch(err => {
                    console.error('❌ خطأ في قراءة الصورة:', err);
                    scanResult.innerHTML = `
                        <div class="alert alert-danger text-center">
                            <i class="fas fa-exclamation-circle fa-2x mb-2"></i>
                            <h5>فشل قراءة الباركود من الصورة</h5>
                            <p>تأكد من وضوح الباركود في الصورة</p>
                        </div>
                    `;
                });
        }
    });
    
    // طلب الأذونات
    requestPermissionBtn.addEventListener('click', function() {
        permissionRequest.classList.add('d-none');
        startCamera();
    });
    
    function startCamera() {
        // فحص HTTPS أولاً
        const isSecure = window.location.protocol === 'https:' || 
                        window.location.hostname === 'localhost' || 
                        window.location.hostname === '127.0.0.1';
        
        if (!isSecure) {
            document.getElementById('httpsWarning').classList.remove('d-none');
            return;
        }
        
        if (isCameraRunning) {
            return;
        }
        
        // إظهار عنصر القارئ
        readerElement.classList.remove('d-none');
        startCameraBtn.classList.add('d-none');
        stopCameraBtn.classList.remove('d-none');
        document.getElementById('httpsWarning').classList.add('d-none');
        document.getElementById('cameraError').classList.add('d-none');
        
        // إنشاء قارئ Html5Qrcode
        html5QrCode = new Html5Qrcode("reader");
        
        // إعدادات الفحص - محسنة للفحص السريع
        const config = {
            fps: 30,
            qrbox: { width: 300, height: 300 },
            aspectRatio: 1.0,
            disableFlip: false,
            experimentalFeatures: {
                useBarCodeDetectorIfSupported: true
            }
        };
        
        // بدء الفحص
        html5QrCode.start(
            { facingMode: "environment" },
            config,
            (decodedText, decodedResult) => {
                // الفحص التلقائي - يعمل فوراً عند اكتشاف الباركود
                if (!isScanning) {
                    isScanning = true;
                    isCameraRunning = true;
                    
                    console.log('✅ تم اكتشاف الباركود:', decodedText);
                    
                    // إيقاف الكاميرا للعرض النظيف
                    stopCamera();
                    
                    // البحث عن المنتج
                    searchProduct(decodedText);
                    
                    setTimeout(() => { 
                        isScanning = false;
                    }, 1000);
                }
            },
            (errorMessage) => {
                // لا نفعل شيء للأخطاء العادية أثناء الفحص
            }
        ).then(() => {
            isCameraRunning = true;
            console.log('✅ تم تشغيل الكاميرا بنجاح');
        }).catch((err) => {
            console.error('❌ خطأ في تشغيل الكاميرا:', err);
            
            // التحقق إذا كان الخطأ بسبب الأذونات
            if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                permissionRequest.classList.remove('d-none');
            } else {
                document.getElementById('cameraError').classList.remove('d-none');
            }
            
            readerElement.classList.add('d-none');
            startCameraBtn.classList.remove('d-none');
            stopCameraBtn.classList.add('d-none');
            isCameraRunning = false;
        });
    }
    
    function stopCamera() {
        if (html5QrCode && isCameraRunning) {
            html5QrCode.stop().then(() => {
                console.log('✅ تم إيقاف الكاميرا');
                readerElement.classList.add('d-none');
                startCameraBtn.classList.remove('d-none');
                stopCameraBtn.classList.add('d-none');
                isCameraRunning = false;
            }).catch((err) => {
                console.error('❌ خطأ في إيقاف الكاميرا:', err);
                isCameraRunning = false;
            });
        } else {
            readerElement.classList.add('d-none');
            startCameraBtn.classList.remove('d-none');
            stopCameraBtn.classList.add('d-none');
            isCameraRunning = false;
        }
    }
    
    // تشغيل الكاميرا
    startCameraBtn.addEventListener('click', function() {
        startCamera();
    });
    
    // إيقاف الكاميرا
    stopCameraBtn.addEventListener('click', function() {
        stopCamera();
    });
    
    // البحث اليدوي
    manualScanBtn.addEventListener('click', function() {
        const barcode = manualBarcodeInput.value.trim();
        if (barcode) {
            searchProduct(barcode);
        }
    });
    
    // البحث عند الضغط على Enter
    manualBarcodeInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            const barcode = manualBarcodeInput.value.trim();
            if (barcode) {
                searchProduct(barcode);
            }
        }
    });
    
    function searchProduct(barcode) {
        // تنظيف الباركود: إزالة المسافات والأحرف غير الضرورية
        barcode = barcode.trim();
        
        // إزالة الأصفار من البداية إذا كانت موجودة
        const originalBarcode = barcode;
        barcode = barcode.replace(/^0+/, '') || '0';
        
        // عرض رسالة في console للمطور
        if (originalBarcode !== barcode) {
            console.log(`🔄 تم تحويل الباركود: ${originalBarcode} → ${barcode}`);
        }
        
        scanResult.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin fa-2x"></i><p>جاري البحث...</p></div>';
        
        fetch(`/inventory/api/barcode-scan/?barcode=${encodeURIComponent(barcode)}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayProduct(data.product);
                } else {
                    scanResult.innerHTML = `
                        <div class="alert alert-danger text-center">
                            <i class="fas fa-exclamation-circle fa-2x mb-2"></i>
                            <h5>${data.error}</h5>
                            <p>${data.message || ''}</p>
                            ${originalBarcode !== barcode ? `<p class="small text-muted">تم البحث بالكود: ${barcode}</p>` : ''}
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('خطأ:', error);
                scanResult.innerHTML = `
                    <div class="alert alert-danger text-center">
                        <i class="fas fa-times-circle fa-2x mb-2"></i>
                        <h5>حدث خطأ في الاتصال</h5>
                    </div>
                `;
            });
    }
    
    function displayProduct(product) {
        let stockStatusClass = 'available';
        if (product.current_stock <= 0) {
            stockStatusClass = 'out';
        } else if (product.current_stock <= product.minimum_stock) {
            stockStatusClass = 'low';
        }
        
        let warehousesHtml = '';
        if (product.warehouses && product.warehouses.length > 0) {
            warehousesHtml = '<div class="mt-3"><strong>المخزون حسب المستودع:</strong><br>';
            product.warehouses.forEach(wh => {
                warehousesHtml += `<span class="warehouse-badge">${wh.warehouse_name}: ${wh.stock}</span>`;
            });
            warehousesHtml += '</div>';
        }
        
        scanResult.innerHTML = `
            <div class="product-card">
                <h4 class="text-center mb-4">
                    <i class="fas fa-box-open"></i> ${product.name}
                </h4>
                
                <div class="product-info-item">
                    <span class="product-info-label">الكود:</span>
                    <span class="product-info-value">${product.code || 'غير محدد'}</span>
                </div>
                
                <div class="product-info-item">
                    <span class="product-info-label">السعر:</span>
                    <span class="product-info-value">${product.price} ${product.currency_symbol}</span>
                </div>
                
                <div class="product-info-item">
                    <span class="product-info-label">الفئة:</span>
                    <span class="product-info-value">${product.category}</span>
                </div>
                
                <div class="product-info-item">
                    <span class="product-info-label">الوحدة:</span>
                    <span class="product-info-value">${product.unit_display}</span>
                </div>
                
                <div class="product-info-item">
                    <span class="product-info-label">الكمية المتوفرة:</span>
                    <span class="product-info-value">${product.current_stock}</span>
                </div>
                
                <div class="text-center mt-3">
                    <span class="stock-status ${stockStatusClass}">${product.stock_status}</span>
                </div>
                
                ${warehousesHtml}
                
                ${product.description ? `<div class="mt-3"><strong>الوصف:</strong><br>${product.description}</div>` : ''}
                
                <div class="text-center mt-3">
                    <button class="btn btn-light btn-sm" onclick="document.getElementById('closeScannerBtn').click()">
                        <i class="fas fa-check-circle"></i> تم
                    </button>
                </div>
            </div>
        `;
    }
});
</script>
