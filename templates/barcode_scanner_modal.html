{% load static %}

<!-- CSS Ù„Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© -->
<style>
    .scanner-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.95);
        z-index: 9999;
        justify-content: center;
        align-items: center;
        padding: 10px;
        overflow-y: auto;
    }
    
    .scanner-modal.active {
        display: flex;
    }
    
    .scanner-container {
        background: white;
        border-radius: 15px;
        padding: 20px;
        max-width: 500px;
        width: 100%;
        max-height: 95vh;
        overflow-y: auto;
        position: relative;
        margin: auto;
    }
    
    .scanner-close {
        position: absolute;
        top: 10px;
        right: 10px;
        background: #ff4757;
        border: none;
        width: 45px;
        height: 45px;
        border-radius: 50%;
        color: white;
        font-size: 24px;
        cursor: pointer;
        transition: all 0.3s ease;
        z-index: 10;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
    }
    
    .scanner-close:hover {
        background: #ff3838;
        transform: scale(1.1);
    }
    
    .scanner-close:active {
        transform: scale(0.95);
    }
    
    #reader {
        width: 100%;
        border-radius: 15px;
        margin: 20px 0;
        border: 3px solid #667eea;
        background: #000;
        position: relative;
        overflow: hidden;
    }
    
    #reader video {
        width: 100% !important;
        border-radius: 15px;
        display: block;
    }
    
    #reader__scan_region {
        border: 3px solid #667eea !important;
        border-radius: 10px !important;
    }
    
    #reader__scan_region img {
        opacity: 0.4 !important;
    }
    
    #reader__dashboard {
        background: rgba(102, 126, 234, 0.1) !important;
        padding: 10px !important;
    }
    
    #reader__dashboard_section {
        text-align: center !important;
    }
    
    #reader__camera_selection {
        margin: 10px 0 !important;
    }
    
    .product-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 20px;
        padding: 30px;
        color: white;
        margin-top: 20px;
        animation: slideIn 0.5s ease;
    }
    
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .product-info-item {
        display: flex;
        justify-content: space-between;
        padding: 12px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .product-info-item:last-child {
        border-bottom: none;
    }
    
    .product-info-label {
        font-weight: 600;
        opacity: 0.9;
    }
    
    .product-info-value {
        font-weight: 700;
    }
    
    .warehouse-badge {
        display: inline-block;
        background: rgba(255, 255, 255, 0.2);
        padding: 8px 15px;
        border-radius: 10px;
        margin: 5px;
        font-size: 14px;
    }
    
    .stock-status {
        display: inline-block;
        padding: 8px 20px;
        border-radius: 20px;
        font-weight: bold;
        margin: 10px 0;
    }
    
    .stock-status.available {
        background: #2ecc71;
        color: white;
    }
    
    .stock-status.low {
        background: #f39c12;
        color: white;
    }
    
    .stock-status.out {
        background: #e74c3c;
        color: white;
    }
    
    .scanner-input-group {
        display: flex;
        gap: 10px;
        margin: 20px 0;
    }
    
    .scanner-input {
        flex: 1;
        padding: 15px;
        border: 2px solid #ddd;
        border-radius: 10px;
        font-size: 16px;
    }
    
    .scanner-submit-btn {
        padding: 15px 30px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 10px;
        color: white;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .scanner-submit-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    
    /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
    @media (max-width: 768px) {
        .scanner-container {
            padding: 15px;
            border-radius: 10px;
            max-height: 98vh;
        }
        
        .scanner-container h3 {
            font-size: 18px;
            margin-bottom: 15px;
            padding-right: 50px;
        }
        
        .scanner-close {
            width: 40px;
            height: 40px;
            font-size: 20px;
            top: 5px;
            right: 5px;
        }
        
        .product-card {
            padding: 20px;
        }
        
        .product-card h4 {
            font-size: 18px;
        }
        
        .product-info-item {
            padding: 10px 0;
            font-size: 14px;
        }
        
        .warehouse-badge {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        .scanner-input {
            padding: 12px;
            font-size: 14px;
        }
        
        .scanner-submit-btn {
            padding: 12px 20px;
            font-size: 14px;
        }
    }
    
    /* ØªÙ†Ø¨ÙŠÙ‡ HTTPS */
    .https-warning {
        background: #fff3cd;
        border: 2px solid #ffc107;
        border-radius: 10px;
        padding: 15px;
        margin: 15px 0;
        color: #856404;
    }
    
    .https-warning strong {
        color: #d39e00;
    }
    
    .camera-error {
        background: #f8d7da;
        border: 2px solid #f5c6cb;
        border-radius: 10px;
        padding: 15px;
        margin: 15px 0;
        color: #721c24;
    }
    
    /* Ø®ÙŠØ§Ø± Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© */
    .upload-option {
        margin: 20px 0;
        padding: 15px;
        background: #e3f2fd;
        border-radius: 10px;
        text-align: center;
    }
    
    .upload-btn {
        display: inline-block;
        padding: 12px 25px;
        background: #2196F3;
        color: white;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s ease;
    }
    
    .upload-btn:hover {
        background: #1976D2;
        transform: translateY(-2px);
    }
    
    #imageInput {
        display: none;
    }
    
    /* Ø·Ù„Ø¨ Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª */
    .permission-request {
        background: #e8f5e9;
        border: 2px solid #4caf50;
        border-radius: 10px;
        padding: 20px;
        margin: 15px 0;
        text-align: center;
    }
    
    .permission-request-btn {
        background: #4caf50;
        color: white;
        border: none;
        padding: 15px 30px;
        border-radius: 10px;
        font-weight: bold;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
        transition: all 0.3s ease;
    }
    
    .permission-request-btn:hover {
        background: #45a049;
        transform: scale(1.05);
    }
</style>

<!-- Ù†Ø§ÙØ°Ø© ÙØ­Øµ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ -->
<div class="scanner-modal" id="scannerModal">
    <div class="scanner-container">
        <button class="scanner-close" id="closeScannerBtn">
            <i class="fas fa-times"></i>
        </button>
        
        <h3 class="text-center mb-3" style="color: #667eea; font-weight: bold;">
            <i class="fas fa-barcode"></i> ÙØ­Øµ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†ØªØ¬
        </h3>
        
        <!-- Ø·Ù„Ø¨ Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª -->
        <div class="permission-request d-none" id="permissionRequest">
            <i class="fas fa-camera fa-3x mb-3" style="color: #4caf50;"></i>
            <h5 style="color: #2e7d32;">Ù†Ø­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø¥Ø°Ù† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</h5>
            <p style="color: #555;">Ù„Ù„ÙØ­Øµ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</p>
            <button class="permission-request-btn" id="requestPermissionBtn">
                <i class="fas fa-check-circle"></i> Ù…Ù†Ø­ Ø§Ù„Ø¥Ø°Ù†
            </button>
        </div>
        
        <!-- ØªÙ†Ø¨ÙŠÙ‡ HTTPS -->
        <div class="https-warning d-none" id="httpsWarning">
            <strong>âš ï¸ ØªÙ†Ø¨ÙŠÙ‡:</strong> Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØªØ¹Ù…Ù„ ÙÙ‚Ø· Ø¹Ù„Ù‰:
            <br>â€¢ <strong>HTTPS</strong> (Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ø¢Ù…Ù†)
            <br>â€¢ <strong>localhost</strong> (Ø§Ù„ØªØ·ÙˆÙŠØ± Ø§Ù„Ù…Ø­Ù„ÙŠ)
            <br>Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙŠØ¯ÙˆÙŠ Ø£Ùˆ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø°Ù„Ùƒ.
        </div>
        
        <!-- Ø®Ø·Ø£ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ -->
        <div class="camera-error d-none" id="cameraError">
            <strong>âŒ ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</strong>
            <br>Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙŠØ¯ÙˆÙŠ Ø£Ùˆ Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯.
        </div>
        
        <!-- Ø®ÙŠØ§Ø± Ø§Ù„ÙØ­Øµ Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ -->
        <div class="text-center mb-3">
            <button class="btn btn-primary" id="startCameraBtn">
                <i class="fas fa-camera"></i> ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
            </button>
            <button class="btn btn-danger d-none" id="stopCameraBtn">
                <i class="fas fa-stop"></i> Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
            </button>
        </div>
        
        <!-- Ø¹Ù†ØµØ± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù„Ù„ÙØ­Øµ -->
        <div id="reader" class="d-none"></div>
        
        <!-- Ø®ÙŠØ§Ø± Ø±ÙØ¹ ØµÙˆØ±Ø© -->
        <div class="upload-option">
            <p style="margin: 0 0 10px 0; font-weight: bold; color: #1976D2;">
                <i class="fas fa-image"></i> Ø£Ùˆ Ø§Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
            </p>
            <input type="file" id="imageInput" accept="image/*" capture="environment">
            <label for="imageInput" class="upload-btn">
                <i class="fas fa-upload"></i> Ø§Ø®ØªØ± ØµÙˆØ±Ø©
            </label>
        </div>
        
        <!-- Ø®ÙŠØ§Ø± Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙŠØ¯ÙˆÙŠ -->
        <div class="scanner-input-group">
            <input type="text" 
                   id="manualBarcodeInput" 
                   class="scanner-input" 
                   placeholder="Ø£Ùˆ Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†ØªØ¬ ÙŠØ¯ÙˆÙŠØ§Ù‹..."
                   autocomplete="off">
            <button class="scanner-submit-btn" id="manualScanBtn">
                <i class="fas fa-search"></i> Ø¨Ø­Ø«
            </button>
        </div>
        
        <!-- Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø© -->
        <div id="scanResult"></div>
    </div>
</div>

<!-- JavaScript Ù„Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© -->
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const openScannerBtn = document.getElementById('openScannerBtn');
    const closeScannerBtn = document.getElementById('closeScannerBtn');
    const scannerModal = document.getElementById('scannerModal');
    const startCameraBtn = document.getElementById('startCameraBtn');
    const stopCameraBtn = document.getElementById('stopCameraBtn');
    const readerElement = document.getElementById('reader');
    const manualBarcodeInput = document.getElementById('manualBarcodeInput');
    const manualScanBtn = document.getElementById('manualScanBtn');
    const scanResult = document.getElementById('scanResult');
    const permissionRequest = document.getElementById('permissionRequest');
    const requestPermissionBtn = document.getElementById('requestPermissionBtn');
    
    let html5QrCode = null;
    let isScanning = false;
    let isCameraRunning = false;
    
    // ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„ÙØ­Øµ
    if (openScannerBtn) {
        openScannerBtn.addEventListener('click', function() {
            scannerModal.classList.add('active');
            manualBarcodeInput.focus();
        });
    }
    
    // Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„ÙØ­Øµ
    closeScannerBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        closeScanner();
    });
    
    // Ø¥ØºÙ„Ø§Ù‚ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Ø§ÙØ°Ø©
    scannerModal.addEventListener('click', function(e) {
        if (e.target === scannerModal) {
            closeScanner();
        }
    });
    
    // Ø¯Ø§Ù„Ø© Ù…Ø±ÙƒØ²ÙŠØ© Ù„Ù„Ø¥ØºÙ„Ø§Ù‚
    function closeScanner() {
        stopCamera();
        scannerModal.classList.remove('active');
        scanResult.innerHTML = '';
        document.getElementById('httpsWarning').classList.add('d-none');
        document.getElementById('cameraError').classList.add('d-none');
        permissionRequest.classList.add('d-none');
        manualBarcodeInput.value = '';
        imageInput.value = '';
    }
    
    // Ø¥ØºÙ„Ø§Ù‚ Ø¨Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ ESC
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && scannerModal.classList.contains('active')) {
            closeScanner();
        }
    });
    
    // Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
    const imageInput = document.getElementById('imageInput');
    imageInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            scanResult.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin fa-2x"></i><p>Ø¬Ø§Ø±ÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØµÙˆØ±Ø©...</p></div>';
            
            const tempScanner = new Html5Qrcode("reader");
            
            tempScanner.scanFile(file, true)
                .then(decodedText => {
                    console.log('âœ… ØªÙ… Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ù† Ø§Ù„ØµÙˆØ±Ø©:', decodedText);
                    searchProduct(decodedText);
                })
                .catch(err => {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØµÙˆØ±Ø©:', err);
                    scanResult.innerHTML = `
                        <div class="alert alert-danger text-center">
                            <i class="fas fa-exclamation-circle fa-2x mb-2"></i>
                            <h5>ÙØ´Ù„ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ù† Ø§Ù„ØµÙˆØ±Ø©</h5>
                            <p>ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¶ÙˆØ­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙÙŠ Ø§Ù„ØµÙˆØ±Ø©</p>
                        </div>
                    `;
                });
        }
    });
    
    // Ø·Ù„Ø¨ Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª
    requestPermissionBtn.addEventListener('click', function() {
        permissionRequest.classList.add('d-none');
        startCamera();
    });
    
    function startCamera() {
        // ÙØ­Øµ HTTPS Ø£ÙˆÙ„Ø§Ù‹
        const isSecure = window.location.protocol === 'https:' || 
                        window.location.hostname === 'localhost' || 
                        window.location.hostname === '127.0.0.1';
        
        if (!isSecure) {
            document.getElementById('httpsWarning').classList.remove('d-none');
            return;
        }
        
        if (isCameraRunning) {
            return;
        }
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ø¹Ù†ØµØ± Ø§Ù„Ù‚Ø§Ø±Ø¦
        readerElement.classList.remove('d-none');
        startCameraBtn.classList.add('d-none');
        stopCameraBtn.classList.remove('d-none');
        document.getElementById('httpsWarning').classList.add('d-none');
        document.getElementById('cameraError').classList.add('d-none');
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø±Ø¦ Html5Qrcode
        html5QrCode = new Html5Qrcode("reader");
        
        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙØ­Øµ - Ù…Ø­Ø³Ù†Ø© Ù„Ù„ÙØ­Øµ Ø§Ù„Ø³Ø±ÙŠØ¹
        const config = {
            fps: 30,
            qrbox: { width: 300, height: 300 },
            aspectRatio: 1.0,
            disableFlip: false,
            experimentalFeatures: {
                useBarCodeDetectorIfSupported: true
            }
        };
        
        // Ø¨Ø¯Ø¡ Ø§Ù„ÙØ­Øµ
        html5QrCode.start(
            { facingMode: "environment" },
            config,
            (decodedText, decodedResult) => {
                // Ø§Ù„ÙØ­Øµ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ - ÙŠØ¹Ù…Ù„ ÙÙˆØ±Ø§Ù‹ Ø¹Ù†Ø¯ Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
                if (!isScanning) {
                    isScanning = true;
                    isCameraRunning = true;
                    
                    console.log('âœ… ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯:', decodedText);
                    
                    // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù„Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù†Ø¸ÙŠÙ
                    stopCamera();
                    
                    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù†ØªØ¬
                    searchProduct(decodedText);
                    
                    setTimeout(() => { 
                        isScanning = false;
                    }, 1000);
                }
            },
            (errorMessage) => {
                // Ù„Ø§ Ù†ÙØ¹Ù„ Ø´ÙŠØ¡ Ù„Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ÙØ­Øµ
            }
        ).then(() => {
            isCameraRunning = true;
            console.log('âœ… ØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø¨Ù†Ø¬Ø§Ø­');
        }).catch((err) => {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§:', err);
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø®Ø·Ø£ Ø¨Ø³Ø¨Ø¨ Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª
            if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                permissionRequest.classList.remove('d-none');
            } else {
                document.getElementById('cameraError').classList.remove('d-none');
            }
            
            readerElement.classList.add('d-none');
            startCameraBtn.classList.remove('d-none');
            stopCameraBtn.classList.add('d-none');
            isCameraRunning = false;
        });
    }
    
    function stopCamera() {
        if (html5QrCode && isCameraRunning) {
            html5QrCode.stop().then(() => {
                console.log('âœ… ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§');
                readerElement.classList.add('d-none');
                startCameraBtn.classList.remove('d-none');
                stopCameraBtn.classList.add('d-none');
                isCameraRunning = false;
            }).catch((err) => {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§:', err);
                isCameraRunning = false;
            });
        } else {
            readerElement.classList.add('d-none');
            startCameraBtn.classList.remove('d-none');
            stopCameraBtn.classList.add('d-none');
            isCameraRunning = false;
        }
    }
    
    // ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
    startCameraBtn.addEventListener('click', function() {
        startCamera();
    });
    
    // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
    stopCameraBtn.addEventListener('click', function() {
        stopCamera();
    });
    
    // Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ÙŠØ¯ÙˆÙŠ
    manualScanBtn.addEventListener('click', function() {
        const barcode = manualBarcodeInput.value.trim();
        if (barcode) {
            searchProduct(barcode);
        }
    });
    
    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Enter
    manualBarcodeInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            const barcode = manualBarcodeInput.value.trim();
            if (barcode) {
                searchProduct(barcode);
            }
        }
    });
    
    function searchProduct(barcode) {
        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯: Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§ÙØ§Øª ÙˆØ§Ù„Ø£Ø­Ø±Ù ØºÙŠØ± Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ©
        barcode = barcode.trim();
        
        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø£ØµÙØ§Ø± Ù…Ù† Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
        const originalBarcode = barcode;
        barcode = barcode.replace(/^0+/, '') || '0';
        
        // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© ÙÙŠ console Ù„Ù„Ù…Ø·ÙˆØ±
        if (originalBarcode !== barcode) {
            console.log(`ğŸ”„ ØªÙ… ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯: ${originalBarcode} â†’ ${barcode}`);
        }
        
        scanResult.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin fa-2x"></i><p>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...</p></div>';
        
        fetch(`/inventory/api/barcode-scan/?barcode=${encodeURIComponent(barcode)}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayProduct(data.product);
                } else {
                    scanResult.innerHTML = `
                        <div class="alert alert-danger text-center">
                            <i class="fas fa-exclamation-circle fa-2x mb-2"></i>
                            <h5>${data.error}</h5>
                            <p>${data.message || ''}</p>
                            ${originalBarcode !== barcode ? `<p class="small text-muted">ØªÙ… Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„ÙƒÙˆØ¯: ${barcode}</p>` : ''}
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Ø®Ø·Ø£:', error);
                scanResult.innerHTML = `
                    <div class="alert alert-danger text-center">
                        <i class="fas fa-times-circle fa-2x mb-2"></i>
                        <h5>Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„</h5>
                    </div>
                `;
            });
    }
    
    function displayProduct(product) {
        let stockStatusClass = 'available';
        if (product.current_stock <= 0) {
            stockStatusClass = 'out';
        } else if (product.current_stock <= product.minimum_stock) {
            stockStatusClass = 'low';
        }
        
        let warehousesHtml = '';
        if (product.warehouses && product.warehouses.length > 0) {
            warehousesHtml = '<div class="mt-3"><strong>Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹:</strong><br>';
            product.warehouses.forEach(wh => {
                warehousesHtml += `<span class="warehouse-badge">${wh.warehouse_name}: ${wh.stock}</span>`;
            });
            warehousesHtml += '</div>';
        }
        
        scanResult.innerHTML = `
            <div class="product-card">
                <h4 class="text-center mb-4">
                    <i class="fas fa-box-open"></i> ${product.name}
                </h4>
                
                <div class="product-info-item">
                    <span class="product-info-label">Ø§Ù„ÙƒÙˆØ¯:</span>
                    <span class="product-info-value">${product.code || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>
                </div>
                
                <div class="product-info-item">
                    <span class="product-info-label">Ø§Ù„Ø³Ø¹Ø±:</span>
                    <span class="product-info-value">${product.price} ${product.currency_symbol}</span>
                </div>
                
                <div class="product-info-item">
                    <span class="product-info-label">Ø§Ù„ÙØ¦Ø©:</span>
                    <span class="product-info-value">${product.category}</span>
                </div>
                
                <div class="product-info-item">
                    <span class="product-info-label">Ø§Ù„ÙˆØ­Ø¯Ø©:</span>
                    <span class="product-info-value">${product.unit_display}</span>
                </div>
                
                <div class="product-info-item">
                    <span class="product-info-label">Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªÙˆÙØ±Ø©:</span>
                    <span class="product-info-value">${product.current_stock}</span>
                </div>
                
                <div class="text-center mt-3">
                    <span class="stock-status ${stockStatusClass}">${product.stock_status}</span>
                </div>
                
                ${warehousesHtml}
                
                ${product.description ? `<div class="mt-3"><strong>Ø§Ù„ÙˆØµÙ:</strong><br>${product.description}</div>` : ''}
                
                <div class="text-center mt-3">
                    <button class="btn btn-light btn-sm" onclick="document.getElementById('closeScannerBtn').click()">
                        <i class="fas fa-check-circle"></i> ØªÙ…
                    </button>
                </div>
            </div>
        `;
    }
});
</script>
