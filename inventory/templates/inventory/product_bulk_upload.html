{% extends 'inventory/inventory_base_custom.html' %}
{% load static %}
{% block inventory_title %}رفع المنتجات بالجملة{% endblock %}
{% block breadcrumb_items %}
    <li class="breadcrumb-item">
        <a href="{% url 'inventory:dashboard' %}">لوحة التحكم</a>
    </li>
    <li class="breadcrumb-item">
        <a href="{% url 'inventory:product_list' %}">المنتجات</a>
    </li>
    <li class="breadcrumb-item active" aria-current="page">رفع المنتجات بالجملة</li>
{% endblock %}
{% block quick_actions %}
    <a href="{% url 'inventory:download_excel_template' %}"
       class="btn btn-info btn-sm">
        <i class="fas fa-download"></i> تحميل القالب
    </a>
    <a href="{% url 'inventory:bulk_upload_log_list' %}"
       class="btn btn-warning btn-sm">
        <i class="fas fa-history"></i> سجل العمليات
    </a>
    <a href="{% url 'inventory:product_list' %}"
       class="btn btn-secondary btn-sm">
        <i class="fas fa-arrow-left"></i> العودة للقائمة
    </a>
{% endblock %}
{% block inventory_content %}
    <!-- آخر عملية رفع -->
    {% if last_upload %}
        <div class="row mb-3">
            <div class="col-12">
                <div class="alert {% if last_upload.status == 'completed' %}alert-success{% elif last_upload.status == 'completed_with_errors' %}alert-warning{% elif last_upload.status == 'failed' %}alert-danger{% else %}alert-info{% endif %}">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">
                                <i class="fas fa-clock"></i> آخر عملية رفع: {{ last_upload.file_name }}
                            </h6>
                            <small>
                                {{ last_upload.created_at|date:"Y-m-d H:i" }} -
                                {{ last_upload.get_status_display }} -
                                معالجة {{ last_upload.processed_count }} من {{ last_upload.total_rows }} صف
                                {% if last_upload.error_count > 0 %}
                                    - <strong class="text-danger">{{ last_upload.error_count }} خطأ</strong>
                                {% endif %}
                            </small>
                        </div>
                        <a href="{% url 'inventory:bulk_upload_report' last_upload.id %}"
                           class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-file-alt"></i> عرض التقرير
                        </a>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-upload"></i>
                        رفع المنتجات من ملف إكسل
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data" id="uploadForm">
                        {% csrf_token %}
                        <div class="mb-4">
                            <label for="{{ form.excel_file.id_for_label }}" class="form-label">
                                {{ form.excel_file.label }}
                                <span class="text-danger">*</span>
                            </label>
                            {{ form.excel_file }}
                            {% if form.excel_file.help_text %}<div class="form-text">{{ form.excel_file.help_text }}</div>{% endif %}
                            {% if form.excel_file.errors %}
                                <div class="text-danger">
                                    {% for error in form.excel_file.errors %}
                                        <small>{{ error }}</small>
                                        <br>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        <div class="mb-4">
                            <label for="{{ form.warehouse.id_for_label }}" class="form-label">
                                {{ form.warehouse.label }}
                                <span class="text-muted">(اختياري)</span>
                            </label>
                            {{ form.warehouse }}
                            {% if form.warehouse.help_text %}<div class="form-text">{{ form.warehouse.help_text }}</div>{% endif %}
                            {% if form.warehouse.errors %}
                                <div class="text-danger">
                                    {% for error in form.warehouse.errors %}
                                        <small>{{ error }}</small>
                                        <br>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        <div class="mb-4">
                            <label class="form-label fw-bold">{{ form.upload_mode.label }}</label>
                            {% if form.upload_mode.help_text %}<div class="form-text mb-2">{{ form.upload_mode.help_text }}</div>{% endif %}
                            {% for radio in form.upload_mode %}
                                <div class="form-check mb-2">
                                    {{ radio.tag }}
                                    <label class="form-check-label" for="{{ radio.id_for_label }}">{{ radio.choice_label }}</label>
                                </div>
                            {% endfor %}
                            {% if form.upload_mode.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.upload_mode.errors %}
                                        <small>{{ error }}</small>
                                        <br>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        <!-- خيار حذف المستودعات الفارغة -->
                        <div class="mb-4">
                            <div class="card border-warning">
                                <div class="card-body">
                                    <div class="form-check form-switch">
                                        {{ form.auto_delete_empty_warehouses }}
                                        <label class="form-check-label"
                                               for="{{ form.auto_delete_empty_warehouses.id_for_label }}">
                                            <strong>{{ form.auto_delete_empty_warehouses.label }}</strong>
                                        </label>
                                    </div>
                                    {% if form.auto_delete_empty_warehouses.help_text %}
                                        <small class="form-text text-muted d-block mt-2">
                                            <i class="fas fa-info-circle"></i> {{ form.auto_delete_empty_warehouses.help_text }}
                                        </small>
                                    {% endif %}
                                    {% if form.auto_delete_empty_warehouses.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.auto_delete_empty_warehouses.errors %}
                                                <small>{{ error }}</small>
                                                <br>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <!-- تحذير التهيئة الكاملة -->
                        <div class="alert alert-danger d-none" id="fullResetWarning">
                            <h6 class="alert-heading">
                                <i class="fas fa-exclamation-triangle"></i> تحذير خطر!
                            </h6>
                            <p class="mb-1">
                                <strong>وضع التهيئة الكاملة سيقوم بـ:</strong>
                            </p>
                            <ul class="mb-2">
                                <li>
                                    حذف <strong>جميع</strong> المنتجات الحالية
                                </li>
                                <li>
                                    حذف <strong>جميع</strong> معاملات المخزون
                                </li>
                                <li>
                                    حذف <strong>جميع</strong> التحويلات المخزنية
                                </li>
                                <li>استبدالها بالمنتجات من الملف المرفوع</li>
                            </ul>
                            <p class="mb-0 text-danger">
                                <strong>⚠️ هذا الإجراء لا يمكن التراجع عنه!</strong>
                            </p>
                        </div>
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                                <i class="fas fa-upload"></i>
                                رفع وإضافة المنتجات
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <!-- تعليمات الاستخدام -->
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-info-circle"></i>
                        تعليمات الاستخدام
                    </h6>
                </div>
                <div class="card-body">
                    <ol class="mb-0">
                        <li class="mb-2">قم بتحميل قالب ملف الإكسل</li>
                        <li class="mb-2">املأ البيانات حسب الأعمدة المطلوبة</li>
                        <li class="mb-2">أضف أسماء المستودعات في عمود "المستودع"</li>
                        <li class="mb-2">تأكد من صحة البيانات قبل الرفع</li>
                        <li class="mb-2">اختر المستودع الافتراضي (اختياري)</li>
                        <li>اضغط على "رفع وإضافة المنتجات"</li>
                    </ol>
                </div>
            </div>
            <!-- الأعمدة المطلوبة -->
            <div class="card mt-3">
                <div class="card-header bg-warning text-dark">
                    <h6 class="mb-0">
                        <i class="fas fa-table"></i>
                        الأعمدة المطلوبة
                    </h6>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled mb-0">
                        <li>
                            <strong>اسم المنتج:</strong> <span class="text-danger">مطلوب</span>
                        </li>
                        <li>
                            <strong>الكود:</strong> اختياري
                        </li>
                        <li>
                            <strong>الفئة:</strong> اسم الفئة
                        </li>
                        <li>
                            <strong>السعر:</strong> <span class="text-danger">مطلوب</span>
                        </li>
                        <li>
                            <strong>الكمية:</strong> الكمية الابتدائية
                        </li>
                        <li>
                            <strong>المستودع:</strong> <span class="text-success">جديد!</span> اسم المستودع
                        </li>
                        <li>
                            <strong>الوصف:</strong> اختياري
                        </li>
                        <li>
                            <strong>الحد الأدنى:</strong> للتنبيهات
                        </li>
                        <li>
                            <strong>العملة:</strong> EGP, USD, EUR
                        </li>
                    </ul>
                </div>
            </div>
            <!-- ميزة جديدة -->
            <div class="card mt-3">
                <div class="card-header bg-primary text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-star"></i>
                        ميزة جديدة: إنشاء المستودعات تلقائياً
                    </h6>
                </div>
                <div class="card-body">
                    <p class="mb-2">
                        <i class="fas fa-magic text-success"></i>
                        يمكن الآن إضافة عمود "المستودع" في ملف الإكسل
                    </p>
                    <p class="mb-2">
                        <i class="fas fa-warehouse text-info"></i>
                        سيتم إنشاء المستودعات تلقائياً إذا لم تكن موجودة
                    </p>
                    <p class="mb-0">
                        <i class="fas fa-chart-line text-warning"></i>
                        يمكن تتبع المخزون لكل مستودع منفصل
                    </p>
                </div>
            </div>
            <!-- نصائح -->
            <div class="card mt-3">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-lightbulb"></i>
                        نصائح مهمة
                    </h6>
                </div>
                <div class="card-body">
                    <ul class="mb-0">
                        <li class="mb-1">تأكد من عدم تكرار الأكواد</li>
                        <li class="mb-1">استخدم أرقام صحيحة للكميات والأسعار</li>
                        <li class="mb-1">الحد الأقصى لحجم الملف 10 ميجابايت</li>
                        <li>يمكن إنشاء فئات جديدة تلقائياً</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <!-- إضافة ملف آخر للتحديث المجمع -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-edit"></i>
                        تحديث سريع للمخزون
                    </h5>
                </div>
                <div class="card-body">
                    <p class="mb-3">
                        إذا كنت تريد فقط تحديث كميات المنتجات الموجودة دون إضافة منتجات جديدة،
                        يمكنك استخدام الرابط التالي:
                    </p>
                    <a href="{% url 'inventory:bulk_stock_update' %}"
                       class="btn btn-outline-secondary">
                        <i class="fas fa-sync-alt"></i>
                        تحديث المخزون بالجملة
                    </a>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
{% block extra_js %}
    {{ block.super }}
    <!-- Modal للتقدم اللحظي -->
    <div class="modal fade"
         id="uploadProgressModal"
         tabindex="-1"
         data-bs-backdrop="static"
         data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-upload"></i> جاري رفع المنتجات...
                    </h5>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-3">
                        <div class="spinner-border text-primary mb-2"
                             role="status"
                             id="uploadSpinner"></div>
                        <h4 id="progressPercent">0%</h4>
                    </div>
                    <div class="progress mb-3" style="height: 30px;">
                        <div id="progressBar"
                             class="progress-bar progress-bar-striped progress-bar-animated bg-success"
                             style="width: 0%"></div>
                    </div>
                    <div class="row text-center">
                        <div class="col-4">
                            <h5 class="text-success mb-0" id="createdCount">0</h5>
                            <small class="text-muted">جديد</small>
                        </div>
                        <div class="col-4">
                            <h5 class="text-info mb-0" id="updatedCount">0</h5>
                            <small class="text-muted">محدّث</small>
                        </div>
                        <div class="col-4">
                            <h5 class="text-warning mb-0" id="skippedCount">0</h5>
                            <small class="text-muted">متخطى</small>
                        </div>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between small text-muted">
                        <span>⚡ السرعة: <strong id="uploadSpeed">-</strong> صف/ث</span>
                        <span>⏱️ المتبقي: <strong id="etaTime">-</strong></span>
                    </div>
                    <div class="text-center mt-2 small">
                        <span id="processedText">0</span> من <span id="totalText">0</span> صف
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('uploadForm');
    const submitBtn = document.getElementById('submitBtn');
    const fileInput = document.getElementById('{{ form.excel_file.id_for_label }}');
    const fullResetWarning = document.getElementById('fullResetWarning');
    const uploadModeRadios = document.querySelectorAll('input[name="upload_mode"]');
    
    // مراقبة تغيير وضع الرفع
    uploadModeRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.value === 'full_reset') {
                fullResetWarning.classList.remove('d-none');
                submitBtn.classList.remove('btn-primary');
                submitBtn.classList.add('btn-danger');
                submitBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> تهيئة كاملة (خطر!)';
            } else {
                fullResetWarning.classList.add('d-none');
                submitBtn.classList.remove('btn-danger');
                submitBtn.classList.add('btn-primary');
                submitBtn.innerHTML = '<i class="fas fa-upload"></i> رفع وإضافة المنتجات';
            }
        });
    });
    
    // تغيير النص عند اختيار ملف
    fileInput.addEventListener('change', function() {
        if (this.files && this.files[0]) {
            const fileName = this.files[0].name;
            const fileSize = (this.files[0].size / 1024 / 1024).toFixed(2);
            
            let fileInfo = document.getElementById('fileInfo');
            if (!fileInfo) {
                fileInfo = document.createElement('div');
                fileInfo.id = 'fileInfo';
                fileInfo.className = 'alert alert-info mt-2';
                this.parentNode.appendChild(fileInfo);
            }
            
            fileInfo.innerHTML = '<i class="fas fa-file-excel"></i> <strong>الملف المحدد:</strong> ' + fileName + ' (' + fileSize + ' ميجابايت)';
        }
    });
    
    // تأكيد قبل الإرسال
    form.addEventListener('submit', function(e) {
        if (!fileInput.files || !fileInput.files[0]) {
            e.preventDefault();
            alert('يرجى اختيار ملف إكسل أولاً');
            return;
        }
        
        const selectedMode = document.querySelector('input[name="upload_mode"]:checked');
        
        // تأكيد مزدوج لوضع التهيئة الكاملة
        if (selectedMode && selectedMode.value === 'full_reset') {
            e.preventDefault();
            
            const firstConfirm = confirm('⚠️ تحذير خطر!\n\nسيتم حذف جميع المنتجات والمعاملات الحالية ولا يمكن التراجع عن هذا الإجراء!\n\nهل أنت متأكد من المتابعة؟');
            if (!firstConfirm) return;
            
            const secondConfirm = prompt('للتأكيد، اكتب كلمة "حذف" بالعربي:');
            if (secondConfirm !== 'حذف') {
                alert('تم الإلغاء. لم يتم حذف أي شيء.');
                return;
            }
            
            const finalConfirm = confirm('تأكيد نهائي: هل أنت متأكد 100% من حذف جميع البيانات القديمة؟');
            if (!finalConfirm) return;
            
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> جاري الحذف والرفع...';
            form.submit();
            return;
        }
        
        const confirmed = confirm('هل أنت متأكد من رفع هذا الملف؟');
        if (!confirmed) {
            e.preventDefault();
            return;
        }
        
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> جاري الإرسال...';
    });
});
    </script>
{% endblock %}
