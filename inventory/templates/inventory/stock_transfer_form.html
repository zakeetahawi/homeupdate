{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
<style>
.formset-row { border: 1px solid #dee2e6; border-radius: 5px; padding: 15px; margin-bottom: 15px; background-color: #f8f9fa; position: relative; }
.formset-row.to-delete { opacity: 0.5; background-color: #f8d7da; }
.delete-row-btn { cursor: pointer; position: absolute; top: 10px; left: 10px; }
.stock-info { background-color: #e7f3ff; padding: 8px; border-radius: 4px; margin-top: 5px; font-size: 0.9em; }
.similar-products-box { background-color: #fff3cd; padding: 10px; border-radius: 4px; margin-top: 10px; display: none; }
.select2-container { width: 100% !important; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="card shadow">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="fas fa-exchange-alt"></i> {{ title }}</h5>
        </div>
        <div class="card-body">
            <form method="post" id="transfer-form">
                {% csrf_token %}
                <div class="row mb-4">
                    <div class="col-md-6">
                        <label class="form-label"><i class="fas fa-warehouse text-danger"></i> {{ form.from_warehouse.label }} *</label>
                        {{ form.from_warehouse }}
                        {% if form.from_warehouse.errors %}<div class="text-danger">{{ form.from_warehouse.errors }}</div>{% endif %}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label"><i class="fas fa-warehouse text-success"></i> {{ form.to_warehouse.label }} *</label>
                        {{ form.to_warehouse }}
                        {% if form.to_warehouse.errors %}<div class="text-danger">{{ form.to_warehouse.errors }}</div>{% endif %}
                    </div>
                </div>
                <div class="row mb-4">
                    <div class="col-md-6">
                        <label class="form-label"><i class="fas fa-calendar"></i> {{ form.transfer_date.label }} *</label>
                        {{ form.transfer_date }}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label"><i class="fas fa-calendar-check"></i> {{ form.expected_arrival_date.label }}</label>
                        {{ form.expected_arrival_date }}
                    </div>
                </div>
                <div class="row mb-4">
                    <div class="col-md-6">
                        <label class="form-label"><i class="fas fa-info-circle"></i> {{ form.reason.label }}</label>
                        {{ form.reason }}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label"><i class="fas fa-sticky-note"></i> {{ form.notes.label }}</label>
                        {{ form.notes }}
                    </div>
                </div>
                <hr>
                <div class="mb-4">
                    <div class="d-flex justify-content-between mb-3">
                        <h5><i class="fas fa-boxes"></i> المنتجات</h5>
                        <button type="button" class="btn btn-success btn-sm" id="add-item"><i class="fas fa-plus"></i> إضافة</button>
                    </div>
                    {{ formset.management_form }}
                    <div id="formset-container">
                        {% for form in formset %}
                        <div class="formset-row">
                            <button type="button" class="btn btn-danger btn-sm delete-row-btn"><i class="fas fa-times"></i></button>
                            <div class="row">
                                <div class="col-md-5">
                                    <label>المنتج *</label>
                                    {{ form.product }}
                                    <div class="stock-info" style="display:none;"><span class="stock-text"></span></div>
                                    <div class="similar-products-box"><strong>الأصناف المشابهة:</strong><div class="similar-products-list"></div></div>
                                </div>
                                <div class="col-md-2">
                                    <label>الكمية *</label>
                                    {{ form.quantity }}
                                </div>
                                <div class="col-md-3">
                                    <label>ملاحظات</label>
                                    {{ form.notes }}
                                </div>
                                <div class="col-md-2">
                                    <label>خيارات</label>
                                    <div class="form-check"><input type="checkbox" class="form-check-input transfer-all-checkbox" id="transfer_all_{{ forloop.counter0 }}"><label class="form-check-label" for="transfer_all_{{ forloop.counter0 }}">نقل الكل</label></div>
                                    <div class="form-check"><input type="checkbox" class="form-check-input include-similar-checkbox" id="include_similar_{{ forloop.counter0 }}"><label class="form-check-label" for="include_similar_{{ forloop.counter0 }}">المشابهة</label></div>
                                </div>
                            </div>
                            {{ form.DELETE }}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="d-flex justify-content-between">
                    <a href="{% url 'inventory:stock_transfer_list' %}" class="btn btn-secondary"><i class="fas fa-arrow-right"></i> رجوع</a>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> حفظ</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
$(document).ready(function() {
    function initSelect2() {
        $('#id_from_warehouse, #id_to_warehouse').select2({theme: 'bootstrap-5', placeholder: 'اختر...', dir: 'rtl'});
        $('.product-select').select2({theme: 'bootstrap-5', placeholder: 'اختر المنتج...', dir: 'rtl', width: '100%'});
    }
    initSelect2();
    
    $(document).on('change', '.product-select', function() {
        const $row = $(this).closest('.formset-row');
        const productId = $(this).val();
        const warehouseId = $('#id_from_warehouse').val();
        if (productId && warehouseId) {
            $.get('/inventory/api/product-stock/', {product_id: productId, warehouse_id: warehouseId}, function(data) {
                if (data.success) {
                    $row.find('.stock-info').show().find('.stock-text').html('المخزون: <strong>' + data.current_stock + ' ' + data.unit + '</strong>');
                }
            });
        }
    });
    
    $(document).on('change', '.transfer-all-checkbox', function() {
        const $row = $(this).closest('.formset-row');
        if ($(this).is(':checked')) {
            const productId = $row.find('.product-select').val();
            const warehouseId = $('#id_from_warehouse').val();
            if (productId && warehouseId) {
                $.get('/inventory/api/product-stock/', {product_id: productId, warehouse_id: warehouseId}, function(data) {
                    if (data.success) $row.find('.quantity-input').val(data.current_stock);
                });
            }
        }
    });
    
    $(document).on('change', '.include-similar-checkbox', function() {
        const $row = $(this).closest('.formset-row');
        const productId = $row.find('.product-select').val();
        if ($(this).is(':checked') && productId) {
            $.get('/inventory/api/similar-products/', {product_id: productId}, function(data) {
                if (data.success && data.similar_products.length > 0) {
                    let html = '<div class="list-group mt-2">';
                    data.similar_products.forEach(function(p) {
                        html += '<a href="#" class="list-group-item list-group-item-action add-similar-product" data-product-id="' + p.id + '">' + p.name + '</a>';
                    });
                    html += '</div>';
                    $row.find('.similar-products-list').html(html);
                    $row.find('.similar-products-box').show();
                }
            });
        } else {
            $row.find('.similar-products-box').hide();
        }
    });
    
    $(document).on('click', '.add-similar-product', function(e) {
        e.preventDefault();
        $('#add-item').click();
        setTimeout(function() { $('.formset-row').last().find('.product-select').val($(this).data('product-id')).trigger('change'); }.bind(this), 100);
    });
    
    let formIndex = {{ formset.total_form_count }};
    $('#add-item').click(function() {
        const $template = $('.formset-row').first().clone();
        $template.find('input, select, textarea').val('');
        $template.find('.stock-info, .similar-products-box').hide();
        $template.find('input[type="checkbox"]').prop('checked', false);
        $template.html($template.html().replace(/form-0/g, 'form-' + formIndex));
        $('#formset-container').append($template);
        $('#id_form-TOTAL_FORMS').val(formIndex + 1);
        formIndex++;
        initSelect2();
    });
    
    $(document).on('click', '.delete-row-btn', function() {
        const $row = $(this).closest('.formset-row');
        if ($('.formset-row').length > 1) {
            $row.find('input[name$="-DELETE"]').prop('checked', true);
            $row.addClass('to-delete').hide();
        } else {
            alert('يجب أن يحتوي التحويل على منتج واحد على الأقل');
        }
    });
    
    const now = new Date();
    if (!$('#id_transfer_date').val()) $('#id_transfer_date').val(now.toISOString().slice(0, 16));
});
</script>
{% endblock %}
