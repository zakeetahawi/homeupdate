{% extends 'base.html' %}
{% load static %}

{% block title %}ØªØ­ÙˆÙŠÙ„Ø§Øª Ù…Ø®Ø²Ù†ÙŠØ©{% endblock %}

{% block extra_css %}
<style>
    .warehouse-radio-card {
        cursor: pointer;
        transition: all 0.3s;
        border: 2px solid #dee2e6;
    }

    .warehouse-radio-card:hover {
        border-color: #0d6efd;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .form-check-input:checked ~ .form-check-label .warehouse-radio-card {
        border-color: #0d6efd;
        background: #e7f1ff;
        box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.25);
    }

    .product-item {
        padding: 10px;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        margin-bottom: 8px;
        background: white;
        transition: all 0.2s;
    }

    .product-item:hover {
        background: #f8f9fa;
        border-color: #0d6efd;
    }

    .product-item.selected {
        background: #e7f1ff;
        border-color: #0d6efd;
    }

    .stock-badge {
        font-size: 0.85rem;
        padding: 4px 8px;
    }

    .search-box {
        position: sticky;
        top: 0;
        z-index: 10;
        background: white;
        padding: 15px;
        border-bottom: 2px solid #dee2e6;
    }

    .products-container {
        max-height: 500px;
        overflow-y: auto;
    }

    .step-indicator {
        display: flex;
        justify-content: space-between;
        margin-bottom: 30px;
    }

    .step {
        flex: 1;
        text-align: center;
        padding: 15px;
        background: #e9ecef;
        position: relative;
    }

    .step.active {
        background: #0d6efd;
        color: white;
    }

    .step.completed {
        background: #198754;
        color: white;
    }

    .loading {
        display: none;
        text-align: center;
        padding: 20px;
    }

    .loading.show {
        display: block;
    }

    .form-check {
        margin-bottom: 0;
    }

    .form-check-label {
        cursor: pointer;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>
                    <i class="fas fa-bolt text-warning"></i>
                    ØªØ­ÙˆÙŠÙ„Ø§Øª Ù…Ø®Ø²Ù†ÙŠØ©
                </h2>
                <a href="{% url 'inventory:stock_transfer_list' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-right"></i> Ø±Ø¬ÙˆØ¹
                </a>
            </div>

            <!-- Step Indicator -->
            <div class="step-indicator">
                <div class="step active" id="step1">
                    <i class="fas fa-warehouse"></i>
                    <div>1. Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª</div>
                </div>
                <div class="step" id="step2">
                    <i class="fas fa-boxes"></i>
                    <div>2. Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div>
                </div>
                <div class="step" id="step3">
                    <i class="fas fa-check-circle"></i>
                    <div>3. ØªØ£ÙƒÙŠØ¯ ÙˆÙ†Ù‚Ù„</div>
                </div>
            </div>

            <!-- Step 1: Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª -->
            <div id="step1-content" class="step-content">
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-warehouse"></i>
                            Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ù…ØµØ¯Ø± ÙˆØ§Ù„Ù…Ø³ØªÙ‡Ø¯Ù
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Ù…Ù† Ù…Ø³ØªÙˆØ¯Ø¹ -->
                        <div class="mb-4">
                            <label class="form-label fw-bold fs-5">
                                <i class="fas fa-warehouse text-danger"></i>
                                Ù…Ù† Ù…Ø³ØªÙˆØ¯Ø¹ *
                            </label>
                            <div class="row g-3">
                                {% for warehouse in warehouses %}
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio"
                                               name="from_warehouse"
                                               id="from_{{ warehouse.id }}"
                                               value="{{ warehouse.id }}"
                                               onchange="updateToWarehouses()">
                                        <label class="form-check-label w-100" for="from_{{ warehouse.id }}">
                                            <div class="card h-100 warehouse-radio-card">
                                                <div class="card-body text-center">
                                                    <i class="fas fa-warehouse fa-2x text-danger mb-2"></i>
                                                    <h6>{{ warehouse.name }}</h6>
                                                </div>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <hr class="my-4">

                        <!-- Ø¥Ù„Ù‰ Ù…Ø³ØªÙˆØ¯Ø¹ -->
                        <div class="mb-4">
                            <label class="form-label fw-bold fs-5">
                                <i class="fas fa-warehouse text-success"></i>
                                Ø¥Ù„Ù‰ Ù…Ø³ØªÙˆØ¯Ø¹ *
                            </label>
                            <div class="row g-3" id="to-warehouses-container">
                                <div class="col-12 text-center text-muted">
                                    <i class="fas fa-arrow-up"></i>
                                    Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ù…ØµØ¯Ø± Ø£ÙˆÙ„Ø§Ù‹
                                </div>
                            </div>
                        </div>

                        <hr class="my-4">

                        <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Ø³Ø¨Ø¨ Ø§Ù„ØªØ­ÙˆÙŠÙ„</label>
                                <input type="text" id="reason" class="form-control" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ...">
                            </div>

                            <div class="col-md-6 mb-3">
                                <label class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                                <input type="text" id="notes" class="form-control" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ...">
                            </div>
                        </div>

                        <button type="button" class="btn btn-primary btn-lg w-100" onclick="goToStep2()" id="next-step2-btn" disabled>
                            <i class="fas fa-arrow-left"></i>
                            Ø§Ù„ØªØ§Ù„ÙŠ: Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
                        </button>
                    </div>
                </div>
            </div>

            <!-- Step 2: Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª -->
            <div id="step2-content" class="step-content" style="display:none;">
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-boxes"></i>
                            Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù„Ù„Ù†Ù‚Ù„
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        <!-- Search Box -->
                        <div class="search-box">
                            <div class="row">
                                <div class="col-md-6">
                                    <input type="text" id="product-search" class="form-control form-control-lg"
                                           placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬ (Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„ÙƒÙˆØ¯ØŒ Ø§Ù„ÙØ¦Ø©)...">
                                </div>
                                <div class="col-md-3">
                                    <button type="button" class="btn btn-outline-success w-100" onclick="selectAll()">
                                        <i class="fas fa-check-double"></i>
                                        ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„
                                    </button>
                                </div>
                                <div class="col-md-3">
                                    <button type="button" class="btn btn-outline-danger w-100" onclick="deselectAll()">
                                        <i class="fas fa-times-circle"></i>
                                        Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙƒÙ„
                                    </button>
                                </div>
                            </div>
                            <div class="mt-2">
                                <span class="badge bg-info">
                                    <span id="selected-count">0</span> Ù…Ù†ØªØ¬ Ù…Ø­Ø¯Ø¯
                                </span>
                            </div>
                        </div>
                        
                        <!-- Loading -->
                        <div class="loading" id="products-loading">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
                            </div>
                            <p class="mt-2">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª...</p>
                        </div>
                        
                        <!-- Products List -->
                        <div class="products-container p-3" id="products-list">
                            <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="d-flex justify-content-between">
                            <button type="button" class="btn btn-secondary" onclick="goToStep1()">
                                <i class="fas fa-arrow-right"></i>
                                Ø±Ø¬ÙˆØ¹
                            </button>
                            <button type="button" class="btn btn-success btn-lg" onclick="goToStep3()">
                                <i class="fas fa-arrow-left"></i>
                                Ø§Ù„ØªØ§Ù„ÙŠ: ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù†Ù‚Ù„
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 3: Ø§Ù„ØªØ£ÙƒÙŠØ¯ ÙˆØ§Ù„Ù†Ù‚Ù„ -->
            <div id="step3-content" class="step-content" style="display:none;">
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">
                            <i class="fas fa-check-circle"></i>
                            ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ­ÙˆÙŠÙ„
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="transfer-summary">
                            <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="d-flex justify-content-between">
                            <button type="button" class="btn btn-secondary" onclick="goToStep2()">
                                <i class="fas fa-arrow-right"></i>
                                Ø±Ø¬ÙˆØ¹
                            </button>
                            <button type="button" class="btn btn-success btn-lg" onclick="submitTransfer()" id="submit-btn">
                                <i class="fas fa-check"></i>
                                ØªØ£ÙƒÙŠØ¯ ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªØ­ÙˆÙŠÙ„
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let selectedProducts = [];
let allProducts = [];
let fromWarehouseId = null;
let toWarehouseId = null;

// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ©
function updateToWarehouses() {
    fromWarehouseId = $('input[name="from_warehouse"]:checked').val();

    if (!fromWarehouseId) {
        $('#to-warehouses-container').html(`
            <div class="col-12 text-center text-muted">
                <i class="fas fa-arrow-up"></i>
                Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ù…ØµØ¯Ø± Ø£ÙˆÙ„Ø§Ù‹
            </div>
        `);
        $('#next-step2-btn').prop('disabled', true);
        return;
    }

    // Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª Ù…Ø§ Ø¹Ø¯Ø§ Ø§Ù„Ù…ØµØ¯Ø±
    let html = '';
    {% for warehouse in warehouses %}
    if ('{{ warehouse.id }}' !== fromWarehouseId) {
        html += `
            <div class="col-md-4">
                <div class="form-check">
                    <input class="form-check-input" type="radio"
                           name="to_warehouse"
                           id="to_{{ warehouse.id }}"
                           value="{{ warehouse.id }}"
                           onchange="enableNextButton()">
                    <label class="form-check-label w-100" for="to_{{ warehouse.id }}">
                        <div class="card h-100 warehouse-radio-card">
                            <div class="card-body text-center">
                                <i class="fas fa-warehouse fa-2x text-success mb-2"></i>
                                <h6>{{ warehouse.name }}</h6>
                            </div>
                        </div>
                    </label>
                </div>
            </div>
        `;
    }
    {% endfor %}

    $('#to-warehouses-container').html(html);
}

// ØªÙØ¹ÙŠÙ„ Ø²Ø± Ø§Ù„ØªØ§Ù„ÙŠ
function enableNextButton() {
    toWarehouseId = $('input[name="to_warehouse"]:checked').val();
    $('#next-step2-btn').prop('disabled', !toWarehouseId);
}

// Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø®Ø·ÙˆØ© 2
function goToStep2() {
    fromWarehouseId = $('input[name="from_warehouse"]:checked').val();
    toWarehouseId = $('input[name="to_warehouse"]:checked').val();

    if (!fromWarehouseId || !toWarehouseId) {
        alert('âš ï¸ ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ù…ØµØ¯Ø± ÙˆØ§Ù„Ù…Ø³ØªÙ‡Ø¯Ù');
        return;
    }

    if (fromWarehouseId === toWarehouseId) {
        alert('âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù…Ù† ÙˆØ¥Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹');
        return;
    }

    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø®Ø·ÙˆØ© 1 ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø®Ø·ÙˆØ© 2
    $('#step1-content').hide();
    $('#step2-content').show();
    $('#step1').removeClass('active').addClass('completed');
    $('#step2').addClass('active');

    // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø¨Ø­Ø« Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
    $('#products-list').html(`
        <div class="alert alert-info text-center">
            <i class="fas fa-search"></i>
            <h5 class="mt-2">Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h5>
            <p class="mb-0">Ø§Ø³ØªØ®Ø¯Ù… Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø¨Ø­Ø« Ø£Ø¹Ù„Ø§Ù‡ Ù„Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª (Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ø£Ùˆ Ø£ÙˆÙ„ Ø­Ø±Ù Ù…Ù†Ù‡)</p>
        </div>
    `);
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø­Ø«
function loadProducts(searchQuery = '') {
    // Ù„Ø§ ØªØ­Ù…Ù„ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¨Ø­Ø« ÙØ§Ø±ØºØ§Ù‹
    if (!searchQuery || searchQuery.length < 1) {
        $('#products-list').html(`
            <div class="alert alert-info text-center">
                <i class="fas fa-search"></i>
                <h5 class="mt-2">Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h5>
                <p class="mb-0">Ø§ÙƒØªØ¨ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ø­Ø±Ù ÙˆØ§Ø­Ø¯ Ù„Ù„Ø¨Ø­Ø«</p>
            </div>
        `);
        return;
    }

    $('#products-loading').addClass('show');
    $('#products-list').html('');

    $.ajax({
        url: '{% url "inventory:api_warehouse_products" %}',
        data: {
            warehouse_id: fromWarehouseId,
            search: searchQuery
        },
        success: function(data) {
            $('#products-loading').removeClass('show');

            if (data.success && data.products.length > 0) {
                allProducts = data.products;
                renderProducts(allProducts);
            } else {
                $('#products-list').html(`
                    <div class="alert alert-warning text-center">
                        <i class="fas fa-exclamation-triangle"></i>
                        Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¨Ø­Ø« "${searchQuery}"
                    </div>
                `);
            }
        },
        error: function() {
            $('#products-loading').removeClass('show');
            $('#products-list').html(`
                <div class="alert alert-danger text-center">
                    <i class="fas fa-times-circle"></i>
                    Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
                </div>
            `);
        }
    });
}

// Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
function renderProducts(products) {
    let html = '';
    products.forEach(function(product) {
        const isSelected = selectedProducts.find(p => p.id === product.id);
        html += `
            <div class="product-item ${isSelected ? 'selected' : ''}" data-product-id="${product.id}">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" 
                           id="product-${product.id}" 
                           ${isSelected ? 'checked' : ''}
                           onchange="toggleProduct(${product.id}, '${product.name}', ${product.stock}, '${product.unit}')">
                    <label class="form-check-label w-100" for="product-${product.id}">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${product.name}</strong>
                                ${product.code ? `<small class="text-muted">(${product.code})</small>` : ''}
                            </div>
                            <span class="badge bg-primary stock-badge">
                                ${product.stock} ${product.unit}
                            </span>
                        </div>
                    </label>
                </div>
            </div>
        `;
    });
    $('#products-list').html(html);
}

// ØªØ¨Ø¯ÙŠÙ„ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù†ØªØ¬
function toggleProduct(id, name, stock, unit) {
    const index = selectedProducts.findIndex(p => p.id === id);
    
    if (index > -1) {
        selectedProducts.splice(index, 1);
    } else {
        selectedProducts.push({ id, name, stock, unit });
    }
    
    updateSelectedCount();
}

// ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„
function selectAll() {
    const visibleProducts = $('#products-list .product-item:visible');
    visibleProducts.each(function() {
        const checkbox = $(this).find('input[type="checkbox"]');
        if (!checkbox.prop('checked')) {
            checkbox.prop('checked', true).trigger('change');
        }
    });
}

// Ø¥Ù„ØºØ§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„ (Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© ÙˆÙ„ÙŠØ³ Ø§Ù„Ù…Ø±Ø¦ÙŠØ© ÙÙ‚Ø·)
function deselectAll() {
    // Ø¥Ù„ØºØ§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø¬Ù…ÙŠØ¹ checkboxes Ø§Ù„Ù…Ø±Ø¦ÙŠØ©
    $('#products-list .product-item input[type="checkbox"]:checked').each(function() {
        $(this).prop('checked', false);
    });

    // Ù…Ø³Ø­ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
    selectedProducts = [];

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯
    updateSelectedCount();

    // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø©
    Swal.fire({
        icon: 'success',
        title: 'ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ¯',
        text: 'ØªÙ… Ø¥Ù„ØºØ§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª',
        timer: 1500,
        showConfirmButton: false
    });
}

// ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
function updateSelectedCount() {
    $('#selected-count').text(selectedProducts.length);
}

// Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª - Ù…Ø¹ debounce
let searchTimeout;
$('#product-search').on('input', function() {
    const searchTerm = $(this).val().trim();

    // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø³Ø§Ø¨Ù‚
    clearTimeout(searchTimeout);

    // Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± 500ms Ù‚Ø¨Ù„ Ø§Ù„Ø¨Ø­Ø«
    searchTimeout = setTimeout(function() {
        if (searchTerm.length >= 1) {
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
            loadProducts(searchTerm);
        } else {
            // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø«
            $('#products-list').html(`
                <div class="alert alert-info text-center">
                    <i class="fas fa-search"></i>
                    <h5 class="mt-2">Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h5>
                    <p class="mb-0">Ø§ÙƒØªØ¨ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ø­Ø±Ù ÙˆØ§Ø­Ø¯ Ù„Ù„Ø¨Ø­Ø«</p>
                </div>
            `);
            allProducts = [];
        }
    }, 500);
});

// Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø®Ø·ÙˆØ© 3
function goToStep3() {
    if (selectedProducts.length === 0) {
        alert('âš ï¸ ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù†ØªØ¬ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
        return;
    }
    
    $('#step2-content').hide();
    $('#step3-content').show();
    $('#step2').removeClass('active').addClass('completed');
    $('#step3').addClass('active');
    
    showSummary();
}

// Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ø®Øµ
function showSummary() {
    const fromName = $('#from_warehouse option:selected').text();
    const toName = $('#to_warehouse option:selected').text();
    const reason = $('#reason').val() || '-';
    const notes = $('#notes').val() || '-';
    
    let html = `
        <div class="alert alert-info">
            <h5><i class="fas fa-info-circle"></i> Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ­ÙˆÙŠÙ„</h5>
            <p><strong>Ù…Ù†:</strong> ${fromName}</p>
            <p><strong>Ø¥Ù„Ù‰:</strong> ${toName}</p>
            <p><strong>Ø§Ù„Ø³Ø¨Ø¨:</strong> ${reason}</p>
            <p><strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> ${notes}</p>
        </div>
        
        <h5 class="mt-4"><i class="fas fa-boxes"></i> Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© (${selectedProducts.length})</h5>
        <div class="table-responsive">
            <table class="table table-bordered">
                <thead class="table-light">
                    <tr>
                        <th>#</th>
                        <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
                        <th>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªÙˆÙØ±Ø©</th>
                        <th>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ù†Ù‚ÙˆÙ„Ø©</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    selectedProducts.forEach((product, index) => {
        html += `
            <tr>
                <td>${index + 1}</td>
                <td>${product.name}</td>
                <td>${product.stock} ${product.unit}</td>
                <td><strong class="text-success">${product.stock} ${product.unit}</strong> (Ø§Ù„ÙƒÙ„)</td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
    `;
    
    $('#transfer-summary').html(html);
}

// Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„
function submitTransfer() {
    $('#submit-btn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡...');
    
    const data = {
        from_warehouse: fromWarehouseId,
        to_warehouse: toWarehouseId,
        reason: $('#reason').val(),
        notes: $('#notes').val(),
        products: selectedProducts,
        csrfmiddlewaretoken: '{{ csrf_token }}'
    };
    
    $.ajax({
        url: '{% url "inventory:stock_transfer_bulk_create" %}',
        method: 'POST',
        data: JSON.stringify(data),
        contentType: 'application/json',
        success: function(response) {
            if (response.success) {
                alert('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!');
                window.location.href = response.redirect_url;
            } else {
                alert('âŒ Ø®Ø·Ø£: ' + response.error);
                $('#submit-btn').prop('disabled', false).html('<i class="fas fa-check"></i> ØªØ£ÙƒÙŠØ¯ ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªØ­ÙˆÙŠÙ„');
            }
        },
        error: function() {
            alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªØ­ÙˆÙŠÙ„');
            $('#submit-btn').prop('disabled', false).html('<i class="fas fa-check"></i> ØªØ£ÙƒÙŠØ¯ ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªØ­ÙˆÙŠÙ„');
        }
    });
}

// Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø®Ø·ÙˆØ© 1
function goToStep1() {
    $('#step2-content').hide();
    $('#step1-content').show();
    $('#step2').removeClass('active');
    $('#step1').removeClass('completed').addClass('active');
}
</script>
{% endblock %}

