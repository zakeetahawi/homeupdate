{% extends 'inventory/inventory_base_custom.html' %}
{% load static %}

{% block inventory_title %}Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø®Ø²ÙˆÙ†{% endblock %}

{% block inventory_content %}
<div class="dashboard-container">
    <!-- Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ù„Ù„ØªÙ†Ù‚Ù„ -->
    <div class="icon-cards-container">
        <a href="{% url 'inventory:product_list' %}" class="icon-card">
            <div class="icon-card-icon" style="color: #4e73df;">
                <i class="fas fa-box"></i>
            </div>
            <div class="icon-card-title">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div>
            <div class="icon-card-subtitle">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙˆØ§Ù„Ù…Ø®Ø²ÙˆÙ†</div>
        </a>
        
        <a href="{% url 'inventory:category_list' %}" class="icon-card">
            <div class="icon-card-icon" style="color: #1cc88a;">
                <i class="fas fa-tags"></i>
            </div>
            <div class="icon-card-title">Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª</div>
            <div class="icon-card-subtitle">Ø¥Ø¯Ø§Ø±Ø© ÙØ¦Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div>
        </a>
        
        <a href="{% url 'inventory:transaction_list' %}" class="icon-card">
            <div class="icon-card-icon" style="color: #36b9cc;">
                <i class="fas fa-exchange-alt"></i>
            </div>
            <div class="icon-card-title">Ø­Ø±ÙƒØ§Øª Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</div>
            <div class="icon-card-subtitle">ØªØªØ¨Ø¹ Ø­Ø±ÙƒØ© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div>
        </a>
        
        <a href="{% url 'inventory:adjustment_list' %}" class="icon-card">
            <div class="icon-card-icon" style="color: #f6c23e;">
                <i class="fas fa-balance-scale"></i>
            </div>
            <div class="icon-card-title">ØªØ³ÙˆÙŠØ§Øª Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</div>
            <div class="icon-card-subtitle">Ø¶Ø¨Ø· ÙˆØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</div>
        </a>
        
        <a href="{% url 'inventory:purchase_order_list' %}" class="icon-card">
            <div class="icon-card-icon" style="color: #e74a3b;">
                <i class="fas fa-shopping-cart"></i>
            </div>
            <div class="icon-card-title">Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø´Ø±Ø§Ø¡</div>
            <div class="icon-card-subtitle">Ø¥Ø¯Ø§Ø±Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø´Ø±Ø§Ø¡</div>
        </a>
        
        <a href="{% url 'inventory:supplier_list' %}" class="icon-card">
            <div class="icon-card-icon" style="color: #5a5c69;">
                <i class="fas fa-truck"></i>
            </div>
            <div class="icon-card-title">Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†</div>
            <div class="icon-card-subtitle">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†</div>
        </a>
        
        <a href="{% url 'inventory:warehouse_list' %}" class="icon-card">
            <div class="icon-card-icon" style="color: #6f42c1;">
                <i class="fas fa-warehouse"></i>
            </div>
            <div class="icon-card-title">Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª</div>
            <div class="icon-card-subtitle">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª</div>
        </a>
        
        <a href="{% url 'inventory:warehouse_location_list' %}" class="icon-card">
            <div class="icon-card-icon" style="color: #fd7e14;">
                <i class="fas fa-map-marker-alt"></i>
            </div>
            <div class="icon-card-title">Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„ØªØ®Ø²ÙŠÙ†</div>
            <div class="icon-card-subtitle">Ø¥Ø¯Ø§Ø±Ø© Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„ØªØ®Ø²ÙŠÙ†</div>
        </a>
        
        <a href="{% url 'inventory:report_list' %}" class="icon-card">
            <div class="icon-card-icon" style="color: #20c9a6;">
                <i class="fas fa-chart-bar"></i>
            </div>
            <div class="icon-card-title">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</div>
            <div class="icon-card-subtitle">ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</div>
        </a>
        
        <a href="{% url 'inventory:product_bulk_upload' %}" class="icon-card">
            <div class="icon-card-icon" style="color: #28a745;">
                <i class="fas fa-upload"></i>
            </div>
            <div class="icon-card-title">Ø±ÙØ¹ Ù…Ù†ØªØ¬Ø§Øª</div>
            <div class="icon-card-subtitle">Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬Ø§Øª Ù…Ù† Ø¥ÙƒØ³Ù„</div>
        </a>
        
        <a href="{% url 'inventory:bulk_stock_update' %}" class="icon-card">
            <div class="icon-card-icon" style="color: #ffc107;">
                <i class="fas fa-sync-alt"></i>
            </div>
            <div class="icon-card-title">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</div>
            <div class="icon-card-subtitle">ØªØ­Ø¯ÙŠØ« ÙƒÙ…ÙŠØ§Øª Ø¨Ø§Ù„Ø¬Ù…Ù„Ø©</div>
        </a>
        
        <a href="{% url 'inventory:download_excel_template' %}" class="icon-card">
            <div class="icon-card-icon" style="color: #17a2b8;">
                <i class="fas fa-download"></i>
            </div>
            <div class="icon-card-title">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ù„Ø¨</div>
            <div class="icon-card-subtitle">Ù‚Ø§Ù„Ø¨ Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„</div>
        </a>

        <a href="{% url 'cutting:order_list' %}" class="icon-card">
            <div class="icon-card-icon" style="color: #6f42c1;">
                <i class="fas fa-cut"></i>
            </div>
            <div class="icon-card-title">Ø£ÙˆØ§Ù…Ø± Ø§Ù„ØªÙ‚Ø·ÙŠØ¹</div>
            <div class="icon-card-subtitle">Ø¥Ø¯Ø§Ø±Ø© Ø£ÙˆØ§Ù…Ø± Ø§Ù„ØªÙ‚Ø·ÙŠØ¹ ÙˆØ§Ù„Ø®ØµÙ…</div>
        </a>

        <a href="{% url 'inventory:alert_list' %}" class="icon-card alert-card">
            <div class="icon-card-icon" style="color: #e74a3b;">
                <i class="fas fa-bell"></i>
                <span class="alert-count" id="alertCount">0</span>
            </div>
            <div class="icon-card-title">Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</div>
            <div class="icon-card-subtitle">ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</div>
        </a>
    </div>

    <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø³Ø±ÙŠØ¹Ø© -->
    <div class="stats-cards-container">
        <div class="stat-card">
            <div class="stat-card-icon">
                <i class="fas fa-box"></i>
            </div>
            <div class="stat-card-content">
                <div class="stat-card-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div>
                <div class="stat-card-value">{{ total_products }}</div>
                <div class="stat-card-change positive">
                    <i class="fas fa-arrow-up"></i> 5% Ù…Ù†Ø° Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø§Ø¶ÙŠ
                </div>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-card-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="stat-card-content">
                <div class="stat-card-title">Ù…Ù†ØªØ¬Ø§Øª Ù…Ù†Ø®ÙØ¶Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</div>
                <div class="stat-card-value">{{ low_stock_products_count }}</div>
                <div class="stat-card-change negative">
                    <i class="fas fa-arrow-up"></i> 12% Ù…Ù†Ø° Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ù…Ø§Ø¶ÙŠ
                </div>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-card-icon">
                <i class="fas fa-bell"></i>
            </div>
            <div class="stat-card-content">
                <div class="stat-card-title">Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©</div>
                <div class="stat-card-value" id="activeAlertsCount">0</div>
                <div class="stat-card-change positive">
                    <i class="fas fa-arrow-up"></i> Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: Ø§Ù„Ø¢Ù†
                </div>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-card-icon">
                <i class="fas fa-shopping-cart"></i>
            </div>
            <div class="stat-card-content">
                <div class="stat-card-title">Ø·Ù„Ø¨Ø§Øª Ø´Ø±Ø§Ø¡ Ù…Ø¹Ù„Ù‚Ø©</div>
                <div class="stat-card-value">{{ pending_purchase_orders }}</div>
                <div class="stat-card-change negative">
                    <i class="fas fa-arrow-down"></i> 8% Ù…Ù†Ø° Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ù…Ø§Ø¶ÙŠ
                </div>
            </div>
        </div>
    </div>

    <!-- Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© -->
    <div class="row">
        <div class="col-xl-6">
            <div class="chart-container">
                <div class="chart-header">
                    <h4 class="chart-title">Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø©</h4>
                    <div class="chart-actions">
                        <button class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-download"></i> ØªØµØ¯ÙŠØ±
                        </button>
                    </div>
                </div>
                <div class="chart-body">
                    <canvas id="stockByCategoryChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-xl-6">
            <div class="chart-container">
                <div class="chart-header">
                    <h4 class="chart-title">Ø­Ø±ÙƒØ© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† (Ø¢Ø®Ø± 30 ÙŠÙˆÙ…)</h4>
                    <div class="chart-actions">
                        <button class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-download"></i> ØªØµØ¯ÙŠØ±
                        </button>
                    </div>
                </div>
                <div class="chart-body">
                    <canvas id="stockMovementChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ù†Ø®ÙØ¶Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† -->
    <div class="data-table-container">
        <div class="data-table-header">
            <h4 class="data-table-title">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ù†Ø®ÙØ¶Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</h4>
            <div class="data-table-actions">
                <a href="{% url 'inventory:product_list' %}?filter=low_stock" class="btn btn-primary btn-sm">
                    Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„
                </a>
            </div>
        </div>
        <div class="data-table-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
                            <th>Ø§Ù„ÙƒÙˆØ¯</th>
                            <th>Ø§Ù„ÙØ¦Ø©</th>
                            <th>Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø­Ø§Ù„ÙŠ</th>
                            <th>Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰</th>
                            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for product in low_stock_products %}
                        <tr>
                            <td>{{ product.name }}</td>
                            <td>{{ product.code }}</td>
                            <td>{{ product.category }}</td>
                            <td>
                                <span class="badge bg-danger">{{ product.current_stock_level|default:0 }}</span>
                            </td>
                            <td>{{ product.minimum_stock }}</td>
                            <td>
                                <div class="btn-group" role="group">
                                    <a href="{% url 'inventory:product_detail' product.id %}" class="btn btn-info btn-sm">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a href="{% url 'inventory:transaction_create' product.id %}" class="btn btn-success btn-sm">
                                        <i class="fas fa-plus"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù…Ù†Ø®ÙØ¶Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Ø¢Ø®Ø± Ø­Ø±ÙƒØ§Øª Ø§Ù„Ù…Ø®Ø²ÙˆÙ† -->
    <div class="data-table-container">
        <div class="data-table-header">
            <h4 class="data-table-title">Ø¢Ø®Ø± Ø­Ø±ÙƒØ§Øª Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</h4>
            <div class="data-table-actions">
                <a href="{% url 'inventory:stock_movement_report' %}" class="btn btn-primary btn-sm">
                    Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„
                </a>
            </div>
        </div>
        <div class="data-table-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
                            <th>Ù†ÙˆØ¹ Ø§Ù„Ø­Ø±ÙƒØ©</th>
                            <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                            <th>Ø§Ù„Ø³Ø¨Ø¨</th>
                            <th>Ø¨ÙˆØ§Ø³Ø·Ø©</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for transaction in recent_transactions %}
                        <tr>
                            <td>{{ transaction.date|date:"Y-m-d H:i" }}</td>
                            <td>{{ transaction.product.name }}</td>
                            <td>
                                <span class="badge {% if transaction.transaction_type == 'in' %}bg-success{% elif transaction.transaction_type == 'out' %}bg-danger{% else %}bg-info{% endif %}">
                                    {{ transaction.get_transaction_type_display }}
                                </span>
                            </td>
                            <td>{{ transaction.quantity }}</td>
                            <td>{{ transaction.get_reason_display }}</td>
                            <td>{{ transaction.created_by.get_full_name }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø±ÙƒØ§Øª Ù…Ø®Ø²ÙˆÙ† Ø­Ø¯ÙŠØ«Ø©</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script>
    // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©
    const stockByCategoryData = {
        labels: [{% for category in stock_by_category %}'{{ category.name }}',{% endfor %}],
        data: [{% for category in stock_by_category %}{{ category.stock }},{% endfor %}]
    };
    
    const stockMovementData = {
        labels: [{% for date in stock_movement_dates %}'{{ date|date:"d/m" }}',{% endfor %}],
        inData: [{% for value in stock_movement_in %}{{ value }},{% endfor %}],
        outData: [{% for value in stock_movement_out %}{{ value }},{% endfor %}]
    };

    // Ø±Ø³Ù… Ø¨ÙŠØ§Ù†ÙŠ Ù„Ù„Ù…Ø®Ø²ÙˆÙ† Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø©
    const stockByCategoryChart = document.getElementById('stockByCategoryChart');
    if (stockByCategoryChart) {
        new Chart(stockByCategoryChart, {
            type: 'bar',
            data: {
                labels: stockByCategoryData.labels,
                datasets: [{
                    label: 'Ø§Ù„ÙƒÙ…ÙŠØ© ÙÙŠ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†',
                    data: stockByCategoryData.data,
                    backgroundColor: [
                        'rgba(78, 115, 223, 0.8)',
                        'rgba(28, 200, 138, 0.8)',
                        'rgba(54, 185, 204, 0.8)',
                        'rgba(246, 194, 62, 0.8)',
                        'rgba(231, 74, 59, 0.8)',
                        'rgba(133, 135, 150, 0.8)',
                        'rgba(111, 66, 193, 0.8)',
                        'rgba(253, 126, 20, 0.8)',
                        'rgba(32, 201, 151, 0.8)',
                        'rgba(255, 99, 132, 0.8)'
                    ],
                    borderColor: [
                        'rgba(78, 115, 223, 1)',
                        'rgba(28, 200, 138, 1)',
                        'rgba(54, 185, 204, 1)',
                        'rgba(246, 194, 62, 1)',
                        'rgba(231, 74, 59, 1)',
                        'rgba(133, 135, 150, 1)',
                        'rgba(111, 66, 193, 1)',
                        'rgba(253, 126, 20, 1)',
                        'rgba(32, 201, 151, 1)',
                        'rgba(255, 99, 132, 1)'
                    ],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    title: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            font: {
                                size: 12
                            }
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    x: {
                        ticks: {
                            font: {
                                size: 12
                            }
                        },
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
    }

    // Ø±Ø³Ù… Ø¨ÙŠØ§Ù†ÙŠ Ù„Ø­Ø±ÙƒØ© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
    const stockMovementChart = document.getElementById('stockMovementChart');
    if (stockMovementChart) {
        new Chart(stockMovementChart, {
            type: 'line',
            data: {
                labels: stockMovementData.labels,
                datasets: [
                    {
                        label: 'Ø¥Ø¯Ø®Ø§Ù„',
                        data: stockMovementData.inData,
                        backgroundColor: 'rgba(28, 200, 138, 0.1)',
                        borderColor: 'rgba(28, 200, 138, 1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointBackgroundColor: 'rgba(28, 200, 138, 1)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointHoverRadius: 6,
                        pointHoverBackgroundColor: 'rgba(28, 200, 138, 1)',
                        pointHoverBorderColor: '#fff',
                        pointHoverBorderWidth: 2
                    },
                    {
                        label: 'Ø¥Ø®Ø±Ø§Ø¬',
                        data: stockMovementData.outData,
                        backgroundColor: 'rgba(231, 74, 59, 0.1)',
                        borderColor: 'rgba(231, 74, 59, 1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointBackgroundColor: 'rgba(231, 74, 59, 1)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointHoverRadius: 6,
                        pointHoverBackgroundColor: 'rgba(231, 74, 59, 1)',
                        pointHoverBorderColor: '#fff',
                        pointHoverBorderWidth: 2
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            padding: 15,
                            font: {
                                size: 13
                            }
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        titleFont: {
                            size: 14
                        },
                        bodyFont: {
                            size: 13
                        },
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                label += context.parsed.y + ' ÙˆØ­Ø¯Ø©';
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            font: {
                                size: 12
                            }
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    x: {
                        ticks: {
                            font: {
                                size: 12
                            }
                        },
                        grid: {
                            display: false
                        }
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                }
            }
        });
    }
</script>
<!-- Real-time Dashboard -->
<script>
class InventoryDashboardManager {
    constructor() {
        this.updateInterval = 15000; // 15 seconds
        this.isUpdating = false;
        this.init();
    }

    init() {
        // Start updating after page load
        setTimeout(() => {
            this.startAutoUpdate();
            this.setupEventListeners();
        }, 1000);
        
        // Stop auto-updates when page is hidden
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                this.stopAutoUpdate();
            } else {
                this.startAutoUpdate();
            }
        });
    }

    setupEventListeners() {
        // Auto-refresh on filter changes
        const filterElements = document.querySelectorAll('.dashboard-filters select, .dashboard-filters input');
        filterElements.forEach(element => {
            element.addEventListener('change', () => {
                this.updateDashboard();
            });
        });
    }

    startAutoUpdate() {
        if (this.isUpdating) return;
        
        this.isUpdating = true;
        console.log('ğŸ”„Starting dashboard real-time updates...');
        
        // Update immediately
        this.updateDashboard();
        
        // Set interval for periodic updates
        this.updateIntervalId = setInterval(() => {
            this.updateDashboard();
        }, this.updateInterval);
    }

    stopAutoUpdate() {
        this.isUpdating = false;
        if (this.updateIntervalId) {
            clearInterval(this.updateIntervalId);
            this.updateIntervalId = null;
        }
        console.log('â¸ï¸Stopped dashboard updates');
    }

    async updateDashboard() {
        if (!this.isUpdating) return;

        try {
            const response = await fetch('/inventory/api/dashboard-stats/', {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json',
                }
            });

            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    this.updateDashboardUI(data);
                    console.log('âœ…Dashboard updated successfully');
                }
            }
        } catch (error) {
            console.error('âŒError fetching dashboard data:', error);
        }
    }

    updateDashboardUI(data) {
        // Update statistics cards
        this.updateStatsCards(data.stats);
        
        // Update recent alerts
        this.updateAlertsList(data.recent_alerts);
        
        // Update notifications
        this.updateNotifications(data.notifications);
        
        // Update unread count in header
        this.updateUnreadCount(data.unread_count);
    }

    updateStatsCards(stats) {
        const updates = {
            'totalProducts': stats.total_products,
            'lowStockCount': stats.low_stock_count,
            'outOfStockCount': stats.out_of_stock_count,
            'totalValue': stats.total_value || 0,
            'activeAlertsCount': stats.active_alerts_count,
        };

        Object.keys(updates).forEach(key => {
            const element = document.getElementById(key) || 
                              document.querySelector(`.${key}`) ||
                              document.querySelector(`[data-stat="${key}"]`);
                              
            if (element) {
                const elementValue = element.querySelector('.stat-card-value');
                if (elementValue) {
                    const oldValue = parseFloat(elementValue.textContent) || 0;
                    const newValue = parseFloat(updates[key]);
                    
                    if (oldValue !== newValue) {
                        this.animateValueChange(elementValue, oldValue, newValue);
                    }
                }
            }
        });
    }

    updateAlertsList(alerts) {
        const alertsContainer = document.getElementById('recentAlertsList') ||
                            document.querySelector('.recent-alerts-placeholder');
        
        if (!alertsContainer) return;

        const containerTitle = alertsContainer.querySelector('.container-title') ||
                                 alertsContainer.querySelector('h4');
        
        // Show alerts if any exist
        if (alerts.length > 0) {
            containerTitle.innerHTML += ` <span class="badge bg-danger ms-2">${alerts.length}</span>`;
            
            // Update alerts list or create placeholder
            const alertsList = alertsContainer.querySelector('.alerts-list');
            
            if (alertsList) {
                alertsList.innerHTML = alerts.slice(0, 5).map(alert => `
                    <div class="alert-item alert-priority-${alert.priority}">
                        <div class="alert-info">
                            <strong>${alert.title}</strong>
                            <small class="text-muted">${alert.product.name}</small>
                        </div>
                        <div class="alert-actions">
                            <a href="/inventory/product/${alert.product.id}" class="btn btn-sm btn-primary">
                                <i class="fas fa-eye"></i> Ø¹Ø±Ø¶
                            </a>
                            <button class="btn btn-sm btn-success" 
                                    onclick="resolveAlert(${alert.id})">
                                <i class="fas fa-check"></i> Ø­Ù„
                            </button>
                        </div>
                        <div class="alert-time">${new Date(alert.created_at).toLocaleTimeString('ar-SA')}</div>
                    </div>
                `).join('');
            }
            
            containerTitle.style.display = 'block';
        } else {
            containerTitle.innerHTML = 'Ø£Ø­Ø¯Ø« ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ù…Ø¤Ø®Ø±Ø§Ù‹';
            
            if (alertsList) {
                alertsList.innerHTML = '<p class="text-muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</p>';
            }
        }
    }

    updateNotifications(notifications) {
        const notificationsContainer = document.getElementById('dashboardNotifications');
        
        if (!notificationsContainer) return;

        if (notifications.length > 0) {
            notificationsContainer.innerHTML = notifications.slice(0, 3).map(notification => `
                <div class="notification-item">
                    <div class="notification-content">
                        <div class="notification-title">${notification.title}</div>
                        <div class="notification-message">${notification.message}</div>
                        <div class="notification-time">${new Date(notification.created_at).toLocaleTimeString('ar-SA')}</div>
                    </div>
                </div>
            `).join('');
            
            notificationsContainer.style.display = 'block';
        } else {
            notificationsContainer.innerHTML = '<p class="text-muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</p>';
            notificationsContainer.style.display = 'none';
        }
    }

    updateUnreadCount(count) {
        const unreadCountElement = document.getElementById('dashboardUnreadCount');
        if (unreadCountElement) {
            if (count > 0) {
                unreadCountElement.textContent = count;
                unreadCountElement.style.display = 'block';
                unreadCountElement.classList.add('animate-pulse');
                
                setTimeout(() => {
                    unreadCountElement.classList.remove('animate-pulse');
                }, 2000);
            } else {
                unreadCountElement.style.display = 'none';
            }
        }
    }

    animateValueChange(element, oldValue, newValue) {
        element.style.transition = 'all 0.6s ease';
        
        element.style.transform = 'scale(1.1)';
        setTimeout(() => {
            element.textContent = newValue.toLocaleString();
            element.style.transform = 'scale(1)';
            element.style.transition = '';
        }, 200);
    }

    async resolveAlert(alertId) {
        try {
            const response = await fetch(`/inventory/api/alert/${alertId}/resolve/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': this.getCsrfToken(),
                    'Content-Type': 'application/json',
                }
            });

            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    // Show success message
                    this.showToast('âœ…', data.message, 'success');
                    
                    // Update immediately
                    setTimeout(() => this.updateDashboard(), 500);
                } else {
                    this.showToast('âŒ', data.message, 'error');
                }
            }
        } catch (error) {
            console.error('Error resolving alert:', error);
            this.showToast('âŒ', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡', 'error');
        }
    }

    showToast(icon, message, type = 'info') {
        console.log(`ğŸ”” ${icon} ${message}`);
    }

    getCsrfToken() {
        return document.cookie.match('csrftoken[^;]+ ')[0])[1] || null;
    }
}

// Initialize the dashboard manager when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    window.inventoryDashboardManager = new InventoryDashboardManager();
});
</script>

<style>
.animate-pulse {
    animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}

.alert-card .icon-card-icon {
    position: relative;
}

.alert-count {
    position: absolute;
    top: -5px;
    right: -5px;
    background: #dc3545;
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    font-weight: bold;
}

.recent-alerts-placeholder {
    max-height: 300px;
    overflow-y: auto;
}

.alert-item {
    padding: 10px;
    margin-bottom: 8px;
    border-radius: 8px;
    border-left: 3px solid;
    margin-bottom: 10px;
    background: white;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
}

.alert-priority-high {
    border-left-color: #dc3545;
}

.alert-priority-medium {
    border-left-color: #ffc107;
}

.alert-priority-low {
    border-left-color: #17a2b8;
}

.alert-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-grow: 1;
}

.alert-actions {
    display: flex;
    gap: 5px;
}

.alert-time {
    font-size: 0.75rem;
    color: #6c757d;
}
</style>
{% endblock %}
