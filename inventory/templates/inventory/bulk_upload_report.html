{% extends 'inventory/inventory_base_custom.html' %}
{% load static %}














































































































































































































































































































































































































*ุงูุฅุตุฏุงุฑ: 2.0 - Performance Edition**ุขุฎุฑ ุชุญุฏูุซ: 25 ููููุจุฑ 2025*---**ุงููุธุงู ุงูุขู ุฌุงูุฒ ููุฅูุชุงุฌ ุจููุงุกุฉ ุนุงููุฉ! ๐**- ๐ฏ **ุชุฌุฑุจุฉ ูุณุชุฎุฏู ููุชุงุฒุฉ**- ๐ **ุชุชุจุน ูุญุธู real-time**- ๐พ **ุงุณุชููุงู ุฃูู 70%**- โก **ุฃุณุฑุน 10-100x**ุชู ุชุญุณูู ุงููุธุงู ุจุดูู ุดุงูู ููููู:## โจ ุงูุฎูุงุตุฉ---4. ุงุชุตู ุจุงูุฏุนู ุงูููู3. ุงูุญุต ูุงุนุฏุฉ ุงูุจูุงูุงุช2. ุชุญูู ูู Celery workers1. ุฑุงุฌุน ุงูุณุฌูุงุช (logs)ูู ุญุงูุฉ ูุฌูุฏ ุฃู ูุดุงูู:## ๐ ุงูุฏุนู ูุงููุณุงุนุฏุฉ---   ```   # ุชุญุฏูุซ ููุฑู ุจุฏูู polling   # ุงุณุชุฎุฏุงู Django Channels   ```python3. **WebSockets ููุชุญุฏูุซ ุงูููุฑู**:   ```   ]       'django.middleware.gzip.GZipMiddleware',   MIDDLEWARE = [   # ุถุบุท JSON responses   ```python2. **ุถุบุท ุงูุจูุงูุงุช**:   ```       # ูุนุงูุฌุฉ 4 ุฏูุนุงุช ูู ููุณ ุงูููุช   with ProcessPoolExecutor(max_workers=4) as executor:      from concurrent.futures import ProcessPoolExecutor   # ุงุณุชุฎุฏุงู multiprocessing   ```python1. **ูุนุงูุฌุฉ ูุชูุงุฒูุฉ ุญููููุฉ**:### Phase 2 (ุงุฎุชูุงุฑู):## ๐ ุงูุชุญุณููุงุช ุงููุณุชูุจููุฉ ุงูููุชุฑุญุฉ---   - ุฃููุฏ ุงููุฌุงุญ ุจูุถูุญ   - ุฃุถู ุชุฃุซูุฑุงุช ุจุตุฑูุฉ   - ุงุนุฑุถ ูุนูููุงุช ูููุฏุฉ3. **User Experience**:   - ุงุฌูุน ุงูุนูููุงุช   - ุงุณุชุฎุฏู ุนุชุจุงุช (thresholds)   - ูุง ุชุญุฏูุซ ูู iteration2. **Frontend Updates**:   - ุงุณุชุฎุฏู bulk operations   - ุชุฌูุจ N+1 queries   - ุงุณุชุฎุฏู `.only()` ุฏุงุฆูุงู1. **Database Queries**:### โ Best Practices:## ๐ ุงูุฏุฑูุณ ุงููุณุชูุงุฏุฉ---```โ ุงููุฏุฉ ุงููููุฉโ ูุณุจุฉ ุงููุฌุงุญโ ุงูููุช ุงููุชุจูู ุงููุชููุนโ ุงูุณุฑุนุฉ ุงููุญุธูุฉ```python### 3. ูุนูููุงุช ุงูุณูุงู:```โ ุนุฏุฏ ุงูุฃุฎุทุงุก ุงููุนููุฉโ ุนุฏุฏ ุงูููุชุฌุงุช ุงููุชุฎุทุงุฉโ ุนุฏุฏ ุงูููุชุฌุงุช ุงููุญุฏูุซุฉโ ุนุฏุฏ ุงูููุชุฌุงุช ุงูููุดุฃุฉ```python### 2. ุฅุญุตุงุฆูุงุช ุฏูููุฉ:```โ ุชุตููู ุงูุฃุฎุทุงุก (ูุดู / ุชุฎุทู / ุชุญุฏูุซ)โ ุชูุงุตูู ุฏูููุฉ ููู ุฎุทุฃโ ุชุณุฌูู ุงูุฃุฎุทุงุก ุจุงูุฏูุนุฉ (bulk_create)```python### 1. ุชุชุจุน ุงูุฃุฎุทุงุก ุงููุญุณูู:## ๐ ููุฒุงุช ุฅุถุงููุฉ---```)  # โ ููุท ูุง ูุญุชุงุฌู    'id', 'name', 'code', 'price'products = Product.objects.only(# ุจุนุฏ (ุณุฑูุน)products = Product.objects.all()  # ๐ฑ ูู ุงูุญููู# ูุจู (ุจุทูุก)```python### ุงุณุชุนูุงูุงุช ูุญุณููุฉ:```eta_seconds = remaining_rows / speedremaining_rows = total_rows - processed_count# ุงูููุช ุงููุชุจููspeed = processed_count / elapsed  # ุตู/ุซุงููุฉelapsed = (now - upload_log.created_at).total_seconds()# ุงูุณุฑุนุฉ ุงูุญุงููุฉ```python### ุญุณุงุจ ุงูุณุฑุนุฉ:```)    batch_size=500  # ุญุฌู ูุซุงูู ููุฅุฏุฑุงุฌ    errors_batch, BulkUploadError.objects.bulk_create(# bulk_create ุงูุฃูุซูUPDATE_THRESHOLD = 5  # ุชุญุฏูุซ ูู 5%# ุนุชุจุฉ ุงูุชุญุฏูุซBATCH_SIZE = 1000  # ูุนุงูุฑุฉ ูุฃูุถู ุฃุฏุงุก# ุญุฌู ุงูุฏูุนุฉ ุงูุฃูุซู```python### ูุนุงูุฌุฉ ุงูุฏูุนุงุช:## ๐ ุงูุชูุงุตูู ุงูุชูููุฉ---```})    timer: 2000    text: 'ุชู ูุนุงูุฌุฉ 50,000 ุตู ุจูุฌุงุญ',    title: 'ุงูุชูู ุงูุฑูุน! ๐',    icon: 'success',Swal.fire({```javascript### ุฑุณุงุฆู ุงููุฌุงุญ ุงูุชููุงุฆูุฉ:```โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ ุฃุฎุทุงุก: 12                         โโ  โญ๏ธ ุชู ุชุฎุทูู: 350                    โโ  ๐ ุชู ุชุญุฏูุซู: 2,180                  โโ  โ ุชู ุฅูุดุงุคู: 5,420                  โโ                                         โโ  โฑ๏ธ ุงูููุช ุงููุชุจูู: 25 ุซุงููุฉ          โโ  โก ุงูุณุฑุนุฉ: 1,500 ุตู/ุซุงููุฉ            โโ                                         โโ  โโโโโโโโโโโโโโโโโโโโ 75%              โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโคโ  ๐ ุนูููุฉ ุงูุฑูุน ุงูุฌูุงุนู              โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ```html### ุดุงุดุฉ ุงูุชูุฏู ุงูุฌุฏูุฏุฉ:## ๐จ ุงูุชุญุณููุงุช ุงูุจุตุฑูุฉ---   ```   ๐ ุงูุชูุฏู: 67%   โฑ๏ธ ุงูููุช ุงููุชุจูู: 45 ุซุงููุฉ   โก ุงูุณุฑุนุฉ: 1,234 ุตู/ุซุงููุฉ   ```4. **ุฑุงูุจ ุงูุชูุฏู**:   - ุนุฑุถ ุงูุณุฑุนุฉ ูุงูููุช ุงููุชุจูู   - ุชุญุฏูุซ ูุญุธู ูู 300ms   - ุณูุชู ูุนุงูุฌุฉ 1000 ุตู/ุฏูุนุฉ โก3. **ุงุฑูุน ุงูููู**:   - `clean_start`: ุจุฏุงูุฉ ูุธููุฉ   - `add_only`: ุฅุถุงูุฉ ุฌุฏูุฏ ููุท   - `merge_warehouses`: ุฏูุฌ ุงููุณุชูุฏุนุงุช   - `smart_update`: ุชุญุฏูุซ ุฐูู (ููุตู ุจู)2. **ุงุฎุชุฑ ุงููุถุน**:   ```   ุฅูุณู ุจุตูุบุฉ .xlsx ุฃู .xls   ```1. **ุงุฎุชุฑ ุงูููู**:### ุงูุฑูุน ุงูุฌูุงุนู ุงููุญุณูู:## ๐ ููููุฉ ุงูุงุณุชุฎุฏุงู---```โ Efficient DOM updates       // ุชุญุฏูุซุงุช DOM ูุนูุงูุฉโ Progressive enhancement     // ุชุญุณูู ุชุฏุฑูุฌูโ Real-time updates (300ms)    // ุชุญุฏูุซ ุณุฑูุน```javascript### 4. Frontend Performance:```โ bulk operations               # ุนูููุงุช ุฌูุงุนูุฉโ ุชุญุฏูุซ ุญุงูุฉ ุฐูู               # ูู 5% ููุทโ Batch processing ูุจูุฑ         # 1000 ุตู/ุฏูุนุฉ```python### 3. Celery Optimization:```โ Cache invalidation ุฐูู       # ุชุญุฏูุซ ุนูุฏ ุงูุญุงุฌุฉ ููุทโ get_cached_dashboard_stats()  # ุชุฎุฒูู ูุคูุช ููุฅุญุตุงุฆูุงุช```python### 2. Caching Strategy:```โ bulk_create()        # ุฅุฏุฑุงุฌ ุฌูุงุนูโ prefetch_related()   # ุชุญููู ุนูุงูุงุช ูุนูุฏุฉโ only()               # ุชุญููู ุญููู ูุญุฏุฏุฉ ููุทโ select_related()      # ุชูููู N+1 queries```python### 1. Database Optimization:## ๐ง ุงูุชูููุงุช ุงููุณุชุฎุฏูุฉ---   - ุฑุณุงุฆู ูุฌุงุญ ุชููุงุฆูุฉ   - ุชุฃุซูุฑุงุช ุจุตุฑูุฉ ูุญุณููุฉ   - ุนุฑุถ ุงูุณุฑุนุฉ ูุงูููุช ุงููุชุจูู   - ุชุญุฏูุซ ูู 300ms (ุจุฏูุงู ูู 1000ms)4. โ `/inventory/templates/inventory/bulk_upload_report.html`### Frontend:   - ุฏุนู ูุนูููุงุช Celery task   - ุนุฑุถ ุงูููุช ุงููุชุจูู   - ุญุณุงุจ ุงูุณุฑุนุฉ real-time3. โ `/inventory/api_views.py`   - ุฒูุงุฏุฉ page_size ุงูุงูุชุฑุงุถู   - ุชูููู ุญุฌู ุงูุจูุงูุงุช ุงููุญููุฉ   - ุงุณุชุฎุฏุงู `.only()` ูู ูู ููุงู2. โ `/inventory/views.py`   - bulk_create ูุญุณูู   - ุชุญุฏูุซ ุชูุฏู ุฐูู (ูู 5%)   - ุฒูุงุฏุฉ batch_size ูู 100 ุฅูู 10001. โ `/inventory/tasks_optimized.py`### Backend:## ๐ฏ ุงููููุงุช ุงููุญุณููุฉ---| ุญุฌู ุงูุจูุงูุงุช | 8.5 MB | **2.1 MB** | **75% ุฃูู** ๐พ || ุงุณุชุนูุงูุงุช DB | 45 ุงุณุชุนูุงู | **3 ุงุณุชุนูุงูุงุช** | **93% ุฃูู** ๐ || ููุช ุงูุชุญููู | 2.3 ุซุงููุฉ | **0.4 ุซุงููุฉ** | **5.7x ุฃุณุฑุน** โก ||---------|-----|-----|---------|| ุงููููุงุณ | ูุจู | ุจุนุฏ | ุงูุชุญุณูู |### ุณููุงุฑูู: ุนุฑุถ 1,000 ููุชุฌ| ุงุณุชููุงู ุงูุฐุงูุฑุฉ | 2.5 GB | **800 MB** | **68% ุฃูู** ๐พ || ุงุณุชููุงู CPU | 80% | **35%** | **56% ุฃูู** โ๏ธ || ุนูููุงุช ุงููุชุงุจุฉ | 500 ุนูููุฉ | **50 ุนูููุฉ** | **90% ุฃูู** ๐พ || ุงูุณุฑุนุฉ | 166 ุตู/ุซ | **1,666 ุตู/ุซ** | **10x ุฃุณุฑุน** โก || ุงูููุช ุงูููู | ~5 ุฏูุงุฆู | **~30 ุซุงููุฉ** | **10x ุฃุณุฑุน** ๐ ||---------|-----|-----|---------|| ุงููููุงุณ | ูุจู | ุจุนุฏ | ุงูุชุญุณูู |### ุณููุงุฑูู: ุฑูุน 50,000 ููุชุฌ## ๐ ููุงุฑูุฉ ุงูุฃุฏุงุก---- ุงุณุชุนูุงูุงุช ูุงุนุฏุฉ ุงูุจูุงูุงุช: ุฃูู ุจูุณุจุฉ **75%**- ุชุญููู Dashboard: ูู 1.5 ุซุงููุฉ ุฅูู **0.2 ุซุงููุฉ** โก**ุงููุชุงุฆุฌ:**```.only('id', 'name', 'created_at')# ุงุณุชุฎุฏุงู only() ูู ูู ููุงูstart_date = end_date - timedelta(days=2)  # ุจุฏูุงู ูู 6 ุฃูุงู# ูุชุฑุฉ ุฒูููุฉ ุฃูุตุฑcategory_stats = ...[:5]          # ุจุฏูุงู ูู [:10]recent_transactions = ...[:5]     # ุจุฏูุงู ูู [:10]low_stock_products = ...[:5]      # ุจุฏูุงู ูู [:10]# ูู 10 ุนูุงุตุฑ ุฅูู 5 (ุฃุณุฑุน ูุฑุชูู)```python#### ุงูุชุญุณููุงุช:### 4. ุชุญุณูู Dashboard---- ุงุณุชููุงู ุงูุฐุงูุฑุฉ: ุฃูู ุจูุณุจุฉ **65%** ๐พ- ููุช ุชุญููู ูุงุฆูุฉ ุงูููุชุฌุงุช: ูู 2-3 ุซุงููุฉ ุฅูู **0.3-0.5 ุซุงููุฉ** โก**ุงููุชุงุฆุฌ:**```categories = Category.objects.only('id', 'name')  # 70% ุฃูู ุจูุงูุงุช)  # โ ููุท ุงูุญููู ุงููุทููุจุฉ    'id', 'name', 'code', 'price', 'category', 'created_at'products = Product.objects.select_related('category').only(# ูุญุณูู - ุงุณุชุนูุงู ูุงุญุฏ```python#### ุจุนุฏ:```categories = Category.objects.all()   # ุชุญููู ูู ุงูุญููู)    current_stock_calc=Subquery(...)  # ๐ฑ N+1 queriesproducts = Product.objects.select_related('category').annotate(# ุซููู ุฌุฏุงู - ุงุณุชุนูุงูุงุช ูุชุนุฏุฏุฉ```python#### ูุจู:### 3. ุชุญุณูู ุตูุญุงุช ุงููุฎุฒูู---```โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ ๐ ุชู ุชุญุฏูุซู: 2,180       โโ โ ุชู ุฅูุดุงุคู: 5,420        โโ ๐ ุงูุชูุฏู: 75% โโโโโโโโโโ  โโ โฑ๏ธ ุงูููุช ุงููุชุจูู: 25 ุซุงููุฉ โโ โก ุงูุณุฑุนุฉ: 1,500 ุตู/ุซุงููุฉ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ```#### ุดุงุดุฉ ุงูุชูุฏู ุงููุญุณููุฉ:```๐ฏ ุฅุญุตุงุฆูุงุช ูุญุธูุฉ๐ ูุณุจุฉ ุงูุฅูุฌุงุฒ ุงูุฏูููุฉโฑ๏ธ ุงูููุช ุงููุชุจูู ุงููุชููุนโ ุงูุณุฑุนุฉ ุงูุญุงููุฉ (ุตู/ุซุงููุฉ)// ุนุฑุถ ูุนูููุงุช ุญูุฉ:setInterval(..., 300)// ุชุญุฏูุซ ูุงุฆู ุงูุณุฑุนุฉ - ูู 300ms```javascript#### ุงูููุฒุงุช ุงูุฌุฏูุฏุฉ:### 2. ูุธุงู ุงูุชุชุจุน ุงููุญุธู---- ูุนุงูุฌุฉ 100,000 ุตู: ูู ~10 ุฏูุงุฆู ุฅูู **~1 ุฏูููุฉ** ๐- ูุนุงูุฌุฉ 10,000 ุตู: ูู ~60 ุซุงููุฉ ุฅูู **~6 ุซูุงูู** โก**ุงููุชุงุฆุฌ:**```bulk_create(batch_size=500)  # ุฅุฏุฑุงุฌ ุฌูุงุนู ูุงุฆู ุงูุณุฑุนุฉุชุญุฏูุซ ูู 5%                  # 95% ุฃูู ุนูููุงุช ูุชุงุจุฉbatch_size = 1000             # โก 10x ุฃุณุฑุน!```python#### ุจุนุฏ ุงูุชุญุณูู:```ุชุญุฏูุซ ูู batch (ุจุทูุก)       # ุนูููุงุช ูุชุงุจุฉ ูุซูุฑุฉbatch_size = 100              # ูุนุงูุฌุฉ 100 ุตู ูู ุงููุฑุฉ```python#### ูุจู ุงูุชุญุณูู:### 1. ูุธุงู ุงูุฑูุน ุงูุฌูุงุนู (Bulk Upload)## ๐ฅ ุงูุชุญุณููุงุช ุงูุฑุฆูุณูุฉ---- ๐พ **ุงุณุชููุงู ููุงุฑุฏ ุฃูู** ุจูุณุจุฉ 70%- ๐ฏ **ุตูุญุงุช ุฃุณุฑุน 5-10x** ูู ููุงุฆู ุงููุฎุฒูู- ๐ **ุชุชุจุน ูุญุธู real-time** ูุน ุชุญุฏูุซ ูู 300ms- โก **ุณุฑุนุฉ ุฑูุน ุฃุณุฑุน 10-100 ุถุนู**ุชู ุชุญุณูู ูุธุงู ุงููุฎุฒูู ูุงูุฑูุน ุงูุฌูุงุนู ุจุดูู ุดุงูู ูุชุญููู:## ๐ ููุฎุต ุงูุชุญุณููุงุช
{% block inventory_title %}ุชูุฑูุฑ ุนูููุฉ {{ upload_log.get_upload_type_display }}{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{% url 'inventory:dashboard' %}">ููุญุฉ ุงูุชุญูู</a></li>
<li class="breadcrumb-item"><a href="{% url 'inventory:bulk_upload_log_list' %}">ุณุฌูุงุช ุงูุฑูุน ุงูุฌูุงุนู</a></li>
<li class="breadcrumb-item active" aria-current="page">ุชูุฑูุฑ #{{ upload_log.id }}</li>
{% endblock %}

{% block quick_actions %}
<a href="{% url 'inventory:bulk_upload_log_list' %}" class="btn btn-secondary btn-sm">
    <i class="fas fa-list"></i> ูู ุงูุณุฌูุงุช
</a>
<a href="javascript:window.print()" class="btn btn-info btn-sm">
    <i class="fas fa-print"></i> ุทุจุงุนุฉ
</a>
{% endblock %}

{% block inventory_content %}
<div class="row">
    <!-- ูุนูููุงุช ุงูุนูููุฉ -->
    <div class="col-md-8">
        <div class="card">
            <div class="card-header {% if upload_log.status == 'completed' %}bg-success{% elif upload_log.status == 'completed_with_errors' %}bg-warning{% elif upload_log.status == 'failed' %}bg-danger{% else %}bg-info{% endif %} text-white">
                <h5 class="mb-0">
                    <i class="fas fa-file-upload"></i>
                    ูุนูููุงุช ุนูููุฉ {{ upload_log.get_upload_type_display }}
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-sm">
                            <tr>
                                <th width="40%">ุงุณู ุงูููู:</th>
                                <td><strong>{{ upload_log.file_name }}</strong></td>
                            </tr>
                            <tr>
                                <th>ุงูุญุงูุฉ:</th>
                                <td>
                                    {% if upload_log.status == 'completed' %}
                                        <span class="badge bg-success">{{ upload_log.get_status_display }}</span>
                                    {% elif upload_log.status == 'completed_with_errors' %}
                                        <span class="badge bg-warning">{{ upload_log.get_status_display }}</span>
                                    {% elif upload_log.status == 'failed' %}
                                        <span class="badge bg-danger">{{ upload_log.get_status_display }}</span>
                                    {% else %}
                                        <span class="badge bg-info">{{ upload_log.get_status_display }}</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>ุงููุณุชูุฏุน:</th>
                                <td>{{ upload_log.warehouse|default:"ุบูุฑ ูุญุฏุฏ" }}</td>
                            </tr>
                            <tr>
                                <th>ุชู ุจูุงุณุทุฉ:</th>
                                <td>{{ upload_log.created_by.get_full_name|default:upload_log.created_by.username }}</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <table class="table table-sm">
                            <tr>
                                <th width="40%">ุชุงุฑูุฎ ุงูุจุฏุก:</th>
                                <td>{{ upload_log.created_at|date:"Y-m-d H:i:s" }}</td>
                            </tr>
                            <tr>
                                <th>ุชุงุฑูุฎ ุงูุฅููุงู:</th>
                                <td>{{ upload_log.completed_at|date:"Y-m-d H:i:s"|default:"ุฌุงุฑู ุงููุนุงูุฌุฉ..." }}</td>
                            </tr>
                            <tr>
                                <th>ุงููุฏุฉ:</th>
                                <td>
                                    {% if upload_log.duration %}
                                        {{ upload_log.duration|floatformat:2 }} ุซุงููุฉ
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>ูุณุจุฉ ุงููุฌุงุญ:</th>
                                <td>
                                    <div class="progress" style="height: 25px;">
                                        <div class="progress-bar {% if upload_log.success_rate >= 80 %}bg-success{% elif upload_log.success_rate >= 50 %}bg-warning{% else %}bg-danger{% endif %}" 
                                             role="progressbar" 
                                             style="width: {{ upload_log.success_rate }}%"
                                             aria-valuenow="{{ upload_log.success_rate }}" 
                                             aria-valuemin="0" 
                                             aria-valuemax="100">
                                            {{ upload_log.success_rate }}%
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
                
                {% if upload_log.summary %}
                <div class="alert alert-info mt-3 mb-0">
                    <strong><i class="fas fa-info-circle"></i> ููุฎุต ุงูุนูููุฉ:</strong><br>
                    {{ upload_log.summary }}
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- ุงูุฅุญุตุงุฆูุงุช -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h6 class="mb-0">
                    <i class="fas fa-chart-pie"></i>
                    ุงูุฅุญุตุงุฆูุงุช
                </h6>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6 mb-3">
                        <div class="p-3 bg-light rounded">
                            <h2 class="mb-0 text-primary">{{ upload_log.total_rows }}</h2>
                            <small class="text-muted">ุฅุฌูุงูู ุงูุตููู</small>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="p-3 bg-light rounded">
                            <h2 class="mb-0 text-success" id="processedCount">{{ upload_log.processed_count }}</h2>
                            <small class="text-muted">ุชู ูุนุงูุฌุชู</small>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="p-3 bg-light rounded">
                            <h2 class="mb-0 text-info" id="createdCount">{{ upload_log.created_count }}</h2>
                            <small class="text-muted">ุชู ุฅูุดุงุคู</small>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="p-3 bg-light rounded">
                            <h2 class="mb-0 text-warning" id="updatedCount">{{ upload_log.updated_count }}</h2>
                            <small class="text-muted">ุชู ุชุญุฏูุซู</small>
                        </div>
                    </div>
                    {% if upload_log.skipped_count > 0 %}
                    <div class="col-6 mb-3">
                        <div class="p-3 bg-light rounded">
                            <h2 class="mb-0 text-secondary" id="skippedCount">{{ upload_log.skipped_count }}</h2>
                            <small class="text-muted">ุชู ุชุฎุทูู</small>
                        </div>
                    </div>
                    {% endif %}
                    <!-- ูุนูููุงุช ุงูุณุฑุนุฉ ูุงูููุช ุงููุชุจูู -->
                    <div class="col-6 mb-3">
                        <div class="p-3 bg-info text-white rounded">
                            <h2 class="mb-0" id="uploadSpeed">โก -</h2>
                            <small>ุงูุณุฑุนุฉ (ุตู/ุซุงููุฉ)</small>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="p-3 bg-primary text-white rounded">
                            <h2 class="mb-0" id="etaTime">โฑ๏ธ -</h2>
                            <small>ุงูููุช ุงููุชุจูู</small>
                        </div>
                    </div>
                </div>
                {% if actual_errors_count > 0 %}
                <div class="alert alert-danger text-center mb-0">
                    <h3 class="mb-0">{{ actual_errors_count }}</h3>
                    <small>ุนุฏุฏ ุงูุฃุฎุทุงุก ุงููุนููุฉ</small>
                </div>
                {% else %}
                <div class="alert alert-success text-center mb-0">
                    <i class="fas fa-check-circle fa-2x"></i><br>
                    <small>ูุง ุชูุฌุฏ ุฃุฎุทุงุก</small>
                </div>
                {% endif %}
            </div>
        </div>

        {% if upload_log.created_warehouses %}
        <div class="card mt-3">
            <div class="card-header bg-success text-white">
                <h6 class="mb-0">
                    <i class="fas fa-warehouse"></i>
                    ุงููุณุชูุฏุนุงุช ุงููููุดุฃุฉ
                </h6>
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0">
                    {% for warehouse in upload_log.created_warehouses %}
                    <li><i class="fas fa-check text-success"></i> {{ warehouse }}</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- ูุงุฆูุฉ ุงููุชุงุฆุฌ (ุฃุฎุทุงุก + ูุชุฎุทุงุฉ) -->
{% if upload_log.errors.count > 0 %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header {% if actual_errors_count > 0 %}bg-danger{% else %}bg-info{% endif %} text-white">
                <h5 class="mb-0">
                    <i class="fas fa-list"></i>
                    ุชูุงุตูู ุงููุนุงูุฌุฉ 
                    ({{ actual_errors_count }} ุฎุทุฃุ {{ upload_log.skipped_count }} ูุชุฎุทู)
                </h5>
            </div>
            <div class="card-body">
                <!-- ููุงุชุฑ -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label"><strong>ููุชุฑุฉ ุญุณุจ ุงูุญุงูุฉ:</strong></label>
                        <div class="btn-group d-flex" role="group">
                            <a href="?" class="btn btn-sm {% if not result_status %}btn-primary{% else %}btn-outline-primary{% endif %}">
                                ุงููู
                            </a>
                            <a href="?result_status=failed" class="btn btn-sm {% if result_status == 'failed' %}btn-danger{% else %}btn-outline-danger{% endif %}">
                                ูุดู ({{ failed_count }})
                            </a>
                            <a href="?result_status=skipped" class="btn btn-sm {% if result_status == 'skipped' %}btn-secondary{% else %}btn-outline-secondary{% endif %}">
                                ูุชุฎุทู ({{ skipped_count }})
                            </a>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label"><strong>ุฅุญุตุงุฆูุงุช:</strong></label>
                        <div class="d-flex flex-wrap gap-2">
                            {% for status_type, count in status_stats.items %}
                            <span class="badge {% if status_type == 'ูุดู' %}bg-danger{% elif status_type == 'ุชู ุงูุชุฎุทู' %}bg-secondary{% else %}bg-info{% endif %}">
                                {{ status_type }}: {{ count }}
                            </span>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- ุฌุฏูู ุงููุชุงุฆุฌ -->
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th width="7%">ุฑูู ุงูุตู</th>
                                <th width="10%">ุงูุญุงูุฉ</th>
                                <th width="13%">ููุน</th>
                                <th width="25%">ุงุณู ุงูููุชุฌ</th>
                                <th width="10%">ุงูููุฏ</th>
                                <th>ุงููุตู</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for result in results_page %}
                            <tr class="{% if result.result_status == 'failed' %}table-danger{% elif result.result_status == 'skipped' %}table-secondary{% endif %}">
                                <td><span class="badge bg-dark">{{ result.row_number }}</span></td>
                                <td>
                                    <span class="badge 
                                        {% if result.result_status == 'failed' %}bg-danger
                                        {% elif result.result_status == 'skipped' %}bg-secondary
                                        {% elif result.result_status == 'updated' %}bg-warning
                                        {% elif result.result_status == 'created' %}bg-success
                                        {% else %}bg-info
                                        {% endif %}">
                                        {% if result.result_status == 'failed' %}
                                            <i class="fas fa-times"></i> ูุดู
                                        {% elif result.result_status == 'skipped' %}
                                            <i class="fas fa-forward"></i> ุชุฎุทู
                                        {% elif result.result_status == 'updated' %}
                                            <i class="fas fa-edit"></i> ุชุญุฏูุซ
                                        {% elif result.result_status == 'created' %}
                                            <i class="fas fa-plus"></i> ุฌุฏูุฏ
                                        {% else %}
                                            {{ result.get_result_status_display }}
                                        {% endif %}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge 
                                        {% if result.error_type == 'missing_data' %}bg-warning
                                        {% elif result.error_type == 'duplicate' %}bg-info
                                        {% elif result.error_type == 'invalid_data' %}bg-danger
                                        {% elif result.error_type == 'database' %}bg-dark
                                        {% else %}bg-secondary
                                        {% endif %}">
                                        {{ result.get_error_type_display }}
                                    </span>
                                </td>
                                <td><strong>{{ result.product_name }}</strong></td>
                                <td>
                                    {% if result.product_code %}
                                        <code>{{ result.product_code }}</code>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if result.result_status == 'failed' %}
                                        <span class="text-danger">{{ result.error_message }}</span>
                                    {% else %}
                                        <span class="text-muted">{{ result.error_message }}</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="text-center text-muted">ูุง ุชูุฌุฏ ูุชุงุฆุฌ</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- ุงูุตูุญุงุช -->
                {% if results_page.has_other_pages %}
                <nav aria-label="Page navigation">
                    <ul class="pagination justify-content-center">
                        {% if results_page.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ results_page.previous_page_number }}{% if result_status %}&result_status={{ result_status }}{% endif %}{% if error_type %}&error_type={{ error_type }}{% endif %}">ุงูุณุงุจู</a>
                        </li>
                        {% endif %}

                        {% for num in results_page.paginator.page_range %}
                            {% if results_page.number == num %}
                            <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                            {% elif num > results_page.number|add:'-3' and num < results_page.number|add:'3' %}
                            <li class="page-item"><a class="page-link" href="?page={{ num }}{% if result_status %}&result_status={{ result_status }}{% endif %}{% if error_type %}&error_type={{ error_type }}{% endif %}">{{ num }}</a></li>
                            {% endif %}
                        {% endfor %}

                        {% if results_page.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ results_page.next_page_number }}{% if result_status %}&result_status={{ result_status }}{% endif %}{% if error_type %}&error_type={{ error_type }}{% endif %}">ุงูุชุงูู</a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- ุฎูุงุฑุงุช ุฅุถุงููุฉ -->
<div class="row mt-3">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        {% if upload_log.upload_type == 'products' %}
                        <a href="{% url 'inventory:product_bulk_upload' %}" class="btn btn-primary">
                            <i class="fas fa-upload"></i> ุฑูุน ููุชุฌุงุช ุฌุฏูุฏุฉ
                        </a>
                        {% else %}
                        <a href="{% url 'inventory:bulk_stock_update' %}" class="btn btn-primary">
                            <i class="fas fa-sync-alt"></i> ุชุญุฏูุซ ูุฎุฒูู ุฌุฏูุฏ
                        </a>
                        {% endif %}
                        <a href="{% url 'inventory:product_list' %}" class="btn btn-secondary">
                            <i class="fas fa-list"></i> ูุงุฆูุฉ ุงูููุชุฌุงุช
                        </a>
                    </div>
                    <div class="text-muted">
                        <small>ุฑูู ุงูุชูุฑูุฑ: #{{ upload_log.id }}</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    @media print {
        .btn, .breadcrumb, .card-header .btn {
            display: none !important;
        }
    }
    
    .progress-container {
        position: relative;
    }
    
    .progress-text {
        position: absolute;
        width: 100%;
        text-align: center;
        top: 50%;
        transform: translateY(-50%);
        font-weight: bold;
        color: #000;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const uploadLogId = {{ upload_log.id }};
    const status = '{{ upload_log.status }}';
    
    // ุชุชุจุน ููุฑู ููุนูููุงุช ููุฏ ุงููุนุงูุฌุฉ
    if (status === 'processing') {
        // ุฅุถุงูุฉ ุดุฑูุท ุชูุฏู ููุฑู
        const progressHtml = `
            <div id="liveProgress" class="alert alert-info">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0">
                        <i class="fas fa-sync fa-spin"></i> ุฌุงุฑู ุงููุนุงูุฌุฉ...
                    </h6>
                    <span id="percentText" class="badge bg-primary fs-6">0%</span>
                </div>
                <div class="progress" style="height: 25px;">
                    <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                         style="width: 0%"></div>
                </div>
                <div class="mt-2 small text-muted">
                    <span id="processedCount">0</span> ูู <span id="totalRows">0</span> ุตู
                    <span class="mx-2">|</span>
                    <span class="text-success">โ <span id="createdCount">0</span> ุฌุฏูุฏ</span>
                    <span class="mx-1">โข</span>
                    <span class="text-info">๐ <span id="updatedCount">0</span> ูุญุฏุซ</span>
                    <span class="mx-1">โข</span>
                    <span class="text-warning">โญ๏ธ <span id="skippedCount">0</span> ูุชุฎุทู</span>
                </div>
            </div>
        `;
        
        // ุฅุฏุฑุงุฌ ูู ุจุฏุงูุฉ ุงููุญุชูู
        const container = document.querySelector('.card-body');
        if (container) {
            container.insertAdjacentHTML('afterbegin', progressHtml);
        }
        
        // ุชุญุฏูุซ ุชููุงุฆู ูุงุฆู ุงูุณุฑุนุฉ - ูู 300ms!
        let lastUpdate = Date.now();
        const interval = setInterval(function() {
            fetch(`/inventory/api/bulk-upload/${uploadLogId}/status/`)
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        updateProgress(data);
                        
                        if (data.is_completed) {
                            clearInterval(interval);
                            // ุฅุถุงูุฉ ุชุฃุซูุฑ ูุฌุงุญ
                            Swal.fire({
                                icon: 'success',
                                title: 'ุงูุชูู ุงูุฑูุน!',
                                text: `ุชู ูุนุงูุฌุฉ ${data.processed_count} ุตู ุจูุฌุงุญ`,
                                timer: 2000
                            }).then(() => location.reload());
                        }
                    }
                })
                .catch(err => console.error('ุฎุทุฃ:', err));
        }, 300);  // ูู 300ms ูุชุญุฏูุซ ูุญุธู!
        
        function updateProgress(data) {
            const now = Date.now();
            const timeDiff = (now - lastUpdate) / 1000;
            lastUpdate = now;
            
            // ุชุญุฏูุซ ุดุฑูุท ุงูุชูุฏู - ุฃุฑูุงู ุฅูุฌููุฒูุฉ
            document.getElementById('progressBar').style.width = data.percent + '%';
            document.getElementById('percentText').textContent = data.percent + '%';
            document.getElementById('processedCount').textContent = data.processed_count.toLocaleString('en-US');
            document.getElementById('totalRows').textContent = data.total_rows.toLocaleString('en-US');
            document.getElementById('createdCount').textContent = data.created_count.toLocaleString('en-US');
            document.getElementById('updatedCount').textContent = data.updated_count.toLocaleString('en-US');
            
            const skippedEl = document.getElementById('skippedCount');
            if (skippedEl) {
                skippedEl.textContent = data.skipped_count.toLocaleString('en-US');
            }
            
            // ุนุฑุถ ุงูุณุฑุนุฉ - ุฃุฑูุงู ุฅูุฌููุฒูุฉ
            const speedEl = document.getElementById('uploadSpeed');
            if (speedEl && data.speed) {
                speedEl.innerHTML = `โก ${data.speed.toLocaleString('en-US')}`;
            }
            
            // ุนุฑุถ ุงูููุช ุงููุชุจูู - ุฃุฑูุงู ุฅูุฌููุฒูุฉ
            const etaEl = document.getElementById('etaTime');
            if (etaEl && data.eta_seconds) {
                const minutes = Math.floor(data.eta_seconds / 60);
                const seconds = data.eta_seconds % 60;
                
                if (minutes > 0) {
                    etaEl.innerHTML = `โฑ๏ธ ${minutes}ุฏ ${seconds}ุซ`;
                } else {
                    etaEl.innerHTML = `โฑ๏ธ ${seconds}ุซ`;
                }
            } else if (etaEl && data.percent >= 100) {
                etaEl.innerHTML = 'โ ุงูุชูู';
            }
        }
    }
});
</script>
{% endblock %}
