<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>اختبار إرسال النموذج</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug { background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .error { background: #ffebee; color: #c62828; }
        .success { background: #e8f5e8; color: #2e7d32; }
        .info { background: #e3f2fd; color: #1565c0; }
        button { padding: 10px 20px; margin: 5px; }
        input[type="file"] { margin: 10px 0; }
        select { margin: 10px 0; padding: 5px; }
    </style>
</head>
<body>
    <h1>🔍 اختبار إرسال النموذج</h1>
    
    <div class="debug info">
        <h3>معلومات التشخيص:</h3>
        <div id="diagnostics"></div>
    </div>
    
    <form id="testForm" action="/odoo-db-manager/backups/upload/" method="post" enctype="multipart/form-data">
        <h3>نموذج الاختبار:</h3>
        
        <div>
            <label>ملف النسخة الاحتياطية:</label><br>
            <input type="file" id="backup_file" name="backup_file" accept=".json,.gz" required>
        </div>
        
        <div>
            <label>قاعدة البيانات:</label><br>
            <select id="database_id" name="database_id" required>
                <option value="">اختر قاعدة البيانات</option>
                <option value="1">قاعدة بيانات 1</option>
                <option value="2">قاعدة بيانات 2</option>
                <option value="3">قاعدة بيانات 3</option>
            </select>
        </div>
        
        <div>
            <input type="hidden" name="csrfmiddlewaretoken" value="test-token">
            <input type="hidden" name="backup_type" value="full">
            <input type="hidden" name="clear_data" value="off">
            <input type="hidden" name="session_id" id="session_id" value="">
        </div>
        
        <div>
            <button type="submit" id="submitBtn">إرسال النموذج</button>
            <button type="button" id="testBtn">اختبار JavaScript</button>
            <button type="button" id="clearBtn">مسح السجل</button>
        </div>
    </form>
    
    <div class="debug">
        <h3>سجل الأحداث:</h3>
        <div id="eventLog"></div>
    </div>

    <script>
        // دالة لإضافة رسالة إلى السجل
        function log(message, type = 'info') {
            const eventLog = document.getElementById('eventLog');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            
            const logEntry = document.createElement('div');
            logEntry.className = `debug ${className}`;
            logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            
            eventLog.appendChild(logEntry);
            eventLog.scrollTop = eventLog.scrollHeight;
            
            // طباعة في console أيضاً
            console.log(`[${timestamp}] ${message}`);
        }

        // دالة لتحديث معلومات التشخيص
        function updateDiagnostics() {
            const diagnostics = document.getElementById('diagnostics');
            
            const info = [
                `URL: ${window.location.href}`,
                `User Agent: ${navigator.userAgent}`,
                `Document Ready State: ${document.readyState}`,
                `Form Element: ${document.getElementById('testForm') ? 'موجود' : 'غير موجود'}`,
                `Submit Button: ${document.getElementById('submitBtn') ? 'موجود' : 'غير موجود'}`,
                `File Input: ${document.getElementById('backup_file') ? 'موجود' : 'غير موجود'}`,
                `Database Select: ${document.getElementById('database_id') ? 'موجود' : 'غير موجود'}`,
                `Fetch API: ${typeof fetch !== 'undefined' ? 'متوفر' : 'غير متوفر'}`,
                `XMLHttpRequest: ${typeof XMLHttpRequest !== 'undefined' ? 'متوفر' : 'غير متوفر'}`
            ];
            
            diagnostics.innerHTML = info.map(item => `<div>• ${item}</div>`).join('');
        }

        // تحديث التشخيص عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', function() {
            log('🚀 تم تحميل الصفحة', 'success');
            updateDiagnostics();
            
            // إضافة معرف جلسة
            const sessionId = 'test_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            document.getElementById('session_id').value = sessionId;
            log(`📋 تم إنشاء معرف الجلسة: ${sessionId}`, 'info');
        });

        // معالج إرسال النموذج
        document.getElementById('testForm').addEventListener('submit', function(e) {
            e.preventDefault();
            log('📤 تم إرسال النموذج', 'info');
            
            // التحقق من البيانات
            const fileInput = document.getElementById('backup_file');
            const databaseSelect = document.getElementById('database_id');
            
            if (!fileInput.files || fileInput.files.length === 0) {
                log('❌ لم يتم اختيار ملف', 'error');
                return;
            }
            
            if (!databaseSelect.value) {
                log('❌ لم يتم اختيار قاعدة البيانات', 'error');
                return;
            }
            
            log(`✅ تم اختيار الملف: ${fileInput.files[0].name} (${fileInput.files[0].size} بايت)`, 'success');
            log(`✅ تم اختيار قاعدة البيانات: ${databaseSelect.value}`, 'success');
            
            // إرسال النموذج باستخدام fetch
            const formData = new FormData(this);
            
            log('🔄 إرسال البيانات إلى الخادم...', 'info');
            
            fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                log(`📨 تم استلام الرد: ${response.status}`, response.ok ? 'success' : 'error');
                return response.text();
            })
            .then(data => {
                log(`📄 محتوى الرد: ${data.substring(0, 200)}...`, 'info');
                
                try {
                    const jsonData = JSON.parse(data);
                    log(`✅ JSON صالح: ${JSON.stringify(jsonData)}`, 'success');
                } catch (e) {
                    log(`⚠️ الرد ليس JSON: ${e.message}`, 'error');
                }
            })
            .catch(error => {
                log(`❌ خطأ في الإرسال: ${error.message}`, 'error');
            });
        });

        // زر الاختبار
        document.getElementById('testBtn').addEventListener('click', function() {
            log('🧪 اختبار JavaScript', 'info');
            
            // اختبار العناصر
            const elements = [
                'testForm',
                'backup_file',
                'database_id',
                'submitBtn',
                'session_id'
            ];
            
            elements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    log(`✅ العنصر ${id} موجود`, 'success');
                } else {
                    log(`❌ العنصر ${id} غير موجود`, 'error');
                }
            });
            
            // اختبار الدوال
            if (typeof fetch !== 'undefined') {
                log('✅ fetch API متوفر', 'success');
            } else {
                log('❌ fetch API غير متوفر', 'error');
            }
            
            updateDiagnostics();
        });

        // زر مسح السجل
        document.getElementById('clearBtn').addEventListener('click', function() {
            document.getElementById('eventLog').innerHTML = '';
            log('🗑️ تم مسح السجل', 'info');
        });

        // تسجيل الأخطاء
        window.addEventListener('error', function(e) {
            log(`❌ خطأ JavaScript: ${e.message} في ${e.filename}:${e.lineno}`, 'error');
        });

        // تسجيل الأخطاء غير المعالجة
        window.addEventListener('unhandledrejection', function(e) {
            log(`❌ Promise غير معالج: ${e.reason}`, 'error');
        });
    </script>
</body>
</html> 