{% extends 'base.html' %}
{% load static %}
{% block title %}تقارير الشكاوى المتقدمة{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/complaints-module.css' %}?v={% now 'U' %}">
{% endblock %}

{% block content %}
<div class="container-fluid cm-page">

    <div class="cm-page-header mb-4" style="background:linear-gradient(135deg,#28a745 0%,#20c997 100%)">
        <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
            <div>
                <h2 class="mb-1"><i class="fas fa-chart-line me-2"></i>تقارير الشكاوى المتقدمة</h2>
                <p class="mb-0" style="opacity:.85">تحليل شامل لأداء نظام الشكاوى</p>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-light btn-sm" onclick="location.reload()"><i class="fas fa-sync-alt me-1"></i>تحديث</button>
                <button class="btn btn-outline-light btn-sm" onclick="window.print()"><i class="fas fa-print me-1"></i>طباعة</button>
            </div>
        </div>
    </div>

    {# Key Metrics #}
    <div class="row g-3 mb-4">
        <div class="col-6 col-md-3"><div class="cm-stat"><div class="cm-stat-icon" style="background:var(--cm-primary)"><i class="fas fa-clipboard-list"></i></div><div class="cm-stat-value">{{ total_complaints }}</div><div class="cm-stat-label">إجمالي</div></div></div>
        <div class="col-6 col-md-3"><div class="cm-stat"><div class="cm-stat-icon" style="background:var(--cm-green)"><i class="fas fa-check-circle"></i></div><div class="cm-stat-value">{{ resolved_complaints }}</div><div class="cm-stat-label">محلولة</div></div></div>
        <div class="col-6 col-md-3"><div class="cm-stat"><div class="cm-stat-icon" style="background:var(--cm-amber)"><i class="fas fa-clock"></i></div><div class="cm-stat-value">{{ pending_complaints }}</div><div class="cm-stat-label">معلقة</div></div></div>
        <div class="col-6 col-md-3"><div class="cm-stat"><div class="cm-stat-icon" style="background:var(--cm-red)"><i class="fas fa-exclamation-triangle"></i></div><div class="cm-stat-value">{{ priority_stats.urgent }}</div><div class="cm-stat-label">عاجلة</div></div></div>
    </div>

    {# Time metrics #}
    <div class="row g-3 mb-4">
        <div class="col-md-4"><div class="cm-stat"><div class="cm-stat-value text-info">{{ this_week }}</div><div class="cm-stat-label">هذا الأسبوع</div></div></div>
        <div class="col-md-4"><div class="cm-stat"><div class="cm-stat-value text-info">{{ this_month }}</div><div class="cm-stat-label">هذا الشهر</div></div></div>
        <div class="col-md-4"><div class="cm-stat"><div class="cm-stat-value text-info">{{ avg_resolution_time }}</div><div class="cm-stat-label">متوسط وقت الحل (ساعة)</div></div></div>
    </div>

    {# Export #}
    <div class="cm-card mb-4">
        <div class="cm-card-header"><h6><i class="fas fa-download me-2"></i>تصدير التقارير</h6></div>
        <div class="cm-card-body">
            <div class="btn-group btn-group-sm" role="group">
                <button class="btn btn-outline-success" onclick="location.href='{% url "complaints:reports" %}?export=excel'"><i class="fas fa-file-excel me-1"></i>Excel</button>
                <button class="btn btn-outline-danger" onclick="location.href='{% url "complaints:reports" %}?export=pdf'"><i class="fas fa-file-pdf me-1"></i>PDF</button>
                <button class="btn btn-outline-info" onclick="location.href='{% url "complaints:reports" %}?export=csv'"><i class="fas fa-file-csv me-1"></i>CSV</button>
            </div>
        </div>
    </div>

    {# Charts #}
    <div class="row g-3 mb-4">
        <div class="col-md-6">
            <div class="cm-card"><div class="cm-card-header"><h6><i class="fas fa-chart-pie me-2"></i>حسب الحالة</h6></div>
                <div class="cm-card-body cm-chart-wrap"><canvas id="statusChart"></canvas></div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="cm-card"><div class="cm-card-header"><h6><i class="fas fa-chart-pie me-2"></i>حسب الأولوية</h6></div>
                <div class="cm-card-body cm-chart-wrap"><canvas id="priorityChart"></canvas></div>
            </div>
        </div>
    </div>
    <div class="row g-3 mb-4">
        <div class="col-md-8">
            <div class="cm-card"><div class="cm-card-header"><h6><i class="fas fa-chart-bar me-2"></i>حسب النوع</h6></div>
                <div class="cm-card-body cm-chart-wrap"><canvas id="typesChart"></canvas></div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="cm-card"><div class="cm-card-header"><h6><i class="fas fa-trophy me-2 text-warning"></i>أفضل الموظفين</h6></div>
                <div class="cm-card-body p-0 px-3">
                    {% for r in top_resolvers %}
                    <div class="cm-leaderboard-item"><div class="d-flex align-items-center gap-2"><span class="badge rounded-pill bg-primary" style="width:26px;height:26px;display:flex;align-items:center;justify-content:center">{{ forloop.counter }}</span><span class="fw-semibold">{{ r.get_full_name|default:r.username }}</span></div><span class="cm-badge cm-badge-resolved">{{ r.resolved_count }}</span></div>
                    {% empty %}<div class="cm-empty py-3"><p>لا توجد بيانات</p></div>{% endfor %}
                </div>
            </div>
        </div>
    </div>

    {# Filter #}
    <div class="cm-filter mb-4">
        <div class="cm-filter-header" data-bs-toggle="collapse" data-bs-target="#reportFilters"><h6><i class="fas fa-filter me-2"></i>فلاتر التقارير</h6><i class="fas fa-chevron-down"></i></div>
        <div class="collapse" id="reportFilters">
            <div class="cm-filter-body">
                <form method="get" class="row g-2" id="reportsFilterForm">
                    <div class="col-md-3"><label class="form-label">الفترة</label><select name="period" class="form-select form-select-sm"><option value="all">الكل</option><option value="today">اليوم</option><option value="week">الأسبوع</option><option value="month">الشهر</option><option value="quarter">الربع</option><option value="year">السنة</option></select></div>
                    <div class="col-md-3"><label class="form-label">نوع التقرير</label><select name="report_type" class="form-select form-select-sm"><option value="summary">موجز</option><option value="detailed">مفصل</option><option value="performance">أداء</option></select></div>
                    <div class="col-md-3"><label class="form-label">تجميع</label><select name="group_by" class="form-select form-select-sm"><option value="status">الحالة</option><option value="priority">الأولوية</option><option value="type">النوع</option><option value="department">القسم</option></select></div>
                    <div class="col-md-3 d-flex align-items-end"><button type="submit" class="btn btn-primary btn-sm w-100"><i class="fas fa-chart-line me-1"></i>إنشاء</button></div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.js"></script>
<script>
Chart.defaults.font.family='Cairo, sans-serif';Chart.defaults.plugins.legend.rtl=true;
new Chart(document.getElementById('statusChart'),{type:'doughnut',data:{labels:['جديدة','قيد الحل','محلولة','مغلقة','مصعدة','متأخرة'],datasets:[{data:[{{ status_stats.new }},{{ status_stats.in_progress }},{{ status_stats.resolved }},{{ status_stats.closed }},{{ status_stats.escalated }},{{ status_stats.overdue }}],backgroundColor:['#4361ee','#f59e0b','#10b981','#6c757d','#7c3aed','#ef4444'],borderWidth:2,borderColor:'#fff'}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{padding:15,usePointStyle:true}}}}});
new Chart(document.getElementById('priorityChart'),{type:'pie',data:{labels:['عاجلة','عالية','متوسطة','منخفضة'],datasets:[{data:[{{ priority_stats.urgent }},{{ priority_stats.high }},{{ priority_stats.medium }},{{ priority_stats.low }}],backgroundColor:['#ef4444','#f97316','#f59e0b','#10b981'],borderWidth:2,borderColor:'#fff'}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{padding:15,usePointStyle:true}}}}});
new Chart(document.getElementById('typesChart'),{type:'bar',data:{labels:[{% for t in type_stats %}'{{ t.name|escapejs }}'{% if not forloop.last %},{% endif %}{% endfor %}],datasets:[{label:'عدد الشكاوى',data:[{% for t in type_stats %}{{ t.complaint_count }}{% if not forloop.last %},{% endif %}{% endfor %}],backgroundColor:'rgba(67,97,238,0.8)',borderRadius:6}]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true,ticks:{stepSize:1}}},plugins:{legend:{display:false}}}});
</script>
{% endblock %}
