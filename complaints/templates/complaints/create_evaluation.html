{% extends 'base.html' %}
{% load static %}
{% block title %}تقييم الشكوى {{ complaint.complaint_number }}{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/complaints-module.css' %}?v={% now 'U' %}">
<style>
.star-group{display:flex;gap:4px;direction:ltr}
.star-group input{display:none}
.star-group label{font-size:2rem;color:#ddd;cursor:pointer;transition:color .2s}
.star-group label:hover,.star-group label:hover~label,.star-group input:checked~label{color:#f59e0b}
</style>
{% endblock %}

{% block content %}
<div class="container cm-page" style="max-width:800px;margin-top:2rem">

    <div class="cm-page-header mb-4" style="background:linear-gradient(135deg,#f59e0b 0%,#f97316 100%)">
        <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
            <div>
                <h2 class="mb-1"><i class="fas fa-star me-2"></i>تقييم الشكوى</h2>
                <p class="mb-0" style="opacity:.85">نرجو تقييم تجربتك في حل الشكوى</p>
            </div>
            <a href="{% url 'complaints:complaint_detail' complaint.pk %}" class="btn btn-light btn-sm"><i class="fas fa-arrow-right me-1"></i>العودة</a>
        </div>
        <div class="mt-3 p-3 rounded-3" style="background:rgba(255,255,255,.15)">
            <h6 class="mb-1">{{ complaint.complaint_number }}</h6>
            <p class="mb-0" style="font-size:.9rem">{{ complaint.title }}</p>
            {% if complaint.resolved_at %}<small style="opacity:.8">تم الحل: {{ complaint.resolved_at|date:"Y-m-d H:i" }}</small>{% endif %}
        </div>
    </div>

    <form method="post" id="evaluationForm">
        {% csrf_token %}

        {# Rating sections #}
        {% with ratings="overall_rating:التقييم العام:fas fa-star:text-warning,response_time_rating:سرعة الاستجابة:fas fa-clock:text-info,solution_quality_rating:جودة الحل:fas fa-check-circle:text-success,staff_behavior_rating:تعامل الموظفين:fas fa-users:text-primary" %}
        {% for item in ratings|make_list %}{% endfor %}
        {% endwith %}

        <div class="cm-card mb-3">
            <div class="cm-card-body">
                <label class="fw-semibold mb-2"><i class="fas fa-star me-2 text-warning"></i>التقييم العام</label>
                <div class="star-group" data-rating="overall_rating">
                    <input type="radio" name="overall_rating" value="5" id="o5"><label for="o5">&#9733;</label>
                    <input type="radio" name="overall_rating" value="4" id="o4"><label for="o4">&#9733;</label>
                    <input type="radio" name="overall_rating" value="3" id="o3"><label for="o3">&#9733;</label>
                    <input type="radio" name="overall_rating" value="2" id="o2"><label for="o2">&#9733;</label>
                    <input type="radio" name="overall_rating" value="1" id="o1"><label for="o1">&#9733;</label>
                </div>
                <small class="text-muted">من 1 (غير راضي) إلى 5 (راضي جداً)</small>
            </div>
        </div>

        <div class="cm-card mb-3">
            <div class="cm-card-body">
                <label class="fw-semibold mb-2"><i class="fas fa-clock me-2 text-info"></i>سرعة الاستجابة</label>
                <div class="star-group" data-rating="response_time_rating">
                    <input type="radio" name="response_time_rating" value="5" id="r5"><label for="r5">&#9733;</label>
                    <input type="radio" name="response_time_rating" value="4" id="r4"><label for="r4">&#9733;</label>
                    <input type="radio" name="response_time_rating" value="3" id="r3"><label for="r3">&#9733;</label>
                    <input type="radio" name="response_time_rating" value="2" id="r2"><label for="r2">&#9733;</label>
                    <input type="radio" name="response_time_rating" value="1" id="r1"><label for="r1">&#9733;</label>
                </div>
            </div>
        </div>

        <div class="cm-card mb-3">
            <div class="cm-card-body">
                <label class="fw-semibold mb-2"><i class="fas fa-check-circle me-2 text-success"></i>جودة الحل</label>
                <div class="star-group" data-rating="solution_quality_rating">
                    <input type="radio" name="solution_quality_rating" value="5" id="s5"><label for="s5">&#9733;</label>
                    <input type="radio" name="solution_quality_rating" value="4" id="s4"><label for="s4">&#9733;</label>
                    <input type="radio" name="solution_quality_rating" value="3" id="s3"><label for="s3">&#9733;</label>
                    <input type="radio" name="solution_quality_rating" value="2" id="s2"><label for="s2">&#9733;</label>
                    <input type="radio" name="solution_quality_rating" value="1" id="s1"><label for="s1">&#9733;</label>
                </div>
            </div>
        </div>

        <div class="cm-card mb-3">
            <div class="cm-card-body">
                <label class="fw-semibold mb-2"><i class="fas fa-users me-2 text-primary"></i>تعامل الموظفين</label>
                <div class="star-group" data-rating="staff_behavior_rating">
                    <input type="radio" name="staff_behavior_rating" value="5" id="b5"><label for="b5">&#9733;</label>
                    <input type="radio" name="staff_behavior_rating" value="4" id="b4"><label for="b4">&#9733;</label>
                    <input type="radio" name="staff_behavior_rating" value="3" id="b3"><label for="b3">&#9733;</label>
                    <input type="radio" name="staff_behavior_rating" value="2" id="b2"><label for="b2">&#9733;</label>
                    <input type="radio" name="staff_behavior_rating" value="1" id="b1"><label for="b1">&#9733;</label>
                </div>
            </div>
        </div>

        {# Textareas #}
        <div class="cm-card mb-3">
            <div class="cm-card-body">
                <div class="mb-3">
                    <label class="form-label fw-semibold"><i class="fas fa-thumbs-up me-2 text-success"></i>ما أعجبك؟</label>
                    <textarea class="form-control" name="positive_feedback" rows="3" placeholder="النقاط الإيجابية..."></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-semibold"><i class="fas fa-thumbs-down me-2 text-danger"></i>ما لم يعجبك؟</label>
                    <textarea class="form-control" name="negative_feedback" rows="3" placeholder="النقاط التي تحتاج تحسين..."></textarea>
                </div>
                <div>
                    <label class="form-label fw-semibold"><i class="fas fa-lightbulb me-2 text-warning"></i>اقتراحات</label>
                    <textarea class="form-control" name="suggestions" rows="3" placeholder="كيف نحسن خدمتنا؟"></textarea>
                </div>
            </div>
        </div>

        {# Recommendation #}
        <div class="cm-card mb-3" style="background:linear-gradient(135deg,#10b981,#059669);color:#fff">
            <div class="cm-card-body">
                <label class="fw-semibold mb-2"><i class="fas fa-heart me-2"></i>هل تنصح بخدماتنا؟</label>
                <div class="d-flex gap-3 mt-2">
                    <div class="form-check"><input class="form-check-input" type="radio" name="would_recommend" id="rec_yes" value="true"><label class="form-check-label text-white" for="rec_yes"><i class="fas fa-thumbs-up me-1"></i>نعم</label></div>
                    <div class="form-check"><input class="form-check-input" type="radio" name="would_recommend" id="rec_no" value="false"><label class="form-check-label text-white" for="rec_no"><i class="fas fa-thumbs-down me-1"></i>لا</label></div>
                </div>
            </div>
        </div>

        <div class="text-center mb-4">
            <button type="submit" class="btn btn-warning btn-lg px-5"><i class="fas fa-paper-plane me-2"></i>إرسال التقييم</button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded',function(){
    document.querySelectorAll('.star-group label').forEach(function(lbl){
        lbl.addEventListener('click',function(){
            var inp=this.previousElementSibling;if(inp&&inp.tagName==='INPUT')inp.checked=true;
        });
    });
    document.getElementById('evaluationForm').addEventListener('submit',function(e){
        var req=['overall_rating','response_time_rating','solution_quality_rating','staff_behavior_rating'],ok=true;
        req.forEach(function(n){
            var g=document.querySelector('[data-rating="'+n+'"]'),c=document.querySelector('input[name="'+n+'"]:checked');
            if(!c){g.closest('.cm-card').style.border='2px solid #ef4444';ok=false}else{g.closest('.cm-card').style.border=''}
        });
        if(!ok){e.preventDefault();alert('يرجى تقييم جميع النقاط المطلوبة');document.querySelector('.cm-card[style*="border"]').scrollIntoView({behavior:'smooth',block:'center'})}
    });
});
</script>
{% endblock %}
