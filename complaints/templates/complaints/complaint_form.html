{% extends 'base.html' %}
{% load static widget_tweaks %}
{% block title %}{% if complaint %}تعديل {{ complaint.complaint_number }}{% else %}شكوى جديدة{% endif %} - نظام الخواجه{% endblock %}
{% block extra_css %}
<link href="{% static 'vendor/select2/css/select2.min.css' %}" rel="stylesheet">
<link href="{% static 'vendor/select2/css/select2-bootstrap-5-theme.rtl.min.css' %}" rel="stylesheet">
<link rel="stylesheet" href="{% static 'css/complaints-module.css' %}?v={% now 'U' %}">
{% endblock %}

{% block content %}
<div class="container-fluid cm-page">

    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb" style="font-size:.85rem">
            <li class="breadcrumb-item"><a href="{% url 'complaints:dashboard' %}">الشكاوى</a></li>
            {% if complaint %}<li class="breadcrumb-item"><a href="{% url 'complaints:complaint_detail' complaint.pk %}">{{ complaint.complaint_number }}</a></li><li class="breadcrumb-item active">تعديل</li>
            {% else %}<li class="breadcrumb-item active">شكوى جديدة</li>{% endif %}
        </ol>
    </nav>

    <div class="cm-page-header mb-4">
        <div class="d-flex align-items-center gap-2">
            <h2 class="mb-0"><i class="fas fa-{% if complaint %}edit{% else %}plus-circle{% endif %} me-2"></i>{% if complaint %}تعديل {{ complaint.complaint_number }}{% else %}شكوى جديدة{% endif %}</h2>
            {% if complaint %}<span class="cm-badge cm-badge-{{ complaint.status }}">{{ complaint.get_status_display }}</span>{% endif %}
        </div>
    </div>

    <form method="post" enctype="multipart/form-data" class="needs-validation" novalidate id="complaintForm">
        {% csrf_token %}
        <div class="row g-3">
            {# ── Main form ── #}
            <div class="col-lg-8">

                {# Basic info #}
                <div class="cm-card">
                    <div class="cm-card-header"><h6><i class="fas fa-info-circle me-2"></i>معلومات الشكوى</h6></div>
                    <div class="cm-card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">العميل <span class="text-danger">*</span></label>
                                <select id="customer_search_select" class="form-select" style="width:100%">
                                    {% if complaint.customer %}<option value="{{ complaint.customer.id }}" selected>{{ complaint.customer.name }} - {{ complaint.customer.phone }}</option>{% endif %}
                                </select>
                                {{ form.customer }}
                                {% if form.customer.errors %}<div class="invalid-feedback d-block">{{ form.customer.errors|join:", " }}</div>{% endif %}
                                <small class="text-muted">ابحث بالاسم أو الهاتف</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">نوع الشكوى <span class="text-danger">*</span></label>
                                {{ form.complaint_type|add_class:"form-select" }}
                                {% if form.complaint_type.errors %}<div class="invalid-feedback d-block">{{ form.complaint_type.errors|join:", " }}</div>{% endif %}
                            </div>
                            <div class="col-12">
                                <label class="form-label fw-semibold">العنوان <span class="text-danger">*</span></label>
                                {{ form.title|add_class:"form-control" }}
                                {% if form.title.errors %}<div class="invalid-feedback d-block">{{ form.title.errors|join:", " }}</div>{% endif %}
                            </div>
                            <div class="col-12">
                                <label class="form-label fw-semibold">الوصف <span class="text-danger">*</span></label>
                                {{ form.description|add_class:"form-control"|attr:"rows:5" }}
                                {% if form.description.errors %}<div class="invalid-feedback d-block">{{ form.description.errors|join:", " }}</div>{% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                {# Priority & Deadline #}
                <div class="cm-card">
                    <div class="cm-card-header"><h6><i class="fas fa-tags me-2"></i>الأولوية والتوقيت</h6></div>
                    <div class="cm-card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label fw-semibold">الأولوية <span class="text-danger">*</span></label>
                                {{ form.priority|add_class:"form-select" }}
                                {% if form.priority.errors %}<div class="invalid-feedback d-block">{{ form.priority.errors|join:", " }}</div>{% endif %}
                                <div id="deadline-preview" class="alert alert-info py-2 px-3 mt-2 d-none" style="font-size:.78rem">
                                    <i class="fas fa-clock me-1"></i>الموعد المتوقع: <strong id="expected-deadline"></strong>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-semibold">الحالة</label>
                                {{ form.status|add_class:"form-select" }}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-semibold">الموعد النهائي</label>
                                {{ form.deadline|add_class:"form-control" }}
                                {% if form.deadline.errors %}<div class="invalid-feedback d-block">{{ form.deadline.errors|join:", " }}</div>{% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                {# Assignment #}
                <div class="cm-card">
                    <div class="cm-card-header"><h6><i class="fas fa-users me-2"></i>التعيين</h6></div>
                    <div class="cm-card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">الموظف المسؤول</label>
                                {{ form.assigned_to|add_class:"form-select" }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">القسم المختص</label>
                                {{ form.assigned_department|add_class:"form-select" }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {# ── Sidebar ── #}
            <div class="col-lg-4">

                {# Customer info #}
                <div class="cm-card">
                    <div class="cm-card-header"><h6><i class="fas fa-user me-2"></i>بيانات العميل</h6></div>
                    <div class="cm-card-body">
                        <div id="customer-info" style="display:none">
                            <div id="customer-details"></div>
                        </div>
                        <div id="no-customer-selected" class="cm-empty py-3"><i class="fas fa-user-slash"></i><p>لم يتم اختيار عميل</p></div>
                    </div>
                </div>

                {# Complaint type info #}
                <div class="cm-card">
                    <div class="cm-card-header"><h6><i class="fas fa-tag me-2"></i>معلومات النوع</h6></div>
                    <div class="cm-card-body">
                        <div id="complaint-type-info" style="display:none"><div id="complaint-type-details"></div></div>
                        <div id="no-type-selected" class="cm-empty py-3"><i class="fas fa-tag"></i><p>لم يتم اختيار نوع</p></div>
                    </div>
                </div>

                {# Status info (edit mode) #}
                {% if complaint %}
                <div class="cm-card">
                    <div class="cm-card-header"><h6><i class="fas fa-chart-line me-2"></i>معلومات الحالة</h6></div>
                    <div class="cm-card-body p-0 px-3">
                        <div class="cm-sidebar-item"><span class="cm-sidebar-label">الحالة</span><span class="cm-sidebar-value"><span class="cm-badge cm-badge-{{ complaint.status }}">{{ complaint.get_status_display }}</span></span></div>
                        <div class="cm-sidebar-item"><span class="cm-sidebar-label">الإنشاء</span><span class="cm-sidebar-value">{{ complaint.created_at|date:"Y-m-d H:i" }}</span></div>
                        {% if complaint.deadline %}<div class="cm-sidebar-item"><span class="cm-sidebar-label">الموعد</span><span class="cm-sidebar-value {% if complaint.is_overdue %}text-danger{% endif %}">{{ complaint.deadline|date:"Y-m-d H:i" }}</span></div>{% endif %}
                        {% if complaint.resolved_at %}<div class="cm-sidebar-item"><span class="cm-sidebar-label">الحل</span><span class="cm-sidebar-value text-success">{{ complaint.resolved_at|date:"Y-m-d H:i" }}</span></div>{% endif %}
                    </div>
                </div>
                {% endif %}

                {# Save buttons #}
                <div class="cm-card" style="position:sticky;top:1rem">
                    <div class="cm-card-body">
                        <div class="d-grid gap-2">
                            <button type="submit" name="action" value="save" class="btn btn-primary submit-btn"><i class="fas fa-save me-1"></i>{% if complaint %}تحديث{% else %}حفظ{% endif %} الشكوى</button>
                            {% if not complaint %}<button type="submit" name="action" value="save_and_new" class="btn btn-success submit-btn"><i class="fas fa-plus me-1"></i>حفظ وإنشاء جديدة</button>{% endif %}
                            <a href="{% if complaint %}{% url 'complaints:complaint_detail' complaint.pk %}{% else %}{% url 'complaints:complaint_list' %}{% endif %}" class="btn btn-outline-secondary"><i class="fas fa-times me-1"></i>إلغاء</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'vendor/select2/js/select2.min.js' %}"></script>
<script>
function updateCustomerInfo(id){
    if(!id){$('#customer-info').hide();$('#no-customer-selected').show();return}
    $.get('/complaints/ajax/customer-info/'+id+'/',function(d){
        $('#customer-details').html('<h6 class="mb-1">'+d.name+'</h6><p class="mb-1" style="font-size:.85rem"><i class="fas fa-phone me-1"></i>'+d.phone+'</p><p class="mb-1" style="font-size:.85rem"><i class="fas fa-envelope me-1"></i>'+d.email+'</p><p class="mb-0" style="font-size:.85rem"><i class="fas fa-map-marker-alt me-1"></i>'+d.address+'</p>');
        $('#customer-info').show();$('#no-customer-selected').hide()
    }).fail(function(){$('#customer-info').hide();$('#no-customer-selected').show()})
}

$(document).ready(function(){
    // Track clicked submit button
    $('.submit-btn').click(function(){$('.submit-btn').removeAttr('clicked');$(this).attr('clicked','true')});

    // Select2 customer search
    $('#customer_search_select').select2({
        theme:'bootstrap-5',language:'ar',placeholder:'ابحث عن العميل...',allowClear:true,minimumInputLength:2,
        ajax:{url:'/complaints/ajax/customers/search/',dataType:'json',delay:300,
            data:function(p){return{q:p.term,page:p.page}},
            processResults:function(d){return{results:(d.results||[]).map(function(c){return{id:c.id,text:c.name+' - '+c.phone,customer:c}})}},
            cache:true
        },
        templateResult:function(c){if(c.loading||!c.customer)return c.text;return $('<div><strong>'+c.customer.name+'</strong><br><small class="text-muted">'+c.customer.phone+'</small></div>')},
        templateSelection:function(c){return c.customer?c.customer.name+' - '+c.customer.phone:c.text}
    });

    $('#customer_search_select').on('select2:select',function(e){
        var c=e.params.data.customer;
        if(c){$('#id_customer').val(c.id);updateCustomerInfo(c.id)}
    }).on('select2:clear',function(){$('#id_customer').val('');$('#customer-info').hide();$('#no-customer-selected').show()});

    // Priority → auto deadline
    var priorityHours={urgent:4,high:24,medium:72,low:168};
    $('#id_priority').change(function(){
        var p=$(this).val();
        if(p&&priorityHours[p]){
            var d=new Date();d.setHours(d.getHours()+priorityHours[p]);
            $('#expected-deadline').text(d.toLocaleString('ar-EG',{year:'numeric',month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'})+' (بعد '+priorityHours[p]+' ساعة)');
            $('#deadline-preview').removeClass('d-none');
            if(!$('#id_deadline').val())$('#id_deadline').val(d.toISOString().slice(0,16))
        }else{$('#deadline-preview').addClass('d-none')}
    });

    // Complaint type → staff/dept update
    window.selectedComplaintType=null;
    $('#id_complaint_type').change(function(){
        var tid=$(this).val();window.selectedComplaintType=tid;
        if(!tid){$('#complaint-type-info').hide();$('#no-type-selected').show();return}
        $.get('/complaints/api/complaint-types/'+tid+'/',function(d){
            if(!d.success)return;
            var name=$('#id_complaint_type option:selected').text();
            $('#complaint-type-details').html('<h6 class="mb-1">'+name+'</h6><p class="mb-1" style="font-size:.85rem"><i class="fas fa-clock me-1"></i>المهلة: '+d.default_deadline_hours+' ساعة</p><p class="mb-0" style="font-size:.85rem"><i class="fas fa-users me-1"></i>الموظفين: '+(d.staff?d.staff.length:0)+'</p>');
            $('#complaint-type-info').show();$('#no-type-selected').hide();
            // Update staff
            var as=$('#id_assigned_to'),cv=as.val();as.empty().append('<option value="">اختر الموظف</option>');
            if(d.staff)d.staff.forEach(function(s){var sel=s.is_default&&!cv?' selected':'';var di=s.department?' ('+s.department+')':'';as.append('<option value="'+s.id+'"'+sel+'>'+s.name+di+'</option>')});
            // Update depts
            var ds=$('#id_assigned_department'),dv=ds.val();ds.empty().append('<option value="">اختر القسم</option>');
            if(d.departments)d.departments.forEach(function(dp){var sel=dp.is_default&&!dv?' selected':'';ds.append('<option value="'+dp.id+'"'+sel+'>'+dp.name+'</option>')});
            // Defaults
            if(d.default_priority&&!$('#id_priority').val()){$('#id_priority').val(d.default_priority).trigger('change')}
            if(d.default_deadline_hours&&!$('#id_deadline').val()){var dl=new Date();dl.setHours(dl.getHours()+d.default_deadline_hours);$('#id_deadline').val(dl.toISOString().slice(0,16))}
        })
    });

    // Dept → filter staff
    $('#id_assigned_department').change(function(){
        var did=$(this).val(),tid=window.selectedComplaintType;
        if(did&&tid){
            $.get('/complaints/api/complaint-types/'+tid+'/',function(d){
                if(!d.success)return;var as=$('#id_assigned_to'),cv=as.val();as.empty().append('<option value="">اختر الموظف</option>');
                var dn=$('#id_assigned_department option:selected').text();
                var fs=(d.staff||[]).filter(function(s){return s.source==='responsible_staff'||(s.department&&s.department.trim()===dn.trim())});
                fs.forEach(function(s){as.append('<option value="'+s.id+'">'+s.name+(s.department?' ('+s.department+')':'')+'</option>')});
                if(cv)as.val(cv)
            })
        }else if(did){
            $.get('/complaints/api/department/'+did+'/staff/',function(d){
                var as=$('#id_assigned_to'),cv=as.val();as.empty().append('<option value="">اختر الموظف</option>');
                if(d.staff)d.staff.forEach(function(s){as.append('<option value="'+s.id+'">'+s.name+'</option>')});
                if(cv)as.val(cv)
            })
        }
    });

    // AJAX form submit
    $('#complaintForm').on('submit',function(e){
        e.preventDefault();
        var form=$(this),fd=new FormData(form[0]),btn=$('button[type="submit"][clicked=true]'),origHtml=btn.html();
        if(btn.length)fd.append('action',btn.val());
        // Validate required
        var req=['customer','title','complaint_type','priority','description'],err=[];
        req.forEach(function(f){var v=$('#id_'+f).val();if(!v||!v.trim()){$('#id_'+f).addClass('is-invalid');err.push(f)}else{$('#id_'+f).removeClass('is-invalid')}});
        if(err.length){Swal.fire({icon:'warning',title:'حقول مطلوبة',text:'يرجى ملء جميع الحقول المطلوبة',confirmButtonText:'حسناً'});return false}
        btn.prop('disabled',true).html('<i class="fas fa-spinner fa-spin me-1"></i>جاري الحفظ...');
        $.ajax({
            url:form.attr('action')||window.location.href,method:'POST',data:fd,processData:false,contentType:false,
            headers:{'X-CSRFToken':$('[name=csrfmiddlewaretoken]').val()},
            success:function(r){window.formChanged=false;window.location.href=r.redirect_url||'/complaints/'},
            error:function(xhr){
                var msg='حدث خطأ أثناء الحفظ';
                try{var r=JSON.parse(xhr.responseText);if(r.errors){msg='';Object.entries(r.errors).forEach(function(e){msg+=e[0]+': '+e[1].join(', ')+'\n';$('#id_'+e[0]).addClass('is-invalid')})}}catch(ex){}
                Swal.fire({icon:'error',title:'خطأ',text:msg,confirmButtonText:'حسناً'});
                btn.prop('disabled',false).html(origHtml)
            }
        });
        return false
    });

    // Auto-select customer from URL param
    var cid=new URLSearchParams(window.location.search).get('customer_id');
    if(cid){
        $('#id_customer').val(cid);
        $.get('/customers/api/customer/'+cid+'/',function(r){
            if(r.success&&r.customer){var o=new Option(r.customer.name+' - '+r.customer.phone,r.customer.id,true,true);$('#customer_search_select').append(o).trigger('change');updateCustomerInfo(cid)}
        })
    }

    // Fire initial events
    var ic=$('#id_customer').val(),it=$('#id_complaint_type').val(),ip=$('#id_priority').val();
    window.selectedComplaintType=it||null;
    if(ic)updateCustomerInfo(ic);
    if(it)$('#id_complaint_type').trigger('change');
    if(ip)$('#id_priority').trigger('change');

    // Unsaved changes warning
    window.formChanged=false;
    $('form input,form select,form textarea').change(function(){window.formChanged=true});
    $(window).on('beforeunload',function(){if(window.formChanged)return'هناك تغييرات غير محفوظة'});
});
</script>
{% endblock %}
