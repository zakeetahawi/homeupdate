{% extends 'base.html' %}
{% load static %}
{% block title %}إحصائيات الشكاوى - نظام الخواجه{% endblock %}
{% block extra_css %}<link rel="stylesheet" href="{% static 'css/complaints-module.css' %}?v={% now 'U' %}">{% endblock %}

{% block content %}
<div class="container-fluid cm-page">
    <div class="cm-page-header mb-4"><h2><i class="fas fa-chart-bar me-2"></i>إحصائيات الشكاوى</h2></div>

    <div class="row g-3 mb-4">
        <div class="col-6 col-md-3"><div class="cm-stat"><div class="cm-stat-icon" style="background:var(--cm-primary)"><i class="fas fa-clipboard-list"></i></div><div class="cm-stat-value">{{ stats.total }}</div><div class="cm-stat-label">إجمالي</div></div></div>
        <div class="col-6 col-md-3"><div class="cm-stat"><div class="cm-stat-icon" style="background:var(--cm-blue)"><i class="fas fa-inbox"></i></div><div class="cm-stat-value">{{ stats.new }}</div><div class="cm-stat-label">جديدة</div></div></div>
        <div class="col-6 col-md-3"><div class="cm-stat"><div class="cm-stat-icon" style="background:var(--cm-amber)"><i class="fas fa-spinner"></i></div><div class="cm-stat-value">{{ stats.in_progress }}</div><div class="cm-stat-label">قيد المعالجة</div></div></div>
        <div class="col-6 col-md-3"><div class="cm-stat"><div class="cm-stat-icon" style="background:var(--cm-green)"><i class="fas fa-check"></i></div><div class="cm-stat-value">{{ stats.resolved }}</div><div class="cm-stat-label">تم حلها</div></div></div>
    </div>

    <div class="row g-3">
        <div class="col-lg-7">
            <div class="cm-card"><div class="cm-card-header"><h6><i class="fas fa-chart-line me-2"></i>حسب الشهر</h6></div>
                <div class="cm-card-body cm-chart-wrap"><canvas id="byMonthChart"></canvas></div>
            </div>
        </div>
        <div class="col-lg-5">
            <div class="cm-card"><div class="cm-card-header"><h6><i class="fas fa-chart-pie me-2"></i>حسب النوع</h6></div>
                <div class="cm-card-body cm-chart-wrap"><canvas id="byTypeChart"></canvas></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.js"></script>
<script>
Chart.defaults.font.family='Cairo, sans-serif';Chart.defaults.plugins.legend.rtl=true;
var byType={{ by_type|safe }},byMonth={{ by_month|safe }};
new Chart(document.getElementById('byTypeChart'),{type:'doughnut',data:{labels:byType.map(function(i){return i.complaint_type__name}),datasets:[{data:byType.map(function(i){return i.count}),backgroundColor:['#4361ee','#10b981','#06b6d4','#f59e0b','#ef4444','#6c757d','#7c3aed'],borderWidth:2,borderColor:'#fff'}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{padding:12,usePointStyle:true}}}}});
new Chart(document.getElementById('byMonthChart'),{type:'line',data:{labels:byMonth.map(function(i){return new Date(i.month).toLocaleDateString('ar-EG-u-nu-latn',{month:'long',year:'numeric'})}),datasets:[{label:'الشكاوى',data:byMonth.map(function(i){return i.count}),fill:true,borderColor:'#4361ee',backgroundColor:'rgba(67,97,238,0.1)',tension:.3,pointRadius:4}]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true}}}});
</script>
{% endblock %}
