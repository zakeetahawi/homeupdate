{% extends 'base.html' %}
{% load static %}
{% block title %}لوحة تحكم الشكاوى - نظام الخواجه{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/complaints-module.css' %}?v={% now 'U' %}">
{% endblock %}

{% block content %}
<div class="container-fluid cm-page">

    {# ── Page Header ── #}
    <div class="cm-page-header">
        <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
            <div>
                <h2><i class="fas fa-headset me-2"></i>لوحة تحكم الشكاوى</h2>
                <p>نظرة شاملة على أداء إدارة الشكاوى والخدمة</p>
            </div>
            <div class="d-flex gap-2 position-relative" style="z-index:1">
                <a href="{% url 'complaints:complaint_create' %}" class="btn btn-light btn-sm fw-semibold">
                    <i class="fas fa-plus me-1"></i>شكوى جديدة
                </a>
                <a href="{% url 'complaints:complaint_list' %}" class="btn btn-outline-light btn-sm fw-semibold">
                    <i class="fas fa-list me-1"></i>جميع الشكاوى
                </a>
            </div>
        </div>
        <div class="cm-header-stats">
            <div class="cm-header-stat">
                <div class="cm-header-stat-value">{{ performance_stats.new_complaints_30d }}</div>
                <div class="cm-header-stat-label">جديدة (30 يوم)</div>
            </div>
            <div class="cm-header-stat">
                <div class="cm-header-stat-value">{{ performance_stats.total_resolved_and_closed_30d }}</div>
                <div class="cm-header-stat-label">منتهية (30 يوم)</div>
            </div>
            <div class="cm-header-stat">
                <div class="cm-header-stat-value">{{ performance_stats.avg_resolution_time }}<small>h</small></div>
                <div class="cm-header-stat-label">متوسط وقت الحل</div>
            </div>
            <div class="cm-header-stat">
                <div class="cm-header-stat-value">{{ performance_stats.resolution_rate_30d }}<small>%</small></div>
                <div class="cm-header-stat-label">معدل الإنجاز</div>
            </div>
        </div>
    </div>

    {# ── KPI Cards ── #}
    <div class="row g-3 mb-4">
        <div class="col-6 col-md-4 col-xl">
            <div class="cm-stat"><div class="cm-stat-icon primary"><i class="fas fa-chart-bar"></i></div><div><div class="cm-stat-value">{{ total_complaints }}</div><div class="cm-stat-label">إجمالي</div></div></div>
        </div>
        <div class="col-6 col-md-4 col-xl">
            <div class="cm-stat"><div class="cm-stat-icon info"><i class="fas fa-plus-circle"></i></div><div><div class="cm-stat-value">{{ new_complaints }}</div><div class="cm-stat-label">جديدة</div></div></div>
        </div>
        <div class="col-6 col-md-4 col-xl">
            <div class="cm-stat"><div class="cm-stat-icon warning"><i class="fas fa-spinner"></i></div><div><div class="cm-stat-value">{{ in_progress_complaints }}</div><div class="cm-stat-label">قيد الحل</div></div></div>
        </div>
        <div class="col-6 col-md-4 col-xl">
            <div class="cm-stat"><div class="cm-stat-icon success"><i class="fas fa-check-circle"></i></div><div><div class="cm-stat-value">{{ resolved_complaints }}</div><div class="cm-stat-label">محلولة</div></div></div>
        </div>
        <div class="col-6 col-md-4 col-xl">
            <div class="cm-stat"><div class="cm-stat-icon secondary"><i class="fas fa-archive"></i></div><div><div class="cm-stat-value">{{ closed_complaints }}</div><div class="cm-stat-label">مغلقة</div></div></div>
        </div>
        <div class="col-6 col-md-4 col-xl">
            <div class="cm-stat"><div class="cm-stat-icon danger"><i class="fas fa-exclamation-triangle"></i></div><div><div class="cm-stat-value">{{ overdue_complaints }}</div><div class="cm-stat-label">متأخرة</div></div></div>
        </div>
        <div class="col-6 col-md-4 col-xl">
            <div class="cm-stat"><div class="cm-stat-icon purple"><i class="fas fa-level-up-alt"></i></div><div><div class="cm-stat-value">{{ escalated_complaints|default:0 }}</div><div class="cm-stat-label">مصعدة</div></div></div>
        </div>
        <div class="col-6 col-md-4 col-xl">
            <div class="cm-stat"><div class="cm-stat-icon warning"><i class="fas fa-star-half-alt"></i></div><div><div class="cm-stat-value">{{ pending_evaluation_complaints }}</div><div class="cm-stat-label">بحاجة تقييم</div></div></div>
        </div>
        <div class="col-6 col-md-4 col-xl">
            <div class="cm-stat"><div class="cm-stat-icon success"><i class="fas fa-star"></i></div><div><div class="cm-stat-value">{{ avg_rating }}</div><div class="cm-stat-label">متوسط الرضا</div></div></div>
        </div>
    </div>

    {# ── SLA + Auto Row ── #}
    <div class="row g-3 mb-4">
        <div class="col-lg-6">
            <div class="cm-card">
                <div class="cm-card-header">
                    <h6><i class="fas fa-tachometer-alt me-2 text-primary"></i>أداء SLA</h6>
                    <span class="cm-badge {% if sla_stats.compliance_rate >= 80 %}cm-badge-resolved{% elif sla_stats.compliance_rate >= 60 %}cm-badge-in_progress{% else %}cm-badge-overdue{% endif %}">{{ sla_stats.compliance_rate }}%</span>
                </div>
                <div class="cm-card-body">
                    <div class="cm-progress-thin mb-3"><div class="bar {% if sla_stats.compliance_rate >= 80 %}bg-success{% elif sla_stats.compliance_rate >= 60 %}bg-warning{% else %}bg-danger{% endif %}" style="width:{{ sla_stats.compliance_rate }}%"></div></div>
                    <div class="row g-3 text-center">
                        <div class="col-4"><div class="fw-bold text-success fs-4">{{ sla_stats.within_sla }}</div><small class="text-muted">ضمن SLA</small></div>
                        <div class="col-4"><div class="fw-bold text-danger fs-4">{{ sla_stats.outside_sla }}</div><small class="text-muted">خارج SLA</small></div>
                        <div class="col-4"><div class="fw-bold text-warning fs-4">{{ sla_stats.approaching_deadline }}</div><small class="text-muted">تقترب</small></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="cm-card">
                <div class="cm-card-header"><h6><i class="fas fa-robot me-2 text-info"></i>شكاوى تلقائية (تأخيرات)</h6></div>
                <div class="cm-card-body">
                    <div class="row g-3 text-center">
                        <div class="col-4"><div class="fw-bold text-info fs-4">{{ auto_complaints.total|default:"0" }}</div><small class="text-muted">إجمالي</small></div>
                        <div class="col-4"><div class="fw-bold text-warning fs-4">{{ auto_complaints.open|default:"0" }}</div><small class="text-muted">مفتوحة</small></div>
                        <div class="col-4"><div class="fw-bold text-success fs-4">{{ auto_complaints.resolved|default:"0" }}</div><small class="text-muted">محلولة</small></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# ── By Type + Priority ── #}
    <div class="row g-3 mb-4">
        <div class="col-lg-6">
            <div class="cm-card">
                <div class="cm-card-header"><h6><i class="fas fa-tags me-2"></i>حسب النوع</h6></div>
                <div class="cm-card-body p-0">
                    {% for item in complaints_by_type %}
                    <div class="cm-leaderboard-item"><span class="fw-semibold" style="font-size:.85rem"><i class="fas fa-tag me-1 text-primary"></i>{{ item.complaint_type__name }}</span><span class="cm-badge cm-badge-new">{{ item.count }}</span></div>
                    {% empty %}<div class="cm-empty py-4"><p>لا توجد بيانات</p></div>{% endfor %}
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="cm-card">
                <div class="cm-card-header"><h6><i class="fas fa-exclamation-circle me-2"></i>حسب الأولوية</h6></div>
                <div class="cm-card-body p-0">
                    {% for item in complaints_by_priority %}
                    <div class="cm-leaderboard-item">
                        <span class="fw-semibold" style="font-size:.85rem"><i class="fas fa-flag me-1"></i>{% if item.priority == 'urgent' %}عاجل{% elif item.priority == 'high' %}عالي{% elif item.priority == 'medium' %}متوسط{% else %}منخفض{% endif %}</span>
                        <span class="cm-badge cm-priority-{{ item.priority }}">{{ item.count }}</span>
                    </div>
                    {% empty %}<div class="cm-empty py-4"><p>لا توجد بيانات</p></div>{% endfor %}
                </div>
            </div>
        </div>
    </div>

    {# ── Assignees + 30-Day ── #}
    <div class="row g-3 mb-4">
        <div class="col-lg-6">
            <div class="cm-card">
                <div class="cm-card-header"><h6><i class="fas fa-users me-2"></i>الأكثر نشاطاً</h6></div>
                <div class="cm-card-body p-0">
                    {% for item in complaints_by_assignee %}
                    <div class="cm-leaderboard-item">
                        <div class="d-flex align-items-center gap-2"><div class="cm-leaderboard-rank">{{ forloop.counter }}</div><span class="fw-semibold" style="font-size:.85rem">{{ item.assigned_to__first_name }} {{ item.assigned_to__last_name }}</span></div>
                        <span class="cm-badge cm-badge-resolved">{{ item.count }}</span>
                    </div>
                    {% empty %}<div class="cm-empty py-4"><p>لا توجد بيانات</p></div>{% endfor %}
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="cm-card">
                <div class="cm-card-header"><h6><i class="fas fa-chart-line me-2"></i>أداء 30 يوم</h6></div>
                <div class="cm-card-body">
                    <div class="row g-3 text-center">
                        <div class="col-6 col-md-3"><div class="fw-bold text-primary fs-4">{{ performance_stats.new_complaints_30d }}</div><small class="text-muted">جديدة</small></div>
                        <div class="col-6 col-md-3"><div class="fw-bold text-success fs-4">{{ performance_stats.total_resolved_and_closed_30d }}</div><small class="text-muted">منتهية</small></div>
                        <div class="col-6 col-md-3"><div class="fw-bold text-warning fs-4">{{ performance_stats.avg_resolution_time }}<small>h</small></div><small class="text-muted">متوسط الحل</small></div>
                        <div class="col-6 col-md-3"><div class="fw-bold text-info fs-4">{{ performance_stats.resolution_rate_30d }}%</div><small class="text-muted">الإنجاز</small></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# ── Recent + Overdue ── #}
    <div class="row g-3 mb-4">
        <div class="col-lg-6">
            <div class="cm-card">
                <div class="cm-card-header">
                    <h6><i class="fas fa-clock me-2"></i>الشكاوى الحديثة</h6>
                    <a href="{% url 'complaints:complaint_list' %}" class="cm-btn cm-btn-outline" style="font-size:.75rem">الكل</a>
                </div>
                <div class="cm-card-body p-0">
                    {% for c in recent_complaints %}
                    <a href="{% url 'complaints:complaint_detail' c.pk %}" class="d-block text-decoration-none px-3 py-2 border-bottom" style="border-right:3px solid {% if c.status == 'new' %}#3b82f6{% elif c.status == 'in_progress' %}#f59e0b{% elif c.status == 'resolved' %}#10b981{% elif c.status == 'overdue' %}#ef4444{% elif c.status == 'escalated' %}#8b5cf6{% else %}#94a3b8{% endif %}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <div class="d-flex align-items-center gap-2 mb-1">
                                    <span class="fw-bold text-primary" style="font-size:.85rem">{{ c.complaint_number }}</span>
                                    <span class="cm-badge cm-badge-{{ c.status }}">{{ c.get_status_display }}</span>
                                    <span class="cm-badge cm-priority-{{ c.priority }}">{{ c.get_priority_display }}</span>
                                </div>
                                <div class="text-dark fw-semibold" style="font-size:.85rem">{{ c.title|truncatechars:45 }}</div>
                                <small class="text-muted"><i class="fas fa-user me-1"></i>{{ c.customer.name|truncatechars:20 }} · {{ c.created_at|date:"m/d H:i" }}</small>
                            </div>
                            {% if c.assigned_to %}<small class="text-success"><i class="fas fa-user-check"></i></small>{% else %}<small class="text-warning"><i class="fas fa-user-times"></i></small>{% endif %}
                        </div>
                    </a>
                    {% empty %}
                    <div class="cm-empty py-4"><i class="fas fa-inbox"></i><p>لا توجد شكاوى حديثة</p></div>
                    {% endfor %}
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="cm-card">
                <div class="cm-card-header">
                    <h6><i class="fas fa-exclamation-triangle me-2 text-danger"></i>المتأخرة</h6>
                    <a href="{% url 'complaints:complaint_list' %}?status=overdue" class="cm-btn cm-btn-outline" style="font-size:.75rem">الكل</a>
                </div>
                <div class="cm-card-body p-0">
                    {% for c in overdue_complaints_list %}
                    <a href="{% url 'complaints:complaint_detail' c.pk %}" class="d-block text-decoration-none px-3 py-2 border-bottom" style="border-right:3px solid #ef4444">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <div class="d-flex align-items-center gap-2 mb-1">
                                    <span class="fw-bold text-danger" style="font-size:.85rem">{{ c.complaint_number }}</span>
                                    <span class="cm-badge cm-badge-overdue">متأخرة</span>
                                </div>
                                <div class="text-dark fw-semibold" style="font-size:.85rem">{{ c.title|truncatechars:45 }}</div>
                                <small class="text-danger"><i class="fas fa-calendar-times me-1"></i>{{ c.deadline|date:"m/d H:i" }}</small>
                            </div>
                            {% if c.assigned_to %}<small class="text-muted"><i class="fas fa-user-check"></i></small>{% endif %}
                        </div>
                    </a>
                    {% empty %}
                    <div class="cm-empty py-4"><i class="fas fa-check-circle text-success"></i><h5>ممتاز!</h5><p>لا توجد شكاوى متأخرة</p></div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    {# ── Quick Actions ── #}
    <div class="cm-card">
        <div class="cm-card-body">
            <div class="row g-2">
                <div class="col-6 col-md-3"><a href="{% url 'complaints:complaint_create' %}" class="btn btn-primary w-100"><i class="fas fa-plus me-1"></i>شكوى جديدة</a></div>
                <div class="col-6 col-md-3"><a href="{% url 'complaints:reports' %}" class="btn btn-outline-primary w-100"><i class="fas fa-chart-bar me-1"></i>التقارير</a></div>
                <div class="col-6 col-md-3"><a href="{% url 'complaints:evaluation_report' %}" class="btn btn-outline-warning w-100"><i class="fas fa-star me-1"></i>التقييمات</a></div>
                <div class="col-6 col-md-3"><a href="{% url 'complaints:export_complaints' %}" class="btn btn-outline-secondary w-100"><i class="fas fa-download me-1"></i>تصدير</a></div>
            </div>
        </div>
    </div>

    <a href="{% url 'complaints:complaint_create' %}" class="cm-fab" title="شكوى جديدة"><i class="fas fa-plus"></i></a>
</div>
{% endblock %}

{% block extra_js %}
<script>
setInterval(function(){
    fetch('{% url "complaints:ajax_stats" %}').then(r=>r.json()).then(function(d){console.log('Dashboard refreshed');}).catch(function(){});
}, 300000);
</script>
{% endblock %}
