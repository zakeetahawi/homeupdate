{% extends 'base.html' %}
{% load static pagination_tags %}
{% block title %}قائمة الشكاوى - نظام الخواجه{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/complaints-module.css' %}?v={% now 'U' %}">
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet"/>
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet"/>
{% endblock %}

{% block content %}
<div class="container-fluid cm-page">

    {# ── Header ── #}
    <div class="cm-page-header">
        <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
            <div>
                <h2><i class="fas fa-list-ul me-2"></i>قائمة الشكاوى</h2>
                <p>إجمالي {{ page_obj.paginator.count }} شكوى{% if page_obj.has_other_pages %} — صفحة {{ page_obj.number }} من {{ page_obj.paginator.num_pages }}{% endif %}</p>
            </div>
            <div class="d-flex gap-2 position-relative" style="z-index:1">
                <a href="{% url 'complaints:complaint_create' %}" class="btn btn-light btn-sm fw-semibold"><i class="fas fa-plus me-1"></i>شكوى جديدة</a>
                <a href="{% url 'complaints:analysis' %}" class="btn btn-outline-light btn-sm fw-semibold"><i class="fas fa-chart-line me-1"></i>تحليل</a>
                <button type="button" class="btn btn-outline-light btn-sm fw-semibold" onclick="document.getElementById('bulkActions').classList.toggle('d-none')"><i class="fas fa-tasks me-1"></i>إجراءات مجمعة</button>
            </div>
        </div>
    </div>

    {# ── Filter Panel ── #}
    <div class="cm-filter mb-3">
        <div class="cm-filter-header" data-bs-toggle="collapse" data-bs-target="#filterBody" aria-expanded="true">
            <h6><i class="fas fa-filter me-2"></i>فلاتر البحث</h6>
            <i class="fas fa-chevron-down text-muted"></i>
        </div>
        <div class="collapse show" id="filterBody">
            <div class="cm-filter-body">
                <form method="get" id="filterForm" class="row g-3">
                    <div class="col-md-3 col-6">
                        <label class="form-label fw-semibold" style="font-size:.8rem">{{ filter_form.status.label }}</label>
                        {{ filter_form.status }}
                    </div>
                    <div class="col-md-3 col-6">
                        <label class="form-label fw-semibold" style="font-size:.8rem">{{ filter_form.priority.label }}</label>
                        {{ filter_form.priority }}
                    </div>
                    <div class="col-md-3 col-6">
                        <label class="form-label fw-semibold" style="font-size:.8rem">{{ filter_form.complaint_type.label }}</label>
                        {{ filter_form.complaint_type }}
                    </div>
                    <div class="col-md-3 col-6">
                        <label class="form-label fw-semibold" style="font-size:.8rem">{{ filter_form.assigned_to.label }}</label>
                        {{ filter_form.assigned_to }}
                    </div>
                    <div class="col-md-3 col-6">
                        <label class="form-label fw-semibold" style="font-size:.8rem">{{ filter_form.assigned_department.label }}</label>
                        {{ filter_form.assigned_department }}
                    </div>
                    <div class="col-md-2 col-6">
                        <label class="form-label fw-semibold" style="font-size:.8rem">{{ filter_form.date_from.label }}</label>
                        {{ filter_form.date_from }}
                    </div>
                    <div class="col-md-2 col-6">
                        <label class="form-label fw-semibold" style="font-size:.8rem">{{ filter_form.date_to.label }}</label>
                        {{ filter_form.date_to }}
                    </div>
                    <div class="col-md-5">
                        <label class="form-label fw-semibold" style="font-size:.8rem">{{ filter_form.search.label }}</label>
                        {{ filter_form.search }}
                    </div>
                    {# Advanced #}
                    <div class="col-md-3 col-6 advanced-filter d-none">
                        <label class="form-label fw-semibold" style="font-size:.8rem">العميل</label>
                        <input type="text" name="customer_name" class="form-control form-control-sm" placeholder="اسم العميل" value="{{ request.GET.customer_name }}">
                    </div>
                    <div class="col-md-3 col-6 advanced-filter d-none">
                        <label class="form-label fw-semibold" style="font-size:.8rem">رقم الشكوى</label>
                        <input type="text" name="complaint_id" class="form-control form-control-sm" placeholder="رقم الشكوى" value="{{ request.GET.complaint_id }}">
                    </div>
                    <div class="col-md-3 col-6 advanced-filter d-none">
                        <label class="form-label fw-semibold" style="font-size:.8rem">المسؤول</label>
                        <select name="assigned_to" class="form-select form-select-sm">
                            <option value="">جميع المسؤولين</option>
                            {% for user in users %}<option value="{{ user.id }}" {% if request.GET.assigned_to == user.id|stringformat:"s" %}selected{% endif %}>{{ user.get_full_name|default:user.username }}</option>{% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3 col-6 advanced-filter d-none">
                        <label class="form-label fw-semibold" style="font-size:.8rem">حالة التقييم</label>
                        <select name="evaluation_status" class="form-select form-select-sm">
                            <option value="">الكل</option>
                            <option value="needs_evaluation" {% if request.GET.evaluation_status == 'needs_evaluation' %}selected{% endif %}>بحاجة تقييم</option>
                            <option value="evaluated" {% if request.GET.evaluation_status == 'evaluated' %}selected{% endif %}>تم التقييم</option>
                            <option value="not_evaluated" {% if request.GET.evaluation_status == 'not_evaluated' %}selected{% endif %}>لم يتم التقييم</option>
                        </select>
                    </div>
                    <div class="col-12 d-flex justify-content-center gap-2 mt-2">
                        <button type="submit" class="btn btn-primary btn-sm"><i class="fas fa-search me-1"></i>بحث</button>
                        <a href="{% url 'complaints:complaint_list' %}" class="btn btn-outline-secondary btn-sm"><i class="fas fa-undo me-1"></i>إعادة تعيين</a>
                        <button type="button" class="btn btn-outline-info btn-sm" id="toggleAdvanced"><i class="fas fa-sliders-h me-1"></i>متقدمة</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    {# ── Bulk Actions (hidden) ── #}
    <div id="bulkActions" class="cm-card d-none">
        <div class="cm-card-body">
            <form method="post" action="{% url 'complaints:bulk_action' %}" id="bulkForm" class="row g-2 align-items-end">
                {% csrf_token %}
                <div class="col-md-3">
                    <label class="form-label fw-semibold" style="font-size:.8rem">{{ bulk_action_form.action.label }}</label>
                    {{ bulk_action_form.action }}
                </div>
                <div class="col-md-2 d-none" id="assignedToField">{{ bulk_action_form.assigned_to.label_tag }}{{ bulk_action_form.assigned_to }}</div>
                <div class="col-md-2 d-none" id="statusField">{{ bulk_action_form.status.label_tag }}{{ bulk_action_form.status }}</div>
                <div class="col-md-2 d-none" id="priorityField">{{ bulk_action_form.priority.label_tag }}{{ bulk_action_form.priority }}</div>
                <div class="col-md-3">
                    <label class="form-label fw-semibold" style="font-size:.8rem">{{ bulk_action_form.notes.label }}</label>
                    {{ bulk_action_form.notes }}
                </div>
                <div class="col-md-2 d-flex gap-1">
                    <button type="submit" class="btn btn-primary btn-sm"><i class="fas fa-check me-1"></i>تنفيذ</button>
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="document.getElementById('bulkActions').classList.add('d-none')">إلغاء</button>
                </div>
            </form>
        </div>
    </div>

    {# ── Table ── #}
    <div class="cm-card">
        {% if complaints %}
        <div class="table-responsive">
            <table class="cm-table">
                <thead>
                    <tr>
                        <th style="width:40px" class="text-center"><input type="checkbox" class="form-check-input" id="selectAllCb" onchange="toggleAll()"></th>
                        <th>الشكوى</th>
                        <th>العميل</th>
                        <th>العنوان / النوع</th>
                        <th class="text-center">الأولوية</th>
                        <th class="text-center">الحالة</th>
                        <th class="text-center" style="width:130px">إجراءات</th>
                    </tr>
                </thead>
                <tbody>
                    {% for complaint in complaints %}
                    <tr data-status="{{ complaint.status }}">
                        <td class="text-center"><input type="checkbox" class="form-check-input complaint-cb" value="{{ complaint.pk }}"></td>
                        <td>
                            <a href="{% url 'complaints:complaint_detail' complaint.pk %}" class="fw-bold text-primary text-decoration-none" style="font-size:.85rem">{{ complaint.complaint_number }}</a>
                            <div class="text-muted" style="font-size:.75rem"><i class="fas fa-calendar me-1"></i>{{ complaint.created_at|date:"Y-m-d" }}</div>
                        </td>
                        <td>
                            <div class="fw-semibold" style="font-size:.85rem">{{ complaint.customer.name }}</div>
                            <div class="text-muted" style="font-size:.75rem">{{ complaint.customer.phone }}</div>
                        </td>
                        <td>
                            <div class="fw-semibold" style="font-size:.85rem">{{ complaint.title|truncatechars:45 }}</div>
                            <span class="cm-badge cm-badge-new" style="font-size:.7rem">{{ complaint.complaint_type.name }}</span>
                        </td>
                        <td class="text-center"><span class="cm-badge cm-priority-{{ complaint.priority }}">{{ complaint.get_priority_display }}</span></td>
                        <td class="text-center">
                            <span class="cm-badge cm-badge-{{ complaint.status }}">{{ complaint.get_status_display }}</span>
                            {% if complaint.escalations.exists %}<br><span class="cm-badge cm-badge-escalated mt-1">مصعدة</span>{% endif %}
                            {% if complaint.is_overdue %}<br><span class="cm-badge cm-badge-overdue mt-1">متأخرة</span>{% endif %}
                            {% if complaint.needs_evaluation %}<br><span class="cm-badge cm-badge-pending_evaluation mt-1">تقييم</span>{% endif %}
                            {% if complaint.is_fully_completed %}<br><span class="cm-badge cm-badge-resolved mt-1"><i class="fas fa-check-double"></i></span>{% endif %}
                        </td>
                        <td class="text-center">
                            <div class="btn-group btn-group-sm">
                                <a href="{% url 'complaints:complaint_detail' complaint.pk %}" class="btn btn-outline-primary" title="عرض"><i class="fas fa-eye"></i></a>
                                <a href="{% url 'complaints:complaint_edit' complaint.pk %}" class="btn btn-outline-secondary" title="تعديل"><i class="fas fa-edit"></i></a>
                                {% if complaint.status != 'closed' %}<button type="button" class="btn btn-outline-success" onclick="quickResolve({{ complaint.pk }})" title="حل"><i class="fas fa-check"></i></button>{% endif %}
                            </div>
                            {% if complaint.assigned_to %}
                            <div class="mt-1"><small class="text-success" style="font-size:.7rem"><i class="fas fa-user-check me-1"></i>{{ complaint.assigned_to.get_full_name|default:complaint.assigned_to.username|truncatechars:12 }}</small></div>
                            {% else %}
                            <div class="mt-1"><small class="text-warning" style="font-size:.7rem"><i class="fas fa-user-times me-1"></i>غير مُعين</small></div>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="cm-card-footer">{% render_pagination page_obj %}</div>
        {% else %}
        <div class="cm-empty">
            <i class="fas fa-inbox"></i>
            <h5>لا توجد شكاوى</h5>
            <p>لم يتم العثور على شكاوى تطابق معايير البحث</p>
            <div class="d-flex justify-content-center gap-2">
                <a href="{% url 'complaints:complaint_create' %}" class="btn btn-primary btn-sm"><i class="fas fa-plus me-1"></i>شكوى جديدة</a>
                <a href="{% url 'complaints:complaint_list' %}" class="btn btn-outline-secondary btn-sm"><i class="fas fa-undo me-1"></i>إعادة تحميل</a>
            </div>
        </div>
        {% endif %}
    </div>

    <a href="{% url 'complaints:complaint_create' %}" class="cm-fab" title="شكوى جديدة"><i class="fas fa-plus"></i></a>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
$(function(){
    // Select2 on filter fields
    ['#id_status','#id_priority','#id_complaint_type','#id_assigned_to','#id_assigned_department'].forEach(function(sel){
        $(sel).select2({theme:'bootstrap-5',allowClear:true,dir:'rtl',width:'100%',placeholder:'الكل...'});
    });
    // Auto-submit on filter change
    $('#filterForm select').on('change',function(){$('#filterForm').submit()});

    // Advanced filters toggle
    $('#toggleAdvanced').on('click',function(){
        var adv=document.querySelectorAll('.advanced-filter');
        var show=adv[0].classList.contains('d-none');
        adv.forEach(function(el){el.classList.toggle('d-none',!show)});
        $(this).html(show?'<i class="fas fa-times me-1"></i>إخفاء':'<i class="fas fa-sliders-h me-1"></i>متقدمة');
    });
    // Show advanced if they have values
    var hasAdv=false;
    document.querySelectorAll('.advanced-filter input,.advanced-filter select').forEach(function(el){if(el.value)hasAdv=true});
    if(hasAdv) $('#toggleAdvanced').click();

    // Bulk action field toggle
    $('select[name="action"]').on('change',function(){
        $('#assignedToField,#statusField,#priorityField').addClass('d-none');
        if(this.value==='assign')$('#assignedToField').removeClass('d-none');
        else if(this.value==='change_status')$('#statusField').removeClass('d-none');
        else if(this.value==='change_priority')$('#priorityField').removeClass('d-none');
    });
});

function toggleAll(){
    var c=document.getElementById('selectAllCb').checked;
    document.querySelectorAll('.complaint-cb').forEach(function(cb){cb.checked=c});
    updateBulkIds();
}
function updateBulkIds(){
    var form=document.getElementById('bulkForm');
    form.querySelectorAll('input[name="complaint_ids"]').forEach(function(e){e.remove()});
    document.querySelectorAll('.complaint-cb:checked').forEach(function(cb){
        var inp=document.createElement('input');inp.type='hidden';inp.name='complaint_ids';inp.value=cb.value;form.appendChild(inp);
    });
}
document.querySelectorAll('.complaint-cb').forEach(function(cb){cb.addEventListener('change',updateBulkIds)});

function quickResolve(id){
    if(confirm('هل أنت متأكد من حل هذه الشكوى؟'))window.location.href='/complaints/'+id+'/';
}
</script>
{% endblock %}
