{% extends 'base.html' %}
{% load static inventory_math_filters %}
{% block title %}شكوى {{ complaint.complaint_number }} - نظام الخواجه{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/complaints-module.css' %}?v={% now 'U' %}">
{% endblock %}

{% block content %}
<div class="container-fluid cm-page">

    {# Breadcrumb #}
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb" style="font-size:.85rem">
            <li class="breadcrumb-item"><a href="{% url 'complaints:dashboard' %}">الشكاوى</a></li>
            <li class="breadcrumb-item"><a href="{% url 'complaints:complaint_list' %}">القائمة</a></li>
            <li class="breadcrumb-item active">{{ complaint.complaint_number }}</li>
        </ol>
    </nav>

    {# ── Header ── #}
    <div class="cm-page-header mb-4">
        <div class="d-flex flex-wrap justify-content-between align-items-start gap-3">
            <div class="flex-grow-1">
                <div class="d-flex align-items-center gap-2 mb-2">
                    <h2 class="mb-0"><i class="fas fa-ticket-alt me-2"></i>{{ complaint.complaint_number }}</h2>
                    <span class="cm-badge cm-badge-{{ complaint.status }}" style="font-size:.85rem">{{ complaint.get_status_display }}</span>
                    <span class="cm-badge cm-priority-{{ complaint.priority }}" style="font-size:.85rem">{{ complaint.get_priority_display }}</span>
                </div>
                <p class="mb-2 fs-5" style="opacity:.95">{{ complaint.title }}</p>
                <div class="d-flex flex-wrap gap-3" style="font-size:.85rem;opacity:.9">
                    <span><i class="fas fa-user me-1"></i>{{ complaint.customer.name }}</span>
                    <span><i class="fas fa-phone me-1"></i>{{ complaint.customer.phone }}</span>
                    <span><i class="fas fa-calendar me-1"></i>{{ complaint.created_at|date:"Y-m-d H:i" }}</span>
                    <span><i class="fas fa-clock me-1"></i>الموعد: {{ complaint.deadline|date:"Y-m-d H:i" }}</span>
                </div>
            </div>
            <div class="text-end position-relative" style="z-index:1">
                {% if complaint.is_overdue %}<div class="alert alert-danger py-1 px-3 mb-2" style="font-size:.8rem"><i class="fas fa-exclamation-triangle me-1"></i>متأخرة!</div>{% endif %}
                {% if complaint.time_remaining %}<div class="alert alert-info py-1 px-3 mb-0" style="font-size:.8rem"><i class="fas fa-hourglass-half me-1"></i>متبقي {{ complaint.time_remaining.days }} يوم</div>{% endif %}
            </div>
        </div>
    </div>

    <div class="row g-3">
        {# ── Main Column ── #}
        <div class="col-lg-8">

            {# Description #}
            <div class="cm-card">
                <div class="cm-card-header"><h6><i class="fas fa-align-right me-2"></i>وصف الشكوى</h6></div>
                <div class="cm-card-body">
                    <div class="border-start border-primary border-3 ps-3" style="font-size:.9rem">{{ complaint.description|linebreaks }}</div>
                </div>
            </div>

            {# Related Order #}
            {% if complaint.related_order %}
            <div class="cm-card" style="background:#eff6ff;border-color:#bfdbfe">
                <div class="cm-card-body py-2">
                    <i class="fas fa-link me-2 text-primary"></i>
                    <strong>الطلب المرتبط:</strong>
                    <a href="{% url 'orders:order_detail' complaint.related_order.pk %}" class="text-decoration-none fw-semibold">
                        طلب #{{ complaint.related_order.order_number }}
                    </a> — {{ complaint.related_order.customer.name }}
                </div>
            </div>
            {% endif %}

            {# Updates Timeline #}
            <div class="cm-card">
                <div class="cm-card-header"><h6><i class="fas fa-history me-2"></i>سجل التحديثات</h6></div>
                <div class="cm-card-body">
                    {% if updates %}
                    <div class="cm-timeline">
                        {% for update in updates %}
                        <div class="cm-timeline-item">
                            <div class="cm-timeline-dot {{ update.update_type }}"></div>
                            <div class="cm-timeline-content">
                                <h6>{{ update.title }}</h6>
                                <p>{{ update.description|linebreaks }}</p>
                                <div class="cm-timeline-meta">
                                    <span><i class="fas fa-user me-1"></i>{{ update.created_by.get_full_name|default:update.created_by.username }}</span>
                                    <span><i class="fas fa-clock me-1"></i>{{ update.created_at|date:"Y-m-d H:i" }}</span>
                                    {% if update.is_visible_to_customer %}<span class="cm-badge cm-badge-resolved">مرئي للعميل</span>{% else %}<span class="cm-badge cm-badge-closed">داخلي</span>{% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="cm-empty py-3"><p>لا توجد تحديثات بعد</p></div>
                    {% endif %}
                </div>
            </div>

            {# Attachments #}
            <div class="cm-card">
                <div class="cm-card-header">
                    <h6><i class="fas fa-paperclip me-2"></i>المرفقات</h6>
                    <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addAttachmentModal"><i class="fas fa-upload me-1"></i>إضافة</button>
                </div>
                <div class="cm-card-body">
                    {% for att in attachments %}
                    <div class="cm-attachment">
                        <div class="cm-attachment-icon"><i class="fas fa-file"></i></div>
                        <div class="flex-grow-1">
                            <a href="{{ att.file.url }}" target="_blank" class="fw-semibold text-decoration-none" style="font-size:.85rem">{{ att.filename }}</a>
                            {% if att.description %}<div class="text-muted" style="font-size:.75rem">{{ att.description }}</div>{% endif %}
                            <div class="text-muted" style="font-size:.75rem">{{ att.uploaded_by.get_full_name }} · {{ att.uploaded_at|date:"Y-m-d H:i" }}
                                {% if att.file_size %}· {% if att.file_size < 1048576 %}{{ att.file_size|divide:1024|floatformat:0 }} ك.ب{% else %}{{ att.file_size|divide:1048576|floatformat:1 }} م.ب{% endif %}{% endif %}
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="cm-empty py-3"><i class="fas fa-folder-open"></i><p>لا توجد مرفقات</p></div>
                    {% endfor %}
                </div>
            </div>

            {# Customer Rating #}
            {% if complaint.customer_rating %}
            <div class="cm-card">
                <div class="cm-card-header"><h6><i class="fas fa-star me-2 text-warning"></i>تقييم العميل</h6></div>
                <div class="cm-card-body">
                    <div class="mb-2">
                        {% for i in "12345" %}{% if forloop.counter <= complaint.customer_rating %}<i class="fas fa-star text-warning"></i>{% else %}<i class="far fa-star text-muted"></i>{% endif %}{% endfor %}
                        <span class="ms-2 fw-semibold">{{ complaint.get_customer_rating_display }}</span>
                    </div>
                    {% if complaint.customer_feedback %}<div class="border-start border-warning border-3 ps-3" style="font-size:.9rem">{{ complaint.customer_feedback|linebreaks }}</div>{% endif %}
                </div>
            </div>
            {% endif %}
        </div>

        {# ── Sidebar ── #}
        <div class="col-lg-4">

            {# Actions #}
            <div class="cm-card">
                <div class="cm-card-header"><h6><i class="fas fa-bolt me-2 text-primary"></i>إجراءات</h6></div>
                <div class="cm-card-body">
                    {% if complaint.status == 'new' %}
                    <div class="alert alert-info py-2 mb-3" style="font-size:.8rem"><i class="fas fa-info-circle me-1"></i>شكوى جديدة — ابدأ العمل أو أسندها</div>
                    <div class="d-grid gap-2">
                        <button data-quick-action="status" data-complaint-id="{{ complaint.pk }}" data-value="in_progress" class="btn btn-warning btn-sm"><i class="fas fa-play me-1"></i>بدء العمل</button>
                        <button data-quick-action="assign" data-complaint-id="{{ complaint.pk }}" class="btn btn-info btn-sm"><i class="fas fa-user-plus me-1"></i>إسناد</button>
                        <a href="{% url 'complaints:complaint_edit' complaint.pk %}" class="btn btn-outline-primary btn-sm"><i class="fas fa-edit me-1"></i>تعديل</a>
                    </div>

                    {% elif complaint.status == 'in_progress' %}
                    <div class="alert alert-warning py-2 mb-3" style="font-size:.8rem"><i class="fas fa-spinner me-1"></i>قيد المعالجة</div>
                    <div class="d-grid gap-2">
                        <button data-quick-action="status" data-complaint-id="{{ complaint.pk }}" data-value="resolved" class="btn btn-success btn-sm"><i class="fas fa-check me-1"></i>حل الشكوى</button>
                        <button data-quick-action="assign" data-complaint-id="{{ complaint.pk }}" class="btn btn-info btn-sm"><i class="fas fa-user-edit me-1"></i>إعادة إسناد</button>
                        <button data-quick-action="escalate" data-complaint-id="{{ complaint.pk }}" class="btn btn-danger btn-sm"><i class="fas fa-exclamation-triangle me-1"></i>تصعيد</button>
                    </div>

                    {% elif complaint.status == 'resolved' %}
                    <div class="alert alert-success py-2 mb-3" style="font-size:.8rem"><i class="fas fa-check-circle me-1"></i>تم الحل</div>
                    <div class="d-grid gap-2">
                        <button data-quick-action="status" data-complaint-id="{{ complaint.pk }}" data-value="pending_evaluation" class="btn btn-warning btn-sm"><i class="fas fa-star-half-alt me-1"></i>تحويل للتقييم</button>
                    </div>

                    {% elif complaint.status == 'pending_evaluation' %}
                    <div class="alert alert-warning py-2 mb-3" style="font-size:.8rem"><i class="fas fa-star-half-alt me-1"></i>بحاجة تقييم</div>
                    <div class="d-grid gap-2">
                        {% if not complaint.is_evaluated %}
                        <a href="{% url 'complaints:create_evaluation' complaint.pk %}" class="btn btn-primary btn-sm"><i class="fas fa-star me-1"></i>إضافة تقييم</a>
                        {% else %}
                        <div class="alert alert-success py-2 mb-0" style="font-size:.8rem">
                            <i class="fas fa-star me-1"></i>تم التقييم: {{ complaint.evaluation.overall_rating }}/5
                        </div>
                        <button data-quick-action="status" data-complaint-id="{{ complaint.pk }}" data-value="closed" class="btn btn-success btn-sm"><i class="fas fa-archive me-1"></i>إغلاق نهائي</button>
                        {% endif %}
                    </div>

                    {% elif complaint.status == 'overdue' %}
                    <div class="alert alert-danger py-2 mb-3" style="font-size:.8rem"><i class="fas fa-clock me-1"></i>متأخرة — تحتاج إجراء فوري</div>
                    <div class="d-grid gap-2">
                        <button data-quick-action="status" data-complaint-id="{{ complaint.pk }}" data-value="in_progress" class="btn btn-warning btn-sm"><i class="fas fa-play me-1"></i>استئناف</button>
                        <button data-quick-action="status" data-complaint-id="{{ complaint.pk }}" data-value="resolved" class="btn btn-success btn-sm"><i class="fas fa-check me-1"></i>حل</button>
                        <button data-quick-action="escalate" data-complaint-id="{{ complaint.pk }}" class="btn btn-danger btn-sm"><i class="fas fa-exclamation-triangle me-1"></i>تصعيد</button>
                    </div>

                    {% elif complaint.status == 'escalated' %}
                    <div class="alert alert-danger py-2 mb-3" style="font-size:.8rem"><i class="fas fa-exclamation-triangle me-1"></i>مصعدة — تحتاج تدخل إداري</div>
                    <div class="d-grid gap-2">
                        <button data-quick-action="status" data-complaint-id="{{ complaint.pk }}" data-value="in_progress" class="btn btn-warning btn-sm"><i class="fas fa-undo me-1"></i>إرجاع للمعالجة</button>
                        <button data-quick-action="assign" data-complaint-id="{{ complaint.pk }}" class="btn btn-info btn-sm"><i class="fas fa-user-edit me-1"></i>إعادة إسناد</button>
                    </div>

                    {% elif complaint.status == 'closed' %}
                        {% if complaint.is_fully_completed %}
                        <div class="alert alert-success py-2 mb-3" style="font-size:.8rem"><i class="fas fa-check-double me-1"></i>منتهية تماماً</div>
                        {% if complaint.evaluation %}
                        <div class="text-center mb-2">
                            {% for i in "12345" %}{% if forloop.counter <= complaint.evaluation.overall_rating %}<i class="fas fa-star text-warning"></i>{% else %}<i class="far fa-star text-muted"></i>{% endif %}{% endfor %}
                            <span class="fw-semibold ms-1">{{ complaint.evaluation.overall_rating }}/5</span>
                        </div>
                        {% if complaint.evaluation.would_recommend %}<div class="text-center"><span class="cm-badge cm-badge-resolved"><i class="fas fa-thumbs-up me-1"></i>ينصح بالخدمة</span></div>{% endif %}
                        {% endif %}
                        {% else %}
                        <div class="alert alert-secondary py-2 mb-3" style="font-size:.8rem"><i class="fas fa-archive me-1"></i>مغلقة</div>
                        {% endif %}

                    {% elif complaint.status == 'cancelled' %}
                    <div class="alert alert-dark py-2 mb-3" style="font-size:.8rem"><i class="fas fa-ban me-1"></i>ملغية</div>
                    {% endif %}

                    {# Extra actions for open complaints #}
                    {% if complaint.status not in 'closed,cancelled' %}
                    <hr class="my-3">
                    <div class="d-grid gap-2">
                        <button data-quick-action="note" data-complaint-id="{{ complaint.pk }}" class="btn btn-outline-secondary btn-sm"><i class="fas fa-sticky-note me-1"></i>إضافة ملاحظة</button>
                        <button data-quick-action="status" data-complaint-id="{{ complaint.pk }}" class="btn btn-outline-info btn-sm"><i class="fas fa-exchange-alt me-1"></i>تغيير الحالة</button>
                        <button data-quick-action="assign" data-complaint-id="{{ complaint.pk }}" class="btn btn-outline-warning btn-sm"><i class="fas fa-user-cog me-1"></i>إعادة الإسناد</button>
                    </div>
                    {% endif %}
                </div>
            </div>

            {# Info #}
            <div class="cm-card">
                <div class="cm-card-header"><h6><i class="fas fa-info-circle me-2"></i>المعلومات</h6></div>
                <div class="cm-card-body p-0 px-3">
                    <div class="cm-sidebar-item"><span class="cm-sidebar-label">النوع</span><span class="cm-sidebar-value">{{ complaint.complaint_type.name }}</span></div>
                    <div class="cm-sidebar-item">
                        <span class="cm-sidebar-label">المسؤول</span>
                        <span class="cm-sidebar-value">
                            {% if complaint.assigned_to %}
                            <i class="fas fa-user me-1 text-primary"></i>{{ complaint.assigned_to.get_full_name|default:complaint.assigned_to.username }}
                            {% else %}<span class="text-danger"><i class="fas fa-user-times me-1"></i>غير مُعين</span>{% endif %}
                        </span>
                    </div>
                    <div class="cm-sidebar-item"><span class="cm-sidebar-label">القسم</span><span class="cm-sidebar-value">{{ complaint.assigned_department.name|default:"—" }}</span></div>
                    <div class="cm-sidebar-item"><span class="cm-sidebar-label">الفرع</span><span class="cm-sidebar-value">{{ complaint.branch.name|default:"—" }}</span></div>
                    <div class="cm-sidebar-item"><span class="cm-sidebar-label">أنشأها</span><span class="cm-sidebar-value">{{ complaint.created_by.get_full_name|default:"—" }}</span></div>
                    {% if complaint.resolved_at %}
                    <div class="cm-sidebar-item"><span class="cm-sidebar-label">تاريخ الحل</span><span class="cm-sidebar-value">{{ complaint.resolved_at|date:"Y-m-d H:i" }}</span></div>
                    {% endif %}
                    {% if complaint.resolution_time %}
                    <div class="cm-sidebar-item"><span class="cm-sidebar-label">وقت الحل</span><span class="cm-sidebar-value">{{ complaint.resolution_time.days }} يوم</span></div>
                    {% endif %}
                </div>
            </div>

            {# Notifications #}
            {% if notifications %}
            <div class="cm-card">
                <div class="cm-card-header"><h6><i class="fas fa-bell me-2"></i>الإشعارات</h6></div>
                <div class="cm-card-body p-0 px-3 py-2">
                    {% for notif in notifications|slice:":5" %}
                    <div class="cm-sidebar-item">
                        <div>
                            <div class="fw-semibold" style="font-size:.8rem">{{ notif.title }}</div>
                            <small class="text-muted">{{ notif.created_at|date:"m/d H:i" }}</small>
                        </div>
                        {% if not notif.is_read %}<span class="cm-badge cm-badge-new">جديد</span>{% endif %}
                    </div>
                    {% endfor %}
                    {% if notifications.count > 5 %}<div class="text-center py-2"><a href="{% url 'complaints:notifications_list' %}" class="btn btn-outline-primary btn-sm" style="font-size:.75rem">عرض الكل</a></div>{% endif %}
                </div>
            </div>
            {% endif %}

            {# Escalations #}
            {% if escalations %}
            <div class="cm-card">
                <div class="cm-card-header"><h6><i class="fas fa-level-up-alt me-2 text-danger"></i>التصعيدات</h6></div>
                <div class="cm-card-body p-0 px-3 py-2">
                    {% for esc in escalations %}
                    <div class="cm-sidebar-item flex-column align-items-start gap-1">
                        <div class="fw-semibold" style="font-size:.85rem">{{ esc.get_reason_display }}</div>
                        <div class="text-muted" style="font-size:.75rem">{{ esc.description|truncatechars:80 }}</div>
                        <small class="text-muted">من: {{ esc.escalated_from.get_full_name|default:"—" }} → {{ esc.escalated_to.get_full_name|default:"—" }} · {{ esc.escalated_at|date:"m/d H:i" }}</small>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

{# ── Modals ── #}

{# Status Modal #}
<div class="modal fade" id="statusModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">تحديث الحالة</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <form method="post" action="{% url 'complaints:complaint_status_update' complaint.pk %}">
                <div class="modal-body">
                    {% csrf_token %}
                    <div class="mb-3">{{ status_form.status.label_tag }}{{ status_form.status }}</div>
                    <div class="mb-3 d-none" id="resolution-method-field">
                        <label for="id_resolution_method" class="form-label">طريقة الحل</label>
                        <select name="resolution_method" id="id_resolution_method" class="form-select"><option value="">اختر...</option></select>
                    </div>
                    <div class="mb-3">{{ status_form.notes.label_tag }}{{ status_form.notes }}<div class="form-text">{{ status_form.notes.help_text }}</div></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">إلغاء</button>
                    <button type="submit" class="btn btn-primary btn-sm">تحديث</button>
                </div>
            </form>
        </div>
    </div>
</div>

{# Attachment Modal #}
<div class="modal fade" id="addAttachmentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">إضافة مرفق</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <form method="post" action="{% url 'complaints:complaint_add_attachment' complaint.pk %}" enctype="multipart/form-data">
                <div class="modal-body">
                    {% csrf_token %}
                    <div class="mb-3">{{ attachment_form.file.label_tag }}{{ attachment_form.file }}</div>
                    <div class="mb-3">{{ attachment_form.description.label_tag }}{{ attachment_form.description }}</div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">إلغاء</button>
                    <button type="submit" class="btn btn-primary btn-sm">رفع</button>
                </div>
            </form>
        </div>
    </div>
</div>

{# Rating Modal #}
<div class="modal fade" id="ratingModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">تقييم الخدمة</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <form method="post" action="{% url 'complaints:customer_rating' complaint.pk %}">
                <div class="modal-body">
                    {% csrf_token %}
                    <div class="mb-3">{{ rating_form.customer_rating.label_tag }}{{ rating_form.customer_rating }}</div>
                    <div class="mb-3">{{ rating_form.customer_feedback.label_tag }}{{ rating_form.customer_feedback }}</div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">إلغاء</button>
                    <button type="submit" class="btn btn-primary btn-sm">حفظ</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
{% load static %}
<script src="{% static 'js/complaints-quick-actions.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded',function(){
    var ss=document.getElementById('id_status');
    var rmf=document.getElementById('resolution-method-field');
    var rms=document.getElementById('id_resolution_method');
    function toggleRM(){
        if(ss&&ss.value==='resolved'){rmf.classList.remove('d-none');rms.required=true;
            if(rms.children.length<=1)fetch('/complaints/api/resolution-methods/').then(r=>r.json()).then(function(d){if(d.success)d.methods.forEach(function(m){var o=document.createElement('option');o.value=m.id;o.textContent=m.name;rms.appendChild(o)})}).catch(function(){});
        }else{rmf.classList.add('d-none');rms.required=false}
    }
    if(ss){toggleRM();ss.addEventListener('change',toggleRM)}
});
</script>
{% endblock %}
