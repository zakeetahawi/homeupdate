{% extends 'base.html' %}
{% load static %}
{% load inventory_math_filters %}

{% block title %}شكوى {{ complaint.complaint_number }} - نظام الخواجه{% endblock %}

{% block extra_css %}
<style>
    /* Mobile-first base styles */
    .complaint-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    
    .info-card {
        background: white;
        border-radius: 15px;
        padding: 1rem;
        margin-bottom: 1rem;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
    
    /* Desktop styles */
    @media (min-width: 768px) {
        .complaint-header {
            padding: 2rem;
            margin-bottom: 2rem;
        }
        
        .info-card {
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
    }
    
    /* Responsive timeline */
    .timeline {
        position: relative;
        padding-left: 1rem;
    }
    
    .timeline::before {
        content: '';
        position: absolute;
        left: 0.5rem;
        top: 0;
        height: 100%;
        width: 2px;
        background: #dee2e6;
    }
    
    @media (min-width: 768px) {
        .timeline {
            padding-left: 2rem;
        }
        
        .timeline::before {
            left: 1rem;
        }
    }
    
    /* Touch-friendly timeline items */
    .timeline-item {
        position: relative;
        margin-bottom: 1rem;
        background: white;
        border-radius: 10px;
        padding: 0.75rem;
        border-left: 4px solid #007bff;
        font-size: 0.9rem;
    }
    
    @media (min-width: 768px) {
        .timeline-item {
            margin-bottom: 2rem;
            padding: 1rem;
            font-size: 1rem;
        }
    }
    
    .timeline-item::before {
        content: '';
        position: absolute;
        left: -1.75rem;
        top: 1rem;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #007bff;
        border: 3px solid white;
        box-shadow: 0 0 0 3px #dee2e6;
    }
    
    .timeline-item.status_change::before { background: #ffc107; }
    .timeline-item.assignment::before { background: #17a2b8; }
    .timeline-item.escalation::before { background: #dc3545; }
    .timeline-item.resolution::before { background: #28a745; }
    .timeline-item.customer_response::before { background: #6f42c1; }
    
    .priority-indicator {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        display: inline-block;
        margin-left: 10px;
    }
    
    .priority-urgent { background-color: #dc3545; }
    .priority-high { background-color: #fd7e14; }
    .priority-medium { background-color: #ffc107; }
    .priority-low { background-color: #20c997; }
    
    .attachment-item {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1rem;
        border-left: 3px solid #007bff;
    }
    
    .related-info {
        background: #e3f2fd;
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    
    /* تحسين تصميم أزرار الإجراءات */
    .info-card .btn {
        padding: 0.75rem 1rem;
        font-weight: 500;
        border-radius: 0.5rem;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .info-card .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .info-card .btn i {
        font-size: 1.1em;
    }

    /* تحسين تصميم التنبيهات */
    .alert-sm {
        padding: 0.5rem 0.75rem;
        font-size: 0.875rem;
        border-radius: 0.375rem;
    }

    /* تحسين العناوين */
    .border-bottom {
        border-color: #e9ecef !important;
    }

    /* تحسين النجوم في التقييم */
    .fa-star {
        font-size: 1.1em;
        margin: 0 1px;
    }

    /* تحسين responsive design */
    @media (max-width: 768px) {
        .info-card {
            margin-bottom: 1rem;
        }

        .info-card .btn {
            padding: 0.875rem 1rem;
            font-size: 0.95rem;
        }
    }

    /* تحسين loading states */
    .btn.loading {
        pointer-events: none;
        opacity: 0.7;
    }

    .btn.loading::after {
        content: "";
        position: absolute;
        width: 16px;
        height: 16px;
        margin: auto;
        border: 2px solid transparent;
        border-top-color: currentColor;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        top: 0;
        left: 0;
        bottom: 0;
        right: 0;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* تحسين موضع SweetAlert2 modals */
    .swal2-container {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        z-index: 10000 !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        padding: 10px !important;
    }

    .swal2-popup {
        position: relative !important;
        max-height: 90vh !important;
        overflow-y: auto !important;
        margin: auto !important;
    }

    /* تحسين RTL للـ modals */
    .swal-rtl .swal2-popup {
        text-align: right !important;
        direction: rtl !important;
    }

    .swal-rtl .swal2-title {
        text-align: center !important;
    }

    .swal-rtl .swal2-html-container {
        text-align: right !important;
    }
    
    /* Touch-friendly modals */
    .modal-content {
        border-radius: 15px;
        padding: 0.5rem;
    }
    
    .modal-header {
        padding: 1rem;
    }
    
    .modal-body {
        padding: 1rem;
    }
    
    .modal-footer {
        padding: 1rem;
    }
    
    .modal-footer .btn {
        width: 100%;
        margin: 0.25rem 0;
    }
    
    @media (min-width: 768px) {
        .modal-content {
            padding: 1rem;
        }
        
        .modal-footer .btn {
            width: auto;
            margin: 0 0.25rem;
        }
    }
    
    /* Responsive text and spacing */
    @media (max-width: 767px) {
        h1 { font-size: 1.5rem; }
        h4 { font-size: 1.2rem; }
        h5 { font-size: 1.1rem; }
        h6 { font-size: 1rem; }
        
        .badge {
            font-size: 0.8rem;
            padding: 0.4rem 0.6rem;
        }
        
        .form-control, .form-select {
            font-size: 16px; /* Prevents zoom on iOS */
        }
    }
    
    .modal-content {
        border-radius: 15px;
    }
    
    .rating-stars {
        color: #ffc107;
        font-size: 1.2rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">



    <!-- Page Header -->
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'complaints:dashboard' %}">لوحة التحكم</a></li>
            <li class="breadcrumb-item"><a href="{% url 'complaints:complaint_list' %}">قائمة الشكاوى</a></li>
            <li class="breadcrumb-item active">{{ complaint.complaint_number }}</li>
        </ol>
    </nav>

    <!-- معلومات الشكوى الأساسية -->
    <div class="complaint-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="mb-2">
                    <i class="fas fa-ticket-alt me-2"></i>
                    شكوى {{ complaint.complaint_number }}
                </h1>
                <h4 class="mb-3">{{ complaint.title }}</h4>
                <div class="row">
                    <div class="col-md-6">
                        <p class="mb-1">
                            <i class="fas fa-user me-2"></i>
                            <strong>العميل:</strong> {{ complaint.customer.name }}
                        </p>
                        <p class="mb-1">
                            <i class="fas fa-phone me-2"></i>
                            {{ complaint.customer.phone }}
                        </p>
                    </div>
                    <div class="col-md-6">
                        <p class="mb-1">
                            <i class="fas fa-calendar me-2"></i>
                            <strong>تاريخ التقديم:</strong> {{ complaint.created_at|date:"Y-m-d H:i" }}
                        </p>
                        <p class="mb-1">
                            <i class="fas fa-clock me-2"></i>
                            <strong>الموعد النهائي:</strong> {{ complaint.deadline|date:"Y-m-d H:i" }}
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-md-4 text-end">
                <div class="mb-3">
                    <span class="badge bg-{{ complaint.get_status_badge_class|slice:'3:' }} fs-6 mb-2">
                        {{ complaint.get_status_display }}
                    </span>
                    <br>
                    <span class="priority-indicator priority-{{ complaint.priority }}" 
                          title="{{ complaint.get_priority_display }}"></span>
                    <span class="text-white">{{ complaint.get_priority_display }}</span>
                </div>
                {% if complaint.is_overdue %}
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    الشكوى متأخرة!
                </div>
                {% endif %}
                {% if complaint.time_remaining %}
                <div class="alert alert-info">
                    <i class="fas fa-hourglass-half me-2"></i>
                    الوقت المتبقي: {{ complaint.time_remaining.days }} يوم
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="row">
        <!-- العمود الأيسر - معلومات الشكوى -->
        <div class="col-md-8">
            <!-- وصف الشكوى -->
            <div class="info-card">
                <h5 class="mb-3">
                    <i class="fas fa-align-left me-2"></i>
                    وصف الشكوى
                </h5>
                <div class="border-start border-primary border-3 ps-3">
                    {{ complaint.description|linebreaks }}
                </div>
            </div>

            <!-- معلومات مرتبطة -->
            {% if complaint.related_order %}
            <div class="related-info">
                <h6><i class="fas fa-link me-2"></i>الطلب المرتبط</h6>
                <p class="mb-0">
                    <a href="{% url 'orders:order_detail' complaint.related_order.pk %}" class="text-decoration-none">
                        طلب #{{ complaint.related_order.order_number }}
                    </a>
                    - {{ complaint.related_order.customer.name }}
                </p>
            </div>
            {% endif %}

            <!-- سجل التحديثات -->
            <div class="info-card">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">
                        <i class="fas fa-history me-2"></i>
                        سجل التحديثات والإجراءات
                    </h5>
                    <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addUpdateModal">
                        <i class="fas fa-plus me-1"></i>
                        إضافة تحديث
                    </button>
                </div>

                <div class="timeline">
                    {% for update in updates %}
                    <div class="timeline-item {{ update.update_type }}">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="mb-0">{{ update.title }}</h6>
                            <small class="text-muted">{{ update.created_at|date:"Y-m-d H:i" }}</small>
                        </div>
                        <p class="mb-2">{{ update.description|linebreaks }}</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                <i class="fas fa-user me-1"></i>
                                {{ update.created_by.get_full_name|default:update.created_by.username }}
                            </small>
                            {% if update.is_visible_to_customer %}
                            <span class="badge bg-success">مرئي للعميل</span>
                            {% else %}
                            <span class="badge bg-secondary">داخلي</span>
                            {% endif %}
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-info-circle me-2"></i>
                        لا توجد تحديثات بعد
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- المرفقات -->
            <div class="info-card">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">
                        <i class="fas fa-paperclip me-2"></i>
                        المرفقات
                    </h5>
                    <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addAttachmentModal">
                        <i class="fas fa-upload me-1"></i>
                        إضافة مرفق
                    </button>
                </div>

                {% for attachment in attachments %}
                <div class="attachment-item">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="mb-1">
                                <i class="fas fa-file me-1"></i>
                                <a href="{{ attachment.file.url }}" target="_blank" class="text-decoration-none">
                                    {{ attachment.filename }}
                                </a>
                            </h6>
                            {% if attachment.description %}
                            <p class="mb-1 text-muted">{{ attachment.description }}</p>
                            {% endif %}
                            <small class="text-muted">
                                رفع بواسطة: {{ attachment.uploaded_by.get_full_name }}
                                في {{ attachment.uploaded_at|date:"Y-m-d H:i" }}
                            </small>
                        </div>
                        <div class="text-end">
                            {% if attachment.file_size %}
                            <small class="text-muted d-block">
                                {% if attachment.file_size < 1024 %}
                                    {{ attachment.file_size }} بايت
                                {% elif attachment.file_size < 1048576 %}
                                    {{ attachment.file_size|divide:1024|floatformat:1 }} ك.ب
                                {% else %}
                                    {{ attachment.file_size|divide:1048576|floatformat:1 }} م.ب
                                {% endif %}
                            </small>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="text-center text-muted py-3">
                    <i class="fas fa-folder-open me-2"></i>
                    لا توجد مرفقات
                </div>
                {% endfor %}
            </div>

            <!-- تقييم العميل -->
            {% if complaint.customer_rating %}
            <div class="info-card">
                <h5 class="mb-3">
                    <i class="fas fa-star me-2"></i>
                    تقييم العميل
                </h5>
                <div class="rating-stars mb-2">
                    {% for i in "12345" %}
                        {% if forloop.counter <= complaint.customer_rating %}
                            <i class="fas fa-star"></i>
                        {% else %}
                            <i class="far fa-star"></i>
                        {% endif %}
                    {% endfor %}
                    <span class="ms-2">{{ complaint.get_customer_rating_display }}</span>
                </div>
                {% if complaint.customer_feedback %}
                <div class="border-start border-warning border-3 ps-3">
                    {{ complaint.customer_feedback|linebreaks }}
                </div>
                {% endif %}
            </div>
            {% endif %}
        </div>

        <!-- العمود الأيمن - الإجراءات والمعلومات الجانبية -->
        <div class="col-md-4">
            <!-- إجراءات سريعة -->
            <!-- قسم الإجراءات السريعة المحدث والمنظم -->
            <div class="info-card">
                <h5 class="mb-4">
                    <i class="fas fa-bolt me-2 text-primary"></i>
                    إجراءات الشكوى
                </h5>

                <!-- الإجراءات الأساسية -->
                {% if complaint.status not in 'resolved,closed' %}
                <div class="mb-4">
                    <h6 class="text-muted mb-3 border-bottom pb-2">
                        <i class="fas fa-cog me-1"></i>
                        الإجراءات الأساسية
                    </h6>

                    <div class="d-grid gap-2">

                        {% if complaint.status not in 'resolved,pending_evaluation,closed' %}
                        <a href="{% url 'complaints:complaint_edit' complaint.pk %}" class="btn btn-outline-primary">
                            <i class="fas fa-edit me-2"></i>
                            تعديل الشكوى
                        </a>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <!-- الإجراءات السريعة حسب حالة الشكوى -->
                <div class="mb-4">
                    <h6 class="text-muted mb-3 border-bottom pb-2">
                        <i class="fas fa-zap me-1"></i>
                        إجراءات سريعة
                    </h6>

                    <div class="d-grid gap-2">
                        {% if complaint.status == 'new' %}
                            <!-- شكوى جديدة -->
                            <div class="alert alert-info alert-sm mb-3">
                                <i class="fas fa-info-circle me-1"></i>
                                <strong>شكوى جديدة:</strong> ابدأ العمل أو قم بإسنادها
                            </div>

                            <button data-quick-action="status"
                                    data-complaint-id="{{ complaint.pk }}"
                                    data-value="in_progress"
                                    class="btn btn-warning">
                                <i class="fas fa-play me-2"></i>
                                بدء العمل على الشكوى
                            </button>

                            <button data-quick-action="assign"
                                    data-complaint-id="{{ complaint.pk }}"
                                    class="btn btn-info">
                                <i class="fas fa-user-plus me-2"></i>
                                إسناد الشكوى
                            </button>

                        {% elif complaint.status == 'in_progress' %}
                            <!-- شكوى قيد المعالجة -->
                            <div class="alert alert-warning alert-sm mb-3">
                                <i class="fas fa-clock me-1"></i>
                                <strong>قيد المعالجة:</strong> اختر الإجراء المناسب
                            </div>

                            <button data-quick-action="status"
                                    data-complaint-id="{{ complaint.pk }}"
                                    data-value="resolved"
                                    class="btn btn-success">
                                <i class="fas fa-check me-2"></i>
                                حل الشكوى
                            </button>

                            <button data-quick-action="assign"
                                    data-complaint-id="{{ complaint.pk }}"
                                    class="btn btn-info">
                                <i class="fas fa-user-edit me-2"></i>
                                إعادة إسناد
                            </button>

                            <button data-quick-action="escalate"
                                    data-complaint-id="{{ complaint.pk }}"
                                    class="btn btn-danger">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                تصعيد الشكوى
                            </button>

                        {% elif complaint.status == 'resolved' %}
                            <!-- شكوى محلولة - تحويل لبحاجة تقييم -->
                            <div class="alert alert-success alert-sm mb-3">
                                <i class="fas fa-check-circle me-1"></i>
                                <strong>تم الحل:</strong> سيتم تحويلها لبحاجة تقييم
                            </div>

                            <button data-quick-action="status"
                                    data-complaint-id="{{ complaint.pk }}"
                                    data-value="pending_evaluation"
                                    class="btn btn-warning">
                                <i class="fas fa-star-half-alt me-2"></i>
                                تحويل لبحاجة تقييم
                            </button>

                        {% elif complaint.status == 'pending_evaluation' %}
                            <!-- شكوى بحاجة تقييم -->
                            <div class="alert alert-warning alert-sm mb-3">
                                <i class="fas fa-star-half-alt me-1"></i>
                                <strong>بحاجة تقييم:</strong> في انتظار تقييم العميل
                            </div>

                            {% if not complaint.is_evaluated %}
                                <a href="{% url 'complaints:create_evaluation' complaint.pk %}"
                                   class="btn btn-primary">
                                    <i class="fas fa-star me-2"></i>
                                    إضافة تقييم
                                </a>
                            {% else %}
                                <div class="alert alert-success mb-3">
                                    <i class="fas fa-star me-2"></i>
                                    <strong>تم التقييم:</strong>
                                    <span class="badge bg-success ms-2">{{ complaint.evaluation.overall_rating }}/5</span>
                                    {% for i in "12345" %}
                                        {% if forloop.counter <= complaint.evaluation.overall_rating %}
                                            <i class="fas fa-star text-warning"></i>
                                        {% else %}
                                            <i class="far fa-star text-muted"></i>
                                        {% endif %}
                                    {% endfor %}
                                </div>

                                <button data-quick-action="status"
                                        data-complaint-id="{{ complaint.pk }}"
                                        data-value="closed"
                                        class="btn btn-success">
                                    <i class="fas fa-archive me-2"></i>
                                    إغلاق الشكوى نهائياً
                                </button>
                            {% endif %}

                        {% elif complaint.status == 'escalated' %}
                            <!-- شكوى مصعدة -->
                            <div class="alert alert-danger alert-sm mb-3">
                                <i class="fas fa-exclamation-triangle me-1"></i>
                                <strong>مصعدة:</strong> تحتاج تدخل إداري
                            </div>

                            <button data-quick-action="status"
                                    data-complaint-id="{{ complaint.pk }}"
                                    data-value="in_progress"
                                    class="btn btn-warning">
                                <i class="fas fa-undo me-2"></i>
                                إرجاع للمعالجة
                            </button>

                            <button data-quick-action="assign"
                                    data-complaint-id="{{ complaint.pk }}"
                                    class="btn btn-info">
                                <i class="fas fa-user-edit me-2"></i>
                                إعادة إسناد
                            </button>

                        {% elif complaint.status == 'closed' %}
                            <!-- شكوى مغلقة -->
                            {% if complaint.is_fully_completed %}
                                <div class="alert alert-success mb-3">
                                    <i class="fas fa-check-double me-2"></i>
                                    <strong>منتهية تماماً</strong>
                                    <br>
                                    <small class="text-muted">تم الحل والتقييم والإغلاق</small>
                                </div>

                                {% if complaint.evaluation %}
                                    <div class="card border-success mb-3">
                                        <div class="card-header bg-success text-white">
                                            <i class="fas fa-star me-2"></i>تقييم العميل النهائي
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-6">
                                                    <small class="text-muted">التقييم العام</small>
                                                    <div class="h5 text-warning">
                                                        {% for i in "12345" %}
                                                            {% if forloop.counter <= complaint.evaluation.overall_rating %}
                                                                <i class="fas fa-star"></i>
                                                            {% else %}
                                                                <i class="far fa-star"></i>
                                                            {% endif %}
                                                        {% endfor %}
                                                        <span class="text-muted ms-2">{{ complaint.evaluation.overall_rating }}/5</span>
                                                    </div>
                                                </div>
                                                <div class="col-6">
                                                    <small class="text-muted">متوسط التقييم</small>
                                                    <div class="h5 text-{{ complaint.evaluation.rating_color }}">
                                                        {{ complaint.evaluation.average_rating|floatformat:1 }}/5
                                                    </div>
                                                </div>
                                            </div>
                                            {% if complaint.evaluation.positive_feedback %}
                                                <div class="mt-2">
                                                    <small class="text-success fw-bold">التعليقات الإيجابية:</small>
                                                    <p class="mb-1">{{ complaint.evaluation.positive_feedback }}</p>
                                                </div>
                                            {% endif %}
                                            {% if complaint.evaluation.would_recommend %}
                                                <span class="badge bg-success mt-2">
                                                    <i class="fas fa-thumbs-up me-1"></i>ينصح بالخدمة
                                                </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endif %}
                            {% else %}
                                <div class="alert alert-secondary mb-3">
                                    <i class="fas fa-archive me-2"></i>
                                    <strong>الشكوى مغلقة</strong>
                                    <br>
                                    <small class="text-muted">لا توجد إجراءات متاحة</small>
                                </div>
                            {% endif %}

                        {% elif complaint.status == 'cancelled' %}
                            <!-- شكوى ملغية -->
                            <div class="alert alert-dark mb-3">
                                <i class="fas fa-ban me-2"></i>
                                <strong>الشكوى ملغية</strong>
                                <br>
                                <small class="text-muted">لا توجد إجراءات متاحة</small>
                            </div>

                        {% else %}
                            <!-- حالة غير معروفة -->
                            <div class="alert alert-warning mb-3">
                                <i class="fas fa-question-circle me-2"></i>
                                <strong>حالة غير معروفة:</strong> {{ complaint.get_status_display }}
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- إجراءات إضافية -->
                {% if complaint.status not in 'closed,cancelled' %}
                <div class="mb-3">
                    <h6 class="text-muted mb-3 border-bottom pb-2">
                        <i class="fas fa-plus me-1"></i>
                        إجراءات إضافية
                    </h6>

                    <div class="d-grid gap-2">
                        <button data-quick-action="note"
                                data-complaint-id="{{ complaint.pk }}"
                                class="btn btn-outline-secondary">
                            <i class="fas fa-sticky-note me-2"></i>
                            إضافة ملاحظة
                        </button>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- معلومات إضافية -->
            <div class="info-card">
                <h5 class="mb-3">
                    <i class="fas fa-info-circle me-2"></i>
                    معلومات إضافية
                </h5>
                <table class="table table-borderless table-sm">
                    <tr>
                        <td><strong>نوع الشكوى:</strong></td>
                        <td>{{ complaint.complaint_type.name }}</td>
                    </tr>
                    <tr>
                        <td><strong>المسؤول:</strong></td>
                        <td>
                            {% if complaint.assigned_to %}
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-user me-2 text-primary"></i>
                                    <div>
                                        <strong>
                                            {% if complaint.assigned_to.get_full_name %}
                                                {{ complaint.assigned_to.get_full_name }}
                                            {% else %}
                                                {{ complaint.assigned_to.username }}
                                            {% endif %}
                                        </strong>
                                        {% if complaint.assigned_to.email %}
                                            <br><small class="text-muted">{{ complaint.assigned_to.email }}</small>
                                        {% endif %}
                                    </div>
                                </div>
                            {% else %}
                                <span class="text-danger">
                                    <i class="fas fa-exclamation-triangle me-1"></i>
                                    غير مُعين
                                </span>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td><strong>القسم:</strong></td>
                        <td>
                            {% if complaint.assigned_department %}
                                {{ complaint.assigned_department.name }}
                            {% else %}
                                <span class="text-muted">غير محدد</span>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td><strong>الفرع:</strong></td>
                        <td>
                            {% if complaint.branch %}
                                {{ complaint.branch.name }}
                            {% else %}
                                <span class="text-muted">غير محدد</span>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td><strong>تم الإنشاء بواسطة:</strong></td>
                        <td>
                            {% if complaint.created_by %}
                                {{ complaint.created_by.get_full_name }}
                            {% else %}
                                <span class="text-muted">غير محدد</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% if complaint.resolved_at %}
                    <tr>
                        <td><strong>تاريخ الحل:</strong></td>
                        <td>{{ complaint.resolved_at|date:"Y-m-d H:i" }}</td>
                    </tr>
                    {% endif %}
                    {% if complaint.resolution_time %}
                    <tr>
                        <td><strong>وقت الحل:</strong></td>
                        <td>{{ complaint.resolution_time.days }} يوم</td>
                    </tr>
                    {% endif %}
                </table>
            </div>

            <!-- الإشعارات -->
            {% if notifications %}
            <div class="info-card">
                <h5 class="mb-3">
                    <i class="fas fa-bell me-2"></i>
                    الإشعارات
                </h5>
                {% for notification in notifications|slice:":5" %}
                <div class="mb-2 pb-2 border-bottom">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="mb-1">{{ notification.title }}</h6>
                            <small class="text-muted">{{ notification.created_at|date:"Y-m-d H:i" }}</small>
                        </div>
                        {% if not notification.is_read %}
                        <span class="badge bg-primary">جديد</span>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
                {% if notifications.count > 5 %}
                <div class="text-center">
                    <a href="{% url 'complaints:notifications_list' %}" class="btn btn-sm btn-outline-primary">
                        عرض جميع الإشعارات
                    </a>
                </div>
                {% endif %}
            </div>
            {% endif %}

            <!-- التصعيدات -->
            {% if escalations %}
            <div class="info-card">
                <h5 class="mb-3">
                    <i class="fas fa-arrow-up me-2"></i>
                    سجل التصعيدات
                </h5>
                {% for escalation in escalations %}
                <div class="mb-2 pb-2 border-bottom">
                    <h6 class="mb-1">{{ escalation.get_reason_display }}</h6>
                    <p class="mb-1 text-muted small">{{ escalation.description|truncatechars:100 }}</p>
                    <small class="text-muted">
                        من: {{ escalation.escalated_from.get_full_name|default:"غير محدد" }}
                        إلى: {{ escalation.escalated_to.get_full_name|default:"غير محدد" }}
                        <br>
                        {{ escalation.escalated_at|date:"Y-m-d H:i" }}
                    </small>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modals -->
<!-- إضافة تحديث -->
<div class="modal fade" id="addUpdateModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">إضافة تحديث</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'complaints:complaint_add_update' complaint.pk %}">
                <div class="modal-body">
                    {% csrf_token %}
                    <div class="mb-3">
                        {{ update_form.update_type.label_tag }}
                        {{ update_form.update_type }}
                    </div>
                    <div class="mb-3">
                        {{ update_form.title.label_tag }}
                        {{ update_form.title }}
                    </div>
                    <div class="mb-3">
                        {{ update_form.description.label_tag }}
                        {{ update_form.description }}
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            {{ update_form.is_visible_to_customer }}
                            {{ update_form.is_visible_to_customer.label_tag }}
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="submit" class="btn btn-primary">إضافة التحديث</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- تحديث الحالة -->
<div class="modal fade" id="statusModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">تحديث حالة الشكوى</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'complaints:complaint_status_update' complaint.pk %}">
                <div class="modal-body">
                    {% csrf_token %}
                    <div class="mb-3">
                        {{ status_form.status.label_tag }}
                        {{ status_form.status }}
                        {% if status_form.status.errors %}
                            <div class="text-danger small">{{ status_form.status.errors }}</div>
                        {% endif %}
                    </div>

                    <!-- Resolution method selection (shown when status is resolved) -->
                    <div class="mb-3" id="resolution-method-field" style="display: none;">
                        <label for="id_resolution_method" class="form-label">طريقة الحل</label>
                        <select name="resolution_method" id="id_resolution_method" class="form-select">
                            <option value="">اختر طريقة الحل...</option>
                        </select>
                        <div class="form-text">اختر الطريقة المستخدمة لحل الشكوى</div>
                    </div>

                    <div class="mb-3">
                        {{ status_form.notes.label_tag }}
                        {{ status_form.notes }}
                        {% if status_form.notes.errors %}
                            <div class="text-danger small">{{ status_form.notes.errors }}</div>
                        {% endif %}
                        <div class="form-text">{{ status_form.notes.help_text }}</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="submit" class="btn btn-primary">تحديث الحالة</button>
                </div>
            </form>
        </div>
    </div>
</div>



<!-- إضافة مرفق -->
<div class="modal fade" id="addAttachmentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">إضافة مرفق</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'complaints:complaint_add_attachment' complaint.pk %}" enctype="multipart/form-data">
                <div class="modal-body">
                    {% csrf_token %}
                    <div class="mb-3">
                        {{ attachment_form.file.label_tag }}
                        {{ attachment_form.file }}
                    </div>
                    <div class="mb-3">
                        {{ attachment_form.description.label_tag }}
                        {{ attachment_form.description }}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="submit" class="btn btn-primary">رفع المرفق</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- تقييم العميل -->
<div class="modal fade" id="ratingModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">تقييم الخدمة</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'complaints:customer_rating' complaint.pk %}">
                <div class="modal-body">
                    {% csrf_token %}
                    <div class="mb-3">
                        {{ rating_form.customer_rating.label_tag }}
                        {{ rating_form.customer_rating }}
                    </div>
                    <div class="mb-3">
                        {{ rating_form.customer_feedback.label_tag }}
                        {{ rating_form.customer_feedback }}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="submit" class="btn btn-primary">حفظ التقييم</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}



{% block extra_js %}
<!-- SweetAlert2 for beautiful modals -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<!-- Load unified quick actions -->
{% load static %}
<script src="{% static 'js/complaints-quick-actions.js' %}"></script>
<script>
    // Handle resolution method selection
    document.addEventListener('DOMContentLoaded', function() {
        const statusSelect = document.getElementById('id_status');
        const resolutionMethodField = document.getElementById('resolution-method-field');
        const resolutionMethodSelect = document.getElementById('id_resolution_method');

        // Load resolution methods
        function loadResolutionMethods() {
            fetch('/complaints/api/resolution-methods/')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        resolutionMethodSelect.innerHTML = '<option value="">اختر طريقة الحل...</option>';
                        data.methods.forEach(method => {
                            const option = document.createElement('option');
                            option.value = method.id;
                            option.textContent = method.name;
                            resolutionMethodSelect.appendChild(option);
                        });
                    }
                })
                .catch(error => console.error('Error loading resolution methods:', error));
        }

        // Show/hide resolution method field based on status
        function toggleResolutionMethod() {
            if (statusSelect && statusSelect.value === 'resolved') {
                resolutionMethodField.style.display = 'block';
                resolutionMethodSelect.required = true;
                if (resolutionMethodSelect.children.length <= 1) {
                    loadResolutionMethods();
                }
            } else {
                resolutionMethodField.style.display = 'none';
                resolutionMethodSelect.required = false;
            }
        }

        // Initialize and add event listener
        if (statusSelect) {
            toggleResolutionMethod();
            statusSelect.addEventListener('change', toggleResolutionMethod);
        }
    });

    // تحديث الإشعارات تلقائياً
    setInterval(function() {
        // يمكن إضافة AJAX call لتحديث الإشعارات
    }, 30000); // كل 30 ثانية
</script>
{% endblock %}
