{% extends 'base.html' %}
{% load static %}
{% block title %}تحليل الشكاوى وطرق الحل{% endblock %}
{% block extra_css %}<link rel="stylesheet" href="{% static 'css/complaints-module.css' %}?v={% now 'U' %}">{% endblock %}

{% block content %}
<div class="container-fluid cm-page">

    <div class="cm-page-header mb-4">
        <h2 class="mb-1"><i class="fas fa-chart-line me-2"></i>تحليل الشكاوى وطرق الحل</h2>
        <p class="mb-0" style="opacity:.85">من {{ start_date|date:"Y-m-d" }} إلى {{ end_date|date:"Y-m-d" }}</p>
    </div>

    {# Period filter #}
    <div class="cm-card mb-4">
        <div class="cm-card-body py-2">
            <form method="get" class="d-flex align-items-center gap-3">
                <label class="fw-semibold mb-0">الفترة:</label>
                <select name="period" class="form-select form-select-sm" style="width:auto" onchange="this.form.submit()">
                    <option value="1month" {% if period == '1month' %}selected{% endif %}>شهر</option>
                    <option value="3months" {% if period == '3months' %}selected{% endif %}>3 أشهر</option>
                    <option value="6months" {% if period == '6months' %}selected{% endif %}>6 أشهر</option>
                    <option value="1year" {% if period == '1year' %}selected{% endif %}>سنة</option>
                </select>
            </form>
        </div>
    </div>

    {# Stats #}
    <div class="row g-3 mb-4">
        <div class="col-6 col-md-3"><div class="cm-stat"><div class="cm-stat-value">{{ total_complaints }}</div><div class="cm-stat-label">إجمالي</div></div></div>
        <div class="col-6 col-md-3"><div class="cm-stat"><div class="cm-stat-value text-success">{{ total_resolved }}</div><div class="cm-stat-label">محلولة</div></div></div>
        <div class="col-6 col-md-3"><div class="cm-stat"><div class="cm-stat-value text-primary">{{ resolution_rate }}%</div><div class="cm-stat-label">معدل الحل</div></div></div>
        <div class="col-6 col-md-3"><div class="cm-stat"><div class="cm-stat-value">{{ resolution_methods_stats|length }}</div><div class="cm-stat-label">طرق الحل</div></div></div>
    </div>

    <div class="row g-3 mb-4">
        {# Resolution methods #}
        <div class="col-md-6">
            <div class="cm-card"><div class="cm-card-header"><h6><i class="fas fa-tools me-2 text-primary"></i>أكثر طرق الحل استخداماً</h6></div>
                <div class="cm-card-body p-0 px-3">
                    {% for m in resolution_methods_stats %}
                    <div class="cm-leaderboard-item">
                        <span class="fw-semibold" style="font-size:.85rem">{{ m.resolution_method__name|default:"غير محدد" }}</span>
                        <div class="d-flex gap-3" style="font-size:.8rem;color:#6c757d"><span><i class="fas fa-hashtag me-1"></i>{{ m.count }}</span><span><i class="fas fa-clock me-1"></i>{{ m.avg_resolution_hours|floatformat:1 }}ساعة</span></div>
                    </div>
                    {% empty %}<div class="cm-empty py-3"><p>لا توجد بيانات</p></div>{% endfor %}
                </div>
            </div>
        </div>
        {# Satisfaction #}
        <div class="col-md-6">
            <div class="cm-card"><div class="cm-card-header"><h6><i class="fas fa-star me-2 text-warning"></i>رضا العملاء</h6></div>
                <div class="cm-card-body p-0 px-3">
                    {% for m in customer_satisfaction %}
                    <div class="cm-leaderboard-item">
                        <span class="fw-semibold" style="font-size:.85rem">{{ m.resolution_method__name }}</span>
                        <div class="d-flex gap-3" style="font-size:.8rem"><span class="text-warning"><i class="fas fa-star me-1"></i>{{ m.avg_rating|floatformat:1 }}/5</span><span class="text-muted"><i class="fas fa-users me-1"></i>{{ m.count }}</span></div>
                    </div>
                    {% empty %}<div class="cm-empty py-3"><p>لا توجد تقييمات</p></div>{% endfor %}
                </div>
            </div>
        </div>
    </div>

    <div class="row g-3 mb-4">
        {# Fastest #}
        <div class="col-md-6">
            <div class="cm-card"><div class="cm-card-header"><h6><i class="fas fa-tachometer-alt me-2 text-success"></i>أسرع طرق الحل</h6></div>
                <div class="cm-card-body p-0 px-3">
                    {% for m in fastest_methods %}
                    <div class="cm-leaderboard-item">
                        <span class="fw-semibold" style="font-size:.85rem">{{ m.resolution_method__name }}</span>
                        <div class="d-flex gap-3" style="font-size:.8rem"><span class="text-success"><i class="fas fa-clock me-1"></i>{{ m.avg_hours|floatformat:1 }}ساعة</span><span class="text-muted">{{ m.count }} حالة</span></div>
                    </div>
                    {% empty %}<div class="cm-empty py-3"><p>لا توجد بيانات</p></div>{% endfor %}
                </div>
            </div>
        </div>
        {# Type vs resolution #}
        <div class="col-md-6">
            <div class="cm-card"><div class="cm-card-header"><h6><i class="fas fa-chart-pie me-2 text-info"></i>النوع مقابل طريقة الحل</h6></div>
                <div class="cm-card-body" style="max-height:300px;overflow-y:auto">
                    {% regroup type_resolution_analysis by complaint_type__name as grouped %}
                    {% for g in grouped %}
                    <div class="mb-3">
                        <h6 class="text-primary mb-1" style="font-size:.85rem">{{ g.grouper }}</h6>
                        {% for i in g.list %}
                        <div class="d-flex justify-content-between align-items-center ps-3 mb-1">
                            <small>{{ i.resolution_method__name|default:"غير محدد" }}</small>
                            <span class="badge bg-secondary">{{ i.count }}</span>
                        </div>
                        {% endfor %}
                    </div>
                    {% empty %}<div class="cm-empty py-3"><p>لا توجد بيانات</p></div>{% endfor %}
                </div>
            </div>
        </div>
    </div>

    {# Monthly trend #}
    {% if monthly_analysis %}
    <div class="cm-card">
        <div class="cm-card-header"><h6><i class="fas fa-chart-line me-2"></i>الاتجاه الشهري</h6></div>
        <div class="cm-card-body">
            <div class="table-responsive">
                <table class="cm-table">
                    <thead><tr><th>الشهر</th><th>إجمالي</th><th>محلولة</th><th>مصعدة</th><th>متأخرة</th><th>معدل الحل</th></tr></thead>
                    <tbody>
                    {% for d in monthly_analysis %}
                    <tr>
                        <td>{{ d.month|date:"F Y" }}</td>
                        <td>{{ d.total }}</td>
                        <td><span class="cm-badge cm-badge-resolved">{{ d.resolved }}</span></td>
                        <td><span class="cm-badge cm-badge-escalated">{{ d.escalated }}</span></td>
                        <td><span class="cm-badge cm-badge-overdue">{{ d.overdue }}</span></td>
                        <td>{% if d.total > 0 %}{% widthratio d.resolved d.total 100 %}%{% else %}0%{% endif %}</td>
                    </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}
