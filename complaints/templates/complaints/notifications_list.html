{% extends 'base.html' %}
{% load static %}
{% block title %}الإشعارات - نظام الخواجه{% endblock %}
{% block extra_css %}<link rel="stylesheet" href="{% static 'css/complaints-module.css' %}?v={% now 'U' %}">{% endblock %}

{% block content %}
<div class="container-fluid cm-page">

    <nav aria-label="breadcrumb" class="mb-3"><ol class="breadcrumb" style="font-size:.85rem"><li class="breadcrumb-item"><a href="{% url 'complaints:dashboard' %}">الشكاوى</a></li><li class="breadcrumb-item active">الإشعارات</li></ol></nav>

    <div class="cm-page-header mb-4">
        <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
            <div><h2 class="mb-0"><i class="fas fa-bell me-2"></i>الإشعارات</h2></div>
            <button type="button" class="btn btn-light btn-sm" onclick="markAllAsRead()"><i class="fas fa-check-double me-1"></i>تعليم الكل كمقروء</button>
        </div>
    </div>

    {# Stats #}
    <div class="row g-3 mb-4">
        <div class="col-6 col-md-3"><div class="cm-stat"><div class="cm-stat-value">{{ stats.total_notifications }}</div><div class="cm-stat-label">إجمالي</div></div></div>
        <div class="col-6 col-md-3"><div class="cm-stat"><div class="cm-stat-value text-primary">{{ stats.unread_notifications }}</div><div class="cm-stat-label">غير مقروءة</div></div></div>
        <div class="col-6 col-md-3"><div class="cm-stat"><div class="cm-stat-value text-danger">{{ stats.urgent_notifications }}</div><div class="cm-stat-label">عاجلة</div></div></div>
        <div class="col-6 col-md-3"><div class="cm-stat"><div class="cm-stat-value text-success">{{ stats.today_notifications }}</div><div class="cm-stat-label">اليوم</div></div></div>
    </div>

    {# Filters #}
    <div class="cm-filter mb-3">
        <div class="cm-filter-header" data-bs-toggle="collapse" data-bs-target="#notifFilters"><h6><i class="fas fa-filter me-2"></i>فلاتر</h6><i class="fas fa-chevron-down"></i></div>
        <div class="collapse {% if request.GET %}show{% endif %}" id="notifFilters">
            <div class="cm-filter-body">
                <form method="get" class="row g-2">
                    <div class="col-md-3"><select name="notification_type" class="form-select form-select-sm"><option value="">جميع الأنواع</option><option value="info" {% if request.GET.notification_type == 'info' %}selected{% endif %}>معلوماتي</option><option value="urgent" {% if request.GET.notification_type == 'urgent' %}selected{% endif %}>عاجل</option><option value="warning" {% if request.GET.notification_type == 'warning' %}selected{% endif %}>تحذير</option><option value="success" {% if request.GET.notification_type == 'success' %}selected{% endif %}>نجاح</option></select></div>
                    <div class="col-md-3"><select name="status" class="form-select form-select-sm"><option value="">الكل</option><option value="unread" {% if request.GET.status == 'unread' %}selected{% endif %}>غير مقروءة</option><option value="read" {% if request.GET.status == 'read' %}selected{% endif %}>مقروءة</option></select></div>
                    <div class="col-md-3"><select name="date_range" class="form-select form-select-sm"><option value="">كل الفترات</option><option value="today" {% if request.GET.date_range == 'today' %}selected{% endif %}>اليوم</option><option value="week" {% if request.GET.date_range == 'week' %}selected{% endif %}>الأسبوع</option><option value="month" {% if request.GET.date_range == 'month' %}selected{% endif %}>الشهر</option></select></div>
                    <div class="col-md-3 d-flex gap-2"><button type="submit" class="btn btn-primary btn-sm flex-grow-1"><i class="fas fa-filter me-1"></i>تطبيق</button>{% if request.GET %}<a href="{% url 'complaints:notifications_list' %}" class="btn btn-outline-secondary btn-sm"><i class="fas fa-times"></i></a>{% endif %}</div>
                </form>
            </div>
        </div>
    </div>

    {# Bulk actions #}
    <div class="alert alert-light py-2 d-none" id="bulkActions">
        <div class="d-flex justify-content-between align-items-center">
            <span><strong id="selectedCount">0</strong> محدد</span>
            <div class="d-flex gap-2"><button class="btn btn-primary btn-sm" onclick="markSelectedAsRead()"><i class="fas fa-check me-1"></i>مقروء</button><button class="btn btn-danger btn-sm" onclick="deleteSelected()"><i class="fas fa-trash me-1"></i>حذف</button></div>
        </div>
    </div>

    {# Notifications list #}
    {% for n in notifications %}
    <div class="cm-notif {% if not n.is_read %}unread{% endif %}">
        <div class="d-flex align-items-start gap-3">
            <input type="checkbox" class="form-check-input notif-cb mt-1" value="{{ n.id }}" onchange="updateBulk()">
            <div class="cm-stat-icon" style="width:36px;height:36px;font-size:.9rem;flex-shrink:0;background:{% if n.notification_type == 'urgent' %}var(--cm-red){% elif n.notification_type == 'warning' %}var(--cm-amber){% elif n.notification_type == 'success' %}var(--cm-green){% else %}var(--cm-primary){% endif %}">
                <i class="fas fa-{% if n.notification_type == 'urgent' %}exclamation-triangle{% elif n.notification_type == 'warning' %}exclamation-circle{% elif n.notification_type == 'success' %}check-circle{% else %}info-circle{% endif %}"></i>
            </div>
            <div class="flex-grow-1">
                <div class="d-flex justify-content-between align-items-start">
                    <h6 class="mb-1 {% if not n.is_read %}fw-bold{% endif %}" style="font-size:.9rem">{{ n.title }}</h6>
                    <div class="d-flex align-items-center gap-2">
                        {% if not n.is_read %}<span class="cm-badge cm-badge-new" style="font-size:.7rem">جديد</span>{% endif %}
                        <div class="dropdown"><button class="btn btn-sm btn-link text-muted p-0" data-bs-toggle="dropdown"><i class="fas fa-ellipsis-v"></i></button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                {% if not n.is_read %}<li><a class="dropdown-item" href="javascript:void(0)" onclick="markAsRead({{ n.id }})"><i class="fas fa-check me-2"></i>مقروء</a></li>{% endif %}
                                <li><a class="dropdown-item text-danger" href="javascript:void(0)" onclick="deleteNotification({{ n.id }})"><i class="fas fa-trash me-2"></i>حذف</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
                <p class="mb-1 text-muted" style="font-size:.85rem">{{ n.message|truncatechars:150 }}</p>
                <div class="d-flex gap-3" style="font-size:.78rem;color:#6c757d">
                    <span><i class="fas fa-clock me-1"></i>{{ n.created_at|date:"Y-m-d H:i" }}</span>
                    {% if n.content_object %}<a href="{% url 'complaints:complaint_detail' n.content_object.pk %}" class="text-decoration-none"><i class="fas fa-ticket-alt me-1"></i>{{ n.content_object.complaint_number }}</a>{% endif %}
                </div>
            </div>
        </div>
    </div>
    {% empty %}
    <div class="cm-empty"><i class="fas fa-bell-slash"></i><h5>لا توجد إشعارات</h5></div>
    {% endfor %}

    {# Pagination #}
    {% if notifications.has_other_pages %}
    <nav><ul class="pagination justify-content-center mt-3">
        {% if notifications.has_previous %}<li class="page-item"><a class="page-link" href="?page={{ notifications.previous_page_number }}"><i class="fas fa-chevron-right"></i></a></li>{% endif %}
        {% for num in notifications.paginator.page_range %}{% if notifications.number == num %}<li class="page-item active"><span class="page-link">{{ num }}</span></li>{% elif num > notifications.number|add:'-3' and num < notifications.number|add:'3' %}<li class="page-item"><a class="page-link" href="?page={{ num }}">{{ num }}</a></li>{% endif %}{% endfor %}
        {% if notifications.has_next %}<li class="page-item"><a class="page-link" href="?page={{ notifications.next_page_number }}"><i class="fas fa-chevron-left"></i></a></li>{% endif %}
    </ul></nav>
    {% endif %}
</div>
{% csrf_token %}
{% endblock %}

{% block extra_js %}
<script>
var csrf=document.querySelector('[name=csrfmiddlewaretoken]').value;
function updateBulk(){var c=document.querySelectorAll('.notif-cb:checked'),b=document.getElementById('bulkActions');document.getElementById('selectedCount').textContent=c.length;c.length?b.classList.remove('d-none'):b.classList.add('d-none')}
function markAsRead(id){fetch('/complaints/notifications/'+id+'/mark-read/',{method:'POST',headers:{'X-CSRFToken':csrf,'Content-Type':'application/json'}}).then(function(r){return r.json()}).then(function(d){if(d.success)location.reload()})}
function markAllAsRead(){if(!confirm('تعليم الكل كمقروء؟'))return;fetch('/complaints/notifications/mark-all-read/',{method:'POST',headers:{'X-CSRFToken':csrf,'Content-Type':'application/json'}}).then(function(r){return r.json()}).then(function(d){if(d.success)location.reload()})}
function markSelectedAsRead(){var ids=Array.from(document.querySelectorAll('.notif-cb:checked')).map(function(c){return c.value});if(!ids.length)return;fetch('/complaints/notifications/mark-selected-read/',{method:'POST',headers:{'X-CSRFToken':csrf,'Content-Type':'application/json'},body:JSON.stringify({notification_ids:ids})}).then(function(r){return r.json()}).then(function(d){if(d.success)location.reload()})}
function deleteNotification(id){if(!confirm('حذف هذا الإشعار؟'))return;fetch('/complaints/notifications/'+id+'/delete/',{method:'DELETE',headers:{'X-CSRFToken':csrf,'Content-Type':'application/json'}}).then(function(r){return r.json()}).then(function(d){if(d.success)location.reload()})}
function deleteSelected(){var ids=Array.from(document.querySelectorAll('.notif-cb:checked')).map(function(c){return c.value});if(!ids.length||!confirm('حذف '+ids.length+' إشعار؟'))return;fetch('/complaints/notifications/delete-selected/',{method:'DELETE',headers:{'X-CSRFToken':csrf,'Content-Type':'application/json'},body:JSON.stringify({notification_ids:ids})}).then(function(r){return r.json()}).then(function(d){if(d.success)location.reload()})}
</script>
{% endblock %}
