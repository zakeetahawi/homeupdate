<!DOCTYPE html>
<html>
<head>
    <title>اختبار الإصلاحات الحرجة النهائية</title>
    <meta charset="utf-8">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { border: 1px solid #ddd; margin: 20px 0; padding: 20px; border-radius: 8px; }
        .success { background: #f0f8ff; border-color: #4CAF50; }
        .warning { background: #fff8f0; border-color: #ff9800; }
        .error { background: #fff0f0; border-color: #f44336; }
        .info { background: #f8f8f8; border-color: #2196F3; }
        code { background: #f5f5f5; padding: 2px 4px; border-radius: 3px; }
        .checklist { list-style: none; padding: 0; }
        .checklist li { margin: 8px 0; }
        .checklist li:before { content: "☐ "; margin-right: 8px; }
        .checklist li.done:before { content: "✅ "; }
        .checklist li.fail:before { content: "❌ "; }
    </style>
</head>
<body>
    <h1>🔧 اختبار الإصلاحات الحرجة النهائية</h1>
    
    <div class="test-section success">
        <h2>✅ الإصلاحات المطبقة</h2>
        <ul class="checklist">
            <li class="done">إصلاح مشكلة الصوتين - تعطيل الصوت في showNewMessageNotification</li>
            <li class="done">إصلاح خطأ حذف المحادثة - إضافة فحص للبيانات في updateActiveUsersWidget</li>
            <li class="done">إصلاح عدم ظهور المحادثات - تحديث updated_at للغرفة عند إرسال رسائل</li>
            <li class="done">تحسين حالة المستخدمين - تحديث كل 15 ثانية بدلاً من دقيقة</li>
        </ul>
    </div>
    
    <div class="test-section info">
        <h2>🧪 خطوات الاختبار الشاملة</h2>
        
        <h3>1. اختبار الصوت:</h3>
        <ol>
            <li>افتح متصفحين مختلفين</li>
            <li>سجل دخول بمستخدمين مختلفين</li>
            <li>أرسل رسالة من المستخدم الأول</li>
            <li><strong>النتيجة المتوقعة:</strong> صوت واحد فقط في المستخدم الثاني</li>
            <li>اختبر زر كتم الصوت - يجب أن يوقف الصوت تماماً</li>
        </ol>
        
        <h3>2. اختبار قائمة المحادثات:</h3>
        <ol>
            <li>أرسل رسالة جديدة</li>
            <li>افتح قائمة المحادثات</li>
            <li><strong>النتيجة المتوقعة:</strong> يجب أن تظهر المحادثة في القائمة</li>
            <li>تحقق من آخر رسالة ووقتها</li>
        </ol>
        
        <h3>3. اختبار حذف المحادثة:</h3>
        <ol>
            <li>انقر بالزر الأيمن على محادثة في القائمة</li>
            <li>اختر "حذف المحادثة"</li>
            <li><strong>النتيجة المتوقعة:</strong> لا أخطاء في console</li>
            <li>المحادثة تُحذف من القائمة</li>
        </ol>
        
        <h3>4. اختبار حالة المستخدمين:</h3>
        <ol>
            <li>أغلق أحد المتصفحين</li>
            <li>انتظر 20 ثانية</li>
            <li>في المتصفح الآخر، تحقق من قائمة المستخدمين</li>
            <li><strong>النتيجة المتوقعة:</strong> المستخدم يظهر كـ "غير متصل"</li>
        </ol>
    </div>
    
    <div class="test-section warning">
        <h2>⚠️ رسائل Console المتوقعة</h2>
        
        <h3>عند فتح الصفحة:</h3>
        <pre><code>تهيئة ChatManager...
تم تهيئة ChatManager بنجاح
تحميل قائمة المحادثات...
بيانات المحادثات: {rooms: Array(1), count: 1}
عدد المحادثات: 1</code></pre>
        
        <h3>عند إرسال رسالة:</h3>
        <pre><code>معالجة رسالة واردة: [MESSAGE_OBJECT]
تحميل قائمة المحادثات...
بيانات المحادثات: {rooms: Array(1), count: 1}</code></pre>
        
        <h3>عند كتم الصوت:</h3>
        <pre><code>تبديل كتم الصوت للغرفة: [ROOM_ID]
تم كتم الصوت
الصوت مكتوم للغرفة: [ROOM_ID]</code></pre>
        
        <h3>عند حذف المحادثة:</h3>
        <pre><code>تم حذف المحادثة بنجاح
تحميل قائمة المحادثات...</code></pre>
    </div>
    
    <div class="test-section error">
        <h2>🚨 مشاكل محتملة وحلولها</h2>
        
        <h3>إذا استمر الصوت المكرر:</h3>
        <ul>
            <li>تحقق من عدم وجود رسائل <code>تم تشغيل الصوت بنجاح</code> مكررة</li>
            <li>ابحث عن استدعاءات <code>playNotificationSound</code> إضافية</li>
        </ul>
        
        <h3>إذا لم تظهر المحادثات:</h3>
        <ul>
            <li>تحقق من رسالة <code>بيانات المحادثات</code> في console</li>
            <li>إذا كانت <code>{rooms: Array(0), count: 0}</code> فلا توجد محادثات في قاعدة البيانات</li>
            <li>أرسل رسالة جديدة وتحقق مرة أخرى</li>
        </ul>
        
        <h3>إذا استمر خطأ الحذف:</h3>
        <ul>
            <li>تحقق من رسالة <code>Cannot read properties of undefined</code></li>
            <li>تأكد من أن البيانات المرسلة للدالة صحيحة</li>
        </ul>
        
        <h3>إذا لم تتحدث حالة المستخدمين:</h3>
        <ul>
            <li>انتظر 20 ثانية على الأقل</li>
            <li>تحقق من اتصال WebSocket</li>
            <li>تأكد من أن المستخدم مسجل دخول</li>
        </ul>
    </div>
    
    <div class="test-section success">
        <h2>🎯 النتائج النهائية المتوقعة</h2>
        <ul class="checklist">
            <li>✅ صوت واحد فقط عند وصول الرسائل</li>
            <li>✅ زر كتم الصوت يعمل بشكل صحيح</li>
            <li>✅ المحادثات تظهر في القائمة فور إرسال رسائل</li>
            <li>✅ حذف المحادثة يعمل بدون أخطاء</li>
            <li>✅ حالة المستخدمين تتحدث بسرعة</li>
            <li>✅ فتح تلقائي للمحادثة عند وصول رسائل</li>
            <li>✅ لا أخطاء JavaScript في console</li>
            <li>✅ تجربة سلسة مثل Facebook Messenger</li>
        </ul>
    </div>
    
    <div class="test-section info">
        <h2>📊 إحصائيات الأداء</h2>
        <p>بعد تطبيق هذه الإصلاحات، يجب أن يكون النظام:</p>
        <ul>
            <li><strong>أسرع:</strong> تحديث حالة المستخدمين كل 15 ثانية</li>
            <li><strong>أكثر دقة:</strong> عدم تكرار الأصوات والرسائل</li>
            <li><strong>أكثر استقراراً:</strong> معالجة أفضل للأخطاء</li>
            <li><strong>أكثر سلاسة:</strong> تحديث فوري لقائمة المحادثات</li>
        </ul>
    </div>
    
    <script>
        // اختبار تلقائي بسيط
        setTimeout(() => {
            console.log('🧪 اختبار تلقائي للنظام...');
            
            // فحص ChatManager
            if (typeof ChatManager !== 'undefined') {
                console.log('✅ ChatManager موجود');
                console.log('📊 حالة النظام:', {
                    isConnected: ChatManager.isConnected,
                    openChats: ChatManager.openChats.size,
                    mutedChats: ChatManager.mutedChats.size
                });
            } else {
                console.error('❌ ChatManager غير موجود');
            }
            
            // فحص الدوال المهمة
            const functions = ['loadChatRooms', 'loadActiveUsers', 'playNotificationSound'];
            functions.forEach(func => {
                if (typeof window[func] === 'function') {
                    console.log(`✅ ${func} موجودة`);
                } else {
                    console.error(`❌ ${func} غير موجودة`);
                }
            });
            
        }, 3000);
    </script>
</body>
</html>
