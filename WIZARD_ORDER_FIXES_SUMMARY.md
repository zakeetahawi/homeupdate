# ุฅุตูุงุญุงุช ููุฒุงุฑุฏ ุฅูุดุงุก ุงูุทูุจุงุช - ููุฎุต ุงูุชูููุฐ

**ุงูุชุงุฑูุฎ:** 2025-11-28  
**ุงูุญุงูุฉ:** โ ุชู ุชุทุจูู ุฌููุน ุงูุฅุตูุงุญุงุช

---

## ๐ ุงููุดุงูู ุงูุชู ุชู ุฅุตูุงุญูุง

### 1. โ ุงููุดููุฉ: ุนุฑุถ ุงููููุฉ ุงููุชุจููุฉ ูู ุงูููุงุด ุจุดูู ุฎุงุทุฆ
**ุงููุตู:** ุนูุฏ ุฅุถุงูุฉ ููุงุด ุจูููุฉ 10.5 ูุชุฑุ ูุงู ูุนุฑุถ 10 ูุชุฑ ููุท (ุชุฌุงูู ุงูุฌุฒุก ุงูุนุดุฑู)

**โ ุงูุฅุตูุงุญ:**

#### ุฃ) Backend - ุญุณุงุจ ุงููููุงุช ุงููุณุชุฎุฏูุฉ
**ุงูููู:** `orders/wizard_views.py` - ุฏุงูุฉ `wizard_step_5_contract`

**ุงูุชุบููุฑ:**
```python
# ูุจู ุงูุฅุตูุงุญ โ
used = CurtainFabric.objects.filter(
    order_item__isnull=False,  # ูุงู ูุจุญุซ ูู ุงูุทูุจุงุช ุงูููุงุฆูุฉ
    curtain__draft_order=draft,
    order_item__product=item.product
).aggregate(total=models.Sum('meters'))['total'] or 0

# ุจุนุฏ ุงูุฅุตูุงุญ โ
# ุญุณุงุจ ุงููููุฉ ุงููุณุชุฎุฏูุฉ ูู ุงูุฃููุดุฉ
used_fabrics = CurtainFabric.objects.filter(
    draft_order_item=item,  # ุงูุจุญุซ ูู ุนูุงุตุฑ ุงููุณูุฏุฉ
    curtain__draft_order=draft
).aggregate(total=models.Sum('meters'))['total'] or Decimal('0')

# ุญุณุงุจ ุงููููุฉ ุงููุณุชุฎุฏูุฉ ูู ุงูุฅูุณุณูุงุฑุงุช
used_accessories = CurtainAccessory.objects.filter(
    draft_order_item=item,
    curtain__draft_order=draft
).aggregate(total=models.Sum('quantity'))['total'] or Decimal('0')

# ุฅุฌูุงูู ุงููุณุชุฎุฏู
used = used_fabrics + used_accessories
```

**ุงููุชูุฌุฉ:** ุงูุขู ูุชู ุญุณุงุจ ุงููููุงุช ุงููุณุชุฎุฏูุฉ ุจุดูู ุตุญูุญ ูู ุงููุณูุฏุฉ ุงูุญุงููุฉ.

---

#### ุจ) Frontend - ุนุฑุถ ุงูุฃุฑูุงู ุงูุนุดุฑูุฉ
**ุงูููู:** `orders/templates/orders/wizard/step5_contract.html`

**ุงูุชุบููุฑ:**
```django-html
<!-- ูุจู ุงูุฅุตูุงุญ โ -->
<span class="available-qty-{{ item.id }}">{{ item.quantity }}</span> ูุชุฑ

<!-- ุจุนุฏ ุงูุฅุตูุงุญ โ -->
<span class="available-qty-{{ item.id }}">{{ item.quantity|floatformat:"-3" }}</span> ูุชุฑ
```

**ุงููุชูุฌุฉ:** ูุนุฑุถ ุงูุฃุฑูุงู ุงูุนุดุฑูุฉ ุจุดูู ุตุญูุญ (10.5 ุจุฏูุงู ูู 10).

---

### 2. โ ุงููุดููุฉ: ุงูุณูุงุญ ุจุชุฌุงูุฒ ุงููููุงุช ุงููุชุงุญุฉ ูู ุงููุณูุฏุงุช
**ุงููุตู:** ูุงู ุงููุธุงู ูุณูุญ ุจุฅุถุงูุฉ ูููุงุช ุฃูุจุฑ ูู ุงููุชููุฑ (ูุงู ููุท ุชุญุฐูุฑ ูููุณ ููุน)

**โ ุงูุฅุตูุงุญ:**

#### ุฃ) CurtainFabric Validation
**ุงูููู:** `orders/contract_models.py` - ุฏุงูุฉ `CurtainFabric.clean()`

**ุงูุชุบููุฑ:**
```python
# ูุจู ุงูุฅุตูุงุญ โ
if self.draft_order_item and self.meters:
    used_total = CurtainFabric.objects.filter(
        draft_order_item=self.draft_order_item
    ).exclude(pk=self.pk).aggregate(
        total=models.Sum('meters')
    )['total'] or 0
    
    available = self.draft_order_item.quantity - used_total
    
    # ุชุญุฐูุฑ ููุทุ ูุง ูููุน ุงูุญูุธ โ
    if self.meters > available:
        logger.warning(f'ุงููููุฉ ุงููุทููุจุฉ ุฃูุจุฑ ูู ุงููุชุงุญ')

# ุจุนุฏ ุงูุฅุตูุงุญ โ
if self.draft_order_item and self.meters:
    # ุญุณุงุจ ูุง ุชู ุงุณุชุฎุฏุงูู ูู ุงูุฃููุดุฉ
    used_in_fabrics = CurtainFabric.objects.filter(
        draft_order_item=self.draft_order_item
    ).exclude(pk=self.pk).aggregate(
        total=Sum('meters')
    )['total'] or Decimal('0')
    
    # ุญุณุงุจ ูุง ุชู ุงุณุชุฎุฏุงูู ูู ุงูุฅูุณุณูุงุฑุงุช
    used_in_accessories = CurtainAccessory.objects.filter(
        draft_order_item=self.draft_order_item
    ).aggregate(
        total=Sum('quantity')
    )['total'] or Decimal('0')
    
    # ุฅุฌูุงูู ุงููุณุชุฎุฏู
    used_total = used_in_fabrics + used_in_accessories
    available = self.draft_order_item.quantity - used_total
    
    # ููุน ุงูุญูุธ โ
    if self.meters > available:
        errors['meters'] = (
            f'ุงููููุฉ ุงููุทููุจุฉ ({self.meters}ู) ุฃูุจุฑ ูู ุงููุชุงุญ '
            f'({available}ู ูู ุฃุตู {self.draft_order_item.quantity}ู)'
        )
```

**ุงููุชูุฌุฉ:** ุงูุขู ูููุน ุงููุธุงู ุชุฌุงูุฒ ุงููููุงุช ููุนุฑุถ ุฑุณุงูุฉ ุฎุทุฃ ูุงุถุญุฉ.

---

#### ุจ) CurtainAccessory Validation
**ุงูููู:** `orders/contract_models.py` - ุฏุงูุฉ `CurtainAccessory.clean()`

**ุงูุชุบููุฑ:** ููุณ ุงูููุทู - ุชู ุชุบููุฑ ุงูุชุญุฐูุฑ ุฅูู ุฎุทุฃ ูููุน ุงูุญูุธ.

**ุงููุชูุฌุฉ:** ุงูุขู ูููุน ุงููุธุงู ุชุฌุงูุฒ ุงููููุงุช ููุฅูุณุณูุงุฑุงุช ุฃูุถุงู.

---

### 3. โ ุงููุดููุฉ: ุนุฏู ุชุญุฏูุซ ุงููููุงุช ุจุนุฏ ุญุฐู ุงูุณุชุงุฑุฉ
**ุงููุตู:** ุนูุฏ ุญุฐู ุณุชุงุฑุฉุ ูุงูุช ุงููููุงุช ูุง ุชุนูุฏ ูุชุงุญุฉ ููุงุณุชุฎุฏุงู

**โ ุงูุฅุตูุงุญ:**

**ุงูููู:** `orders/templates/orders/wizard/step5_contract.html` - ุฏุงูุฉ `removeCurtain()`

**ุงูุชุบููุฑ:**
```javascript
// ูุจู ุงูุฅุตูุงุญ โ
.then(data => {
    if (data.success) {
        document.querySelector(`[data-curtain-id="${curtainId}"]`).remove();
        
        // ุชุญุฏูุซ DOM ููุท - ูุง ูุนูุฏ ุญุณุงุจ ุงููููุงุช โ
        if (document.querySelectorAll('.curtain-card').length === 0) {
            document.getElementById('curtains-list').innerHTML = `...`;
        }
    }
});

// ุจุนุฏ ุงูุฅุตูุงุญ โ
.then(data => {
    if (data.success) {
        // ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ ูุชุญุฏูุซ ุงููููุงุช โ
        location.reload();
    } else {
        alert(data.message || 'ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุญุฐู ุงูุณุชุงุฑุฉ');
    }
});
```

**ุงููุชูุฌุฉ:** ุงูุขู ุนูุฏ ุญุฐู ุณุชุงุฑุฉุ ูุชู ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ ูุชุญุฏูุซ ุฌููุน ุงููููุงุช ุงููุชุงุญุฉ.

---

## ๐ ููุฎุต ุงูุชุบููุฑุงุช

| ุงูููู | ุงูุชุบููุฑุงุช | ุงูุณุจุจ |
|------|----------|-------|
| `orders/wizard_views.py` | ุชุตุญูุญ ุญุณุงุจ ุงููููุงุช ุงููุณุชุฎุฏูุฉ | ูุงู ูุจุญุซ ูู `order_item` ุจุฏูุงู ูู `draft_order_item` |
| `orders/contract_models.py` (CurtainFabric) | ุชุบููุฑ ุงูุชุญุฐูุฑ ุฅูู ุฎุทุฃ ูููุน ุงูุญูุธ | ูุงู ูุณูุญ ุจุชุฌุงูุฒ ุงููููุงุช ูู ุงููุณูุฏุงุช |
| `orders/contract_models.py` (CurtainAccessory) | ููุณ ุงูุฅุตูุงุญ ููุฅูุณุณูุงุฑุงุช | ููุณ ุงููุดููุฉ |
| `orders/templates/orders/wizard/step5_contract.html` | 1. ุงุณุชุฎุฏุงู `floatformat:"-3"` ูุนุฑุถ ุงูุฃุฑูุงู<br>2. ุฅุนุงุฏุฉ ุชุญููู ุจุนุฏ ุงูุญุฐู | 1. ุนุฑุถ ุงูุฃุฑูุงู ุงูุนุดุฑูุฉ ุจุดูู ุตุญูุญ<br>2. ุชุญุฏูุซ ุงููููุงุช ุจุนุฏ ุงูุญุฐู |

---

## โ ุงููุชุงุฆุฌ ุงููุชููุนุฉ ุจุนุฏ ุงูุฅุตูุงุญุงุช

### 1. ุนุฑุถ ุงููููุงุช
- โ ุนุฑุถ ุงููููุงุช ุงูุนุดุฑูุฉ ุจุดูู ุตุญูุญ (10.5 ูููุณ 10)
- โ ุญุณุงุจ ุงููููุงุช ุงููุณุชุฎุฏูุฉ ูู ุงููุณูุฏุฉ ุงูุญุงููุฉ ููุท
- โ ุนุฑุถ ุงููููุงุช ุงููุชุจููุฉ ุจุฏูุฉ

### 2. ููุน ุงูุชุฌุงูุฒ
- โ ุฑูุถ ุฅุถุงูุฉ ูููุงุช ุฃูุจุฑ ูู ุงููุชุงุญุฉ
- โ ุนุฑุถ ุฑุณุงูุฉ ุฎุทุฃ ูุงุถุญุฉ ุชุชุถูู:
  - ุงููููุฉ ุงููุทููุจุฉ
  - ุงููููุฉ ุงููุชุงุญุฉ
  - ุงููููุฉ ุงูุฅุฌูุงููุฉ
- โ ุญุณุงุจ ุตุญูุญ ูููููุงุช ุงููุณุชุฎุฏูุฉ ูู ุงูุฃููุดุฉ ูุงูุฅูุณุณูุงุฑุงุช ูุนุงู

### 3. ุญุฐู ุงูุณุชุงุฆุฑ
- โ ุนูุฏ ุญุฐู ุณุชุงุฑุฉุ ุชุนูุฏ ุงููููุงุช ููุชููุฑ
- โ ุชุญุฏูุซ ููุฑู ููู ุงูุนูุงุตุฑ ูู ุงูุตูุญุฉ
- โ ุนูู ุตุญูุญ ููุญุฐู ุงููุชุนุฏุฏ

---

## ๐งช ุณููุงุฑูููุงุช ุงูุงุฎุชุจุงุฑ ุงููุทููุจุฉ

### ุงุฎุชุจุงุฑ 1: ุงููููุงุช ุงูุนุดุฑูุฉ โ
```
1. ุฅุถุงูุฉ ููุงุด ุจูููุฉ 10.5 ูุชุฑ ูู ุงููุงุชูุฑุฉ (ุงูุฎุทูุฉ 3)
2. ุงูุงูุชูุงู ูุฎุทูุฉ ุงูุนูุฏ (ุงูุฎุทูุฉ 5)
3. ุฅุถุงูุฉ ุณุชุงุฑุฉ ูุงุฎุชูุงุฑ ุงูููุงุด
4. ุงูุชุญูู: ูุนุฑุถ "ูุชููุฑ: 10.5 ูุชุฑ" โ
5. ุฅุถุงูุฉ 5.5 ูุชุฑ ููููุงุด ุงูุฎููู
6. ุญูุธ ุงูุณุชุงุฑุฉ
7. ุฅุถุงูุฉ ุณุชุงุฑุฉ ุฌุฏูุฏุฉ
8. ุงูุชุญูู: ูุนุฑุถ "ูุชููุฑ: 5 ูุชุฑ" โ
9. ูุญุงููุฉ ุฅุถุงูุฉ 5.5 ูุชุฑ (ุฃูุจุฑ ูู ุงููุชุงุญ)
10. ุงูุชุญูู: ูุธูุฑ ุฎุทุฃ ูููุน ุงูุญูุธ โ
```

### ุงุฎุชุจุงุฑ 2: ููุน ุงูุชุฌุงูุฒ โ
```
1. ููุงุด ูุชููุฑ: 10 ูุชุฑ
2. ุฅุถุงูุฉ ุณุชุงุฑุฉ ุชุณุชููู 7 ูุชุฑ
3. ูุญุงููุฉ ุฅุถุงูุฉ ุณุชุงุฑุฉ ุฃุฎุฑู ุชุณุชููู 5 ูุชุฑ (ุฃูุซุฑ ูู ุงููุชุจูู 3)
4. ุงูุชุญูู: ุฑุณุงูุฉ ุฎุทุฃ ูุงุถุญุฉ โ
5. ุงูุฑุณุงูุฉ ุชุชุถูู: "ุงููููุฉ ุงููุทููุจุฉ (5ู) ุฃูุจุฑ ูู ุงููุชุงุญ (3ู ูู ุฃุตู 10ู)" โ
```

### ุงุฎุชุจุงุฑ 3: ุญุฐู ุงูุณุชุงุฆุฑ โ
```
1. ููุงุด ูุชููุฑ: 10 ูุชุฑ
2. ุฅุถุงูุฉ ุณุชุงุฑุฉ ุชุณุชููู 6 ูุชุฑ โ ุงููุชุจูู: 4 ูุชุฑ
3. ุฅุถุงูุฉ ุณุชุงุฑุฉ ุชุณุชููู 3 ูุชุฑ โ ุงููุชุจูู: 1 ูุชุฑ
4. ุญุฐู ุงูุณุชุงุฑุฉ ุงูุฃููู (6 ูุชุฑ)
5. ุงูุชุญูู: ุงููุชุจูู ูุตุจุญ 7 ูุชุฑ โ
6. ูููู ุงูุขู ุฅุถุงูุฉ ุณุชุงุฑุฉ ุจู 5 ูุชุฑ โ
```

### ุงุฎุชุจุงุฑ 4: ุงูุฃููุดุฉ ูุงูุฅูุณุณูุงุฑุงุช ูู ููุณ ุงูุนูุตุฑ โ
```
1. ุนูุตุฑ ูู ุงููุงุชูุฑุฉ: "ููุงุด ุฃุจูุถ" - 20 ูุชุฑ
2. ุฅุถุงูุฉ ุณุชุงุฑุฉ:
   - ููุงุด ุฎููู ูู "ููุงุด ุฃุจูุถ": 8 ูุชุฑ
   - ุฅูุณุณูุงุฑ ูู "ููุงุด ุฃุจูุถ": ุนุฏุฏ 3 ร ููุงุณ 2 = 6
3. ุงูุชุญูู: ุงููุณุชุฎุฏู = 8 + 6 = 14 ูุชุฑ
4. ุงูุชุญูู: ุงููุชุจูู = 20 - 14 = 6 ูุชุฑ โ
```

### ุงุฎุชุจุงุฑ 5: ุญูุธ ุงูุฏุฑุงูุช ูุงูุนูุฏุฉ ๐
```
1. ุฅูุดุงุก ุทูุจ ุญุชู ุงูุฎุทูุฉ 5
2. ุฅุถุงูุฉ ุณุชุงุฑุฉ ูุงููุฉ
3. ุงูุฎุฑูุฌ ูู ุงูููุฒุงุฑุฏ
4. ุงูุนูุฏุฉ ุนุจุฑ ูุงุฆูุฉ ุงููุณูุฏุงุช
5. ุงูุชุญูู: ุงูุณุชุงุฑุฉ ููุฌูุฏุฉ ุจูู ุชูุงุตูููุง
```
**ููุงุญุธุฉ:** ูุฐุง ุงูุงุฎุชุจุงุฑ ููุชุฃูุฏ ูู ุนุฏู ูุฌูุฏ ูุดููุฉ ูู ุญูุธ ุงููุณูุฏุงุช.

---

## ๐ ููุงุท ุฅุถุงููุฉ ูููุฑุงุฌุนุฉ

### 1. ูุดููุฉ ุญูุธ ุงูุฏุฑุงูุช (ุชุญุชุงุฌ ุชุญูู ุฅุถุงูู)
**ุงููุตู:** ุงููุณุชุฎุฏู ุฐูุฑ ุฃู ุชูุงุตูู ุงูุณุชุงุฆุฑ ูุง ุชุจูู ูุญููุธุฉ ุนูุฏ ุงูุนูุฏุฉ.

**ุงูุชุญููู:**
- ุงูููุฏ ุงูุญุงูู ูู `wizard_add_curtain` ูุญูุธ ุงูุจูุงูุงุช ููุฑุงู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช โ
- ุนูุฏ ุงูุนูุฏุฉุ `wizard_step` ูุฌูุจ ุงููุณูุฏุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช โ
- ุงูุณุชุงุฆุฑ ูุฑุชุจุทุฉ ุจู `draft_order` ุนุจุฑ FK โ

**ุงูุงุญุชูุงูุงุช:**
1. ูุดููุฉ ูู ุงูุฌูุณุฉ (session timeout)
2. ุงููุณุชุฎุฏู ููุชุญ ุฑุงุจุท ูุจุงุดุฑ ุจุฏูุงู ูู ุงูุงุณุชูุฑุงุฑ
3. ุชุถุงุฑุจ ูู `wizard_draft_id`

**ุงูุฅุฌุฑุงุก ุงูููุชุฑุญ:**
- ุงุฎุชุจุงุฑ ุงูุณููุงุฑูู ุจุงููุงูู
- ุฅุถุงูุฉ logging ูุชุชุจุน ุงููุณูุฏุงุช
- ุฅุถุงูุฉ ุฑุณุงูุฉ ุชูุจูู ูููุณุชุฎุฏู ุนูุฏ ูุฌูุฏ ูุณูุฏุงุช ุบูุฑ ููุชููุฉ

---

## ๐ ููุงุญุธุงุช ูููุฉ

### ูููุทูุฑูู:
1. **ุงูููุงุชุฑ ูู Aggregation:** ุชุฃูุฏ ุฏุงุฆูุงู ูู ุงุณุชุฎุฏุงู `draft_order_item` ูููุณูุฏุงุช ู `order_item` ููุทูุจุงุช ุงูููุงุฆูุฉ
2. **Decimal vs Float:** ุงุณุชุฎุฏู `Decimal('0')` ุจุฏูุงู ูู `0` ูู ุงูุนูููุงุช ุงูุญุณุงุจูุฉ ูููููุงุช
3. **Validation ูู ุงููุณูุฏุงุช:** ูุฌุจ ููุน ุชุฌุงูุฒ ุงููููุงุช ุญุชู ูู ุงููุณูุฏุงุช
4. **Reload vs Update DOM:** ูู ุญุงูุงุช ุงูุญุฐูุ ุฅุนุงุฏุฉ ุงูุชุญููู ุฃุจุณุท ูุฃุถูู ูู ุชุญุฏูุซ DOM ูุฏููุงู

### ูููุณุชุฎุฏููู:
1. ุงูุฃุฑูุงู ุงูุนุดุฑูุฉ ูุฏุนููุฉ ุงูุขู ุจุดูู ูุงูู
2. ุงููุธุงู ูููุน ุชุฌุงูุฒ ุงููููุงุช ุงููุชุงุญุฉ
3. ุนูุฏ ุญุฐู ุณุชุงุฑุฉุ ุงููููุงุช ุชุนูุฏ ุชููุงุฆูุงู
4. ุงุญูุธ ุนููู ุจุงูุชุธุงู ููุญูุงุธ ุนูู ุงูุจูุงูุงุช

---

## ๐ฏ ุงูุฎุทูุงุช ุงูุชุงููุฉ

1. **ุงุฎุชุจุงุฑ ุดุงูู** ููู ุงูุณููุงุฑูููุงุช ุงููุฐููุฑุฉ ุฃุนูุงู
2. **ูุฑุงูุจุฉ** ุฃู ุฃุฎุทุงุก ูู ุงูุฅูุชุงุฌ
3. **ุฌูุน ููุงุญุธุงุช** ุงููุณุชุฎุฏููู
4. **ุชุญุณููุงุช ุฅุถุงููุฉ** ุฅุฐุง ูุฒู ุงูุฃูุฑ:
   - ุฑุณุงุฆู ุฎุทุฃ ุฃูุถุญ
   - ุฅุดุนุงุฑุงุช ุนูุฏ ุงูุงูุชุฑุงุจ ูู ุงุณุชููุงุฐ ุงููููุฉ
   - ุชูููู ุจุตุฑู ููุนูุงุตุฑ ุงููุณุชููุฐุฉ

---

**ุชู ุจูุฌุงุญ!** โ

ุฌููุน ุงูุฅุตูุงุญุงุช ุงูุฃุณุงุณูุฉ ุชู ุชุทุจูููุง. ุงููุธุงู ุงูุขู ูุฌุจ ุฃู ูุนูู ุจุดูู ุตุญูุญ ููุญู ุงููุดุงูู ุงููุฐููุฑุฉ.
