# ๐ ุฏููู ูุดุฑ ูุธุงู ุงููุญุงุฏุซุฉ ุงูููุฑูุฉ (WebSockets)

## ูุธุฑุฉ ุนุงูุฉ
ุชู ุชุญุฏูุซ ุงูููุตุฉ ูุชุฏุนู ุงููุญุงุฏุซุฉ ุงูููุฑูุฉ (Real-Time) ุจุงุณุชุฎุฏุงู ุชูููุฉ WebSockets ุจุฏูุงู ูู HTTP Polling ุงูุชูููุฏู. ูุฐุง ุงูุชุญุฏูุซ ูุนุชูุฏ ุนูู ููุชุจุฉ `Django Channels` ู `Redis`.

## 1. ุงููุชุทูุจุงุช ุงูุฌุฏูุฏุฉ (Requirements)
ุชู ุชุญุฏูุซ ููู `requirements.txt`. ุชุฃูุฏ ูู ุชูุตูุจ ุงูุญุฒู ุงูุฌุฏูุฏุฉ:
```bash
pip install -r requirements.txt
```
ุฃูู ุงูุญุฒู ุงูุฌุฏูุฏุฉ:
- `channels`
- `channels_redis`
- `daphne` (ุฎุงุฏู ASGI ููุฅูุชุงุฌ)

## 2. ุฅุนุฏุงุฏ ุฎุฏูุฉ Redis
ุงููุธุงู ูุญุชุงุฌ ูุฎุฏูุฉ Redis ูุชุนูู ูู "Channel Layer" ูุชุจุงุฏู ุงูุฑุณุงุฆู.
- **ูู ุจูุฆุฉ ุงูุชุทููุฑ ุงููุญููุฉ:**
  ุชุฃูุฏ ูู ุชุดุบูู Redis (ุฃู Valkey).
  ```bash
  sudo systemctl start valkey-server
  # ุฃู
  docker run -p 6379:6379 -d redis:5
  ```

- **ูู ุจูุฆุฉ ุงูุฅูุชุงุฌ (Production):**
  ูุฌุจ ูุฌูุฏ ุฎุงุฏู Redis ูููุตู ุฃู ุฎุฏูุฉ ุณุญุงุจูุฉ. ุชุฃูุฏ ูู ุชุญุฏูุซ ุฅุนุฏุงุฏุงุช `CHANNEL_LAYERS` ูู `settings.py` ุฅุฐุง ูุงู ุงูุฑุงุจุท ูุฎุชููุงู ุนู `redis://127.0.0.1:6379`.

## 3. ุชุดุบูู ุงูุฎุงุฏู (Production)
ุงูุขู ูุฌุจ ุชุดุบูู ุงููุดุฑูุน ุจุงุณุชุฎุฏุงู **Daphne** (ููู WebSockets) ุจุฏูุงู ูู (ุฃู ุจุฌุงูุจ) Gunicorn.

### ุงูุฎูุงุฑ ุงูุฃูุถู: Daphne ูุฏูุฑ ูู ุดูุก
ุงุณุชุจุฏู ุฃูุฑ ุชุดุบูู `gunicorn` ุจุงูุฃูุฑ ุงูุชุงูู:
```bash
daphne -b 0.0.0.0 -p 8000 crm.asgi:application
```

### ุงูุฎูุงุฑ ุงูุจุฏูู: Gunicorn + Daphne
ุฅุฐุง ููุช ุชูุถู ูุตู ุงูู HTTP ุนู ุงูู websocket:
- Gunicorn ูุชุนุงูู ูุน `wsgi.py`.
- Daphne ูุชุนุงูู ูุน `asgi.py` (ูุซูุงู ุนูู ูููุฐ 8001).
- Nginx ููุฌู `/ws/` ุฅูู Daphne ูุงูุจุงูู ุฅูู Gunicorn.

## 4. ุฅุนุฏุงุฏุงุช ุฎุงุฏู ุงูููุจ (Nginx)
ูุฌุจ ุชุญุฏูุซ ุฅุนุฏุงุฏุงุช Nginx ููุณูุงุญ ุจุชุฑููุฉ ุงูุงุชุตุงู ุฅูู WebSocket (Connection Upgrade).

ูุซุงู ูุฅุนุฏุงุฏ Nginx (ุฏุงุฎู `location /` ุฃู `location /ws/`):
```nginx
location / {
    proxy_pass http://127.0.0.1:8000;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    
    proxy_redirect off;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Host $server_name;
}
```

## 5. ุฅุนุฏุงุฏุงุช Cloudflare (ูุงู ุฌุฏุงู โ๏ธ)
ุฅุฐุง ููุช ุชุณุชุฎุฏู Cloudflareุ ูุงููุธุงู ูุฏุนู WebSockets ุชููุงุฆูุงู.
- ุชุฃูุฏ ูู ุชูุนูู "WebSockets" ูู: **Cloudflare Dashboard > Network**.
- ูุง ุญุงุฌุฉ ูุชุบููุฑ ุฃู ููุฏ ุฎุงุต ุจู Cloudflareุ ุงูููุชุจุฉ ุชุชุนุงูู ูุนู.

## 6. ุงูุชุญูู ูู ุงูุนูู
ุจุนุฏ ุงููุดุฑุ ูู ุจูุง ููู:
1. ุงูุชุญ ุงููููุน ูุณุฌู ุงูุฏุฎูู.
2. ุงูุชุญ ุงููููุณูู (F12) ูู ุงููุชุตูุญ.
3. ุชุฃูุฏ ูู ุธููุฑ ุงูุฑุณุงูุฉ: `Chat WebSocket Connected` ุจุงูููู ุงูุฃุฎุถุฑ.
4. ุฃุฑุณู ุฑุณุงูุฉ ูุชุฃูุฏ ูู ูุตูููุง ููุฑุงู ูุธููุฑ ุนูุงูุชู "ุตุญ" (Read Receipts).

---
**ููุงุญุธุฉ:** ุชู ุชุนุทูู ุฌููุน ุณุฌูุงุช ุงูู Debugging (Logs) ูุถูุงู ุฃุฏุงุก ูุธูู ูุณุฑูุน ูู ุงูุฅูุชุงุฌ.
