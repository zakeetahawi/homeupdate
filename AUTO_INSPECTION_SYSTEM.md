# 🔄 نظام إنشاء المعاينة التلقائية

## 📋 نظرة عامة

تم تطوير نظام تلقائي لإنشاء معاينة عند إنشاء طلب من نوع "معاينة"، مع مزامنة حالة الطلب بناءً على حالة المعاينة.

## ✨ المميزات الجديدة

### 1. إنشاء معاينة تلقائية
- **عند إنشاء طلب من نوع "معاينة"**: يتم إنشاء معاينة تلقائياً
- **للطلبات المختلطة**: إذا كان الطلب يحتوي على "معاينة" + أنواع أخرى، يتم إنشاء المعاينة
- **للطلبات الأخرى**: لا يتم إنشاء معاينة إذا لم يكن النوع "معاينة"

### 2. مزامنة الحالات
- **حالة الطلب تتبع حالة المعاينة** تلقائياً
- **تحديث فوري** عند تغيير حالة المعاينة
- **خريطة حالات ذكية** لتحويل حالات المعاينة إلى حالات الطلب

## 🔧 المكونات المطورة

### 1. إشارة إنشاء المعاينة التلقائية

```python
@receiver(post_save, sender=Order)
def create_inspection_on_order_creation(sender, instance, created, **kwargs):
    """إنشاء معاينة تلقائية عند إنشاء طلب من نوع معاينة"""
    if created:
        order_types = instance.get_selected_types_list()
        
        if 'inspection' in order_types:
            inspection = Inspection.objects.create(
                customer=instance.customer,
                branch=instance.branch,
                responsible_employee=instance.salesperson,
                order=instance,
                is_from_orders=True,
                request_date=timezone.now().date(),
                scheduled_date=timezone.now().date() + timedelta(days=1),
                status='pending',
                notes=f'معاينة تلقائية للطلب رقم {instance.order_number}',
                order_notes=instance.notes,
                created_by=instance.created_by
            )
```

### 2. إشارة مزامنة الحالات

```python
@receiver(post_save, sender=Inspection)
def update_order_status_on_inspection_change(sender, instance, **kwargs):
    """تحديث حالة الطلب بناءً على حالة المعاينة للطلبات من نوع معاينة"""
    if instance.order and 'inspection' in instance.order.get_selected_types_list():
        # خريطة تحويل الحالات
        inspection_to_order_status = {
            'pending': 'pending',           # قيد الانتظار
            'scheduled': 'pending',         # مجدول -> قيد الانتظار
            'completed': 'completed',       # مكتملة -> مكتمل
            'cancelled': 'cancelled',       # ملغية -> ملغي
        }
        
        inspection_to_tracking_status = {
            'pending': 'processing',        # قيد الانتظار -> قيد المعالجة
            'scheduled': 'processing',      # مجدول -> قيد المعالجة
            'completed': 'ready',           # مكتملة -> جاهز للتسليم
            'cancelled': 'pending',         # ملغية -> قيد الانتظار
        }
```

## 📊 خريطة تحويل الحالات

| حالة المعاينة | حالة الطلب | حالة التتبع |
|-------------|-----------|------------|
| `pending` | `pending` | `processing` |
| `scheduled` | `pending` | `processing` |
| `completed` | `completed` | `ready` |
| `cancelled` | `cancelled` | `pending` |

## 🧪 نتائج الاختبار

### اختبار 1: طلب من نوع معاينة فقط
```
=== اختبار إنشاء طلب من نوع معاينة ===
العميل: مخائيل تامر
كود العميل: 5-0107

تم إنشاء الطلب: 5-0107-0003
حالة الطلب: pending
حالة التتبع: pending

✅ تم إنشاء المعاينة التلقائية: 1346
حالة المعاينة: pending
تاريخ الطلب: 2025-07-08
تاريخ التنفيذ: 2025-07-09
من قسم الطلبات: True
```

### اختبار 2: تحديث حالة المعاينة
```
--- اختبار تحديث حالة المعاينة ---
بعد تحديث المعاينة إلى مجدول:
  حالة الطلب: pending
  حالة التتبع: processing

بعد تحديث المعاينة إلى مكتمل:
  حالة الطلب: completed
  حالة التتبع: ready

🎉 النظام يعمل بنجاح!
```

### اختبار 3: طلب من نوع تركيب (ليس معاينة)
```
=== اختبار إنشاء طلب من نوع تركيب (ليس معاينة) ===
تم إنشاء الطلب: 5-0107-0005
حالة الطلب: pending
حالة التتبع: pending

✅ لم يتم إنشاء معاينة (صحيح)
```

### اختبار 4: طلب مختلط (معاينة + تركيب)
```
=== اختبار طلب مختلط (معاينة + تركيب) ===
تم إنشاء الطلب المختلط: 5-0107-0006
حالة الطلب: pending
حالة التتبع: pending
✅ تم إنشاء معاينة للطلب المختلط: 1348

🎯 جميع الاختبارات نجحت!
```

## 🎯 سيناريوهات الاستخدام

### 1. طلب معاينة بسيط
```python
order = Order.objects.create(
    customer=customer,
    selected_types=['inspection'],
    notes='طلب معاينة',
    created_by=user
)
# ✅ يتم إنشاء معاينة تلقائياً
```

### 2. طلب مختلط
```python
order = Order.objects.create(
    customer=customer,
    selected_types=['inspection', 'installation'],
    invoice_number='INV-001',
    notes='طلب معاينة وتركيب',
    created_by=user
)
# ✅ يتم إنشاء معاينة تلقائياً
# ✅ يتم إنشاء أمر تصنيع للتركيب
```

### 3. طلب تركيب فقط
```python
order = Order.objects.create(
    customer=customer,
    selected_types=['installation'],
    invoice_number='INV-002',
    notes='طلب تركيب فقط',
    created_by=user
)
# ❌ لا يتم إنشاء معاينة
# ✅ يتم إنشاء أمر تصنيع فقط
```

## 📈 الفوائد

### 1. تحسين تجربة المستخدم
- **إنشاء تلقائي**: لا حاجة لإنشاء معاينة يدوياً
- **مزامنة فورية**: حالة الطلب تتحدث تلقائياً
- **سهولة التتبع**: حالة واحدة تتحكم في النظام

### 2. تحسين الكفاءة
- **تقليل الأخطاء**: لا نسيان لإنشاء معاينة
- **توفير الوقت**: إنشاء تلقائي بدلاً من يدوي
- **تنظيم أفضل**: ربط تلقائي بين الطلب والمعاينة

### 3. مرونة في التطبيق
- **طلبات مختلطة**: يدعم معاينة + أنواع أخرى
- **طلبات بسيطة**: يعمل مع معاينة فقط
- **طلبات أخرى**: لا يتدخل في الأنواع الأخرى

## 🔄 تدفق العمل

### 1. إنشاء الطلب
```
مستخدم ينشئ طلب من نوع "معاينة"
         ↓
إشارة post_save للطلب
         ↓
فحص إذا كان النوع يحتوي على "معاينة"
         ↓
إنشاء معاينة تلقائياً
         ↓
ربط المعاينة بالطلب
```

### 2. تحديث المعاينة
```
مستخدم يحدث حالة المعاينة
         ↓
إشارة post_save للمعاينة
         ↓
فحص إذا كان الطلب من نوع "معاينة"
         ↓
تحديث حالة الطلب بناءً على حالة المعاينة
         ↓
مزامنة فورية للحالات
```

## 🛠️ الصيانة والتطوير

### 1. إضافة حالات جديدة
لإضافة حالة جديدة للمعاينة:
```python
inspection_to_order_status = {
    'pending': 'pending',
    'scheduled': 'pending',
    'completed': 'completed',
    'cancelled': 'cancelled',
    'new_status': 'new_order_status',  # إضافة هنا
}
```

### 2. تخصيص المعاينة التلقائية
يمكن تخصيص المعاينة التلقائية من خلال تعديل:
```python
inspection = Inspection.objects.create(
    # ... الحقول الأساسية
    scheduled_date=timezone.now().date() + timedelta(days=1),  # تخصيص التاريخ
    notes=f'معاينة تلقائية للطلب رقم {instance.order_number}',  # تخصيص الملاحظات
)
```

## 📝 ملاحظات مهمة

1. **المعاينة التلقائية** تُنشأ فقط للطلبات الجديدة (created=True)
2. **المزامنة** تعمل فقط للطلبات التي تحتوي على نوع "معاينة"
3. **الطلبات المختلطة** تحصل على معاينة + أنواع أخرى
4. **البائع** يتم نسخه تلقائياً من الطلب إلى المعاينة
5. **الفرع** يتم نسخه تلقائياً من الطلب إلى المعاينة

## 🚀 الاستخدام

النظام يعمل تلقائياً الآن:
- **إنشاء طلب معاينة**: معاينة تلقائية
- **تحديث حالة المعاينة**: تحديث حالة الطلب
- **طلبات مختلطة**: معاينة + أنواع أخرى
- **طلبات أخرى**: لا تأثير على الأنواع الأخرى

---

**تم تطوير النظام بنجاح ✅**

*آخر تحديث: يوليو 2025* 