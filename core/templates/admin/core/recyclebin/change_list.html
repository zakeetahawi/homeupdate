{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block title %}Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ©{% endblock %}
{% block content_title %}<h1>ğŸ—‘ï¸ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ©</h1>{% endblock %}

{% block extrahead %}
{{ block.super }}
<style>
  .recycle-container { max-width: 1200px; margin: 0 auto; }
  .recycle-header {
    background: linear-gradient(135deg, #dc3545 0%, #a71d2a 100%);
    color: #fff; padding: 20px 25px; border-radius: 10px 10px 0 0;
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 0;
  }
  .recycle-header h2 { margin: 0; font-size: 22px; }
  .total-badge {
    background: rgba(255,255,255,.2); padding: 8px 20px; border-radius: 20px;
    font-size: 16px; font-weight: bold;
  }
  .category-card {
    background: #fff; border: 1px solid #e0e0e0; border-radius: 10px;
    margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,.04);
    overflow: hidden;
  }
  .category-card.primary { border-right: 4px solid #dc3545; }
  .category-card.secondary { border-right: 4px solid #6c757d; }
  .category-header {
    padding: 14px 20px; cursor: pointer; display: flex;
    justify-content: space-between; align-items: center;
    background: #f8f9fa; border-bottom: 1px solid #eee;
    transition: background .2s;
  }
  .category-header:hover { background: #eef1f5; }
  .category-title { font-size: 16px; font-weight: bold; color: #333; display: flex; align-items: center; gap: 10px; }
  .category-title .app-badge {
    font-size: 11px; color: #888; background: #e9ecef;
    padding: 2px 8px; border-radius: 10px; font-weight: normal;
  }
  .category-count {
    background: #dc3545; color: #fff; padding: 4px 12px;
    border-radius: 12px; font-weight: bold; font-size: 13px;
    min-width: 30px; text-align: center;
  }
  .category-body { padding: 0; display: none; }
  .category-body.open { display: block; }
  .item-row {
    padding: 12px 20px; border-bottom: 1px solid #f0f0f0;
    display: flex; justify-content: space-between; align-items: flex-start;
    transition: background .15s;
  }
  .item-row:hover { background: #fafbfc; }
  .item-row:last-child { border-bottom: none; }
  .item-info { flex: 1; }
  .item-name { font-weight: 600; color: #333; font-size: 14px; margin-bottom: 4px; }
  .item-meta { font-size: 12px; color: #888; }
  .item-meta span { margin-left: 15px; }
  .item-related {
    margin-top: 8px; padding: 8px 12px; background: #fff3cd;
    border-radius: 6px; border-right: 3px solid #ffc107;
  }
  .item-related-title { font-size: 12px; font-weight: bold; color: #856404; margin-bottom: 4px; }
  .related-group { font-size: 12px; color: #666; margin-bottom: 3px; padding-right: 10px; }
  .related-group .related-badge {
    background: #ffc107; color: #333; padding: 1px 6px;
    border-radius: 8px; font-size: 11px; font-weight: bold;
  }
  .related-items-list { font-size: 11px; color: #999; padding-right: 15px; margin-top: 2px; }
  .item-actions { display: flex; gap: 6px; flex-shrink: 0; align-items: flex-start; }
  .btn-action {
    border: none; padding: 6px 12px; border-radius: 5px;
    font-size: 12px; cursor: pointer; font-weight: 500;
    display: inline-flex; align-items: center; gap: 4px;
    transition: all .2s;
  }
  .btn-restore { background: #28a745; color: #fff; }
  .btn-restore:hover { background: #218838; }
  .btn-cascade-restore { background: #17a2b8; color: #fff; }
  .btn-cascade-restore:hover { background: #138496; }
  .btn-hard-delete { background: #dc3545; color: #fff; }
  .btn-hard-delete:hover { background: #c82333; }
  .btn-view { background: #fff; color: #333; text-decoration: none; padding: 6px 12px; border-radius: 5px; font-size: 12px; font-weight: 600; border: 2px solid #6c757d; }
  .btn-view:hover { background: #6c757d; color: #fff; }
  .empty-state {
    text-align: center; padding: 60px 20px; color: #999;
    background: #fff; border-radius: 10px; border: 1px solid #e0e0e0;
  }
  .empty-state i { font-size: 48px; opacity: .3; display: block; margin-bottom: 15px; }
  .toggle-arrow { transition: transform .3s; display: inline-block; margin-left: 8px; }
  .toggle-arrow.open { transform: rotate(90deg); }

  /* Hide default Django admin elements */
  #changelist-filter, #changelist-form, .paginator, .actions, .object-tools { display: none !important; }
  #content-main { padding: 0 !important; }
  #content { padding: 20px; }
</style>
{% endblock %}

{% block content %}
<div class="recycle-container">
  <!-- Header -->
  <div class="recycle-header">
    <h2><i class="fas fa-trash-restore" style="margin-left:8px"></i> Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ©</h2>
    <div class="total-badge">
      Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: {{ total_deleted|default:0 }} Ø¹Ù†ØµØ± Ù…Ø­Ø°ÙˆÙ
    </div>
  </div>

  <div style="background:#fff;padding:12px 20px;border-bottom:1px solid #ddd;display:flex;justify-content:space-between;align-items:center">
    <div style="font-size:13px;color:#666">
      <i class="fas fa-info-circle" style="color:#17a2b8;margin-left:5px"></i>
      Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£ÙŠ Ù‚Ø³Ù… Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø­Ø°ÙˆÙØ© ÙÙŠÙ‡ â€¢ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø£Ùˆ Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„ÙƒÙ„ Ø¹Ù†ØµØ±
    </div>
    <div>
      <button onclick="expandAll()" class="btn-action" style="background:#6c757d;color:#fff">
        <i class="fas fa-expand-arrows-alt"></i> ÙØªØ­ Ø§Ù„ÙƒÙ„
      </button>
      <button onclick="collapseAll()" class="btn-action" style="background:#6c757d;color:#fff">
        <i class="fas fa-compress-arrows-alt"></i> Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ÙƒÙ„
      </button>
    </div>
  </div>

  {% if categories %}
    {% for cat in categories %}
    <div class="category-card {{ cat.is_primary|yesno:'primary,secondary' }}">
      <!-- Category Header -->
      <div class="category-header" onclick="toggleCategory('cat-{{ forloop.counter }}')">
        <div class="category-title">
          <span class="toggle-arrow" id="arrow-cat-{{ forloop.counter }}">â—‚</span>
          {{ cat.info.verbose_name_plural }}
          <span class="app-badge">{{ cat.info.app_label_ar }}</span>
          {% if cat.is_primary %}
            <span style="font-size:11px;color:#dc3545;font-weight:normal">â˜… Ø±Ø¦ÙŠØ³ÙŠ</span>
          {% endif %}
        </div>
        <div style="display:flex;align-items:center;gap:10px">
          {% if cat.url %}
            <a href="{{ cat.url }}" class="btn-view" onclick="event.stopPropagation()">
              <i class="fas fa-external-link-alt"></i> Ø¹Ø±Ø¶ ÙÙŠ Ø§Ù„Ø£Ø¯Ù…Ù†
            </a>
          {% endif %}
          <div class="category-count">{{ cat.count }}</div>
        </div>
      </div>

      <!-- Category Body - Items List -->
      <div class="category-body" id="cat-{{ forloop.counter }}">
        {% for item in cat.items %}
        <div class="item-row">
          <div class="item-info">
            <div class="item-name">
              #{{ item.pk }} â€” {{ item.str }}
            </div>
            <div class="item-meta">
              {% if item.deleted_at %}
                <span><i class="fas fa-clock"></i> {{ item.deleted_at|date:"Y/m/d H:i" }}</span>
              {% endif %}
              {% if item.deleted_by %}
                <span><i class="fas fa-user"></i> {{ item.deleted_by }}</span>
              {% endif %}
            </div>

            {% if item.related %}
            <div class="item-related">
              <div class="item-related-title">
                <i class="fas fa-project-diagram"></i> Ø¹Ù†Ø§ØµØ± Ù…Ø±ØªØ¨Ø·Ø© Ù…Ø­Ø°ÙˆÙØ©:
              </div>
              {% for rel in item.related %}
              <div class="related-group">
                <span class="related-badge">{{ rel.count }}</span>
                {{ rel.verbose_name_plural }}
                {% if rel.items %}
                <div class="related-items-list">
                  {% for ri in rel.items %}
                    â€¢ {{ ri.str }}{% if not forloop.last %}<br>{% endif %}
                  {% endfor %}
                  {% if rel.count > 10 %}
                    <br><em>... Ùˆ {{ rel.count|add:"-10" }} Ø¹Ù†Ø§ØµØ± Ø£Ø®Ø±Ù‰</em>
                  {% endif %}
                </div>
                {% endif %}
              </div>
              {% endfor %}
            </div>
            {% endif %}
          </div>

          <div class="item-actions">
            <!-- Restore -->
            <form method="post" style="display:inline">
              {% csrf_token %}
              <input type="hidden" name="recycle_action" value="restore">
              <input type="hidden" name="app_label" value="{{ cat.info.app_label }}">
              <input type="hidden" name="model_name" value="{{ cat.info.model_name }}">
              <input type="hidden" name="pk" value="{{ item.pk }}">
              <button type="submit" class="btn-action btn-restore" title="Ø§Ø³ØªØ¹Ø§Ø¯Ø©">
                <i class="fas fa-undo"></i> Ø§Ø³ØªØ¹Ø§Ø¯Ø©
              </button>
            </form>

            {% if item.related %}
            <!-- Cascade Restore -->
            <form method="post" style="display:inline">
              {% csrf_token %}
              <input type="hidden" name="recycle_action" value="restore">
              <input type="hidden" name="app_label" value="{{ cat.info.app_label }}">
              <input type="hidden" name="model_name" value="{{ cat.info.model_name }}">
              <input type="hidden" name="pk" value="{{ item.pk }}">
              <input type="hidden" name="cascade" value="1">
              <button type="submit" class="btn-action btn-cascade-restore" title="Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù…ØªØ³Ù„Ø³Ù„Ø© Ù…Ø¹ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©">
                <i class="fas fa-redo"></i> Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù…ØªØ³Ù„Ø³Ù„Ø©
              </button>
            </form>
            {% endif %}

            <!-- Hard Delete (superuser only) -->
            {% if request.user.is_superuser %}
            <form method="post" style="display:inline" onsubmit="return confirm('âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©!')">
              {% csrf_token %}
              <input type="hidden" name="recycle_action" value="hard_delete">
              <input type="hidden" name="app_label" value="{{ cat.info.app_label }}">
              <input type="hidden" name="model_name" value="{{ cat.info.model_name }}">
              <input type="hidden" name="pk" value="{{ item.pk }}">
              <button type="submit" class="btn-action btn-hard-delete" title="Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ">
                <i class="fas fa-times"></i> Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ
              </button>
            </form>
            {% endif %}
          </div>
        </div>
        {% endfor %}

        {% if cat.count > cat.items|length %}
        <div style="padding:12px 20px;text-align:center;background:#f8f9fa;border-top:1px solid #eee">
          <a href="{{ cat.url }}" style="color:#4e73df;font-size:13px;font-weight:500">
            <i class="fas fa-arrow-left"></i>
            Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„ ({{ cat.count }}) ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†
          </a>
        </div>
        {% endif %}
      </div>
    </div>
    {% endfor %}
  {% else %}
    <div class="empty-state">
      <i class="fas fa-check-circle"></i>
      <h3>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± Ù…Ø­Ø°ÙˆÙØ©</h3>
      <p>Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª ÙØ§Ø±ØºØ© â€” Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø´Ø·Ø©</p>
    </div>
  {% endif %}
</div>

<script>
function toggleCategory(id) {
  const body = document.getElementById(id);
  const arrow = document.getElementById('arrow-' + id);
  if (body.classList.contains('open')) {
    body.classList.remove('open');
    arrow.classList.remove('open');
  } else {
    body.classList.add('open');
    arrow.classList.add('open');
  }
}

function expandAll() {
  document.querySelectorAll('.category-body').forEach(el => el.classList.add('open'));
  document.querySelectorAll('.toggle-arrow').forEach(el => el.classList.add('open'));
}

function collapseAll() {
  document.querySelectorAll('.category-body').forEach(el => el.classList.remove('open'));
  document.querySelectorAll('.toggle-arrow').forEach(el => el.classList.remove('open'));
}

// Auto-expand primary categories on load
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.category-card.primary').forEach(card => {
    const body = card.querySelector('.category-body');
    const arrow = card.querySelector('.toggle-arrow');
    if (body) body.classList.add('open');
    if (arrow) arrow.classList.add('open');
  });
});
</script>
{% endblock %}
