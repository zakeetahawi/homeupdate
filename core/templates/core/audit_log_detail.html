{% extends 'base.html' %}
{% load i18n audit_tags %}

{% block title %}تفاصيل سجل التدقيق #{{ log.pk }} — نظام الخواجه{% endblock %}

{% block extra_css %}
<style>
    .detail-card {
        border-radius: 12px;
    }
    .detail-card .card-header {
        border-radius: 12px 12px 0 0;
    }
    .detail-label {
        font-weight: 600;
        font-size: 0.85rem;
        color: var(--text-muted, #6c757d);
        min-width: 140px;
    }
    .detail-value {
        font-size: 0.9rem;
    }
    .badge-action {
        font-size: 0.8rem;
        padding: 0.35em 0.65em;
        border-radius: 6px;
    }
    .badge-CREATE { background-color: #28a745; color: #fff; }
    .badge-UPDATE { background-color: #17a2b8; color: #fff; }
    .badge-DELETE { background-color: #dc3545; color: #fff; }
    .badge-LOGIN { background-color: #007bff; color: #fff; }
    .badge-LOGOUT { background-color: #6c757d; color: #fff; }
    .badge-PERMISSION_CHANGE { background-color: #fd7e14; color: #fff; }
    .badge-SECURITY_EVENT { background-color: #e83e8c; color: #fff; }
    .badge-DATA_EXPORT { background-color: #20c997; color: #fff; }
    .badge-SETTINGS_CHANGE { background-color: #ffc107; color: #212529; }
    .badge-VIEW { background-color: #6f42c1; color: #fff; }
    .badge-BULK_UPDATE { background-color: #0dcaf0; color: #212529; }
    .badge-BULK_DELETE { background-color: #842029; color: #fff; }

    .badge-severity-INFO { background-color: #17a2b8; color: #fff; }
    .badge-severity-WARNING { background-color: #ffc107; color: #212529; }
    .badge-severity-ERROR { background-color: #dc3545; color: #fff; }
    .badge-severity-CRITICAL { background-color: #ff0000; color: #fff; font-weight: 700; }

    .changes-table {
        font-size: 0.85rem;
    }
    .changes-table th {
        background-color: var(--primary, #8B735A);
        color: #fff;
        font-size: 0.8rem;
        border: none;
    }
    .changes-table .old-value {
        background-color: rgba(220,53,69,0.06);
        text-decoration: line-through;
        opacity: 0.8;
    }
    .changes-table .new-value {
        background-color: rgba(40,167,69,0.06);
        font-weight: 500;
    }
    .json-block {
        background-color: rgba(0,0,0,0.03);
        border-radius: 8px;
        padding: 1rem;
        font-family: 'Roboto Mono', monospace;
        font-size: 0.8rem;
        direction: ltr;
        text-align: left;
        max-height: 300px;
        overflow-y: auto;
        white-space: pre-wrap;
        word-break: break-all;
    }
    .ip-badge {
        font-family: 'Roboto Mono', monospace;
        font-size: 0.85rem;
        background-color: rgba(0,0,0,0.06);
        padding: 0.25em 0.6em;
        border-radius: 4px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">

    {# ===== العنوان ===== #}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">
            <i class="fas fa-file-alt me-2"></i>تفاصيل سجل التدقيق
            <small class="text-muted">#{{ log.pk }}</small>
        </h2>
        <a href="{% url 'audit:audit_log_list' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-right me-1"></i> العودة للقائمة
        </a>
    </div>

    <div class="row g-4">

        {# ===== المعلومات الأساسية ===== #}
        <div class="col-lg-6">
            <div class="card detail-card shadow-sm">
                <div class="card-header" style="background-color: var(--primary, #8B735A); color: #fff;">
                    <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>المعلومات الأساسية</h6>
                </div>
                <div class="card-body">
                    <table class="table table-borderless mb-0">
                        <tr>
                            <td class="detail-label">التاريخ والوقت</td>
                            <td class="detail-value">
                                <i class="fas fa-clock me-1 text-muted"></i>
                                {{ log.timestamp|date:"Y/m/d — H:i:s" }}
                            </td>
                        </tr>
                        <tr>
                            <td class="detail-label">نوع العملية</td>
                            <td class="detail-value">
                                <span class="badge badge-action badge-{{ log.action }}">
                                    {{ log.get_action_display }}
                                </span>
                            </td>
                        </tr>
                        <tr>
                            <td class="detail-label">الخطورة</td>
                            <td class="detail-value">
                                <span class="badge badge-action badge-severity-{{ log.severity }}">
                                    {{ log.get_severity_display }}
                                </span>
                            </td>
                        </tr>
                        <tr>
                            <td class="detail-label">المستخدم</td>
                            <td class="detail-value">
                                {% if log.user %}
                                    <i class="fas fa-user-circle me-1 text-muted"></i>
                                    {{ log.user.get_full_name|default:log.user.username }}
                                    <small class="text-muted">({{ log.user.username }})</small>
                                {% else %}
                                    <i class="fas fa-robot me-1 text-muted"></i>
                                    {{ log.username|default:"نظام" }}
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td class="detail-label">الوصف</td>
                            <td class="detail-value">{{ log.description }}</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>

        {# ===== معلومات النموذج والاتصال ===== #}
        <div class="col-lg-6">
            <div class="card detail-card shadow-sm">
                <div class="card-header" style="background-color: var(--primary, #8B735A); color: #fff;">
                    <h6 class="mb-0"><i class="fas fa-database me-2"></i>معلومات النموذج والاتصال</h6>
                </div>
                <div class="card-body">
                    <table class="table table-borderless mb-0">
                        <tr>
                            <td class="detail-label">التطبيق</td>
                            <td class="detail-value">{{ log.app_label|default:"—" }}</td>
                        </tr>
                        <tr>
                            <td class="detail-label">النموذج</td>
                            <td class="detail-value">{{ log.model_name|default:"—" }}</td>
                        </tr>
                        <tr>
                            <td class="detail-label">معرف الكائن</td>
                            <td class="detail-value">{{ log.object_id|default:"—" }}</td>
                        </tr>
                        <tr>
                            <td class="detail-label">وصف الكائن</td>
                            <td class="detail-value">{{ log.object_repr|default:"—" }}</td>
                        </tr>
                        <tr>
                            <td class="detail-label">عنوان IP</td>
                            <td class="detail-value">
                                {% if log.ip_address %}
                                    <span class="ip-badge">{{ log.ip_address }}</span>
                                {% else %}
                                    <span class="text-muted">—</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td class="detail-label">المسار</td>
                            <td class="detail-value">
                                {% if log.url_path %}
                                    <code dir="ltr" style="font-size:0.85rem;">
                                        {{ log.http_method }} {{ log.url_path }}
                                    </code>
                                {% else %}
                                    <span class="text-muted">—</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td class="detail-label">الجلسة</td>
                            <td class="detail-value">
                                <small class="text-muted">{{ log.session_key|default:"—" }}</small>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>

        {# ===== التغييرات — حقل بحقل ===== #}
        {% if log.changed_fields %}
        <div class="col-12">
            <div class="card detail-card shadow-sm">
                <div class="card-header" style="background-color: var(--primary, #8B735A); color: #fff;">
                    <h6 class="mb-0">
                        <i class="fas fa-exchange-alt me-2"></i>
                        {% if log.action == "CREATE" %}
                            البيانات المُسجلة
                        {% elif log.action == "DELETE" %}
                            البيانات المحذوفة
                        {% else %}
                            التغييرات — ما كان وما تبدّل
                        {% endif %}
                        <span class="badge bg-light text-dark ms-2">{{ log.changed_fields|length }} حقل</span>
                    </h6>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table changes-table mb-0">
                            <thead>
                                <tr>
                                    <th style="width:200px;">الحقل</th>
                                    {% if log.action == "CREATE" %}
                                        <th>القيمة</th>
                                    {% elif log.action == "DELETE" %}
                                        <th>القيمة قبل الحذف</th>
                                    {% else %}
                                        <th>القيمة القديمة</th>
                                        <th>القيمة الجديدة</th>
                                    {% endif %}
                                </tr>
                            </thead>
                            <tbody>
                                {% if log.action == "CREATE" and log.new_value %}
                                    {# إنشاء: نعرض القيم الجديدة فقط #}
                                    {% for field_name in log.changed_fields %}
                                    <tr>
                                        <td><strong>{{ field_name }}</strong></td>
                                        <td class="new-value">{{ log.new_value|get_dict_value:field_name }}</td>
                                    </tr>
                                    {% endfor %}
                                {% elif log.action == "DELETE" and log.old_value %}
                                    {# حذف: نعرض القيم القديمة فقط #}
                                    {% for field_name in log.changed_fields %}
                                    <tr>
                                        <td><strong>{{ field_name }}</strong></td>
                                        <td class="old-value">{{ log.old_value|get_dict_value:field_name }}</td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    {# تعديل: نعرض القيم القديمة والجديدة #}
                                    {% for change in log.changes_summary %}
                                    <tr>
                                        <td><strong>{{ change.field }}</strong></td>
                                        <td class="old-value">{{ change.old }}</td>
                                        <td class="new-value">{{ change.new }}</td>
                                    </tr>
                                    {% endfor %}
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        {# ===== القيم الكاملة — قابل للطي ===== #}
        {% if log.old_value or log.new_value %}
        <div class="col-12">
            <div class="card detail-card shadow-sm">
                <div class="card-header bg-secondary bg-opacity-75 text-white"
                     data-bs-toggle="collapse" data-bs-target="#rawJsonCollapse"
                     style="cursor: pointer;">
                    <h6 class="mb-0 d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-code me-2"></i>البيانات الخام (JSON)</span>
                        <i class="fas fa-chevron-down"></i>
                    </h6>
                </div>
                <div class="collapse" id="rawJsonCollapse">
                    <div class="card-body">
                        <div class="row g-3">
                            {% if log.old_value %}
                            <div class="{% if log.new_value %}col-lg-6{% else %}col-12{% endif %}">
                                <h6 class="text-danger mb-2"><i class="fas fa-minus-circle me-1"></i>القيم القديمة</h6>
                                <div class="json-block">{{ log.old_value|pprint }}</div>
                            </div>
                            {% endif %}
                            {% if log.new_value %}
                            <div class="{% if log.old_value %}col-lg-6{% else %}col-12{% endif %}">
                                <h6 class="text-success mb-2"><i class="fas fa-plus-circle me-1"></i>القيم الجديدة</h6>
                                <div class="json-block">{{ log.new_value|pprint }}</div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        {# ===== بيانات إضافية ===== #}
        {% if log.extra_data %}
        <div class="col-12">
            <div class="card detail-card shadow-sm">
                <div class="card-header" style="background-color: var(--secondary, #A67B5B); color: #fff;">
                    <h6 class="mb-0"><i class="fas fa-database me-2"></i>بيانات إضافية</h6>
                </div>
                <div class="card-body">
                    <div class="json-block">{{ log.extra_data|pprint }}</div>
                </div>
            </div>
        </div>
        {% endif %}

        {# ===== User Agent ===== #}
        {% if log.user_agent %}
        <div class="col-12">
            <div class="card detail-card shadow-sm">
                <div class="card-header bg-secondary bg-opacity-75 text-white">
                    <h6 class="mb-0"><i class="fas fa-desktop me-2"></i>User Agent</h6>
                </div>
                <div class="card-body">
                    <code dir="ltr" style="font-size:0.8rem; word-break: break-all;">
                        {{ log.user_agent }}
                    </code>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

</div>
{% endblock %}
