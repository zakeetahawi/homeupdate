{% extends 'base.html' %}
{% load static %}

{% block title %}Ø±ÙØ¹ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©{% endblock %}

{% block extra_css %}
<style>
    .rtl-popup {
        direction: rtl;
        text-align: right;
    }
    .rtl-title {
        text-align: right;
    }
    .rtl-content {
        text-align: right;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Ø±ÙØ¹ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</h3>
                </div>
                
                <div class="card-body">
                    <form id="restoreForm" method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        
                        <div class="form-group">
                            <label for="backup_file">Ù…Ù„Ù Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©:</label>
                            <input type="file" class="form-control-file" id="backup_file" name="backup_file" accept=".json,.gz" required>
                            <small class="form-text text-muted">ÙŠØ¯Ø¹Ù… Ù…Ù„ÙØ§Øª JSON Ùˆ GZ</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="database_id">Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:</label>
                            <select class="form-control" id="database_id" name="database_id" required>
                                <option value="">Ø§Ø®ØªØ± Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</option>
                                {% for db in databases %}
                                <option value="{{ db.id }}" {% if db.is_active %}selected{% endif %}>
                                    {{ db.name }} {% if db.is_active %}(Ù†Ø´Ø·Ø©){% endif %}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="clear_existing" name="clear_existing" value="1">
                                <label class="form-check-label" for="clear_existing">
                                    Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©
                                </label>
                                <small class="form-text text-muted">ØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</small>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-upload"></i> Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©
                            </button>
                            <a href="{% url 'odoo_db_manager:dashboard' %}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Ø§Ù„Ø¹ÙˆØ¯Ø©
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
console.log('ğŸš€ [DEBUG] JavaScript script starting...');

// Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø© Ù„Ù„ØªØªØ¨Ø¹
let tempToken = null;
let progressInterval;
let errorCount = 0;
const maxErrors = 5;

// Ø¯Ø§Ù„Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Ø¯Ø§Ù„Ø© Ù„ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø¬Ù„Ø³Ø© - ØªÙ… Ø­Ø°ÙÙ‡Ø§ Ù„Ø£Ù†Ù‡Ø§ Ù„Ù… ØªØ¹Ø¯ Ù…Ø·Ù„ÙˆØ¨Ø© Ù…Ø¹ Ø§Ù„Ø­Ù„ Ø§Ù„Ù…Ø¨Ø³Ø·

// Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙ‚Ø¯Ù… Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ø­Ø³Ù†Ø© Ù„Ù„Ø£Ø®Ø·Ø§Ø¡
async function checkProgress(sessionId) {
    console.log('ğŸ” [DEBUG] Checking progress for session:', sessionId);
    
    try {
        const headers = {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': getCookie('csrftoken')
        };

        const response = await fetch(`/odoo-db-manager/restore-progress/${sessionId}/status/`, {
            method: 'GET',
            headers: headers,
            credentials: 'same-origin'
        });
        
        console.log('ğŸ” [DEBUG] Progress response status:', response.status);
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†ÙˆØ¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            const text = await response.text();
            throw new Error('Invalid response format: ' + text.substring(0, 100));
        }
        
        const data = await response.json();
        console.log('ğŸ” [DEBUG] Progress data:', data);
        
        return data;
        
    } catch (error) {
        console.error('âŒ [DEBUG] Error checking progress:', error);
        throw error;
    }
}

// Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø¯Ù…
function updateProgressDisplay(data) {
    if (!data) return;
    
    // ØªØ­Ø¯ÙŠØ« Ù…Ø­ØªÙˆÙ‰ SweetAlert
    Swal.update({
        html: `
            <div style="direction: rtl; text-align: right;">
                <h4 style="margin-bottom: 20px;">Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h4>
                <div style="margin-bottom: 15px;">
                    <div style="background: #e9ecef; border-radius: 10px; height: 20px; overflow: hidden;">
                        <div style="background: linear-gradient(90deg, #007bff, #0056b3); height: 100%; width: ${data.progress_percentage || 0}%; transition: width 0.3s ease;"></div>
                    </div>
                    <div style="text-align: center; margin-top: 5px; font-weight: bold;">${data.progress_percentage || 0}%</div>
                </div>
                <div style="margin-bottom: 10px;">
                    <strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> ${data.current_step || 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...'}
                </div>
                <div style="margin-bottom: 10px;">
                    ${data.total_items > 0 ? `
                        <strong>Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</strong> Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¹Ù†ØµØ± ${(data.processed_items || 0) + 1} Ù…Ù† ${data.total_items}...<br>
                        <strong>Ø§Ù„ØªÙ‚Ø¯Ù…:</strong> ${data.processed_items || 0} Ù…Ù† ${data.total_items} Ø¹Ù†ØµØ±<br>
                        <strong>Ù†Ø¬Ø­:</strong> ${data.success_count || 0}<br>
                        <strong>ÙØ´Ù„:</strong> ${data.error_count || 0}
                    ` : data.current_step || 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...'}
                </div>
            </div>
        `
    });
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
    if (data.status === 'completed') {
        clearInterval(progressInterval);
        progressInterval = null;
        
        // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
        const result = data.result_data || {};
        let successMessage = `
            <div style="direction: rtl; text-align: right;">
                <h4 style="color: #28a745; margin-bottom: 20px;">âœ… ØªÙ…Øª Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­!</h4>
        `;
        
        if (result.total_items) {
            successMessage += `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <strong>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©:</strong><br>
                    Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù†Ø§ØµØ±: ${result.total_items}<br>
                    Ù†Ø¬Ø­: ${result.success_count}<br>
                    ÙØ´Ù„: ${result.error_count}
                </div>
            `;
            
            if (result.errors && result.errors.length > 0) {
                successMessage += `
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <strong>Ø£ÙˆÙ„ 5 Ø£Ø®Ø·Ø§Ø¡:</strong><br>
                        ${result.errors.slice(0, 5).map(error => `â€¢ ${error}`).join('<br>')}
                    </div>
                `;
            }
        }
        
        successMessage += `</div>`;
        
        Swal.fire({
            icon: 'success',
            title: 'ØªÙ…Øª Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­!',
            html: successMessage,
            confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹',
            customClass: {
                popup: 'rtl-popup',
                title: 'rtl-title',
                content: 'rtl-content'
            }
        }).then(() => {
            window.location.reload();
        });
        
    } else if (data.status === 'failed') {
        clearInterval(progressInterval);
        progressInterval = null;
        
        Swal.fire({
            icon: 'error',
            title: 'ÙØ´Ù„Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©',
            html: `
                <div style="direction: rtl; text-align: right;">
                    <p><strong>Ø³Ø¨Ø¨ Ø§Ù„ÙØ´Ù„:</strong></p>
                    <p>${data.error_message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹'}</p>
                </div>
            `,
            confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹',
            customClass: {
                popup: 'rtl-popup',
                title: 'rtl-title',
                content: 'rtl-content'
            }
        });
    }
}

// Ø¯Ø§Ù„Ø© Ù„ØªØªØ¨Ø¹ Ø§Ù„ØªÙ‚Ø¯Ù… Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ø­Ø³Ù†Ø© Ù„Ù„Ø£Ø®Ø·Ø§Ø¡
function startProgressTracking(sessionId) {
    console.log('ğŸ” [DEBUG] Starting progress tracking for session:', sessionId);
    
    const runCheck = () => {
        checkProgress(sessionId)
        .then(data => {
            errorCount = 0;
            
            updateProgressDisplay(data);
            
            // Ø¥Ø°Ø§ Ù„Ù… ØªÙƒØªÙ…Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©ØŒ Ø§Ø³ØªÙ…Ø± ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚
            if (data.status !== 'completed' && data.status !== 'failed') {
                progressInterval = setTimeout(runCheck, 1500); // Ø§Ø³ØªÙ…Ø± ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ø¹Ø¯ 1.5 Ø«Ø§Ù†ÙŠØ©
            }
        })
        .catch(error => {
            console.error(`âŒ [DEBUG] Error checking progress:`, error);
            
            errorCount++;
            console.error(`âŒ [DEBUG] Progress tracking error (${errorCount}/${maxErrors}):`, error);
            
            if (errorCount >= maxErrors) {
                clearTimeout(progressInterval);
                Swal.fire({
                    icon: 'error',
                    title: 'Ø®Ø·Ø£ ÙÙŠ ØªØªØ¨Ø¹ Ø§Ù„ØªÙ‚Ø¯Ù…',
                    html: `<div style="direction: rtl; text-align: right;">
                            <p>Ø­Ø¯Ø« Ø®Ø·Ø£ Ù…ØªÙƒØ±Ø± ÙÙŠ ØªØªØ¨Ø¹ Ø§Ù„ØªÙ‚Ø¯Ù….</p>
                            <p><strong>Ø§Ù„Ø®Ø·Ø£:</strong> ${error.message}</p>
                            <p><strong>Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù‚Ø¯ ØªÙƒÙˆÙ† Ù…ÙƒØªÙ…Ù„Ø© ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©.</p>
                           </div>`,
                    confirmButtonText: 'Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©',
                    customClass: { popup: 'rtl-popup', title: 'rtl-title', content: 'rtl-content' }
                }).then(() => { window.location.reload(); });
            } else {
                // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¹Ø¯ ÙØªØ±Ø© Ù‚ØµÙŠØ±Ø©
                progressInterval = setTimeout(runCheck, 2000);
            }
        });
    };
    
    // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚ ÙÙˆØ±Ø§Ù‹
    runCheck();
}


// Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
document.addEventListener('DOMContentLoaded', function() {
    console.log('âœ… [DEBUG] DOM loaded, initializing form handler');
    
    const restoreForm = document.getElementById('restoreForm');
    
    if (restoreForm) {
        restoreForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            console.log('ğŸ” [DEBUG] Form submitted');
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            const fileInput = document.getElementById('backup_file');
            const databaseSelect = document.getElementById('database_id');
            
            if (!fileInput.files[0]) {
                Swal.fire({
                    icon: 'error',
                    title: 'Ø®Ø·Ø£',
                    text: 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©',
                    customClass: {
                        popup: 'rtl-popup',
                        title: 'rtl-title',
                        content: 'rtl-content'
                    }
                });
                return;
            }
            
            if (!databaseSelect.value) {
                Swal.fire({
                    icon: 'error',
                    title: 'Ø®Ø·Ø£',
                    text: 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª',
                    customClass: {
                        popup: 'rtl-popup',
                        title: 'rtl-title',
                        content: 'rtl-content'
                    }
                });
                return;
            }
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø±Ù Ø¬Ù„Ø³Ø© ÙØ±ÙŠØ¯
            const currentSessionId = 'restore_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            console.log('ğŸ” [DEBUG] Generated session ID:', currentSessionId);
            
            // Ø¹Ø±Ø¶ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
            Swal.fire({
                title: 'Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...',
                html: `
                    <div style="direction: rtl; text-align: right;">
                        <h4 style="margin-bottom: 20px;">Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h4>
                        <div style="margin-bottom: 15px;">
                            <div style="background: #e9ecef; border-radius: 10px; height: 20px; overflow: hidden;">
                                <div style="background: linear-gradient(90deg, #007bff, #0056b3); height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                            </div>
                            <div style="text-align: center; margin-top: 5px; font-weight: bold;">0%</div>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> Ø¬Ø§Ø±ÙŠ Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©...
                        </div>
                        <div style="margin-bottom: 10px;">
                            <strong>Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</strong> Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬...
                        </div>
                    </div>
                `,
                allowOutsideClick: false,
                allowEscapeKey: false,
                showConfirmButton: false,
                customClass: {
                    popup: 'rtl-popup',
                    title: 'rtl-title',
                    content: 'rtl-content'
                }
            });
            
            // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
            const formData = new FormData(restoreForm);
            formData.append('session_id', currentSessionId);
            
            console.log('ğŸ” [DEBUG] Sending form with session_id:', currentSessionId);
            
            // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
            fetch(restoreForm.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                },
                credentials: 'same-origin'
            })
            .then(response => {
                console.log('âœ… [DEBUG] Form submitted successfully, status:', response.status);
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    console.log('âœ… [DEBUG] Form submission successful');
                    tempToken = data.temp_token; // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ù…Ø¤Ù‚Øª
                    console.log('âœ… [DEBUG] Temp token stored.');
                    
                    // Ø¨Ø¯Ø¡ ØªØªØ¨Ø¹ Ø§Ù„ØªÙ‚Ø¯Ù… ÙÙ‚Ø· Ø¨Ø¹Ø¯ Ù†Ø¬Ø§Ø­ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
                    startProgressTracking(currentSessionId);

                } else {
                    throw new Error(data.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹');
                }
            })
            .catch(error => {
                console.error('âŒ [DEBUG] Form submission error:', error);
                
                // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØªØ¨Ø¹
                if (progressInterval) {
                    clearTimeout(progressInterval); // Ø§Ø³ØªØ®Ø¯Ø§Ù… clearTimeout
                    progressInterval = null;
                }
                
                Swal.fire({
                    icon: 'error',
                    title: 'Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬',
                    text: error.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹',
                    customClass: {
                        popup: 'rtl-popup',
                        title: 'rtl-title',
                        content: 'rtl-content'
                    }
                });
            });
        });
    }
});

console.log('âœ… [DEBUG] Script loaded successfully');
</script>
{% endblock %} 