# Cloudflare Workers Configuration
# This file configures two workers:
# 1. QR Scanner Worker (existing)
# 2. Error Handler Worker (new - for custom error pages)

# ═══════════════════════════════════════════════════════════════════
# QR Scanner Worker (Existing)
# ═══════════════════════════════════════════════════════════════════
name = "elkhawaga-qr"
main = "src/index.js"
compatibility_date = "2024-01-01"
workers_dev = true

# KV Namespace binding
[[kv_namespaces]]
binding = "PRODUCTS_KV"
id = "5dad2f4d72b246758bdafa17dfe4eb10"

# ═══ Queue (Sync Queue) ═══════════════════════════════════════════
# Producer: Worker يدفع رسائل المزامنة بدلاً من الكتابة المباشرة في KV
# Consumer: نفس Worker يعالج الرسائل ويكتب في KV بشكل موثوق
# إنشاء Queue: npx wrangler queues create elkhawaga-sync-queue

[[queues.producers]]
binding   = "SYNC_QUEUE"
queue     = "elkhawaga-sync-queue"

[[queues.consumers]]
queue             = "elkhawaga-sync-queue"
max_batch_size    = 25   # عدد الرسائل لكل batch
max_batch_timeout = 5    # ثوان للانتظار قبل معالجة batch ناقص
max_retries       = 3    # محاولات إعادة تلقائية عند الفشل

# Environment variables
[vars]
SITE_NAME = "الخواجة"
MAIN_SITE_URL = "https://www.elkhawaga.uk"
SYNC_API_KEY = "cf_66eed06368ff433b92ac3f80c950038f"

# Production environment for QR Scanner
[env.production]
name = "elkhawaga-qr"
workers_dev = false
route = { pattern = "qr.elkhawaga.uk/*", zone_name = "elkhawaga.uk" }

# KV for production
[[env.production.kv_namespaces]]
binding = "PRODUCTS_KV"
id = "5dad2f4d72b246758bdafa17dfe4eb10"

# Queue for production
[[env.production.queues.producers]]
binding   = "SYNC_QUEUE"
queue     = "elkhawaga-sync-queue"

[[env.production.queues.consumers]]
queue             = "elkhawaga-sync-queue"
max_batch_size    = 25
max_batch_timeout = 5
max_retries       = 3

[env.production.vars]
SITE_NAME = "الخواجة"
MAIN_SITE_URL = "https://www.elkhawaga.uk"
SYNC_API_KEY = "cf_66eed06368ff433b92ac3f80c950038f"

# ═══════════════════════════════════════════════════════════════════
# Error Handler Worker (New)
# ═══════════════════════════════════════════════════════════════════
# Note: This worker should be deployed separately
# Use: npx wrangler deploy --config wrangler-error.toml
# Or deploy via Cloudflare Dashboard and configure routes manually
