{% extends 'base.html' %}
{% load static %}
{% load unified_status_tags %}

{% block title %}قائمة التركيبات{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
<style>
    /* تنسيق الفلاتر المتقدمة */
    .filter-card {
        transition: all 0.3s ease;
        border: none !important;
    }
    .filter-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 30px rgba(0,0,0,0.1) !important;
    }
    .advanced-filter-form .form-floating {
        position: relative;
    }
    .advanced-filter-form .form-floating > .form-select,
    .advanced-filter-form .form-floating > .form-control {
        border-radius: 10px;
        border: 2px solid #e9ecef;
        transition: all 0.3s ease;
        font-size: 14px;
        padding: 12px 16px;
    }
    .advanced-filter-form .form-floating > .form-select:focus,
    .advanced-filter-form .form-floating > .form-control:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        transform: translateY(-1px);
    }
    .advanced-filter-form .form-floating > label {
        color: #6c757d;
        font-weight: 500;
        font-size: 13px;
        padding: 8px 16px;
    }
    .advanced-filter-form .form-floating > .form-select:focus ~ label,
    .advanced-filter-form .form-floating > .form-control:focus ~ label,
    .advanced-filter-form .form-floating > .form-select:not(:placeholder-shown) ~ label,
    .advanced-filter-form .form-floating > .form-control:not(:placeholder-shown) ~ label {
        color: #667eea;
        font-weight: 600;
    }
    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    .btn-outline-danger {
        border: 2px solid #dc3545;
        color: #dc3545;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    .btn-outline-danger:hover {
        background: #dc3545;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(220, 53, 69, 0.4);
    }
    .btn-success {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        border: none;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    .btn-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
    }
    .input-group-text {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border: 2px solid #e9ecef;
        color: #6c757d;
    }
    .input-group .form-control {
        border: 2px solid #e9ecef;
        border-left: none;
        border-right: none;
    }
    .input-group .form-control:focus {
        border-color: #667eea;
        box-shadow: none;
    }
    .input-group .form-control:focus + .btn,
    .input-group .form-control:focus ~ .input-group-text {
        border-color: #667eea;
    }
    .badge {
        font-size: 12px;
        font-weight: 600;
        padding: 8px 12px;
        border-radius: 20px;
    }

    /* بادج عدد الشبابيك */
    .badge-pill.windows-badge {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        font-size: 0.9rem;
        padding: 0.5rem 1rem;
        box-shadow: 0 4px 6px rgba(102, 126, 234, 0.3);
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .badge-pill.windows-badge:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(102, 126, 234, 0.4);
    }

    .badge-pill.windows-badge i {
        font-size: 1rem;
    }
    .applied-filters .badge {
        margin: 2px;
        position: relative;
        padding-right: 25px;
    }
    .applied-filters .badge a {
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        text-decoration: none;
        font-weight: bold;
        font-size: 14px;
    }
    @media (max-width: 768px) {
        .filter-stats {
            flex-direction: column;
            gap: 5px;
        }
        .filter-stats .badge {
            font-size: 11px;
            padding: 6px 10px;
        }
        .advanced-filter-form .btn-lg {
            font-size: 14px;
            padding: 10px 15px;
        }
    }
    .filter-card {
        animation: slideInDown 0.5s ease-out;
    }
    @keyframes slideInDown {
        from {
            opacity: 0;
            transform: translateY(-30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    .form-floating {
        animation: fadeInUp 0.6s ease-out;
    }
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    /* --- محتوى البلوك الثاني --- */
    .card { 
        border-radius: 0.5rem; 
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        border: 1px solid rgba(0, 0, 0, 0.125);
        transition: all 0.3s ease;
    } 
    .card:hover {
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        transform: translateY(-2px);
    }
    .badge { 
        font-size: 0.75rem; 
        font-weight: 600; 
        border-radius: 0.375rem; 
        padding: 0.375rem 0.5rem; 
        transition: all 0.2s ease;
    } 
    .badge:hover {
        transform: scale(1.05);
    }
    .badge-success { 
        background-color: #28a745 !important;
        color: white !important;
    } 
    .badge-info { 
        background-color: #17a2b8 !important;
        color: white !important;
    } 
    .badge-primary { 
        background-color: #007bff !important;
        color: white !important;
    } 
    .badge-warning { 
        background-color: #ffc107 !important;
        color: #212529 !important;
    } 
    .badge-danger { 
        background-color: #dc3545 !important;
        color: white !important;
    } 
    .badge-secondary { 
        background-color: #6c757d !important;
        color: white !important;
    } 
    .filter-card {
        border-radius: 0.5rem;
        border: 1px solid rgba(0, 0, 0, 0.125);
    }
</style>
{% endblock %}

{% block content %}
{% csrf_token %}
<div class="container-fluid">
    <!-- عنوان الصفحة -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">
                <i class="fas fa-list text-primary"></i>
                قائمة التركيبات
            </h1>
            <!-- عرض الفلتر المطبق إن وجد -->
            {% if request.GET.status %}
                <div class="mt-2">
                    <span class="badge badge-primary fs-6">
                        <i class="fas fa-filter me-1"></i>
                        مفلتر حسب: 
                        {% if request.GET.status == 'completed' %}مكتمل
                        {% elif request.GET.status == 'scheduled' %}مجدول
                        {% elif request.GET.status == 'needs_scheduling' %}بانتظار الجدولة
                        {% elif request.GET.status == 'under_manufacturing' %}تحت التصنيع
                        {% elif request.GET.status == 'in_installation' %}قيد التركيب
                        {% elif request.GET.status == 'modification_required' %}يحتاج تعديل
                        {% elif request.GET.status == 'cancelled' %}ملغي
                        {% elif request.GET.status == 'modification_in_progress' %}التعديل قيد التنفيذ
                        {% elif request.GET.status == 'modification_completed' %}التعديل مكتمل
                        {% else %}{{ request.GET.status }}{% endif %}
                    </span>
                </div>
            {% elif request.GET.search %}
                <div class="mt-2">
                    <span class="badge badge-info fs-6">
                        <i class="fas fa-search me-1"></i>
                        بحث عن: "{{ request.GET.search }}"
                    </span>
                </div>
            {% endif %}
        </div>
        <a href="{% url 'installations:dashboard' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-right"></i> العودة للوحة التحكم
        </a>
    </div>

    <!-- فلاتر البحث المحسّنة والحديثة -->
    <div class="card filter-card shadow-lg mb-4" style="border: none; border-radius: 15px;">
        <div class="card-header py-4" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 15px 15px 0 0;">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="m-0 text-white fw-bold">
                    <i class="fas fa-filter me-2"></i>
                    فلاتر البحث والعرض المتقدمة
                </h5>
                <div class="filter-stats d-flex gap-2">
                    <span class="badge bg-light text-dark fs-6 px-3 py-2">
                        <i class="fas fa-list me-1"></i>
                        {{ total_count }} نتيجة
                    </span>
                    {% if needs_scheduling_count %}
                        <span class="badge bg-warning text-dark fs-6 px-3 py-2">
                            <i class="fas fa-clock me-1"></i>
                            {{ needs_scheduling_count }} بحاجة جدولة
                        </span>
                    {% endif %}
                    {% if scheduled_count %}
                        <span class="badge bg-primary fs-6 px-3 py-2">
                            <i class="fas fa-calendar-check me-1"></i>
                            {{ scheduled_count }} مجدول
                        </span>
                    {% endif %}
                    {% if completed_count %}
                        <span class="badge bg-success fs-6 px-3 py-2">
                            <i class="fas fa-check-circle me-1"></i>
                            {{ completed_count }} مكتمل
                        </span>
                    {% endif %}
                </div>
            </div>
        </div>
        <!-- Installations Filter -->
        {% include 'includes/installations_filter.html' %}

        </div>
    </div>

    <!-- جدول التركيبات -->
    <div class="card" style="border-color: var(--neutral);">
        <div class="card-header" style="background-color: var(--primary); color: white;">
            <h6 class="m-0 font-weight-bold text-white">
                <i class="fas fa-table"></i>
                التركيبات ({{ page_obj.paginator.count }})
                <small class="ms-2 opacity-75">
                    <i class="fas fa-calendar-alt"></i> السنة: {{ default_year }}
                </small>
            </h6>
        </div>
        <div class="card-body">
            {% if installations %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover installations-table" width="100%" cellspacing="0">
                        <thead>
                            <tr>
                                <th>رقم الطلب</th>
                                <th>العميل</th>
                                <th>رقم الهاتف</th>
                                <th>العنوان</th>
                                <th>المكان</th>
                                <th>البائع</th>
                                <th>رقم العقد</th>
                                <th>رقم الفاتورة</th>
                                <th>الفرع</th>
                                <th>الفريق</th>
                                <th>التاريخ</th>
                                <th>الموعد</th>
                                <th>عدد الشبابيك</th>
                                <th>القيمة المتبقية</th>
                                <th>الحالة</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in installations %}
                            <tr>
                                <td>
                                    <a href="{% url 'orders:order_detail' item.order.id %}" class="font-weight-bold text-primary" title="تفاصيل الطلب الأساسي">
                                        {{ item.order.order_number }}
                                    </a>
                                </td>
                                <td>
                                    <a href="{% url 'customers:customer_detail' item.order.customer.id %}" class="font-weight-bold text-info" title="بطاقة العميل">
                                        {{ item.order.customer.name }}
                                    </a>
                                    {% if item.order.total_amount and item.order.paid_amount and item.order.remaining_amount > 0 %}
                                        <br><small class="text-warning">
                                            <i class="fas fa-exclamation-triangle"></i>
                                            مديونية: {{ item.order.remaining_amount|floatformat:2 }} ج.م
                                        </small>
                                    {% endif %}
                                </td>
                                <td>{{ item.order.customer.phone }}</td>
                                <td>{{ item.order.customer.address|default:"غير محدد" }}</td>
                                <td>
                                    {% if item.installation and item.installation.location_type == 'open' %}
                                        <span class="badge badge-success">مفتوح</span>
                                    {% elif item.installation and item.installation.location_type == 'compound' %}
                                        <span class="badge badge-info">كومبوند</span>
                                    {% else %}
                                        <span class="text-muted">غير محدد</span>
                                    {% endif %}
                                </td>
                                <td>{{ item.order.salesperson.name|default:"غير محدد" }}</td>
                                <td>
                                    {{ item.order.contract_number|default:"غير محدد" }}
                                    {% if item.order.contract_number_2 %}<br><span class="text-muted">{{ item.order.contract_number_2 }}</span>{% endif %}
                                    {% if item.order.contract_number_3 %}<br><span class="text-muted">{{ item.order.contract_number_3 }}</span>{% endif %}
                                </td>
                                <td>
                                    {{ item.order.invoice_number|default:"غير محدد" }}
                                    {% if item.order.invoice_number_2 %}<br><span class="text-muted">{{ item.order.invoice_number_2 }}</span>{% endif %}
                                    {% if item.order.invoice_number_3 %}<br><span class="text-muted">{{ item.order.invoice_number_3 }}</span>{% endif %}
                                </td>
                                <td>{{ item.order.branch.name|default:"غير محدد" }}</td>
                                <td>{{ item.team.name|default:"غير محدد" }}</td>
                                <td>
                                    {% if item.scheduled_date %}
                                        {{ item.scheduled_date|date:"Y-m-d" }}
                                        {% if item.installation and item.installation.scheduled_time %}
                                            <br><small class="text-muted">{{ item.installation.scheduled_time|time:"H:i" }}</small>
                                        {% endif %}
                                    {% else %}
                                        <span class="text-muted">غير محدد</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if item.installation and item.installation.scheduled_time %}
                                        {{ item.installation.scheduled_time|time:"H:i" }}
                                    {% else %}
                                        <span class="text-muted">غير محدد</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if item.windows_count %}
                                        <span class="badge badge-pill" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-size: 0.9rem; padding: 0.5rem 1rem;">
                                            <i class="fas fa-window-maximize"></i>
                                            {{ item.windows_count }}
                                        </span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if item.order.total_amount and item.order.paid_amount %}
                                        {% if item.order.remaining_amount > 0 %}
                                            <span class="badge badge-warning" style="cursor: pointer;" 
                                                  onclick="showDebtWarning('{{ item.order.customer.name|escapejs }}', '{{ item.order.remaining_amount }}', '{{ item.order.id }}')">
                                                <i class="fas fa-exclamation-triangle"></i>
                                                {{ item.order.remaining_amount|floatformat:2 }} ج.م
                                            </span>
                                        {% else %}
                                            <span class="badge badge-success">
                                                <i class="fas fa-check-circle"></i>
                                                مدفوع بالكامل
                                            </span>
                                        {% endif %}
                                    {% else %}
                                        <span class="text-muted">غير محدد</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if item.status == 'needs_scheduling' %}
                                        <span class="badge badge-warning">
                                            <i class="fas fa-calendar-plus"></i> بحاجة جدولة
                                        </span>
                                    {% elif item.status == 'under_manufacturing' %}
                                        <span class="badge badge-secondary">
                                            <i class="fas fa-industry"></i> تحت التصنيع
                                        </span>
                                        {% if item.manufacturing_status %}
                                            <br><small class="text-muted">
                                                {% if item.manufacturing_status == 'pending_approval' %}قيد الموافقة
                                                {% elif item.manufacturing_status == 'approved' %}تمت الموافقة
                                                {% elif item.manufacturing_status == 'in_cutting' %}قيد القص
                                                {% elif item.manufacturing_status == 'cutting_completed' %}تم القص
                                                {% elif item.manufacturing_status == 'in_manufacturing' %}قيد التصنيع
                                                {% elif item.manufacturing_status == 'quality_check' %}فحص الجودة
                                                {% else %}{{ item.manufacturing_status }}{% endif %}
                                            </small>
                                        {% endif %}
                                    {% elif item.status == 'scheduled' %}
                                        <span class="badge badge-info">
                                            <i class="fas fa-calendar-check"></i> مجدول
                                        </span>
                                    {% elif item.status == 'in_installation' %}
                                        <span class="badge badge-primary">
                                            <i class="fas fa-tools"></i> قيد التركيب
                                        </span>
                                    {% elif item.status == 'completed' %}
                                        <span class="badge badge-success">
                                            <i class="fas fa-check-circle"></i> مكتمل
                                        </span>
                                    {% elif item.status == 'cancelled' %}
                                        <span class="badge badge-danger">
                                            <i class="fas fa-times-circle"></i> ملغي
                                        </span>
                                    {% elif item.status == 'modification_required' %}
                                        <span class="badge badge-warning">
                                            <i class="fas fa-exclamation-triangle"></i> يحتاج تعديل
                                        </span>
                                    {% elif item.status == 'modification_in_progress' %}
                                        <span class="badge badge-info">
                                            <i class="fas fa-cogs"></i> التعديل قيد التنفيذ
                                        </span>
                                    {% elif item.status == 'modification_completed' %}
                                        <span class="badge badge-success">
                                            <i class="fas fa-check-circle"></i> التعديل مكتمل
                                        </span>
                                    {% else %}
                                        <span class="badge badge-secondary">
                                            {% if item.installation %}{{ item.installation.get_status_display }}{% else %}{{ item.status }}{% endif %}
                                        </span>
                                    {% endif %}
                                    
                                    <!-- عرض حالة الطلب الأصلي -->
                                    {% if item.order.is_manufacturing_order %}
                                        {% if item.order.is_delivered_manufacturing_order %}
                                            <br><small class="text-info">
                                                <i class="fas fa-truck"></i> تم التسليم (أمر تصنيع)
                                            </small>
                                        {% else %}
                                            <br><small class="text-warning">
                                                <i class="fas fa-industry"></i> جاهز للتركيب (أمر تصنيع)
                                            </small>
                                        {% endif %}
                                    {% elif item.order.order_status == 'ready_install' or item.order.order_status == 'completed' %}
                                        <br><small class="text-success">
                                            <i class="fas fa-check-circle"></i> جاهز للتركيب
                                        </small>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm action-buttons">
                                        {% if item.installation %}
                                            <a href="{% url 'installations:installation_detail' item.installation.pk %}" class="btn btn-info" title="عرض">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            {% if perms.installations.change_installationschedule %}
                                                <a href="{% url 'installations:edit_schedule' item.installation.pk %}" class="btn btn-primary" title="تعديل">
                                                    <i class="fas fa-edit"></i>
                                                </a>
                                            {% endif %}
                                            {% if perms.installations.delete_installationschedule %}
                                                <a href="{% url 'installations:installation_delete' item.installation.pk %}" class="btn btn-danger" title="حذف">
                                                    <i class="fas fa-trash"></i>
                                                </a>
                                            {% endif %}
                                        {% elif item.status == 'under_manufacturing' %}
                                            <!-- الطلبات تحت التصنيع - للعرض فقط -->
                                            <a href="{% url 'orders:order_detail' item.order.id %}" class="btn btn-info" title="تفاصيل الطلب">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <span class="badge badge-secondary" title="لا يمكن جدولة طلب تحت التصنيع">
                                                <i class="fas fa-lock"></i> تحت التصنيع
                                            </span>
                                        {% else %}
                                            <!-- زر جدولة للطلبات غير المجدولة -->
                                            <button class="btn btn-success schedule-installation-btn"
                                                    data-order-id="{{ item.order.id }}"
                                                    data-schedule-url="{% url 'installations:quick_schedule_installation' item.order.id %}"
                                                    title="جدولة تركيب">
                                                <i class="fas fa-calendar-plus"></i>
                                            </button>
                                            <a href="{% url 'orders:order_detail' item.order.id %}" class="btn btn-info" title="تفاصيل الطلب">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Unified Pagination -->
                {% load pagination_tags %}
                {% render_pagination page_obj %}
            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-inbox fa-4x text-gray-300 mb-3"></i>
                    <h5 class="text-gray-500">لا توجد تركيبات</h5>
                    <p class="text-gray-400">لم يتم العثور على تركيبات تطابق معايير البحث</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- SweetAlert2 JS -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<!-- نظام التحقق من المديونية - خاص بقسم التركيبات فقط -->
<script src="{% static 'js/debt_check.js' %}"></script>
<script>
// تحديث حالة التركيب مع SweetAlert2
document.querySelectorAll('.update-status').forEach(button => {
    button.addEventListener('click', function() {
        const installationId = this.dataset.installationId;
        const newStatus = this.dataset.status;
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        Swal.fire({
            title: 'تأكيد العملية',
            text: 'هل أنت متأكد من تحديث حالة التركيب؟',
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'نعم، تحديث',
            cancelButtonText: 'إلغاء',
            confirmButtonColor: '#28a745',
            cancelButtonColor: '#6c757d',
            reverseButtons: true
        }).then((result) => {
            if (result.isConfirmed) {
                fetch(`/installations/installation/${installationId}/update-status/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `status=${newStatus}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        Swal.fire({
                            title: 'تم التحديث!',
                            text: 'تم تحديث حالة التركيب بنجاح',
                            icon: 'success',
                            timer: 1500,
                            showConfirmButton: false
                        }).then(() => {
                            location.reload();
                        });
                    } else {
                        Swal.fire('خطأ', 'حدث خطأ أثناء تحديث الحالة', 'error');
                    }
                });
            }
        });
    });
});

// تأكيد جدولة التركيب - تم نقل هذا النظام إلى debt_check.js
// الآن يتم التحقق من المديونية قبل الجدولة

// إضافة نظام التحقق من المديونية للأزرار الجديدة
document.addEventListener('DOMContentLoaded', function() {
    // إضافة التحقق من المديونية لأزرار الجدولة
    if (typeof checkDebtBeforeScheduling === 'function') {
        // البحث عن جميع أزرار الجدولة وإضافة التحقق لها
        document.querySelectorAll('[data-schedule-url]').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                
                const orderId = this.getAttribute('data-order-id');
                const scheduleUrl = this.getAttribute('data-schedule-url');
                
                if (orderId && scheduleUrl) {
                    checkDebtBeforeScheduling(orderId, scheduleUrl);
                } else {
                    console.error('مفقود: order-id أو schedule-url');
                }
            });
        });
    } else {
        console.warn('checkDebtBeforeScheduling function not found. Make sure debt_check.js is loaded.');
    }
});

// إزالة البحث التلقائي بالكامل
// تم إيقاف البحث التلقائي عند إدخال أي بيانات في الفلاتر
// الآن يتم البحث والفلترة فقط عند الضغط على زر "تطبيق"

// منع التطبيق التلقائي للفلاتر عند إدخال البيانات
document.querySelectorAll('#filterForm select, #filterForm input[type="date"], #filterForm input[name="date_from"], #filterForm input[name="date_to"]').forEach(element => {
    console.log('تم إعداد منع التطبيق التلقائي للفلاتر لـ:', element.name);
});

// تطبيق الفلاتر عند الضغط على زر "تطبيق"
document.addEventListener('DOMContentLoaded', function() {
    const applyFiltersBtn = document.querySelector('.apply-filters-btn');
    if (applyFiltersBtn) {
        applyFiltersBtn.addEventListener('click', applyFilters);
    }

    // تطبيق الفلاتر عند الضغط على زر البحث في input group
    const searchButton = document.querySelector('.input-group .btn');
    if (searchButton && searchButton.type === 'submit') {
        searchButton.addEventListener('click', function(e) {
            e.preventDefault();
            applyFilters();
        });
    }
});

function applyFilters() {
    const form = document.getElementById('filterForm');
    if (!form) return;

    // إضافة قيمة الصفحة الحالية
    const pageInput = form.querySelector('input[name="page"]');
    if (!pageInput) {
        const hiddenPageInput = document.createElement('input');
        hiddenPageInput.type = 'hidden';
        hiddenPageInput.name = 'page';
        hiddenPageInput.value = '1';
        form.appendChild(hiddenPageInput);
    } else {
        pageInput.value = '1';
    }

    // إظهار مؤشر التحميل
    showLoading();

    // حفظ حالة الفلاتر
    saveFilterState();

    // إرسال النموذج
    form.submit();
}

// دالة لمنع التطبيق التلقائي للفلاتر
function preventAutoFilter() {
    // إيقاف التطبيق التلقائي للفلاتر الأخرى
    document.querySelectorAll('#filterForm select, #filterForm input[type="date"]').forEach(element => {
        // إزالة أي مستمعي أحداث حاليين
        element.removeEventListener('change', element._autoFilterHandler);

        // منع التطبيق التلقائي
        element._autoFilterHandler = function(e) {
            console.log('تم تغيير فلتر:', this.name, '- لن يتم تطبيق الفلاتر تلقائيًا');
        };
        element.addEventListener('change', element._autoFilterHandler);
    });
}

// استدعاء الدالة عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', preventAutoFilter);

// دالة للحفاظ على الفلاتر عند التصفح بين الصفحات
function preserveFiltersOnPagination() {
    // الحصول على الفلاتر النشطة من النموذج
    const filters = getActiveFilters();
    const paginationLinks = document.querySelectorAll('.pagination a');
    paginationLinks.forEach(link => {
        const href = link.getAttribute('href');
        if (!href) return;
        // استخراج رقم الصفحة من href الأصلي
        let pageMatch = href.match(/[?&]page=(\d+)/);
        let pageValue = pageMatch ? pageMatch[1] : null;
        // إزالة جميع المعاملات من href
        let baseUrl = href.split('?')[0];
        let params = new URLSearchParams();
        if (pageValue) {
            params.set('page', pageValue);
        }
        // إضافة الفلاتر النشطة
        for (const [key, value] of Object.entries(filters)) {
            if (value && key !== 'page') {
                params.set(key, value);
            }
        }
        link.setAttribute('href', `${baseUrl}?${params.toString()}`);
    });
}

// دالة للحصول على الفلاتر النشطة
function getActiveFilters() {
    const filters = {};
    const form = document.getElementById('filterForm');
    if (!form) return filters;

    const formData = new FormData(form);
    for (const [key, value] of formData.entries()) {
        if (value && key !== 'page' && key !== 'page_size') {
            filters[key] = value;
        }
    }

    return filters;
}

// استدعاء الدالة عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', preserveFiltersOnPagination);

// حفظ حالة الفلاتر في localStorage
function saveFilterState() {
    const formData = new FormData(document.getElementById('filterForm'));
    const filters = Object.fromEntries(formData);

    // تحويل القيم إلى strings لمنع مشاكل النوع
    const filtersForStorage = {};
    for (const [key, value] of Object.entries(filters)) {
        if (Array.isArray(value)) {
            filtersForStorage[key] = value[0] || '';
        } else {
            filtersForStorage[key] = String(value);
        }
    }

    localStorage.setItem('installation_filters', JSON.stringify(filtersForStorage));
}

function loadFilterState() {
    const saved = localStorage.getItem('installation_filters');
    if (saved) {
        try {
            const filters = JSON.parse(saved);
            const form = document.getElementById('filterForm');

            // التحقق من صلاحية البيانات المحفوظة
            if (filters && typeof filters === 'object') {
                Object.entries(filters).forEach(([key, value]) => {
                    const input = form.querySelector(`[name="${key}"]`);
                    if (input) {
                        if (input.type === 'checkbox' || input.type === 'radio') {
                            input.checked = String(value) === 'true';
                        } else {
                            input.value = String(value);
                        }
                    }
                });
            }
        } catch (error) {
            console.error('خطأ في تحميل الفلاتر المحفوظة:', error);
            localStorage.removeItem('installation_filters');
        }
    }
}

// تحميل الفلاتر المحفوظة عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', loadFilterState);

// حفظ الفلاتر عند التغيير
document.getElementById('filterForm').addEventListener('submit', saveFilterState);

// إضافة تأثيرات بصرية للجدول
document.querySelectorAll('tbody tr').forEach(row => {
    row.addEventListener('mouseenter', function() {
        this.style.backgroundColor = '#f8f9fa';
        this.style.transform = 'scale(1.01)';
        this.style.transition = 'all 0.2s ease';
    });
    
    row.addEventListener('mouseleave', function() {
        this.style.backgroundColor = '';
        this.style.transform = '';
    });
});

// تحديث الإحصائيات في الوقت الفعلي
function updateStats() {
    fetch('{% url "installations:installation_list" %}' + window.location.search)
        .then(response => response.text())
        .then(html => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const newStats = doc.querySelector('.filter-stats');
            if (newStats) {
                document.querySelector('.filter-stats').innerHTML = newStats.innerHTML;
            }
        })
        .catch(console.error);
}

// تحديث الإحصائيات كل 30 ثانية
setInterval(updateStats, 30000);

// إضافة مؤشرات تحميل
function showLoading() {
    const overlay = document.createElement('div');
    overlay.id = 'loading-overlay';
    overlay.innerHTML = `
        <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin fa-3x text-primary"></i>
            <p class="mt-2">جاري التحميل...</p>
        </div>
    `;
    overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255,255,255,0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    `;
    document.body.appendChild(overlay);
}

function hideLoading() {
    const overlay = document.getElementById('loading-overlay');
    if (overlay) {
        overlay.remove();
    }
}

// إظهار مؤشر التحميل عند إرسال النماذج
document.getElementById('filterForm').addEventListener('submit', showLoading);

// إخفاء مؤشر التحميل عند اكتمال التحميل
window.addEventListener('load', hideLoading);

// وظيفة إظهار تحذير المديونية
function showDebtWarning(customerName, remainingAmount, orderId) {
    Swal.fire({
        title: '<i class="fas fa-exclamation-triangle text-warning"></i> تحذير مديونية',
        html: `
            <div class="text-right" dir="rtl">
                <p><strong>العميل:</strong> ${customerName}</p>
                <p><strong>المبلغ المتبقي:</strong> <span class="text-danger">${remainingAmount} ج.م</span></p>
                <hr>
                <p class="text-warning">
                    <i class="fas fa-info-circle"></i>
                    يوجد مديونية متبقية على هذا العميل. يرجى إقفال المديونية قبل التركيب.
                </p>
                <p class="text-muted">اختر أحد الخيارات التالية:</p>
            </div>
        `,
        showCancelButton: true,
        showDenyButton: true,
        confirmButtonText: '<i class="fas fa-money-bill-wave"></i> دفع المديونية',
        denyButtonText: '<i class="fas fa-clock"></i> استلام بعد التركيب',
        cancelButtonText: '<i class="fas fa-times"></i> إلغاء',
        confirmButtonColor: '#28a745',
        denyButtonColor: '#ffc107',
        cancelButtonColor: '#6c757d',
        width: '500px',
        padding: '2rem',
        backdrop: true,
        allowOutsideClick: false,
        customClass: {
            title: 'text-right',
            content: 'text-right'
        }
    }).then((result) => {
        if (result.isConfirmed) {
            // إعادة توجيه لصفحة دفع المديونية
            window.open(`/orders/order/${orderId}/`, '_blank');
        } else if (result.isDenied) {
            // تسجيل ملاحظة استلام بعد التركيب
            Swal.fire({
                title: 'تم التأكيد',
                text: 'سيتم استلام المبلغ المتبقي بعد التركيب',
                icon: 'info',
                timer: 2000,
                showConfirmButton: false
            });
        }
    });
}
</script>
{% endblock %}