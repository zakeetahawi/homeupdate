{% extends 'base.html' %}
{% load static %}
{% load i18n %}
{% block title %}{{ title }}{% endblock %}
{% block content %}
    <div class="container-fluid py-4">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-4">
            <h1 class="h3 mb-3 mb-md-0 text-gray-800">
                <i class="fas fa-traffic-light text-primary me-2"></i>{{ title }}
            </h1>
            <div class="d-flex align-items-center">
                <!-- Date Picker -->
                <form method="get" class="d-flex align-items-center me-3">
                    <input type="date"
                           name="date"
                           class="form-control"
                           value="{{ selected_date|date:'Y-m-d' }}"
                           onchange="this.form.submit()">
                </form>
                <button type="button"
                        class="btn btn-primary"
                        data-bs-toggle="modal"
                        data-bs-target="#createMissionModal">
                    <i class="fas fa-plus-circle me-1"></i> مهمة خاصة
                </button>
            </div>
        </div>
        <!-- Stats Cards -->
        <div class="row mb-4">
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-left-primary shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">المهام اليومية</div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800">
                                    {{ daily_installations_count|add:daily_custom_missions_count }}
                                </div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-tasks fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-left-success shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-success text-uppercase mb-1">المركبات الشاغرة</div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800">{{ vacant_vehicles.count }}</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-car-side fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-left-warning shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">طلبات معلقة</div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800">{{ pending_requests.count }}</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-bell fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-left-info shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-info text-uppercase mb-1">السائقين الشاغرين</div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800">{{ vacant_drivers_count }}</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-id-card fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Pending Requests Section -->
        {% if pending_requests %}
            <div class="card shadow mb-4 border-bottom-warning">
                <div class="card-header py-3 bg-warning bg-opacity-10 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-warning">
                        <i class="fas fa-bell me-2"></i> طلبات المركبات المعلقة
                    </h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered mb-0">
                            <thead class="bg-light">
                                <tr>
                                    <th>مقدم الطلب</th>
                                    <th>التاريخ/الوقت</th>
                                    <th>الغرض</th>
                                    <th>الإجراء</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for req in pending_requests %}
                                    <tr>
                                        <td>{{ req.requester.get_full_name|default:req.requester.username }}</td>
                                        <td>
                                            {{ req.requested_date }} <span class="text-muted">{{ req.requested_time|default:"" }}</span>
                                        </td>
                                        <td>{{ req.purpose }}</td>
                                        <td>
                                            <!-- Action Buttons Logic... (Simplified for brevity, same as before) -->
                                            <button class="btn btn-sm btn-success"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#approveRequestModal{{ req.id }}">
                                                <i class="fas fa-check"></i> قبول
                                            </button>
                                            <!-- ... modal code ... -->
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        {% endif %}
        <div class="row">
            <!-- Daily Schedule (Installations + Custom Missions) -->
            <div class="col-lg-8 mb-4">
                <div class="card shadow mb-4">
                    <div class="card-header py-3 d-flex justify-content-between align-items-center">
                        <h6 class="m-0 font-weight-bold text-primary">جدول الحركة اليومي ({{ selected_date }})</h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover" width="100%" cellspacing="0">
                                <thead>
                                    <tr>
                                        <th>نوع المهمة</th>
                                        <th>التفاصيل/العميل</th>
                                        <th>السائق المعين</th>
                                        <th>المركبة</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Installations -->
                                    {% for installation in daily_installations %}
                                        <tr>
                                            <td>
                                                <span class="badge bg-primary">تركيب</span>
                                                <div class="small text-muted mt-1">{{ installation.scheduled_time|time:"H:i" }}</div>
                                            </td>
                                            <td>
                                                <strong><a href="{% url 'installations:installation_detail' installation.id %}">#{{ installation.order.order_number }}</a></strong>
                                                <br>
                                                {{ installation.order.customer.name }}
                                                <br>
                                                <small class="text-muted">
                                                    <i class="fas fa-map-marker-alt text-danger me-1"></i>
                                                    {{ installation.location_type_display|default:installation.order.customer.address }}
                                                </small>
                                            </td>
                                            <td class="bg-light">
                                                {% if installation.driver %}
                                                    <span class="text-success fw-bold">{{ installation.driver.name }}</span>
                                                {% else %}
                                                    <span class="text-danger small">-- غير معين --</span>
                                                {% endif %}
                                            </td>
                                            <td class="bg-light">
                                                {% if installation.driver and installation.driver.vehicle %}
                                                    {{ installation.driver.vehicle.name }}
                                                {% elif installation.driver %}
                                                    <span class="text-warning small">بدون مركبة</span>
                                                {% else %}
                                                    <span class="text-muted small">-</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-primary"
                                                        onclick="openAssignModal( '{{ installation.id }}', '{{ installation.order.order_number }}', '{{ installation.order.customer.name|escapejs }}', '{{ installation.location_type_display|default:installation.order.customer.address|escapejs }}', '{{ installation.driver_id|default:'' }}' )">
                                                    <i class="fas fa-user-tag"></i> تعيين
                                                </button>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                    <!-- Custom Missions -->
                                    {% for mission in daily_missions %}
                                        {% if mission.mission_type != 'installation' %}
                                            <tr>
                                                <td>
                                                    <span class="badge bg-secondary">{{ mission.get_mission_type_display }}</span>
                                                    {% if mission.start_time %}<div class="small text-muted mt-1">{{ mission.start_time|time:"H:i" }}</div>{% endif %}
                                                </td>
                                                <td>
                                                    {{ mission.description|truncatechars:50 }}
                                                    {% if mission.request %}
                                                        <div class="small text-info mt-1">
                                                            <i class="fas fa-user"></i> طلب: {{ mission.request.requester.get_full_name }}
                                                        </div>
                                                    {% endif %}
                                                </td>
                                                <td>{{ mission.driver.name }}</td>
                                                <td>
                                                    <a href="{% url 'installations:vehicle_detail' mission.vehicle.id %}"
                                                       class="text-decoration-none">{{ mission.vehicle.name }}</a>
                                                </td>
                                                <td>
                                                    <span class="badge bg-success">نشط</span>
                                                </td>
                                            </tr>
                                        {% endif %}
                                    {% endfor %}
                                    {% if not daily_installations and not daily_missions %}
                                        <tr>
                                            <td colspan="5" class="text-center text-muted py-4">لا توجد مهام أو تركيبات مجدولة لهذا اليوم</td>
                                        </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Vacant Vehicles & Drivers Row -->
            <div class="col-lg-4 mb-4">
                <!-- Vacant Vehicles -->
                <div class="card shadow mb-4">
                    <div class="card-header py-3 d-flex justify-content-between align-items-center">
                        <h6 class="m-0 font-weight-bold text-success">المركبات الشاغرة (اليوم)</h6>
                    </div>
                    <div class="card-body">
                        <div class="list-group list-group-flush">
                            {% for vehicle in vacant_vehicles %}
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="fas fa-check-circle text-success me-2"></i>
                                        <a href="{% url 'installations:vehicle_detail' vehicle.id %}"
                                           class="text-decoration-none">
                                            <strong>{{ vehicle.name }}</strong>
                                        </a>
                                        <div class="small text-muted">{{ vehicle.model }} - {{ vehicle.plate_number }}</div>
                                    </div>
                                    <button class="btn btn-sm btn-outline-success rounded-pill"
                                            onclick="assignToMission('{{ vehicle.id }}', '{{ vehicle.name }}')"
                                            data-bs-toggle="modal"
                                            data-bs-target="#createMissionModal">
                                        <i class="fas fa-plus"></i> مهمة
                                    </button>
                                </div>
                            {% empty %}
                                <div class="text-center text-muted py-3">جميع المركبات مشغولة اليوم</div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                <!-- Vacant Drivers -->
                <div class="card shadow mb-4">
                    <div class="card-header py-3 d-flex justify-content-between align-items-center">
                        <h6 class="m-0 font-weight-bold text-info">السائقين الشاغرين (اليوم)</h6>
                    </div>
                    <div class="card-body">
                        <div class="list-group list-group-flush">
                            {% for driver in vacant_drivers %}
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="fas fa-user-check text-info me-2"></i>
                                        <strong>{{ driver.name }}</strong>
                                        {% if driver.phone %}<div class="small text-muted">{{ driver.phone }}</div>{% endif %}
                                    </div>
                                    <div class="text-end">
                                        {% if driver.vehicle %}
                                            <span class="badge bg-light text-dark border small">{{ driver.vehicle.name }}</span>
                                        {% else %}
                                            <span class="badge bg-light text-muted border small">لا توجد مركبة</span>
                                        {% endif %}
                                    </div>
                                </div>
                            {% empty %}
                                <div class="text-center text-muted py-3">جميع السائقين مشغولون اليوم</div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                <!-- Quick Links -->
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-secondary">إدارة البيانات</h6>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <a href="{% url 'installations:driver_list' %}"
                               class="btn btn-outline-primary">
                                <i class="fas fa-user-plus"></i> إدارة السائقين ({{ drivers_count }})
                            </a>
                            <a href="{% url 'installations:vehicle_list' %}"
                               class="btn btn-outline-success">
                                <i class="fas fa-truck"></i> إدارة المركبات ({{ vehicles_count }})
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
{% block modals %}
    <!-- Custom Unified Assign Driver Modal -->
    <div class="modal fade"
         id="unifiedAssignDriverModal"
         tabindex="-1"
         aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <form id="assignDriverForm" method="post" action="">
                    {% csrf_token %}
                    <div class="modal-header">
                        <h5 class="modal-title" id="assignModalTitle">تعيين سائق</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-secondary mb-3">
                            <div class="fw-bold">
                                <i class="fas fa-user"></i> العميل: <span id="modalCustomerName" class="fw-normal"></span>
                            </div>
                            <div class="fw-bold mt-1">
                                <i class="fas fa-map-marker-alt text-danger"></i> المنطقة: <span id="modalCustomerRegion" class="text-primary fw-normal"></span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">اختر السائق</label>
                            <select name="driver_id" id="modalDriverSelect" class="form-select">
                                <option value="">-- إلغاء التعيين --</option>
                                {% for driver in drivers %}
                                    <option value="{{ driver.id }}">
                                        {{ driver.name }}
                                        {% if driver.active_tasks > 0 %}
                                            (مشغول الآن - {{ driver.active_tasks }} مهام نشطة)
                                        {% elif driver.total_tasks > 0 %}
                                            (متاح - أتم {{ driver.total_tasks }} مهام اليوم)
                                        {% else %}
                                            (شاغر تماماً)
                                        {% endif %}
                                        {% if driver.vehicle %}- {{ driver.vehicle.name }}{% endif %}
                                    </option>
                                {% endfor %}
                            </select>
                            <div class="form-text text-muted">يمكنك اختيار سائق لديه مهام أخرى بالفعل.</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                        <button type="submit" class="btn btn-primary">حفظ التغييرات</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- Create Custom Mission Modal -->
    <div class="modal fade"
         id="createMissionModal"
         tabindex="-1"
         aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <form action="{% url 'installations:create_custom_mission' %}"
                      method="post">
                    {% csrf_token %}
                    <div class="modal-header">
                        <h5 class="modal-title">إنشاء مهمة خاصة جديدة</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">التاريخ</label>
                            <input type="date"
                                   name="date"
                                   class="form-control"
                                   value="{{ selected_date|date:'Y-m-d' }}"
                                   required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">المركبة</label>
                            <select name="vehicle_id"
                                    id="missionVehicleSelect"
                                    class="form-select"
                                    required>
                                <option value="">اختر مركبة...</option>
                                {% for vehicle in all_vehicles %}<option value="{{ vehicle.id }}">{{ vehicle.name }}</option>{% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">السائق</label>
                            <select name="driver_id" class="form-select" required>
                                <option value="">اختر سائق...</option>
                                {% for driver in drivers %}<option value="{{ driver.id }}">{{ driver.name }}</option>{% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">تفاصيل المهمة</label>
                            <textarea name="description"
                                      class="form-control"
                                      rows="3"
                                      placeholder="اكتب تفاصيل المهمة..."
                                      required></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                        <button type="submit" class="btn btn-primary">إنشاء المهمة</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
{% endblock %}
{% block extra_js %}
    <script>
    function assignToMission(vehicleId, vehicleName) {
        // Pre-select vehicle in modal
        const select = document.getElementById('missionVehicleSelect');
        select.value = vehicleId;
    }

    var assignModal;

    function openAssignModal(installationId, orderNumber, customerName, region, currentDriverId) {
        // Initialize modal if not already done (Bootstrap 5)
        if (!assignModal) {
            assignModal = new bootstrap.Modal(document.getElementById('unifiedAssignDriverModal'));
        }

        // Set Form Action
        const form = document.getElementById('assignDriverForm');
        // Construct the URL. Note: This requires the base URL structure to be known or passed via data attribute.
        // A safer way is to use a placeholder in Django template or construct it here carefully.
        // Assuming '/installations/traffic/assign-driver/' is the path.
        form.action = `/installations/traffic/assign-driver/${installationId}/`;

        // Set Title & Info
        document.getElementById('assignModalTitle').textContent = `تعيين سائق للتركيب #${orderNumber}`;
        document.getElementById('modalCustomerName').textContent = customerName;
        document.getElementById('modalCustomerRegion').textContent = region || 'غير محدد';

        // Set Current Driver
        const select = document.getElementById('modalDriverSelect');
        select.value = currentDriverId;

        // Show Modal
        assignModal.show();
    }
    </script>
{% endblock %}
