#!/bin/bash
# ═══════════════════════════════════════════════════════════════════════════════
# سكربت النشر الشامل - نظام الخواجه
# Comprehensive Deployment Script - El-Khawaga System
# ═══════════════════════════════════════════════════════════════════════════════
# التاريخ: 2026-02-11
# الإصدار: يشمل المحاسبة + لوحة التحكم + الثيم + إصلاحات
# ⚠️  ينشئ القيود المحاسبية من بداية 2026 فقط (2026-01-01)
# ═══════════════════════════════════════════════════════════════════════════════

set -e  # توقف عند أي خطأ

# ألوان للطباعة
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# ═══ تاريخ البداية للقيود المحاسبية ═══
START_DATE="2026-01-01"

# مسار المشروع
PROJECT_DIR="$(cd "$(dirname "$0")" && pwd)"
cd "$PROJECT_DIR"

echo -e "${CYAN}═══════════════════════════════════════════════════════════════${NC}"
echo -e "${CYAN}    سكربت نشر تحديثات نظام الخواجه${NC}"
echo -e "${CYAN}    El-Khawaga System Deployment Script${NC}"
echo -e "${CYAN}    📅 القيود المحاسبية: من ${START_DATE} فقط${NC}"
echo -e "${CYAN}═══════════════════════════════════════════════════════════════${NC}"
echo ""

# ═══════════════════════════════════════════════════════════════════
# المرحلة 1: سحب التحديثات من GitHub
# ═══════════════════════════════════════════════════════════════════
echo -e "${BLUE}[1/8] 📥 سحب التحديثات من GitHub...${NC}"
git pull origin main
echo -e "${GREEN}  ✅ تم سحب التحديثات بنجاح${NC}"
echo ""

# ═══════════════════════════════════════════════════════════════════
# المرحلة 2: تثبيت المتطلبات الجديدة (إن وُجدت)
# ═══════════════════════════════════════════════════════════════════
echo -e "${BLUE}[2/8] 📦 تثبيت المتطلبات...${NC}"
if [ -f "venv/bin/pip" ]; then
    venv/bin/pip install -r requirements.txt --quiet 2>/dev/null || true
elif [ -f ".venv/bin/pip" ]; then
    .venv/bin/pip install -r requirements.txt --quiet 2>/dev/null || true
else
    pip install -r requirements.txt --quiet 2>/dev/null || true
fi
echo -e "${GREEN}  ✅ تم تثبيت المتطلبات${NC}"
echo ""

# ═══════════════════════════════════════════════════════════════════
# المرحلة 3: تشغيل Migrations قواعد البيانات
# ═══════════════════════════════════════════════════════════════════
echo -e "${BLUE}[3/8] 🗄️  تشغيل Migrations قواعد البيانات...${NC}"
echo -e "${YELLOW}  ⚡ Migrations جديدة:${NC}"
echo -e "    📌 accounting: 0008 → 0013 (حسابات عملاء + فهارس + مرفقات + تحسينات)"
echo -e "    📌 customers: 0020 (حد ائتمان + شروط دفع)"
echo -e "    📌 orders: 0095-0096 (تخصيص مدفوعات + إزالة رصيد مستخدم)"
echo ""

python manage.py migrate --noinput
echo -e "${GREEN}  ✅ تم تشغيل جميع الـ Migrations بنجاح${NC}"
echo ""

# ═══════════════════════════════════════════════════════════════════
# المرحلة 4: إعداد البنية المحاسبية
# ═══════════════════════════════════════════════════════════════════
echo -e "${BLUE}[4/8] 🏗️  إعداد البنية المحاسبية الأساسية...${NC}"
echo -e "${YELLOW}  هذه الخطوة تنشئ:${NC}"
echo -e "    📌 أنواع الحسابات (Assets, Liabilities, Equity, Revenue, Expenses)"
echo -e "    📌 شجرة الحسابات الأساسية (Chart of Accounts)"
echo -e "    📌 الحسابات الافتراضية (نقدية، بنك، إيرادات، مصروفات)"
echo ""

python manage.py setup_accounting_structure
echo -e "${GREEN}  ✅ تم إنشاء البنية المحاسبية${NC}"
echo ""

# ═══════════════════════════════════════════════════════════════════
# المرحلة 5: إعداد الإعدادات المحاسبية الافتراضية
# ═══════════════════════════════════════════════════════════════════
echo -e "${BLUE}[5/8] ⚙️  إعداد الإعدادات المحاسبية الافتراضية...${NC}"
echo -e "${YELLOW}  هذه الخطوة تحدد:${NC}"
echo -e "    📌 الحسابات الافتراضية للإيرادات والمصروفات"
echo -e "    📌 إعدادات القيد المزدوج التلقائي"
echo ""

python manage.py setup_accounting_defaults
echo -e "${GREEN}  ✅ تم إعداد الإعدادات الافتراضية${NC}"
echo ""

# ═══════════════════════════════════════════════════════════════════
# المرحلة 6: إنشاء حسابات العملاء
# ═══════════════════════════════════════════════════════════════════
echo -e "${BLUE}[6/8] 👥 إنشاء حسابات محاسبية للعملاء...${NC}"
echo -e "${YELLOW}  هذه الخطوة:${NC}"
echo -e "    📌 تنشئ حساب محاسبي لكل عميل ليس لديه حساب"
echo -e "    📌 تربط كل حساب عميل تحت حساب 'ذمم العملاء' (Accounts Receivable)"
echo -e "    📌 تعلّم الحسابات بـ is_customer_account = True"
echo ""

python manage.py create_customer_accounts
echo -e "${GREEN}  ✅ تم إنشاء حسابات العملاء${NC}"
echo ""

# ═══════════════════════════════════════════════════════════════════
# المرحلة 7: إنشاء القيود المحاسبية من بداية 2026
# ═══════════════════════════════════════════════════════════════════
echo -e "${BLUE}[7/8] 📝 إنشاء القيود المحاسبية للطلبات (من ${START_DATE})...${NC}"
echo -e "${YELLOW}  ⚠️  هذه الخطوة مهمة جداً - تنشئ:${NC}"
echo -e "    📌 قيد بيع لكل طلب من ${START_DATE} (مدين: ذمم العملاء / دائن: الإيرادات)"
echo -e "    📌 قيد دفع لكل دفعة من ${START_DATE} (مدين: النقدية أو البنك / دائن: ذمم العملاء)"
echo -e "    📌 ربط كل قيد بالطلب والعميل المناسب"
echo -e "    📌 تسوية الأرصدة بشكل صحيح"
echo -e "${RED}  ⏳ قد تستغرق وقتاً حسب عدد الطلبات الموجودة...${NC}"
echo ""

python manage.py create_historical_transactions --from-date ${START_DATE}
echo -e "${GREEN}  ✅ تم إنشاء القيود من ${START_DATE}${NC}"
echo ""

# ═══════════════════════════════════════════════════════════════════
# المرحلة 7.5: ربط قيود الدفعات + تحديث الأرصدة
# ═══════════════════════════════════════════════════════════════════
echo -e "${BLUE}[7.5] 🔗 ربط قيود الدفعات وتحديث الأرصدة...${NC}"

echo -e "${YELLOW}  ربط قيود الدفعات:${NC}"
python manage.py link_payment_transactions
echo -e "${GREEN}  ✅ تم ربط قيود الدفعات${NC}"

echo -e "${YELLOW}  تحديث أرصدة الحسابات:${NC}"
python manage.py update_account_balances
echo -e "${GREEN}  ✅ تم تحديث جميع الأرصدة${NC}"

echo -e "${YELLOW}  تحديث الملخصات المالية:${NC}"
python manage.py refresh_financial_summaries
echo -e "${GREEN}  ✅ تم تحديث الملخصات المالية${NC}"
echo ""

# ═══════════════════════════════════════════════════════════════════
# المرحلة 8: جمع الملفات الثابتة + التحقق
# ═══════════════════════════════════════════════════════════════════
echo -e "${BLUE}[8/8] 📂 جمع الملفات الثابتة والتحقق النهائي...${NC}"

python manage.py collectstatic --noinput --clear 2>/dev/null || python manage.py collectstatic --noinput 2>/dev/null || true
echo -e "${GREEN}  ✅ تم جمع الملفات الثابتة${NC}"

echo ""
echo -e "${YELLOW}  🔍 تشغيل التدقيق المحاسبي...${NC}"
python manage.py audit_accounting 2>/dev/null || true
echo ""

# ═══════════════════════════════════════════════════════════════════
# النتيجة النهائية
# ═══════════════════════════════════════════════════════════════════
echo -e "${CYAN}═══════════════════════════════════════════════════════════════${NC}"
echo -e "${GREEN}  ✅✅✅ تم النشر بنجاح! ✅✅✅${NC}"
echo -e "${CYAN}═══════════════════════════════════════════════════════════════${NC}"
echo ""
echo -e "${YELLOW}📋 ملخص ما تم:${NC}"
echo -e "  1. ✅ سحب آخر التحديثات من GitHub"
echo -e "  2. ✅ تثبيت المتطلبات الجديدة"
echo -e "  3. ✅ تشغيل Migrations قواعد البيانات"
echo -e "  4. ✅ إنشاء البنية المحاسبية (شجرة الحسابات)"
echo -e "  5. ✅ إعداد الإعدادات المحاسبية"
echo -e "  6. ✅ إنشاء حسابات العملاء المحاسبية"
echo -e "  7. ✅ إنشاء القيود المحاسبية (من ${START_DATE} فقط)"
echo -e "  7.5 ✅ ربط الدفعات + تحديث الأرصدة"
echo -e "  8. ✅ جمع الملفات الثابتة + التدقيق"
echo ""
echo -e "${YELLOW}🔄 لإعادة تشغيل الخوادم:${NC}"
echo -e "  sudo systemctl restart daphne gunicorn nginx"
echo -e "  أو: ./لينكس/start-all.sh"
echo ""
echo -e "${YELLOW}📊 أوامر اختيارية للتحقق:${NC}"
echo -e "  python manage.py trial_balance              # ميزان المراجعة"
echo -e "  python manage.py verify_customer_balances    # تحقق أرصدة العملاء"
echo -e "  python manage.py final_accounting_report     # تقرير محاسبي شامل"
echo -e "  python manage.py check_orders_2026           # فحص قيود 2026"
echo ""
echo -e "${CYAN}═══════════════════════════════════════════════════════════════${NC}"
