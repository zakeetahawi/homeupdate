<!-- Ø§Ù„Ø²Ø± Ø§Ù„Ø¹Ø§Ø¦Ù… Ù„Ù„Ø¯Ø±Ø¯Ø´Ø© - Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø³Ø­Ø¨ -->
<div id="chatFloatingButton" class="chat-floating-btn draggable-btn">
    <div class="chat-btn-main" onclick="toggleChatWidget()">
        <i class="fas fa-comments"></i>
        <span class="chat-notification-badge" id="chatNotificationBadge" style="display: none;">0</span>
    </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ù…ØµØºØ±Ø© -->
<div id="chatWidget" class="chat-widget" style="display: none;">
    <div class="chat-widget-header">
        <div class="d-flex justify-content-between align-items-center">
            <h6 class="mb-0">
                <i class="fas fa-comments me-2"></i>
                Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
            </h6>
            <div class="chat-widget-controls">
                <button class="btn btn-sm" onclick="minimizeChatWidget()" title="ØªØµØºÙŠØ±">
                    <i class="fas fa-minus"></i>
                </button>
                <button class="btn btn-sm" onclick="closeChatWidget()" title="Ø¥ØºÙ„Ø§Ù‚">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </div>
    
    <div class="chat-widget-body">
        <div class="chat-widget-tabs">
            <div class="nav nav-tabs" role="tablist">
                <button class="nav-link active" onclick="switchChatTab('activeUsers', this)" type="button">
                    Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†
                </button>
            </div>
        </div>
        
        <div class="tab-content">
            <!-- Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø§Ù„Ù†Ø´Ø·ÙˆÙ† -->
            <div class="tab-pane fade show active" id="activeUsers">
                <div class="active-users-list" id="activeUsersWidget">
                    <div class="text-center p-3">
                        <div class="spinner-border spinner-border-sm" role="status"></div>
                        <p class="mt-2 mb-0">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="chat-widget-footer">
        <small class="text-muted text-center d-block">
            <i class="fas fa-comments me-1"></i>
            Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ù…ØµØºØ±
        </small>
    </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø¯Ø±Ø¯Ø´Ø© ØµØºÙŠØ±Ø© Ù…Ø«Ù„ Ù…Ø³Ù†Ø¬Ø± -->
<div id="miniChatWindow" class="mini-chat-window" style="display: none;">
    <div class="mini-chat-header">
        <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <div class="mini-chat-avatar">
                    <span id="miniChatUserInitial">U</span>
                </div>
                <div class="ms-2">
                    <h6 class="mb-0" id="miniChatUserName">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</h6>
                    <small class="text-success" id="miniChatUserStatus">Ù…ØªØµÙ„</small>
                </div>
            </div>
            <div class="mini-chat-controls">
                <button id="muteChatButton" class="btn btn-sm btn-outline-light" onclick="toggleChatMute()" title="ÙƒØªÙ…/Ø¥Ù„ØºØ§Ø¡ ÙƒØªÙ… Ø§Ù„ØµÙˆØª">
                    <i class="fas fa-volume-up"></i>
                </button>
                <button class="btn btn-sm" onclick="minimizeMiniChat()" title="ØªØµØºÙŠØ±">
                    <i class="fas fa-minus"></i>
                </button>
                <button class="btn btn-sm" onclick="closeMiniChat()" title="Ø¥ØºÙ„Ø§Ù‚">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </div>

    <div class="mini-chat-messages" id="miniChatMessages">
        <!-- Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ -->
    </div>

    <!-- Ù…Ø¤Ø´Ø± Ø§Ù„ÙƒØªØ§Ø¨Ø© -->
    <div class="typing-indicator" id="typingIndicator" style="display: none;">
        <span class="typing-user"></span> ÙŠÙƒØªØ¨
        <div class="typing-dots">
            <span></span>
            <span></span>
            <span></span>
        </div>
    </div>

    <div class="mini-chat-input">
        <div class="d-flex">
            <input type="text" class="form-control form-control-sm"
                   id="miniChatInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..."
                   onkeypress="handleMiniChatEnter(event)"
                   oninput="handleTyping()"
                   onblur="stopTyping()">
            <button class="btn btn-primary btn-sm ms-2" onclick="sendMiniChatMessage()">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
</div>

<!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†Ù‚Ø± Ø¨Ø§Ù„Ø²Ø± Ø§Ù„Ø£ÙŠÙ…Ù† -->
<div id="userContextMenu" class="context-menu" style="display: none;">
    <div class="context-menu-item" onclick="viewUserProfile()">
        <i class="fas fa-user me-2"></i>
        Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ
    </div>
    <div class="context-menu-item" onclick="startPrivateChat()">
        <i class="fas fa-comments me-2"></i>
        Ø¨Ø¯Ø¡ Ù…Ø­Ø§Ø¯Ø«Ø©
    </div>
    <div class="context-menu-item" onclick="deleteConversation()">
        <i class="fas fa-trash me-2"></i>
        Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
    </div>
    <div class="context-menu-item" onclick="blockUser()">
        <i class="fas fa-ban me-2"></i>
        Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    </div>
</div>

<style>
.chat-floating-btn {
    position: fixed;
    bottom: 30px;
    right: 30px;
    z-index: 1050;
    cursor: move;
    user-select: none;
    transition: none;
    will-change: transform;
}

.chat-floating-btn.dragging {
    transform: scale(1.05);
    box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
    z-index: 1060;
    transition: none;
}

.chat-floating-btn.snapping {
    transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
}

.chat-floating-btn:not(.dragging):not(.snapping) {
    transition: transform 0.2s ease;
}

.chat-btn-main {
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 24px;
    cursor: pointer;
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
    transition: all 0.3s ease;
    position: relative;
}

.chat-btn-main:hover {
    transform: translateY(-3px);
    box-shadow: 0 12px 35px rgba(102, 126, 234, 0.4);
}

.chat-notification-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background: #ef4444;
    color: white;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: bold;
    border: 2px solid white;
}

.chat-widget {
    position: fixed;
    bottom: 100px;
    right: 30px;
    width: 320px;
    height: 400px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    z-index: 1040;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    animation: slideInUp 0.3s ease;
    border: 1px solid #e0e0e0;
}

@keyframes slideInUp {
    from {
        transform: translateY(20px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideOutRight {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(100%);
        opacity: 0;
    }
}

@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideOutRight {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(100%);
        opacity: 0;
    }
}

.chat-widget-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 15px;
    border-radius: 15px 15px 0 0;
}

.chat-widget-controls button {
    background: none;
    border: none;
    color: white;
    padding: 5px;
    margin-left: 5px;
    border-radius: 5px;
    transition: background 0.2s ease;
}

.chat-widget-controls button:hover {
    background: rgba(255,255,255,0.2);
}

.chat-widget-body {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.chat-widget-tabs .nav-tabs {
    border-bottom: 1px solid #dee2e6;
    background: #f8f9fa;
}

.chat-widget-tabs .nav-link {
    border: none;
    color: #6c757d;
    font-size: 14px;
    padding: 10px 15px;
}

.chat-widget-tabs .nav-link.active {
    background: white;
    color: #667eea;
    border-bottom: 2px solid #667eea;
}

.tab-content {
    flex: 1;
    overflow: hidden;
}

.tab-pane {
    height: 100%;
    overflow-y: auto;
}

.chat-rooms-list, .active-users-list {
    max-height: 300px;
    overflow-y: auto;
}

.chat-room-item, .user-item-widget {
    padding: 12px 15px;
    border-bottom: 1px solid #f0f0f0;
    cursor: pointer;
    transition: background 0.2s ease;
}

.chat-room-item:hover, .user-item-widget:hover {
    background: #f8f9fa;
}

/* ØªØ­Ø³ÙŠÙ† Ù…Ø¸Ù‡Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø© */
.user-online {
    border-left: 3px solid #28a745;
    background: linear-gradient(90deg, rgba(40, 167, 69, 0.05) 0%, transparent 100%);
}

.user-offline {
    border-left: 3px solid #6c757d;
    background: linear-gradient(90deg, rgba(108, 117, 125, 0.03) 0%, transparent 100%);
}

.user-online:hover {
    background: linear-gradient(90deg, rgba(40, 167, 69, 0.1) 0%, #f8f9fa 100%);
}

.user-offline:hover {
    background: linear-gradient(90deg, rgba(108, 117, 125, 0.08) 0%, #f8f9fa 100%);
}

/* ØªØ­Ø³ÙŠÙ† Ù…Ø¸Ù‡Ø± Ø§Ù„Ø£ÙØ§ØªØ§Ø± */
.user-avatar-small {
    position: relative;
    overflow: visible;
}

/* ØªØ­Ø³ÙŠÙ† Ù…Ø¸Ù‡Ø± Ù…Ø¤Ø´Ø± Ø§Ù„Ø­Ø§Ù„Ø© */
.status-indicator-dot {
    position: absolute;
    bottom: -2px;
    right: -2px;
    width: 12px;
    height: 12px;
    border: 2px solid white;
    border-radius: 50%;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}

.chat-widget-footer {
    padding: 15px;
    border-top: 1px solid #dee2e6;
    background: #f8f9fa;
}

.user-avatar-small {
    width: 35px;
    height: 35px;
    border-radius: 50%;
    background: linear-gradient(45deg, #667eea, #764ba2);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 14px;
}

.status-indicator {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    display: inline-block;
    margin-left: 5px;
}

.status-online { background: #10b981; }
.status-away { background: #f59e0b; }
.status-busy { background: #ef4444; }
.status-offline { background: #6b7280; }

/* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†Ù‚Ø± Ø¨Ø§Ù„Ø²Ø± Ø§Ù„Ø£ÙŠÙ…Ù† */
.context-menu {
    position: fixed;
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    z-index: 2000;
    min-width: 180px;
    padding: 5px 0;
}

.context-menu-item {
    padding: 10px 15px;
    cursor: pointer;
    transition: background 0.2s ease;
    font-size: 14px;
    color: #333;
}

.context-menu-item:hover {
    background: #f8f9fa;
}

.context-menu-item i {
    width: 16px;
    text-align: center;
}

/* Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© */
.new-message-notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 15px 20px;
    border-radius: 10px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.3);
    z-index: 2000;
    animation: slideInRight 0.3s ease;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: transform 0.2s ease;
    max-width: 300px;
    word-wrap: break-word;
}

.new-message-notification:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 35px rgba(0,0,0,0.4);
}

.new-message-notification i {
    margin-left: 8px;
    font-size: 16px;
}

@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes fadeOut {
    from {
        opacity: 1;
    }
    to {
        opacity: 0;
    }
}

/* Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø¹Ø§Ù… Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© */
.global-message-notification {
    position: fixed;
    top: 80px;
    right: 20px;
    background: white;
    border: 1px solid #ddd;
    border-radius: 10px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.15);
    z-index: 2000;
    cursor: pointer;
    animation: slideInRight 0.3s ease, pulse 2s infinite 1s;
    min-width: 250px;
}

.notification-content {
    padding: 15px;
    display: flex;
    align-items: center;
}

.notification-content i {
    font-size: 24px;
    color: #667eea;
    margin-left: 15px;
}

.notification-text {
    flex: 1;
}

.notification-text strong {
    display: block;
    color: #333;
    font-size: 14px;
    margin-bottom: 2px;
}

.notification-text small {
    color: #666;
    font-size: 12px;
}

@keyframes pulse {
    0%, 100% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.02);
    }
}

/* Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„ØµØºÙŠØ±Ø© Ù…Ø«Ù„ Ù…Ø³Ù†Ø¬Ø± */
.mini-chat-window {
    position: fixed;
    bottom: 100px;
    right: 100px;
    width: 300px;
    height: 350px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.2);
    z-index: 1045;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    border: 1px solid #ddd;
    animation: slideInUp 0.3s ease;
}

.mini-chat-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 10px 15px;
    border-radius: 10px 10px 0 0;
}

.mini-chat-avatar {
    width: 35px;
    height: 35px;
    border-radius: 50%;
    background: rgba(255,255,255,0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
}

.mini-chat-controls button {
    background: none;
    border: none;
    color: white;
    padding: 5px;
    margin-left: 5px;
    border-radius: 3px;
    transition: background 0.2s ease;
}

.mini-chat-controls button:hover {
    background: rgba(255,255,255,0.2);
}

.mini-chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
    background: #f8f9fa;
}

.mini-chat-input {
    padding: 10px;
    border-top: 1px solid #ddd;
    background: white;
}

.mini-message {
    margin-bottom: 8px;
    display: flex;
    align-items: flex-start;
}

.mini-message.own {
    flex-direction: row-reverse;
}

.mini-message-content {
    max-width: 70%;
    padding: 8px 12px;
    border-radius: 15px;
    font-size: 14px;
    line-height: 1.3;
}

.mini-message:not(.own) .mini-message-content {
    background: #e9ecef;
    color: #333;
}

.mini-message.own .mini-message-content {
    background: #667eea;
    color: white;
}

.mini-message-time {
    font-size: 11px;
    opacity: 0.7;
    margin-top: 2px;
    text-align: center;
}

/* Ù…Ø¤Ø´Ø± Ø§Ù„ÙƒØªØ§Ø¨Ø© */
.typing-indicator {
    padding: 8px 15px;
    background: rgba(0,0,0,0.05);
    border-top: 1px solid #ddd;
    font-size: 12px;
    color: #666;
    font-style: italic;
}

.typing-dots {
    display: inline-block;
    margin-right: 5px;
}

.typing-dots span {
    display: inline-block;
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: #666;
    margin: 0 1px;
    animation: typing 1.4s infinite ease-in-out;
}

.typing-dots span:nth-child(1) { animation-delay: -0.32s; }
.typing-dots span:nth-child(2) { animation-delay: -0.16s; }

@keyframes typing {
    0%, 80%, 100% {
        transform: scale(0);
        opacity: 0.5;
    }
    40% {
        transform: scale(1);
        opacity: 1;
    }
}

/* Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© - Ù…Ø«Ù„ Facebook */
.facebook-chat-window {
    position: fixed;
    bottom: 0;
    width: 300px;
    height: 400px;
    background: white;
    border: 1px solid #ddd;
    border-bottom: none;
    border-radius: 8px 8px 0 0;
    box-shadow: 0 -2px 12px rgba(0,0,0,0.15);
    z-index: 1050;
    display: flex;
    flex-direction: column;
    animation: slideInUp 0.3s ease;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

.facebook-chat-window.minimized {
    height: 42px;
    overflow: hidden;
}

.chat-window-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 8px 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-radius: 8px 8px 0 0;
    cursor: pointer;
}

.chat-user-info {
    display: flex;
    align-items: center;
    flex: 1;
}

.chat-avatar {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: rgba(255,255,255,0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 12px;
    margin-left: 8px;
}

.chat-user-details {
    display: flex;
    flex-direction: column;
}

.chat-user-name {
    font-size: 13px;
    font-weight: 600;
    line-height: 1;
}

.chat-user-status {
    font-size: 11px;
    opacity: 0.8;
    line-height: 1;
}

.chat-window-controls {
    display: flex;
    gap: 4px;
}

.chat-control-btn {
    background: none;
    border: none;
    color: white;
    padding: 4px;
    border-radius: 4px;
    cursor: pointer;
    transition: background 0.2s;
    font-size: 12px;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.chat-control-btn:hover {
    background: rgba(255,255,255,0.2);
}

.chat-messages-container {
    flex: 1;
    overflow-y: auto;
    padding: 8px;
    background: #f8f9fa;
    display: flex;
    flex-direction: column;
}

.loading-messages {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
    color: #666;
    font-size: 13px;
}

.spinner {
    width: 16px;
    height: 16px;
    border: 2px solid #ddd;
    border-top: 2px solid #667eea;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-left: 8px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.chat-message {
    margin-bottom: 8px;
    display: flex;
    max-width: 85%;
}

.chat-message.own {
    align-self: flex-end;
    flex-direction: row-reverse;
}

.chat-message.other {
    align-self: flex-start;
}

.message-content {
    background: #e4e6ea;
    padding: 8px 12px;
    border-radius: 16px;
    font-size: 14px;
    line-height: 1.3;
    position: relative;
    word-wrap: break-word;
}

.chat-message.own .message-content {
    background: #667eea;
    color: white;
}

.message-time {
    font-size: 11px;
    opacity: 0.7;
    margin-top: 2px;
    text-align: center;
}

.typing-indicator {
    padding: 8px 12px;
    background: rgba(0,0,0,0.05);
    border-top: 1px solid #ddd;
    font-size: 12px;
    color: #666;
    display: flex;
    align-items: center;
}

.typing-dots {
    display: flex;
    gap: 2px;
    margin-right: 6px;
}

.typing-dots span {
    width: 4px;
    height: 4px;
    border-radius: 50%;
    background: #666;
    animation: typing 1.4s infinite ease-in-out;
}

.typing-dots span:nth-child(1) { animation-delay: -0.32s; }
.typing-dots span:nth-child(2) { animation-delay: -0.16s; }

@keyframes typing {
    0%, 80%, 100% {
        transform: scale(0);
        opacity: 0.5;
    }
    40% {
        transform: scale(1);
        opacity: 1;
    }
}

.chat-input-container {
    display: flex;
    padding: 8px;
    border-top: 1px solid #ddd;
    background: white;
    align-items: center;
    gap: 8px;
}

.chat-input {
    flex: 1;
    border: 1px solid #ddd;
    border-radius: 20px;
    padding: 8px 12px;
    font-size: 14px;
    outline: none;
    transition: border-color 0.2s;
}

.chat-input:focus {
    border-color: #667eea;
}

.send-btn {
    background: #667eea;
    border: none;
    color: white;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;
    font-size: 12px;
}

.send-btn:hover {
    background: #5a6fd8;
}

.unread-badge {
    background: #ff4444;
    color: white;
    border-radius: 10px;
    padding: 2px 6px;
    font-size: 11px;
    font-weight: bold;
    margin-right: 8px;
    min-width: 18px;
    text-align: center;
    line-height: 1.2;
}

/* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© */
@media (max-width: 768px) {
    .facebook-chat-window {
        width: calc(100vw - 20px);
        right: 10px !important;
        left: 10px;
        height: 350px;
    }

    .chat-widget {
        width: calc(100vw - 20px);
        right: 10px;
        left: 10px;
        height: 400px;
    }

    .chat-floating-btn {
        bottom: 20px;
        right: 20px;
    }
}
</style>

<script>
let chatWidgetVisible = false;
let chatWidgetMinimized = false;
let isDragging = false;
let dragOffset = { x: 0, y: 0 };

// Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ¹Ø© - Ù…Ø«Ù„ Facebook Messenger
const ChatManager = {
    // WebSocket
    socket: null,
    isConnected: false,
    reconnectAttempts: 0,
    maxReconnectAttempts: 5,
    reconnectDelay: 1000,

    // Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„Ù…ÙØªÙˆØ­Ø© (Ù†ÙˆØ§ÙØ° Ù…ØªØ¹Ø¯Ø¯Ø©)
    openChats: new Map(), // roomId -> chatWindow object

    // Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ØºÙŠØ± Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø©
    unreadCounts: new Map(), // roomId -> count

    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙˆØª ÙˆØ§Ù„ÙƒØªÙ…
    soundEnabled: true,
    mutedChats: new Set(),
    notificationAudio: null,

    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù…
    init() {
        console.log('ØªÙ‡ÙŠØ¦Ø© ChatManager...');
        this.initWebSocket();
        this.loadSettings();
        this.setupEventListeners();
        this.initializeAudio();
        console.log('ØªÙ… ØªÙ‡ÙŠØ¦Ø© ChatManager Ø¨Ù†Ø¬Ø§Ø­');
    },

    // ÙØªØ­ Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø£Ùˆ Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
    openChat(roomId, userInfo) {
        console.log('ChatManager.openChat called with:', roomId, userInfo);

        if (!roomId || !userInfo) {
            console.error('Ù…Ø¹Ø§Ù…Ù„Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø© Ù„ÙØªØ­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©:', { roomId, userInfo });
            return;
        }

        if (this.openChats.has(roomId)) {
            // Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
            console.log('Ø§Ù„Ù†Ø§ÙØ°Ø© Ù…ÙˆØ¬ÙˆØ¯Ø©ØŒ Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„ÙŠÙ‡Ø§');
            this.focusChat(roomId);
        } else {
            // Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø©
            console.log('Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø©');
            this.createChatWindow(roomId, userInfo);
        }

        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¹Ø¯Ø§Ø¯
        this.clearUnreadCount(roomId);
    },

    // Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø§ÙØ°Ø© Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©
    createChatWindow(roomId, userInfo) {
        console.log('Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø§ÙØ°Ø© Ù…Ø­Ø§Ø¯Ø«Ø©:', roomId, userInfo);

        const windowId = `chat-window-${roomId}`;
        const existingWindow = document.getElementById(windowId);

        if (existingWindow) {
            console.log('Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©');
            existingWindow.remove();
        }

        // Ø­Ø³Ø§Ø¨ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù†Ø§ÙØ°Ø© (Ù…ØªØ¹Ø¯Ø¯Ø© Ø§Ù„Ù†ÙˆØ§ÙØ°)
        const windowCount = this.openChats.size;
        const rightOffset = 30 + (windowCount * 320);

        try {
            const chatWindow = this.createChatWindowHTML(windowId, roomId, userInfo, rightOffset);
            document.body.appendChild(chatWindow);
            console.log('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Ø§ÙØ°Ø© Ù„Ù„ØµÙØ­Ø©');

            // Ø­ÙØ¸ Ù…Ø±Ø¬Ø¹ Ø§Ù„Ù†Ø§ÙØ°Ø©
            this.openChats.set(roomId, {
                element: chatWindow,
                roomId: roomId,
                userInfo: userInfo,
                isMinimized: false
            });

            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
            this.loadMessages(roomId);

            // ØªØ­Ø¯ÙŠØ« Ø²Ø± Ø§Ù„ÙƒØªÙ…
            this.updateMuteButton(roomId);

            console.log('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø¨Ù†Ø¬Ø§Ø­');
        } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø§ÙØ°Ø©:', error);
        }
    },

    // Ø¥Ù†Ø´Ø§Ø¡ HTML Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
    createChatWindowHTML(windowId, roomId, userInfo, rightOffset) {
        const div = document.createElement('div');
        div.id = windowId;
        div.className = 'facebook-chat-window';
        div.style.right = rightOffset + 'px';

        div.innerHTML = `
            <div class="chat-window-header">
                <div class="chat-user-info">
                    <div class="chat-avatar">
                        ${userInfo.name.charAt(0).toUpperCase()}
                    </div>
                    <div class="chat-user-details">
                        <span class="chat-user-name">${userInfo.name}</span>
                        <span class="chat-user-status">Ù…ØªØµÙ„</span>
                    </div>
                </div>
                <div class="chat-window-controls">
                    <button class="chat-control-btn" onclick="ChatManager.toggleMute('${roomId}')" title="ÙƒØªÙ…/Ø¥Ù„ØºØ§Ø¡ ÙƒØªÙ…" id="mute-btn-${roomId}">
                        <i class="fas fa-volume-up"></i>
                    </button>
                    <button class="chat-control-btn" onclick="ChatManager.minimizeChat('${roomId}')" title="ØªØµØºÙŠØ±">
                        <i class="fas fa-minus"></i>
                    </button>
                    <button class="chat-control-btn" onclick="ChatManager.closeChat('${roomId}')" title="Ø¥ØºÙ„Ø§Ù‚">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>

            <div class="chat-messages-container" id="messages-${roomId}">
                <div class="loading-messages">
                    <div class="spinner"></div>
                    <span>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„...</span>
                </div>
            </div>

            <div class="typing-indicator" id="typing-${roomId}" style="display: none;">
                <span class="typing-text"></span>
                <div class="typing-dots">
                    <span></span><span></span><span></span>
                </div>
            </div>

            <div class="chat-input-container">
                <input type="text"
                       class="chat-input"
                       id="input-${roomId}"
                       placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..."
                       onkeypress="ChatManager.handleKeyPress(event, '${roomId}')"
                       oninput="ChatManager.handleTyping('${roomId}')"
                       onblur="ChatManager.stopTyping('${roomId}')">
                <button class="send-btn" onclick="ChatManager.sendMessage('${roomId}')">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        `;

        return div;
    },

    // Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ù…Ø­Ø§Ø¯Ø«Ø© Ù…ÙˆØ¬ÙˆØ¯Ø©
    focusChat(roomId) {
        const chat = this.openChats.get(roomId);
        if (chat && chat.isMinimized) {
            this.restoreChat(roomId);
        }

        // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ø£Ø³ÙÙ„
        this.scrollToBottom(roomId);

        // Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
        const input = document.getElementById(`input-${roomId}`);
        if (input) input.focus();
    },

    // Ø¥ØºÙ„Ø§Ù‚ Ù…Ø­Ø§Ø¯Ø«Ø©
    closeChat(roomId) {
        const chat = this.openChats.get(roomId);
        if (chat) {
            chat.element.remove();
            this.openChats.delete(roomId);

            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ±ØªÙŠØ¨ Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©
            this.rearrangeWindows();
        }
    },

    // ØªØµØºÙŠØ± Ù…Ø­Ø§Ø¯Ø«Ø©
    minimizeChat(roomId) {
        const chat = this.openChats.get(roomId);
        if (chat) {
            const messagesContainer = chat.element.querySelector('.chat-messages-container');
            const inputContainer = chat.element.querySelector('.chat-input-container');
            const typingIndicator = chat.element.querySelector('.typing-indicator');

            messagesContainer.style.display = 'none';
            inputContainer.style.display = 'none';
            typingIndicator.style.display = 'none';

            chat.isMinimized = true;
            chat.element.classList.add('minimized');
        }
    },

    // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù…Ø­Ø§Ø¯Ø«Ø© Ù…ØµØºØ±Ø©
    restoreChat(roomId) {
        const chat = this.openChats.get(roomId);
        if (chat) {
            const messagesContainer = chat.element.querySelector('.chat-messages-container');
            const inputContainer = chat.element.querySelector('.chat-input-container');

            messagesContainer.style.display = 'block';
            inputContainer.style.display = 'flex';

            chat.isMinimized = false;
            chat.element.classList.remove('minimized');

            // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ø£Ø³ÙÙ„
            this.scrollToBottom(roomId);
        }
    },

    // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø§Ù„ÙˆØ§Ø±Ø¯Ø©
    handleIncomingMessage(message) {
        console.log('Ù…Ø¹Ø§Ù„Ø¬Ø© Ø±Ø³Ø§Ù„Ø© ÙˆØ§Ø±Ø¯Ø©:', message);

        const roomId = message.room_id;
        console.log('roomId from message:', roomId);
        console.log('currentChatRoomId:', currentChatRoomId);

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„ÙŠØ³Øª Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
        const isFromCurrentUser = message.sender?.is_current_user || false;
        if (isFromCurrentUser) {
            console.log('Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠØŒ ØªØ¬Ø§Ù‡Ù„');
            return;
        }

        // ÙØ­Øµ Ø§Ù„ØªÙƒØ±Ø§Ø± - Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„
        if (this.isMessageAlreadyDisplayed(roomId, message)) {
            console.log('Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ØŒ ØªØ¬Ø§Ù‡Ù„ Ø§Ù„ØªÙƒØ±Ø§Ø±');
            return;
        }

        // ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª Ù…Ø¹ ÙØ­Øµ Ø§Ù„ÙƒØªÙ…
        this.playSound('receive', roomId);

        // ÙØªØ­ Ø§Ù„Ù†Ø§ÙØ°Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙØªÙˆØ­Ø©
        if (!this.openChats.has(roomId) && (!currentChatRoomId || currentChatRoomId !== roomId)) {
            console.log('ÙØªØ­ Ù†Ø§ÙØ°Ø© ØµØºÙŠØ±Ø© Ù„Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ÙˆØ§Ø±Ø¯Ø©');
            const senderInfo = {
                id: message.sender?.id || message.sender_id,
                name: message.sender?.name || message.sender_name || 'Ù…Ø³ØªØ®Ø¯Ù…'
            };
            openMiniChatForRoom(roomId, senderInfo);
        }

        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ù†Ø§ÙØ°Ø©
        if (currentChatRoomId === roomId) {
            // Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„ØµØºÙŠØ±Ø©
            addMiniChatMessage(message.content, false, message.created_at);
        } else {
            // Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„ÙƒØ¨ÙŠØ±Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙØªÙˆØ­Ø©
            this.addMessageToWindow(roomId, message, false);
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù†Ø§ÙØ°Ø© Ù…ØµØºØ±Ø©
        const chat = this.openChats.get(roomId);
        if (chat && chat.isMinimized) {
            this.incrementUnreadCount(roomId);
        } else {
            // ØªØ­Ø¯ÙŠØ¯ ÙƒÙ…Ù‚Ø±ÙˆØ¡Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù†Ø§ÙØ°Ø© Ù…ÙØªÙˆØ­Ø©
            this.markAsRead(roomId);
        }

        // Ø¥Ø¸Ù‡Ø§Ø± Ø¥Ø´Ø¹Ø§Ø±
        this.showNotification(message);

        // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
        if (typeof loadActiveUsers === 'function') {
            loadActiveUsers();
        }
    },

    // ÙØ­Øµ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø±
    isMessageAlreadyDisplayed(roomId, message) {
        const messageId = message.id || message.temp_id;

        // ÙØ­Øµ Ø¨Ø§Ù„Ù…Ø¹Ø±Ù Ø§Ù„ÙØ±ÙŠØ¯ Ø£ÙˆÙ„Ø§Ù‹ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªØ§Ø­Ø§Ù‹
        if (messageId) {
            // ÙØ­Øµ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„ØµØºÙŠØ±Ø©
            if (currentChatRoomId === roomId) {
                const miniMessages = document.getElementById('miniChatMessages');
                if (miniMessages) {
                    const existingMessage = miniMessages.querySelector(`[data-message-id="${messageId}"]`);
                    if (existingMessage) {
                        return true;
                    }
                }
            }

            // ÙØ­Øµ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„ÙƒØ¨ÙŠØ±Ø©
            const messagesContainer = document.getElementById(`messages-${roomId}`);
            if (messagesContainer) {
                const existingMessage = messagesContainer.querySelector(`[data-message-id="${messageId}"]`);
                if (existingMessage) {
                    return true;
                }
            }
        }

        // ÙØ­Øµ Ø¨Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙˆØ§Ù„ÙˆÙ‚Øª ÙƒØ¨Ø¯ÙŠÙ„
        const containers = [];

        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„ØµØºÙŠØ±Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù„Ù„ØºØ±ÙØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        if (currentChatRoomId === roomId) {
            const miniMessages = document.getElementById('miniChatMessages');
            if (miniMessages) containers.push(miniMessages);
        }

        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„ÙƒØ¨ÙŠØ±Ø©
        const messagesContainer = document.getElementById(`messages-${roomId}`);
        if (messagesContainer) containers.push(messagesContainer);

        for (let container of containers) {
            const messageElements = container.querySelectorAll('.message, .chat-message');
            for (let element of messageElements) {
                const messageContent = element.querySelector('.message-content');
                if (messageContent && messageContent.textContent.trim() === message.content.trim()) {
                    // ÙØ­Øµ Ø¥Ø¶Ø§ÙÙŠ Ø¨Ø§Ù„ÙˆÙ‚Øª
                    const messageTime = element.querySelector('.message-time');
                    if (messageTime && message.created_at) {
                        const displayedTime = new Date(messageTime.getAttribute('data-timestamp') || messageTime.textContent);
                        const messageTime_obj = new Date(message.created_at);
                        const timeDiff = Math.abs(displayedTime - messageTime_obj);

                        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙØ±Ù‚ Ø£Ù‚Ù„ Ù…Ù† 10 Ø«ÙˆØ§Ù†ØŒ Ø§Ø¹ØªØ¨Ø±Ù‡Ø§ Ù†ÙØ³ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
                        if (timeDiff < 10000) {
                            return true;
                        }
                    } else {
                        // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ ÙˆÙ‚ØªØŒ Ø§Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙÙ‚Ø·
                        return true;
                    }
                }
            }
        }

        return false;
    },

    // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¹Ù†Ø¯ Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
    refreshUserListAfterDelete() {
        console.log('ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¨Ø¹Ø¯ Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©');
        if (typeof loadActiveUsers === 'function') {
            loadActiveUsers();
        }
    },

    // Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
    addMessageToWindow(roomId, message, isOwn = false) {
        const messagesContainer = document.getElementById(`messages-${roomId}`);
        if (!messagesContainer) return;

        // ÙØ­Øµ Ø§Ù„ØªÙƒØ±Ø§Ø± Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙØ©
        if (this.isMessageAlreadyDisplayed(roomId, message)) {
            console.log('Ø±Ø³Ø§Ù„Ø© Ù…ÙƒØ±Ø±Ø© ÙÙŠ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„ÙƒØ¨ÙŠØ±Ø©ØŒ ØªÙ… ØªØ¬Ø§Ù‡Ù„Ù‡Ø§');
            return;
        }

        // Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
        const loading = messagesContainer.querySelector('.loading-messages');
        if (loading) loading.remove();

        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-message ${isOwn ? 'own' : 'other'}`;

        // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø±Ù ÙØ±ÙŠØ¯ Ù„Ù„Ø±Ø³Ø§Ù„Ø© Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø±
        const messageId = message.id || message.temp_id || 'msg_' + Date.now() + '_' + Math.random();
        messageDiv.setAttribute('data-message-id', messageId);

        const time = new Date(message.created_at || new Date()).toLocaleTimeString('ar-EG', {
            hour: '2-digit',
            minute: '2-digit'
        });

        messageDiv.innerHTML = `
            <div class="message-content">
                ${message.content}
                <div class="message-time" data-timestamp="${message.created_at || new Date().toISOString()}">${time}</div>
            </div>
        `;

        messagesContainer.appendChild(messageDiv);
        this.scrollToBottom(roomId);

        // ØªØ£Ø«ÙŠØ± Ø¨ØµØ±ÙŠ Ù„Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        if (!isOwn) {
            messageDiv.style.opacity = '0';
            messageDiv.style.transform = 'translateY(10px)';
            setTimeout(() => {
                messageDiv.style.transition = 'all 0.3s ease';
                messageDiv.style.opacity = '1';
                messageDiv.style.transform = 'translateY(0)';
            }, 10);
        }
    },

    // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©
    sendMessage(roomId) {
        const input = document.getElementById(`input-${roomId}`);
        if (!input) return;

        const content = input.value.trim();
        if (!content) return;

        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù„ÙˆØ§Ø¬Ù‡Ø© ÙÙˆØ±Ø§Ù‹ Ù…Ø¹ Ù…Ø¹Ø±Ù Ù…Ø¤Ù‚Øª Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø±
        const tempMessage = {
            content: content,
            created_at: new Date(),
            sender: { name: 'Ø£Ù†Øª' },
            temp_id: 'temp_' + Date.now() + '_' + Math.random()
        };
        this.addMessageToWindow(roomId, tempMessage, true);

        // Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø¨Ø± WebSocket
        if (this.isConnected) {
            this.socket.send(JSON.stringify({
                type: 'send_message',
                room_id: roomId,
                content: content
            }));
        }

        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø­Ù‚Ù„
        input.value = '';
        this.stopTyping(roomId);

        // ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
        this.playSound('send', roomId);
    },

    // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¶ØºØ· Ø§Ù„Ù…ÙØ§ØªÙŠØ­
    handleKeyPress(event, roomId) {
        if (event.key === 'Enter') {
            this.sendMessage(roomId);
        }
    },

    // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø©
    handleTyping(roomId) {
        if (!this.isConnected) return;

        // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø§Ø±Ø© Ø¨Ø¯Ø¡ Ø§Ù„ÙƒØªØ§Ø¨Ø©
        this.socket.send(JSON.stringify({
            type: 'typing_start',
            room_id: roomId
        }));

        // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØªÙŠÙ†
        clearTimeout(this.typingTimeout);
        this.typingTimeout = setTimeout(() => {
            this.stopTyping(roomId);
        }, 2000);
    },

    // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØªØ§Ø¨Ø©
    stopTyping(roomId) {
        if (this.isConnected) {
            this.socket.send(JSON.stringify({
                type: 'typing_stop',
                room_id: roomId
            }));
        }
        clearTimeout(this.typingTimeout);
    },

    // Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø©
    scrollToBottom(roomId) {
        const container = document.getElementById(`messages-${roomId}`);
        if (container) {
            container.scrollTop = container.scrollHeight;
        }
    },

    rearrangeWindows() {
        let index = 0;
        for (const [roomId, chat] of this.openChats) {
            const rightOffset = 30 + (index * 320);
            chat.element.style.right = rightOffset + 'px';
            index++;
        }
    },

    incrementUnreadCount(roomId) {
        const current = this.unreadCounts.get(roomId) || 0;
        this.unreadCounts.set(roomId, current + 1);
        this.updateChatHeader(roomId);
        this.updateFloatingButton();
    },

    clearUnreadCount(roomId) {
        this.unreadCounts.delete(roomId);
        this.updateChatHeader(roomId);
        this.updateFloatingButton();
    },

    updateChatHeader(roomId) {
        const chat = this.openChats.get(roomId);
        if (!chat) return;

        const count = this.unreadCounts.get(roomId) || 0;
        const header = chat.element.querySelector('.chat-window-header');

        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù‚Ø¯ÙŠÙ…
        const oldBadge = header.querySelector('.unread-badge');
        if (oldBadge) oldBadge.remove();

        // Ø¥Ø¶Ø§ÙØ© Ø¹Ø¯Ø§Ø¯ Ø¬Ø¯ÙŠØ¯ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø±Ø³Ø§Ø¦Ù„ ØºÙŠØ± Ù…Ù‚Ø±ÙˆØ¡Ø©
        if (count > 0) {
            const badge = document.createElement('span');
            badge.className = 'unread-badge';
            badge.textContent = count;
            header.appendChild(badge);
        }
    },

    updateFloatingButton() {
        const totalUnread = Array.from(this.unreadCounts.values()).reduce((sum, count) => sum + count, 0);
        const badge = document.getElementById('chatNotificationBadge');

        if (badge) {
            if (totalUnread > 0) {
                badge.textContent = totalUnread;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }
    },

    handleTypingIndicator(data) {
        const roomId = data.room_id;
        const typingElement = document.getElementById(`typing-${roomId}`);

        if (!typingElement) return;

        if (data.is_typing && data.user_name) {
            const textElement = typingElement.querySelector('.typing-text');
            textElement.textContent = `${data.user_name} ÙŠÙƒØªØ¨...`;
            typingElement.style.display = 'flex';

            // Ø¥Ø®ÙØ§Ø¡ Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†
            setTimeout(() => {
                typingElement.style.display = 'none';
            }, 3000);
        } else {
            typingElement.style.display = 'none';
        }
    },

    playSound(type, roomId = null) {
        console.log('playSound called with type:', type, 'roomId:', roomId);
        console.log('mutedChats:', Array.from(this.mutedChats));
        // ÙØ­Øµ Ø§Ù„ÙƒØªÙ… Ø£ÙˆÙ„Ø§Ù‹
        if (roomId && this.mutedChats.has(roomId)) {
            console.log('Ø§Ù„ØµÙˆØª Ù…ÙƒØªÙˆÙ… Ù„Ù„ØºØ±ÙØ©:', roomId);
            return;
        }

        // ÙØ­Øµ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙˆØª Ø§Ù„Ø¹Ø§Ù…Ø©
        if (!this.soundEnabled) {
            console.log('Ø§Ù„ØµÙˆØª Ù…Ø¹Ø·Ù„ Ø¹Ø§Ù„Ù…ÙŠØ§Ù‹');
            return;
        }

        // ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª
        try {
            const audio = this.notificationAudio;
            if (audio && audio.play) {
                audio.currentTime = 0;
                const playPromise = audio.play();
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        console.log('ØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª Ø¨Ù†Ø¬Ø§Ø­ (ChatManager)');
                    }).catch(e => {
                        console.log('ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª:', e);
                    });
                }
            } else {
                console.log('Ù…Ù„Ù Ø§Ù„ØµÙˆØª ØºÙŠØ± Ù…ØªØ§Ø­');
            }
        } catch (error) {
            console.log('Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª:', error);
        }
    },

    showNotification(message) {
        // Ø¥Ø¸Ù‡Ø§Ø± Ø¥Ø´Ø¹Ø§Ø± Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ´ØºÙŠÙ„ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø³Ù…ÙˆØ­Ø§Ù‹
        if ('Notification' in window && Notification.permission === 'granted') {
            const senderName = message.sender?.name || message.sender_name || 'Ù…Ø³ØªØ®Ø¯Ù…';
            const content = message.content || 'Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©';

            new Notification(`Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† ${senderName}`, {
                body: content,
                icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTIwIDJINEMyLjkgMiAyIDIuOSAyIDRWMjJMMTggMjBIMjBDMjEuMSAyMCAyMiAxOS4xIDIyIDE4VjRDMjIgMi45IDIxLjEgMiAyMCAyWiIgZmlsbD0iIzY2N2VlYSIvPgo8L3N2Zz4K'
            });
        }
    },

    toggleMute(roomId) {
        console.log('ØªØ¨Ø¯ÙŠÙ„ ÙƒØªÙ… Ø§Ù„ØµÙˆØª Ù„Ù„ØºØ±ÙØ©:', roomId);

        if (this.mutedChats.has(roomId)) {
            this.mutedChats.delete(roomId);
            console.log('ØªÙ… Ø¥Ù„ØºØ§Ø¡ ÙƒØªÙ… Ø§Ù„ØµÙˆØª');
            this.showToast('ØªÙ… Ø¥Ù„ØºØ§Ø¡ ÙƒØªÙ… Ø§Ù„ØµÙˆØª', 'success');
        } else {
            this.mutedChats.add(roomId);
            console.log('ØªÙ… ÙƒØªÙ… Ø§Ù„ØµÙˆØª');
            this.showToast('ØªÙ… ÙƒØªÙ… Ø§Ù„ØµÙˆØª', 'info');
        }

        this.updateMuteButton(roomId);
        this.saveSettings();
    },

    updateMuteButton(roomId) {
        const muteBtn = document.getElementById(`mute-btn-${roomId}`);
        if (!muteBtn) {
            console.log('Ø²Ø± Ø§Ù„ÙƒØªÙ… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ù„Ù„ØºØ±ÙØ©:', roomId);
            return;
        }

        const icon = muteBtn.querySelector('i');
        if (!icon) return;

        if (this.mutedChats.has(roomId)) {
            icon.className = 'fas fa-volume-mute';
            muteBtn.title = 'Ø¥Ù„ØºØ§Ø¡ ÙƒØªÙ… Ø§Ù„ØµÙˆØª';
        } else {
            icon.className = 'fas fa-volume-up';
            muteBtn.title = 'ÙƒØªÙ… Ø§Ù„ØµÙˆØª';
        }

        console.log('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø²Ø± Ø§Ù„ÙƒØªÙ… Ù„Ù„ØºØ±ÙØ©:', roomId, 'Ù…ÙƒØªÙˆÙ…:', this.mutedChats.has(roomId));
    },

    loadSettings() {
        const saved = localStorage.getItem('chatSettings');
        if (saved) {
            try {
                const settings = JSON.parse(saved);
                this.mutedChats = new Set(settings.mutedChats || []);
                this.soundEnabled = settings.soundEnabled !== false;
            } catch (e) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª:', e);
            }
        }
    },

    saveSettings() {
        const settings = {
            mutedChats: Array.from(this.mutedChats),
            soundEnabled: this.soundEnabled
        };
        localStorage.setItem('chatSettings', JSON.stringify(settings));
    },

    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø£ØµÙˆØ§Øª
    initializeAudio() {
        try {
            this.notificationAudio = new Audio('/static/sounds/message-receive.wav');

            // Ø§Ø®ØªØ¨Ø§Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª
            this.notificationAudio.addEventListener('error', () => {
                console.log('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ ØµÙˆØª Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… ØµÙˆØª Ø¨Ø¯ÙŠÙ„');
                this.notificationAudio = this.createFallbackAudio();
            });

        } catch (error) {
            console.log('Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø£ØµÙˆØ§Øª:', error);
            this.notificationAudio = this.createFallbackAudio();
        }
    },

    // Ø¥Ù†Ø´Ø§Ø¡ ØµÙˆØª Ø¨Ø¯ÙŠÙ„
    createFallbackAudio() {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);

        oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);

        return {
            play: () => {
                try {
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.1);
                } catch (e) {
                    console.log('Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª Ø§Ù„Ø¨Ø¯ÙŠÙ„');
                }
            }
        };
    },

    // ØªÙ… Ø­Ø°Ù playNotificationSound - ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… playSound Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù†Ù‡Ø§

    // ØªØ¨Ø¯ÙŠÙ„ ÙƒØªÙ… Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
    toggleChatMute(roomId) {
        if (this.mutedChats.has(roomId)) {
            this.mutedChats.delete(roomId);
            console.log('ØªÙ… Ø¥Ù„ØºØ§Ø¡ ÙƒØªÙ… Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©:', roomId);
        } else {
            this.mutedChats.add(roomId);
            console.log('ØªÙ… ÙƒØªÙ… Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©:', roomId);
        }
        this.saveSettings();
        return !this.mutedChats.has(roomId); // Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    },

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„ÙƒØªÙ…
    isChatMuted(roomId) {
        return this.mutedChats.has(roomId);
    },

    // ØªÙ‡ÙŠØ¦Ø© WebSocket
    initWebSocket() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws/chat/`;

        this.socket = new WebSocket(wsUrl);

        this.socket.onopen = (e) => {
            console.log('âœ… WebSocket Ù…ØªØµÙ„ Ø¨Ù†Ø¬Ø§Ø­');
            this.isConnected = true;
            this.reconnectAttempts = 0;

            // Ø¥Ø±Ø³Ø§Ù„ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            this.socket.send(JSON.stringify({
                type: 'user_status_update',
                status: 'online'
            }));
        };

        this.socket.onmessage = (e) => {
            const data = JSON.parse(e.data);
            this.handleWebSocketMessage(data);
        };

        this.socket.onclose = (e) => {
            console.log('âŒ WebSocket Ù…Ù‚Ø·ÙˆØ¹:', e.code, e.reason);
            this.isConnected = false;

            // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
            if (this.reconnectAttempts < this.maxReconnectAttempts) {
                setTimeout(() => {
                    this.reconnectAttempts++;
                    console.log(`ğŸ”„ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ ${this.reconnectAttempts}/${this.maxReconnectAttempts}`);
                    this.initWebSocket();
                }, this.reconnectDelay * this.reconnectAttempts);
            }
        };

        this.socket.onerror = (e) => {
            console.error('Ø®Ø·Ø£ ÙÙŠ WebSocket:', e);
        };
    },

    // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø±Ø³Ø§Ø¦Ù„ WebSocket
    handleWebSocketMessage(data) {
        console.log('Ø±Ø³Ø§Ù„Ø© WebSocket:', data);

        switch(data.type) {
            case 'new_message':
                this.handleIncomingMessage(data.message);
                break;
            case 'new_message_notification':
                this.handleIncomingMessage(data.message);
                break;
            case 'typing_indicator':
                this.handleTypingIndicator(data);
                break;
            case 'user_status_update':
                this.handleUserStatusUpdate(data);
                break;
            case 'room_joined':
                console.log('ØªÙ… Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„ØºØ±ÙØ©:', data.room_id);
                break;
            case 'messages_read':
                this.handleMessagesRead(data);
                break;
        }
    },

    // Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    handleUserStatusUpdate(data) {
        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        if (typeof updateUserStatusInList === 'function') {
            updateUserStatusInList(data.user_id, data.status);
        }
        // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù†Ø´Ø·ÙŠÙ†
        if (typeof loadActiveUsers === 'function') {
            loadActiveUsers();
        }
    },

    // Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ø¤Ø´Ø± Ø§Ù„ÙƒØªØ§Ø¨Ø©
    handleTypingIndicator(data) {
        const typingIndicator = document.getElementById(`typing-${data.room_id}`);
        if (!typingIndicator) return;

        if (data.is_typing && data.user_name) {
            typingIndicator.querySelector('.typing-text').textContent = `${data.user_name} ÙŠÙƒØªØ¨ Ø§Ù„Ø¢Ù†`;
            typingIndicator.style.display = 'block';

            // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ø¤Ø´Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†
            setTimeout(() => {
                if (typingIndicator.style.display === 'block') {
                    typingIndicator.style.display = 'none';
                }
            }, 3000);
        } else {
            typingIndicator.style.display = 'none';
        }
    },

    // Ù…Ø¹Ø§Ù„Ø¬Ø© Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
    handleMessagesRead(data) {
        console.log(`Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ${data.user_id} Ù‚Ø±Ø£ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙÙŠ Ø§Ù„ØºØ±ÙØ© ${data.room_id}`);
        // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚ Ø¥Ø¶Ø§ÙÙŠ Ù‡Ù†Ø§ Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±
    },

    // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
    setupEventListeners() {
        // Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ header Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…ØµØºØ±Ø©
        document.addEventListener('click', (e) => {
            if (e.target.closest('.chat-window-header')) {
                const windowElement = e.target.closest('.facebook-chat-window');
                if (windowElement && windowElement.classList.contains('minimized')) {
                    const roomId = windowElement.id.replace('chat-window-', '');
                    this.restoreChat(roomId);
                }
            }
        });
    },

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
    loadMessages(roomId) {
        fetch(`/modern-chat/api/messages/${roomId}/`)
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById(`messages-${roomId}`);
                if (!container) return;

                // Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
                container.innerHTML = '';

                if (data.messages && data.messages.length > 0) {
                    data.messages.forEach(message => {
                        this.addMessageToWindow(roomId, message, message.sender.is_current_user);
                    });
                } else {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #666; font-size: 13px;">
                            <i class="fas fa-comments" style="font-size: 24px; margin-bottom: 8px; display: block;"></i>
                            Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
                        </div>
                    `;
                }

                this.scrollToBottom(roomId);
            })
            .catch(error => {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„:', error);
            });
    },

    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙƒÙ…Ù‚Ø±ÙˆØ¡Ø©
    markAsRead(roomId) {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
                         document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');

        fetch(`/modern-chat/api/mark-read/${roomId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                this.clearUnreadCount(roomId);
            }
        })
        .catch(error => {
            console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙƒÙ…Ù‚Ø±ÙˆØ¡Ø©:', error);
        });
    },

    // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© ØªÙˆØ³Øª
    showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `alert alert-${type} position-fixed`;
        toast.style.cssText = `
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 250px;
            animation: slideInRight 0.3s ease;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        `;
        toast.textContent = message;

        document.body.appendChild(toast);

        setTimeout(() => {
            toast.style.animation = 'slideOutRight 0.3s ease';
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 300);
        }, 3000);
    }
};

// ØªÙ… Ø­Ø°Ù Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ… - ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… ChatManager ÙÙ‚Ø·

// ØªÙ… Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© - ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… ChatManager.handleIncomingMessage Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù†Ù‡Ø§

function handleTypingIndicator(data) {
    const typingIndicator = document.getElementById('typingIndicator');
    if (!typingIndicator) return;

    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„ÙƒØªØ§Ø¨Ø© ÙÙŠ Ø§Ù„ØºØ±ÙØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    if (data.room_id && data.room_id !== currentChatRoomId) {
        return;
    }

    if (data.is_typing && data.user_name) {
        typingIndicator.innerHTML = `
            <span class="typing-user">${data.user_name}</span> ÙŠÙƒØªØ¨ Ø§Ù„Ø¢Ù†
            <div class="typing-dots">
                <span></span>
                <span></span>
                <span></span>
            </div>
        `;
        typingIndicator.style.display = 'block';

        // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ø¤Ø´Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†
        setTimeout(() => {
            if (typingIndicator.style.display === 'block') {
                typingIndicator.style.display = 'none';
            }
        }, 3000);
    } else {
        typingIndicator.style.display = 'none';
    }
}

function handleUserStatusUpdate(data) {
    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    updateUserStatusInList(data.user_id, data.status);
}

function handleNewMessageNotification(data) {
    // Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ Ù…Ù† ØºØ±Ù Ø£Ø®Ø±Ù‰
    if (currentChatRoomId !== data.room_id) {
        showGlobalNewMessageNotification({
            has_new_messages: true,
            new_message_count: 1,
            sender_name: data.message.sender_name
        });
    }
}

function handleMessagesRead(data) {
    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
    console.log(`Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ${data.user_id} Ù‚Ø±Ø£ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙÙŠ Ø§Ù„ØºØ±ÙØ© ${data.room_id}`);
}

// Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª
document.addEventListener('DOMContentLoaded', function() {
    const floatingBtn = document.getElementById('chatFloatingButton');

    if (!floatingBtn) {
        console.error('âŒ Ø§Ù„Ø²Ø± Ø§Ù„Ø¹Ø§Ø¦Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!');
        return;
    }

    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³Ø­Ø¨ - Ø¥Ø¶Ø§ÙØ© passive: false Ù„Ù…Ù†Ø¹ Ø§Ù„ØªØ¯Ø§Ø®Ù„
    floatingBtn.addEventListener('mousedown', startDrag, { passive: false });
    floatingBtn.addEventListener('touchstart', startDrag, { passive: false });

    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙÙ‚Ø·
    ChatManager.init();

    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·)
    updateUserStatus();
    loadActiveUsers();
});

function startDrag(e) {
    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø± Ù†ÙØ³Ù‡ ÙˆÙ„ÙŠØ³ Ø¹Ù„Ù‰ Ø¹Ù†Ø§ØµØ± Ø£Ø®Ø±Ù‰
    if (!e.target.closest('.chat-btn-main')) {
        return;
    }

    e.preventDefault();
    e.stopPropagation();

    isDragging = true;

    const floatingBtn = document.getElementById('chatFloatingButton');
    const rect = floatingBtn.getBoundingClientRect();

    const clientX = e.clientX || (e.touches && e.touches[0].clientX);
    const clientY = e.clientY || (e.touches && e.touches[0].clientY);

    dragOffset.x = clientX - rect.left;
    dragOffset.y = clientY - rect.top;

    floatingBtn.classList.add('dragging');

    // Ø¥Ø¶Ø§ÙØ© event listeners Ù…Ø¹ passive: false
    document.addEventListener('mousemove', drag, { passive: false });
    document.addEventListener('mouseup', stopDrag, { passive: false });
    document.addEventListener('touchmove', drag, { passive: false });
    document.addEventListener('touchend', stopDrag, { passive: false });
}

function drag(e) {
    if (!isDragging) return;

    e.preventDefault();
    const floatingBtn = document.getElementById('chatFloatingButton');

    const clientX = e.clientX || (e.touches && e.touches[0].clientX);
    const clientY = e.clientY || (e.touches && e.touches[0].clientY);

    let newX = clientX - dragOffset.x;
    let newY = clientY - dragOffset.y;

    // Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø´Ø§Ø´Ø© Ù…Ø¹ Ù‡Ø§Ù…Ø´
    const margin = 10;
    const maxX = window.innerWidth - floatingBtn.offsetWidth - margin;
    const maxY = window.innerHeight - floatingBtn.offsetHeight - margin;

    newX = Math.max(margin, Math.min(newX, maxX));
    newY = Math.max(margin, Math.min(newY, maxY));

    // Ø§Ø³ØªØ®Ø¯Ø§Ù… transform Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† left/top Ù„Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø£ÙØ¶Ù„
    floatingBtn.style.transform = `translate(${newX - parseInt(floatingBtn.style.right || 30)}px, ${newY - parseInt(floatingBtn.style.bottom || 30)}px) scale(1.05)`;
}

function stopDrag() {
    if (!isDragging) return;

    isDragging = false;
    const floatingBtn = document.getElementById('chatFloatingButton');

    floatingBtn.classList.remove('dragging');
    floatingBtn.classList.add('snapping');

    // Ø§Ù„ØªÙ‚Ø§Ø· Ø¥Ù„Ù‰ Ø§Ù„Ø­ÙˆØ§Ù
    snapToEdge();

    setTimeout(() => {
        floatingBtn.classList.remove('snapping');
    }, 200);

    document.removeEventListener('mousemove', drag);
    document.removeEventListener('mouseup', stopDrag);
    document.removeEventListener('touchmove', drag);
    document.removeEventListener('touchend', stopDrag);
}

function snapToEdge() {
    const floatingBtn = document.getElementById('chatFloatingButton');
    const rect = floatingBtn.getBoundingClientRect();
    const centerX = rect.left + rect.width / 2;

    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† transform
    floatingBtn.style.transform = '';

    if (centerX < window.innerWidth / 2) {
        // Ø§Ù„ØªÙ‚Ø§Ø· Ø¥Ù„Ù‰ Ø§Ù„ÙŠØ³Ø§Ø±
        floatingBtn.style.left = '20px';
        floatingBtn.style.right = 'auto';
        floatingBtn.style.bottom = '20px';
        floatingBtn.style.top = 'auto';
    } else {
        // Ø§Ù„ØªÙ‚Ø§Ø· Ø¥Ù„Ù‰ Ø§Ù„ÙŠÙ…ÙŠÙ†
        floatingBtn.style.right = '20px';
        floatingBtn.style.left = 'auto';
        floatingBtn.style.bottom = '20px';
        floatingBtn.style.top = 'auto';
    }
}

function toggleChatWidget() {
    if (ChatManager.isDragging) return; // Ù…Ù†Ø¹ ÙØªØ­ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø³Ø­Ø¨

    const widget = document.getElementById('chatWidget');

    if (chatWidgetVisible) {
        if (chatWidgetMinimized) {
            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…ØµØºØ±Ø©
            widget.style.display = 'flex';
            chatWidgetMinimized = false;
            loadChatData();
            // Ø¥Ø®ÙØ§Ø¡ Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ù†Ø§ÙØ°Ø©
            hideChatNotificationBadge();
        } else {
            // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù†Ø§ÙØ°Ø©
            closeChatWidget();
        }
    } else {
        // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†Ø§ÙØ°Ø©
        widget.style.display = 'flex';
        chatWidgetVisible = true;
        chatWidgetMinimized = false;
        loadChatData();
        // Ø¥Ø®ÙØ§Ø¡ Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ù†Ø§ÙØ°Ø©
        hideChatNotificationBadge();
    }
}

function hideChatNotificationBadge() {
    const badge = document.getElementById('chatNotificationBadge');
    if (badge) {
        badge.style.display = 'none';
        badge.textContent = '0';
    }
}

function showChatNotificationBadge(count = 1) {
    const badge = document.getElementById('chatNotificationBadge');
    if (badge) {
        badge.textContent = count;
        badge.style.display = 'flex';
    }
}

function minimizeChatWidget() {
    const widget = document.getElementById('chatWidget');
    widget.style.display = 'none';
    chatWidgetMinimized = true;
}

function closeChatWidget() {
    const widget = document.getElementById('chatWidget');
    widget.style.display = 'none';
    chatWidgetVisible = false;
    chatWidgetMinimized = false;
}

function openFullChat() {
    // Ù„Ø§ Ù†Ø­ØªØ§Ø¬ Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø¢Ù†
    alert('ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„ÙƒØ¨ÙŠØ±Ø©. Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„ØµØºÙŠØ±Ø© ÙÙ‚Ø·.');
}

function loadChatData() {
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù†Ø´Ø·ÙŠÙ†
    loadActiveUsers();
}

function sendWebSocketMessage(data) {
    if (ChatManager.socket && ChatManager.socket.readyState === WebSocket.OPEN) {
        ChatManager.socket.send(JSON.stringify(data));
    } else {
        console.error('WebSocket ØºÙŠØ± Ù…ØªØµÙ„');
    }
}

function openRoomFromWidget(roomId) {
    // ÙØªØ­ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„ØµØºÙŠØ±Ø© Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„ØµÙØ­Ø©
    openMiniChatForRoom(roomId);

    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„ÙƒØ¨ÙŠØ±Ø©
    closeChatWidget();
}

function loadActiveUsers() {
    fetch('/modern-chat/api/active-users/')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('ğŸ“Š Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©:', data);

            const users = data.users || [];
            updateActiveUsersWidget(users);

            // Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ù…ØªØµÙ„ÙŠÙ† Ø§Ù„ÙØ¹Ù„ÙŠ Ø¨Ø¯Ù‚Ø©
            const onlineCount = users.filter(user => {
                const now = new Date();
                const lastSeen = user.last_seen ? new Date(user.last_seen) : null;
                const timeDiff = lastSeen ? (now - lastSeen) / 1000 / 60 : Infinity;
                return (user.status === 'online' || user.status === 'away' || user.status === 'busy') && timeDiff <= 3;
            }).length;

            console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${users.length} Ù…Ø³ØªØ®Ø¯Ù…ØŒ Ù…Ù†Ù‡Ù… ${onlineCount} Ù…ØªØµÙ„ ÙØ¹Ù„ÙŠØ§Ù‹`);

            // ØªØ­Ø¯ÙŠØ« Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ù„ÙŠØ¸Ù‡Ø± Ø¹Ø¯Ø¯ Ø§Ù„Ù…ØªØµÙ„ÙŠÙ†
            const activeUsersTab = document.querySelector('.nav-link[onclick*="activeUsers"]');
            if (activeUsersTab) {
                const baseText = 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†';
                if (onlineCount > 0) {
                    activeUsersTab.innerHTML = `${baseText} <span class="badge bg-success ms-1">${onlineCount}</span>`;
                } else {
                    activeUsersTab.innerHTML = baseText;
                }
            }

            // ØªØ­Ø¯ÙŠØ« Ø´Ø§Ø±Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
            const badge = document.getElementById('chatNotificationBadge');
            if (badge && onlineCount > 0) {
                badge.textContent = onlineCount;
                badge.style.display = 'flex';
            } else if (badge) {
                badge.style.display = 'none';
            }
        })
        .catch(error => {
            console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù†Ø´Ø·ÙŠÙ†:', error);
            const container = document.getElementById('activeUsersWidget');
            if (container) {
                container.innerHTML = `
                    <div class="text-center p-3">
                        <i class="fas fa-exclamation-triangle text-warning"></i>
                        <p class="text-muted mt-2 mb-0">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„: ${error.message}</p>
                        <button class="btn btn-sm btn-outline-primary mt-2" onclick="loadActiveUsers()">
                            <i class="fas fa-redo"></i> Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
                        </button>
                    </div>
                `;
            }
        });
}

function updateActiveUsersWidget(users) {
    const container = document.getElementById('activeUsersWidget');

    if (!container) {
        console.error('Ø¹Ù†ØµØ± activeUsersWidget ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
        return;
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    if (!users || !Array.isArray(users) || users.length === 0) {
        container.innerHTML = `
            <div class="text-center p-3">
                <i class="fas fa-user-slash text-muted" style="font-size: 32px;"></i>
                <p class="text-muted mt-2 mb-0">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†</p>
                <small class="text-muted">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ${new Date().toLocaleTimeString('ar-EG')}</small>
            </div>
        `;
        return;
    }

    // ØªØµÙ†ÙŠÙ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©
    const onlineUsers = [];
    const offlineUsers = [];

    users.forEach(user => {
        // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ÙØ¹Ù„ÙŠØ© Ø¨Ø¯Ù‚Ø©
        const now = new Date();
        const lastSeen = user.last_seen ? new Date(user.last_seen) : null;
        const timeDiff = lastSeen ? (now - lastSeen) / 1000 / 60 : Infinity; // Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚

        // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ØªØµÙ„ Ø¥Ø°Ø§:
        // 1. Ø­Ø§Ù„ØªÙ‡ online/away/busy
        // 2. Ø¢Ø®Ø± Ø¸Ù‡ÙˆØ± Ù„Ù‡ Ø®Ù„Ø§Ù„ Ø¢Ø®Ø± 3 Ø¯Ù‚Ø§Ø¦Ù‚
        const isReallyOnline = (user.status === 'online' || user.status === 'away' || user.status === 'busy') &&
                              timeDiff <= 3;

        if (isReallyOnline) {
            onlineUsers.push({...user, isOnline: true});
        } else {
            offlineUsers.push({...user, isOnline: false});
        }
    });

    // ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: Ø§Ù„Ù…ØªØµÙ„ÙŠÙ† Ø£ÙˆÙ„Ø§Ù‹ØŒ Ø«Ù… ØºÙŠØ± Ø§Ù„Ù…ØªØµÙ„ÙŠÙ†
    const sortedUsers = [...onlineUsers, ...offlineUsers];

    if (sortedUsers.length === 0) {
        container.innerHTML = `
            <div class="text-center p-3">
                <i class="fas fa-user-clock text-muted" style="font-size: 32px;"></i>
                <p class="text-muted mt-2 mb-0">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†</p>
                <small class="text-muted">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ${new Date().toLocaleTimeString('ar-EG')}</small>
            </div>
        `;
        return;
    }

    container.innerHTML = sortedUsers.map(user => {
        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
        const userName = user.name || user.username || 'Ù…Ø³ØªØ®Ø¯Ù…';
        const userId = user.id || 0;
        const isOnline = user.isOnline;

        // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†Øµ ÙˆØ§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ÙØ¹Ù„ÙŠØ©
        let statusText, statusColor, statusIcon;
        if (isOnline) {
            statusText = 'Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù†';
            statusColor = '#28a745'; // Ø£Ø®Ø¶Ø±
            statusIcon = 'fas fa-circle';
        } else {
            const lastSeen = user.last_seen ? new Date(user.last_seen) : null;
            if (lastSeen) {
                const timeDiff = (new Date() - lastSeen) / 1000 / 60; // Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚
                if (timeDiff < 60) {
                    statusText = `Ø¢Ø®Ø± Ø¸Ù‡ÙˆØ± Ù…Ù†Ø° ${Math.round(timeDiff)} Ø¯Ù‚ÙŠÙ‚Ø©`;
                } else if (timeDiff < 1440) {
                    statusText = `Ø¢Ø®Ø± Ø¸Ù‡ÙˆØ± Ù…Ù†Ø° ${Math.round(timeDiff / 60)} Ø³Ø§Ø¹Ø©`;
                } else {
                    statusText = `Ø¢Ø®Ø± Ø¸Ù‡ÙˆØ± Ù…Ù†Ø° ${Math.round(timeDiff / 1440)} ÙŠÙˆÙ…`;
                }
            } else {
                statusText = 'ØºÙŠØ± Ù…ØªØµÙ„';
            }
            statusColor = '#6c757d'; // Ø±Ù…Ø§Ø¯ÙŠ
            statusIcon = 'fas fa-circle';
        }

        return `
            <div class="user-item-widget ${isOnline ? 'user-online' : 'user-offline'}"
                 onclick="showUserContextMenu(event, ${userId}, '${userName}', '${user.username || userName}', ${isOnline})"
                 oncontextmenu="showUserContextMenu(event, ${userId}, '${userName}', '${user.username || userName}', ${isOnline})"
                 style="opacity: ${isOnline ? '1' : '0.7'}; cursor: pointer;">
                <div class="d-flex align-items-center">
                    <div class="user-avatar-small position-relative">
                        ${userName.charAt(0).toUpperCase()}
                        <span class="position-absolute bottom-0 end-0 translate-middle-x"
                              style="width: 12px; height: 12px; background: ${statusColor}; border: 2px solid white; border-radius: 50%;"></span>
                    </div>
                    <div class="ms-2 flex-grow-1">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="mb-0" style="font-size: 14px; color: ${isOnline ? '#000' : '#6c757d'};">${userName}</h6>
                            <i class="${statusIcon}" style="color: ${statusColor}; font-size: 8px;"></i>
                        </div>
                        <small style="color: ${statusColor}; font-size: 11px;">
                            <i class="fas fa-circle" style="font-size: 6px; margin-left: 4px;"></i>
                            ${statusText}
                        </small>
                    </div>
                </div>
            </div>
        `;
    }).join('');

    // Ø¥Ø¶Ø§ÙØ© Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙÙŠ Ø£Ø³ÙÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    const onlineCount = sortedUsers.filter(user => user.isOnline).length;
    const offlineCount = sortedUsers.length - onlineCount;

    container.innerHTML += `
        <div class="users-stats mt-2 p-2 border-top" style="background: #f8f9fa; font-size: 11px;">
            <div class="d-flex justify-content-between text-muted">
                <span><i class="fas fa-circle text-success" style="font-size: 6px;"></i> Ù…ØªØµÙ„: ${onlineCount}</span>
                <span><i class="fas fa-circle text-secondary" style="font-size: 6px;"></i> ØºÙŠØ± Ù…ØªØµÙ„: ${offlineCount}</span>
            </div>
            <div class="text-center mt-1">
                <small class="text-muted">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ${new Date().toLocaleTimeString('ar-EG')}</small>
            </div>
        </div>
    `;

    console.log(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: ${onlineCount} Ù…ØªØµÙ„ØŒ ${offlineCount} ØºÙŠØ± Ù…ØªØµÙ„`);
}

function startPrivateChatFromWidget(userId) {
    console.log('ÙØªØ­ Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', userId);

    // Ø¥ØºÙ„Ø§Ù‚ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª
    closeChatWidget();

    // Ø¥Ù†Ø´Ø§Ø¡/Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ØºØ±ÙØ© Ù…Ø¨Ø§Ø´Ø±Ø©
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
                     document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');

    fetch(`/modern-chat/private/${userId}/`, {
        method: 'GET',
        headers: {
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            throw new Error(data.error);
        }

        const roomId = data.room_id;
        console.log('ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ØºØ±ÙØ©:', roomId);

        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        return fetch(`/modern-chat/api/user-info/${userId}/`)
            .then(response => response.json())
            .then(userInfo => {
                console.log('Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', userInfo);
                ChatManager.openChat(roomId, userInfo);
            })
            .catch(error => {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', error);
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
                ChatManager.openChat(roomId, {
                    id: userId,
                    name: `Ù…Ø³ØªØ®Ø¯Ù… ${userId}`
                });
            });
    })
    .catch(error => {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡/Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ØºØ±ÙØ©:', error);
        alert('Ø®Ø·Ø£ ÙÙŠ ÙØªØ­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©: ' + error.message);
    });
}

async function createOrFindPrivateRoom(userId) {
    try {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
                         document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');

        const response = await fetch(`/modern-chat/private/${userId}/`, {
            method: 'GET',
            headers: {
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            }
        });

        const data = await response.json();

        if (data.error) {
            throw new Error(data.error);
        }

        return data.room_id;
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡/Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ØºØ±ÙØ©:', error);
        return null;
    }
}

// Ø¯ÙˆØ§Ù„ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„ØµØºÙŠØ±Ø©
let currentChatUserId = null;
let currentChatRoomId = null;

function openMiniChat(userId) {
    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„ÙƒØ¨ÙŠØ±Ø©
    closeChatWidget();

    currentChatUserId = userId;

    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„ØµØºÙŠØ±Ø©
    const miniWindow = document.getElementById('miniChatWindow');
    miniWindow.style.display = 'flex';

    // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    loadUserDataForMiniChat(userId);

    // Ø¥Ù†Ø´Ø§Ø¡ Ø£Ùˆ Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØºØ±ÙØ© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
    createOrFindPrivateRoom(userId);
}

function createOrFindPrivateRoom(userId) {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
                     document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');

    fetch(`/modern-chat/private/${userId}/`, {
        method: 'GET',
        headers: {
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            throw new Error(data.error);
        }

        if (data.room_id) {
            currentChatRoomId = data.room_id;

            // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ù†Ø§ÙØ°Ø©
            if (data.other_user) {
                document.getElementById('miniChatUserInitial').textContent =
                    data.other_user.name.charAt(0).toUpperCase();
                document.getElementById('miniChatUserName').textContent = data.other_user.name;
                document.getElementById('miniChatUserStatus').textContent = 'Ù…ØªØµÙ„';
            }

            loadMiniChatMessages(data.room_id);
            startMessagePolling();
        }
    })
    .catch(error => {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ©:', error);
        alert('Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©: ' + error.message);
    });
}

function loadUserDataForMiniChat(userId) {
    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† API
    fetch(`/modern-chat/api/user-info/${userId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', data.error);
                return;
            }

            // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„ØµØºÙŠØ±Ø©
            document.getElementById('miniChatUserInitial').textContent =
                data.name.charAt(0).toUpperCase();
            document.getElementById('miniChatUserName').textContent = data.name;

            // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            const statusText = {
                'online': 'Ù…ØªØµÙ„',
                'away': 'ØºØ§Ø¦Ø¨',
                'busy': 'Ù…Ø´ØºÙˆÙ„',
                'offline': 'ØºÙŠØ± Ù…ØªØµÙ„'
            };
            document.getElementById('miniChatUserStatus').textContent =
                statusText[data.status] || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';


        })
        .catch(error => {
            console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', error);
            // Ù‚ÙŠÙ… Ø§ÙØªØ±Ø§Ø¶ÙŠØ© ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
            document.getElementById('miniChatUserInitial').textContent = 'U';
            document.getElementById('miniChatUserName').textContent = 'Ù…Ø³ØªØ®Ø¯Ù…';
            document.getElementById('miniChatUserStatus').textContent = 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
        });
}

function loadMiniChatMessages(roomId) {
    if (!roomId) return;

    fetch(`/modern-chat/api/messages/${roomId}/`)
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('miniChatMessages');
            container.innerHTML = '';

            if (data.messages && data.messages.length > 0) {
                data.messages.forEach(message => {
                    addMiniChatMessage(message.content, message.sender.is_current_user, message.created_at);
                });
                // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹!
                lastMessageCount = data.messages.length;
                console.log('ØªÙ… ØªØ­Ø¯ÙŠØ« lastMessageCount Ø¥Ù„Ù‰:', lastMessageCount);
            } else {
                container.innerHTML = `
                    <div class="text-center text-muted p-3">
                        <i class="fas fa-comments fa-2x mb-2"></i>
                        <p class="mb-0">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</p>
                    </div>
                `;
                lastMessageCount = 0;
            }

            // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙƒÙ…Ù‚Ø±ÙˆØ¡Ø© Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ù†Ø§ÙØ°Ø©
            markMessagesAsRead(roomId);
        })
        .catch(error => {
            console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„:', error);
        });
}

function sendMiniChatMessage() {
    const input = document.getElementById('miniChatInput');
    const message = input.value.trim();

    if (!message || !currentChatRoomId || input.disabled) return;

    // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¤Ù‚ØªØ§Ù‹
    input.disabled = true;

    // Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø¨Ø± WebSocket Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªØµÙ„Ø§Ù‹
    if (ChatManager.isConnected) {
        sendWebSocketMessage({
            type: 'send_message',
            room_id: currentChatRoomId,
            content: message
        });

        // Ù„Ø§ Ù†Ø¶ÙŠÙ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙÙˆØ±Ø§Ù‹ - Ù†Ù†ØªØ¸Ø± ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø®Ø§Ø¯Ù… Ø¹Ø¨Ø± WebSocket
        // addMiniChatMessage(message, true); // ØªÙ… ØªØ¹Ø·ÙŠÙ„Ù‡ Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø±
        input.value = '';

        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù†Ø§ÙØ°Ø© Ù…ÙØªÙˆØ­Ø©
        const miniWindow = document.getElementById('miniChatWindow');
        if (miniWindow.style.display !== 'flex') {
            miniWindow.style.display = 'flex';
            console.log('ØªÙ… ÙØªØ­ Ø§Ù„Ù†Ø§ÙØ°Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©');
        }

        // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
        lastMessageCount++;

        input.disabled = false;
        input.focus();
    } else {
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… HTTP ÙƒØ¨Ø¯ÙŠÙ„
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
                         document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');

        fetch('/modern-chat/api/send-message/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                room_id: currentChatRoomId,
                content: message
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }

            // Ù„Ø§ Ù†Ø¶ÙŠÙ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù‡Ù†Ø§ - Ù†Ù†ØªØ¸Ø± ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø®Ø§Ø¯Ù… Ø¹Ø¨Ø± WebSocket
            // addMiniChatMessage(message, true); // ØªÙ… ØªØ¹Ø·ÙŠÙ„Ù‡ Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø±
            input.value = '';

            // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù†Ø§ÙØ°Ø© Ù…ÙØªÙˆØ­Ø©
            const miniWindow = document.getElementById('miniChatWindow');
            if (miniWindow.style.display !== 'flex') {
                miniWindow.style.display = 'flex';
                console.log('ØªÙ… ÙØªØ­ Ø§Ù„Ù†Ø§ÙØ°Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©');
            }

            // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
            lastMessageCount++;
            console.log('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¹Ø¨Ø± HTTP');
        })
        .catch(error => {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©:', error);
            alert('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©: ' + error.message);
        })
        .finally(() => {
            input.disabled = false;
            input.focus();
        });
    }
}

function addMiniChatMessage(content, isOwn = false, timestamp = null) {
    const container = document.getElementById('miniChatMessages');

    // ÙØ­Øµ Ø§Ù„ØªÙƒØ±Ø§Ø± Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙØ©
    const existingMessages = container.querySelectorAll('.message');
    for (let msg of existingMessages) {
        const msgContent = msg.querySelector('.message-content');
        if (msgContent && msgContent.textContent.trim() === content.trim()) {
            // ÙØ­Øµ Ø¥Ø¶Ø§ÙÙŠ Ù„Ù„ÙˆÙ‚Øª Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªØ§Ø­Ø§Ù‹
            const msgTime = msg.querySelector('.message-time');
            if (msgTime && timestamp) {
                const existingTime = new Date(msgTime.getAttribute('data-timestamp') || msgTime.textContent);
                const newTime = new Date(timestamp);
                const timeDiff = Math.abs(existingTime - newTime);

                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙØ±Ù‚ Ø£Ù‚Ù„ Ù…Ù† 10 Ø«ÙˆØ§Ù†ØŒ Ø§Ø¹ØªØ¨Ø±Ù‡Ø§ Ù†ÙØ³ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
                if (timeDiff < 10000) {
                    console.log('Ø±Ø³Ø§Ù„Ø© Ù…ÙƒØ±Ø±Ø© ØªÙ… ØªØ¬Ø§Ù‡Ù„Ù‡Ø§:', content);
                    return;
                }
            } else if (!timestamp) {
                // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ ÙˆÙ‚ØªØŒ Ø§Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙÙ‚Ø·
                console.log('Ø±Ø³Ø§Ù„Ø© Ù…ÙƒØ±Ø±Ø© ØªÙ… ØªØ¬Ø§Ù‡Ù„Ù‡Ø§ (Ø¨Ø¯ÙˆÙ† ÙˆÙ‚Øª):', content);
                return;
            }
        }
    }

    // Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© "Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©" Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
    const emptyMessage = container.querySelector('.text-center');
    if (emptyMessage) {
        emptyMessage.remove();
    }

    const messageElement = document.createElement('div');
    messageElement.className = `mini-message ${isOwn ? 'own' : ''}`;

    // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø±Ù ÙØ±ÙŠØ¯ Ù„Ù„Ø±Ø³Ø§Ù„Ø©
    const messageId = 'mini_msg_' + Date.now() + '_' + Math.random();
    messageElement.setAttribute('data-message-id', messageId);

    let time;
    if (timestamp) {
        time = new Date(timestamp).toLocaleTimeString('ar-EG', {
            hour: '2-digit',
            minute: '2-digit'
        });
    } else {
        time = new Date().toLocaleTimeString('ar-EG', {
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    messageElement.innerHTML = `
        <div class="mini-message-content message-content">
            ${content}
            <div class="mini-message-time message-time" data-timestamp="${timestamp || new Date().toISOString()}">${time}</div>
        </div>
    `;

    container.appendChild(messageElement);
    container.scrollTop = container.scrollHeight;

    // Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ± Ø¨ØµØ±ÙŠ Ù„Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    if (!timestamp) { // Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©
        messageElement.style.opacity = '0';
        messageElement.style.transform = 'translateY(10px)';
        setTimeout(() => {
            messageElement.style.transition = 'all 0.3s ease';
            messageElement.style.opacity = '1';
            messageElement.style.transform = 'translateY(0)';
        }, 10);
    }
}

let typingTimer = null;
let isTyping = false;

function handleMiniChatEnter(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMiniChatMessage();
        stopTyping();
    }
}

function handleTyping() {
    if (!ChatManager.isConnected || !currentChatRoomId) {
        return;
    }

    // Ø¥Ø±Ø³Ø§Ù„ Ù…Ø¤Ø´Ø± Ø¨Ø¯Ø¡ Ø§Ù„ÙƒØªØ§Ø¨Ø©
    if (!isTyping) {
        isTyping = true;
        sendWebSocketMessage({
            type: 'typing_start',
            room_id: currentChatRoomId
        });
    }

    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª
    clearTimeout(typingTimer);
    typingTimer = setTimeout(() => {
        stopTyping();
    }, 2000); // ØªÙˆÙ‚Ù Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØªÙŠÙ† Ù…Ù† Ø¹Ø¯Ù… Ø§Ù„Ù†Ø´Ø§Ø·
}

function stopTyping() {
    if (isTyping && ChatManager.isConnected && currentChatRoomId) {
        isTyping = false;
        sendWebSocketMessage({
            type: 'typing_stop',
            room_id: currentChatRoomId
        });
    }

    clearTimeout(typingTimer);
}

function minimizeMiniChat() {
    const miniWindow = document.getElementById('miniChatWindow');
    miniWindow.style.display = 'none';
    // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø­Ø§Ù„Ø© Ù…ØµØºØ±Ø© Ù‡Ù†Ø§
}

let messagePollingInterval = null;
let lastMessageCount = 0;

function startMessagePolling() {
    // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø§Ø¨Ù‚ Ø¥Ù† ÙˆØ¬Ø¯
    if (messagePollingInterval) {
        clearInterval(messagePollingInterval);
    }

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙƒÙ„ 5 Ø«ÙˆØ§Ù† ÙÙ‚Ø· Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ù†Ø§ÙØ°Ø©
    messagePollingInterval = setInterval(() => {
        if (currentChatRoomId && document.getElementById('miniChatWindow').style.display === 'flex') {
            checkForNewMessages();
        }
    }, 5000);
}

let isCheckingMessages = false;

function checkForNewMessages() {
    if (!currentChatRoomId || isCheckingMessages) return;

    isCheckingMessages = true;

    fetch(`/modern-chat/api/messages/${currentChatRoomId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.messages && data.messages.length > lastMessageCount) {
                console.log(`Ø±Ø³Ø§Ø¦Ù„ Ø¬Ø¯ÙŠØ¯Ø©: ${data.messages.length - lastMessageCount}`);

                // Ù‡Ù†Ø§Ùƒ Ø±Ø³Ø§Ø¦Ù„ Ø¬Ø¯ÙŠØ¯Ø©
                const newMessages = data.messages.slice(lastMessageCount);
                let hasNewMessagesFromOthers = false;

                newMessages.forEach(message => {
                    if (!message.sender.is_current_user) {
                        // Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ù…Ø³ØªØ®Ø¯Ù… Ø¢Ø®Ø±
                        addMiniChatMessage(message.content, false, message.created_at);
                        showNewMessageNotification(message);
                        hasNewMessagesFromOthers = true;
                        console.log('Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù†:', message.sender.name);
                    } else {
                        console.log('Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠØŒ ØªÙ… ØªØ¬Ø§Ù‡Ù„Ù‡Ø§');
                    }
                });

                lastMessageCount = data.messages.length;

                // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙƒÙ…Ù‚Ø±ÙˆØ¡Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù†Ø§ÙØ°Ø© Ù…ÙØªÙˆØ­Ø©
                if (hasNewMessagesFromOthers &&
                    document.getElementById('miniChatWindow').style.display === 'flex') {
                    markMessagesAsRead(currentChatRoomId);
                }
            }
        })
        .catch(error => {
            console.error('Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:', error);
        })
        .finally(() => {
            isCheckingMessages = false;
        });
}

function showNewMessageNotification(message) {
    // Ù„Ø§ Ù†Ø´ØºÙ„ Ø§Ù„ØµÙˆØª Ù‡Ù†Ø§ - ÙŠØªÙ… ØªØ´ØºÙŠÙ„Ù‡ ÙÙŠ ChatManager.handleIncomingMessage
    // playNotificationSound(); // ØªÙ… ØªØ¹Ø·ÙŠÙ„Ù‡ Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø±

    // Ø¥Ø¸Ù‡Ø§Ø± Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    const notification = document.createElement('div');
    notification.className = 'new-message-notification';
    notification.innerHTML = `
        <i class="fas fa-comment"></i>
        Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† ${message.sender.name}
    `;

    // Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ø§Ù„Ù†Ù‚Ø± Ù„ÙØªØ­ Ø§Ù„Ù†Ø§ÙØ°Ø© ÙˆØ¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
    notification.onclick = () => {
        // ÙØªØ­ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙØªÙˆØ­Ø©
        const miniWindow = document.getElementById('miniChatWindow');
        if (miniWindow.style.display !== 'flex') {
            openMiniChatForRoom(currentChatRoomId);
        }
        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
        notification.remove();
        // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙƒÙ…Ù‚Ø±ÙˆØ¡Ø©
        markMessagesAsRead(currentChatRoomId);
    };

    document.body.appendChild(notification);

    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);

    // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
    updateNotificationBadge();

    // ÙØªØ­ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„ØµØºÙŠØ±Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙØªÙˆØ­Ø©
    const miniWindow = document.getElementById('miniChatWindow');
    if (miniWindow.style.display !== 'flex') {
        console.log('ÙØªØ­ Ø§Ù„Ù†Ø§ÙØ°Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù„Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©');
        openMiniChatForRoom(currentChatRoomId);
    }
}

function updateNotificationBadge() {
    const badge = document.getElementById('chatNotificationBadge');
    if (badge) {
        badge.style.display = 'flex';
        badge.textContent = '!';
    }
}

function closeMiniChat() {
    const miniWindow = document.getElementById('miniChatWindow');
    miniWindow.style.display = 'none';

    // Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØºØ±ÙØ© Ø¹Ø¨Ø± WebSocket
    if (ChatManager.isConnected && currentChatRoomId) {
        sendWebSocketMessage({
            type: 'leave_room',
            room_id: currentChatRoomId
        });
    }

    // Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ø´Ø± Ø§Ù„ÙƒØªØ§Ø¨Ø©
    stopTyping();

    // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯ÙˆØ±ÙŠ
    if (messagePollingInterval) {
        clearInterval(messagePollingInterval);
        messagePollingInterval = null;
    }

    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
    currentChatUserId = null;
    currentChatRoomId = null;
    lastMessageCount = 0;
}

function toggleChatMute() {
    if (!currentChatRoomId) return;

    const muteButton = document.getElementById('muteChatButton');
    const icon = muteButton.querySelector('i');

    if (ChatManager.mutedChats.has(currentChatRoomId)) {
        // Ø¥Ù„ØºØ§Ø¡ ÙƒØªÙ… Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
        ChatManager.mutedChats.delete(currentChatRoomId);
        icon.className = 'fas fa-volume-up';
        muteButton.title = 'ÙƒØªÙ… Ø§Ù„ØµÙˆØª';

        // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø©
        showToast('ØªÙ… Ø¥Ù„ØºØ§Ø¡ ÙƒØªÙ… Ø§Ù„ØµÙˆØª Ù„Ù„Ù…Ø­Ø§Ø¯Ø«Ø©', 'success');
    } else {
        // ÙƒØªÙ… Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
        ChatManager.mutedChats.add(currentChatRoomId);
        icon.className = 'fas fa-volume-mute';
        muteButton.title = 'Ø¥Ù„ØºØ§Ø¡ ÙƒØªÙ… Ø§Ù„ØµÙˆØª';

        // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø©
        showToast('ØªÙ… ÙƒØªÙ… Ø§Ù„ØµÙˆØª Ù„Ù„Ù…Ø­Ø§Ø¯Ø«Ø©', 'info');
    }

    // Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙÙŠ localStorage
    localStorage.setItem('mutedChats', JSON.stringify([...ChatManager.mutedChats]));
    // Ø­ÙØ¸ ÙÙŠ chatSettings Ø£ÙŠØ¶Ø§Ù‹
    const settings = JSON.parse(localStorage.getItem('chatSettings') || '{}');
    settings.mutedChats = [...ChatManager.mutedChats];
    localStorage.setItem('chatSettings', JSON.stringify(settings));
}

function loadMuteSettings() {
    // ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙƒØªÙ… Ù…Ù† localStorage
    const saved = localStorage.getItem('mutedChats');
    if (saved) {
        try {
            const mutedArray = JSON.parse(saved);
            if (ChatManager && ChatManager.mutedChats) {
                ChatManager.mutedChats = new Set(mutedArray);
            }
        } catch (e) {
            console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙƒØªÙ…:', e);
            if (ChatManager && ChatManager.mutedChats) {
                ChatManager.mutedChats = new Set();
            }
        }
    }
}

function updateMuteButtonState() {
    if (!currentChatRoomId) return;

    const muteButton = document.getElementById('muteChatButton');
    if (!muteButton) return;

    const icon = muteButton.querySelector('i');

    if (ChatManager.mutedChats.has(currentChatRoomId)) {
        icon.className = 'fas fa-volume-mute';
        muteButton.title = 'Ø¥Ù„ØºØ§Ø¡ ÙƒØªÙ… Ø§Ù„ØµÙˆØª';
    } else {
        icon.className = 'fas fa-volume-up';
        muteButton.title = 'ÙƒØªÙ… Ø§Ù„ØµÙˆØª';
    }
}

function showToast(message, type = 'info') {
    // Ø¥Ù†Ø´Ø§Ø¡ toast notification Ø¨Ø³ÙŠØ·
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} position-fixed`;
    toast.style.cssText = `
        top: 20px;
        right: 20px;
        z-index: 9999;
        min-width: 250px;
        animation: slideInRight 0.3s ease;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    `;
    toast.textContent = message;

    document.body.appendChild(toast);

    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙˆØ³Øª Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†
    setTimeout(() => {
        toast.style.animation = 'slideOutRight 0.3s ease';
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 300);
    }, 3000);
}

// ØªÙ… Ù†Ù‚Ù„ Ø¬Ù…ÙŠØ¹ ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØµÙˆØª Ø¥Ù„Ù‰ ChatManager

// ØªÙ… Ù†Ù‚Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø¥Ù„Ù‰ ChatManager.playNotificationSound

// ØªÙ… Ù†Ù‚Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø¥Ù„Ù‰ ChatManager.createFallbackAudio

function markMessagesAsRead(roomId) {
    if (!roomId) return;

    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
                     document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');

    fetch(`/modern-chat/api/mark-read/${roomId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // Ø¥Ø®ÙØ§Ø¡ Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙÙˆØ±Ø§Ù‹
            hideChatNotificationBadge();

            // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¹Ø¨Ø± WebSocket Ø£Ù† Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ØªÙ… Ù‚Ø±Ø§Ø¡ØªÙ‡Ø§
            if (ChatManager.isConnected && ChatManager.socket) {
                ChatManager.socket.send(JSON.stringify({
                    type: 'messages_read',
                    room_id: roomId
                }));
            }
        }
    })
    .catch(error => {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙƒÙ…Ù‚Ø±ÙˆØ¡Ø©:', error);
    });
}

function openMiniChatForRoom(roomId, senderInfo = null) {
    if (!roomId) return;

    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„ØµØºÙŠØ±Ø© Ø¨Ù‚ÙˆØ©
    const miniWindow = document.getElementById('miniChatWindow');
    if (!miniWindow) {
        console.error('âŒ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ù…ØµØºØ±Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©!');
        return;
    }

    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†Ø§ÙØ°Ø© Ø¨Ù‚ÙˆØ© Ù…Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®ØµØ§Ø¦Øµ
    miniWindow.style.display = 'flex';
    miniWindow.style.visibility = 'visible';
    miniWindow.style.opacity = '1';
    miniWindow.style.zIndex = '1055';

    // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ø±Ù Ø§Ù„ØºØ±ÙØ©
    currentChatRoomId = roomId;

    // Ø¥Ø®ÙØ§Ø¡ Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙÙˆØ±Ø§Ù‹
    hideChatNotificationBadge();

    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø²Ø± Ø§Ù„ÙƒØªÙ…
    updateMuteButtonState();

    // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø±Ø³Ù„ Ù…ØªÙˆÙØ±Ø©ØŒ Ø§Ø³ØªØ®Ø¯Ù…Ù‡Ø§
    if (senderInfo) {
        document.getElementById('miniChatUserInitial').textContent =
            senderInfo.name ? senderInfo.name.charAt(0).toUpperCase() : '?';
        document.getElementById('miniChatUserName').textContent =
            senderInfo.name || 'Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
        document.getElementById('miniChatUserStatus').textContent = 'Ù…ØªØµÙ„';

        // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
        currentChatUserId = senderInfo.id;
    } else {
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØºØ±ÙØ© Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…
        fetch(`/modern-chat/api/room-info/${roomId}/`)
            .then(response => response.json())
            .then(data => {
                if (data.other_user) {
                    document.getElementById('miniChatUserInitial').textContent =
                        data.other_user.name.charAt(0).toUpperCase();
                    document.getElementById('miniChatUserName').textContent = data.other_user.name;
                    document.getElementById('miniChatUserStatus').textContent = 'Ù…ØªØµÙ„';
                    currentChatUserId = data.other_user.id;
                }
            })
            .catch(error => {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØºØ±ÙØ©:', error);
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‚ÙŠÙ… Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
                document.getElementById('miniChatUserInitial').textContent = '?';
                document.getElementById('miniChatUserName').textContent = 'Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                document.getElementById('miniChatUserStatus').textContent = 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                currentChatUserId = null; // ØªØ£ÙƒÙŠØ¯ Ø£Ù†Ù‡ null
            });
    }

    // Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„ØºØ±ÙØ© Ø¹Ø¨Ø± WebSocket
    if (ChatManager.isConnected) {
        sendWebSocketMessage({
            type: 'join_room',
            room_id: roomId
        });
    }

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
    loadMiniChatMessages(roomId);

    // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯ÙˆØ±ÙŠ (ÙƒÙ†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©)
    startMessagePolling();

    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙƒÙ…Ù‚Ø±ÙˆØ¡Ø©
    if (ChatManager.isConnected) {
        sendWebSocketMessage({
            type: 'mark_read',
            room_id: roomId
        });
    }
}

function openFullChatFromMini() {
    // Ù„Ø§ Ù†Ø­ØªØ§Ø¬ Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø¢Ù† - ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„ÙƒØ¨ÙŠØ±Ø©
    alert('ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„ÙƒØ¨ÙŠØ±Ø©. Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„ØµØºÙŠØ±Ø© ÙÙ‚Ø·.');
}

// Ù…ØªØºÙŠØ±Ø§Øª Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙŠØ§Ù‚
let contextMenuUserId = null;
let contextMenuUserName = '';
let contextMenuUsername = '';
let contextMenuRoomId = null;

// Ù…ØªØºÙŠØ±Ø§Øª ÙƒØªÙ… Ø§Ù„ØµÙˆØª (ØªÙ… Ù†Ù‚Ù„Ù‡Ø§ Ø¥Ù„Ù‰ ChatManager)
let isChatMuted = false;

// Ø¯ÙˆØ§Ù„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙŠØ§Ù‚
function showUserContextMenu(event, userId, userName, username, isOnline = false) {
    event.preventDefault();
    event.stopPropagation();

    contextMenuUserId = userId;
    contextMenuUserName = userName;
    contextMenuUsername = username;

    const contextMenu = document.getElementById('userContextMenu');

    // ØªØ­Ø¯ÙŠØ« Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø­Ø³Ø¨ Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
    const chatItem = contextMenu.querySelector('.context-menu-item[onclick="startPrivateChat()"]');
    const profileItem = contextMenu.querySelector('.context-menu-item[onclick="viewUserProfile()"]');

    if (chatItem) {
        if (isOnline) {
            chatItem.style.display = 'block';
            chatItem.innerHTML = `<i class="fas fa-comments me-2 text-success"></i>Ø¨Ø¯Ø¡ Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¹ ${userName}`;
            chatItem.style.color = '#28a745';
        } else {
            chatItem.style.display = 'none';
        }
    }

    if (profileItem) {
        profileItem.style.display = 'block';
        if (isOnline) {
            profileItem.innerHTML = `<i class="fas fa-user me-2 text-primary"></i>Ø¹Ø±Ø¶ Ù…Ù„Ù ${userName} (Ù…ØªØµÙ„)`;
        } else {
            profileItem.innerHTML = `<i class="fas fa-user me-2 text-muted"></i>Ø¹Ø±Ø¶ Ù…Ù„Ù ${userName} (ØºÙŠØ± Ù…ØªØµÙ„)`;
        }
    }

    contextMenu.style.display = 'block';
    contextMenu.style.left = event.pageX + 'px';
    contextMenu.style.top = event.pageY + 'px';

    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± ÙÙŠ Ø£ÙŠ Ù…ÙƒØ§Ù† Ø¢Ø®Ø±
    setTimeout(() => {
        document.addEventListener('click', hideContextMenu);
    }, 10);
}

function hideContextMenu() {
    const contextMenu = document.getElementById('userContextMenu');
    contextMenu.style.display = 'none';
    document.removeEventListener('click', hideContextMenu);
}

function showRoomContextMenu(event, roomId, otherUserId, roomName) {
    event.preventDefault();
    event.stopPropagation();

    // ØªØ­Ø¯ÙŠØ« Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø³ÙŠØ§Ù‚
    contextMenuUserId = otherUserId;
    contextMenuUserName = roomName;
    contextMenuUsername = roomName;
    contextMenuRoomId = roomId;

    const contextMenu = document.getElementById('userContextMenu');

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Øµ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    const deleteItem = contextMenu.querySelector('.context-menu-item[onclick="deleteConversation()"]');
    if (deleteItem) {
        deleteItem.innerHTML = `<i class="fas fa-trash me-2"></i>Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¹ ${roomName}`;
    }

    // Ø¥Ø®ÙØ§Ø¡ Ø®ÙŠØ§Ø±Ø§Øª ØºÙŠØ± Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª
    const profileItem = contextMenu.querySelector('.context-menu-item[onclick="viewUserProfile()"]');
    const chatItem = contextMenu.querySelector('.context-menu-item[onclick="startPrivateChat()"]');

    if (profileItem) profileItem.style.display = 'block';
    if (chatItem) chatItem.style.display = 'none'; // Ø¥Ø®ÙØ§Ø¡ "Ø¨Ø¯Ø¡ Ù…Ø­Ø§Ø¯Ø«Ø©" Ù„Ø£Ù†Ù†Ø§ ÙÙŠ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©

    // ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    const rect = event.target.getBoundingClientRect();
    const menuWidth = 200;
    const menuHeight = 160;

    let left = event.clientX;
    let top = event.clientY;

    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø¯Ù… Ø®Ø±ÙˆØ¬ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù…Ù† Ø§Ù„Ø´Ø§Ø´Ø©
    if (left + menuWidth > window.innerWidth) {
        left = window.innerWidth - menuWidth - 10;
    }

    if (top + menuHeight > window.innerHeight) {
        top = window.innerHeight - menuHeight - 10;
    }

    contextMenu.style.left = left + 'px';
    contextMenu.style.top = top + 'px';
    contextMenu.style.display = 'block';

    // Ø¥Ø¶Ø§ÙØ© listener Ù„Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
    setTimeout(() => {
        document.addEventListener('click', hideContextMenu);
    }, 10);
}

function viewUserProfile() {
    hideContextMenu();
    if (contextMenuUserId) {
        // Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ modal Ù…Ø¨Ø§Ø´Ø±Ø©
        showUserInfoModal(contextMenuUserId, contextMenuUserName, contextMenuUsername);
    }
}

function startPrivateChat() {
    hideContextMenu();
    if (contextMenuUserId) {
        startPrivateChatFromWidget(contextMenuUserId);
    }
}

function showUserInfoModal(userId, userName, username) {
    // Ø¥Ù†Ø´Ø§Ø¡ modal Ù„Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    const modalId = 'userInfoModal';

    // Ø¥Ø²Ø§Ù„Ø© modal Ø§Ù„Ø³Ø§Ø¨Ù‚ Ø¥Ù† ÙˆØ¬Ø¯
    const existingModal = document.getElementById(modalId);
    if (existingModal) {
        existingModal.remove();
    }

    const modal = document.createElement('div');
    modal.id = modalId;
    modal.className = 'modal fade';
    modal.innerHTML = `
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-user me-2"></i>
                        Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center">
                        <div class="user-avatar-large mb-3">
                            ${userName.charAt(0).toUpperCase()}
                        </div>
                        <h4 class="mb-2">${userName}</h4>
                        <p class="text-muted mb-3">@${username}</p>
                        <p class="text-muted mb-4">Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${userId}</p>

                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" onclick="startPrivateChatFromWidget(${userId}); bootstrap.Modal.getInstance(document.getElementById('${modalId}')).hide();">
                                <i class="fas fa-comments me-2"></i>
                                Ø¨Ø¯Ø¡ Ù…Ø­Ø§Ø¯Ø«Ø© Ø®Ø§ØµØ©
                            </button>
                            <button class="btn btn-outline-secondary" onclick="copyUserInfo('${userName}', '${username}', ${userId})">
                                <i class="fas fa-copy me-2"></i>
                                Ù†Ø³Ø® Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;

    document.body.appendChild(modal);

    // Ø¥Ø¶Ø§ÙØ© CSS Ù„Ù„Ù€ avatar Ø§Ù„ÙƒØ¨ÙŠØ±
    if (!document.getElementById('userModalStyles')) {
        const style = document.createElement('style');
        style.id = 'userModalStyles';
        style.textContent = `
            .user-avatar-large {
                width: 80px;
                height: 80px;
                border-radius: 50%;
                background: linear-gradient(135deg, #007bff, #0056b3);
                color: white;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 32px;
                font-weight: bold;
                margin: 0 auto;
                box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            }
        `;
        document.head.appendChild(style);
    }

    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();

    // Ø¥Ø²Ø§Ù„Ø© modal Ø¹Ù†Ø¯ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚
    modal.addEventListener('hidden.bs.modal', () => {
        modal.remove();
    });
}

function copyUserInfo(userName, username, userId) {
    const userInfo = `Ø§Ù„Ø§Ø³Ù…: ${userName}\nØ§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: @${username}\nØ§Ù„Ù…Ø¹Ø±Ù: ${userId}`;

    if (navigator.clipboard) {
        navigator.clipboard.writeText(userInfo).then(() => {
            showToast('ØªÙ… Ù†Ø³Ø® Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', 'success');
        });
    } else {
        // fallback Ù„Ù„Ù…ØªØµÙØ­Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
        const textArea = document.createElement('textarea');
        textArea.value = userInfo;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showToast('ØªÙ… Ù†Ø³Ø® Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', 'success');
    }
}

function deleteConversation() {
    hideContextMenu();

    // Ø§Ø³ØªØ®Ø¯Ø§Ù… room_id Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªØ§Ø­Ø§Ù‹ØŒ ÙˆØ¥Ù„Ø§ Ø§Ø³ØªØ®Ø¯Ù… user_id
    const requestData = contextMenuRoomId ?
        { room_id: contextMenuRoomId } :
        { user_id: contextMenuUserId };

    if (contextMenuUserId || contextMenuRoomId) {
        if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¹ ${contextMenuUserName}ØŸ\n\nØ³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ±Ø¬Ø§Ø¹Ù‡Ø§.`)) {
            // Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
            fetch('/modern-chat/api/delete-conversation/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(requestData)
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            })
            .then(data => {
                if (data.success) {
                    showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');

                    // Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙØªÙˆØ­Ø©
                    const miniWindow = document.getElementById('miniChatWindow');
                    if (miniWindow && miniWindow.style.display !== 'none') {
                        miniWindow.style.display = 'none';
                    }

                    // Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© ChatManager Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙØªÙˆØ­Ø©
                    if (contextMenuRoomId && ChatManager.openChats.has(contextMenuRoomId)) {
                        ChatManager.closeChat(contextMenuRoomId);
                    }

                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… ÙÙˆØ±Ø§Ù‹ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
                    ChatManager.refreshUserListAfterDelete();

                    // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù†Ø´Ø·ÙŠÙ†
                    updateActiveUsersWidget();
                } else {
                    // Ø­ØªÙ‰ Ù„Ùˆ ÙƒØ§Ù† success: falseØŒ Ù‚Ø¯ ØªÙƒÙˆÙ† Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø­Ø°ÙˆÙØ© ÙØ¹Ù„Ø§Ù‹
                    if (data.error && data.error.includes('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¯Ø«Ø©')) {
                        showToast('Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø­Ø°ÙˆÙØ© Ø¨Ø§Ù„ÙØ¹Ù„', 'success');

                        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…
                        ChatManager.refreshUserListAfterDelete();
                        updateUserRoomsWidget();
                        updateActiveUsersWidget();
                    } else {
                        showToast('ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©: ' + (data.error || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'), 'error');
                    }
                }
            })
            .catch(error => {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©:', error);
                showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©', 'error');
            });
        }
    }
}

function blockUser() {
    hideContextMenu();
    if (contextMenuUserId) {
        if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ${contextMenuUserName}ØŸ`)) {
            // Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            fetch('/modern-chat/api/block-user/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    user_id: contextMenuUserId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast(`ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ${contextMenuUserName} Ø¨Ù†Ø¬Ø§Ø­`, 'success');

                    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…
                    updateActiveUsersWidget();
                    updateUserRoomsWidget();
                } else {
                    showToast('ÙØ´Ù„ ÙÙŠ Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ' + (data.error || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'), 'error');
                }
            })
            .catch(error => {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', error);
                showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', 'error');
            });
        }
    }
}

function getStatusText(status) {
    const statusMap = {
        'online': 'Ù…ØªØµÙ„',
        'away': 'ØºØ§Ø¦Ø¨',
        'busy': 'Ù…Ø´ØºÙˆÙ„',
        'offline': 'ØºÙŠØ± Ù…ØªØµÙ„'
    };
    return statusMap[status] || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
}

function showToast(message, type = 'info') {
    // Ø¥Ù†Ø´Ø§Ø¡ toast container Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
    let toastContainer = document.getElementById('toastContainer');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toastContainer';
        toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
        toastContainer.style.zIndex = '9999';
        document.body.appendChild(toastContainer);
    }

    // Ø¥Ù†Ø´Ø§Ø¡ toast
    const toastId = 'toast_' + Date.now();
    const toast = document.createElement('div');
    toast.id = toastId;
    toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'primary'} border-0`;
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;

    toastContainer.appendChild(toast);

    // Ø¥Ø¸Ù‡Ø§Ø± toast
    const bsToast = new bootstrap.Toast(toast, {
        autohide: true,
        delay: type === 'error' ? 5000 : 3000
    });
    bsToast.show();

    // Ø¥Ø²Ø§Ù„Ø© toast Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø®ÙØ§Ø¡
    toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø© ÙÙ‚Ø·
let lastActiveUsersUpdate = 0;
setInterval(function() {
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù†Ø´Ø·ÙŠÙ† ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù†Ø§ÙØ°Ø© Ù…ÙØªÙˆØ­Ø© ÙˆÙ…Ø±Øª 3 Ø¯Ù‚Ø§Ø¦Ù‚ Ø¹Ù„Ù‰ Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«
    if (chatWidgetVisible && !chatWidgetMinimized &&
        (Date.now() - lastActiveUsersUpdate) > 180000) {
        loadActiveUsers();
        lastActiveUsersUpdate = Date.now();
    }
}, 60000);

// ÙØ­Øµ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
let globalMessageCheckInterval = null;

function startGlobalMessageCheck() {
    if (globalMessageCheckInterval) {
        clearInterval(globalMessageCheckInterval);
    }

    globalMessageCheckInterval = setInterval(() => {
        checkForNewMessagesGlobal();
    }, 30000); // ÙØ­Øµ ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©
}

let isCheckingGlobalMessages = false;

function checkForNewMessagesGlobal() {
    // ØªØ¬Ù†Ø¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ØªÙƒØ±Ø±Ø©
    if (isCheckingGlobalMessages) return;

    isCheckingGlobalMessages = true;

    // ÙØ­Øµ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØºØ±Ù
    fetch('/modern-chat/api/check-new-messages/', {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.has_new_messages) {
            // Ø¥Ø¸Ù‡Ø§Ø± Ø¥Ø´Ø¹Ø§Ø± ÙˆÙØªØ­ Ø§Ù„Ù†Ø§ÙØ°Ø©
            showGlobalNewMessageNotification(data);

            // ÙØªØ­ Ø§Ù„Ù†Ø§ÙØ°Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙØªÙˆØ­Ø©
            if (!chatWidgetVisible && document.getElementById('miniChatWindow').style.display !== 'flex') {
                // Ù„Ø§ Ù†ÙØªØ­ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ØŒ ÙÙ‚Ø· Ù†Ø¸Ù‡Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
                console.log('Ø±Ø³Ø§Ø¦Ù„ Ø¬Ø¯ÙŠØ¯Ø© Ù…ØªØ§Ø­Ø©');
            }
        }
    })
    .catch(error => {
        console.error('Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:', error);
    })
    .finally(() => {
        isCheckingGlobalMessages = false;
    });
}

function showGlobalNewMessageNotification(data) {
    const notification = document.createElement('div');
    notification.className = 'global-message-notification';
    notification.innerHTML = `
        <div class="notification-content">
            <i class="fas fa-envelope"></i>
            <div class="notification-text">
                <strong>Ø±Ø³Ø§Ø¦Ù„ Ø¬Ø¯ÙŠØ¯Ø© (${data.new_message_count})</strong>
                <small>Ø§Ù†Ù‚Ø± Ù„ÙØªØ­ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</small>
            </div>
        </div>
    `;

    notification.onclick = () => {
        // ÙØªØ­ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙØªÙˆØ­Ø©
        if (!chatWidgetVisible) {
            toggleChatWidget();
        }
        // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙØªÙˆØ­Ø© ÙˆÙ…ØµØºØ±Ø©ØŒ Ø¥Ø¸Ù‡Ø§Ø±Ù‡Ø§
        else if (chatWidgetMinimized) {
            const widget = document.getElementById('chatWidget');
            widget.style.display = 'flex';
            chatWidgetMinimized = false;
        }

        // Ø¥Ø®ÙØ§Ø¡ Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
        const badge = document.getElementById('chatNotificationBadge');
        if (badge) {
            badge.style.display = 'none';
        }

        notification.remove();
    };

    document.body.appendChild(notification);

    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);

    // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
    const badge = document.getElementById('chatNotificationBadge');
    if (badge) {
        badge.style.display = 'flex';
        badge.textContent = data.new_message_count;
    }
}

// Ø¨Ø¯Ø¡ ÙØ­Øµ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
document.addEventListener('DOMContentLoaded', function() {
    startGlobalMessageCheck();
    // ØªÙ… Ù†Ù‚Ù„ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø£ØµÙˆØ§Øª Ø¥Ù„Ù‰ ChatManager.init()

    // Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
    if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
    }
});

// ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
function updateUserStatus() {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
                     document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');

    if (!csrfToken) {
        console.warn('CSRF token not found');
        return;
    }

    fetch('/modern-chat/api/update-status/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            status: 'online'
        })
    })
    .then(response => {
        return response.json();
    })
    .catch(error => console.error('Error updating status:', error));
}

// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© ÙƒÙ„ 60 Ø«Ø§Ù†ÙŠØ© ÙÙ‚Ø· (ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª)
setInterval(updateUserStatus, 60000);

// ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¹Ø¨Ø± WebSocket ÙÙ‚Ø· - Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯ÙˆØ±ÙŠ
// setInterval(loadActiveUsers, 30000); // ØªÙ… ØªØ¹Ø·ÙŠÙ„Ù‡ - ÙŠØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¹Ø¨Ø± WebSocket

// Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
if ('Notification' in window && Notification.permission === 'default') {
    Notification.requestPermission();
}

// Ø¯Ø§Ù„Ø© ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
function switchChatTab(tabId, buttonElement) {
    // Ø¥Ø²Ø§Ù„Ø© active Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
    const allButtons = document.querySelectorAll('.chat-widget-tabs .nav-link');
    allButtons.forEach(btn => btn.classList.remove('active'));

    // Ø¥Ø¶Ø§ÙØ© active Ù„Ù„Ø²Ø± Ø§Ù„Ù…Ø¶ØºÙˆØ·
    buttonElement.classList.add('active');

    // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
    const allTabs = document.querySelectorAll('.tab-pane');
    allTabs.forEach(tab => {
        tab.classList.remove('show', 'active');
    });

    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
    const targetTab = document.getElementById(tabId);
    if (targetTab) {
        targetTab.classList.add('show', 'active');

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ØªØ¨ÙˆÙŠØ¨
        if (tabId === 'activeUsers') {
            // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù†Ø´Ø·ÙŠÙ†
            loadActiveUsers();
        }
    }
}

// Ø¥ØµÙ„Ø§Ø­ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù†Ø´Ø·ÙŠÙ† - ØªØ­Ø¯ÙŠØ« Ø¯ÙˆØ±ÙŠ Ø£Ù‚Ù„ ØªÙƒØ±Ø§Ø±Ø§Ù‹
let lastUserStatusCheck = 0;
function updateUserStatusPeriodically() {
    const now = Date.now();
    // ØªØ­Ø¯ÙŠØ« ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚ØªÙŠÙ† ÙÙ‚Ø· Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø­Ù…Ù„
    if (now - lastUserStatusCheck > 120000) {
        lastUserStatusCheck = now;
        if (typeof loadActiveUsers === 'function') {
            loadActiveUsers();
        }
    }
}

// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚ØªÙŠÙ† Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† ÙƒÙ„ 15 Ø«Ø§Ù†ÙŠØ©
setInterval(updateUserStatusPeriodically, 120000);

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ© Ù„Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
document.addEventListener('DOMContentLoaded', function() {
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù†Ø´Ø·ÙŠÙ† Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
    loadActiveUsers();
});
</script>
