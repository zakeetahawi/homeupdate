<!-- الزر العائم للدردشة - قابل للسحب -->
<div id="chatFloatingButton" class="chat-floating-btn draggable-btn">
    <div class="chat-btn-main" onclick="toggleChatWidget()">
        <i class="fas fa-comments"></i>
        <span class="chat-notification-badge" id="chatNotificationBadge" style="display: none;">0</span>
    </div>
</div>

<!-- نافذة الدردشة المصغرة -->
<div id="chatWidget" class="chat-widget" style="display: none;">
    <div class="chat-widget-header">
        <div class="d-flex justify-content-between align-items-center">
            <h6 class="mb-0">
                <i class="fas fa-comments me-2"></i>
                الدردشة
            </h6>
            <div class="chat-widget-controls">
                <button class="btn btn-sm" onclick="minimizeChatWidget()" title="تصغير">
                    <i class="fas fa-minus"></i>
                </button>
                <button class="btn btn-sm" onclick="closeChatWidget()" title="إغلاق">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </div>
    
    <div class="chat-widget-body">
        <div class="chat-widget-tabs">
            <div class="nav nav-tabs" role="tablist">
                <button class="nav-link active" onclick="switchChatTab('activeUsers', this)" type="button">
                    المستخدمون
                </button>
            </div>
        </div>
        
        <div class="tab-content">
            <!-- المستخدمون النشطون -->
            <div class="tab-pane fade show active" id="activeUsers">
                <div class="active-users-list" id="activeUsersWidget">
                    <div class="text-center p-3">
                        <div class="spinner-border spinner-border-sm" role="status"></div>
                        <p class="mt-2 mb-0">جاري التحميل...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="chat-widget-footer">
        <small class="text-muted text-center d-block">
            <i class="fas fa-comments me-1"></i>
            نظام الدردشة المصغر
        </small>
    </div>
</div>

<!-- نافذة دردشة صغيرة مثل مسنجر -->
<div id="miniChatWindow" class="mini-chat-window" style="display: none;">
    <div class="mini-chat-header">
        <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <div class="mini-chat-avatar">
                    <span id="miniChatUserInitial">U</span>
                </div>
                <div class="ms-2">
                    <h6 class="mb-0" id="miniChatUserName">اسم المستخدم</h6>
                    <small class="text-success" id="miniChatUserStatus">متصل</small>
                </div>
            </div>
            <div class="mini-chat-controls">
                <button id="muteChatButton" class="btn btn-sm btn-outline-light" onclick="toggleChatMute()" title="كتم/إلغاء كتم الصوت">
                    <i class="fas fa-volume-up"></i>
                </button>
                <button class="btn btn-sm" onclick="minimizeMiniChat()" title="تصغير">
                    <i class="fas fa-minus"></i>
                </button>
                <button class="btn btn-sm" onclick="closeMiniChat()" title="إغلاق">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </div>

    <div class="mini-chat-messages" id="miniChatMessages">
        <!-- الرسائل ستظهر هنا -->
    </div>

    <!-- مؤشر الكتابة -->
    <div class="typing-indicator" id="typingIndicator" style="display: none;">
        <span class="typing-user"></span> يكتب
        <div class="typing-dots">
            <span></span>
            <span></span>
            <span></span>
        </div>
    </div>

    <div class="mini-chat-input">
        <div class="d-flex">
            <input type="text" class="form-control form-control-sm"
                   id="miniChatInput" placeholder="اكتب رسالة..."
                   onkeypress="handleMiniChatEnter(event)"
                   oninput="handleTyping()"
                   onblur="stopTyping()">
            <button class="btn btn-primary btn-sm ms-2" onclick="sendMiniChatMessage()">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
</div>

<!-- قائمة النقر بالزر الأيمن -->
<div id="userContextMenu" class="context-menu" style="display: none;">
    <div class="context-menu-item" onclick="viewUserProfile()">
        <i class="fas fa-user me-2"></i>
        عرض الملف الشخصي
    </div>
    <div class="context-menu-item" onclick="startPrivateChat()">
        <i class="fas fa-comments me-2"></i>
        بدء محادثة
    </div>
    <div class="context-menu-item" onclick="deleteConversation()">
        <i class="fas fa-trash me-2"></i>
        حذف المحادثة
    </div>
    <div class="context-menu-item" onclick="blockUser()">
        <i class="fas fa-ban me-2"></i>
        حظر المستخدم
    </div>
</div>

<style>
.chat-floating-btn {
    position: fixed;
    bottom: 30px;
    right: 30px;
    z-index: 1050;
    cursor: move;
    user-select: none;
    transition: none;
    will-change: transform;
}

.chat-floating-btn.dragging {
    transform: scale(1.05);
    box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
    z-index: 1060;
    transition: none;
}

.chat-floating-btn.snapping {
    transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
}

.chat-floating-btn:not(.dragging):not(.snapping) {
    transition: transform 0.2s ease;
}

.chat-btn-main {
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 24px;
    cursor: pointer;
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
    transition: all 0.3s ease;
    position: relative;
}

.chat-btn-main:hover {
    transform: translateY(-3px);
    box-shadow: 0 12px 35px rgba(102, 126, 234, 0.4);
}

.chat-notification-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background: #ef4444;
    color: white;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: bold;
    border: 2px solid white;
}

.chat-widget {
    position: fixed;
    bottom: 100px;
    right: 30px;
    width: 320px;
    height: 400px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    z-index: 1040;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    animation: slideInUp 0.3s ease;
    border: 1px solid #e0e0e0;
}

@keyframes slideInUp {
    from {
        transform: translateY(20px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideOutRight {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(100%);
        opacity: 0;
    }
}

@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideOutRight {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(100%);
        opacity: 0;
    }
}

.chat-widget-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 15px;
    border-radius: 15px 15px 0 0;
}

.chat-widget-controls button {
    background: none;
    border: none;
    color: white;
    padding: 5px;
    margin-left: 5px;
    border-radius: 5px;
    transition: background 0.2s ease;
}

.chat-widget-controls button:hover {
    background: rgba(255,255,255,0.2);
}

.chat-widget-body {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.chat-widget-tabs .nav-tabs {
    border-bottom: 1px solid #dee2e6;
    background: #f8f9fa;
}

.chat-widget-tabs .nav-link {
    border: none;
    color: #6c757d;
    font-size: 14px;
    padding: 10px 15px;
}

.chat-widget-tabs .nav-link.active {
    background: white;
    color: #667eea;
    border-bottom: 2px solid #667eea;
}

.tab-content {
    flex: 1;
    overflow: hidden;
}

.tab-pane {
    height: 100%;
    overflow-y: auto;
}

.chat-rooms-list, .active-users-list {
    max-height: 300px;
    overflow-y: auto;
}

.chat-room-item, .user-item-widget {
    padding: 12px 15px;
    border-bottom: 1px solid #f0f0f0;
    cursor: pointer;
    transition: background 0.2s ease;
}

.chat-room-item:hover, .user-item-widget:hover {
    background: #f8f9fa;
}

/* تحسين مظهر المستخدمين حسب الحالة */
.user-online {
    border-left: 3px solid #28a745;
    background: linear-gradient(90deg, rgba(40, 167, 69, 0.05) 0%, transparent 100%);
}

.user-offline {
    border-left: 3px solid #6c757d;
    background: linear-gradient(90deg, rgba(108, 117, 125, 0.03) 0%, transparent 100%);
}

.user-online:hover {
    background: linear-gradient(90deg, rgba(40, 167, 69, 0.1) 0%, #f8f9fa 100%);
}

.user-offline:hover {
    background: linear-gradient(90deg, rgba(108, 117, 125, 0.08) 0%, #f8f9fa 100%);
}

/* تحسين مظهر الأفاتار */
.user-avatar-small {
    position: relative;
    overflow: visible;
}

/* تحسين مظهر مؤشر الحالة */
.status-indicator-dot {
    position: absolute;
    bottom: -2px;
    right: -2px;
    width: 12px;
    height: 12px;
    border: 2px solid white;
    border-radius: 50%;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}

.chat-widget-footer {
    padding: 15px;
    border-top: 1px solid #dee2e6;
    background: #f8f9fa;
}

.user-avatar-small {
    width: 35px;
    height: 35px;
    border-radius: 50%;
    background: linear-gradient(45deg, #667eea, #764ba2);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 14px;
}

.status-indicator {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    display: inline-block;
    margin-left: 5px;
}

.status-online { background: #10b981; }
.status-away { background: #f59e0b; }
.status-busy { background: #ef4444; }
.status-offline { background: #6b7280; }

/* قائمة النقر بالزر الأيمن */
.context-menu {
    position: fixed;
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    z-index: 2000;
    min-width: 180px;
    padding: 5px 0;
}

.context-menu-item {
    padding: 10px 15px;
    cursor: pointer;
    transition: background 0.2s ease;
    font-size: 14px;
    color: #333;
}

.context-menu-item:hover {
    background: #f8f9fa;
}

.context-menu-item i {
    width: 16px;
    text-align: center;
}

/* إشعارات الرسائل الجديدة */
.new-message-notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 15px 20px;
    border-radius: 10px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.3);
    z-index: 2000;
    animation: slideInRight 0.3s ease;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: transform 0.2s ease;
    max-width: 300px;
    word-wrap: break-word;
}

.new-message-notification:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 35px rgba(0,0,0,0.4);
}

.new-message-notification i {
    margin-left: 8px;
    font-size: 16px;
}

@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes fadeOut {
    from {
        opacity: 1;
    }
    to {
        opacity: 0;
    }
}

/* الإشعار العام للرسائل الجديدة */
.global-message-notification {
    position: fixed;
    top: 80px;
    right: 20px;
    background: white;
    border: 1px solid #ddd;
    border-radius: 10px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.15);
    z-index: 2000;
    cursor: pointer;
    animation: slideInRight 0.3s ease, pulse 2s infinite 1s;
    min-width: 250px;
}

.notification-content {
    padding: 15px;
    display: flex;
    align-items: center;
}

.notification-content i {
    font-size: 24px;
    color: #667eea;
    margin-left: 15px;
}

.notification-text {
    flex: 1;
}

.notification-text strong {
    display: block;
    color: #333;
    font-size: 14px;
    margin-bottom: 2px;
}

.notification-text small {
    color: #666;
    font-size: 12px;
}

@keyframes pulse {
    0%, 100% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.02);
    }
}

/* نافذة الدردشة الصغيرة مثل مسنجر */
.mini-chat-window {
    position: fixed;
    bottom: 100px;
    right: 100px;
    width: 300px;
    height: 350px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.2);
    z-index: 1045;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    border: 1px solid #ddd;
    animation: slideInUp 0.3s ease;
}

.mini-chat-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 10px 15px;
    border-radius: 10px 10px 0 0;
}

.mini-chat-avatar {
    width: 35px;
    height: 35px;
    border-radius: 50%;
    background: rgba(255,255,255,0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
}

.mini-chat-controls button {
    background: none;
    border: none;
    color: white;
    padding: 5px;
    margin-left: 5px;
    border-radius: 3px;
    transition: background 0.2s ease;
}

.mini-chat-controls button:hover {
    background: rgba(255,255,255,0.2);
}

.mini-chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
    background: #f8f9fa;
}

.mini-chat-input {
    padding: 10px;
    border-top: 1px solid #ddd;
    background: white;
}

.mini-message {
    margin-bottom: 8px;
    display: flex;
    align-items: flex-start;
}

.mini-message.own {
    flex-direction: row-reverse;
}

.mini-message-content {
    max-width: 70%;
    padding: 8px 12px;
    border-radius: 15px;
    font-size: 14px;
    line-height: 1.3;
}

.mini-message:not(.own) .mini-message-content {
    background: #e9ecef;
    color: #333;
}

.mini-message.own .mini-message-content {
    background: #667eea;
    color: white;
}

.mini-message-time {
    font-size: 11px;
    opacity: 0.7;
    margin-top: 2px;
    text-align: center;
}

/* مؤشر الكتابة */
.typing-indicator {
    padding: 8px 15px;
    background: rgba(0,0,0,0.05);
    border-top: 1px solid #ddd;
    font-size: 12px;
    color: #666;
    font-style: italic;
}

.typing-dots {
    display: inline-block;
    margin-right: 5px;
}

.typing-dots span {
    display: inline-block;
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: #666;
    margin: 0 1px;
    animation: typing 1.4s infinite ease-in-out;
}

.typing-dots span:nth-child(1) { animation-delay: -0.32s; }
.typing-dots span:nth-child(2) { animation-delay: -0.16s; }

@keyframes typing {
    0%, 80%, 100% {
        transform: scale(0);
        opacity: 0.5;
    }
    40% {
        transform: scale(1);
        opacity: 1;
    }
}

/* نوافذ المحادثة الجديدة - مثل Facebook */
.facebook-chat-window {
    position: fixed;
    bottom: 0;
    width: 300px;
    height: 400px;
    background: white;
    border: 1px solid #ddd;
    border-bottom: none;
    border-radius: 8px 8px 0 0;
    box-shadow: 0 -2px 12px rgba(0,0,0,0.15);
    z-index: 1050;
    display: flex;
    flex-direction: column;
    animation: slideInUp 0.3s ease;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

.facebook-chat-window.minimized {
    height: 42px;
    overflow: hidden;
}

.chat-window-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 8px 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-radius: 8px 8px 0 0;
    cursor: pointer;
}

.chat-user-info {
    display: flex;
    align-items: center;
    flex: 1;
}

.chat-avatar {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: rgba(255,255,255,0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 12px;
    margin-left: 8px;
}

.chat-user-details {
    display: flex;
    flex-direction: column;
}

.chat-user-name {
    font-size: 13px;
    font-weight: 600;
    line-height: 1;
}

.chat-user-status {
    font-size: 11px;
    opacity: 0.8;
    line-height: 1;
}

.chat-window-controls {
    display: flex;
    gap: 4px;
}

.chat-control-btn {
    background: none;
    border: none;
    color: white;
    padding: 4px;
    border-radius: 4px;
    cursor: pointer;
    transition: background 0.2s;
    font-size: 12px;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.chat-control-btn:hover {
    background: rgba(255,255,255,0.2);
}

.chat-messages-container {
    flex: 1;
    overflow-y: auto;
    padding: 8px;
    background: #f8f9fa;
    display: flex;
    flex-direction: column;
}

.loading-messages {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
    color: #666;
    font-size: 13px;
}

.spinner {
    width: 16px;
    height: 16px;
    border: 2px solid #ddd;
    border-top: 2px solid #667eea;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-left: 8px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.chat-message {
    margin-bottom: 8px;
    display: flex;
    max-width: 85%;
}

.chat-message.own {
    align-self: flex-end;
    flex-direction: row-reverse;
}

.chat-message.other {
    align-self: flex-start;
}

.message-content {
    background: #e4e6ea;
    padding: 8px 12px;
    border-radius: 16px;
    font-size: 14px;
    line-height: 1.3;
    position: relative;
    word-wrap: break-word;
}

.chat-message.own .message-content {
    background: #667eea;
    color: white;
}

.message-time {
    font-size: 11px;
    opacity: 0.7;
    margin-top: 2px;
    text-align: center;
}

.typing-indicator {
    padding: 8px 12px;
    background: rgba(0,0,0,0.05);
    border-top: 1px solid #ddd;
    font-size: 12px;
    color: #666;
    display: flex;
    align-items: center;
}

.typing-dots {
    display: flex;
    gap: 2px;
    margin-right: 6px;
}

.typing-dots span {
    width: 4px;
    height: 4px;
    border-radius: 50%;
    background: #666;
    animation: typing 1.4s infinite ease-in-out;
}

.typing-dots span:nth-child(1) { animation-delay: -0.32s; }
.typing-dots span:nth-child(2) { animation-delay: -0.16s; }

@keyframes typing {
    0%, 80%, 100% {
        transform: scale(0);
        opacity: 0.5;
    }
    40% {
        transform: scale(1);
        opacity: 1;
    }
}

.chat-input-container {
    display: flex;
    padding: 8px;
    border-top: 1px solid #ddd;
    background: white;
    align-items: center;
    gap: 8px;
}

.chat-input {
    flex: 1;
    border: 1px solid #ddd;
    border-radius: 20px;
    padding: 8px 12px;
    font-size: 14px;
    outline: none;
    transition: border-color 0.2s;
}

.chat-input:focus {
    border-color: #667eea;
}

.send-btn {
    background: #667eea;
    border: none;
    color: white;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;
    font-size: 12px;
}

.send-btn:hover {
    background: #5a6fd8;
}

.unread-badge {
    background: #ff4444;
    color: white;
    border-radius: 10px;
    padding: 2px 6px;
    font-size: 11px;
    font-weight: bold;
    margin-right: 8px;
    min-width: 18px;
    text-align: center;
    line-height: 1.2;
}

/* تحسينات للشاشات الصغيرة */
@media (max-width: 768px) {
    .facebook-chat-window {
        width: calc(100vw - 20px);
        right: 10px !important;
        left: 10px;
        height: 350px;
    }

    .chat-widget {
        width: calc(100vw - 20px);
        right: 10px;
        left: 10px;
        height: 400px;
    }

    .chat-floating-btn {
        bottom: 20px;
        right: 20px;
    }
}
</style>

<script>
let chatWidgetVisible = false;
let chatWidgetMinimized = false;
let isDragging = false;
let dragOffset = { x: 0, y: 0 };

// نظام إدارة المحادثات السريعة - مثل Facebook Messenger
const ChatManager = {
    // WebSocket
    socket: null,
    isConnected: false,
    reconnectAttempts: 0,
    maxReconnectAttempts: 5,
    reconnectDelay: 1000,

    // المحادثات المفتوحة (نوافذ متعددة)
    openChats: new Map(), // roomId -> chatWindow object

    // الرسائل غير المقروءة
    unreadCounts: new Map(), // roomId -> count

    // إعدادات الصوت والكتم
    soundEnabled: true,
    mutedChats: new Set(),
    notificationAudio: null,

    // تهيئة النظام
    init() {
        console.log('تهيئة ChatManager...');
        this.initWebSocket();
        this.loadSettings();
        this.setupEventListeners();
        this.initializeAudio();
        console.log('تم تهيئة ChatManager بنجاح');
    },

    // فتح محادثة جديدة أو التركيز على الموجودة
    openChat(roomId, userInfo) {
        console.log('ChatManager.openChat called with:', roomId, userInfo);

        if (!roomId || !userInfo) {
            console.error('معاملات غير صحيحة لفتح المحادثة:', { roomId, userInfo });
            return;
        }

        if (this.openChats.has(roomId)) {
            // التركيز على النافذة الموجودة
            console.log('النافذة موجودة، التركيز عليها');
            this.focusChat(roomId);
        } else {
            // إنشاء نافذة جديدة
            console.log('إنشاء نافذة جديدة');
            this.createChatWindow(roomId, userInfo);
        }

        // إزالة العداد
        this.clearUnreadCount(roomId);
    },

    // إنشاء نافذة محادثة جديدة
    createChatWindow(roomId, userInfo) {
        console.log('إنشاء نافذة محادثة:', roomId, userInfo);

        const windowId = `chat-window-${roomId}`;
        const existingWindow = document.getElementById(windowId);

        if (existingWindow) {
            console.log('إزالة النافذة الموجودة');
            existingWindow.remove();
        }

        // حساب موقع النافذة (متعددة النوافذ)
        const windowCount = this.openChats.size;
        const rightOffset = 30 + (windowCount * 320);

        try {
            const chatWindow = this.createChatWindowHTML(windowId, roomId, userInfo, rightOffset);
            document.body.appendChild(chatWindow);
            console.log('تم إضافة النافذة للصفحة');

            // حفظ مرجع النافذة
            this.openChats.set(roomId, {
                element: chatWindow,
                roomId: roomId,
                userInfo: userInfo,
                isMinimized: false
            });

            // تحميل الرسائل
            this.loadMessages(roomId);

            // تحديث زر الكتم
            this.updateMuteButton(roomId);

            console.log('تم إنشاء النافذة بنجاح');
        } catch (error) {
            console.error('خطأ في إنشاء النافذة:', error);
        }
    },

    // إنشاء HTML لنافذة المحادثة
    createChatWindowHTML(windowId, roomId, userInfo, rightOffset) {
        const div = document.createElement('div');
        div.id = windowId;
        div.className = 'facebook-chat-window';
        div.style.right = rightOffset + 'px';

        div.innerHTML = `
            <div class="chat-window-header">
                <div class="chat-user-info">
                    <div class="chat-avatar">
                        ${userInfo.name.charAt(0).toUpperCase()}
                    </div>
                    <div class="chat-user-details">
                        <span class="chat-user-name">${userInfo.name}</span>
                        <span class="chat-user-status">متصل</span>
                    </div>
                </div>
                <div class="chat-window-controls">
                    <button class="chat-control-btn" onclick="ChatManager.toggleMute('${roomId}')" title="كتم/إلغاء كتم" id="mute-btn-${roomId}">
                        <i class="fas fa-volume-up"></i>
                    </button>
                    <button class="chat-control-btn" onclick="ChatManager.minimizeChat('${roomId}')" title="تصغير">
                        <i class="fas fa-minus"></i>
                    </button>
                    <button class="chat-control-btn" onclick="ChatManager.closeChat('${roomId}')" title="إغلاق">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>

            <div class="chat-messages-container" id="messages-${roomId}">
                <div class="loading-messages">
                    <div class="spinner"></div>
                    <span>جاري تحميل الرسائل...</span>
                </div>
            </div>

            <div class="typing-indicator" id="typing-${roomId}" style="display: none;">
                <span class="typing-text"></span>
                <div class="typing-dots">
                    <span></span><span></span><span></span>
                </div>
            </div>

            <div class="chat-input-container">
                <input type="text"
                       class="chat-input"
                       id="input-${roomId}"
                       placeholder="اكتب رسالة..."
                       onkeypress="ChatManager.handleKeyPress(event, '${roomId}')"
                       oninput="ChatManager.handleTyping('${roomId}')"
                       onblur="ChatManager.stopTyping('${roomId}')">
                <button class="send-btn" onclick="ChatManager.sendMessage('${roomId}')">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        `;

        return div;
    },

    // التركيز على محادثة موجودة
    focusChat(roomId) {
        const chat = this.openChats.get(roomId);
        if (chat && chat.isMinimized) {
            this.restoreChat(roomId);
        }

        // التمرير لأسفل
        this.scrollToBottom(roomId);

        // التركيز على حقل الإدخال
        const input = document.getElementById(`input-${roomId}`);
        if (input) input.focus();
    },

    // إغلاق محادثة
    closeChat(roomId) {
        const chat = this.openChats.get(roomId);
        if (chat) {
            chat.element.remove();
            this.openChats.delete(roomId);

            // إعادة ترتيب النوافذ المتبقية
            this.rearrangeWindows();
        }
    },

    // تصغير محادثة
    minimizeChat(roomId) {
        const chat = this.openChats.get(roomId);
        if (chat) {
            const messagesContainer = chat.element.querySelector('.chat-messages-container');
            const inputContainer = chat.element.querySelector('.chat-input-container');
            const typingIndicator = chat.element.querySelector('.typing-indicator');

            messagesContainer.style.display = 'none';
            inputContainer.style.display = 'none';
            typingIndicator.style.display = 'none';

            chat.isMinimized = true;
            chat.element.classList.add('minimized');
        }
    },

    // استعادة محادثة مصغرة
    restoreChat(roomId) {
        const chat = this.openChats.get(roomId);
        if (chat) {
            const messagesContainer = chat.element.querySelector('.chat-messages-container');
            const inputContainer = chat.element.querySelector('.chat-input-container');

            messagesContainer.style.display = 'block';
            inputContainer.style.display = 'flex';

            chat.isMinimized = false;
            chat.element.classList.remove('minimized');

            // التمرير لأسفل
            this.scrollToBottom(roomId);
        }
    },

    // معالجة الرسائل الجديدة الواردة
    handleIncomingMessage(message) {
        console.log('معالجة رسالة واردة:', message);

        const roomId = message.room_id;
        console.log('roomId from message:', roomId);
        console.log('currentChatRoomId:', currentChatRoomId);

        // التحقق من أن الرسالة ليست من المستخدم الحالي
        const isFromCurrentUser = message.sender?.is_current_user || false;
        if (isFromCurrentUser) {
            console.log('رسالة من المستخدم الحالي، تجاهل');
            return;
        }

        // فحص التكرار - إذا كانت الرسالة موجودة بالفعل
        if (this.isMessageAlreadyDisplayed(roomId, message)) {
            console.log('الرسالة موجودة بالفعل، تجاهل التكرار');
            return;
        }

        // تشغيل الصوت مع فحص الكتم
        this.playSound('receive', roomId);

        // فتح النافذة تلقائياً إذا لم تكن مفتوحة
        if (!this.openChats.has(roomId) && (!currentChatRoomId || currentChatRoomId !== roomId)) {
            console.log('فتح نافذة صغيرة للرسالة الواردة');
            const senderInfo = {
                id: message.sender?.id || message.sender_id,
                name: message.sender?.name || message.sender_name || 'مستخدم'
            };
            openMiniChatForRoom(roomId, senderInfo);
        }

        // إضافة الرسالة للنافذة
        if (currentChatRoomId === roomId) {
            // إضافة للنافذة الصغيرة
            addMiniChatMessage(message.content, false, message.created_at);
        } else {
            // إضافة للنافذة الكبيرة إذا كانت مفتوحة
            this.addMessageToWindow(roomId, message, false);
        }

        // تحديث العداد إذا كانت النافذة مصغرة
        const chat = this.openChats.get(roomId);
        if (chat && chat.isMinimized) {
            this.incrementUnreadCount(roomId);
        } else {
            // تحديد كمقروءة إذا كانت النافذة مفتوحة
            this.markAsRead(roomId);
        }

        // إظهار إشعار
        this.showNotification(message);

        // تحديث قائمة المستخدمين
        if (typeof loadActiveUsers === 'function') {
            loadActiveUsers();
        }
    },

    // فحص إذا كانت الرسالة موجودة بالفعل لتجنب التكرار
    isMessageAlreadyDisplayed(roomId, message) {
        const messageId = message.id || message.temp_id;

        // فحص بالمعرف الفريد أولاً إذا كان متاحاً
        if (messageId) {
            // فحص النافذة الصغيرة
            if (currentChatRoomId === roomId) {
                const miniMessages = document.getElementById('miniChatMessages');
                if (miniMessages) {
                    const existingMessage = miniMessages.querySelector(`[data-message-id="${messageId}"]`);
                    if (existingMessage) {
                        return true;
                    }
                }
            }

            // فحص النافذة الكبيرة
            const messagesContainer = document.getElementById(`messages-${roomId}`);
            if (messagesContainer) {
                const existingMessage = messagesContainer.querySelector(`[data-message-id="${messageId}"]`);
                if (existingMessage) {
                    return true;
                }
            }
        }

        // فحص بالمحتوى والوقت كبديل
        const containers = [];

        // إضافة النافذة الصغيرة إذا كانت للغرفة الحالية
        if (currentChatRoomId === roomId) {
            const miniMessages = document.getElementById('miniChatMessages');
            if (miniMessages) containers.push(miniMessages);
        }

        // إضافة النافذة الكبيرة
        const messagesContainer = document.getElementById(`messages-${roomId}`);
        if (messagesContainer) containers.push(messagesContainer);

        for (let container of containers) {
            const messageElements = container.querySelectorAll('.message, .chat-message');
            for (let element of messageElements) {
                const messageContent = element.querySelector('.message-content');
                if (messageContent && messageContent.textContent.trim() === message.content.trim()) {
                    // فحص إضافي بالوقت
                    const messageTime = element.querySelector('.message-time');
                    if (messageTime && message.created_at) {
                        const displayedTime = new Date(messageTime.getAttribute('data-timestamp') || messageTime.textContent);
                        const messageTime_obj = new Date(message.created_at);
                        const timeDiff = Math.abs(displayedTime - messageTime_obj);

                        // إذا كان الفرق أقل من 10 ثوان، اعتبرها نفس الرسالة
                        if (timeDiff < 10000) {
                            return true;
                        }
                    } else {
                        // إذا لم يكن هناك وقت، اعتمد على المحتوى فقط
                        return true;
                    }
                }
            }
        }

        return false;
    },

    // تحديث قائمة المستخدمين عند حذف المحادثة
    refreshUserListAfterDelete() {
        console.log('تحديث قائمة المستخدمين بعد حذف المحادثة');
        if (typeof loadActiveUsers === 'function') {
            loadActiveUsers();
        }
    },

    // إضافة رسالة لنافذة المحادثة
    addMessageToWindow(roomId, message, isOwn = false) {
        const messagesContainer = document.getElementById(`messages-${roomId}`);
        if (!messagesContainer) return;

        // فحص التكرار قبل الإضافة
        if (this.isMessageAlreadyDisplayed(roomId, message)) {
            console.log('رسالة مكررة في النافذة الكبيرة، تم تجاهلها');
            return;
        }

        // إزالة رسالة التحميل
        const loading = messagesContainer.querySelector('.loading-messages');
        if (loading) loading.remove();

        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-message ${isOwn ? 'own' : 'other'}`;

        // إضافة معرف فريد للرسالة لتجنب التكرار
        const messageId = message.id || message.temp_id || 'msg_' + Date.now() + '_' + Math.random();
        messageDiv.setAttribute('data-message-id', messageId);

        const time = new Date(message.created_at || new Date()).toLocaleTimeString('ar-EG', {
            hour: '2-digit',
            minute: '2-digit'
        });

        messageDiv.innerHTML = `
            <div class="message-content">
                ${message.content}
                <div class="message-time" data-timestamp="${message.created_at || new Date().toISOString()}">${time}</div>
            </div>
        `;

        messagesContainer.appendChild(messageDiv);
        this.scrollToBottom(roomId);

        // تأثير بصري للرسالة الجديدة
        if (!isOwn) {
            messageDiv.style.opacity = '0';
            messageDiv.style.transform = 'translateY(10px)';
            setTimeout(() => {
                messageDiv.style.transition = 'all 0.3s ease';
                messageDiv.style.opacity = '1';
                messageDiv.style.transform = 'translateY(0)';
            }, 10);
        }
    },

    // إرسال رسالة
    sendMessage(roomId) {
        const input = document.getElementById(`input-${roomId}`);
        if (!input) return;

        const content = input.value.trim();
        if (!content) return;

        // إضافة الرسالة للواجهة فوراً مع معرف مؤقت لتجنب التكرار
        const tempMessage = {
            content: content,
            created_at: new Date(),
            sender: { name: 'أنت' },
            temp_id: 'temp_' + Date.now() + '_' + Math.random()
        };
        this.addMessageToWindow(roomId, tempMessage, true);

        // إرسال عبر WebSocket
        if (this.isConnected) {
            this.socket.send(JSON.stringify({
                type: 'send_message',
                room_id: roomId,
                content: content
            }));
        }

        // تنظيف الحقل
        input.value = '';
        this.stopTyping(roomId);

        // تشغيل صوت الإرسال
        this.playSound('send', roomId);
    },

    // معالجة ضغط المفاتيح
    handleKeyPress(event, roomId) {
        if (event.key === 'Enter') {
            this.sendMessage(roomId);
        }
    },

    // معالجة الكتابة
    handleTyping(roomId) {
        if (!this.isConnected) return;

        // إرسال إشارة بدء الكتابة
        this.socket.send(JSON.stringify({
            type: 'typing_start',
            room_id: roomId
        }));

        // إيقاف الكتابة بعد ثانيتين
        clearTimeout(this.typingTimeout);
        this.typingTimeout = setTimeout(() => {
            this.stopTyping(roomId);
        }, 2000);
    },

    // إيقاف الكتابة
    stopTyping(roomId) {
        if (this.isConnected) {
            this.socket.send(JSON.stringify({
                type: 'typing_stop',
                room_id: roomId
            }));
        }
        clearTimeout(this.typingTimeout);
    },

    // دوال مساعدة
    scrollToBottom(roomId) {
        const container = document.getElementById(`messages-${roomId}`);
        if (container) {
            container.scrollTop = container.scrollHeight;
        }
    },

    rearrangeWindows() {
        let index = 0;
        for (const [roomId, chat] of this.openChats) {
            const rightOffset = 30 + (index * 320);
            chat.element.style.right = rightOffset + 'px';
            index++;
        }
    },

    incrementUnreadCount(roomId) {
        const current = this.unreadCounts.get(roomId) || 0;
        this.unreadCounts.set(roomId, current + 1);
        this.updateChatHeader(roomId);
        this.updateFloatingButton();
    },

    clearUnreadCount(roomId) {
        this.unreadCounts.delete(roomId);
        this.updateChatHeader(roomId);
        this.updateFloatingButton();
    },

    updateChatHeader(roomId) {
        const chat = this.openChats.get(roomId);
        if (!chat) return;

        const count = this.unreadCounts.get(roomId) || 0;
        const header = chat.element.querySelector('.chat-window-header');

        // إزالة العداد القديم
        const oldBadge = header.querySelector('.unread-badge');
        if (oldBadge) oldBadge.remove();

        // إضافة عداد جديد إذا كان هناك رسائل غير مقروءة
        if (count > 0) {
            const badge = document.createElement('span');
            badge.className = 'unread-badge';
            badge.textContent = count;
            header.appendChild(badge);
        }
    },

    updateFloatingButton() {
        const totalUnread = Array.from(this.unreadCounts.values()).reduce((sum, count) => sum + count, 0);
        const badge = document.getElementById('chatNotificationBadge');

        if (badge) {
            if (totalUnread > 0) {
                badge.textContent = totalUnread;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }
    },

    handleTypingIndicator(data) {
        const roomId = data.room_id;
        const typingElement = document.getElementById(`typing-${roomId}`);

        if (!typingElement) return;

        if (data.is_typing && data.user_name) {
            const textElement = typingElement.querySelector('.typing-text');
            textElement.textContent = `${data.user_name} يكتب...`;
            typingElement.style.display = 'flex';

            // إخفاء بعد 3 ثوان
            setTimeout(() => {
                typingElement.style.display = 'none';
            }, 3000);
        } else {
            typingElement.style.display = 'none';
        }
    },

    playSound(type, roomId = null) {
        console.log('playSound called with type:', type, 'roomId:', roomId);
        console.log('mutedChats:', Array.from(this.mutedChats));
        // فحص الكتم أولاً
        if (roomId && this.mutedChats.has(roomId)) {
            console.log('الصوت مكتوم للغرفة:', roomId);
            return;
        }

        // فحص إعدادات الصوت العامة
        if (!this.soundEnabled) {
            console.log('الصوت معطل عالمياً');
            return;
        }

        // تشغيل الصوت
        try {
            const audio = this.notificationAudio;
            if (audio && audio.play) {
                audio.currentTime = 0;
                const playPromise = audio.play();
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        console.log('تم تشغيل الصوت بنجاح (ChatManager)');
                    }).catch(e => {
                        console.log('فشل تشغيل الصوت:', e);
                    });
                }
            } else {
                console.log('ملف الصوت غير متاح');
            }
        } catch (error) {
            console.log('خطأ في تشغيل الصوت:', error);
        }
    },

    showNotification(message) {
        // إظهار إشعار نظام التشغيل إذا كان مسموحاً
        if ('Notification' in window && Notification.permission === 'granted') {
            const senderName = message.sender?.name || message.sender_name || 'مستخدم';
            const content = message.content || 'رسالة جديدة';

            new Notification(`رسالة جديدة من ${senderName}`, {
                body: content,
                icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTIwIDJINEMyLjkgMiAyIDIuOSAyIDRWMjJMMTggMjBIMjBDMjEuMSAyMCAyMiAxOS4xIDIyIDE4VjRDMjIgMi45IDIxLjEgMiAyMCAyWiIgZmlsbD0iIzY2N2VlYSIvPgo8L3N2Zz4K'
            });
        }
    },

    toggleMute(roomId) {
        console.log('تبديل كتم الصوت للغرفة:', roomId);

        if (this.mutedChats.has(roomId)) {
            this.mutedChats.delete(roomId);
            console.log('تم إلغاء كتم الصوت');
            this.showToast('تم إلغاء كتم الصوت', 'success');
        } else {
            this.mutedChats.add(roomId);
            console.log('تم كتم الصوت');
            this.showToast('تم كتم الصوت', 'info');
        }

        this.updateMuteButton(roomId);
        this.saveSettings();
    },

    updateMuteButton(roomId) {
        const muteBtn = document.getElementById(`mute-btn-${roomId}`);
        if (!muteBtn) {
            console.log('زر الكتم غير موجود للغرفة:', roomId);
            return;
        }

        const icon = muteBtn.querySelector('i');
        if (!icon) return;

        if (this.mutedChats.has(roomId)) {
            icon.className = 'fas fa-volume-mute';
            muteBtn.title = 'إلغاء كتم الصوت';
        } else {
            icon.className = 'fas fa-volume-up';
            muteBtn.title = 'كتم الصوت';
        }

        console.log('تم تحديث زر الكتم للغرفة:', roomId, 'مكتوم:', this.mutedChats.has(roomId));
    },

    loadSettings() {
        const saved = localStorage.getItem('chatSettings');
        if (saved) {
            try {
                const settings = JSON.parse(saved);
                this.mutedChats = new Set(settings.mutedChats || []);
                this.soundEnabled = settings.soundEnabled !== false;
            } catch (e) {
                console.error('خطأ في تحميل الإعدادات:', e);
            }
        }
    },

    saveSettings() {
        const settings = {
            mutedChats: Array.from(this.mutedChats),
            soundEnabled: this.soundEnabled
        };
        localStorage.setItem('chatSettings', JSON.stringify(settings));
    },

    // تهيئة الأصوات
    initializeAudio() {
        try {
            this.notificationAudio = new Audio('/static/sounds/message-receive.wav');

            // اختبار تحميل الملفات
            this.notificationAudio.addEventListener('error', () => {
                console.log('فشل تحميل صوت الاستقبال، استخدام صوت بديل');
                this.notificationAudio = this.createFallbackAudio();
            });

        } catch (error) {
            console.log('خطأ في إنشاء الأصوات:', error);
            this.notificationAudio = this.createFallbackAudio();
        }
    },

    // إنشاء صوت بديل
    createFallbackAudio() {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);

        oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);

        return {
            play: () => {
                try {
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.1);
                } catch (e) {
                    console.log('لا يمكن تشغيل الصوت البديل');
                }
            }
        };
    },

    // تم حذف playNotificationSound - يتم استخدام playSound بدلاً منها

    // تبديل كتم المحادثة
    toggleChatMute(roomId) {
        if (this.mutedChats.has(roomId)) {
            this.mutedChats.delete(roomId);
            console.log('تم إلغاء كتم المحادثة:', roomId);
        } else {
            this.mutedChats.add(roomId);
            console.log('تم كتم المحادثة:', roomId);
        }
        this.saveSettings();
        return !this.mutedChats.has(roomId); // إرجاع الحالة الجديدة
    },

    // التحقق من حالة الكتم
    isChatMuted(roomId) {
        return this.mutedChats.has(roomId);
    },

    // تهيئة WebSocket
    initWebSocket() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws/chat/`;

        this.socket = new WebSocket(wsUrl);

        this.socket.onopen = (e) => {
            console.log('✅ WebSocket متصل بنجاح');
            this.isConnected = true;
            this.reconnectAttempts = 0;

            // إرسال تحديث حالة المستخدم
            this.socket.send(JSON.stringify({
                type: 'user_status_update',
                status: 'online'
            }));
        };

        this.socket.onmessage = (e) => {
            const data = JSON.parse(e.data);
            this.handleWebSocketMessage(data);
        };

        this.socket.onclose = (e) => {
            console.log('❌ WebSocket مقطوع:', e.code, e.reason);
            this.isConnected = false;

            // إعادة الاتصال التلقائي
            if (this.reconnectAttempts < this.maxReconnectAttempts) {
                setTimeout(() => {
                    this.reconnectAttempts++;
                    console.log(`🔄 محاولة إعادة الاتصال ${this.reconnectAttempts}/${this.maxReconnectAttempts}`);
                    this.initWebSocket();
                }, this.reconnectDelay * this.reconnectAttempts);
            }
        };

        this.socket.onerror = (e) => {
            console.error('خطأ في WebSocket:', e);
        };
    },

    // معالجة رسائل WebSocket
    handleWebSocketMessage(data) {
        console.log('رسالة WebSocket:', data);

        switch(data.type) {
            case 'new_message':
                this.handleIncomingMessage(data.message);
                break;
            case 'new_message_notification':
                this.handleIncomingMessage(data.message);
                break;
            case 'typing_indicator':
                this.handleTypingIndicator(data);
                break;
            case 'user_status_update':
                this.handleUserStatusUpdate(data);
                break;
            case 'room_joined':
                console.log('تم الانضمام للغرفة:', data.room_id);
                break;
            case 'messages_read':
                this.handleMessagesRead(data);
                break;
        }
    },

    // معالجة تحديث حالة المستخدم
    handleUserStatusUpdate(data) {
        // تحديث حالة المستخدم في القائمة
        if (typeof updateUserStatusInList === 'function') {
            updateUserStatusInList(data.user_id, data.status);
        }
        // تحديث قائمة المستخدمين النشطين
        if (typeof loadActiveUsers === 'function') {
            loadActiveUsers();
        }
    },

    // معالجة مؤشر الكتابة
    handleTypingIndicator(data) {
        const typingIndicator = document.getElementById(`typing-${data.room_id}`);
        if (!typingIndicator) return;

        if (data.is_typing && data.user_name) {
            typingIndicator.querySelector('.typing-text').textContent = `${data.user_name} يكتب الآن`;
            typingIndicator.style.display = 'block';

            // إخفاء المؤشر تلقائياً بعد 3 ثوان
            setTimeout(() => {
                if (typingIndicator.style.display === 'block') {
                    typingIndicator.style.display = 'none';
                }
            }, 3000);
        } else {
            typingIndicator.style.display = 'none';
        }
    },

    // معالجة قراءة الرسائل
    handleMessagesRead(data) {
        console.log(`المستخدم ${data.user_id} قرأ الرسائل في الغرفة ${data.room_id}`);
        // يمكن إضافة منطق إضافي هنا إذا لزم الأمر
    },

    // إعداد مستمعي الأحداث
    setupEventListeners() {
        // النقر على header لاستعادة النافذة المصغرة
        document.addEventListener('click', (e) => {
            if (e.target.closest('.chat-window-header')) {
                const windowElement = e.target.closest('.facebook-chat-window');
                if (windowElement && windowElement.classList.contains('minimized')) {
                    const roomId = windowElement.id.replace('chat-window-', '');
                    this.restoreChat(roomId);
                }
            }
        });
    },

    // تحميل الرسائل
    loadMessages(roomId) {
        fetch(`/modern-chat/api/messages/${roomId}/`)
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById(`messages-${roomId}`);
                if (!container) return;

                // إزالة رسالة التحميل
                container.innerHTML = '';

                if (data.messages && data.messages.length > 0) {
                    data.messages.forEach(message => {
                        this.addMessageToWindow(roomId, message, message.sender.is_current_user);
                    });
                } else {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #666; font-size: 13px;">
                            <i class="fas fa-comments" style="font-size: 24px; margin-bottom: 8px; display: block;"></i>
                            ابدأ المحادثة
                        </div>
                    `;
                }

                this.scrollToBottom(roomId);
            })
            .catch(error => {
                console.error('خطأ في تحميل الرسائل:', error);
            });
    },

    // تحديد الرسائل كمقروءة
    markAsRead(roomId) {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
                         document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');

        fetch(`/modern-chat/api/mark-read/${roomId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                this.clearUnreadCount(roomId);
            }
        })
        .catch(error => {
            console.error('خطأ في تحديد الرسائل كمقروءة:', error);
        });
    },

    // إظهار رسالة توست
    showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `alert alert-${type} position-fixed`;
        toast.style.cssText = `
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 250px;
            animation: slideInRight 0.3s ease;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        `;
        toast.textContent = message;

        document.body.appendChild(toast);

        setTimeout(() => {
            toast.style.animation = 'slideOutRight 0.3s ease';
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 300);
        }, 3000);
    }
};

// تم حذف النظام القديم - يتم استخدام ChatManager فقط

// تم حذف هذه الدالة - يتم استخدام ChatManager.handleIncomingMessage بدلاً منها

function handleTypingIndicator(data) {
    const typingIndicator = document.getElementById('typingIndicator');
    if (!typingIndicator) return;

    // التأكد من أن الكتابة في الغرفة الحالية
    if (data.room_id && data.room_id !== currentChatRoomId) {
        return;
    }

    if (data.is_typing && data.user_name) {
        typingIndicator.innerHTML = `
            <span class="typing-user">${data.user_name}</span> يكتب الآن
            <div class="typing-dots">
                <span></span>
                <span></span>
                <span></span>
            </div>
        `;
        typingIndicator.style.display = 'block';

        // إخفاء المؤشر تلقائياً بعد 3 ثوان
        setTimeout(() => {
            if (typingIndicator.style.display === 'block') {
                typingIndicator.style.display = 'none';
            }
        }, 3000);
    } else {
        typingIndicator.style.display = 'none';
    }
}

function handleUserStatusUpdate(data) {
    // تحديث حالة المستخدم في القائمة
    updateUserStatusInList(data.user_id, data.status);
}

function handleNewMessageNotification(data) {
    // إشعار للرسائل من غرف أخرى
    if (currentChatRoomId !== data.room_id) {
        showGlobalNewMessageNotification({
            has_new_messages: true,
            new_message_count: 1,
            sender_name: data.message.sender_name
        });
    }
}

function handleMessagesRead(data) {
    // تحديث حالة قراءة الرسائل
    console.log(`المستخدم ${data.user_id} قرأ الرسائل في الغرفة ${data.room_id}`);
}

// إعداد السحب والإفلات
document.addEventListener('DOMContentLoaded', function() {
    const floatingBtn = document.getElementById('chatFloatingButton');

    if (!floatingBtn) {
        console.error('❌ الزر العائم غير موجود!');
        return;
    }

    // إعداد السحب - إضافة passive: false لمنع التداخل
    floatingBtn.addEventListener('mousedown', startDrag, { passive: false });
    floatingBtn.addEventListener('touchstart', startDrag, { passive: false });

    // تهيئة النظام الجديد فقط
    ChatManager.init();

    // تحديث حالة المستخدم وتحميل البيانات (مرة واحدة فقط)
    updateUserStatus();
    loadActiveUsers();
});

function startDrag(e) {
    // التأكد من أن النقر على الزر نفسه وليس على عناصر أخرى
    if (!e.target.closest('.chat-btn-main')) {
        return;
    }

    e.preventDefault();
    e.stopPropagation();

    isDragging = true;

    const floatingBtn = document.getElementById('chatFloatingButton');
    const rect = floatingBtn.getBoundingClientRect();

    const clientX = e.clientX || (e.touches && e.touches[0].clientX);
    const clientY = e.clientY || (e.touches && e.touches[0].clientY);

    dragOffset.x = clientX - rect.left;
    dragOffset.y = clientY - rect.top;

    floatingBtn.classList.add('dragging');

    // إضافة event listeners مع passive: false
    document.addEventListener('mousemove', drag, { passive: false });
    document.addEventListener('mouseup', stopDrag, { passive: false });
    document.addEventListener('touchmove', drag, { passive: false });
    document.addEventListener('touchend', stopDrag, { passive: false });
}

function drag(e) {
    if (!isDragging) return;

    e.preventDefault();
    const floatingBtn = document.getElementById('chatFloatingButton');

    const clientX = e.clientX || (e.touches && e.touches[0].clientX);
    const clientY = e.clientY || (e.touches && e.touches[0].clientY);

    let newX = clientX - dragOffset.x;
    let newY = clientY - dragOffset.y;

    // حدود الشاشة مع هامش
    const margin = 10;
    const maxX = window.innerWidth - floatingBtn.offsetWidth - margin;
    const maxY = window.innerHeight - floatingBtn.offsetHeight - margin;

    newX = Math.max(margin, Math.min(newX, maxX));
    newY = Math.max(margin, Math.min(newY, maxY));

    // استخدام transform بدلاً من left/top للأداء الأفضل
    floatingBtn.style.transform = `translate(${newX - parseInt(floatingBtn.style.right || 30)}px, ${newY - parseInt(floatingBtn.style.bottom || 30)}px) scale(1.05)`;
}

function stopDrag() {
    if (!isDragging) return;

    isDragging = false;
    const floatingBtn = document.getElementById('chatFloatingButton');

    floatingBtn.classList.remove('dragging');
    floatingBtn.classList.add('snapping');

    // التقاط إلى الحواف
    snapToEdge();

    setTimeout(() => {
        floatingBtn.classList.remove('snapping');
    }, 200);

    document.removeEventListener('mousemove', drag);
    document.removeEventListener('mouseup', stopDrag);
    document.removeEventListener('touchmove', drag);
    document.removeEventListener('touchend', stopDrag);
}

function snapToEdge() {
    const floatingBtn = document.getElementById('chatFloatingButton');
    const rect = floatingBtn.getBoundingClientRect();
    const centerX = rect.left + rect.width / 2;

    // إعادة تعيين transform
    floatingBtn.style.transform = '';

    if (centerX < window.innerWidth / 2) {
        // التقاط إلى اليسار
        floatingBtn.style.left = '20px';
        floatingBtn.style.right = 'auto';
        floatingBtn.style.bottom = '20px';
        floatingBtn.style.top = 'auto';
    } else {
        // التقاط إلى اليمين
        floatingBtn.style.right = '20px';
        floatingBtn.style.left = 'auto';
        floatingBtn.style.bottom = '20px';
        floatingBtn.style.top = 'auto';
    }
}

function toggleChatWidget() {
    if (ChatManager.isDragging) return; // منع فتح النافذة أثناء السحب

    const widget = document.getElementById('chatWidget');

    if (chatWidgetVisible) {
        if (chatWidgetMinimized) {
            // إظهار النافذة المصغرة
            widget.style.display = 'flex';
            chatWidgetMinimized = false;
            loadChatData();
            // إخفاء عداد الإشعارات عند فتح النافذة
            hideChatNotificationBadge();
        } else {
            // إخفاء النافذة
            closeChatWidget();
        }
    } else {
        // إظهار النافذة
        widget.style.display = 'flex';
        chatWidgetVisible = true;
        chatWidgetMinimized = false;
        loadChatData();
        // إخفاء عداد الإشعارات عند فتح النافذة
        hideChatNotificationBadge();
    }
}

function hideChatNotificationBadge() {
    const badge = document.getElementById('chatNotificationBadge');
    if (badge) {
        badge.style.display = 'none';
        badge.textContent = '0';
    }
}

function showChatNotificationBadge(count = 1) {
    const badge = document.getElementById('chatNotificationBadge');
    if (badge) {
        badge.textContent = count;
        badge.style.display = 'flex';
    }
}

function minimizeChatWidget() {
    const widget = document.getElementById('chatWidget');
    widget.style.display = 'none';
    chatWidgetMinimized = true;
}

function closeChatWidget() {
    const widget = document.getElementById('chatWidget');
    widget.style.display = 'none';
    chatWidgetVisible = false;
    chatWidgetMinimized = false;
}

function openFullChat() {
    // لا نحتاج هذه الدالة بعد الآن
    alert('تم إزالة شاشة المحادثة الكبيرة. استخدم النافذة الصغيرة فقط.');
}

function loadChatData() {
    // تحميل المستخدمين النشطين
    loadActiveUsers();
}

function sendWebSocketMessage(data) {
    if (ChatManager.socket && ChatManager.socket.readyState === WebSocket.OPEN) {
        ChatManager.socket.send(JSON.stringify(data));
    } else {
        console.error('WebSocket غير متصل');
    }
}

function openRoomFromWidget(roomId) {
    // فتح النافذة الصغيرة بدلاً من الانتقال للصفحة
    openMiniChatForRoom(roomId);

    // إغلاق النافذة الكبيرة
    closeChatWidget();
}

function loadActiveUsers() {
    fetch('/modern-chat/api/active-users/')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('📊 بيانات المستخدمين المستلمة:', data);

            const users = data.users || [];
            updateActiveUsersWidget(users);

            // حساب عدد المتصلين الفعلي بدقة
            const onlineCount = users.filter(user => {
                const now = new Date();
                const lastSeen = user.last_seen ? new Date(user.last_seen) : null;
                const timeDiff = lastSeen ? (now - lastSeen) / 1000 / 60 : Infinity;
                return (user.status === 'online' || user.status === 'away' || user.status === 'busy') && timeDiff <= 3;
            }).length;

            console.log(`✅ تم تحميل ${users.length} مستخدم، منهم ${onlineCount} متصل فعلياً`);

            // تحديث عنوان التبويب ليظهر عدد المتصلين
            const activeUsersTab = document.querySelector('.nav-link[onclick*="activeUsers"]');
            if (activeUsersTab) {
                const baseText = 'المستخدمون';
                if (onlineCount > 0) {
                    activeUsersTab.innerHTML = `${baseText} <span class="badge bg-success ms-1">${onlineCount}</span>`;
                } else {
                    activeUsersTab.innerHTML = baseText;
                }
            }

            // تحديث شارة الإشعارات (اختياري)
            const badge = document.getElementById('chatNotificationBadge');
            if (badge && onlineCount > 0) {
                badge.textContent = onlineCount;
                badge.style.display = 'flex';
            } else if (badge) {
                badge.style.display = 'none';
            }
        })
        .catch(error => {
            console.error('خطأ في تحميل المستخدمين النشطين:', error);
            const container = document.getElementById('activeUsersWidget');
            if (container) {
                container.innerHTML = `
                    <div class="text-center p-3">
                        <i class="fas fa-exclamation-triangle text-warning"></i>
                        <p class="text-muted mt-2 mb-0">خطأ في التحميل: ${error.message}</p>
                        <button class="btn btn-sm btn-outline-primary mt-2" onclick="loadActiveUsers()">
                            <i class="fas fa-redo"></i> إعادة المحاولة
                        </button>
                    </div>
                `;
            }
        });
}

function updateActiveUsersWidget(users) {
    const container = document.getElementById('activeUsersWidget');

    if (!container) {
        console.error('عنصر activeUsersWidget غير موجود');
        return;
    }

    // التحقق من وجود البيانات
    if (!users || !Array.isArray(users) || users.length === 0) {
        container.innerHTML = `
            <div class="text-center p-3">
                <i class="fas fa-user-slash text-muted" style="font-size: 32px;"></i>
                <p class="text-muted mt-2 mb-0">لا يوجد مستخدمون</p>
                <small class="text-muted">آخر تحديث: ${new Date().toLocaleTimeString('ar-EG')}</small>
            </div>
        `;
        return;
    }

    // تصنيف المستخدمين حسب الحالة
    const onlineUsers = [];
    const offlineUsers = [];

    users.forEach(user => {
        // تحديد الحالة الفعلية بدقة
        const now = new Date();
        const lastSeen = user.last_seen ? new Date(user.last_seen) : null;
        const timeDiff = lastSeen ? (now - lastSeen) / 1000 / 60 : Infinity; // بالدقائق

        // المستخدم متصل إذا:
        // 1. حالته online/away/busy
        // 2. آخر ظهور له خلال آخر 3 دقائق
        const isReallyOnline = (user.status === 'online' || user.status === 'away' || user.status === 'busy') &&
                              timeDiff <= 3;

        if (isReallyOnline) {
            onlineUsers.push({...user, isOnline: true});
        } else {
            offlineUsers.push({...user, isOnline: false});
        }
    });

    // ترتيب المستخدمين: المتصلين أولاً، ثم غير المتصلين
    const sortedUsers = [...onlineUsers, ...offlineUsers];

    if (sortedUsers.length === 0) {
        container.innerHTML = `
            <div class="text-center p-3">
                <i class="fas fa-user-clock text-muted" style="font-size: 32px;"></i>
                <p class="text-muted mt-2 mb-0">لا يوجد مستخدمون</p>
                <small class="text-muted">آخر تحديث: ${new Date().toLocaleTimeString('ar-EG')}</small>
            </div>
        `;
        return;
    }

    container.innerHTML = sortedUsers.map(user => {
        // التأكد من وجود البيانات المطلوبة
        const userName = user.name || user.username || 'مستخدم';
        const userId = user.id || 0;
        const isOnline = user.isOnline;

        // تحديد النص والأيقونة حسب الحالة الفعلية
        let statusText, statusColor, statusIcon;
        if (isOnline) {
            statusText = 'متصل الآن';
            statusColor = '#28a745'; // أخضر
            statusIcon = 'fas fa-circle';
        } else {
            const lastSeen = user.last_seen ? new Date(user.last_seen) : null;
            if (lastSeen) {
                const timeDiff = (new Date() - lastSeen) / 1000 / 60; // بالدقائق
                if (timeDiff < 60) {
                    statusText = `آخر ظهور منذ ${Math.round(timeDiff)} دقيقة`;
                } else if (timeDiff < 1440) {
                    statusText = `آخر ظهور منذ ${Math.round(timeDiff / 60)} ساعة`;
                } else {
                    statusText = `آخر ظهور منذ ${Math.round(timeDiff / 1440)} يوم`;
                }
            } else {
                statusText = 'غير متصل';
            }
            statusColor = '#6c757d'; // رمادي
            statusIcon = 'fas fa-circle';
        }

        return `
            <div class="user-item-widget ${isOnline ? 'user-online' : 'user-offline'}"
                 onclick="showUserContextMenu(event, ${userId}, '${userName}', '${user.username || userName}', ${isOnline})"
                 oncontextmenu="showUserContextMenu(event, ${userId}, '${userName}', '${user.username || userName}', ${isOnline})"
                 style="opacity: ${isOnline ? '1' : '0.7'}; cursor: pointer;">
                <div class="d-flex align-items-center">
                    <div class="user-avatar-small position-relative">
                        ${userName.charAt(0).toUpperCase()}
                        <span class="position-absolute bottom-0 end-0 translate-middle-x"
                              style="width: 12px; height: 12px; background: ${statusColor}; border: 2px solid white; border-radius: 50%;"></span>
                    </div>
                    <div class="ms-2 flex-grow-1">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="mb-0" style="font-size: 14px; color: ${isOnline ? '#000' : '#6c757d'};">${userName}</h6>
                            <i class="${statusIcon}" style="color: ${statusColor}; font-size: 8px;"></i>
                        </div>
                        <small style="color: ${statusColor}; font-size: 11px;">
                            <i class="fas fa-circle" style="font-size: 6px; margin-left: 4px;"></i>
                            ${statusText}
                        </small>
                    </div>
                </div>
            </div>
        `;
    }).join('');

    // إضافة إحصائيات في أسفل القائمة
    const onlineCount = sortedUsers.filter(user => user.isOnline).length;
    const offlineCount = sortedUsers.length - onlineCount;

    container.innerHTML += `
        <div class="users-stats mt-2 p-2 border-top" style="background: #f8f9fa; font-size: 11px;">
            <div class="d-flex justify-content-between text-muted">
                <span><i class="fas fa-circle text-success" style="font-size: 6px;"></i> متصل: ${onlineCount}</span>
                <span><i class="fas fa-circle text-secondary" style="font-size: 6px;"></i> غير متصل: ${offlineCount}</span>
            </div>
            <div class="text-center mt-1">
                <small class="text-muted">آخر تحديث: ${new Date().toLocaleTimeString('ar-EG')}</small>
            </div>
        </div>
    `;

    console.log(`✅ تم تحديث قائمة المستخدمين: ${onlineCount} متصل، ${offlineCount} غير متصل`);
}

function startPrivateChatFromWidget(userId) {
    console.log('فتح محادثة مع المستخدم:', userId);

    // إغلاق قائمة المحادثات
    closeChatWidget();

    // إنشاء/العثور على الغرفة مباشرة
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
                     document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');

    fetch(`/modern-chat/private/${userId}/`, {
        method: 'GET',
        headers: {
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            throw new Error(data.error);
        }

        const roomId = data.room_id;
        console.log('تم العثور على الغرفة:', roomId);

        // الحصول على معلومات المستخدم
        return fetch(`/modern-chat/api/user-info/${userId}/`)
            .then(response => response.json())
            .then(userInfo => {
                console.log('معلومات المستخدم:', userInfo);
                ChatManager.openChat(roomId, userInfo);
            })
            .catch(error => {
                console.error('خطأ في تحميل معلومات المستخدم:', error);
                // استخدام معلومات افتراضية
                ChatManager.openChat(roomId, {
                    id: userId,
                    name: `مستخدم ${userId}`
                });
            });
    })
    .catch(error => {
        console.error('خطأ في إنشاء/العثور على الغرفة:', error);
        alert('خطأ في فتح المحادثة: ' + error.message);
    });
}

async function createOrFindPrivateRoom(userId) {
    try {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
                         document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');

        const response = await fetch(`/modern-chat/private/${userId}/`, {
            method: 'GET',
            headers: {
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            }
        });

        const data = await response.json();

        if (data.error) {
            throw new Error(data.error);
        }

        return data.room_id;
    } catch (error) {
        console.error('خطأ في إنشاء/العثور على الغرفة:', error);
        return null;
    }
}

// دوال النافذة الصغيرة
let currentChatUserId = null;
let currentChatRoomId = null;

function openMiniChat(userId) {
    // إخفاء النافذة الكبيرة
    closeChatWidget();

    currentChatUserId = userId;

    // إظهار النافذة الصغيرة
    const miniWindow = document.getElementById('miniChatWindow');
    miniWindow.style.display = 'flex';

    // تحميل بيانات المستخدم
    loadUserDataForMiniChat(userId);

    // إنشاء أو العثور على غرفة الدردشة
    createOrFindPrivateRoom(userId);
}

function createOrFindPrivateRoom(userId) {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
                     document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');

    fetch(`/modern-chat/private/${userId}/`, {
        method: 'GET',
        headers: {
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            throw new Error(data.error);
        }

        if (data.room_id) {
            currentChatRoomId = data.room_id;

            // تحديث معلومات المستخدم في النافذة
            if (data.other_user) {
                document.getElementById('miniChatUserInitial').textContent =
                    data.other_user.name.charAt(0).toUpperCase();
                document.getElementById('miniChatUserName').textContent = data.other_user.name;
                document.getElementById('miniChatUserStatus').textContent = 'متصل';
            }

            loadMiniChatMessages(data.room_id);
            startMessagePolling();
        }
    })
    .catch(error => {
        console.error('خطأ في إنشاء الغرفة:', error);
        alert('خطأ في إنشاء المحادثة: ' + error.message);
    });
}

function loadUserDataForMiniChat(userId) {
    // الحصول على بيانات المستخدم من API
    fetch(`/modern-chat/api/user-info/${userId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('خطأ في تحميل بيانات المستخدم:', data.error);
                return;
            }

            // تحديث واجهة النافذة الصغيرة
            document.getElementById('miniChatUserInitial').textContent =
                data.name.charAt(0).toUpperCase();
            document.getElementById('miniChatUserName').textContent = data.name;

            // تحديث حالة المستخدم
            const statusText = {
                'online': 'متصل',
                'away': 'غائب',
                'busy': 'مشغول',
                'offline': 'غير متصل'
            };
            document.getElementById('miniChatUserStatus').textContent =
                statusText[data.status] || 'غير معروف';


        })
        .catch(error => {
            console.error('خطأ في تحميل بيانات المستخدم:', error);
            // قيم افتراضية في حالة الخطأ
            document.getElementById('miniChatUserInitial').textContent = 'U';
            document.getElementById('miniChatUserName').textContent = 'مستخدم';
            document.getElementById('miniChatUserStatus').textContent = 'غير معروف';
        });
}

function loadMiniChatMessages(roomId) {
    if (!roomId) return;

    fetch(`/modern-chat/api/messages/${roomId}/`)
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('miniChatMessages');
            container.innerHTML = '';

            if (data.messages && data.messages.length > 0) {
                data.messages.forEach(message => {
                    addMiniChatMessage(message.content, message.sender.is_current_user, message.created_at);
                });
                // تحديث عداد الرسائل المهم جداً!
                lastMessageCount = data.messages.length;
                console.log('تم تحديث lastMessageCount إلى:', lastMessageCount);
            } else {
                container.innerHTML = `
                    <div class="text-center text-muted p-3">
                        <i class="fas fa-comments fa-2x mb-2"></i>
                        <p class="mb-0">ابدأ المحادثة</p>
                    </div>
                `;
                lastMessageCount = 0;
            }

            // تحديد الرسائل كمقروءة عند فتح النافذة
            markMessagesAsRead(roomId);
        })
        .catch(error => {
            console.error('خطأ في تحميل الرسائل:', error);
        });
}

function sendMiniChatMessage() {
    const input = document.getElementById('miniChatInput');
    const message = input.value.trim();

    if (!message || !currentChatRoomId || input.disabled) return;

    // تعطيل الإدخال مؤقتاً
    input.disabled = true;

    // إرسال عبر WebSocket إذا كان متصلاً
    if (ChatManager.isConnected) {
        sendWebSocketMessage({
            type: 'send_message',
            room_id: currentChatRoomId,
            content: message
        });

        // لا نضيف الرسالة فوراً - ننتظر تأكيد الخادم عبر WebSocket
        // addMiniChatMessage(message, true); // تم تعطيله لتجنب التكرار
        input.value = '';

        // التأكد من أن النافذة مفتوحة
        const miniWindow = document.getElementById('miniChatWindow');
        if (miniWindow.style.display !== 'flex') {
            miniWindow.style.display = 'flex';
            console.log('تم فتح النافذة تلقائياً بعد إرسال الرسالة');
        }

        // تحديث عداد الرسائل
        lastMessageCount++;

        input.disabled = false;
        input.focus();
    } else {
        // استخدام HTTP كبديل
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
                         document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');

        fetch('/modern-chat/api/send-message/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                room_id: currentChatRoomId,
                content: message
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }

            // لا نضيف الرسالة هنا - ننتظر تأكيد الخادم عبر WebSocket
            // addMiniChatMessage(message, true); // تم تعطيله لتجنب التكرار
            input.value = '';

            // التأكد من أن النافذة مفتوحة
            const miniWindow = document.getElementById('miniChatWindow');
            if (miniWindow.style.display !== 'flex') {
                miniWindow.style.display = 'flex';
                console.log('تم فتح النافذة تلقائياً بعد إرسال الرسالة');
            }

            // تحديث عداد الرسائل
            lastMessageCount++;
            console.log('تم إرسال الرسالة عبر HTTP');
        })
        .catch(error => {
            console.error('خطأ في إرسال الرسالة:', error);
            alert('خطأ في إرسال الرسالة: ' + error.message);
        })
        .finally(() => {
            input.disabled = false;
            input.focus();
        });
    }
}

function addMiniChatMessage(content, isOwn = false, timestamp = null) {
    const container = document.getElementById('miniChatMessages');

    // فحص التكرار قبل الإضافة
    const existingMessages = container.querySelectorAll('.message');
    for (let msg of existingMessages) {
        const msgContent = msg.querySelector('.message-content');
        if (msgContent && msgContent.textContent.trim() === content.trim()) {
            // فحص إضافي للوقت إذا كان متاحاً
            const msgTime = msg.querySelector('.message-time');
            if (msgTime && timestamp) {
                const existingTime = new Date(msgTime.getAttribute('data-timestamp') || msgTime.textContent);
                const newTime = new Date(timestamp);
                const timeDiff = Math.abs(existingTime - newTime);

                // إذا كان الفرق أقل من 10 ثوان، اعتبرها نفس الرسالة
                if (timeDiff < 10000) {
                    console.log('رسالة مكررة تم تجاهلها:', content);
                    return;
                }
            } else if (!timestamp) {
                // إذا لم يكن هناك وقت، اعتمد على المحتوى فقط
                console.log('رسالة مكررة تم تجاهلها (بدون وقت):', content);
                return;
            }
        }
    }

    // إزالة رسالة "ابدأ المحادثة" إذا كانت موجودة
    const emptyMessage = container.querySelector('.text-center');
    if (emptyMessage) {
        emptyMessage.remove();
    }

    const messageElement = document.createElement('div');
    messageElement.className = `mini-message ${isOwn ? 'own' : ''}`;

    // إضافة معرف فريد للرسالة
    const messageId = 'mini_msg_' + Date.now() + '_' + Math.random();
    messageElement.setAttribute('data-message-id', messageId);

    let time;
    if (timestamp) {
        time = new Date(timestamp).toLocaleTimeString('ar-EG', {
            hour: '2-digit',
            minute: '2-digit'
        });
    } else {
        time = new Date().toLocaleTimeString('ar-EG', {
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    messageElement.innerHTML = `
        <div class="mini-message-content message-content">
            ${content}
            <div class="mini-message-time message-time" data-timestamp="${timestamp || new Date().toISOString()}">${time}</div>
        </div>
    `;

    container.appendChild(messageElement);
    container.scrollTop = container.scrollHeight;

    // إضافة تأثير بصري للرسالة الجديدة
    if (!timestamp) { // رسالة جديدة
        messageElement.style.opacity = '0';
        messageElement.style.transform = 'translateY(10px)';
        setTimeout(() => {
            messageElement.style.transition = 'all 0.3s ease';
            messageElement.style.opacity = '1';
            messageElement.style.transform = 'translateY(0)';
        }, 10);
    }
}

let typingTimer = null;
let isTyping = false;

function handleMiniChatEnter(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMiniChatMessage();
        stopTyping();
    }
}

function handleTyping() {
    if (!ChatManager.isConnected || !currentChatRoomId) {
        return;
    }

    // إرسال مؤشر بدء الكتابة
    if (!isTyping) {
        isTyping = true;
        sendWebSocketMessage({
            type: 'typing_start',
            room_id: currentChatRoomId
        });
    }

    // إعادة تعيين المؤقت
    clearTimeout(typingTimer);
    typingTimer = setTimeout(() => {
        stopTyping();
    }, 2000); // توقف الكتابة بعد ثانيتين من عدم النشاط
}

function stopTyping() {
    if (isTyping && ChatManager.isConnected && currentChatRoomId) {
        isTyping = false;
        sendWebSocketMessage({
            type: 'typing_stop',
            room_id: currentChatRoomId
        });
    }

    clearTimeout(typingTimer);
}

function minimizeMiniChat() {
    const miniWindow = document.getElementById('miniChatWindow');
    miniWindow.style.display = 'none';
    // يمكن إضافة حالة مصغرة هنا
}

let messagePollingInterval = null;
let lastMessageCount = 0;

function startMessagePolling() {
    // إيقاف التحديث السابق إن وجد
    if (messagePollingInterval) {
        clearInterval(messagePollingInterval);
    }

    // تحديث الرسائل كل 5 ثوان فقط عند فتح النافذة
    messagePollingInterval = setInterval(() => {
        if (currentChatRoomId && document.getElementById('miniChatWindow').style.display === 'flex') {
            checkForNewMessages();
        }
    }, 5000);
}

let isCheckingMessages = false;

function checkForNewMessages() {
    if (!currentChatRoomId || isCheckingMessages) return;

    isCheckingMessages = true;

    fetch(`/modern-chat/api/messages/${currentChatRoomId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.messages && data.messages.length > lastMessageCount) {
                console.log(`رسائل جديدة: ${data.messages.length - lastMessageCount}`);

                // هناك رسائل جديدة
                const newMessages = data.messages.slice(lastMessageCount);
                let hasNewMessagesFromOthers = false;

                newMessages.forEach(message => {
                    if (!message.sender.is_current_user) {
                        // رسالة من مستخدم آخر
                        addMiniChatMessage(message.content, false, message.created_at);
                        showNewMessageNotification(message);
                        hasNewMessagesFromOthers = true;
                        console.log('رسالة جديدة من:', message.sender.name);
                    } else {
                        console.log('رسالة من المستخدم الحالي، تم تجاهلها');
                    }
                });

                lastMessageCount = data.messages.length;

                // تحديد الرسائل كمقروءة إذا كانت النافذة مفتوحة
                if (hasNewMessagesFromOthers &&
                    document.getElementById('miniChatWindow').style.display === 'flex') {
                    markMessagesAsRead(currentChatRoomId);
                }
            }
        })
        .catch(error => {
            console.error('خطأ في فحص الرسائل الجديدة:', error);
        })
        .finally(() => {
            isCheckingMessages = false;
        });
}

function showNewMessageNotification(message) {
    // لا نشغل الصوت هنا - يتم تشغيله في ChatManager.handleIncomingMessage
    // playNotificationSound(); // تم تعطيله لتجنب التكرار

    // إظهار إشعار الرسالة الجديدة
    const notification = document.createElement('div');
    notification.className = 'new-message-notification';
    notification.innerHTML = `
        <i class="fas fa-comment"></i>
        رسالة جديدة من ${message.sender.name}
    `;

    // إضافة حدث النقر لفتح النافذة وإخفاء الإشعار
    notification.onclick = () => {
        // فتح النافذة إذا لم تكن مفتوحة
        const miniWindow = document.getElementById('miniChatWindow');
        if (miniWindow.style.display !== 'flex') {
            openMiniChatForRoom(currentChatRoomId);
        }
        // إزالة الإشعار
        notification.remove();
        // تحديد الرسائل كمقروءة
        markMessagesAsRead(currentChatRoomId);
    };

    document.body.appendChild(notification);

    // إزالة الإشعار بعد 5 ثوان
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);

    // تحديث عداد الإشعارات
    updateNotificationBadge();

    // فتح النافذة الصغيرة تلقائياً إذا لم تكن مفتوحة
    const miniWindow = document.getElementById('miniChatWindow');
    if (miniWindow.style.display !== 'flex') {
        console.log('فتح النافذة تلقائياً لرسالة جديدة');
        openMiniChatForRoom(currentChatRoomId);
    }
}

function updateNotificationBadge() {
    const badge = document.getElementById('chatNotificationBadge');
    if (badge) {
        badge.style.display = 'flex';
        badge.textContent = '!';
    }
}

function closeMiniChat() {
    const miniWindow = document.getElementById('miniChatWindow');
    miniWindow.style.display = 'none';

    // مغادرة الغرفة عبر WebSocket
    if (ChatManager.isConnected && currentChatRoomId) {
        sendWebSocketMessage({
            type: 'leave_room',
            room_id: currentChatRoomId
        });
    }

    // إيقاف مؤشر الكتابة
    stopTyping();

    // إيقاف التحديث الدوري
    if (messagePollingInterval) {
        clearInterval(messagePollingInterval);
        messagePollingInterval = null;
    }

    // إعادة تعيين المتغيرات
    currentChatUserId = null;
    currentChatRoomId = null;
    lastMessageCount = 0;
}

function toggleChatMute() {
    if (!currentChatRoomId) return;

    const muteButton = document.getElementById('muteChatButton');
    const icon = muteButton.querySelector('i');

    if (ChatManager.mutedChats.has(currentChatRoomId)) {
        // إلغاء كتم المحادثة
        ChatManager.mutedChats.delete(currentChatRoomId);
        icon.className = 'fas fa-volume-up';
        muteButton.title = 'كتم الصوت';

        // إظهار رسالة
        showToast('تم إلغاء كتم الصوت للمحادثة', 'success');
    } else {
        // كتم المحادثة
        ChatManager.mutedChats.add(currentChatRoomId);
        icon.className = 'fas fa-volume-mute';
        muteButton.title = 'إلغاء كتم الصوت';

        // إظهار رسالة
        showToast('تم كتم الصوت للمحادثة', 'info');
    }

    // حفظ الإعدادات في localStorage
    localStorage.setItem('mutedChats', JSON.stringify([...ChatManager.mutedChats]));
    // حفظ في chatSettings أيضاً
    const settings = JSON.parse(localStorage.getItem('chatSettings') || '{}');
    settings.mutedChats = [...ChatManager.mutedChats];
    localStorage.setItem('chatSettings', JSON.stringify(settings));
}

function loadMuteSettings() {
    // تحميل إعدادات الكتم من localStorage
    const saved = localStorage.getItem('mutedChats');
    if (saved) {
        try {
            const mutedArray = JSON.parse(saved);
            if (ChatManager && ChatManager.mutedChats) {
                ChatManager.mutedChats = new Set(mutedArray);
            }
        } catch (e) {
            console.error('خطأ في تحميل إعدادات الكتم:', e);
            if (ChatManager && ChatManager.mutedChats) {
                ChatManager.mutedChats = new Set();
            }
        }
    }
}

function updateMuteButtonState() {
    if (!currentChatRoomId) return;

    const muteButton = document.getElementById('muteChatButton');
    if (!muteButton) return;

    const icon = muteButton.querySelector('i');

    if (ChatManager.mutedChats.has(currentChatRoomId)) {
        icon.className = 'fas fa-volume-mute';
        muteButton.title = 'إلغاء كتم الصوت';
    } else {
        icon.className = 'fas fa-volume-up';
        muteButton.title = 'كتم الصوت';
    }
}

function showToast(message, type = 'info') {
    // إنشاء toast notification بسيط
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} position-fixed`;
    toast.style.cssText = `
        top: 20px;
        right: 20px;
        z-index: 9999;
        min-width: 250px;
        animation: slideInRight 0.3s ease;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    `;
    toast.textContent = message;

    document.body.appendChild(toast);

    // إزالة التوست بعد 3 ثوان
    setTimeout(() => {
        toast.style.animation = 'slideOutRight 0.3s ease';
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 300);
    }, 3000);
}

// تم نقل جميع وظائف الصوت إلى ChatManager

// تم نقل هذه الدالة إلى ChatManager.playNotificationSound

// تم نقل هذه الدالة إلى ChatManager.createFallbackAudio

function markMessagesAsRead(roomId) {
    if (!roomId) return;

    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
                     document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');

    fetch(`/modern-chat/api/mark-read/${roomId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // إخفاء عداد الإشعارات فوراً
            hideChatNotificationBadge();

            // إرسال إشعار عبر WebSocket أن الرسائل تم قراءتها
            if (ChatManager.isConnected && ChatManager.socket) {
                ChatManager.socket.send(JSON.stringify({
                    type: 'messages_read',
                    room_id: roomId
                }));
            }
        }
    })
    .catch(error => {
        console.error('خطأ في تحديد الرسائل كمقروءة:', error);
    });
}

function openMiniChatForRoom(roomId, senderInfo = null) {
    if (!roomId) return;

    // إظهار النافذة الصغيرة بقوة
    const miniWindow = document.getElementById('miniChatWindow');
    if (!miniWindow) {
        console.error('❌ نافذة الدردشة المصغرة غير موجودة!');
        return;
    }

    // إظهار النافذة بقوة مع جميع الخصائص
    miniWindow.style.display = 'flex';
    miniWindow.style.visibility = 'visible';
    miniWindow.style.opacity = '1';
    miniWindow.style.zIndex = '1055';

    // تحديث معرف الغرفة
    currentChatRoomId = roomId;

    // إخفاء عداد الإشعارات فوراً
    hideChatNotificationBadge();

    // تحديث حالة زر الكتم
    updateMuteButtonState();

    // إذا كانت معلومات المرسل متوفرة، استخدمها
    if (senderInfo) {
        document.getElementById('miniChatUserInitial').textContent =
            senderInfo.name ? senderInfo.name.charAt(0).toUpperCase() : '?';
        document.getElementById('miniChatUserName').textContent =
            senderInfo.name || 'مستخدم غير معروف';
        document.getElementById('miniChatUserStatus').textContent = 'متصل';

        // تحديث معرف المستخدم الحالي
        currentChatUserId = senderInfo.id;
    } else {
        // محاولة الحصول على معلومات الغرفة من الخادم
        fetch(`/modern-chat/api/room-info/${roomId}/`)
            .then(response => response.json())
            .then(data => {
                if (data.other_user) {
                    document.getElementById('miniChatUserInitial').textContent =
                        data.other_user.name.charAt(0).toUpperCase();
                    document.getElementById('miniChatUserName').textContent = data.other_user.name;
                    document.getElementById('miniChatUserStatus').textContent = 'متصل';
                    currentChatUserId = data.other_user.id;
                }
            })
            .catch(error => {
                console.error('خطأ في تحميل معلومات الغرفة:', error);
                // استخدام قيم افتراضية
                document.getElementById('miniChatUserInitial').textContent = '?';
                document.getElementById('miniChatUserName').textContent = 'مستخدم غير معروف';
                document.getElementById('miniChatUserStatus').textContent = 'غير معروف';
                currentChatUserId = null; // تأكيد أنه null
            });
    }

    // الانضمام للغرفة عبر WebSocket
    if (ChatManager.isConnected) {
        sendWebSocketMessage({
            type: 'join_room',
            room_id: roomId
        });
    }

    // تحميل الرسائل
    loadMiniChatMessages(roomId);

    // بدء التحديث الدوري (كنسخة احتياطية)
    startMessagePolling();

    // تحديد الرسائل كمقروءة
    if (ChatManager.isConnected) {
        sendWebSocketMessage({
            type: 'mark_read',
            room_id: roomId
        });
    }
}

function openFullChatFromMini() {
    // لا نحتاج هذه الدالة بعد الآن - تم إزالة الشاشة الكبيرة
    alert('تم إزالة شاشة المحادثة الكبيرة. استخدم النافذة الصغيرة فقط.');
}

// متغيرات قائمة السياق
let contextMenuUserId = null;
let contextMenuUserName = '';
let contextMenuUsername = '';
let contextMenuRoomId = null;

// متغيرات كتم الصوت (تم نقلها إلى ChatManager)
let isChatMuted = false;

// دوال قائمة السياق
function showUserContextMenu(event, userId, userName, username, isOnline = false) {
    event.preventDefault();
    event.stopPropagation();

    contextMenuUserId = userId;
    contextMenuUserName = userName;
    contextMenuUsername = username;

    const contextMenu = document.getElementById('userContextMenu');

    // تحديث خيارات القائمة حسب حالة الاتصال
    const chatItem = contextMenu.querySelector('.context-menu-item[onclick="startPrivateChat()"]');
    const profileItem = contextMenu.querySelector('.context-menu-item[onclick="viewUserProfile()"]');

    if (chatItem) {
        if (isOnline) {
            chatItem.style.display = 'block';
            chatItem.innerHTML = `<i class="fas fa-comments me-2 text-success"></i>بدء محادثة مع ${userName}`;
            chatItem.style.color = '#28a745';
        } else {
            chatItem.style.display = 'none';
        }
    }

    if (profileItem) {
        profileItem.style.display = 'block';
        if (isOnline) {
            profileItem.innerHTML = `<i class="fas fa-user me-2 text-primary"></i>عرض ملف ${userName} (متصل)`;
        } else {
            profileItem.innerHTML = `<i class="fas fa-user me-2 text-muted"></i>عرض ملف ${userName} (غير متصل)`;
        }
    }

    contextMenu.style.display = 'block';
    contextMenu.style.left = event.pageX + 'px';
    contextMenu.style.top = event.pageY + 'px';

    // إخفاء القائمة عند النقر في أي مكان آخر
    setTimeout(() => {
        document.addEventListener('click', hideContextMenu);
    }, 10);
}

function hideContextMenu() {
    const contextMenu = document.getElementById('userContextMenu');
    contextMenu.style.display = 'none';
    document.removeEventListener('click', hideContextMenu);
}

function showRoomContextMenu(event, roomId, otherUserId, roomName) {
    event.preventDefault();
    event.stopPropagation();

    // تحديث متغيرات السياق
    contextMenuUserId = otherUserId;
    contextMenuUserName = roomName;
    contextMenuUsername = roomName;
    contextMenuRoomId = roomId;

    const contextMenu = document.getElementById('userContextMenu');

    // تحديث النص في القائمة
    const deleteItem = contextMenu.querySelector('.context-menu-item[onclick="deleteConversation()"]');
    if (deleteItem) {
        deleteItem.innerHTML = `<i class="fas fa-trash me-2"></i>حذف المحادثة مع ${roomName}`;
    }

    // إخفاء خيارات غير مناسبة للمحادثات
    const profileItem = contextMenu.querySelector('.context-menu-item[onclick="viewUserProfile()"]');
    const chatItem = contextMenu.querySelector('.context-menu-item[onclick="startPrivateChat()"]');

    if (profileItem) profileItem.style.display = 'block';
    if (chatItem) chatItem.style.display = 'none'; // إخفاء "بدء محادثة" لأننا في المحادثة

    // تحديد موقع القائمة
    const rect = event.target.getBoundingClientRect();
    const menuWidth = 200;
    const menuHeight = 160;

    let left = event.clientX;
    let top = event.clientY;

    // التأكد من عدم خروج القائمة من الشاشة
    if (left + menuWidth > window.innerWidth) {
        left = window.innerWidth - menuWidth - 10;
    }

    if (top + menuHeight > window.innerHeight) {
        top = window.innerHeight - menuHeight - 10;
    }

    contextMenu.style.left = left + 'px';
    contextMenu.style.top = top + 'px';
    contextMenu.style.display = 'block';

    // إضافة listener لإخفاء القائمة عند النقر خارجها
    setTimeout(() => {
        document.addEventListener('click', hideContextMenu);
    }, 10);
}

function viewUserProfile() {
    hideContextMenu();
    if (contextMenuUserId) {
        // عرض معلومات المستخدم في modal مباشرة
        showUserInfoModal(contextMenuUserId, contextMenuUserName, contextMenuUsername);
    }
}

function startPrivateChat() {
    hideContextMenu();
    if (contextMenuUserId) {
        startPrivateChatFromWidget(contextMenuUserId);
    }
}

function showUserInfoModal(userId, userName, username) {
    // إنشاء modal لعرض معلومات المستخدم
    const modalId = 'userInfoModal';

    // إزالة modal السابق إن وجد
    const existingModal = document.getElementById(modalId);
    if (existingModal) {
        existingModal.remove();
    }

    const modal = document.createElement('div');
    modal.id = modalId;
    modal.className = 'modal fade';
    modal.innerHTML = `
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-user me-2"></i>
                        معلومات المستخدم
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center">
                        <div class="user-avatar-large mb-3">
                            ${userName.charAt(0).toUpperCase()}
                        </div>
                        <h4 class="mb-2">${userName}</h4>
                        <p class="text-muted mb-3">@${username}</p>
                        <p class="text-muted mb-4">معرف المستخدم: ${userId}</p>

                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" onclick="startPrivateChatFromWidget(${userId}); bootstrap.Modal.getInstance(document.getElementById('${modalId}')).hide();">
                                <i class="fas fa-comments me-2"></i>
                                بدء محادثة خاصة
                            </button>
                            <button class="btn btn-outline-secondary" onclick="copyUserInfo('${userName}', '${username}', ${userId})">
                                <i class="fas fa-copy me-2"></i>
                                نسخ معلومات المستخدم
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;

    document.body.appendChild(modal);

    // إضافة CSS للـ avatar الكبير
    if (!document.getElementById('userModalStyles')) {
        const style = document.createElement('style');
        style.id = 'userModalStyles';
        style.textContent = `
            .user-avatar-large {
                width: 80px;
                height: 80px;
                border-radius: 50%;
                background: linear-gradient(135deg, #007bff, #0056b3);
                color: white;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 32px;
                font-weight: bold;
                margin: 0 auto;
                box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            }
        `;
        document.head.appendChild(style);
    }

    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();

    // إزالة modal عند الإغلاق
    modal.addEventListener('hidden.bs.modal', () => {
        modal.remove();
    });
}

function copyUserInfo(userName, username, userId) {
    const userInfo = `الاسم: ${userName}\nاسم المستخدم: @${username}\nالمعرف: ${userId}`;

    if (navigator.clipboard) {
        navigator.clipboard.writeText(userInfo).then(() => {
            showToast('تم نسخ معلومات المستخدم', 'success');
        });
    } else {
        // fallback للمتصفحات القديمة
        const textArea = document.createElement('textarea');
        textArea.value = userInfo;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showToast('تم نسخ معلومات المستخدم', 'success');
    }
}

function deleteConversation() {
    hideContextMenu();

    // استخدام room_id إذا كان متاحاً، وإلا استخدم user_id
    const requestData = contextMenuRoomId ?
        { room_id: contextMenuRoomId } :
        { user_id: contextMenuUserId };

    if (contextMenuUserId || contextMenuRoomId) {
        if (confirm(`هل أنت متأكد من حذف المحادثة مع ${contextMenuUserName}؟\n\nسيتم حذف جميع الرسائل نهائياً ولا يمكن استرجاعها.`)) {
            // إرسال طلب حذف المحادثة
            fetch('/modern-chat/api/delete-conversation/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(requestData)
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            })
            .then(data => {
                if (data.success) {
                    showToast('تم حذف المحادثة بنجاح', 'success');

                    // إغلاق نافذة الدردشة إذا كانت مفتوحة
                    const miniWindow = document.getElementById('miniChatWindow');
                    if (miniWindow && miniWindow.style.display !== 'none') {
                        miniWindow.style.display = 'none';
                    }

                    // إغلاق نافذة ChatManager إذا كانت مفتوحة
                    if (contextMenuRoomId && ChatManager.openChats.has(contextMenuRoomId)) {
                        ChatManager.closeChat(contextMenuRoomId);
                    }

                    // تحديث القوائم فوراً باستخدام النظام الجديد
                    ChatManager.refreshUserListAfterDelete();

                    // تحديث قائمة المستخدمين النشطين
                    updateActiveUsersWidget();
                } else {
                    // حتى لو كان success: false، قد تكون المحادثة محذوفة فعلاً
                    if (data.error && data.error.includes('لا توجد محادثة')) {
                        showToast('المحادثة محذوفة بالفعل', 'success');

                        // تحديث القوائم
                        ChatManager.refreshUserListAfterDelete();
                        updateUserRoomsWidget();
                        updateActiveUsersWidget();
                    } else {
                        showToast('فشل في حذف المحادثة: ' + (data.error || 'خطأ غير معروف'), 'error');
                    }
                }
            })
            .catch(error => {
                console.error('خطأ في حذف المحادثة:', error);
                showToast('حدث خطأ أثناء حذف المحادثة', 'error');
            });
        }
    }
}

function blockUser() {
    hideContextMenu();
    if (contextMenuUserId) {
        if (confirm(`هل أنت متأكد من حظر المستخدم ${contextMenuUserName}؟`)) {
            // إرسال طلب حظر المستخدم
            fetch('/modern-chat/api/block-user/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    user_id: contextMenuUserId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast(`تم حظر المستخدم ${contextMenuUserName} بنجاح`, 'success');

                    // إزالة المستخدم من القوائم
                    updateActiveUsersWidget();
                    updateUserRoomsWidget();
                } else {
                    showToast('فشل في حظر المستخدم: ' + (data.error || 'خطأ غير معروف'), 'error');
                }
            })
            .catch(error => {
                console.error('خطأ في حظر المستخدم:', error);
                showToast('حدث خطأ أثناء حظر المستخدم', 'error');
            });
        }
    }
}

function getStatusText(status) {
    const statusMap = {
        'online': 'متصل',
        'away': 'غائب',
        'busy': 'مشغول',
        'offline': 'غير متصل'
    };
    return statusMap[status] || 'غير معروف';
}

function showToast(message, type = 'info') {
    // إنشاء toast container إذا لم يكن موجوداً
    let toastContainer = document.getElementById('toastContainer');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toastContainer';
        toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
        toastContainer.style.zIndex = '9999';
        document.body.appendChild(toastContainer);
    }

    // إنشاء toast
    const toastId = 'toast_' + Date.now();
    const toast = document.createElement('div');
    toast.id = toastId;
    toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'primary'} border-0`;
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;

    toastContainer.appendChild(toast);

    // إظهار toast
    const bsToast = new bootstrap.Toast(toast, {
        autohide: true,
        delay: type === 'error' ? 5000 : 3000
    });
    bsToast.show();

    // إزالة toast بعد الإخفاء
    toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// تحديث البيانات عند الحاجة فقط
let lastActiveUsersUpdate = 0;
setInterval(function() {
    // تحديث المستخدمين النشطين فقط إذا كانت النافذة مفتوحة ومرت 3 دقائق على آخر تحديث
    if (chatWidgetVisible && !chatWidgetMinimized &&
        (Date.now() - lastActiveUsersUpdate) > 180000) {
        loadActiveUsers();
        lastActiveUsersUpdate = Date.now();
    }
}, 60000);

// فحص الرسائل الجديدة للمستخدم الحالي
let globalMessageCheckInterval = null;

function startGlobalMessageCheck() {
    if (globalMessageCheckInterval) {
        clearInterval(globalMessageCheckInterval);
    }

    globalMessageCheckInterval = setInterval(() => {
        checkForNewMessagesGlobal();
    }, 30000); // فحص كل 30 ثانية
}

let isCheckingGlobalMessages = false;

function checkForNewMessagesGlobal() {
    // تجنب الطلبات المتكررة
    if (isCheckingGlobalMessages) return;

    isCheckingGlobalMessages = true;

    // فحص الرسائل الجديدة في جميع الغرف
    fetch('/modern-chat/api/check-new-messages/', {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.has_new_messages) {
            // إظهار إشعار وفتح النافذة
            showGlobalNewMessageNotification(data);

            // فتح النافذة تلقائياً إذا لم تكن مفتوحة
            if (!chatWidgetVisible && document.getElementById('miniChatWindow').style.display !== 'flex') {
                // لا نفتح تلقائياً، فقط نظهر الإشعار
                console.log('رسائل جديدة متاحة');
            }
        }
    })
    .catch(error => {
        console.error('خطأ في فحص الرسائل الجديدة:', error);
    })
    .finally(() => {
        isCheckingGlobalMessages = false;
    });
}

function showGlobalNewMessageNotification(data) {
    const notification = document.createElement('div');
    notification.className = 'global-message-notification';
    notification.innerHTML = `
        <div class="notification-content">
            <i class="fas fa-envelope"></i>
            <div class="notification-text">
                <strong>رسائل جديدة (${data.new_message_count})</strong>
                <small>انقر لفتح الدردشة</small>
            </div>
        </div>
    `;

    notification.onclick = () => {
        // فتح النافذة إذا لم تكن مفتوحة
        if (!chatWidgetVisible) {
            toggleChatWidget();
        }
        // إذا كانت مفتوحة ومصغرة، إظهارها
        else if (chatWidgetMinimized) {
            const widget = document.getElementById('chatWidget');
            widget.style.display = 'flex';
            chatWidgetMinimized = false;
        }

        // إخفاء عداد الإشعارات
        const badge = document.getElementById('chatNotificationBadge');
        if (badge) {
            badge.style.display = 'none';
        }

        notification.remove();
    };

    document.body.appendChild(notification);

    // إزالة الإشعار بعد 5 ثوان
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);

    // تحديث عداد الإشعارات
    const badge = document.getElementById('chatNotificationBadge');
    if (badge) {
        badge.style.display = 'flex';
        badge.textContent = data.new_message_count;
    }
}

// بدء فحص الرسائل عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', function() {
    startGlobalMessageCheck();
    // تم نقل تهيئة الأصوات إلى ChatManager.init()

    // طلب إذن الإشعارات
    if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
    }
});

// تحديث حالة المستخدم
function updateUserStatus() {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
                     document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');

    if (!csrfToken) {
        console.warn('CSRF token not found');
        return;
    }

    fetch('/modern-chat/api/update-status/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            status: 'online'
        })
    })
    .then(response => {
        return response.json();
    })
    .catch(error => console.error('Error updating status:', error));
}

// تحديث الحالة كل 60 ثانية فقط (تقليل التحديثات)
setInterval(updateUserStatus, 60000);

// تحديث قائمة المستخدمين عبر WebSocket فقط - لا حاجة للتحديث الدوري
// setInterval(loadActiveUsers, 30000); // تم تعطيله - يتم التحديث عبر WebSocket

// طلب إذن الإشعارات
if ('Notification' in window && Notification.permission === 'default') {
    Notification.requestPermission();
}

// دالة تبديل التبويبات
function switchChatTab(tabId, buttonElement) {
    // إزالة active من جميع الأزرار
    const allButtons = document.querySelectorAll('.chat-widget-tabs .nav-link');
    allButtons.forEach(btn => btn.classList.remove('active'));

    // إضافة active للزر المضغوط
    buttonElement.classList.add('active');

    // إخفاء جميع التبويبات
    const allTabs = document.querySelectorAll('.tab-pane');
    allTabs.forEach(tab => {
        tab.classList.remove('show', 'active');
    });

    // إظهار التبويب المطلوب
    const targetTab = document.getElementById(tabId);
    if (targetTab) {
        targetTab.classList.add('show', 'active');

        // تحديث البيانات حسب التبويب
        if (tabId === 'activeUsers') {
            // تحديث قائمة المستخدمين النشطين
            loadActiveUsers();
        }
    }
}

// إصلاح مشكلة المستخدمين النشطين - تحديث دوري أقل تكراراً
let lastUserStatusCheck = 0;
function updateUserStatusPeriodically() {
    const now = Date.now();
    // تحديث كل دقيقتين فقط لتقليل الحمل
    if (now - lastUserStatusCheck > 120000) {
        lastUserStatusCheck = now;
        if (typeof loadActiveUsers === 'function') {
            loadActiveUsers();
        }
    }
}

// تحديث المستخدمين كل دقيقتين بدلاً من كل 15 ثانية
setInterval(updateUserStatusPeriodically, 120000);

// تحميل البيانات الأولية للتبويب الافتراضي
document.addEventListener('DOMContentLoaded', function() {
    // تحميل المستخدمين النشطين عند بدء التشغيل
    loadActiveUsers();
});
</script>
