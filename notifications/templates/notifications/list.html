{% extends 'base.html' %}
{% load static %}
{% csrf_token %}
{% block title %}الإشعارات{% endblock %}
{% block extra_head %}
    <style>
/* ===== صفحة الإشعارات ===== */
.notifications-page { margin-top: 100px; }

/* بطاقة الإشعار */
.notification-item {
    transition: all 0.2s ease;
    border-right: 4px solid transparent;
    cursor: pointer;
}
.notification-item:last-child { border-bottom: none !important; }
.notification-item:hover {
    background-color: #f8f9fa !important;
    transform: translateX(2px);
}

/* غير مقروء */
.notification-item.unread {
    background-color: #f0f7ff !important;
    border-right-color: #0d6efd;
}

/* مقروء */
.notification-item.read {
    background-color: #fff;
    border-right-color: #dee2e6;
    opacity: 0.85;
}

/* أولويات */
.notification-item.priority-urgent { border-right-color: #dc3545 !important; }
.notification-item.priority-high   { border-right-color: #fd7e14 !important; }
.notification-item.priority-normal  { border-right-color: #0d6efd; }
.notification-item.priority-low    { border-right-color: #6c757d; }

/* أيقونة الإشعار */
.notif-icon {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}
.notif-icon i { font-size: 16px; }
.notification-item.read .notif-icon { opacity: 0.6; }

/* محتوى الإشعار */
.notif-body { flex: 1; min-width: 0; }
.notif-body h6 { font-size: 0.9rem; line-height: 1.4; }
.notif-body p  { font-size: 0.82rem; line-height: 1.5; }

/* إحصائيات */
.stats-row .stat-box {
    text-align: center;
    padding: 1rem 0.5rem;
}
.stats-row .stat-box h4 {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 0.25rem;
}
.stats-row .stat-box small {
    font-size: 0.78rem;
    opacity: 0.9;
}
    </style>
{% endblock %}
{% block content %}
    <div class="container-fluid notifications-page">
        <!-- عنوان الصفحة -->
        <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
            <h1 class="h4 mb-0">
                <i class="fas fa-bell text-primary me-2"></i>الإشعارات
            </h1>
            {% if unread_count > 0 %}
                <div class="d-flex gap-2">
                    <button type="button"
                            class="btn btn-outline-primary btn-sm"
                            id="mark-all-read-ajax-btn"
                            title="تحديد سريع بدون إعادة تحميل">
                        <i class="fas fa-check-double me-1"></i>تحديد سريع
                    </button>
                    <a href="{% url 'notifications:mark_all_read' %}"
                       class="btn btn-primary btn-sm">
                        <i class="fas fa-check-circle me-1"></i>تحديد الكل كمقروء
                    </a>
                </div>
            {% endif %}
        </div>

        <!-- إحصائيات سريعة -->
        <div class="card border-0 bg-primary bg-gradient text-white mb-3">
            <div class="card-body py-2">
                <div class="row stats-row">
                    <div class="col-6 col-md-3 stat-box">
                        <h4>{{ total_count }}</h4>
                        <small>إجمالي الإشعارات</small>
                    </div>
                    <div class="col-6 col-md-3 stat-box">
                        <h4>{{ unread_count }}</h4>
                        <small>غير مقروءة</small>
                    </div>
                    <div class="col-6 col-md-3 stat-box">
                        <h4>{{ read_count }}</h4>
                        <small>مقروءة</small>
                    </div>
                    <div class="col-6 col-md-3 stat-box">
                        <h4>{{ notifications|length }}</h4>
                        <small>في هذه الصفحة</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- فلاتر البحث -->
        <div class="card border-0 shadow-sm mb-3">
            <div class="card-body py-3">
                <form method="get" class="row g-2 align-items-end">
                    <div class="col-6 col-md-2">
                        <label for="type" class="form-label small mb-1">نوع الإشعار</label>
                        <select name="type" id="type" class="form-select form-select-sm">
                            <option value="">جميع الأنواع</option>
                            {% for value, label in notification_types %}
                                <option value="{{ value }}" {% if current_type == value %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-6 col-md-2">
                        <label for="priority" class="form-label small mb-1">الأولوية</label>
                        <select name="priority" id="priority" class="form-select form-select-sm">
                            <option value="">جميع الأولويات</option>
                            {% for value, label in priority_levels %}
                                <option value="{{ value }}" {% if current_priority == value %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-6 col-md-2">
                        <label for="read" class="form-label small mb-1">حالة القراءة</label>
                        <select name="read" id="read" class="form-select form-select-sm">
                            <option value="">الكل</option>
                            <option value="unread" {% if current_read == 'unread' %}selected{% endif %}>غير مقروءة</option>
                            <option value="read" {% if current_read == 'read' %}selected{% endif %}>مقروءة</option>
                        </select>
                    </div>
                    <div class="col-6 col-md-2">
                        <label for="created_by" class="form-label small mb-1">المستخدم</label>
                        <select name="created_by" id="created_by" class="form-select form-select-sm">
                            <option value="">جميع المستخدمين</option>
                            {% for user in users_with_notifications %}
                                <option value="{{ user.id }}"
                                        {% if request.GET.created_by == user.id|stringformat:'s' %}selected{% endif %}>
                                    {{ user.get_full_name|default:user.username }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-6 col-md-2">
                        <label for="date_from" class="form-label small mb-1">من تاريخ</label>
                        <input type="date" name="date_from" id="date_from"
                               class="form-control form-control-sm"
                               value="{{ request.GET.date_from }}">
                    </div>
                    <div class="col-6 col-md-2">
                        <label for="date_to" class="form-label small mb-1">إلى تاريخ</label>
                        <input type="date" name="date_to" id="date_to"
                               class="form-control form-control-sm"
                               value="{{ request.GET.date_to }}">
                    </div>
                    <div class="col-12 col-md-4">
                        <label for="search" class="form-label small mb-1">البحث</label>
                        <div class="input-group input-group-sm">
                            <input type="text" name="search" id="search"
                                   class="form-control"
                                   placeholder="رقم الطلب، كود العميل، العنوان..."
                                   value="{{ current_search }}">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-12 col-md-4 d-flex gap-2">
                        <button type="submit" class="btn btn-primary btn-sm flex-grow-1">
                            <i class="fas fa-filter me-1"></i>فلترة
                        </button>
                        <a href="{% url 'notifications:list' %}" class="btn btn-outline-secondary btn-sm flex-grow-1">
                            <i class="fas fa-times me-1"></i>مسح
                        </a>
                    </div>
                </form>
            </div>
        </div>

        <!-- قائمة الإشعارات -->
        {% if notifications %}
            <div class="card border-0 shadow-sm">
                <div class="card-body p-0">
                    {% for notification in notifications %}
                        {% with visibility=notification.user_vis_list.0 %}
                            {% with icon_data=notification.get_icon_and_color %}
                            <div class="notification-item p-3 border-bottom d-flex gap-3 align-items-start {% if visibility and not visibility.is_read %}unread{% else %}read{% endif %} priority-{{ notification.priority }}"
                                 data-notification-id="{{ notification.pk }}"
                                 data-is-read="{% if visibility %}{{ visibility.is_read|yesno:'true,false' }}{% else %}false{% endif %}">
                                <!-- أيقونة -->
                                <div class="notif-icon" style="background-color: {{ icon_data.bg }}; border: 2px solid {{ icon_data.color }};">
                                    <i class="{{ icon_data.icon }}" style="color: {{ icon_data.color }};"></i>
                                </div>
                                <!-- محتوى -->
                                <div class="notif-body">
                                    <div class="d-flex justify-content-between align-items-start mb-1">
                                        <h6 class="mb-0">
                                            <a href="{{ notification.get_absolute_url }}"
                                               class="text-decoration-none {% if not visibility.is_read %}text-dark fw-bold{% else %}text-muted{% endif %}">
                                                {% if not visibility.is_read %}<i class="fas fa-circle text-primary me-1" style="font-size: 6px; vertical-align: middle;"></i>{% endif %}
                                                {{ notification.title }}
                                            </a>
                                            {% if not visibility.is_read %}
                                                <span class="badge bg-primary rounded-pill ms-1" style="font-size: 0.65rem;">جديد</span>
                                            {% endif %}
                                        </h6>
                                        <small class="text-muted text-nowrap ms-2" style="font-size: 0.75rem;">
                                            <i class="far fa-clock me-1"></i>{{ notification.created_at|timesince }}
                                        </small>
                                    </div>
                                    <p class="mb-2 {% if not visibility.is_read %}text-body{% else %}text-muted{% endif %}">
                                        {{ notification.message|truncatewords:25 }}
                                    </p>
                                    <div class="d-flex flex-wrap gap-1 align-items-center">
                                        <span class="badge bg-light text-dark border" style="font-size: 0.7rem;">{{ notification.get_notification_type_display }}</span>
                                        {% if notification.priority == 'urgent' %}
                                            <span class="badge bg-danger" style="font-size: 0.7rem;">{{ notification.get_priority_display }}</span>
                                        {% elif notification.priority == 'high' %}
                                            <span class="badge bg-warning text-dark" style="font-size: 0.7rem;">{{ notification.get_priority_display }}</span>
                                        {% elif notification.priority == 'low' %}
                                            <span class="badge bg-secondary" style="font-size: 0.7rem;">{{ notification.get_priority_display }}</span>
                                        {% endif %}
                                        {% if notification.created_by %}
                                            <span class="badge bg-light text-dark border" style="font-size: 0.7rem;">
                                                <i class="fas fa-user me-1 text-primary"></i>{{ notification.created_by.get_full_name|default:notification.created_by.username }}
                                            </span>
                                        {% elif notification.extra_data.changed_by and notification.extra_data.changed_by != 'مستخدم النظام' %}
                                            <span class="badge bg-light text-dark border" style="font-size: 0.7rem;">
                                                <i class="fas fa-user me-1 text-info"></i>{{ notification.extra_data.changed_by }}
                                            </span>
                                        {% endif %}
                                        {% if notification.extra_data.order_number %}
                                            <span class="badge bg-info bg-opacity-10 text-info border border-info" style="font-size: 0.7rem;">
                                                <i class="fas fa-hashtag me-1"></i>{{ notification.extra_data.order_number }}
                                            </span>
                                        {% endif %}
                                        {% if notification.extra_data.customer_name %}
                                            <span class="badge bg-success bg-opacity-10 text-success border border-success" style="font-size: 0.7rem;">
                                                <i class="fas fa-user me-1"></i>{{ notification.extra_data.customer_name }}
                                            </span>
                                        {% endif %}
                                        <!-- أزرار الإجراءات -->
                                        <span class="ms-auto d-flex gap-1">
                                            {% if not visibility.is_read %}
                                                <a href="{% url 'notifications:mark_read' notification.pk %}"
                                                   class="btn btn-outline-primary btn-sm py-0 px-1" style="font-size: 0.75rem;"
                                                   title="تحديد كمقروء" onclick="event.stopPropagation();">
                                                    <i class="fas fa-check"></i>
                                                </a>
                                            {% endif %}
                                            <a href="{{ notification.get_absolute_url }}"
                                               class="btn btn-outline-secondary btn-sm py-0 px-1" style="font-size: 0.75rem;"
                                               title="عرض التفاصيل" onclick="event.stopPropagation();">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                        </span>
                                    </div>
                                </div>
                            </div>
                            {% endwith %}
                        {% endwith %}
                    {% endfor %}
                </div>
            </div>

            <!-- ترقيم الصفحات -->
            {% if notifications.has_other_pages %}
                <nav aria-label="ترقيم الصفحات" class="mt-3 mb-4">
                    <ul class="pagination pagination-sm justify-content-center">
                        {% if notifications.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ notifications.previous_page_number }}&{{ request.GET.urlencode }}">
                                    <i class="fas fa-chevron-right"></i>
                                </a>
                            </li>
                        {% endif %}
                        {% for num in notifications.paginator.page_range %}
                            {% if num == notifications.number %}
                                <li class="page-item active">
                                    <span class="page-link">{{ num }}</span>
                                </li>
                            {% elif num > notifications.number|add:'-3' and num < notifications.number|add:'3' %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ num }}&{{ request.GET.urlencode }}">{{ num }}</a>
                                </li>
                            {% endif %}
                        {% endfor %}
                        {% if notifications.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ notifications.next_page_number }}&{{ request.GET.urlencode }}">
                                    <i class="fas fa-chevron-left"></i>
                                </a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
            {% endif %}
        {% else %}
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center py-5">
                    <i class="fas fa-bell-slash fa-3x text-muted mb-3 d-block"></i>
                    <h5 class="text-muted">لا توجد إشعارات</h5>
                    <p class="text-muted small">لم يتم العثور على إشعارات تطابق معايير البحث المحددة.</p>
                    <a href="{% url 'notifications:list' %}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-sync me-1"></i>عرض جميع الإشعارات
                    </a>
                </div>
            </div>
        {% endif %}
    </div>
    <script>
document.addEventListener('DOMContentLoaded', function() {
    updateNotificationCount();
    setInterval(updateNotificationCount, 30000);
    setupNotificationClickHandlers();

    const markAllAjaxBtn = document.getElementById('mark-all-read-ajax-btn');
    if (markAllAjaxBtn) {
        markAllAjaxBtn.addEventListener('click', function() {
            if (!confirm('هل تريد تحديد جميع الإشعارات كمقروءة؟')) return;

            const originalText = markAllAjaxBtn.innerHTML;
            markAllAjaxBtn.disabled = true;
            markAllAjaxBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>جاري التحديث...';

            fetch('{% url "notifications:mark_all_read" %}', {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/x-www-form-urlencoded'
                }
            })
            .then(r => r.ok ? r.json() : Promise.reject('فشل'))
            .then(data => {
                if (data.success) {
                    showAlert('success', data.message);
                    updateNotificationsUI();
                    updateNotificationCount();
                } else {
                    throw new Error(data.message || 'فشل');
                }
            })
            .catch(e => showAlert('danger', 'حدث خطأ. يرجى المحاولة مرة أخرى.'))
            .finally(() => {
                markAllAjaxBtn.disabled = false;
                markAllAjaxBtn.innerHTML = originalText;
            });
        });
    }
});

function updateNotificationCount() {
    fetch('{% url "notifications:ajax_count" %}')
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                const badge = document.querySelector('#notification-count-badge');
                if (badge) {
                    badge.textContent = data.count;
                    badge.style.display = data.count > 0 ? 'inline' : 'none';
                }
            }
        })
        .catch(() => {});
}

function showAlert(type, message) {
    const div = document.createElement('div');
    div.className = `alert alert-${type} alert-dismissible fade show mb-2`;
    div.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
    const container = document.querySelector('.notifications-page');
    container.insertBefore(div, container.firstChild);
    setTimeout(() => div.remove(), 5000);
}

function updateNotificationsUI() {
    document.querySelectorAll('.notification-item.unread').forEach(item => {
        item.classList.remove('unread');
        item.classList.add('read');
        item.setAttribute('data-is-read', 'true');

        const title = item.querySelector('h6 a');
        if (title) { title.classList.remove('text-dark', 'fw-bold'); title.classList.add('text-muted'); }

        const dot = item.querySelector('.fas.fa-circle');
        if (dot) dot.remove();

        const badge = item.querySelector('.badge.bg-primary');
        if (badge) { badge.remove(); }

        const msg = item.querySelector('p');
        if (msg) { msg.classList.remove('text-body'); msg.classList.add('text-muted'); }

        const icon = item.querySelector('.notif-icon');
        if (icon) { icon.style.opacity = '0.6'; }
    });

    document.querySelectorAll('#mark-all-read-ajax-btn, a[href*="mark-all-read"]').forEach(b => b.style.display = 'none');
}

function setupNotificationClickHandlers() {
    document.querySelectorAll('.notification-item').forEach(item => {
        item.addEventListener('click', function(e) {
            if (e.target.closest('a.btn, button')) return;
            const id = item.getAttribute('data-notification-id');
            const isRead = item.getAttribute('data-is-read') === 'true';
            if (!isRead && id) markNotificationAsRead(id, item);
            const link = item.querySelector('h6 a[href]');
            if (link) window.location.href = link.href;
        });
    });
}

function markNotificationAsRead(notificationId, itemElement) {
    fetch(`{% url 'notifications:mark_read' 0 %}`.replace('0', notificationId), {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/x-www-form-urlencoded'
        }
    })
    .then(r => r.ok ? r.json() : Promise.reject())
    .then(data => {
        if (data.success) {
            updateSingleNotificationUI(itemElement);
            updateNotificationCount();
        }
    })
    .catch(() => {});
}

function updateSingleNotificationUI(el) {
    el.classList.remove('unread');
    el.classList.add('read');
    el.setAttribute('data-is-read', 'true');

    const title = el.querySelector('h6 a');
    if (title) { title.classList.remove('text-dark', 'fw-bold'); title.classList.add('text-muted'); }

    const dot = el.querySelector('.fas.fa-circle');
    if (dot) dot.remove();

    const badge = el.querySelector('.badge.bg-primary');
    if (badge) badge.remove();

    const msg = el.querySelector('p');
    if (msg) { msg.classList.remove('text-body'); msg.classList.add('text-muted'); }

    const icon = el.querySelector('.notif-icon');
    if (icon) icon.style.opacity = '0.6';
{% endblock %}
