# ๐ง ุญู ูุดููุฉ ุชูุฑุงุฑ ุฑูู ุงูุทูุจ

## ๐จ ุงููุดููุฉ

```
duplicate key value violates unique constraint "orders_order_order_number_key" 
DETAIL: Key (order_number)=(5-0107-0002) already exists.
```

ูุงูุช ูุฐู ุงููุดููุฉ ุชุญุฏุซ ุนูุฏ ุฅูุดุงุก ูุนุงููุฉ ุฌุฏูุฏุฉุ ุญูุซ ูุงู ุงููุธุงู ูุญุงูู ุฅูุดุงุก ุฑูู ุทูุจ ููุฑุฑ.

## ๐ ุชุญููู ุงููุดููุฉ

### ุงูุณุจุจ ุงูุฌุฐุฑู:
1. **ููุทู ุชูููุฏ ุฑูู ุงูุทูุจ ุบูุฑ ูุญูู**: ุงูููุฏ ุงูุฃุตูู ูุงู ูุจุญุซ ุนู ุขุฎุฑ ุฑูู ุทูุจ ููุฒูุฏ ุนููู 1ุ ููู ูู ููู ูุชุญูู ูู ูุฌูุฏ ุฑูู ููุฑุฑ
2. **ุนุฏู ุงูุชุนุงูู ูุน ุงูุญุงูุงุช ุงููุชุฒุงููุฉ**: ุนูุฏ ุฅูุดุงุก ุทูุจุงุช ูุชุนุฏุฏุฉ ูู ููุณ ุงูููุชุ ูุงู ูููู ุฃู ูุชู ุชูููุฏ ููุณ ุงูุฑูู
3. **ุนุฏู ุงุณุชุซูุงุก ุงูุทูุจ ุงูุญุงูู**: ุนูุฏ ุงูุชุญุฏูุซุ ูุงู ุงููุธุงู ูุชุญูู ูู ุงูุทูุจ ููุณู

## โ ุงูุญู ุงููุทุจู

### 1. ุฅูุดุงุก ุฏุงูุฉ ูููุตูุฉ ูุชูููุฏ ุฑูู ุงูุทูุจ

```python
def generate_unique_order_number(self):
    """ุชูููุฏ ุฑูู ุทูุจ ูุฑูุฏ ููุนููู"""
    if not self.customer:
        import uuid
        return f"ORD-{str(uuid.uuid4())[:8]}"
    
    try:
        customer_code = self.customer.code if hasattr(self.customer, 'code') and self.customer.code else "UNKNOWN"
        
        # ุงูุจุญุซ ุนู ุขุฎุฑ ุฑูู ุทูุจ ููุฐุง ุงูุนููู
        last_order = Order.objects.filter(
            customer=self.customer,
            order_number__startswith=customer_code
        ).exclude(pk=self.pk).order_by('-order_number').first()
        
        if last_order:
            # Extract the number part and increment it
            try:
                last_num = int(last_order.order_number.split('-')[-1])
                next_num = last_num + 1
            except ValueError:
                next_num = 1
        else:
            next_num = 1
        
        # ุงูุชุฃูุฏ ูู ุนุฏู ุชูุฑุงุฑ ุฑูู ุงูุทูุจ
        max_attempts = 100
        for attempt in range(max_attempts):
            potential_order_number = f"{customer_code}-{next_num:04d}"
            
            # ุงูุชุญูู ูู ุนุฏู ูุฌูุฏ ุฑูู ููุฑุฑ (ุจุงุณุชุซูุงุก ุงูุทูุจ ุงูุญุงูู)
            if not Order.objects.filter(order_number=potential_order_number).exclude(pk=self.pk).exists():
                return potential_order_number
            
            next_num += 1
        
        # ุฅุฐุง ูุดู ูู ุงูุนุซูุฑ ุนูู ุฑูู ูุฑูุฏุ ุงุณุชุฎุฏู UUID
        import uuid
        return f"{customer_code}-{str(uuid.uuid4())[:8]}"
        
    except Exception as e:
        print(f"Error generating order number: {e}")
        # Use a fallback order number if we can't generate one
        import uuid
        return f"ORD-{str(uuid.uuid4())[:8]}"
```

### 2. ุชุญุฏูุซ ุฏุงูุฉ save

```python
# ุชุญูู ูู ูุฌูุฏ ุฑูู ุทูุจ
if not self.order_number:
    self.order_number = self.generate_unique_order_number()
```

### 3. ุงูููุฒุงุช ุงูุฌุฏูุฏุฉ

#### ุฃ) ุงูุจุญุซ ุงููุญุฏูุฏ ุจููุฏ ุงูุนููู
```python
last_order = Order.objects.filter(
    customer=self.customer,
    order_number__startswith=customer_code
).exclude(pk=self.pk).order_by('-order_number').first()
```

#### ุจ) ุงูุชุญูู ูู ุงูุชูุฑุงุฑ
```python
max_attempts = 100
for attempt in range(max_attempts):
    potential_order_number = f"{customer_code}-{next_num:04d}"
    
    if not Order.objects.filter(order_number=potential_order_number).exclude(pk=self.pk).exists():
        return potential_order_number
    
    next_num += 1
```

#### ุฌ) ุขููุฉ ุงูุงุญุชูุงุท
```python
# ุฅุฐุง ูุดู ูู ุงูุนุซูุฑ ุนูู ุฑูู ูุฑูุฏุ ุงุณุชุฎุฏู UUID
import uuid
return f"{customer_code}-{str(uuid.uuid4())[:8]}"
```

## ๐งช ุงุฎุชุจุงุฑ ุงูุญู

### ุงุฎุชุจุงุฑ 1: ุฅูุดุงุก ุทูุจุงุช ูุชุนุฏุฏุฉ ููุนููู ููุณู
```python
# ุงููุชูุฌุฉ:
# ุงูุนููู: ูุฎุงุฆูู ุชุงูุฑ
# ููุฏ ุงูุนููู: 5-0107
# ุงูุทูุจุงุช ุงูุญุงููุฉ ููุนููู:
#   - 5-0107-0001
# 
# ุชู ุฅูุดุงุก ุงูุทูุจ ุงูุฌุฏูุฏ ุจูุฌุงุญ: 5-0107-0002
# ุชู ุฅูุดุงุก ุทูุจ ุขุฎุฑ ุจูุฌุงุญ: 5-0107-0003
# 
# === ูุง ููุฌุฏ ุชูุฑุงุฑ ูู ุฃุฑูุงู ุงูุทูุจุงุช! ===
```

### ุงุฎุชุจุงุฑ 2: ุฅูุดุงุก ูุนุงููุงุช ูู ุงููุงุฌูุฉ
```python
# ุงููุชูุฌุฉ:
# === ูุญุงูุงุฉ ุฅูุดุงุก ูุนุงููุฉ ูู ุงููุงุฌูุฉ ===
# ุงูุนููู: ูุฎุงุฆูู ุชุงูุฑ
# ููุฏ ุงูุนููู: 5-0107
# ุชู ุฅูุดุงุก ุงููุนุงููุฉ: 1344
# ุฑูู ุงูุนูุฏ: None
# ุชู ุฅูุดุงุก ุงููุนุงููุฉ ุงูุซุงููุฉ: 1345
# ุฑูู ุงูุนูุฏ: None
# 
# === ุชู ุฅูุดุงุก ุงููุนุงููุงุช ุจูุฌุงุญ ุจุฏูู ุฃุฎุทุงุก! ===
```

## ๐ ุชุญุณููุงุช ุงูุฃุฏุงุก

### 1. ุชุญุณูู ุงูุงุณุชุนูุงูุงุช
- ุงุณุชุฎุฏุงู `order_number__startswith` ููุจุญุซ ุงููุญุฏูุฏ
- ุงุณุชุฎุฏุงู `exclude(pk=self.pk)` ูุชุฌูุจ ุงูุชุญูู ูู ุงูุทูุจ ุงูุญุงูู
- ุงุณุชุฎุฏุงู `order_by('-order_number')` ููุญุตูู ุนูู ุขุฎุฑ ุฑูู ุจุณุฑุนุฉ

### 2. ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก
- ุขููุฉ ุงุญุชูุงุท ุจู UUID ูู ุญุงูุฉ ูุดู ุงูุชูููุฏ
- ูุนุงูุฌุฉ ุดุงููุฉ ููุงุณุชุซูุงุกุงุช
- ุชุณุฌูู ุงูุฃุฎุทุงุก ููุชุดุฎูุต

### 3. ููุน ุงูุชูุฑุงุฑ
- ุงูุชุญูู ูู ูู ุฑูู ูุญุชูู ูุจู ุงูุงุณุชุฎุฏุงู
- ุญุฏ ุฃูุตู 100 ูุญุงููุฉ ูุชุฌูุจ ุงูุญููุงุช ุงููุงููุงุฆูุฉ
- ุงุณุชุฎุฏุงู UUID ูุญู ุฃุฎูุฑ

## ๐ ุถูุงูุงุช ุงูุฃูุงู

### 1. ุงูุชุญูู ูู ุงูุชูุฑุงุฑ
```python
if not Order.objects.filter(order_number=potential_order_number).exclude(pk=self.pk).exists():
    return potential_order_number
```

### 2. ุขููุฉ ุงูุงุญุชูุงุท
```python
# ุฅุฐุง ูุดู ูู ุงูุนุซูุฑ ุนูู ุฑูู ูุฑูุฏุ ุงุณุชุฎุฏู UUID
import uuid
return f"{customer_code}-{str(uuid.uuid4())[:8]}"
```

### 3. ูุนุงูุฌุฉ ุงูุงุณุชุซูุงุกุงุช
```python
except Exception as e:
    print(f"Error generating order number: {e}")
    import uuid
    return f"ORD-{str(uuid.uuid4())[:8]}"
```

## ๐ ุงููุชุงุฆุฌ

### ูุจู ุงูุญู:
- โ ุฎุทุฃ `duplicate key value violates unique constraint`
- โ ูุดู ูู ุฅูุดุงุก ุงููุนุงููุงุช
- โ ุชุฌุฑุจุฉ ูุณุชุฎุฏู ุณูุฆุฉ

### ุจุนุฏ ุงูุญู:
- โ ุชูููุฏ ุฃุฑูุงู ุทูุจุงุช ูุฑูุฏุฉ ุฏุงุฆูุงู
- โ ุฅูุดุงุก ูุนุงููุงุช ุจูุฌุงุญ
- โ ุชุฌุฑุจุฉ ูุณุชุฎุฏู ุณูุณุฉ
- โ ุฃุฏุงุก ูุญุณู
- โ ูุนุงูุฌุฉ ุดุงููุฉ ููุฃุฎุทุงุก

## ๐ ุงูุงุณุชุฎุฏุงู

ุงููุธุงู ูุนูู ุชููุงุฆูุงู ุงูุขู:
- **ุฅูุดุงุก ูุนุงููุฉ ุฌุฏูุฏุฉ**: ูุชู ุชูููุฏ ุฑูู ุทูุจ ูุฑูุฏ
- **ุฅูุดุงุก ุทูุจ ูุจุงุดุฑ**: ูุชู ุชูููุฏ ุฑูู ุทูุจ ูุฑูุฏ
- **ุชุญุฏูุซ ุทูุจ ููุฌูุฏ**: ูุง ูุคุซุฑ ุนูู ุฑูู ุงูุทูุจ ุงูุญุงูู

## ๐ ููุงุญุธุงุช ูููุทูุฑูู

1. **ุงูุฏุงูุฉ ุขููุฉ ููุงุณุชุฎุฏุงู ุงููุชุฒุงูู**: ุชุชุญูู ูู ุงูุชูุฑุงุฑ ูู ูู ูุญุงููุฉ
2. **ูุฑููุฉ ูู ุงูุชุนุงูู ูุน ุงูุฃุฎุทุงุก**: ุขููุงุช ุงุญุชูุงุท ูุชุนุฏุฏุฉ
3. **ุฃุฏุงุก ูุญุณู**: ุงุณุชุนูุงูุงุช ูุญุฏูุฏุฉ ููุญุณูุฉ
4. **ุณูููุฉ ุงูุตูุงูุฉ**: ููุฏ ููุธู ูููุตูู

---

**ุชู ุญู ุงููุดููุฉ ุจูุฌุงุญ โ**

*ุขุฎุฑ ุชุญุฏูุซ: ููููู 2025* 