# إصلاح مشكلة المستخدم Admin في البحث عبر الفروع

## المشكلة
كان المستخدم `admin` لا يستطيع رؤية العملاء عند البحث برقم الهاتف لأن النظام كان يعتبر جميع العملاء من "فروع أخرى" بالنسبة له.

## السبب
المستخدم `admin` عادة ما يكون:
1. `is_superuser = True`
2. قد لا يكون له فرع محدد (`branch = None`)

وكان الكود يقارن `customer.branch != request.user.branch` مما يؤدي إلى:
- إذا كان `request.user.branch = None` والعميل له فرع، فالنتيجة `True` (فرع آخر)
- هذا يسبب عدم ظهور العملاء في البحث العادي

## الحل المطبق

### 1. إضافة دالة جديدة في `customers/permissions.py`
```python
def is_customer_cross_branch(user, customer):
    """التحقق من أن العميل من فرع آخر"""
    # إذا كان المستخدم admin أو بدون فرع، لا نعتبر أي عميل من فرع آخر
    if user.is_superuser:
        return False
    
    # إذا لم يكن للمستخدم فرع، لا نعتبر أي عميل من فرع آخر
    if not hasattr(user, 'branch') or not user.branch:
        return False
    
    # التحقق من أن العميل من فرع مختلف
    return customer.branch != user.branch
```

### 2. تحديث `customers/views.py`
استبدال جميع الأماكن التي تستخدم:
```python
# القديم
is_cross_branch = customer.branch != request.user.branch

# الجديد  
is_cross_branch = is_customer_cross_branch(request.user, customer)
```

### 3. الأماكن المحدثة
- `customer_list()` - في تحديد العملاء من فروع أخرى
- `customer_detail()` - في تحديد ما إذا كان العميل من فرع آخر
- `add_customer_note()` - في تحديد ما إذا كان العميل من فرع آخر
- `find_customer_by_phone()` - في API البحث

## النتيجة
الآن المستخدم `admin`:
1. ✅ يرى جميع العملاء في البحث العادي
2. ✅ لا يرى أي عميل كأنه من "فرع آخر"
3. ✅ يمكنه تعديل وحذف جميع العملاء
4. ✅ لا تظهر له التنبيهات الخاصة بالعملاء من فروع أخرى

## اختبار الإصلاح
للتأكد من أن الإصلاح يعمل:
1. سجل دخول بالمستخدم `admin`
2. ابحث عن عميل برقم الهاتف
3. يجب أن يظهر العميل في النتائج بدون بادج "فرع آخر"
4. يجب أن تعمل جميع الأزرار (عرض، تعديل، حذف) بشكل طبيعي

## ملاحظات تقنية
- الدالة الجديدة تتعامل مع جميع حالات المستخدمين (admin، بدون فرع، فرع عادي)
- تم الحفاظ على الأمان للمستخدمين العاديين
- لا تؤثر على وظائف النظام الأخرى