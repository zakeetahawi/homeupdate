{% extends "admin/base_site.html" %}
{% load static %}
{% block title %}{{ title }}{% endblock %}
{% block extrastyle %}
    <style>
    .dashboard-container {
        padding: 20px;
        direction: rtl;
        text-align: right;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border-right: 4px solid #007bff;
    }
    
    .stat-card.success {
        border-right-color: #28a745;
    }
    
    .stat-card.warning {
        border-right-color: #ffc107;
    }
    
    .stat-card.danger {
        border-right-color: #dc3545;
    }
    
    .stat-card.info {
        border-right-color: #17a2b8;
    }
    
    .stat-value {
        font-size: 36px;
        font-weight: bold;
        margin: 10px 0;
    }
    
    .stat-label {
        color: #666;
        font-size: 14px;
    }
    
    .section-title {
        font-size: 20px;
        font-weight: bold;
        margin: 30px 0 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #007bff;
    }
    
    .device-table {
        width: 100%;
        background: white;
        border-radius: 8px;
        overflow: hidden;
        margin-bottom: 30px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .device-table table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .device-table th {
        background: #f8f9fa;
        padding: 12px;
        font-weight: bold;
        border-bottom: 2px solid #dee2e6;
    }
    
    .device-table td {
        padding: 12px;
        border-bottom: 1px solid #dee2e6;
    }
    
    .device-table tr:hover {
        background: #f8f9fa;
    }
    
    .badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
    }
    
    .badge-success {
        background: #d4edda;
        color: #155724;
    }
    
    .badge-danger {
        background: #f8d7da;
        color: #721c24;
    }
    
    .badge-warning {
        background: #fff3cd;
        color: #856404;
    }
    
    .badge-info {
        background: #d1ecf1;
        color: #0c5460;
    }
    
    .view-details-btn {
        background: #007bff;
        color: white;
        padding: 6px 12px;
        border-radius: 4px;
        text-decoration: none;
        font-size: 12px;
        display: inline-block;
    }
    
    .view-details-btn:hover {
        background: #0056b3;
        color: white;
    }
    
    .alert {
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    
    .alert-warning {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        color: #856404;
    }
    
    .alert-danger {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
    }
    </style>
{% endblock %}
{% block content %}
    <div class="dashboard-container">
        <h1>{{ title }}</h1>
        <p style="color: #666; margin-bottom: 30px;">ğŸ“… Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: {{ "now"|date:"Y-m-d H:i" }}</p>
        <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø±Ø¦ÙŠØ³ÙŠØ© -->
        <div class="stats-grid">
            <div class="stat-card success">
                <div class="stat-label">ğŸŸ¢ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù†Ø´Ø·Ø©</div>
                <div class="stat-value">{{ active_devices }}</div>
                <small>Ù…Ù† Ø£ØµÙ„ {{ total_devices }} Ø¬Ù‡Ø§Ø²</small>
            </div>
            <div class="stat-card danger">
                <div class="stat-label">ğŸ”´ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø­Ø¸ÙˆØ±Ø©</div>
                <div class="stat-value">{{ blocked_devices }}</div>
                {% if blocked_devices > 0 %}<small style="color: #dc3545;">ÙŠØ­ØªØ§Ø¬ Ù…Ø±Ø§Ø¬Ø¹Ø©!</small>{% endif %}
            </div>
            <div class="stat-card warning">
                <div class="stat-label">âš ï¸ Ù…Ø­Ø§ÙˆÙ„Ø§Øª ØºÙŠØ± Ù…ØµØ±Ø­ Ø¨Ù‡Ø§</div>
                <div class="stat-value">{{ unauthorized_count }}</div>
                <small>Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…</small>
            </div>
            <div class="stat-card info">
                <div class="stat-label">ğŸ’¤ Ø£Ø¬Ù‡Ø²Ø© Ø®Ø§Ù…Ù„Ø© (+30 ÙŠÙˆÙ…)</div>
                <div class="stat-value">{{ inactive_long_count }}</div>
                <small>Ù„Ù… ØªÙØ³ØªØ®Ø¯Ù… Ù…Ù†Ø° Ø´Ù‡Ø±</small>
            </div>
        </div>
        <!-- ØªØ­Ø°ÙŠØ±Ø§Øª -->
        {% if devices_without_token > 0 %}
            <div class="alert alert-warning">
                <strong>âš ï¸ ØªØ­Ø°ÙŠØ±:</strong> ÙŠÙˆØ¬Ø¯ {{ devices_without_token }} Ø¬Ù‡Ø§Ø² Ø¨Ø¯ÙˆÙ† device_token (Ø£Ø¬Ù‡Ø²Ø© Ù‚Ø¯ÙŠÙ…Ø©). ÙŠÙÙ†ØµØ­ Ø¨ØªØ­Ø¯ÙŠØ«Ù‡Ø§.
            </div>
        {% endif %}
        {% if unauthorized_count > 10 %}
            <div class="alert alert-danger">
                <strong>ğŸš¨ ØªÙ†Ø¨ÙŠÙ‡ Ø£Ù…Ù†ÙŠ:</strong> Ø¹Ø¯Ø¯ ÙƒØ¨ÙŠØ± Ù…Ù† Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„ÙˆØµÙˆÙ„ ØºÙŠØ± Ø§Ù„Ù…ØµØ±Ø­ Ø¨Ù‡Ø§ ({{ unauthorized_count }}) Ø®Ù„Ø§Ù„ Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…!
            </div>
        {% endif %}
        <!-- Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø© Ù…Ø¤Ø®Ø±Ø§Ù‹ -->
        <div class="section-title">ğŸ•’ Ø¢Ø®Ø± Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù†Ø´Ø·Ø© (7 Ø£ÙŠØ§Ù…)</div>
        <div class="device-table">
            <table>
                <thead>
                    <tr>
                        <th>Ø§Ø³Ù… Ø§Ù„Ø¬Ù‡Ø§Ø²</th>
                        <th>Ø§Ù„ÙØ±Ø¹</th>
                        <th>Ø¢Ø®Ø± Ø§Ø³ØªØ®Ø¯Ø§Ù…</th>
                        <th>Ø¢Ø®Ø± Ù…Ø³ØªØ®Ø¯Ù…</th>
                        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                    </tr>
                </thead>
                <tbody>
                    {% for device in recently_used %}
                        <tr>
                            <td>
                                <strong>{{ device.device_name }}</strong>
                                {% if device.manual_identifier %}
                                    <br>
                                    <small style="color: #666;">{{ device.manual_identifier }}</small>
                                {% endif %}
                            </td>
                            <td>{{ device.branch.name }}</td>
                            <td>{{ device.last_used|date:"Y-m-d H:i" }}</td>
                            <td>{{ device.last_used_by.get_full_name|default:"â€”" }}</td>
                            <td>
                                {% if device.is_active and not device.is_blocked %}
                                    <span class="badge badge-success">âœ“ Ù†Ø´Ø·</span>
                                {% elif device.is_blocked %}
                                    <span class="badge badge-danger">âœ— Ù…Ø­Ø¸ÙˆØ±</span>
                                {% else %}
                                    <span class="badge badge-warning">Ù…Ø¹Ø·Ù„</span>
                                {% endif %}
                            </td>
                            <td>
                                <a href="{% url 'admin:device_report' device.id %}"
                                   class="view-details-btn">ğŸ“‹ ØªÙ‚Ø±ÙŠØ± ØªÙØµÙŠÙ„ÙŠ</a>
                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="6" style="text-align: center; color: #999;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø¬Ù‡Ø²Ø© Ù…Ø³ØªØ®Ø¯Ù…Ø© Ù…Ø¤Ø®Ø±Ø§Ù‹</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <!-- Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„ÙˆØµÙˆÙ„ ØºÙŠØ± Ø§Ù„Ù…ØµØ±Ø­ Ø¨Ù‡Ø§ -->
        <div class="section-title">ğŸš¨ Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„ÙˆØµÙˆÙ„ ØºÙŠØ± Ø§Ù„Ù…ØµØ±Ø­ Ø¨Ù‡Ø§ (Ø¢Ø®Ø± 20)</div>
        <div class="device-table">
            <table>
                <thead>
                    <tr>
                        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                        <th>Ø§Ù„ÙØ±Ø¹</th>
                        <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                        <th>Ø§Ù„Ø³Ø¨Ø¨</th>
                    </tr>
                </thead>
                <tbody>
                    {% for attempt in unauthorized_attempts %}
                        <tr>
                            <td>{{ attempt.attempted_at|date:"Y-m-d H:i:s" }}</td>
                            <td>{{ attempt.user_branch.name|default:"â€”" }}</td>
                            <td>{{ attempt.user.get_full_name|default:"â€”" }}</td>
                            <td>
                                <small>{{ attempt.get_denial_reason_display }}</small>
                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="4" style="text-align: center; color: #999;">âœ“ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§ÙˆÙ„Ø§Øª ØºÙŠØ± Ù…ØµØ±Ø­ Ø¨Ù‡Ø§</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <!-- Ø§Ù„ÙØ±ÙˆØ¹ Ø§Ù„Ø£ÙƒØ«Ø± Ù†Ø´Ø§Ø·Ø§Ù‹ -->
        <div class="section-title">ğŸ¢ Ø§Ù„ÙØ±ÙˆØ¹ Ø­Ø³Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©</div>
        <div class="device-table">
            <table>
                <thead>
                    <tr>
                        <th>Ø§Ø³Ù… Ø§Ù„ÙØ±Ø¹</th>
                        <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù†Ø´Ø·Ø©</th>
                        <th>Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰</th>
                        <th>Ø§Ù„Ù†Ø³Ø¨Ø©</th>
                    </tr>
                </thead>
                <tbody>
                    {% for branch in active_branches %}
                        <tr>
                            <td>
                                <strong>{{ branch.name }}</strong>
                            </td>
                            <td>{{ branch.device_count }}</td>
                            <td>{{ branch.max_devices|default:"âˆ" }}</td>
                            <td>
                                {% if branch.max_devices %}
                                    {% widthratio branch.device_count 1 100 %}% / {% widthratio branch.max_devices 1 100 %}%
                                {% else %}
                                    â€”
                                {% endif %}
                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="4" style="text-align: center; color: #999;">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ±ÙˆØ¹ Ù†Ø´Ø·Ø©</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div style="text-align: center;
                    margin-top: 40px;
                    padding: 20px;
                    background: #f8f9fa;
                    border-radius: 8px">
            <p style="color: #666;">
                ğŸ’¡ <strong>Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙŠØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡ ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ÙØ¹Ù„ÙŠ. Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªÙ‚Ø±ÙŠØ± ØªÙØµÙŠÙ„ÙŠ Ø¹Ù† Ø¬Ù‡Ø§Ø² Ù…Ø¹ÙŠÙ†ØŒ Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "ØªÙ‚Ø±ÙŠØ± ØªÙØµÙŠÙ„ÙŠ".
            </p>
        </div>
    </div>
{% endblock %}
