{% extends "admin/base_site.html" %}

{% block title %}{{ title }}{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
    &rsaquo; <a href="{% url 'admin:accounts_branchdevice_changelist' %}">Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©</a>
    &rsaquo; ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¬Ù‡Ø§Ø²
</div>
{% endblock %}

{% block content %}
<div id="content-main">
    
    <h1>{{ device.device_name }}</h1>
    
    <div class="module">
        <h2>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¬Ù‡Ø§Ø²</h2>
        <table>
            <tr>
                <th>Ø§Ù„Ø­Ø§Ù„Ø©:</th>
                <td>
                    {% if device.is_active and not device.is_blocked %}
                    <span style="color: green;">âœ“ Ù†Ø´Ø·</span>
                    {% elif device.is_blocked %}
                    <span style="color: red;">âœ— Ù…Ø­Ø¸ÙˆØ±</span>
                    {% else %}
                    <span style="color: orange;">Ù…Ø¹Ø·Ù„</span>
                    {% endif %}
                </td>
            </tr>
            <tr>
                <th>Ø§Ù„ÙØ±Ø¹:</th>
                <td>{{ device.branch.name }}</td>
            </tr>
            <tr>
                <th>Ø¢Ø®Ø± Ø§Ø³ØªØ®Ø¯Ø§Ù…:</th>
                <td>{{ device.last_used|date:"Y-m-d H:i"|default:"Ù„Ù… ÙŠÙØ³ØªØ®Ø¯Ù…" }}</td>
            </tr>
            <tr>
                <th>Ø¢Ø®Ø± Ù…Ø³ØªØ®Ø¯Ù…:</th>
                <td>{{ device.last_used_by.get_full_name|default:"â€”" }}</td>
            </tr>
            {% if days_inactive is not None %}
            <tr>
                <th>Ù…Ø¯Ø© Ø¹Ø¯Ù… Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…:</th>
                <td>{{ days_inactive }} ÙŠÙˆÙ…</td>
            </tr>
            {% endif %}
        </table>
    </div>

    <div class="module">
        <h2>ğŸ”‘ Ù…Ø¹Ø±ÙØ§Øª Ø§Ù„Ø¬Ù‡Ø§Ø²</h2>
        
        {% if device.device_token %}
        <fieldset class="module aligned">
            <div class="form-row">
                <div>
                    <label>Device Token (Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ):</label>
                    <div style="background: #f8f9fa; padding: 10px; margin: 10px 0; font-family: monospace; word-break: break-all;">
                        {{ device.device_token }}
                    </div>
                    <p class="help">âœ“ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¹Ø±Ù‘Ù Ø«Ø§Ø¨Øª ÙˆÙ„Ø§ ÙŠØªØºÙŠØ± (Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ù…ÙˆØµÙ‰ Ø¨Ù‡Ø§)</p>
                </div>
            </div>
        </fieldset>
        {% else %}
        <p class="errornote">âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø² Ù„Ø§ ÙŠÙ…Ù„Ùƒ device_token! ÙŠÙÙ†ØµØ­ Ø¨Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„.</p>
        {% endif %}
    </div>

    <div class="module">
        <h2>ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h2>
        <table>
            <tr>
                <th>Ù…Ø­Ø§ÙˆÙ„Ø§Øª ØºÙŠØ± Ù…ØµØ±Ø­ Ø¨Ù‡Ø§ (ÙƒÙ„ Ø§Ù„Ø£ÙˆÙ‚Ø§Øª):</th>
                <td><strong style="color: {% if total_unauthorized > 0 %}red{% else %}green{% endif %};">{{ total_unauthorized }}</strong></td>
            </tr>
            <tr>
                <th>Ù…Ø­Ø§ÙˆÙ„Ø§Øª ØºÙŠØ± Ù…ØµØ±Ø­ Ø¨Ù‡Ø§ (Ø¢Ø®Ø± 30 ÙŠÙˆÙ…):</th>
                <td><strong style="color: {% if unauthorized_last_month > 5 %}orange{% else %}green{% endif %};">{{ unauthorized_last_month }}</strong></td>
            </tr>
            <tr>
                <th>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ†:</th>
                <td>{{ users_logged.count }}</td>
            </tr>
        </table>
    </div>

    {% if users_logged %}
    <div class="module">
        <h2>ğŸ‘¥ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø§Ù„Ù…Ø³Ø¬Ù„ÙˆÙ†</h2>
        <table>
            <thead>
                <tr>
                    <th>Ø§Ù„Ø§Ø³Ù…</th>
                    <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                    <th>Ø§Ù„ÙØ±Ø¹</th>
                    <th>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users_logged %}
                <tr>
                    <td>{{ user.get_full_name }}</td>
                    <td>{{ user.username }}</td>
                    <td>{{ user.branch.name|default:"â€”" }}</td>
                    <td>
                        {% if user.is_superuser %}Ù…Ø¯ÙŠØ± Ø¹Ø§Ù…{% elif user.is_sales_manager %}Ù…Ø¯ÙŠØ± Ù…Ø¨ÙŠØ¹Ø§Øª{% else %}Ù…Ø³ØªØ®Ø¯Ù…{% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    {% if unauthorized %}
    <div class="module">
        <h2>ğŸš¨ Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„ÙˆØµÙˆÙ„ ØºÙŠØ± Ø§Ù„Ù…ØµØ±Ø­ Ø¨Ù‡Ø§ (Ø¢Ø®Ø± 50)</h2>
        {% if total_unauthorized > 0 %}
        <p class="errornote">ØªØ­Ø°ÙŠØ±: ØªÙ… Ø±ØµØ¯ {{ total_unauthorized }} Ù…Ø­Ø§ÙˆÙ„Ø© ÙØ§Ø´Ù„Ø©!</p>
        {% endif %}
        
        <table>
            <thead>
                <tr>
                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª</th>
                    <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                    <th>Ø§Ù„Ø³Ø¨Ø¨</th>
                </tr>
            </thead>
            <tbody>
                {% for attempt in unauthorized %}
                <tr>
                    <td>{{ attempt.attempted_at|date:"Y-m-d H:i:s" }}</td>
                    <td>{{ attempt.user.get_full_name|default:"â€”" }}</td>
                    <td><small>{{ attempt.failure_reason }}</small></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="module">
        <p style="color: green;">âœ“ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§ÙˆÙ„Ø§Øª ÙˆØµÙˆÙ„ ÙØ§Ø´Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø²</p>
    </div>
    {% endif %}

    <div class="module">
        <h2>â„¹ï¸ ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ©</h2>
        <table>
            <tr>
                <th>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„:</th>
                <td>{{ device.registered_at|date:"Y-m-d H:i:s" }}</td>
            </tr>
            <tr>
                <th>Ø¥ØµØ¯Ø§Ø± QR:</th>
                <td>{{ device.registered_with_qr_version|default:"ØºÙŠØ± Ù…Ø­Ø¯Ø¯" }}</td>
            </tr>
            {% if device.is_blocked %}
            <tr>
                <th>Ø³Ø¨Ø¨ Ø§Ù„Ø­Ø¸Ø±:</th>
                <td style="color: red;"><strong>{{ device.blocked_reason }}</strong></td>
            </tr>
            {% endif %}
        </table>
    </div>

</div>
{% endblock %}
