#!/usr/bin/env python
"""
ุงุฎุชุจุงุฑ ุงูุฅุตูุงุญุงุช ุงูุญุฑุฌุฉ ููุธุงู ุงููุญุงุฏุซุฉ
"""
import os
import django

# ุฅุนุฏุงุฏ Django
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'crm.settings')
django.setup()

from django.contrib.auth import get_user_model
from modern_chat.models import UserStatus, ChatRoom, Message
from django.conf import settings

User = get_user_model()

def test_critical_fixes():
    """ุงุฎุชุจุงุฑ ุงูุฅุตูุงุญุงุช ุงูุญุฑุฌุฉ"""
    print("๐ฅ ุงุฎุชุจุงุฑ ุงูุฅุตูุงุญุงุช ุงูุญุฑุฌุฉ ููุธุงู ุงููุญุงุฏุซุฉ\n")
    
    # ูุญุต ASGI
    if hasattr(settings, 'ASGI_APPLICATION'):
        asgi_app = settings.ASGI_APPLICATION
        print(f"โ ASGI_APPLICATION: {asgi_app}")
    else:
        print("โ ASGI_APPLICATION ุบูุฑ ููุนุฑู")

def test_database_status():
    """ุงุฎุชุจุงุฑ ุญุงูุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช"""
    print("\n๐ ุงุฎุชุจุงุฑ ุญุงูุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช...")
    
    # ุฅุญุตุงุฆูุงุช
    users_count = User.objects.count()
    status_count = UserStatus.objects.count()
    rooms_count = ChatRoom.objects.count()
    messages_count = Message.objects.count()
    
    print(f"ุงููุณุชุฎุฏููู: {users_count}")
    print(f"ุญุงูุงุช ุงููุณุชุฎุฏููู: {status_count}")
    print(f"ุบุฑู ุงูุฏุฑุฏุดุฉ: {rooms_count}")
    print(f"ุงูุฑุณุงุฆู: {messages_count}")

def test_server_connection():
    """ุงุฎุชุจุงุฑ ุงุชุตุงู ุงูุฎุงุฏู"""
    print("\n๐ ุงุฎุชุจุงุฑ ุงุชุตุงู ุงูุฎุงุฏู...")
    
    try:
        import requests
        
        # ุงุฎุชุจุงุฑ ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ
        try:
            response = requests.get('http://localhost:8000/', timeout=5)
            if response.status_code == 200:
                print("โ ุงูุฎุงุฏู ูุนูู ุนูู ุงููููุฐ 8000")
                return True
            else:
                print(f"โ๏ธ ุงูุฎุงุฏู ูุฑุฏ ุจููุฏ: {response.status_code}")
                return False
        except requests.exceptions.ConnectionError:
            print("โ ูุง ูููู ุงูุงุชุตุงู ุจุงูุฎุงุฏู ุนูู localhost:8000")
            print("ุชุฃูุฏ ูู ุชุดุบูู ุงูุฎุงุฏู ุฃููุงู:")
            print("./ููููุณ/run-development.sh")
            return False
        except Exception as e:
            print(f"โ ุฎุทุฃ ูู ุงูุงุชุตุงู: {e}")
            return False
        
    except ImportError:
        print("โ ููุชุจุฉ requests ุบูุฑ ูุซุจุชุฉ")
        return False

def main():
    """ุงูุฏุงูุฉ ุงูุฑุฆูุณูุฉ"""
    print("๐ ุงุฎุชุจุงุฑ ุงูุฅุตูุงุญุงุช ุงูุญุฑุฌุฉ ููุธุงู ุงููุญุงุฏุซุฉ\n")
    
    # ุงุฎุชุจุงุฑ ุงูุฅุตูุงุญุงุช
    test_critical_fixes()
    
    # ุงุฎุชุจุงุฑ ูุงุนุฏุฉ ุงูุจูุงูุงุช
    test_database_status()
    
    # ุงุฎุชุจุงุฑ ุงุชุตุงู ุงูุฎุงุฏู
    server_ok = test_server_connection()
    
    print("\n๐ ุงูุชูู ุงูุงุฎุชุจุงุฑ!")
    print("\n๐ ุงูุฅุตูุงุญุงุช ุงููุทุจูุฉ:")
    print("โ ุฅุตูุงุญ ุฎุทุฃ updateUserRoomsWidget")
    print("โ ุชุญุณูู ูุคุดุฑ 'ุฌุงุฑู ุงููุชุงุจุฉ ุงูุขู'")
    print("โ ุฅุตูุงุญ ุงููุชุญ ุงูุชููุงุฆู ูููุญุงุฏุซุฉ")
    print("โ ุฅุตูุงุญ ุนุฏุงุฏ ุงูุฑุณุงุฆู ุบูุฑ ุงูููุฑูุกุฉ")
    print("โ ุชุญุณูู markMessagesAsRead")
    print("โ ุฅุถุงูุฉ ุฏูุงู ุฅุฏุงุฑุฉ ุงูุนุฏุงุฏุงุช")
    
    if server_ok:
        print("\n๐งช ุฎุทุฉ ุงูุงุฎุชุจุงุฑ:")
        print("1. ุงูุชุญ ุงููุชุตูุญ: http://localhost:8000")
        print("2. ุณุฌู ุงูุฏุฎูู: admin / admin123")
        print("3. ุงูุชุญ console ุงููุชุตูุญ (F12)")
        print("4. ุงุฎุชุจุฑ ุงูููุฒุงุช ุงูุชุงููุฉ:")
        print("\n๐ฅ **ุงุฎุชุจุงุฑุงุช ุญุฑุฌุฉ:**")
        print("   โ ูุชุญ ุงููุญุงุฏุซุฉ ุชููุงุฆูุงู ุนูุฏ ูุตูู ุฑุณุงูุฉ")
        print("   โ ุธููุฑ 'ุฌุงุฑู ุงููุชุงุจุฉ ุงูุขู' ุนูุฏ ูุชุงุจุฉ ุงููุณุชุฎุฏู ุงูุขุฎุฑ")
        print("   โ ุงุฎุชูุงุก ุนุฏุงุฏ ุงูุฑุณุงุฆู ุนูุฏ ูุชุญ ุงููุญุงุฏุซุฉ")
        print("   โ ุญุฐู ุงููุญุงุฏุซุฉ ูุนูู ูู ูุงุฆูุฉ ุงููุญุงุฏุซุงุช")
        print("   โ ุงูุฅุดุนุงุฑ ุงูุตูุชู ูุนูู ูุฌููุน ุงูุฑุณุงุฆู ุงูุฌุฏูุฏุฉ")
        
        print("\n๐ **ุฎุทูุงุช ุงูุงุฎุชุจุงุฑ ุงูููุตูุฉ:**")
        print("1. **ุงุฎุชุจุงุฑ ุงููุชุญ ุงูุชููุงุฆู:**")
        print("   - ุงูุชุญ ูุงูุฐุชูู ูู ูุชุตูุญูู ูุฎุชูููู")
        print("   - ุณุฌู ุฏุฎูู ุจูุณุชุฎุฏููู ูุฎุชูููู")
        print("   - ุฃุฑุณู ุฑุณุงูุฉ ูู ุงููุณุชุฎุฏู ุงูุฃูู")
        print("   - ุชุญูู ูู ูุชุญ ุงููุงูุฐุฉ ุชููุงุฆูุงู ูููุณุชุฎุฏู ุงูุซุงูู")
        
        print("\n2. **ุงุฎุชุจุงุฑ 'ุฌุงุฑู ุงููุชุงุจุฉ ุงูุขู':**")
        print("   - ุงุจุฏุฃ ุงููุชุงุจุฉ ูู ูุงูุฐุฉ ุงููุณุชุฎุฏู ุงูุฃูู")
        print("   - ุชุญูู ูู ุธููุฑ 'ุฌุงุฑู ุงููุชุงุจุฉ ุงูุขู' ูููุณุชุฎุฏู ุงูุซุงูู")
        print("   - ุชููู ุนู ุงููุชุงุจุฉ ูุชุญูู ูู ุงุฎุชูุงุก ุงููุคุดุฑ")
        
        print("\n3. **ุงุฎุชุจุงุฑ ุนุฏุงุฏ ุงูุฑุณุงุฆู:**")
        print("   - ุฃุฑุณู ุฑุณุงูุฉ ูุชุญูู ูู ุธููุฑ ุงูุนุฏุงุฏ")
        print("   - ุงูุชุญ ุงููุญุงุฏุซุฉ ูุชุญูู ูู ุงุฎุชูุงุก ุงูุนุฏุงุฏ")
        
        print("\n4. **ุงุฎุชุจุงุฑ ุญุฐู ุงููุญุงุฏุซุฉ:**")
        print("   - ุงููุฑ ุจุงูุฒุฑ ุงูุฃููู ุนูู ูุญุงุฏุซุฉ ูู ุงููุงุฆูุฉ")
        print("   - ุงุฎุชุฑ 'ุญุฐู ุงููุญุงุฏุซุฉ'")
        print("   - ุชุญูู ูู ุญุฐู ุงููุญุงุฏุซุฉ ุจูุฌุงุญ")
        
        print("\n5. **ุงุฎุชุจุงุฑ ุงูุฅุดุนุงุฑ ุงูุตูุชู:**")
        print("   - ุชุฃูุฏ ูู ุชุดุบูู ุงูุตูุช ูู ุงููุชุตูุญ")
        print("   - ุฃุฑุณู ุฑุณุงูุฉ ูุชุญูู ูู ุชุดุบูู ุงูุตูุช")
        print("   - ุงุฎุชุจุฑ ูุน ุงููุงูุฐุฉ ููุชูุญุฉ ููุบููุฉ")
    else:
        print("\nโ๏ธ ุดุบู ุงูุฎุงุฏู ุฃููุงู:")
        print("./ููููุณ/run-development.sh")
    
    print("\n๐ฏ **ุงููุชุงุฆุฌ ุงููุชููุนุฉ:**")
    print("โ ูุง ุชูุฌุฏ ุฃุฎุทุงุก JavaScript ูู console")
    print("โ ุฌููุน ุงููุธุงุฆู ุชุนูู ุจุณูุงุณุฉ")
    print("โ ุชุฌุฑุจุฉ ูุณุชุฎุฏู ูุญุณูุฉ")
    print("โ ุงุณุชุฌุงุจุฉ ููุฑูุฉ ููุฃุญุฏุงุซ")
    
    print("\n๐ **ุงูุฎุทูุงุช ุงูุชุงููุฉ:**")
    print("1. ุงุฎุชุจุงุฑ ุดุงูู ูููุธุงุฆู")
    print("2. ุชูุธูู ุฑุณุงุฆู console.log ุงููุชุจููุฉ")
    print("3. ุฅุนุงุฏุฉ ููููุฉ ูุธุงู ุฅุฏุงุฑุฉ ุงูุญุงูุฉ")
    print("4. ุฅุถุงูุฉ ููุฒุงุช ุฌุฏูุฏุฉ")

if __name__ == "__main__":
    main()
