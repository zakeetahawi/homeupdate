#!/bin/bash
# =============================================================================
# ุณูุฑูุจุช ุฅุตูุงุญ ุงูุชุญูููุงุช ุงููุฎุฒููุฉ ุงูููุบูุฉ/ุงููุฑููุถุฉ
# =============================================================================
#
# โ๏ธ  ูุชู ูุฌุจ ุชุดุบูู ูุฐุง ุงูุณูุฑูุจุชุ
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# ูุงู ูุธุงู ุฅูุบุงุก/ุฑูุถ ุงูุชุญูููุงุช ุงููุฎุฒููุฉ ููุชูุฑ ุฅูู ููุทู ุฅุนุงุฏุฉ ุงููุฎุฒูู.
# ุฃู ุชุญููู ุชูุช ุงูููุงููุฉ ุนููู (approved/in_transit) ุซู ุฃููุบู ุฃู ุฑููุถ
# ูุงู ุงููุฎุฒูู ููุฎุตู ููุง ููุนุงุฏ โ ููุง ูุฌุนู ุฃุฑุตุฏุฉ ุงููุฎุฒูู ุบูุฑ ุตุญูุญุฉ.
#
# ุชู ุฅุตูุงุญ ูุฐุง ุงูุฎุทุฃ ูู ุงูููุฏุ ููู ุงูุชุญูููุงุช ุงููุฏููุฉ ุงูููุบูุฉ/ุงููุฑููุถุฉ
# ุงูุชู ุญุฏุซุช ูุจู ุงูุฅุตูุงุญ ูุง ุชุฒุงู ุชุญุชุงุฌ ุฅุตูุงุญ ูุฏูู ูุฅุนุงุฏุฉ ุงููุฎุฒูู ูููุง.
#
# ๐ ูุฌุจ ุชุดุบูู ูุฐุง ุงูุณูุฑูุจุช ูุฑุฉ ูุงุญุฏุฉ ููุท ุนูู ุณูุฑูุฑ ุงูุฅูุชุงุฌ ุจุนุฏ ูุดุฑ ุงูุชุญุฏูุซ.
#
# ุงูุงุณุชุฎุฏุงู:
#   bash run_transfer_fix.sh          โ ูุนุงููุฉ ููุท (ุจุฏูู ุชุบููุฑ)
#   bash run_transfer_fix.sh apply    โ ุชุทุจูู ุงูุฅุตูุงุญ ุงููุนูู
# =============================================================================

set -e  # ุฅููุงู ุนูุฏ ุฃูู ุฎุทุฃ

# ุงูุฃููุงู
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}================================================================================${NC}"
echo -e "${BLUE}๐ง ุฅุตูุงุญ ุงูุชุญูููุงุช ุงููุฎุฒููุฉ ุงูููุบูุฉ${NC}"
echo -e "${BLUE}================================================================================${NC}"
echo ""

# ุงูุชุญูู ูู ุงููุณุงุฑ
if [ ! -f "manage.py" ]; then
    echo -e "${RED}โ ุฎุทุฃ: ูุง ููุฌุฏ ููู manage.py ูู ุงููุฌูุฏ ุงูุญุงูู${NC}"
    echo -e "${YELLOW}๐ก ุชุฃูุฏ ูู ุชุดุบูู ุงูุณูุฑูุจุช ูู ูุฌูุฏ ุงููุดุฑูุน (/home/zakee/homeupdate)${NC}"
    exit 1
fi

# ุงูุชุญูู ูู ุงูุจูุฆุฉ ุงูุงูุชุฑุงุถูุฉ
if [ ! -d "venv" ]; then
    echo -e "${RED}โ ุฎุทุฃ: ูุง ุชูุฌุฏ ุจูุฆุฉ ุงูุชุฑุงุถูุฉ (venv)${NC}"
    exit 1
fi

echo -e "${GREEN}โ ุชูุนูู ุงูุจูุฆุฉ ุงูุงูุชุฑุงุถูุฉ...${NC}"
source venv/bin/activate

echo -e "${GREEN}โ ุงูุชุญูู ูู ุงูุณูุฑูุจุช...${NC}"
if [ ! -f "fix_cancelled_transfers.py" ]; then
    echo -e "${RED}โ ุฎุทุฃ: ุงูุณูุฑูุจุช ุบูุฑ ููุฌูุฏ${NC}"
    exit 1
fi

echo ""
echo -e "${YELLOW}================================================================================${NC}"
echo -e "${YELLOW}โ๏ธ  ูุถุน ุงููุนุงููุฉ - ุณูุชู ุนุฑุถ ุงูุชุญูููุงุช ุงููุชุฃุซุฑุฉ ููุท${NC}"
echo -e "${YELLOW}================================================================================${NC}"
echo ""

# ุชุดุบูู ุงููุนุงููุฉ
python fix_cancelled_transfers.py --dry-run

echo ""
echo -e "${YELLOW}================================================================================${NC}"
echo -e "${YELLOW}๐ก ูุฐู ูุนุงููุฉ ููุท. ูุชุทุจูู ุงูุฅุตูุงุญ:${NC}"
echo -e "${YELLOW}   bash run_transfer_fix.sh apply${NC}"
echo -e "${YELLOW}================================================================================${NC}"
echo ""

# ุฅุฐุง ูุงู ุงููุนุงูู apply
if [ "$1" == "apply" ]; then
    echo ""
    echo -e "${RED}================================================================================${NC}"
    echo -e "${RED}โ๏ธ  ุชุญุฐูุฑ: ุณูุชู ุชุทุจูู ุงูุฅุตูุงุญ ุนูู ูุงุนุฏุฉ ุงูุจูุงูุงุช${NC}"
    echo -e "${RED}================================================================================${NC}"
    echo ""
    
    # ุฃุฎุฐ ูุณุฎุฉ ุงุญุชูุงุทูุฉ ุณุฑูุนุฉ
    echo -e "${GREEN}๐ฆ ุฃุฎุฐ ูุณุฎุฉ ุงุญุชูุงุทูุฉ ุณุฑูุนุฉ...${NC}"
    BACKUP_FILE="backup_before_fix_$(date +%Y%m%d_%H%M%S).sql"
    
    # ูุญุงููุฉ ุฃุฎุฐ ูุณุฎุฉ ุงุญุชูุงุทูุฉ (ูุฏ ุชุญุชุงุฌ ุชุนุฏูู ุจูุงูุงุช ุงูุงุชุตุงู)
    if [ -f "db_settings.json" ]; then
        echo -e "${YELLOW}๐ก ููู db_settings.json ููุฌูุฏุ ููููู ุฃุฎุฐ ูุณุฎุฉ ุงุญุชูุงุทูุฉ ูุฏููุงู${NC}"
    fi
    
    echo ""
    read -p "ูู ุฃูุช ูุชุฃูุฏ ูู ุงููุชุงุจุนุฉุ ุงูุชุจ 'ูุนู' ููุชุฃููุฏ: " confirm
    
    if [ "$confirm" != "ูุนู" ] && [ "$confirm" != "yes" ]; then
        echo -e "${YELLOW}โ ุชู ุงูุฅูุบุงุก${NC}"
        exit 0
    fi
    
    echo ""
    echo -e "${GREEN}๐ง ุชุทุจูู ุงูุฅุตูุงุญ...${NC}"
    python fix_cancelled_transfers.py --apply
    
    echo ""
    echo -e "${GREEN}================================================================================${NC}"
    echo -e "${GREEN}โ ุชู ุงูุฅุตูุงุญ ุจูุฌุงุญ!${NC}"
    echo -e "${GREEN}================================================================================${NC}"
    echo ""
    echo -e "${BLUE}๐พ ุชู ุญูุธ ุงูุชูุฑูุฑ ูู:${NC}"
    ls -lt transfer_fix_report_*.txt | head -1
    echo ""
fi
