# ุชูุฑูุฑ ุงูุฃุฎุทุงุก โ 28 ูุจุฑุงูุฑ 2026
**ุงููุธุงู:** El-Khawaga ERP  
**ุงููุชุฑุฉ ุงูููุญูุตุฉ:** 2026-02-26 โ 2026-02-27  
**ููุทุฉ ุงููุฑุฌุน:** ุชูุฑูุบ ุงูุณุฌูุงุช 2026-02-26 11:44  
**ุขุฎุฑ commit:** `e76c2e2f` (Fix BUG-017, BUG-013, BUG-018, BUG-019, BUG-014)  
**ุงููููุงุช ุงูููุญูุตุฉ:** `service_error.log`, `django.log`, `errors.log`, `startup.log`, `error.log`, `security.log`, `postgres-monitor.log`

---

## ููุฎุต ุณุฑูุน

| # | ุงูุจู | ุงูุดุฏุฉ | ุงูุชูุฑุงุฑ | ุงูุญุงูุฉ |
|---|------|-------|---------|--------|
| BUG-013 | ูุณุชูุฏุน ุงูุงุฏููู โ ูุญุงููุฉ ุณุญุจ ูู ูุฎุฒูู ูุงุฑุบ | ๐ก ูุชูุณุท | **36** | ูุณุชูุฑ |
| BUG-020 | `duplicate key: unique_draft_order_sequence` โ ุฅุถุงูุฉ ุณุชุงุฑุฉ | ๐ด ุญุฑุฌ | **27** | ุฌุฏูุฏ |
| BUG-018 | pgBouncer ุบูุฑ ูุชุงุญ ุนูุฏ ุงูุฅููุงุน | ๐ ุชุญุฐูุฑ | 1 | ูุคูุฏ |
| SEC-001 | ูุฌูู CSRF ุนูู ุตูุญุฉ ุชุณุฌูู ุงูุฏุฎูู | ๐ด ุฃููู | **38** | ุฌุฏูุฏ |
| SEC-002 | ูุญุงููุฉ ุชุณุฌูู ุฏุฎูู ุจูุณุชุฎุฏู ุบูุฑ ููุฌูุฏ (`sayed`) | ๐ก ุฃููู | 1 | ุฌุฏูุฏ |
| WARN-001 | `โ๏ธ No device token provided` | ๐ข ุชุญุฐูุฑ | 6 | ูุณุชูุฑ |
| WARN-002 | ุฎุท `Noto Naskh Arabic` ูุง ูุชุญูู (PDF) | ๐ข ุชุญุฐูุฑ | 4 | ูุณุชูุฑ |

---

## BUG-020 ๐ด โ `duplicate key: unique_draft_order_sequence`  โ ุฌุฏูุฏ ุญุฑุฌ

### ุงููุตู
ุนูุฏ ุฅุถุงูุฉ ุณุชุงุฑุฉ ูุนูุฏ (`/orders/wizard/add-curtain/`)ุ ูุญุฏุซ ุชุตุงุฏู ูู ุฑูู ุงูุชุณูุณู (`sequence`) ููุง ูุฌุนู ุงูุนูููุฉ ุชูุดู ุจู HTTP 500 ูุชูุนูุฏ ุงูุณุชุงุฑุฉ ูููุณุชุฎุฏู.

### ุงูุณุฌู
```
[2026-02-27 12:08:20] ERROR - Error adding curtain: duplicate key value violates
unique constraint "unique_draft_order_sequence"
DETAIL: Key (draft_order_id, sequence)=(8140, 3) already exists.

File: orders/wizard_views.py, line 2528, in wizard_add_curtain
    curtain = ContractCurtain.objects.create(
        draft_order=draft,
        sequence=next_sequence,   โ ุงูุฑูู ูุญุณูุจ ุจุฏูู ููู
        ...
    )
django.db.utils.IntegrityError: duplicate key value violates unique constraint
"unique_draft_order_sequence"
```

### ุงูุฅุญุตุงุฆูุงุช
- **27 ุฎุทุฃ** ุฌููุนูุง ูู ููุณ ุงููุญุธุฉ: `2026-02-27 12:08:20`
- ุฌููุนูุง ูุฃูุฑ ูุงุญุฏ: `draft_order_id=8140`, `sequence=3`
- ุงูุณุจุจ: ุงููุณุชุฎุฏู ุถุบุท ุฒุฑ "ุฅุถุงูุฉ ุณุชุงุฑุฉ" ุฃูุซุฑ ูู ูุฑุฉ ูู ููุช ูุงุญุฏ (double-click ุฃู ุฅุนุงุฏุฉ ุฅุฑุณุงู)

### ุงูุณุจุจ ุงูุฌุฐุฑู
```python
# orders/wizard_views.py ุงูุณุทุฑ 2513-2521 โ race condition
last_curtain = (
    ContractCurtain.objects.filter(draft_order=draft)
    .order_by("-sequence")
    .first()
)
next_sequence = (last_curtain.sequence + 1) if last_curtain else 1
# โ ุฅุฐุง ูุตูุช ุทูุจุงู ูู ููุณ ุงูููุช: ููุงููุง ุณููุฑุฃ ููุณ last_curtain
# โ ูููุงููุง ุณูุญุงูู ุฅูุดุงุก sequence=3 โ IntegrityError

curtain = ContractCurtain.objects.create(
    draft_order=draft,
    sequence=next_sequence,  # โ ูุชุนุงุฑุถ ูุน ุงูุทูุจ ุงูุซุงูู
    ...
)
```

### ุทุฑููุฉ ุงูุฅุตูุงุญ
**ุงูููู:** `orders/wizard_views.py` ุงูุณุทุฑ 2513

**ุงูุฎูุงุฑ ุงูููุตู (retry on conflict):**
```python
from django.db import IntegrityError
import time

# ุงุณุชุจุฏุงู:
last_curtain = ContractCurtain.objects.filter(draft_order=draft).order_by("-sequence").first()
next_sequence = (last_curtain.sequence + 1) if last_curtain else 1
curtain = ContractCurtain.objects.create(draft_order=draft, sequence=next_sequence, ...)

# ุจู:
for attempt in range(5):
    last_curtain = (
        ContractCurtain.objects.filter(draft_order=draft)
        .select_for_update()  # โ ููู ูููุน ุงููุฑุงุกุฉ ุงููุชุฒุงููุฉ
        .order_by("-sequence")
        .first()
    )
    next_sequence = (last_curtain.sequence + 1) if last_curtain else 1
    try:
        curtain = ContractCurtain.objects.create(
            draft_order=draft, sequence=next_sequence, ...
        )
        break
    except IntegrityError:
        if attempt == 4:
            raise
        continue
```

**ุฃู ุฃุจุณุท ููู:** ููู ุนูู ูุณุชูู ุงูู view ุจุงุณุชุฎุฏุงู `select_for_update()`:
```python
with transaction.atomic():
    last_curtain = (
        ContractCurtain.objects.select_for_update()
        .filter(draft_order=draft)
        .order_by("-sequence")
        .first()
    )
    next_sequence = (last_curtain.sequence + 1) if last_curtain else 1
    curtain = ContractCurtain.objects.create(...)
```

### ุงูุชุฃุซูุฑ
ุงููุณุชุฎุฏู ูุฑู ุฎุทุฃ 500 ุนูุฏ ุงูุถุบุท ุงูุณุฑูุน ุนูู "ุฅุถุงูุฉ ุณุชุงุฑุฉ"ุ ููุฏ ุชูุถุงู ุณุชุงุฑุฉ ูุงูุตุฉ ููุนูุฏ.

---

## BUG-013 ๐ก โ ุณุญุจ ูู ูุณุชูุฏุน ูุงุฑุบ (ุงูุงุฏููู) โ ูุณุชูุฑ

### ุงููุตู
ุฑุบู ุฅุตูุงุญ `_get_warehouse_for_cutting` ูู BUG-013 ุงูุณุงุจูุ ูุง ูุฒุงู ุงููุธุงู ูุญุงูู ุงูุฎุตู ูู ูุณุชูุฏุน "ุงูุงุฏููู" ุงูุฐู ูุง ูุญุชูู ุนูู ุงูููุชุฌุงุช ุงููุทููุจุฉ.

### ุงูุฅุญุตุงุฆูุงุช ุจุนุฏ ุงูุชูุฑูุบ (26-27 ูุจุฑุงูุฑ)
- **36 ุฎุทุฃ** ุฅุฌูุงููุงู
- **32 ููุชุฌุงู ูุฑูุฏุงู** ูุชุฃุซุฑุงู โ ุฌููุนูุง ููุณุชูุฏุน "ุงูุงุฏููู"



### ุงูููุชุฌุงุช ุงููุชุฃุซุฑุฉ (ูุงููุฉ)
```
FERRARI/C ุงููุณูุฏ 2516      โ 24-27 ูุชุฑ (ููุฑุฑ 3 ูุฑุงุช)
FERRARI/C ุจูุฌ ูุงุชุญ 2495    โ ุธูุฑ ูุฑุชูู
KOYA/C9, C11, C51, C57, C1 โ 5 ูุฑุงุช
NEW TOKYO /C2 ู /C8        โ ูุฑุชูู
FERRARI/C ุฑุตุงุตู 2509       โ ูุฑุฉ
FERRARI/C ุณูุฑู 2545        โ ูุฑุฉ
CAROLINA/C1                โ ูุญุงููุฉ 35 ูุชุฑ
ROCK/C3                    โ 37 ูุชุฑ
PRINT-KASTER               โ 1.5 ูุชุฑ
TOSCANA/C3845 + AIR-21271  โ ูุฑุฉ ูุงุญุฏุฉ
ูุบูุฑูุง...
```

### ุงูุชุญููู
ุงูุฅุตูุงุญ ุงูุณุงุจู (BUG-013) ูุนูู ูู `cutting/inventory_integration.py` ููู ุงููุณุจุจุงุช ุชุฃุชู ูู `inventory/signals.py` ูุจุงุดุฑุฉ ุนูุฏ ูู `StockTransaction.objects.create(...)` โ ุฃู ุนูุฏ ุฃู ุนูููุฉ ุฎุตู ูุฎุฒููุ ูููุณ ููุท ุนูููุงุช ุงูุชูุทูุน.

### ุงูุณุจุจ ุงูุฌุฐุฑู ุงูุญูููู
ุงูุฃุตูุงู ูุง ุชุฒุงู **ูุฑุชุจุทุฉ ุจูุณุชูุฏุน ุงูุงุฏููู ูู ุจูุงูุงุช ุงูุทูุจุงุช ุงููุฏููุฉ**ุ ููู ุงูุฃุตูุงู ููููุช ูุนููุงู ููุณุชูุฏุน ุขุฎุฑ. ูุฌุจ ุชุญุฏูุซ ูุฑุฌุน ุงููุณุชูุฏุน ูู ุงูุทูุจุงุช ุฃู ุญุฑูุงุช ุงููุฎุฒูู ุงููุฑุชุจุทุฉ.

**ุงูุญู ุงููุทููุจ:** ุชุญุฏูุซ ูุณุชูุฏุน ุงูููุงุชูุฑ/ุงูุทูุจุงุช ุงููุฏููุฉ ุงูุชู ูุง ุชุฒุงู ุชุดูุฑ ูู"ุงูุงุฏููู" ูุชุดูุฑ ูููุณุชูุฏุน ุงูุตุญูุญ.

---

## BUG-018 ๐ โ pgBouncer ุบูุฑ ูุชุงุญ ุนูุฏ ุงูุฅููุงุน (ูุคูุฏ)

### ุงูุฏููู ูู startup.log
```
[2026-02-26 11:43:22] โ ERROR: pgBouncer ุบูุฑ ูุชุงุญ โ ุงููุชุงุจุนุฉ ูุน ุงุญุชูุงููุฉ ุงุฎุทุงุก ุงุชุตุงู
```

### ุงูููุงุญุธุฉ
ุฑุณุงูุฉ ุงูุงูุชุธุงุฑ ุงูุฌุฏูุฏุฉ (BUG-018 fix) ุธูุฑุช ูุนููุช โ pgBouncer ูู ููู ุฌุงูุฒุงู ุนูุฏ ุงูุฅููุงุน ููู ุงูุฎุฏูุฉ ูุงุตูุช ุงูุชุดุบูู ุจุฏูุงู ูู ุงูุชุนุทู ุงููุงูู. **ูุง ุชูุฌุฏ ุฃุฎุทุงุก 500 ูู pgBouncer** ูู ูุฐุง ุงูุฏูุฑ โ ุงูุฅุตูุงุญ ุฃุฏู ูุธููุชู ูู ุชุฌููุจ ุงููุณุชุฎุฏููู ุงูุฃุฎุทุงุก.

---

## SEC-001 ๐ด โ ูุฌูู CSRF ุนูู ุตูุญุงุช ุชุณุฌูู ุงูุฏุฎูู

### ุงููุตู
ูููุงุช ูุจูุฑุฉ ูู ูุญุงููุงุช `POST` ุจู CSRF token ุฎุงุทุฆ โ ุนูุงูุฉ ุนูู ูุญุงููุฉ ูุฌูู ุขูู ุฃู bot.

### ุงูุฅุญุตุงุฆูุงุช
```
2026-02-26: 1 ูุญุงููุฉ ุนูู /accounts/login/
2026-02-27: 37 ูุญุงููุฉ โ ููุฒุนุฉ:
  - /accounts/login/   : 33 ูุญุงููุฉ (ุฃุบูุจูุง 15:49โ16:01 ูู 16 ุฏูููุฉ)
  - /admin/login/      : 10 ูุญุงููุงุช (10:10 ู10:26 ู13:28)
  - /customers/create/ : 3 ูุญุงููุงุช (14:11)
```

### ุฃุจุฑุฒ ุงูุฃููุงุท
```
2026-02-27 15:49:21 โ 15:49:43 โ 15 ูุญุงููุฉ ูู 22 ุซุงููุฉ ุนูู /accounts/login/
2026-02-27 16:01:12 โ 16:01:47 โ 5 ูุญุงููุงุช ูุชุชุงููุฉ
2026-02-27 10:10:33 โ 10:10:34 โ 5 ูุญุงููุงุช ูู ุซุงููุฉ ูุงุญุฏุฉ ุนูู /admin/login/
```

### ุงูุชูููู
- ูุง ููุฌุฏ ุฏููู ุนูู ุงุฎุชุฑุงู โ CSRF token ูููุน ุงูุทูุจุงุช
- django-axes ูุณุฌู ููุญุฌุจ ุงููุญุงููุงุช ุงููุชูุฑุฑุฉ
- ุงููุฌูู ุนูู `/admin/login/` ูุณุชุญู ุฅุบูุงู ุงููุตูู ูู `/admin/` ูู IPs ุฎุงุฑุฌูุฉ

---

## SEC-002 ๐ก โ ูุญุงููุฉ ุชุณุฌูู ุฏุฎูู ุจูุณุชุฎุฏู ุบูุฑ ููุฌูุฏ

### ุงูุณุฌู
```
[2026-02-26 13:24:36] WARNING - โ Invalid username attempt: sayed
[2026-02-26 13:24:36] WARNING - โ Invalid username: sayed from IP: 156.204.71.69
```

### ุงูุชูููู
ูุญุงููุฉ ูุงุญุฏุฉ ููุท โ ูุง ุชุดูู ุชูุฏูุฏุงูุ ููู ุชุณุฌูููุง ููู ูููุฑุงูุจุฉ.

---

## WARN-001 ๐ข โ `โ๏ธ No device token provided`

### ุงูุชูุงุตูู
- **6 ูุฑุงุช** ููุฒุนุฉ ุทูุงู ุงูููููู
- ูุญุฏุซ ุนูุฏ ุชุณุฌูู ุฏุฎูู ูุณุชุฎุฏู ูุง ูููู device token (ุฅุดุนุงุฑุงุช Push)
- ูุง ูุคุซุฑ ุนูู ุนูู ุงูุชุทุจูู

---

## WARN-002 ๐ข โ ุฎุท `Noto Naskh Arabic` ูุง ูุชุญูู

### ุงูุชูุงุตูู
```
[2026-02-26 12:31:09] WARNING - Font-face 'Noto Naskh Arabic' cannot be loaded
[2026-02-26 12:46:17] WARNING - Font-face 'Noto Naskh Arabic' cannot be loaded
```
- ูุญุฏุซ ุนูุฏ ุชูููุฏ PDF
- ุงูุฎุท ุบูุฑ ูุชููุฑ ูู ูุณุงุฑ ูุนุฑูู ูู `weasyprint`
- ุงูุชูุงุฑูุฑ ุชููุชุฌ ููู ุจุฎุท ุจุฏูู

---

## ุญุงูุฉ ุงูุฅุตูุงุญุงุช ุงูุณุงุจูุฉ (ุชุญูู)

| ุงูุจู | ุงูุญุงูุฉ ุจุนุฏ ุงูุฅุตูุงุญ |
|------|-------------------|
| BUG-017 (`order_item=None`) | โ **0 ุฎุทุฃ** โ ูุง ููุฌุฏ `NoneType` ูู ุงูุณุฌูุงุช |
| BUG-019 (Cloudflare 429) | โ **0 ุฎุทุฃ** โ Queue ูุนูู ูู ุงูุฎูููุฉ |
| BUG-014 (Celery startup) | โ **Celery ูุนูู** โ PID files ููุฌูุฏุฉ |
| BUG-018 (pgBouncer wait) | โ **ุฌุฒุฆู** โ ุฑุณุงูุฉ ุชุญุฐูุฑ ุจุฏูุงู ูู crash |

---

## ุฃููููุฉ ุงูุฅุตูุงุญ

| ุงูุฃููููุฉ | ุงูุจู | ุงูููู ุงููุณุชูุฏู | ุงูุชุฃุซูุฑ |
|----------|------|---------------|---------|
| 1 ๐ด | BUG-020 | `orders/wizard_views.py:2513` | ุงููุณุชุฎุฏู ูุฑู 500 ุนูุฏ double-click |
| 2 ๐ด | SEC-001 | ุชูููุฏ `/admin/` ูู IPs ุฎุงุฑุฌูุฉ | ูุฌูู ุขูู ุนูู admin panel |
| 3 ๐ก | BUG-013 | ุชุตุญูุญ ูุฑุฌุนูุงุช ูุณุชูุฏุน ูู ุงูุทูุจุงุช ุงููุฏููุฉ | 36 ุฎุทุฃ ููููุงู ูู ุงููุฎุฒูู |
| 4 ๐ข | WARN-002 | ุฅุถุงูุฉ ูุณุงุฑ ุงูุฎุท ูู weasyprint config | PDF ุจุฎุท ุฃูุถู |
