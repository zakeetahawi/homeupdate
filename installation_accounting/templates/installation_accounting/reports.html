{% extends 'base.html' %}
{% load static %}
{% load humanize %}
{% block title %}تقارير حسابات التركيبات{% endblock %}
{% block content %}
    <div class="container" style="margin-top: 100px;">
        <div class="row">
            <div class="col-md-12">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-primary text-white py-3">
                        <h4 class="mb-0 d-flex align-items-center">
                            <i class="fas fa-tools me-2"></i>
                            <span>تقارير حسابات التركيبات</span>
                        </h4>
                    </div>
                    <div class="card-body p-4">
                        <!-- Filters -->
                        <form method="get" class="mb-5 bg-light p-4 rounded shadow-sm border">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <label class="form-label fw-bold">من تاريخ:</label>
                                    <input type="date"
                                           name="date_from"
                                           class="form-control"
                                           value="{{ filters.date_from }}">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-bold">إلى تاريخ:</label>
                                    <input type="date"
                                           name="date_to"
                                           class="form-control"
                                           value="{{ filters.date_to }}">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-bold">حالة الدفع:</label>
                                    <select name="payment_status" class="form-select">
                                        <option value="all"
                                                {% if filters.payment_status == 'all' %}selected{% endif %}>
                                            الكل
                                        </option>
                                        <option value="paid"
                                                {% if filters.payment_status == 'paid' %}selected{% endif %}>
                                            مدفوع
                                        </option>
                                        <option value="unpaid"
                                                {% if filters.payment_status == 'unpaid' %}selected{% endif %}>
                                            غير مدفوع
                                        </option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-bold">الفني:</label>
                                    <select name="technician" class="form-select">
                                        <option value="">الكل</option>
                                        {% for tech in technicians %}
                                            <option value="{{ tech.id }}"
                                                    {% if filters.technician == tech.id|stringformat:"s" %}selected{% endif %}>
                                                {{ tech.name }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="row mt-4">
                                <div class="col-md-12 d-flex gap-2">
                                    <button type="submit" class="btn btn-primary px-4">
                                        <i class="fas fa-filter me-1"></i> فلترة
                                    </button>
                                    <a href="{% url 'installation_accounting:reports' %}"
                                       class="btn btn-outline-secondary">
                                        <i class="fas fa-redo me-1"></i> إعادة تعيين
                                    </a>
                                    <a href="{% url 'installation_accounting:export_report' %}?date_from={{ filters.date_from }}&date_to={{ filters.date_to }}&payment_status={{ filters.payment_status }}&technician={{ filters.technician }}"
                                       class="btn btn-success">
                                        <i class="fas fa-file-excel me-1"></i> تصدير Excel
                                    </a>
                                    <a href="{% url 'reports:ranking' %}?type=installations&date_from={{ filters.date_from }}&date_to={{ filters.date_to }}"
                                       class="btn btn-warning">
                                        <i class="fas fa-trophy me-1"></i> ترتيب الفنيين
                                    </a>
                                </div>
                            </div>
                        </form>
                        <!-- Summary Cards -->
                        <div class="row g-4 mb-5">
                            <div class="col-md-3">
                                <div class="card h-100 border-0 bg-dark text-white shadow">
                                    <div class="card-body text-center p-4">
                                        <div class="display-6 mb-1 fw-bold">{{ total_orders_count }}</div>
                                        <div class="text-uppercase small opacity-75">إجمالي عدد الطلبات</div>
                                        <i class="fas fa-file-invoice fa-2x mt-3 opacity-25"></i>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card h-100 border-0 bg-primary text-white shadow">
                                    <div class="card-body text-center p-4">
                                        <div class="display-6 mb-1 fw-bold">{{ total_windows }}</div>
                                        <div class="text-uppercase small opacity-75">إجمالي الشبابيك</div>
                                        <i class="fas fa-window-maximize fa-2x mt-3 opacity-25"></i>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card h-100 border-0 bg-info text-white shadow">
                                    <div class="card-body text-center p-4">
                                        <div class="display-6 mb-1 fw-bold">{{ total_cost|floatformat:2 }}</div>
                                        <div class="text-uppercase small opacity-75">إجمالي تكلفة التركيبات</div>
                                        <i class="fas fa-money-bill-wave fa-2x mt-3 opacity-25"></i>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card h-100 border-0 bg-success text-white shadow">
                                    <div class="card-body text-center p-4">
                                        <div class="display-6 mb-1 fw-bold">{{ technician_total|floatformat:2 }}</div>
                                        <div class="text-uppercase small opacity-75">إجمالي مستحقات الفنيين</div>
                                        <i class="fas fa-user-check fa-2x mt-3 opacity-25"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Data Table -->
                        <div class="table-responsive bg-white rounded shadow-sm border">
                            <div class="p-3 bg-light border-bottom d-flex justify-content-between align-items-center">
                                <h5 class="mb-0 fw-bold text-secondary">تفاصيل جدول التركيبات</h5>
                                <button type="button"
                                        class="btn btn-success btn-sm shadow-sm"
                                        id="btn-bulk-pay"
                                        style="display: none">
                                    <i class="fas fa-check-double me-1"></i> إتمام الدفع للمحدد
                                </button>
                            </div>
                            <table class="table table-hover align-middle mb-0">
                                <thead class="table-dark text-center">
                                    <tr>
                                        <th style="width: 50px;">
                                            <input type="checkbox" class="form-check-input" id="check-all">
                                        </th>
                                        <th>التاريخ المجدول</th>
                                        <th>رقم الطلب</th>
                                        <th>العميل</th>
                                        <th>حالة الإنجاز</th>
                                        <th>الشبابيك</th>
                                        <th>سعر الشباك</th>
                                        <th>الفنيين (الحصص)</th>
                                        <th>المستحقات</th>
                                        <th>حالة الدفع</th>
                                        <th>تاريخ الدفع</th>
                                    </tr>
                                </thead>
                                <tbody class="text-center">
                                    {% for schedule in schedules %}
                                        {% with card=schedule.accounting_card %}
                                            <tr class="{% if card and card.status == 'paid' %}table-success{% endif %}">
                                                <td>
                                                    {% if card and card.status != 'paid' %}
                                                        <input type="checkbox"
                                                               class="form-check-input card-check"
                                                               value="{{ card.id }}">
                                                    {% elif card and card.status == 'paid' %}
                                                        <i class="fas fa-check-circle text-success" title="مدفوع بالكامل"></i>
                                                    {% else %}
                                                        <!-- No card yet -->
                                                        <i class="fas fa-minus text-muted"></i>
                                                    {% endif %}
                                                </td>
                                                <td class="fw-bold">
                                                    {{ schedule.scheduled_date|date:"Y-m-d" }}
                                                    {% if schedule.completion_date and schedule.completion_date.date != schedule.scheduled_date %}
                                                        <div class="text-danger small mt-1" style="font-size: 0.75rem;">
                                                            <i class="fas fa-check me-1"></i>
                                                            {{ schedule.completion_date|date:"Y-m-d" }}
                                                        </div>
                                                    {% endif %}
                                                </td>
                                                <td class="fw-bold text-primary">
                                                    {{ schedule.order.order_number }}
                                                    {% if schedule.status|slice:":12" == "modification" %}
                                                        <span class="badge bg-warning text-dark ms-1" style="font-size: 0.7rem;">تعديل</span>
                                                    {% endif %}
                                                </td>
                                                <td>{{ schedule.order.customer.name }}</td>
                                                <td>
                                                    {% if schedule.status == 'completed' or schedule.status == 'modification_completed' %}
                                                        <span class="badge bg-success">مكتمل</span>
                                                    {% elif schedule.status == 'in_installation' %}
                                                        <span class="badge bg-primary">قيد التنفيذ</span>
                                                    {% elif schedule.status == 'scheduled' %}
                                                        <span class="badge bg-info text-dark">مجدول</span>
                                                    {% else %}
                                                        <span class="badge bg-secondary">{{ schedule.get_status_display }}</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <span class="badge bg-secondary rounded-pill px-3">{{ card.windows_count|default:schedule.windows_count }}</span>
                                                </td>
                                                <td>{{ card.price_per_window|default:"-" }}</td>
                                                <td class="text-start">
                                                    {% if card %}
                                                        {% for share in card.shares.all %}
                                                            {% if not filters.technician or share.technician_id|stringformat:"s" == filters.technician %}
                                                                <div class="small mb-1 {% if share.is_paid %}text-success{% endif %}">
                                                                    <i class="fas fa-user-circle me-1 opacity-50"></i>
                                                                    <strong>{{ share.technician.name }}:</strong>
                                                                    <span class="badge bg-light text-dark border ms-1">{{ share.assigned_windows|floatformat:1 }} شباك</span>
                                                                    {% if share.is_paid %}<i class="fas fa-check-circle text-success ms-1 small"></i>{% endif %}
                                                                </div>
                                                            {% endif %}
                                                        {% endfor %}
                                                    {% else %}
                                                        <!-- Show techs from schedule if no card yet -->
                                                        {% for tech in schedule.technicians.all %}
                                                            <div class="small mb-1 text-muted">
                                                                <i class="fas fa-user-clock me-1 opacity-50"></i>
                                                                {{ tech.name }}
                                                            </div>
                                                        {% endfor %}
                                                    {% endif %}
                                                </td>
                                                <td class="fw-bold text-success">
                                                    {% if card %}
                                                        {% if filters.technician %}
                                                            {% for share in card.shares.all %}
                                                                {% if share.technician_id|stringformat:"s" == filters.technician %}{{ share.amount|floatformat:2 }}{% endif %}
                                                            {% endfor %}
                                                        {% else %}
                                                            {{ card.total_cost|floatformat:2 }}
                                                        {% endif %}
                                                    {% else %}
                                                        <span class="text-muted">-</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if card %}
                                                        {% if card.status == 'paid' %}
                                                            <span class="badge bg-success">مدفوع</span>
                                                        {% else %}
                                                            <span class="badge bg-warning text-dark">غير مدفوع</span>
                                                        {% endif %}
                                                    {% else %}
                                                        <span class="badge bg-light text-muted border">غير جاهز</span>
                                                    {% endif %}
                                                </td>
                                                <td>{{ card.payment_date|date:"Y-m-d"|default:"-" }}</td>
                                            </tr>
                                        {% endwith %}
                                    {% empty %}
                                        <tr>
                                            <td colspan="11" class="text-center py-5 text-muted italic">لا توجد عمليات تركيب مجدولة في هذه الفترة</td>
                                        </tr>
                                    {% endfor %}
                                    <!-- TOTALS ROW -->
                                    <tr class="table-dark fw-bold">
                                        <td colspan="5" class="text-end">الإجمالي:</td>
                                        <td>{{ total_windows }}</td>
                                        <td>-</td>
                                        <td>-</td>
                                        <td class="text-success">{{ total_cost|floatformat:2 }}</td>
                                        <td colspan="2"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
{% block extra_js %}
    <script>
document.addEventListener('DOMContentLoaded', function () {
    const checkAll = document.getElementById('check-all');
    const checkboxes = document.querySelectorAll('.card-check');
    const bulkPayBtn = document.getElementById('btn-bulk-pay');

    function updateBulkBtn() {
        const checked = document.querySelectorAll('.card-check:checked');
        if (checked.length > 0) {
            bulkPayBtn.style.display = 'inline-block';
            bulkPayBtn.innerHTML = `<i class="fas fa-check-double me-1"></i> إتمام الدفع للمحدد (${checked.length})`;
        } else {
            bulkPayBtn.style.display = 'none';
        }
    }

    if (checkAll) {
        checkAll.addEventListener('change', function () {
            checkboxes.forEach(cb => cb.checked = checkAll.checked);
            updateBulkBtn();
        });
    }

    checkboxes.forEach(cb => {
        cb.addEventListener('change', updateBulkBtn);
    });

    if (bulkPayBtn) {
        bulkPayBtn.addEventListener('click', function () {
            const selected = Array.from(document.querySelectorAll('.card-check:checked')).map(cb => cb.value);
            const urlParams = new URLSearchParams(window.location.search);
            const technicianId = urlParams.get('technician');
            const techName = technicianId ? " للفني المحدد" : " بالكامل";

            if (confirm('هل أنت متأكد من إتمام الدفع لـ ' + selected.length + ' عمليات تركيب' + techName + '؟')) {
                const payload = { card_ids: selected };
                if (technicianId) payload.technician_id = technicianId;

                fetch("{% url 'installation_accounting:bulk_pay' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify(payload)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        location.reload();
                    } else {
                        alert('حدث خطأ: ' + (data.error || data.message));
                    }
                })
                .catch(err => {
                    console.error(err);
                    alert('حدث خطأ في الاتصال');
                });
            }
        });
    }
});
    </script>
    <style>
    .card { border-radius: 12px; }
    .table thead th { font-weight: 600; text-transform: uppercase; font-size: 0.85rem; letter-spacing: 0.5px; }
    .form-label { font-size: 0.9rem; }
    .badge { padding: 0.5em 1em; font-weight: 500; }
    .table-success { background-color: #f1fbf4 !important; }
    </style>
{% endblock %}
